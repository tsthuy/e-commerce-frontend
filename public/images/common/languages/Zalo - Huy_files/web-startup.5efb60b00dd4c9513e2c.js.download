"object"!=typeof globalThis&&(globalThis=window),(this.webpackJsonp=this.webpackJsonp||[]).push([[25],{"+eUS":function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i=s("jDHv"),n=s("+ExH"),a=s("ycTR"),r=s("YEoC"),o=s("kFM4"),l=s("teaq"),c=s("PhBv"),d=s("1UUk"),u=s("Hw41");function h(e){Object(o.a)("RunMode",e),e!==r.f.Unknown&&(i.ModuleContainer.resolve(d.b).install(),e!==r.f.Background&&(setTimeout((()=>{const e=i.ModuleContainer.resolve(c.b);e.install(n.b),e.start()}),1),i.ModuleContainer.resolve(l.b).install(a.a,a.b)),e===r.f.Host&&i.ModuleContainer.resolve(u.a).install())}},"+iAT":function(e,t,s){"use strict";var i=s("VTBJ"),n=s("YEoC"),a=s("xI/L"),r=s("C9Dv"),o=s("teaq");const l={PartitionKey:new o.c({tableName:"partition_key",name:"PartitionKey",fields:{database:{name:"database",type:n.h.string},table:{name:"table",type:n.h.string},key:{name:"key",type:n.h.string},value:{name:"value",type:n.h.string}},indices:{primary:{name:"primary",fields:[{type:"raw",field:"database"},{type:"raw",field:"table"},{type:"raw",field:"key"}],unique:!0}}})},c={name:"Meta",session:!0},d={partitionNamingStrategy:[a.a.byUser(),a.a.const("Meta")],partitionsMap:Object(r.a)(l)},u={partitionNamingStrategy:[a.a.const("mt"),a.a.byUser()],partitionsMap:Object(r.a)(l)},h=Object(i.a)(Object(i.a)(Object(i.a)({},c),d),{},{version:1,milestoneVersion:1,type:n.a.SQLite,corruptionImpact:n.b.IMPACT_PARTIAL}),g=Object(i.a)(Object(i.a)(Object(i.a)({},c),u),{},{version:1,milestoneVersion:1,type:n.a.IDB});let m=null,p=null;t.a={baseConfig:c,schema:l,get useSqlite(){return null===m&&(m=new o.a(h)),m},get useIdb(){return null===p&&(p=new o.a(g)),p}}},"/2rj":function(e,t,s){"use strict";var i,n=s("jDHv"),a=s("8eps");let r=Object(n.injectable)()(i=class{constructor(){this.builder=null}install(e){this.builder=e}getValue(){return this.builder}})||i;n.ModuleContainer.registerSingleton(a.a,r)},"0rWR":function(e,t,s){"use strict";var i,n=s("8/YW"),a=s("jDHv"),r=s("Mgpg"),o=s("YEoC"),l=s("PmZf"),c=s("x9oK"),d=s("UJ0r");let u=Object(n.g)()(i=a.ModuleContainer.injectable()(i=function(e,t){return a.ModuleContainer.inject(r.ZLoggerFactory)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===r.ZLoggerFactory?Object:r.ZLoggerFactory])(i=class extends d.a{constructor(e){super(),this.logger=void 0,this.removeListenersData=[],this.removeListenersForAllAdapters=()=>{this.removeListenersData.forEach((e=>e()))},this.logger=e.createZLogger("db",["adapter-manager"])}registerListenersForAdapter(e){const t=e=>{this.dispatchEvent(e)};this.removeListenersData.push(e.addEventListener(l.b.SuccessOpenDB,t)),this.removeListenersData.push(e.addEventListener(l.b.LongOpenDB,t)),this.removeListenersData.push(e.addEventListener(l.b.TimeConsumingQuery,t)),this.removeListenersData.push(e.addEventListener(l.b.ConnectionClosedAbnormally,t)),this.removeListenersData.push(e.addEventListener(l.b.SchemaMigratedAbnormally,t)),this.removeListenersData.push(e.addEventListener(l.b.Warning,t))}onDispose(){this.removeListenersForAllAdapters()}async getDatabaseAdapter(e,t){const s=this.getAdapterFactoryToken(t.type),i=a.ModuleContainer.resolve(s),n=await i.createAdapter(e,t);return this.registerListenersForAdapter(n),n}async canUse(e){return e!==o.a.SQLite||await this.canIUseSQLite()}async canIUseSQLite(){return!1}getAdapterFactoryToken(e){return e===o.a.IDB?c.b:c.c}getExistedPartitionKeys(e,t){const s=this.getAdapterFactoryToken(t);return a.ModuleContainer.resolve(s).getExistedPartitionKeys(e)}})||i)||i)||i)||i)||i;a.ModuleContainer.registerSingleton(d.b,u)},23:function(e,t){},24:function(e,t){},25:function(e,t){},"5l/R":function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("jDHv");const n=Object(i.define)("zlog-writer-manager")},"5yGw":function(e,t,s){"use strict";var i=s("jDHv"),n=s("Mgpg"),a=s("DI/x"),r=s("wH4e"),o=s("+iAT"),l=s("K5Y3");var c,d=s("d/or"),u=s("teaq");let h=i.ModuleContainer.injectable()(c=function(e,t){return i.ModuleContainer.inject(d.a)(e,void 0,0)}(c=function(e,t){return i.ModuleContainer.inject(n.ZLoggerFactory)(e,void 0,1)}(c=Reflect.metadata("design:type",Function)(c=Reflect.metadata("design:paramtypes",[void 0===d.a?Object:d.a,void 0===n.ZLoggerFactory?Object:n.ZLoggerFactory])(c=class{constructor(e,t){this.settingsManager=e,this.configFactory=void 0,this.getDatabaseBaseConfigFn=void 0,this.configCache=void 0,this.session=null,this.logger=void 0,this.logger=t.createZLogger("db",["config"]),this.configCache=new Map}getDatabaseBaseConfig(e){if(!this.getDatabaseBaseConfigFn)throw new a.g("Config manager hasn't been installed yet!");const t=this.getDatabaseBaseConfigFn(e);if(void 0===t)throw new a.g(`No base config found for '${e}' database`);return t}authenticate(e){this.logger.zsymb(0,"QpVBrI","Clear cache due to new session"),this.clearCache(),this.session=e,this.settingsManager.init(e.userId)}install(e,t){this.configFactory=(t,s)=>{let i=e(t,s);return void 0===i&&(i=((e,t)=>{if(t===r.a.IDB)switch(e){case"Meta":return o.a.useIdb;case"DBState":return l.a.useIdb;default:return}if(t===r.a.SQLite)switch(e){case"Meta":return o.a.useSqlite;case"DBState":return l.a.useSqlite;default:return}})(t,s)),i},this.getDatabaseBaseConfigFn=e=>{let s=t(e);return void 0===s&&(s=(e=>{switch(e){case"Meta":return o.a.baseConfig;case"DBState":return l.a.baseConfig;default:return}})(e)),s}}async getDatabaseConfigs(e){const t=this.configCache.get(e);return t||await this.createConfigCache(e)}clearCache(){const e=this.configCache.values();let t=e.next();for(;!t.done;){t.value.forEach((e=>{e.clearCache()})),t=e.next()}this.configCache.clear()}async createConfigCache(e){const t=[],s=await this.getCurrentConfig(e);return s&&t.push(s),this.configCache.has(e)||this.configCache.set(e,t),t}async getCurrentConfig(e){if(!this.getDatabaseBaseConfigFn)throw new a.g("Config manager hasn't been installed yet!");const t=this.getDatabaseBaseConfigFn(e);if(void 0===t)throw new a.g(`Missing base config for '${e}' database`);const{session:s}=t;let i=null;if(s){if(null===this.session)throw new a.g("Config manager hasn't been authenticated yet!");i=await this.settingsManager.getAdapterTypeOfUserScopedDatabases(this.session.userId)}else i=await this.settingsManager.getAdapterTypeOfSharedDatabases();if("number"!=typeof i)throw new a.g(`${i} is not a valid AdapterType value!`);return this.configFactory(e,i)}})||c)||c)||c)||c)||c;i.ModuleContainer.registerSingleton(u.b,h)},BtX6:function(e,t,s){s("E2g8").polyfill()},FCbV:function(e,t){},HPcM:function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a}));var i=s("jDHv");const n=Object(i.define)("zlog-sentry-bucket"),a=Object(i.define)("zlog-regular-bucket")},HWGt:function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var i=s("PmZf"),n=s("YZti"),a=s("1UUk"),r=s("jDHv"),o=s("Mk04"),l=s("Mgpg");class c{handleOutOfMemError(e){}handleInvalidVersionError(e){}handleMissingStoreError(e){}handleExceedingLimitInReopeningDBConnection(e){}handleQueryExec(e){}handleSuccessOpenDB(e){}handleConnectionClosedAbnormally(e){}handleSchemaMigratedAbnormally(e){}handleLongOpenDB(e){}handleTimeConsumingQuery(e,t){}handleQueryError(e){}handleWarning(e){}constructor(){this.logger=void 0,this.logErrorMessageOnce=Object(o.a)((e=>{this.logger.zsymb(18,"G0Z6PV",e)})),this.dispose=()=>{};const e=r.ModuleContainer.resolve(l.ZLoggerFactory);this.logger=e.createZLogger("db",["event-handler"])}start(){const e=r.ModuleContainer.resolve(a.b),t=e=>{const{data:t}=e;this.handleQueryExec(t)},s=e=>{const{error:t}=e;n.a.isOutOfMemError(t)?(this.logErrorMessageOnce(`OutOfMemError: ${t.message}`),this.handleOutOfMemError(t)):n.a.isInvalidVersionError(t)?(this.logErrorMessageOnce(`${t}`),this.handleInvalidVersionError(t)):n.a.isMissingTableError(t)?(this.logErrorMessageOnce(`${t}`),this.handleMissingStoreError(t)):n.a.isFailedToOpenConnectionError(t)&&(this.logErrorMessageOnce(`${t}`),this.handleExceedingLimitInReopeningDBConnection(t)),this.handleQueryError(t)},o=e=>{this.handleSuccessOpenDB(e.data)},l=e=>{this.handleLongOpenDB(e.data)},c=e=>{const{logInfo:t,totalTime:s}=e;this.handleTimeConsumingQuery(t,s)},d=e=>{this.logErrorMessageOnce(`DB connection closed abnormally: '${e.database}'`),this.handleConnectionClosedAbnormally(e)},u=e=>{this.logErrorMessageOnce(`Schema migrated abnormally: '${e.data}'`),this.handleSchemaMigratedAbnormally(e)},h=e=>{this.handleWarning(e.data)};e.addEventListener(i.b.QueryExec,t),e.addEventListener(i.b.QueryError,s),e.addEventListener(i.b.SuccessOpenDB,o),e.addEventListener(i.b.LongOpenDB,l),e.addEventListener(i.b.TimeConsumingQuery,c),e.addEventListener(i.b.ConnectionClosedAbnormally,d),e.addEventListener(i.b.SchemaMigratedAbnormally,u),e.addEventListener(i.b.Warning,h),this.dispose=()=>{e.removeEventListener(i.b.QueryExec,t),e.removeEventListener(i.b.QueryError,s),e.removeEventListener(i.b.SuccessOpenDB,o),e.removeEventListener(i.b.LongOpenDB,l),e.removeEventListener(i.b.TimeConsumingQuery,c),e.removeEventListener(i.b.ConnectionClosedAbnormally,d),e.removeEventListener(i.b.SchemaMigratedAbnormally,u),e.removeEventListener(i.b.Warning,h)}}}},"ILT/":function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var i,n,a=s("VTBJ"),r=s("igA5"),o=s("ezRR"),l=s("E/Lo"),c=s("QDKs"),d=s("UHN6"),u=s("dKg8"),h=s("jx7S");let g=Object(o.c)()(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[])((n=class e extends o.b{constructor(){super(),this.name="",this.state=void 0,this.microTaskQueue=[],this.taskQueue=[],this.runTaskQueue=[],this.currentTask=void 0,this.backupData={},this.backupDataTimer=void 0,this.tookBackupKeys={},this.timer=void 0,this.timerCount=0,this.tempTaskId=void 0,this.storage=void 0,this.state="running"===this.appStatus?"running":"created"}create(){for(const t in e.instances){const s=e.instances[t];Object(l.d)()&&c.a.info(d.c,`ID: ${s.id} - TASK_MANAGER_CREATED`),s.state="created"}}running(){for(const t in e.instances){const s=e.instances[t];Object(l.d)()&&c.a.info(d.c,`ID: ${s.id} - TASK_MANAGER_RUNNING`),s.state="running",s.prepare()}}stop(){for(const t in e.instances){const s=e.instances[t];Object(l.d)()&&c.a.info(d.c,`ID: ${s.id} - TASK_MANAGER_STOP`),s.state="stop",s.clearTimer()}}setup(t){if(!t)throw new Error("TaskManager name is required.");return this.name=t,e.instances[this.getNameAsKey()]?e.instances[this.getNameAsKey()]:(e.instances[this.getNameAsKey()]=this,this.storage=r.default.getInstance(),"running"===this.state&&this.prepare(),this)}createTask(e,t){if(!this.name)throw new Error("TaskManager is not setup.");return new u.a(e,this,t)}addTask(e){var t;Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - ADD_TASK`,Object(h.a)(e),e.backupData||""),"high"===(null===(t=e.options)||void 0===t?void 0:t.priority)?this.microTaskQueue.push(e):this.taskQueue.push(e),this.restoreBackup(e)}runTask(e){"running"!==this.state||this.currentTask?e&&this.addBackup(e):(this.currentTask=this.findNextTask(),this.currentTask?(Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - RUN_TASK`,Object(h.a)(this.currentTask),this.currentTask.backupData,`runTaskQueue: ${this.runTaskQueue.length} - microTaskQueue: ${this.microTaskQueue.length} - taskQueue: ${this.taskQueue.length}`),this.addBackup(this.currentTask),this.currentTask.run(),this.tempTaskId=this.currentTask.id):Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - NO_TASK_TO_RUN`))}doneTask(e,t=!1,s){var i,n,a;if(Object(l.d)()){const i=s?` - Reason: ${s}`:"";c.a.info(d.c,`ID: ${this.id} - DONE_TASK`,`isForce: ${t} - Task ${Object(h.a)(e)}${i}`,this.currentTask?`Current task ${Object(h.a)(this.currentTask)}`:"")}(null===(i=this.currentTask)||void 0===i?void 0:i.id)===e.id?(null!==(n=e.options)&&void 0!==n&&null!==(a=n.backup)&&void 0!==a&&a.key&&this.removeBackup(e),this.currentTask=void 0,this.tempTaskId=void 0):t&&this.findAndRemoveTask(e);this.runTask()}async prepare(){try{var e;const t=await(null===(e=this.storage)||void 0===e?void 0:e.getItemForCurrentUserAsync(this.getBackupKey()));t&&(this.backupData=JSON.parse(t))}catch(t){}finally{this.runBackup(),this.runTask(),this.runTimer()}}restoreBackup(e){var t,s;if("running"!==this.state)return;const i=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;!i||Object(l.e)(this.backupData[i])||this.tookBackupKeys[i]?e.restore():(Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - GET_BACKUP_DATA_FROM_DB`,Object(h.a)(e)),e.restore(this.backupData[i]),this.resetBackup(e),this.tookBackupKeys[i]=!0)}addBackup(e){var t,s;const i=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;i&&e.backupData&&(this.backupData[i]=Object(a.a)(Object(a.a)({},this.backupData[i]||{}),{},{[e.id]:e.backupData}),this.saveBackupData())}removeBackup(e){var t,s;const i=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;var n;i&&(null===(n=this.backupData[i])||void 0===n||delete n[e.id],this.saveBackupData())}runBackup(){for(const e in this.backupData){const t=this.runTaskQueue.find((t=>{var s,i;return(null===(s=t.options)||void 0===s||null===(i=s.backup)||void 0===i?void 0:i.key)===e}))||this.microTaskQueue.find((t=>{var s,i;return(null===(s=t.options)||void 0===s||null===(i=s.backup)||void 0===i?void 0:i.key)===e}))||this.taskQueue.find((t=>{var s,i;return(null===(s=t.options)||void 0===s||null===(i=s.backup)||void 0===i?void 0:i.key)===e}));t&&this.restoreBackup(t)}}resetBackup(e){var t,s;const i=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;i&&(delete this.backupData[i],this.saveBackupData())}getBackupKey(){return`${d.a}_${this.getNameAsKey()}`}getNameAsKey(){return this.name.replace(/ /gi,"_")}saveBackupData(){this.backupDataTimer||(this.backupDataTimer=setTimeout((()=>{var e;null===(e=this.storage)||void 0===e||e.setItemForCurrentUserAsync(this.getBackupKey(),JSON.stringify(this.backupData)),this.backupDataTimer=void 0,Object(l.d)()&&c.a.info(d.c,"SAVE_BACKUP_DATA",this.backupData)}),d.f))}findNextTask(){let e=[];if(e=Object(h.b)(this.microTaskQueue),this.runTaskQueue=this.runTaskQueue.concat(e),e=Object(h.b)(this.taskQueue),this.runTaskQueue=this.runTaskQueue.concat(e),this.runTaskQueue.length>0)return this.runTaskQueue.shift()}findAndRemoveTask(e){this.microTaskQueue=this.microTaskQueue.filter((t=>t.id!==e.id)),this.taskQueue=this.taskQueue.filter((t=>t.id!==e.id)),this.runTaskQueue=this.runTaskQueue.filter((t=>t.id!==e.id))}runTimer(){this.timer||(this.timer=setInterval((()=>{var e;(this.timerCount++,d.b/d.e===this.timerCount)&&(null!==(e=this.currentTask)&&void 0!==e&&e.id&&this.currentTask.id===this.tempTaskId&&c.a.warn(d.c,`ID: ${this.id} - TASK_TIMER Task (${Object(h.a)(this.currentTask)}) is running too long.`))}),d.e))}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=void 0,this.timerCount=0)}},n.instances={},i=n))||i)||i)||i},K5Y3:function(e,t,s){"use strict";var i=s("VTBJ"),n=s("YEoC"),a=s("xI/L"),r=s("C9Dv"),o=s("teaq");const l={DataTransform:new o.c({tableName:"data_transform",name:"DataTransform",fields:{scope:{name:"scope",type:n.h.string},database:{name:"database",type:n.h.string},table:{name:"table",type:n.h.string},version:{name:"version",type:n.h.integer},migrate:{name:"migrate",type:n.h.json}},indices:{primary:{name:"primary",fields:[{type:"raw",field:"scope"},{type:"raw",field:"database"},{type:"raw",field:"table"}],unique:!0}}})},c={name:"DBState",session:!1},d={partitionNamingStrategy:[a.a.const("Encrypt"),a.a.const("DBState")],partitionsMap:Object(r.a)(l)},u={partitionNamingStrategy:[a.a.const("zdbstate")],partitionsMap:Object(r.a)(l)},h=Object(i.a)(Object(i.a)(Object(i.a)({},c),d),{},{version:1,milestoneVersion:1,type:n.a.SQLite,corruptionImpact:n.b.IMPACT_FULL}),g=Object(i.a)(Object(i.a)(Object(i.a)({},c),u),{},{version:1,milestoneVersion:1,type:n.a.IDB});let m=null,p=null;t.a={baseConfig:c,schema:l,get useSqlite(){return null===m&&(m=new o.a(h)),m},get useIdb(){return null===p&&(p=new o.a(g)),p}}},K8kB:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("jDHv");const n=Object(i.define)("zlog-write-scheduler")},KGrx:function(e,t,s){"use strict";var i=s("ILT/");s.d(t,"TaskManager",(function(){return i.a}));s("dKg8"),s("qU4b")},KdAX:function(e,t,s){"use strict";var i=s("jDHv"),n=s("W8fB"),a=s("UJDs"),r=s("7FSS"),o=(s("j6JD"),s("VTBJ"));const l=s("4JQ2"),c={intro:e=>c.eol(e),info:e=>e,debug:e=>e,warning:e=>e,error:e=>e,placeholder:e=>e,tick:e=>e,header:e=>l.green(e),sourcemap:e=>l.gray(e),level:e=>e,bold:e=>l.bold(e),eol:e=>e+"\n\n"},d=(Object(o.a)(Object(o.a)({},c),{},{intro:e=>c.eol(l.bgWhite.black(e)),info:e=>l.white(e),debug:e=>l.blue(e),warning:e=>l.yellow(e),error:e=>l.red(e),tick:e=>l.black.bgWhite.bold(` ${e} `),header:e=>e}),c);s("CDcE");const u={display:!0,style:"font-size: 11px; color: gray"},h={display:!1,style:"font-size: 11px; color: gray; margin-bottom: 8px"};function g({metadata:e,args:t}){const s=e.tags.join("|");let i=t.map((e=>function(e){let t=e;if("function"==typeof e)try{t=e()}catch(s){r.a.error("ZLogSanitizer: failed to exec func. Please make sure your func executable"+s),t=e.toString()}return t}(e)));1===i.length&&1===t.length&&"function"==typeof t[0]&&Array.isArray(i[0])&&(i=i[0]);const n=function(e,t){if(null===e)return"";const s="{}";let i=0;for(;-1!==e.search(s)&&i<t.length;)switch(typeof t[i++]){case"number":e=e.replace(s,"%d");break;case"string":default:e=e.replace(s,"%s");break;case"object":e=e.replace(s,"%o")}return e}(e.template.length>0?e.template[0]:null,i).trim(),a=(e.ln.toString().substring(e.ln.toString().indexOf("src")),""),o=[];return h.display&&a.trim()&&o.push(d.sourcemap(a)+"\n"),u.display&&s.trim()&&o.push(d.sourcemap(s.trim())+"\n"),n.trim()&&o.push(n.trim()),i.length>0?(i.unshift(o.join(" ")),i):[o.join(" ")]}var m;let p=Object(i.injectable)()(m=class{write(e){const t=g(e),s=globalThis.zconsole||console;switch(e.metadata.level){case a.b.info:s.info.apply(s,t);break;case a.b.warn:s.warn.apply(s,t);break;case a.b.debug:s.debug.apply(s,t);break;case a.b.error:s.error.apply(s,t);break;default:s.log.apply(s,t)}}})||m;i.ModuleContainer.registerSingleton(n.a,p)},Lp8g:function(e,t){globalThis.hasOwnProperty("$recoilDebugStates")&&(globalThis.$recoilDebugStates.push=function(...e){this.length>=100&&Array.prototype.splice.apply(this,[0,Math.round(this.length/2)]),Array.prototype.push.apply(this,e)})},Lq8m:function(e,t,s){"use strict";var i,n=s("jDHv"),a=s("Uzj0"),r=s("Mgpg"),o=s("tHMN"),l=s("8eps"),c=s("oM1A"),d=s("zpw2"),u=s("Mk04"),h=s("LzQZ"),g=s("pjo1");let m=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(o.b)(e,void 0,0)}(i=function(e,t){return n.ModuleContainer.inject(h.a)(e,void 0,1)}(i=function(e,t){return n.ModuleContainer.inject(l.a)(e,void 0,2)}(i=function(e,t){return n.ModuleContainer.inject(r.ZLoggerFactory)(e,void 0,3)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===o.a?Object:o.a,void 0===h.a?Object:h.a,void 0===l.a?Object:l.a,void 0===r.ZLoggerFactory?Object:r.ZLoggerFactory])(i=class{constructor(e,t,s,i){this.engine=e,this.transactionManager=t,this.internalData=s,this.loggerFactory=i,this.logger=void 0,this.logger=this.loggerFactory.createZLogger("db",["client"]),this.internalData.install(a.g.map(c.a,((e,t)=>this.createBuilder(e,t))))}createQueryBuilder(e){const t=a.g.map(e,((e,t)=>this.createBuilder(e,t)));return t.deleteAllDatabases=Object(u.a)(this.engine.deleteAllDatabases.bind(this.engine)),t.closeAllDatabases=Object(u.a)(this.engine.closeAllDatabases.bind(this.engine)),t.getAvailableDBBasicInfos=this.engine.getAvailableDBBasicInfos.bind(this.engine),t}createBuilder(e,t,s){return new d.a(this.engine,this.transactionManager,e,t,s)}})||i)||i)||i)||i)||i)||i)||i;n.ModuleContainer.registerSingleton(g.a,m)},Lrq5:function(e,t,s){"use strict";function i(e){return"number"==typeof e}function n(e){return"string"==typeof e}function a(e){return"boolean"==typeof e}function r(e){return"object"==typeof e}function o(e){return"function"==typeof e}function l(e){return void 0===e}function c(e){return null===e}s.d(t,"d",(function(){return i})),s.d(t,"f",(function(){return n})),s.d(t,"a",(function(){return a})),s.d(t,"e",(function(){return r})),s.d(t,"b",(function(){return o})),s.d(t,"g",(function(){return l})),s.d(t,"c",(function(){return c}))},Mk04:function(e,t,s){"use strict";function i(e){let t={};return async(...s)=>{const i=s.length?s.join("-"):"";if(!t[i])return t[i]=!0,e(...s)}}s.d(t,"a",(function(){return i}))},Pswx:function(e,t,s){"use strict";s("1JlB");var i=s("DvQV");s.d(t,"a",(function(){return i.a})),s.d(t,"b",(function(){return i.b})),s.d(t,"c",(function(){return i.c})),s.d(t,"d",(function(){return i.d})),s.d(t,"e",(function(){return i.e})),s.d(t,"f",(function(){return i.f})),s.d(t,"g",(function(){return i.g})),s.d(t,"h",(function(){return i.h})),s.d(t,"i",(function(){return i.i})),s.d(t,"j",(function(){return i.j})),s.d(t,"k",(function(){return i.k})),s.d(t,"l",(function(){return i.l})),s.d(t,"m",(function(){return i.m})),s.d(t,"n",(function(){return i.n})),s.d(t,"o",(function(){return i.o})),s.d(t,"p",(function(){return i.p})),s.d(t,"q",(function(){return i.q})),s.d(t,"r",(function(){return i.r})),s.d(t,"s",(function(){return i.s})),s.d(t,"t",(function(){return i.t})),s.d(t,"u",(function(){return i.u})),s.d(t,"v",(function(){return i.v})),s.d(t,"w",(function(){return i.w})),s.d(t,"x",(function(){return i.x})),s.d(t,"y",(function(){return i.y})),s.d(t,"z",(function(){return i.z})),s.d(t,"A",(function(){return i.A})),s.d(t,"B",(function(){return i.B})),s.d(t,"C",(function(){return i.C})),s.d(t,"D",(function(){return i.D})),s.d(t,"E",(function(){return i.E})),s.d(t,"F",(function(){return i.F})),s.d(t,"G",(function(){return i.G})),s.d(t,"H",(function(){return i.H})),s.d(t,"I",(function(){return i.I})),s.d(t,"J",(function(){return i.J})),s.d(t,"K",(function(){return i.K})),s.d(t,"L",(function(){return i.L})),s.d(t,"M",(function(){return i.M})),s.d(t,"N",(function(){return i.N})),s.d(t,"O",(function(){return i.O})),s.d(t,"P",(function(){return i.P})),s.d(t,"Q",(function(){return i.Q})),s.d(t,"R",(function(){return i.R})),s.d(t,"S",(function(){return i.S})),s.d(t,"T",(function(){return i.T})),s.d(t,"U",(function(){return i.U})),s.d(t,"V",(function(){return i.V})),s.d(t,"W",(function(){return i.W})),s.d(t,"X",(function(){return i.X})),s.d(t,"Y",(function(){return i.Y}))},QDKs:function(e,t,s){"use strict";var i=s("VTBJ");const n="@LOGGER",a=Object(i.a)(Object(i.a)({},console),{},{info:(e,...t)=>{const s=`%c${n}::INFO`;zconsole.info(s,"font-weight: bold; color: #35611b; background-color: #dcffc6; padding: 2px 5px; border-radius: 5px;",e,...t)},warn:(e,...t)=>{const s=`%c${n}::WARN`;zconsole.warn(s,"font-weight: bold; color: #de6800; background-color: #ffdbbc; padding: 2px 5px; border-radius: 5px;",e,...t)},error:(e,...t)=>{const s=`%c${n}::ERROR`;zconsole.error(s,"font-weight: bold; color: #e11c1c; background-color: #ffc9c9; margin-left: 5px; padding: 2px 5px; border-radius: 5px;",e,...t)},zlog:zconsole});t.a=a},QxEN:function(e,t,s){"use strict";var i=s("YrRS"),n=s("eBEg");let a;a="undefined"!=typeof window&&globalThis.zconsole||console;const r=function(){},o={release:["log","debug","trace"]};if(a){for(const[t,s]of Object.entries(o))if("release"===t)for(const e of s)a[e]=r;globalThis.zconsole=a;const e=n.a.create(["zconsole","nullLogger"],{});Object(i.a)(e,!0)}},SF1S:function(e,t){},SGjP:function(e,t,s){"use strict";s.r(t),s.d(t,"appendTextLog",(function(){return r})),s.d(t,"archiveFileLog",(function(){return o})),s.d(t,"getFileSize",(function(){return l})),s.d(t,"readRange",(function(){return c})),s.d(t,"writeRange",(function(){return d})),s.d(t,"cleanupDescriptors",(function(){return u})),s.d(t,"initBinaryLogFile",(function(){return h}));var i=s("1BPm"),n=s("5FGm");const a=new class{constructor(){this.tracker=new Map,this.track=(e,t)=>{this.tracker.set(e,t)},this.untrack=e=>{this.tracker.delete(e)},this.getDescriptor=e=>this.tracker.get(e),this.getAllDescriptors=()=>Array.from(this.tracker.values()),this.removeAllDescriptors=()=>{this.tracker.clear()},this.removeDescriptor=e=>{this.tracker.delete(e)}}},r=async(e,t)=>{await $zFileManager.appendBufferToPath(e,t)},o=async e=>{const t=$znode.fsExtra;t.existsSync(e)&&t.renameSync(e,e+".old")},l=async e=>{const t=$znode.fs;if(!t.existsSync(e))return 0;return t.statSync(e).size},c=async(e,t,r)=>{try{const o=s("cSWM");let l=a.getDescriptor(e);if(!o.existsSync(e))return l&&(o.closeSync(l),a.removeDescriptor(e)),n.c.Failure({code:i.a.FileNotFound,message:`readRange failed for ${e}`});l||(l=o.openSync(e,"r+"),a.track(e,l));const c=new Uint8Array(r-t);return o.readSync(l,c,0,r-t,t),n.c.Success(c)}catch(o){return n.c.Failure({code:i.a.UnknownError,message:`readRange failed for ${e}`})}},d=async(e,t,r)=>{const o=s("cSWM");let l=a.getDescriptor(e);if(!o.existsSync(e))return l&&(o.closeSync(l),a.removeDescriptor(e)),o.writeFileSync(e,r),n.c.Success(null);l||(l=o.openSync(e,"r+"),a.track(e,l));let c=!1;try{o.writeSync(l,r,0,r.byteLength,t)}catch(d){if("object"!=typeof d||"EBADF"!==d.code)return n.c.Failure({code:i.a.BadFileDescriptorNodeJS,message:`initBinaryLogFile failed for ${e}`});(e=>{if("number"==typeof e)try{s("cSWM").closeSync(e)}catch(d){}})(l),a.removeDescriptor(e),c=!0}return c&&(l=o.openSync(e,"r+"),a.track(e,l),o.writeSync(l,r,0,r.byteLength,t)),n.c.Success(null)},u=async()=>{const e=s("cSWM"),t=a.getAllDescriptors();for(const s of t)try{e.closeSync(s)}catch{}a.removeAllDescriptors()},h=async(e,t)=>{try{const o=s("cSWM");let l=a.getDescriptor(e);l&&(o.closeSync(l),a.removeDescriptor(e));try{o.writeFileSync(e,t)}catch(r){return n.c.Failure({code:i.a.UnknownError,message:`initBinaryLogFile failed for ${e}`})}return n.c.Success(null)}catch(o){return n.c.Failure({code:i.a.UnknownError,message:`initBinaryLogFile failed for ${e}`})}}},"T+bx":function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return r}));class i{constructor(e){this.value=void 0,this.next=void 0,this.value=e,this.next=null}}const n=(e,t)=>{const s=t.split(".");let i=e;const n=s.length;for(let a=0;a<n;a+=1){i=i[s[a]];if(!(a===n-1)&&"object"!=typeof i)throw new Error("Invalid key path")}return i},a=null;class r{constructor(e){this.keyPath=e,this.head=void 0,this.tail=void 0,this.size=0,this.head=null,this.tail=null}isEmpty(){return null===this.head}peek(){return this.isEmpty()?null:this.head.value}append(e){const t=new i(e);this.isEmpty()?(this.head=t,this.tail=t):(this.tail.next=t,this.tail=t),this.size+=1}prepend(e){const t=new i(e);this.isEmpty()?(this.head=t,this.tail=t):(t.next=this.head,this.head=t),this.size+=1}dequeue(){if(this.isEmpty())return null;this.size-=1;const e=this.head.value;return this.head===this.tail?this.head=this.tail=null:this.head=this.head.next,e}delete(e){if(this.keyPath===a)throw new Error("This linked list has no key path!");if(this.isEmpty())return;const t=()=>{this.size-=1};if(n(this.head.value,this.keyPath)===e)return this.head=this.head.next,null===this.head&&(this.tail=null),void t();let s=this.head;for(;null!==s.next;){if(n(s.next.value,this.keyPath)===e)return s.next=s.next.next,null===s.next&&(this.tail=s),void t();s=s.next}}find(e){if(this.keyPath===a)throw new Error("This linked list has no key path!");let t=this.head;for(;null!==t;){const{value:s}=t;if(n(s,this.keyPath)===e)return s;t=t.next}return null}toArray(){const e=[];let t=this.head;for(;null!==t;)e.push(t.value),t=t.next;return e}toArrayKey(){if(this.keyPath===a)throw new Error("This linked list has no key path!");const e=[];let t=this.head;for(;null!==t;)e.push(t.value),t=t.next;return e.map((e=>n(e,this.keyPath)))}forEach(e){let t=this.head;for(;null!==t;)e(t.value),t=t.next}clear(){this.head=this.tail=null}}},UHN6:function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"a",(function(){return n})),s.d(t,"f",(function(){return a})),s.d(t,"e",(function(){return r})),s.d(t,"b",(function(){return o})),s.d(t,"d",(function(){return l}));const i="[@TASK_MANAGEMENT]",n="t_m_t_q__",a=2e3,r=1e4,o=2e4,l=2e4},UJDs:function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return n}));let i=function(e){return e[e.info=0]="info",e[e.error=1]="error",e[e.warn=2]="warn",e[e.debug=3]="debug",e[e.critical=4]="critical",e}({});const n={[i.info]:"info",[i.error]:"error",[i.warn]:"warn",[i.debug]:"debug",[i.critical]:"critical"}},W8fB:function(e,t,s){"use strict";s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a})),s.d(t,"c",(function(){return r}));var i=s("jDHv");const n=Object(i.define)("sen-log-writer"),a=Object(i.define)("console-log-writer"),r=Object(i.define)("zlog-writer")},WOja:function(e,t){},Wc52:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("fsQs"),n=s("PLj1");const a={[n.ZLoggerProcess.Unknown]:{toConsole:!1,toFile:!1,fileInterval:i.f},[n.ZLoggerProcess.Embed]:{toConsole:!1,toFile:!1,fileInterval:-1},[n.ZLoggerProcess.Main]:{toConsole:!1,toFile:!0,fileInterval:i.f},[n.ZLoggerProcess.Login]:{toConsole:!0,toFile:!0,fileInterval:i.g},[n.ZLoggerProcess.Render]:{toConsole:!0,toFile:!0,fileInterval:i.f},[n.ZLoggerProcess.Photo]:{toConsole:!0,toFile:!0,fileInterval:i.f},[n.ZLoggerProcess.SharedWorker]:{toConsole:!1,toFile:!0,fileInterval:i.f},[n.ZLoggerProcess.PreloadSharedWorker]:{toConsole:!0,toFile:!0,fileInterval:i.f},[n.ZLoggerProcess.Web]:{toConsole:!0,toFile:!0,fileInterval:i.h},[n.ZLoggerProcess.CompactApp]:{toConsole:!0,toFile:!0,fileInterval:i.g},[n.ZLoggerProcess.MainCompactApp]:{toConsole:!0,toFile:!0,fileInterval:i.g},[n.ZLoggerProcess.PreloadSQLite]:{toConsole:!0,toFile:!0,fileInterval:i.f},[n.ZLoggerProcess.UProcessSQLite]:{toConsole:!1,toFile:!0,fileInterval:i.f}}},XuBa:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));const i=s("NFKh");class n{static encrypt(e){return i.AES.encrypt(e,"5dbe084b7eedNWjRref04e2rDxs01lwH",{iv:"7eb5dbe084b7eedeef04e2622d46ba00",mode:i.mode.ECB,padding:i.pad.Pkcs7})+""}static decrypt(e){return i.AES.decrypt(e,"5dbe084b7eedNWjRref04e2rDxs01lwH",{keySize:16,iv:"7eb5dbe084b7eedeef04e2622d46ba00",mode:i.mode.ECB,padding:i.pad.Pkcs7}).toString(i.enc.Utf8)}}},Y41u:function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a}));let i=function(e){return e.RegLogBucketStatus="RegLogBucketStatus",e.SentryLogBucketStatus="SentryLogBucketStatus",e.WriteSchedulerRequestFlush="WriteSchedulerRequestFlush",e.WriterStatus="WriterStatus",e.LogBucketRequestFlush="LogBucketRequestFlush",e}({});class n{constructor(e,t){this.type=e,this.payload=t}}class a{constructor(e){this.type=e}}},Yggq:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i=new Set(["Qos"])},YrRS:function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return d}));var i=s("jDHv"),n=s("PLj1"),a=s("KRcn"),r=s("5l/R"),o=s("XB6V");function l(){const e=Object(a.getProcess)();if(n.BLACKLISTED_PROCESSES.includes(e))return;i.ModuleContainer.resolve(r.a).setupWriters();d(i.ModuleContainer.resolve(o.a).createZLogger("zconsole",["zlogger"]))}const c=function(){};function d(e,t=!1){const s=["_applyFilter","_getLevel","_transport"],i=Object.getOwnPropertyNames(e).filter((t=>"function"==typeof e[t]&&!s.includes(t)));if(globalThis.zconsole)for(const n of i)globalThis.zconsole[n]=t?c:e[n].bind(e)}},ZfyH:function(e,t){globalThis.$zcommon={},globalThis.$znode={},globalThis.$zglobalThis={},globalThis.$zresource={onClipboardChange:()=>{},onCheckIdleUpdaterBusy:()=>{},getChildUrl:()=>Promise.resolve()},globalThis.$zlogger={},globalThis.$zupdater={},globalThis.$zapp={onRequestShowPreference:()=>{},onRequestShowAbout:()=>{},beforeAppClose:()=>{},beforeAppAutoRestart:()=>{}},globalThis.$zdownload={},globalThis.$zdb={},globalThis.$zsessionManager={},globalThis.$zmulti={},globalThis.$zcall={sendDataToNative:()=>{}},globalThis.$zsharedWorker={},globalThis.$zelectron={},globalThis.$zelectronNative={},globalThis.$zuri={onNewRequest:()=>{},onRequestOpenConv:()=>{},removeListenNewRequest:()=>{},removeListenRequestOpenConv:()=>{}},globalThis.$zscreencap={onEventOs:()=>{}},globalThis.$zlogin={},globalThis.$zperf={},globalThis.$zconfig={},globalThis.$zFileManager={trustBlob:()=>{}},globalThis.$zFeatures={},globalThis.$zMsgChannel={},globalThis.$zscript={},globalThis.$zwindow={closeWindow:()=>{},expandMainWindow:()=>{},focus:()=>{},onHideWindowComplete:()=>{},removeListenHideWindowComplete:()=>{},removeListenVisibilityChange:()=>{},onVisibilityChange:()=>{}},globalThis.$zTFModels={},globalThis.$zcloud={},globalThis.$zsub={$zapp:globalThis.$zapp,$zscreencap:globalThis.$zscreencap,$zuri:globalThis.$zuri,$zresource:globalThis.$zresource,$zlogger:globalThis.$zlogger,$zwindow:globalThis.$zwindow,$zFileManager:globalThis.$zFileManager,$zcall:globalThis.$zcall},globalThis.$zInAppPayment={openUrl:()=>{},closeInAppPayment:()=>{}},globalThis.$capp={launchCompactApp:()=>{}},globalThis.$zsqlitebw={},globalThis.$zsafeStorage={},globalThis.$zMigrateDrive={getEstimatedCopyTime:()=>{}}},cF85:function(e,t,s){"use strict";var i=s("jDHv"),n=s("x9oK"),a=s("YEoC"),r=s("LzQZ"),o=s("DI/x"),l=s("PmZf"),c=s("AH6j"),d=s("1CsI");class u extends c.b{constructor(e,t){super(),this.fullname=e,this.partition=t,this.schemaVersionHistory=i.ModuleContainer.resolve(d.a)}}var h=s("g/Dz"),g=s("bSii"),m=s("3wcW");class p extends m.a{constructor(e,t,s,i){super(e,t,s,!1),this._transaction=i,this.allowMissingTable=!1}createMissingTable(e){throw new o.z("IndexedDB doesn't support create missing tables")}async _getTables(){return Array.from(this.instance.objectStoreNames)}async _createTable(e){const t=this.instance;let s={};if(e.isNonFieldlikeEntity)s={autoIncrement:!0};else{const t=e.primaryIndex;s={keyPath:Object(g.a)(t.getRealFields()),autoIncrement:t.autoIncrement}}if(t.objectStoreNames.contains(e.tableName))return;const i=t.createObjectStore(e.tableName,s);Object.values(e.indices).map((e=>{if("primary"===e.name)return;const t=e.fields.map((e=>"object"!=typeof e?e:"length"===e.type?`${e.field.toString()}.length`:e.field));i.createIndex(e.name,Object(g.a)(t),{unique:e.unique})}))}async _createIndex(e,t){const s=this._transaction;if(!s)throw new o.C(`Can't create '${t}' due to unavailable IDBTransaction transaction!`);const i=s.objectStore(e.tableName),n=e.getIndex(t),a=n.fields.map((e=>"object"!=typeof e?e:"length"===e.type?`${e.field.toString()}.length`:e.field));var r;i.indexNames.contains(t)||i.createIndex(t,1===(r=a).length?r[0]:r,{unique:n.unique})}_addColumns(e,t){return Promise.resolve()}}class f extends u{async create(){let e=null;const t=(t,s)=>(null===e&&(e=new p(this.fullname,this.partition,t,s)),e.addEventListener(l.b.SchemaMigratedAbnormally,(e=>this.dispatchEvent(e))),e),s=this.schemaVersionHistory,i=Date.now(),n=await new Promise(((e,i)=>{const n=indexedDB.open(this.fullname,this.partition.version);n.onupgradeneeded=async e=>{if(null!==e.newVersion)try{const s=t(n.result,n.transaction);await s.upgrade(e.oldVersion,e.newVersion)}catch(s){throw n.transaction.abort(),s}},n.onsuccess=async()=>{try{const i=n.result,r=t(i,n.transaction);await r.validate(),s.updateSchemaVersion(a.a.IDB,this.fullname,i.version),e(i)}catch(r){i(r)}},n.onerror=()=>{let e=n.error;e=h.a.isVersionError(e)?new o.o({fullname:this.fullname,currentVersion:h.a.getCurrentVersionFromVersionError(e),requestedVersion:this.partition.version}):new o.k(e.message),i(e)},n.onblocked=()=>{var e;const t=new o.k((null===(e=n.error)||void 0===e?void 0:e.message)||"");i(t)}})),r=Date.now(),c={fullname:this.fullname,adapterType:a.a.IDB,startTime:i,endTime:r};this.dispatchEvent(new l.h(c));return r-i>=2e4&&this.dispatchEvent(new l.c(c)),n.onversionchange=function(e){if(null===e.newVersion){e.target.close()}},n}}var v=s("Mgpg"),b=s("UK4g"),I=s("YZti"),y=s("8/YW");class _ extends c.b{constructor(e){super(),this.registerListeners(e)}registerListeners(e){const t=e=>{this.dispatchEvent(e)},s=[];s.push(e.addEventListener(l.b.SuccessOpenDB,t)),s.push(e.addEventListener(l.b.LongOpenDB,t)),s.push(e.addEventListener(l.b.SchemaMigratedAbnormally,t));i.ModuleContainer.resolve(y.a).addEventListener(y.b.Exit,(()=>{s.forEach((e=>e()))}))}}let C=null;const O=()=>{if(null===C){const e=i.ModuleContainer.resolve(v.ZLoggerFactory);C=e.createZLogger("idb",["connection"])}return C};class E extends _{constructor(e){super(e),this.connectionFactory=e,this.connection=null,this.isConnectionDestroyed=!1,this.reOpenCountIn1Hour=0,this.firstTimeReOpenDttm=null,this.onAbnormallyCloseListeners=[],this.failedToOpenDBConnectionErrorMessage=""}get hasActiveConnection(){return null!==this.connection}async getName(){return(await this.getConnection()).name}async getObjectStoreNames(){return(await this.getConnection()).objectStoreNames}async getVersion(){return(await this.getConnection()).version}canReOpenConnection(){return this.reOpenCountIn1Hour<=b.i}updateReopenMetadata(){const e=Date.now();null===this.firstTimeReOpenDttm||(()=>Math.abs(e-this.firstTimeReOpenDttm)>=36e5)()?(this.firstTimeReOpenDttm=e,this.reOpenCountIn1Hour=1):this.reOpenCountIn1Hour+=1}async getConnection(e=!1){const t=async()=>{let e=null;try{e=await this.connectionFactory.create()}catch(t){if(I.a.isFailedToOpenConnectionError(t)){return O().zsymb(18,"VVAj_5",`${t}`),this.failedToOpenDBConnectionErrorMessage=t.message,new Promise(((e,t)=>{setTimeout((()=>{this.getConnection(!0).then(e).catch(t)}))}))}throw t}return e.onclose=()=>{var t;this.dispatchEvent(new l.a((null===(t=e)||void 0===t?void 0:t.name)||""))},e};if(e){if(this.isConnectionDestroyed)throw new o.c("The database connection has been manually closed and destroyed!",["idb"]);if(this.updateReopenMetadata(),!this.canReOpenConnection()){const e=this.failedToOpenDBConnectionErrorMessage;throw this.failedToOpenDBConnectionErrorMessage="",new o.k(e)}const e=this.connection;e&&this.onAbnormallyCloseListeners.forEach((t=>{e.removeEventListener("close",t)})),this.connection=await t()}else this.connection||(this.connection=await t());return this.connection}async getTransaction(e,t){let s=await this.getConnection(),i=null;try{i=s.transaction(e,t)}catch(n){if(!n||!h.a.isInvalidStateError(n))throw n;s=await this.getConnection(!0),i=s.transaction(e,t)}return i}close(e={destroyAfterClosed:!0}){this.connection&&!this.isConnectionDestroyed&&(this.connection.close(),this.connection=null,this.isConnectionDestroyed=e.destroyAfterClosed)}}var M=s("VTBJ"),S=s("X2RP");class T extends S.a{constructor(e,t){super(),this.instance=e,this.transactionManager=t}getExecutorName(){return"idb"}async clear({transaction:e,meta:t,deferrer:s}){const i=t.tableConfig,n=(await this.getStore(e,i,a.g.READWRITE,s.reject)).clear();return Object(h.e)(n)}async get({transaction:e,meta:t,params:s,deferrer:i}){const n=s.index,a=s.key,r=t.tableConfig,o=(await this.getStoreOrIndex(e,r,n,i.reject)).get(a);return this.getResult(r,o)}async getMulti({transaction:e,meta:t,params:s,deferrer:i}){const{index:n,keys:a,onValue:r}=s,o=t.tableConfig,l=await this.getStoreOrIndex(e,o,n,i.reject),c=a.map((async e=>{const t=l.get(e),s=await this.getResult(o,t);return r&&r(s),s}));return Promise.all(c)}async getMultiIfExists({transaction:e,meta:t,params:s,deferrer:i}){const n=s.index,a=s.keys,r=t.tableConfig,o=await this.getStoreOrIndex(e,r,n,i.reject),l=a.map((e=>{const t=o.get(e);return this.getResult(r,t)}));return Promise.all(l).then((e=>e.filter(Boolean)))}getAll(e){return e.params.direction===a.c.PREV||e.params.direction===a.c.PREV_UNIQUE||e.params.filter||e.params.predicate||e.params.aborted||e.params.onProgress||e.params.onValue||e.params.useKeyRangeV2&&e.params.range&&Object(h.f)(e.params.range)?this.getAllByCursor(e):this.getAllWithoutFilter(e)}async getAllKeyByCursor({meta:e,params:t,transaction:s,deferrer:i}){const n=e.tableConfig,a=t.useKeyRangeV2,r=this.toIDBKeyRange(t.range),o=(await this.getStoreOrIndex(s,n,t.index,i.reject)).openKeyCursor(r,t.direction);return null===o?[]:new Promise(((e,s)=>{const i=[];o.onsuccess=()=>{const s=o.result;if(null===s||null===s.primaryKey)return void e(i);if(a&&t.range&&Object(h.f)(t.range)){const e=Object(h.d)(s.key,r,t.direction);if(null!==e)return void s.continue(e)}const n=s.primaryKey;i.push(n);i.length>=t.limit?e(i):s.continue()},o.onerror=()=>{s(o.error)}}))}async getAllKey(e){if(e.params.direction===a.c.PREV||e.params.direction===a.c.PREV_UNIQUE||e.params.useKeyRangeV2&&e.params.range&&Object(h.f)(e.params.range))return this.getAllKeyByCursor(e);{const{meta:t,params:s,transaction:i}=e,n=t.tableConfig,a=this.toIDBKeyRange(s.range),r=(await this.getStoreOrIndex(i,n,s.index,e.deferrer.reject)).getAllKeys(a,s.limit);return Object(h.e)(r)}}async getAndUpdate(e){const{transaction:t,params:s,meta:i}=e,n=s.index,r=s.updater,l=s.key,c=i.tableConfig,d=(await this.getStoreOrIndex(t,c,n,e.deferrer.reject)).get(l),u=await this.getResult(c,d);if(void 0===u){if(!1!==s.ignoreNotFound)throw new o.f("Update undefined document");return}const g=await this.getStore(t,c,a.g.READWRITE,e.deferrer.reject),m=await r(u||{}),p=this.toDB(c,m),f=g.put(p);return await Object(h.e)(f),m}insert(e){return e.params.replace?this._insertOrReplace(e):this._insertIfNotExist(e)}insertMulti(e){return e.params.replace?this.insertOrReplaceMulti(e):this.insertIfNotExistMulti(e)}async update(e){const{transaction:t,meta:s,params:i,deferrer:n}=e,r=s.tableConfig,o=await this.getStore(t,r,a.g.READWRITE,n.reject),l=r.getIndex("primary").fields.map((e=>e.field)),c=Array.isArray(i.key)?i.key:[i.key],d=Object(M.a)({},i.value);return l.forEach(((e,t)=>{d[e]=c[t]})),this._update(o,i.key,i.attributes,this.toDB(r,d,!1),i.index,i.ignoreNotFound).then((({fail:e})=>!e.length))}async updateMulti(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,r=await this.getStore(t,n,a.g.READWRITE,e.deferrer.reject),o={success:[],fail:[]},l=n.getIndex("primary").fields.map((e=>e.field)),c=i.patches.map((t=>{const s=Array.isArray(t.key)?t.key:[t.key],a=Object(M.a)({},t.value);return l.forEach(((e,t)=>{a[e]=s[t]})),this._update(r,t.key,t.attributes,this.toDB(n,a,!1),i.index,i.ignoreNotFound).then((({success:t,fail:s})=>{o.success.push(...this.fromDB(e.meta.tableConfig,t)),o.fail.push(...this.fromDB(e.meta.tableConfig,s))}))}));return Promise.all(c).then((()=>o))}async delete({transaction:e,meta:t,params:s,deferrer:i}){const n=t.tableConfig,r=s.index,o=s.key,l=await this.getStore(e,n,a.g.READWRITE,i.reject);if("primary"===r){const e=l.delete(o);return this.checkReqSuccessOrFail(e)}{const e=l.index(r),t=this.toIDBKeyRange({from:o,to:o}),s=e.getAllKeys(t),i=(await Object(h.e)(s)).map((e=>{const t=l.delete(e);return Object(h.e)(t)}));return Promise.all(i).then((()=>!0)).catch((()=>!1))}}async deleteMulti({transaction:e,meta:t,params:s,deferrer:i}){const n=t.tableConfig,r=s.index,o=await this.getStore(e,n,a.g.READWRITE,i.reject),l=s.keys;let c=[];const d={success:[],fail:[]};if("primary"===r)c=l.map((e=>{const t=o.delete(e);return this.checkReqSuccessOrFail(t).then((t=>{t?d.success.push(e):d.fail.push(e)}))}));else{const e=o.index(r);c=l.map((async t=>{const s=this.toIDBKeyRange({from:t,to:t}),i=(await Object(h.e)(e.getAllKeys(s))).map((e=>Object(h.e)(o.delete(e))));return Promise.all(i).then((()=>{d.success.push(t)})).catch((()=>{d.fail.push(t)}))}))}return Promise.all(c).then((()=>d))}async count({transaction:e,meta:t,params:s,deferrer:i}){const n=t.tableConfig,a=this.toIDBKeyRange(s.range),r=s.useKeyRangeV2,o=await this.getStoreOrIndex(e,n,s.index,i.reject);if(r&&s.range&&Object(h.f)(s.range)){const e=o.openKeyCursor(a);return null===e?0:new Promise(((t,s)=>{let i=0;e.onsuccess=()=>{const s=e.result;if(null===s||null===s.primaryKey)return void t(i);const n=Object(h.d)(s.key,a);null===n?(i+=1,s.continue()):s.continue(n)},e.onerror=()=>{s(e.error)}}))}{const e=o.count(a);return Object(h.e)(e)}}async findAndDelete({transaction:e,meta:t,params:s,deferrer:i}){const n=t.tableConfig,{filter:r,index:o,useKeyRangeV2:l}=s,c=r?e=>Object(h.b)(e,r):null,d=this.toIDBKeyRange(s.range);let u=await this.getStore(e,n,a.g.READWRITE,i.reject);"primary"!==o&&(u=u.index(o));const g=u.openCursor(d);return null===g?[]:new Promise(((e,t)=>{let i=new Set,a=!1;g.onsuccess=()=>{if(a)return;const t=g.result;if(null===t||null===t.value)return a=!0,void e(Array.from(i));if(l&&s.range&&Object(h.f)(s.range)){const e=Object(h.d)(t.key,d);if(e)return void t.continue(e)}const r=this.fromDB(n,t.value);if(!c||c(r)){t.delete();const s=t.key;if(i.add(s),a)return void e(Array.from(i))}t.continue()},g.onerror=()=>{t(g.error)}}))}async getAllByCursor({transaction:e,meta:t,params:s,deferrer:i}){const n=t.tableConfig,{onProgress:a,advance:r,stepCount:l,onValue:c,predicate:d,filter:u,useKeyRangeV2:g}=s;if(d&&u){const e=new o.n("Query using both 'filter' and 'predicate' is not allowed!");return void(null==i||i.reject(e))}let m=null;(d||u)&&(m=d||(e=>Object(h.b)(e,u)));const p=await this.getStoreOrIndex(e,n,s.index,i.reject),f=this.toIDBKeyRange(s.range),v=p.openCursor(f,s.direction);return null===v?[]:new Promise(((e,t)=>{const i=[];let o=!1,d=!!r;const u=()=>{if(o)return;const t=v.result;if(null===t||null===t.value)return o=!0,void e(i);if(d&&r)return d=!1,void t.advance(r);if(g&&s.range&&Object(h.f)(s.range)){const e=Object(h.d)(t.key,f,s.direction);if(e)return void t.continue(e)}const u=this.fromDB(n,t.value);c&&c(u),m&&!m(u)||(i.push(u),a&&a(i,u),o=i.length>=s.limit,o||(o=!!s.aborted&&s.aborted(i,u)),!o)?(l&&t.advance(l),t.continue()):e(i)};v.onsuccess=()=>{try{u()}catch(e){t(e)}},v.onerror=()=>{t(v.error)}}))}async getAllWithoutFilter({transaction:e,meta:t,params:s,deferrer:i}){const n=t.tableConfig,a=this.toIDBKeyRange(s.range),r=(await this.getStoreOrIndex(e,n,s.index,i.reject)).getAll(a,s.limit);return this.getResult(n,r)}async getStoreOrIndex(e,t,s,i){const n=await this.getStore(e,t,a.g.READONLY,i);if("primary"===s)return n;const r=t.getIndex(s);if(!r)throw new o.u(s);return n.index(r.name)}async _insertIfNotExist(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,r=await this.getTransaction(t,n,a.g.READWRITE,e.deferrer.reject),o=r.objectStore(n.tableName);let l=null;if(!n.isNonFieldlikeEntity){const e=n.primaryIndex;if(!e.autoIncrement){const t=Object(g.a)(e.createKey(i.value)),s=o.get(t);l=await new Promise((e=>{s.onsuccess=()=>{const t=this.fromDB(n,s.result);e(t)},s.onerror=()=>{e(null)}}))}}if(l)return Promise.resolve(l);{const e=o.add(this.toDB(n,i.value)),s=await Object(h.e)(e),a=Object(h.c)(n,s,i.value);return t?a:new Promise(((t,s)=>{r.oncomplete=()=>{t(a)},r.onerror=()=>{var n;0===(null===(n=e.error)||void 0===n?void 0:n.code)?t(i.value):s(e.error)}}))}}async _insertOrReplace(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,r=await this.getTransaction(t,n,a.g.READWRITE,e.deferrer.reject),o=r.objectStore(n.tableName).put(this.toDB(n,i.value)),l=await Object(h.e)(o),c=Object(h.c)(n,l,i.value);return t?c:new Promise(((e,t)=>{r.oncomplete=()=>{e(c)},r.onerror=()=>{t(o.error)}}))}async insertIfNotExistMulti(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,r=await this.getTransaction(t,n,a.g.READWRITE,e.deferrer.reject),o=r.objectStore(n.tableName),l={success:[],fail:[]},c=i.values.map((async e=>{let t=!1;if(!n.isNonFieldlikeEntity){const s=n.primaryIndex;if(!s.autoIncrement){const i=Object(g.a)(s.createKey(e)),a=o.get(i);t=await new Promise((e=>{a.onsuccess=()=>{const t=this.fromDB(n,a.result);let s=!1;void 0!==t&&(l.success.push(t),s=!0),e(s)},a.onerror=()=>{e(!1)}}))}}if(t)return;const s=o.add(this.toDB(n,e));return this.checkReqSuccessOrFail(s).then((t=>{if(t){let t=e;if(!n.isNonFieldlikeEntity){const{primaryIndex:e}=n,i=e.fields[0].field;Object.prototype.hasOwnProperty.call(t,i)||(t[i]=s.result)}l.success.push(t)}else l.fail.push(e)})).catch((()=>{l.fail.push(e)}))}));return t?Promise.all(c).then((()=>l)):new Promise((e=>{r.oncomplete=()=>{e(l)},r.onerror=()=>{e(l)}}))}async insertOrReplaceMulti(e){const{transaction:t,meta:s,params:i}=e,n=s.tableConfig,r=await this.getTransaction(t,n,a.g.READWRITE,e.deferrer.reject),o=r.objectStore(n.tableName),l={success:[],fail:[]},c=i.values.map((e=>{const t=o.put(this.toDB(n,e));return this.checkReqSuccessOrFail(t).then((s=>{if(s){let s=e;if(!n.isNonFieldlikeEntity){const{primaryIndex:e}=n,i=e.fields[0].field;Object.prototype.hasOwnProperty.call(s,i)||(s[i]=t.result)}l.success.push(s)}else l.fail.push(e)})).catch((()=>{l.fail.push(e)}))}));return t?Promise.all(c).then((()=>l)):new Promise((e=>{r.oncomplete=()=>e(l),r.onerror=()=>e(l)}))}async _update(e,t,s,i,n,a){if("primary"===n){const n=e.get(t),r=await Object(h.e)(n);if(!r){if(a)return{success:[],fail:[]};throw new o.f("Update undefined document!")}const l=s.reduce(((e,t)=>(e[t]=i[t],e)),r),c=e.put(l);return this.checkReqSuccessOrFail(c).then((e=>e?{success:[l],fail:[]}:{success:[],fail:[r]}))}{const r=this.toIDBKeyRange({from:t,to:t}),l=e.index(n).getAll(r),c=await Object(h.e)(l);if(0===c.length){if(a)return{success:[],fail:[]};throw new o.f("Update undefined document!")}const d=c.map((e=>s.reduce(((e,t)=>(e[t]=i[t],e)),e))),u=d.map((t=>{const s=e.put(t);return Object(h.e)(s)}));return Promise.all(u).then((()=>({success:d,fail:[]}))).catch((()=>({success:[],fail:c})))}}checkReqSuccessOrFail(e){return Object(h.e)(e).then((()=>!0)).catch((()=>!1))}async getTransaction(e,t,s,i){const n=t.tableName;if(e>0){const t=this.transactionManager.get(e);return Promise.resolve(t.instance)}const a=await this.instance.getTransaction([n],s);return a.addEventListener("error",(()=>i(a.error))),a.addEventListener("abort",(()=>i(a.error))),a}async getStore(e,t,s,i){return(await this.getTransaction(e,t,s,i)).objectStore(t.tableName)}toIDBKeyRange(e){if(e){if(e.from&&e.to)try{return IDBKeyRange.bound(e.from,e.to,e.excludeFrom,e.excludeTo)}catch(t){throw t}return e.from?IDBKeyRange.lowerBound(e.from,e.excludeFrom):e.to?IDBKeyRange.upperBound(e.to,e.excludeTo):void 0}}getResult(e,t){return Object(h.e)(t).then((t=>this.fromDB(e,t)))}toDB(e,t,s=!0){try{e.validate(t,s)}catch(r){this.logger.zsymb(21,"Dq0erf",["{}: {} (database={}, table={})","YzxbXs"],r.name,r.message,e.dbName,e.name)}const{isNonFieldlikeEntity:i}=e,n=e.getTransformConfig(a.a.IDB);return function(e){if(!n)return e;const t=e=>{const t=i?e:Object(M.a)({},e);return n.toDB(t),t};return Array.isArray(e)?e.map(t):t(e)}(t=e.prepareValue(t,s,i))}fromDB(e,t){const s=e.getTransformConfig(a.a.IDB);if(!s)return t;const i=e=>(s.fromDB(e),e);return Array.isArray(t)?t.map(i):i(t)}}class w{constructor(e,t){this.partition=e,this.instance=t}async beginTransaction(e){try{const t=e.params.tables.map((e=>this.partition.getTableConfig(e).tableName)),s=e.params.mode,i=await this.instance.getTransaction(t,s),n=e.transaction;e.deferrer.resolve(new R(n,i))}catch(t){e.deferrer.reject(t)}}}class R{constructor(e,t){this.id=e,this.instance=t,this.error=null,this.closed=void 0,this.onCloseListeners=[],this.closed=!1;const s=()=>{const{error:e}=t;this.closed=!0,this.error=e,this.onCloseListeners.forEach((t=>t(e))),t.removeEventListener("complete",s),t.removeEventListener("abort",s),t.removeEventListener("error",s)};t.addEventListener("complete",s),t.addEventListener("abort",s),t.addEventListener("error",s)}execute(e){return e().catch((e=>{throw this.instance.abort(),e}))}commit(){return Promise.resolve()}onClose(e){this.onCloseListeners.push(e),this.closed&&e(this.error)}}class L extends n.a{constructor(e,t,s,i,n,a){super(e,t,s,i,n,a,{})}async doesDatabaseExist(e){try{return(await function(e){const t=globalThis.indexedDB.open(e);return new Promise(((s,i)=>{t.onupgradeneeded=function(){var s;null===(s=t.transaction)||void 0===s||s.abort(),i(new A(`No database whose name is ${e} exists`))},t.onsuccess=function(){s(t.result)},t.onerror=function(){i(t.error)}}))}(e)).close(),!0}catch(t){if(t.name===D)return!1;throw t}}async deleteThisDatabase(e){super.deleteThisDatabase(e);const t=0!=e.preventNewQuery;if(!(await this.doesDatabaseExist(this.fullName)))return t||this.setActiveStatus(!0),void this.logger.zsymb(6,"UtigPd",`Skip db deletion due to non-existence: '${this.fullName}'`);this.instance.close({destroyAfterClosed:t});const s=indexedDB.deleteDatabase(this.fullName),i=this.instance,n=this.fullName,a=this.logger;return a.zsymb(6,"W4jPnP",`The database connection is manually closed due to database deletion: '${n}'`),new Promise(((e,r)=>{const o=()=>{e(),t||this.setActiveStatus(!0)};s.onsuccess=function(){a.zsymb(0,"FRnOHb",`Delete database sucessfully: '${n}'`),o()},s.onblocked=function(){a.zsymb(0,"c8SUFm",`Delete database blocked: '${n}'`),o(),i.close()},s.onerror=function(){const e=s.error;a.zsymb(0,"Dk4_5t",`Failed to delete database: '${n}' - Error: ${e}`),r(e)}}))}closeThisDatabase(e){if(super.closeThisDatabase(e),!this.instance.hasActiveConnection)return Promise.resolve();this.instance.close(),this.logger.zsymb(6,"LZ1SqW",`The database connection is manually closed due to manual database closing: '${this.fullName}'`);const t=void 0!==e.idbTimeout?e.idbTimeout:b.b;return new Promise((e=>{setTimeout((()=>{e()}),t)}))}static async factory(e,t){const s=new f(e,t),n=new E(s),o=i.ModuleContainer.resolve(r.a),l=new w(t,n),c=new T(n,o);return await Promise.all(t.tables.map((e=>{var s;return null===(s=e.getTransformConfig(a.a.IDB))||void 0===s?void 0:s.init(e,t.cipherKey)}))),new L(t,e,o,n,c,l)}}const D="NonExistedDBError";class A extends Error{constructor(e){super(e),this.name=D}}var F;let j=i.ModuleContainer.injectable()(F=class{async createAdapter(e,t){return L.factory(e,t)}async getExistedPartitionKeys(){return[]}})||F;i.ModuleContainer.registerSingleton(n.b,j)},d951:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.executor=e,this.resolve=()=>{},this.reject=()=>{}}execute(){this.executor().then(this.resolve).catch(this.reject)}getResult(){return new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}},dKg8:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var i=s("E/Lo"),n=s("QDKs"),a=s("UHN6"),r=s("jx7S");class o{constructor(e,t,s){this._options=void 0,this._name=void 0,this._id=void 0,this._taskManager=void 0,this._state=void 0,this._retry=0,this._waitForRetry=1e3,this._retryCheatingCount=0,this._backupData=void 0,this._timeout=a.d,this._timer=void 0,this._restore=void 0,this._executor=void 0,this._error=void 0,this._options=s,this._name=e,this._id=Object(i.g)(),this._taskManager=t,this._state="created",this._retry=(null==s?void 0:s.retry)||this._retry,this._waitForRetry=(null==s?void 0:s.waitForRetry)||this._waitForRetry,this._timeout=(null==s?void 0:s.timeout)||this._timeout,this._taskManager.addTask(this),this._createTimer(!0)}get options(){return this._options}get name(){return this._name}get id(){return this._id}get state(){return this._state}get backupData(){return this._backupData}onRestore(e){this._restore=e}onError(e){this._error=e}execute(e,t){"ended"===this.state&&(this._state="created",this._taskManager.addTask(this)),this._clearTimer(),this._state="ready",this._backupData=t,this._executor=()=>{setTimeout(e,10)},this._taskManager.runTask(this)}close(e=!1,t){this._clearTimer(),this._state="ended",this._taskManager.doneTask(this,e,t)}destroy(){}restore(e){var t;null===(t=this._restore)||void 0===t||t.call(this,e)}async run(){try{if("created"===this.state||"running"===this.state)return;if(!this._executor)throw new Error("Task executor is not defined.");this._createTimer(),this._state="running";window.$taskCheatingFailCount;0,await this._executor()}catch(t){var e;if(this._retry>0)return Object(i.d)()&&n.a.info(a.c,"TASK_RETRY",this._retry,Object(r.a)(this),t),this._retry--,void Object(i.i)(this._waitForRetry).then((()=>{this._state="ready",this.run()}));Object(i.d)()&&n.a.error(a.c,"TASK_ERROR",Object(r.a)(this),t),null===(e=this._error)||void 0===e||e.call(this,t),this.close()}}_createTimer(e=!1){this._clearTimer(),this._timer=setTimeout((()=>{this.close(!0),this._timer=void 0,Object(i.d)()&&n.a.warn(a.c,`Task (Name: ${this.name} - ID: ${this.id}) is timeout.${e?" Task is not defined executor.":""}`)}),this._timeout)}_clearTimer(){this._timer&&clearTimeout(this._timer),this._timer=void 0}}},eBEg:function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var i=s("UJDs");const n="z",a=["info","warn","debug","error","critical"],r=["","F","C","T","FT","CT"];function o(){let e=0;const t={},s={};return a.forEach((i=>{r.forEach((a=>{""===a?(t[e]=`${n}${i}A`,s[`${n}${i}A`]=e,e+=1):"T"===a?(t[e]=`${n}${i}AT`,s[`${n}${i}AT`]=e,e+=1):(t[e]=`${n}${i}${a}`,s[`${n}${i}${a}`]=e,e+=1)}))})),{EnumeratedLevels:t,ReversedEnumeratedLevels:s}}Object.freeze(r),Object.freeze(a);const l=o().EnumeratedLevels,c=o().ReversedEnumeratedLevels;Object.freeze(l),Object.freeze(c);var d=s("jDHv"),u=s("jGDt"),h=s("KRcn");const g={[i.b.info]:!0,[i.b.warn]:!0,[i.b.error]:!0,[i.b.critical]:!0,[i.b.debug]:!1};var m=s("Wc52");class p{constructor(e,t){this.tags=e,this.transporters=t,this.enabled=!0,this.Sentry=null,this.tempOffConfig={toConsole:!1,toFile:!1,toSentry:!1},this.zsentry=(...e)=>{this.Sentry&&this.Sentry.captureException(new Error(e.join(" ")))},this.zfatal=(...e)=>{},this.zcritical=(...e)=>{},this.zsymb=(e,t,...s)=>{if(!this.enabled)return;const i=l[e];let n=[];if(i.endsWith("T")&&(null==s?void 0:s.length)>0&&(n=s.shift()),i.includes("zcritical"))return void(this.Sentry&&this.Sentry.captureException(new Error(s.join(" "))));const a=this._getLevel(i);let r="None";i.endsWith("A")||i.endsWith("AT")?r="ConsoleFile":i.endsWith("C")||i.endsWith("CT")?r="toConsole":(i.endsWith("F")||i.endsWith("FT"))&&(r="toFile"),"None"!==r&&this._applyFilter({metadata:{tick:Date.now(),level:a,ln:t,template:n,targetTransporter:r,tags:this.tags},args:s})},this._applyFilter=e=>{if(!g[e.metadata.level])return;let t=e.metadata.targetTransporter;const s=d.ModuleContainer.resolve(u.a),i=Object(h.getProcess)(),n=!!this.transporters.consoleTransporter&&m.a[i].toConsole&&s.isEnabledConsole(),a=!!this.transporters.fileTransporter&&m.a[i].toFile;"ConsoleFile"===t&&(n||(t="toFile"),a||(t="None")),"toConsole"!==t||n||(t="None"),"toFile"!==t||a||(t="None"),"None"!==t&&(e.metadata.targetTransporter=t,this._transport(e))},this._transport=e=>{const t=e.metadata.targetTransporter;var s,i;"toConsole"!==t&&"ConsoleFile"!==t||(null===(s=this.transporters.consoleTransporter)||void 0===s||s.transport(e));"toFile"!==t&&"ConsoleFile"!==t||(null===(i=this.transporters.fileTransporter)||void 0===i||i.transport(e))},this._getLevel=e=>{let t=e;e.endsWith("A")?t=e.replace("A",""):e.endsWith("AT")?t=e.replace("AT",""):e.endsWith("C")?t=e.replace("C",""):e.endsWith("CT")?t=e.replace("CT",""):e.endsWith("F")?t=e.replace("F",""):e.endsWith("FT")&&(t=e.replace("FT",""));let s=i.b.info;switch(t){case"zinfo":s=i.b.info;break;case"zwarn":s=i.b.warn;break;case"zerror":s=i.b.error;break;case"zdebug":s=i.b.debug}return s},this.zinfo=(...e)=>{zconsole.debug("[ZLL-ALERT]: zinfo is not recognized. Function cannot be used directly")},this.zinfoC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zinfoC is not recognized. Function cannot be used directly")},this.zinfoF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zinfoF is not recognized. Function cannot be used directly")},this.zwarn=(...e)=>{zconsole.debug("[ZLL-ALERT]: zwarn is not recognized. Function cannot be used directly")},this.zwarnC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zwarnC is not recognized. Function cannot be used directly")},this.zwarnF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zwarnF is not recognized. Function cannot be used directly")},this.zerror=(...e)=>{zconsole.debug("[ZLL-ALERT]: zerror is not recognized. Function cannot be used directly")},this.zerrorC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zerrorC is not recognized. Function cannot be used directly")},this.zerrorF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zerrorF is not recognized. Function cannot be used directly")},this.zdebug=(...e)=>{zconsole.debug("[ZLL-ALERT]: zdebug is not recognized. Function cannot be used directly")},this.zdebugC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zdebugC is not recognized. Function cannot be used directly")},this.zdebugF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zdebugF is not recognized. Function cannot be used directly")}}disableFile(){this.tempOffConfig.toFile=!0}enableFile(){this.tempOffConfig.toFile=!1}disableConsole(){this.tempOffConfig.toConsole=!0}enableConsole(){this.tempOffConfig.toConsole=!1}static create(e,t){return new this(e,t)}pause(){this.enabled=!0}resume(){this.enabled=!1}}},ebA4:function(e,t,s){"use strict";s.d(t,"c",(function(){return g})),s.d(t,"b",(function(){return m})),s.d(t,"a",(function(){return p}));var i=s("VTBJ"),n=s("UJDs"),a=s("j6JD"),r=s("CDcE"),o=s("fsQs"),l=s("XuBa"),c=(s("7FSS"),s("Lrq5")),d=s("6xEa"),u=s.n(d);const h=new TextEncoder;function g(e,t={}){const{noTruncate:s=!1,noCompress:n=!1}=t;if(Object(r.c)(e)){0;let t=g(e.asset,{noTruncate:!0});return"string"!=typeof t&&(t=JSON.stringify(t)),Object(i.a)(Object(i.a)({},e),{},{asset:l.a.encrypt(t)})}if(Object(r.b)(e))return g(e.asset,{noTruncate:!0,noCompress:!1});let a=e;if(c.b(a))try{a=e()}catch(d){a="[Function]"}return c.e(a)&&(a=JSON.stringify(a,Object(r.a)())),c.f(a)&&(a=a.replace(/\r\n|\n|\t|\r/g,""),s||(a=a.slice(0,o.l)),n||(a=u.a.compressToBase64(a))),a}function m({metadata:e,args:t},s){const i=Object(a.a)(e.tick),r=e.tags.filter((e=>!!e)).join("|"),l=function(e,t){let s=t.map((e=>g(e,{noCompress:!0})));if(1===s.length&&1===t.length&&"function"==typeof t[0]&&Array.isArray(s[0])&&(s=[...s[0]]),!e)return s.join(" ");let i=e;const n=[];return s.forEach((e=>{-1!==i.search("{}")?i=i.replace("{}",e):n.push(e)})),i.concat(" ").concat(n.join(" "))}(e.template.length>0?e.template[0]:null,t),c="["+e.ln+"]",d=[`${i}`,n.a[e.level].toUpperCase(),r,l,c].join("\t");let u=h.encode(d.concat("\n"));return u.byteLength>o.d.line_hard_lim&&(u=h.encode(d.slice(0,o.d.line_hard_lim)+"[BIG OBJECT]\n")),u}function p(e){const t=new ArrayBuffer(8),s=new DataView(t),i=4294967295,n=~~(e/i),a=e%i-n;return s.setUint32(0,n),s.setUint32(4,a),t}},ez9R:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("jDHv");const n=Object(i.define)("zlog-bin-encoder")},ezdo:function(e,t,s){"use strict";var i,n=s("jDHv"),a=s("HPcM"),r=s("AH6j"),o=s("fsQs"),l=s("Y41u"),c=s("UJDs"),d=s("jGDt"),u=s("7FSS");const h=null===globalThis||void 0===globalThis?void 0:globalThis.performance;let g=Object(n.injectable)()(i=function(e,t){return Object(n.inject)(d.a)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===d.a?Object:d.a])(i=class extends r.b{constructor(e){super(),this._session=e,this._data=[],this._lastPing=0,this._isSessionLineReady=!1,this.add=e=>{this._data.length<5e4&&this._data.push(e),h.now()-this._lastPing>=o.o&&(this._lastPing=h.now(),this._broadcastEvent(l.c.LogBucketRequestFlush)),this._data.length>5e4&&u.a.error(`[ZLL]: bucket size high: ${this._data.length}`)},this.getElectronApi=()=>{let e=null;try{e=$zelectron}catch(t){}return e},this._broadcastEvent=(e,t)=>{switch(e){case l.c.LogBucketRequestFlush:case l.c.RegLogBucketStatus:this.dispatchEvent(new l.b(e,t))}},this.recordSession()}get(e=o.m){return this._isSessionLineReady||u.a.error("[ZLL]: session line not ready. get() returns 0 untils it is ready"),this._isSessionLineReady?this._data.slice(0,e):[]}removeFirst(e=1){this._data.splice(0,e)}getAll(){return this._isSessionLineReady?this._data:[]}size(){return this._data.length}async recordSession(){const e=this._session.getSession();const t=`zlgvers:${e.zlgv} ps:${e.process} build:${e.env}-${e.buildType} pversion:${e.pversion} avers: bhash:${e.build}`,s={metadata:{tags:["Session".toUpperCase()],level:c.b.info,tick:this._session.getProcessStartTime(),ln:0,targetTransporter:"toFile",template:[]},args:[t]};this._data.unshift(s),this._isSessionLineReady=!0}})||i)||i)||i)||i;var m;n.ModuleContainer.registerSingleton(a.a,g);let p=Object(n.injectable)()(m=class extends r.b{constructor(...e){super(...e),this._data=[]}removeFirst(e=1){this._data.splice(0,e)}add(e){this._data.push(e),this._broadcastEvent(l.c.LogBucketRequestFlush)}get(e){const t=this._data.slice(0,e);return this._data=this._data.slice(e),t}getAll(){return this._data}size(){return this._data.length}_broadcastEvent(e,t){switch(e){case l.c.LogBucketRequestFlush:case l.c.SentryLogBucketStatus:this.dispatchEvent(new l.b(e,t))}}})||m;n.ModuleContainer.registerSingleton(a.b,p);const f=Object(n.define)("zsentry-log-trans"),v=Object(n.define)("zfile-log-trans"),b=Object(n.define)("zconsole-log-trans");var I,y,_,C=s("W8fB"),O=s("HD3z"),E=s("/n5c");let M=Object(n.injectable)()(I=function(e,t){return Object(n.inject)(a.b)(e,void 0,0)}(I=Reflect.metadata("design:type",Function)(I=Reflect.metadata("design:paramtypes",[void 0===a.b?Object:a.b])(I=class{constructor(e){this.sentryBucket=e}transport(e){throw new Error("Method not implemented.")}})||I)||I)||I)||I,S=Object(n.injectable)()(y=function(e,t){return Object(n.inject)(a.a)(e,void 0,0)}(y=Reflect.metadata("design:type",Function)(y=Reflect.metadata("design:paramtypes",[void 0===a.a?Object:a.a])(y=class{constructor(e){this.regularBucket=e,this._earlyBirdQueue=[],this._transporterMode=o.u.NEED_CHECK,this.emptyEarlyBirdQueue=e=>{const t=this._earlyBirdQueue.splice(0);if(0===t.length)return;let s=null;if(e===o.u.CALF?s=n.ModuleContainer.resolve(E.a).write:e===o.u.ZLOG&&(s=this.regularBucket.add),s)for(const i of t)s(i)},this.checkZLogConfig=async()=>{let e=o.u.ZLOG;try{e=(await Object(O.b)()).enable_calf?o.u.CALF:o.u.ZLOG}catch(t){e=o.u.ZLOG}return this.emptyEarlyBirdQueue(e),e},this.transport=e=>{if(this._transporterMode===o.u.NEED_CHECK&&(this._transporterMode=o.u.CHECKING,this.checkZLogConfig().then((e=>this._transporterMode=e))),![o.u.NEED_CHECK,o.u.CHECKING].includes(this._transporterMode))return this._earlyBirdQueue.length>0?(this._earlyBirdQueue.push(e),void this.emptyEarlyBirdQueue(this._transporterMode)):void(this._transporterMode===o.u.CALF?n.ModuleContainer.resolve(E.a).write(e):this.regularBucket.add(e));this._earlyBirdQueue.push(e)}}})||y)||y)||y)||y,T=Object(n.injectable)()(_=class{transport(e){n.ModuleContainer.resolve(C.a).write(e)}})||_;n.ModuleContainer.registerSingleton(v,S),n.ModuleContainer.registerSingleton(f,M),n.ModuleContainer.registerSingleton(b,T);var w,R=s("XB6V"),L=s("eBEg"),D=s("h0S/");let A=Object(n.injectable)()(w=function(e,t){return Object(n.inject)(v)(e,void 0,0)}(w=function(e,t){return Object(n.inject)(f)(e,void 0,1)}(w=function(e,t){return Object(n.inject)(b)(e,void 0,2)}(w=Reflect.metadata("design:type",Function)(w=Reflect.metadata("design:paramtypes",[void 0===v?Object:v,void 0===f?Object:f,void 0===b?Object:b])(w=class{constructor(e,t,s){this.fileTransporter=e,this.sentryTransporter=t,this.consoleTransporter=s}createZLogger(e,t=[]){const s=[];"string"==typeof e?s.push(e):Array.isArray(e)&&s.push(...e),s.push(...t);return L.a.create(s,{fileTransporter:this.fileTransporter,consoleTransporter:this.consoleTransporter,sentryTransporter:this.sentryTransporter})}createZLoggerStaging(e,t=[]){return t.push(D.ZLoggerNametags.staging),this.createZLogger(e,t)}})||w)||w)||w)||w)||w)||w;n.ModuleContainer.register(R.a,A);var F=s("yBqK"),j=s("ebA4");class P{constructor(){this._TextEncoder=new TextEncoder}encodeUi8(e,t,s){return e.setUint8(t,s),t+o.b.ui8}encodeUi16(e,t,s){return e.setUint16(t,s),t+o.b.ui16}encodeUi32(e,t,s){return e.setUint32(t,s),t+o.b.ui32}encodeFloat32(e,t,s){return e.setFloat32(t,s),t+o.b.float32}encodeFloat64(e,t,s){return e.setFloat64(t,s),t+o.b.float64}encodeBigInt64(e,t,s){const i=Object(j.a)(s),n=new Uint8Array(i);for(let a=0;a<n.byteLength;a++)t=this.encodeUi8(e,t,n[a]);return t}encodeTotalSize(e,t,s){return this.encodeUi16(e,t,s)}encodeTotalSizeEnd(e,t){return this.encodeUi16(e,t,t+o.b.ui16)}encodeTick(e,t,s){const i=Object(j.a)(s),n=new Uint8Array(i);return this.copyCache(e,t,n)}encodeVers(e,t,s){if(s>32767)throw new Error("[BinEncoder] error: encoding verion is TOO BIG!");return this.encodeUi16(e,t,s)}encodeEncoderVers(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeLevel(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeHeaderNum(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding numOfHeader is TOO BIG!");return this.encodeUi8(e,t,s)}encodeStringOnly(e,t,s){const i=this._TextEncoder.encode(s),n=i.byteLength;return t=this.encodeUi8(e,t,n),this.copyCache(e,t,i)}copyCache(e,t,s){for(let i=0;i<s.byteLength;i++)t=this.encodeUi8(e,t,s[i]);return t}}var k,N=s("6xEa"),U=s.n(N),B=s("Lrq5");let x=Object(n.injectable)()(k=Reflect.metadata("design:type",Function)(k=Reflect.metadata("design:paramtypes",[])(k=class extends P{constructor(){super(),this.MemoryLogBatch=void 0,this.dv=void 0,this._lastOffset=0,this._lastTs=0,this.encodeTags=e=>U.a.compress(e.join(".")),this.encodePayload=(e,t,s)=>{const{ln:i,tags:n,template:a,args:r}=s,l=[],c=this.encodeTags(n),d=a||"";let u=e+4+c.length+d.length;for(let m of r){const e=Object(j.c)(m);if(B.d(e)&&(u+=o.b.ubig64),B.f(e)&&(u+=o.b.ui16*e.length),(B.a(e)||B.g(e)||B.c(e))&&(u+=o.b.ui8),u>o.d.line_malloc)break;l.push(e)}const h={$1:i,$2:c,$3:l,$4:d};l.length||delete h.$3,d.length||delete h.$4;const g=F.encode(h);return this.copyCache(t,e,g)},this.MemoryLogBatch=new ArrayBuffer(o.d.mem_batch_lim),this.dv=new DataView(this.MemoryLogBatch)}getLastBuffer(){return this.MemoryLogBatch.slice(0,this._lastOffset)}encode(e){try{var t;const{metadata:s,args:i}=e;let n=0;n+=o.b.ui16;let a=s.tick;a<=this._lastTs&&(a=this._lastTs+1),this._lastTs=a,n=this.encodeTick(this.dv,n,a),n=this.encodeEncoderVers(this.dv,n,o.v),n=this.encodeLevel(this.dv,n,s.level),n=this.encodeStringOnly(this.dv,n,"4Tuwq6Bb"),n=this.encodePayload(n,this.dv,{ln:s.ln,tags:s.tags,template:null==s||null===(t=s.template)||void 0===t?void 0:t[1],args:i});const r=n+o.b.ui16;return this.encodeTotalSize(this.dv,0,r),n=this.encodeTotalSize(this.dv,n,r),this._lastOffset=n,this.MemoryLogBatch.slice(0,r)}catch(s){throw u.a.error("BinEncoderImpl.encode error:",s),new Error("BinEncoderImpl.encode error")}}})||k)||k)||k;var G=s("ez9R");n.ModuleContainer.registerSingleton(G.a,x);var z=s("K8kB");var V,H=class{constructor(e=[],t=!0){this.tasks=e,this.alive=t}do(...e){return this.add(...e)}add(...e){return this.tasks=this.tasks.concat(e),this}once(e=!1){return this.alive=!1,e&&(async e=>this.async())()||this.sync(),this}every(e){return this.add((()=>new Promise((t=>setTimeout(t,e))))),this.forever(!0)}forever(e=!1){return this.alive=!0,e&&(async e=>this.async())()||this.sync(),this}cancel(){return this.alive=!1,this}async async(){for(let e of this.tasks)await e();this.alive&&this.async()}sync(){for(let e of this.tasks)e();this.alive&&this.sync()}},W=s("PLj1"),$=s("KRcn");let K=Object(n.injectable)()(V=function(e,t){return Object(n.inject)(a.a)(e,void 0,0)}(V=Reflect.metadata("design:type",Function)(V=Reflect.metadata("design:paramtypes",[void 0===a.a?Object:a.a])(V=class extends r.b{constructor(e){super(),this.bucket=e,this.task=void 0,this.start=()=>{var e;if(null!==(e=this.task)&&void 0!==e&&e.alive)return;this.task||(this.task=new H);const t=W.ZLoggerProcessFlushTime[Object($.getProcess)()]||o.f;this.task.add((()=>this._broadcastEvent(l.c.WriteSchedulerRequestFlush))).every(t),this._listenEvents()},this.stop=()=>{this.task&&this.task.cancel(),this.task=void 0},this._listenEvents=()=>{this.bucket.addEventListener(l.c.LogBucketRequestFlush,this._handleFlushRequestFromBucket)},this._handleFlushRequestFromBucket=()=>{var e;this.task&&this.task.alive||(o.q&&u.a.log("Oopsie! Scheduler is somehow not running. Restarting..."),null===(e=this.task)||void 0===e||e.cancel(),this.task=void 0,this.start())}}_broadcastEvent(e){if(e===l.c.WriteSchedulerRequestFlush)this.dispatchEvent(new l.a(e))}})||V)||V)||V)||V;n.ModuleContainer.registerSingleton(z.a,K)},gpNb:function(e,t,s){"use strict";var i,n=s("8/YW"),a=s("jDHv"),r=s("UK4g"),o=s("YEoC"),l=s("PmZf"),c=s("PhBv"),d=s("tHMN"),u=s("NTiX");let h=Object(n.g)()(i=Object(a.injectable)()(i=function(e,t){return Object(a.inject)(c.b)(e,void 0,0)}(i=function(e,t){return Object(a.inject)(u.a)(e,void 0,1)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===c.a?Object:c.a,void 0===u.IDatabaseStateStorage?Object:u.IDatabaseStateStorage])(i=class extends d.a{constructor(e,t){super(),this.queryPlanner=e,this.databaseStateStorage=t,this.removeListeners=()=>{},this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.queryPlanner.addEventListener(l.b.QueryExec,e)),t.push(this.queryPlanner.addEventListener(l.b.QueryError,e)),t.push(this.queryPlanner.addEventListener(l.b.UnexpectedError,e)),t.push(this.queryPlanner.addEventListener(l.b.SuccessOpenDB,e)),t.push(this.queryPlanner.addEventListener(l.b.LongOpenDB,e)),t.push(this.queryPlanner.addEventListener(l.b.ConnectionClosedAbnormally,e)),t.push(this.queryPlanner.addEventListener(l.b.TimeConsumingQuery,e)),t.push(this.queryPlanner.addEventListener(l.b.SchemaMigratedAbnormally,e)),t.push(this.queryPlanner.addEventListener(l.b.Warning,e)),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}authenticate(e){this.queryPlanner.authenticate(e),this.databaseStateStorage.authenticate(e)}do(e){return this.queryPlanner.do(e)}doImmediately(e){return"Qos"===e.database&&e.trace(),this.queryPlanner.doImmediately(e)}deleteDatabase(e,t){return this.doImmediately({trace:(...e)=>{},type:o.e.DeleteDB,database:e,table:"",transaction:0,priority:o.d.BLOCKING,retry:r.h,timing:{},meta:{error:new Error,dead:!1,step:-1},params:t||{}})}deleteAllDatabases(e){return this.doImmediately({trace:(...e)=>{},type:o.e.DeleteAllDBs,database:"",table:"",transaction:0,priority:o.d.BLOCKING,retry:r.h,timing:{},meta:{error:new Error,dead:!1,step:-1},params:e||{}})}closeDatabase(e,t){return this.doImmediately({trace:(...e)=>{},type:o.e.CloseDB,database:e,table:"",transaction:0,priority:o.d.BLOCKING,retry:r.h,timing:{},meta:{error:new Error,dead:!1,step:-1},params:t||{}})}closeAllDatabases(e){return this.doImmediately({trace:(...e)=>{},type:o.e.CloseAllDBs,database:"",table:"",transaction:0,priority:o.d.BLOCKING,retry:r.h,timing:{},meta:{error:new Error,dead:!1,step:-1},params:e||{}})}getAvailableDBBasicInfos(e){return this.queryPlanner.getAvailableDBBasicInfos(e)}})||i)||i)||i)||i)||i)||i;a.ModuleContainer.registerSingleton(d.b,h)},hRcX:function(e,t,s){"use strict";var i=s("VTBJ"),n=s("8/YW"),a=s("jDHv"),r=s("Uzj0"),o=s("DwEK");class l{constructor(e){this.value=e,this.next=null}}class c{constructor(){this.head=null,this.tail=null,this.size=0}enqueue(e){const t=new l(e);this.size+=1,null!==this.tail?(this.tail.next=t,this.tail=t):this.head=this.tail=t}dequeue(){if(null===this.head)return null;this.size-=1;const e=this.head.value;return this.head=this.head.next,null===this.head&&(this.tail=null),e}peek(){return null===this.head?null:this.head.value}inversedPeek(){return null===this.tail?null:this.tail.value}getSize(){return this.size}}class d{constructor(){this.sortedPriorityValues=[],this.queues={}}enqueue(e,t){-1!==function(e,t){let s=e.length;if(0===s)return-1;let i=0,n=s-1;for(;i<=n;){const s=i+Math.floor((n-i)/2);if(e[s]===t)return s;e[s]>t?n=s-1:i=s+1}return-1}(this.sortedPriorityValues,t)||(this.sortedPriorityValues.push(t),this.sortedPriorityValues.sort(),this.queues[t]=new c);this.queues[t].enqueue(e)}dequeue(){const e=this.sortedPriorityValues.length;if(0===e)return null;for(let t=0;t<e;t+=1){const e=this.sortedPriorityValues[t],s=this.queues[e];if(0!==s.getSize())return s.dequeue()}return null}getSize(){let e=0;for(const t of this.sortedPriorityValues){e+=this.queues[t].getSize()}return e}peek(){const e=this.sortedPriorityValues.length;if(0===e)return null;for(let t=0;t<e;t+=1){const e=this.sortedPriorityValues[t],s=this.queues[e];if(0!==s.getSize())return s.peek()}return null}inversedPeek(){const e=this.sortedPriorityValues.length;if(0===e)return null;for(let t=e-1;t>=0;t-=1){const e=this.sortedPriorityValues[t],s=this.queues[e];if(0!==s.getSize())return s.inversedPeek()}return null}}var u=s("qBTQ");class h{initData(){return new d}push(e,t){const s=Object(i.a)(Object(i.a)(Object(i.a)({},u.a),t),{},{id:Object(u.b)()});e.enqueue(s,t.priority)}getCandidate(e){return e.dequeue()}}var g=s("Mgpg"),m=s("YEoC"),p=s("DI/x"),f=s("PmZf"),v=s("xI/L"),b=s("YZti");var I,y=s("MRjZ"),_=s("UJ0r"),C=s("teaq"),O=s("8eps"),E=s("oM1A"),M=s("Abbu"),S=s("PhBv");let T=Object(n.g)()(I=a.ModuleContainer.injectable()(I=function(e,t){return a.ModuleContainer.inject(_.b)(e,void 0,0)}(I=function(e,t){return a.ModuleContainer.inject(C.b)(e,void 0,1)}(I=function(e,t){return a.ModuleContainer.inject(O.a)(e,void 0,2)}(I=function(e,t){return a.ModuleContainer.inject(g.ZLoggerFactory)(e,void 0,3)}(I=Reflect.metadata("design:type",Function)(I=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===C.b?Object:C.b,void 0===O.a?Object:O.a,void 0===g.ZLoggerFactory?Object:g.ZLoggerFactory])(I=class extends S.a{constructor(e,t,s,i){super(),this.adapterManager=e,this.configManager=t,this.internalData=s,this.scheduler=void 0,this.pendingQueries=[],this.session=void 0,this.logger=void 0,this.adapterContainers=new Map,this.adapterInfoMap=new Map,this.idCounter=0,this.dbSchema=void 0,this.appSchema=void 0,this.isShuttingDown=!1,this.removeListeners=()=>{},this.authenticate=e=>{this.scheduler.stop(),this.session=e;const t=this.pendingQueries;this.pendingQueries=[],t.forEach((e=>{this.enqueue(e,{immediately:!1})})),this.clearAdapterData(),this.logger.zsymb(0,"5Mry6d","Clear adapter cache due to new session"),this.configManager.authenticate(e),this.scheduler.start()};const n=new h;this.scheduler=new o.b(n,!1),this.logger=i.createZLogger("db",["host","planner"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.adapterManager.addEventListener(f.b.SuccessOpenDB,e)),t.push(this.adapterManager.addEventListener(f.b.LongOpenDB,e)),t.push(this.adapterManager.addEventListener(f.b.ConnectionClosedAbnormally,e)),t.push(this.adapterManager.addEventListener(f.b.TimeConsumingQuery,e)),t.push(this.adapterManager.addEventListener(f.b.SchemaMigratedAbnormally,e)),t.push(this.adapterManager.addEventListener(f.b.Warning,e)),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}install(e){this.dbSchema=Object(i.a)(Object(i.a)({},e),E.a),this.appSchema=Object(i.a)({},e)}getAppSchemas(){if(!this.appSchema)throw new Error("Use app schema before inu");return this.appSchema}start(){this.scheduler.start()}stop(){this.scheduler.stop(),this.logger.zsymb(6,"Na5Aww","Stop!")}do(e){const t=new r.c.Container,s={database:e.database,table:e.table,method:b.b.getTypeName(e.type)||"Unknown method",transaction:e.transaction,startTime:Date.now(),getEndTime:async()=>t.value||t.promise};return this.dispatchEvent(new f.e(s)),new Promise(((t,s)=>{this.enqueue(Object(i.a)(Object(i.a)({},e),{},{deferrer:{resolve:t,reject:e=>{s(e)}}}),{immediately:M.a.isInTransaction(e)})})).finally((()=>{t.resolve(Date.now())}))}doImmediately(e){return new Promise(((t,s)=>{this.enqueue(Object(i.a)(Object(i.a)({},e),{},{deferrer:{resolve:t,reject:s}}),{immediately:!0})}))}async getAvailableDBBasicInfos(e){const t=[],s=this.getAllDBNames(),i=!!this.session,n=[];for(const a of s){const s=this.configManager.getDatabaseBaseConfig(a);!i&&s.session||n.push((async()=>{const s=this.getTablesNameOfDB(a);for(const n of s){const s=(await this.configManager.getDatabaseConfigs(a)).filter((t=>t.type===e))[0];if(void 0===s)return;const r=i?this.session.userId:"";let o=s.computeDatabaseName(r,n);const l=await s.getPartition(n,this.session);if(!l)throw new p.v(n,this.session);const c=l.getTableConfig(n);if(!c)throw new p.x(n);if(c.dbName=a,s.supportPartitionByField&&c.doesHavePartitionByField(l.type)){const e=await this.adapterManager.getExistedPartitionKeys(o,s.type);for(const i of e)t.push({fullname:`${o}/${i}`,sessional:s.session})}else t.push({fullname:o,sessional:s.session})}})())}return await Promise.all(n),t}enqueue(e,t){e.meta.step=0,e.meta.id=this.idCounter++,this.scheduler.run({immediately:t.immediately,execute:()=>{try{return this.execute(e)}catch(t){if(0!==e.retry)throw e.retry-=1,t;{const s=this.createErrorForQuery(e,t);this.logger.zsymb(18,"FojkiZ",(()=>[s]));const i=new p.i(s.message),n=this.getAdapterTypeOfQuery(e);null!==n&&i.setAdaperType(n),this.dispatchEvent(new f.j(i))}}},retry:e.retry})}getAdapterTypeOfQuery(e){const t=e.meta.databaseConfig;return void 0!==t?t.type:null}trapQueryError(e){let t=null,s=()=>{};this.shouldTrapTimeoutQuery(e)&&(t=setTimeout((()=>{var t,s;const i=(null===(t=e.params)||void 0===t||null===(s=t.values)||void 0===s?void 0:s.length)||void 0,n=void 0!==i?[i]:[];e.deferrer.reject(new p.A(n))}),e.meta.timeout),e.meta.timer=t,s=()=>{clearTimeout(t)});const i=e.deferrer;e.deferrer={resolve:e=>{s(),i.resolve(e)},reject:t=>{s();const n=this.createErrorForQuery(e,t);this.dispatchEvent(new f.d(n)),i.reject(n)}}}createErrorForQuery(e,t){const s=Object(y.b)(e);let i=null;const n=(e=>{const t=e.stack;if(!t)return"";const s=`${e.name}`+(e.message?`: ${e.message}`:"")+"\n";return t.startsWith(s)?t.slice(s.length):t})(e.meta.error);if(t)if(t instanceof Error){const a=t.message+` (${s})`;if(t instanceof DOMException)i=new p.b(a,t.name,t.code),i.setStack(n);else if(t instanceof p.e)i=t,i.message=a,i.setStack(n);else if(t.message.includes("SQLITE_CORRUPT")){const s=[e.database,e.table].join("/");i=new p.d(`${s} - ${t.message}`,[s]),i.adapterType=m.a.SQLite,i.setStack(n)}else i=new p.i(a),i.setStack(n)}else{let e=t?`${t}`:"Unknown reason";e+=` (${s})`,i=new p.i(e),i.setStack(n)}else{let e=`Unknown reason (${s})`;i=new p.i(e),i.setStack(n)}const a=this.getAdapterTypeOfQuery(e);return null!==a&&i.setAdaperType(a),i}shouldTrapTimeoutQuery(e){return!1}async execute(e){e.meta.step=1,e.meta.dead=!1,this.isReadyForExecute(e)&&(e.meta.step=2,!e.meta.databaseConfig&&(await this.computeDatabaseConfig(e),e.meta.dead)||(e.meta.step=3,e.meta.shouldNotTrapQuery||this.trapQueryError(e),e.meta.step=4,!e.meta.databaseName&&(this.computeDatabaseName(e),e.meta.dead)||(e.meta.step=5,e.meta.step=6,!e.meta.partitionConfig&&(await this.computePartitionConfig(e),e.meta.dead)||(e.meta.step=7,!e.meta.tableConfig&&(this.computeTableConfig(e),e.meta.dead)||(e.meta.step=8,"string"!=typeof e.meta.partitionKey&&(this.computePartitionKey(e),e.meta.dead)||(e.meta.step=9,!e.meta.executor&&(this.computeDatabaseAdapter(e),e.meta.dead)||(e.meta.step=10,e.meta.executor())))))))}setAdapterInfo(e,t){const{partitionConfig:s,partitionKey:i,databaseConfig:n,tableConfig:a}=e.meta;if(!M.a.isPartitionlessQuery(e)&&n.supportPartitionByField&&a.doesHavePartitionByField(s.type)&&""===i)return void this.rejectQuery(e,new p.w("Partition key is required"));const r=s.type,o=n.name,l=a.name,c=i||"";this.adapterInfoMap.has(r)||this.adapterInfoMap.set(r,{});const d=this.adapterInfoMap.get(r);void 0===d[o]&&(d[o]={});const u=d[o];void 0===u[l]&&(u[l]={});u[l][c]=t}clearAdapterData(){this.adapterContainers.clear(),this.adapterInfoMap.clear()}getAvailableAdapters(){const e=new Set;this.adapterInfoMap.forEach((t=>{for(const s of Object.values(t))for(const t of Object.values(s))for(const s of Object.values(t))e.add(s)}));const t=[],s=e.values();let i=s.next();for(;!i.done;){const e=i.value,n=this.adapterContainers.get(e);if(!n)throw new Error("Mismatched adapter info");t.push(n.promise),i=s.next()}return Promise.all(t)}getAvailableAdaptersOfDatabase(e){const t=new Set;this.adapterInfoMap.forEach((s=>{const i=s[e];if(void 0!==i)for(const e of Object.values(i))for(const s of Object.values(e))t.add(s)}));const s=[],i=t.values();let n=i.next();for(;!n.done;){const e=n.value,t=this.adapterContainers.get(e);if(!t)throw new Error("Mismatched adapter info");s.push(t.promise),n=i.next()}return Promise.all(s)}computeDatabaseAdapter(e){const{databaseName:t,partitionConfig:s,partitionKey:i,databaseConfig:n,tableConfig:a}=e.meta;let o=t;const l=s.type;if(!M.a.isPartitionlessQuery(e)&&n.supportPartitionByField&&n.hasPartitionedTables){const s=[t];if(a.doesHavePartitionByField(l)){if(""===i)return void this.rejectQuery(e,new p.w("Partition key is required"));s.push(a.name,i)}else s.push("Index");const n=Object(v.b)(l);o=s.join(n)}const c=`${o}_${s.type}`;let d=this.adapterContainers.get(c);d||(d=new r.c.Container,this.setAdapterInfo(e,c),this.adapterContainers.set(c,d),this.adapterManager.getDatabaseAdapter(o,s).then(d.resolve).catch(d.reject)),d.value||d.promise.then((()=>(e.meta.shouldNotTrapQuery=!0,this.execute(e)))).catch((t=>{const s=new p.a(c,t.message);this.logger.zsymb(18,"D12p2b",(()=>[s]));const i=this.getAdapterTypeOfQuery(e);null!==i&&s.setAdaperType(i),this.dispatchEvent(new f.j(s))}));const u=d.value;u?(e.meta.adapterName=u.type===m.a.IDB?"idb":"sqlite",e.meta.executor=()=>{e.meta.databaseName=o,u.execute(e)}):e.meta.dead=!0}replicate(e,t){this.do(Object(i.a)(Object(i.a)({},e),{},{transaction:0,meta:Object(i.a)(Object(i.a)({},e.meta),{},{databaseConfig:t,error:new Error}),deferrer:void 0}))}isReadyForExecute(e){return!!(M.a.isCloseAllDBsQuery(e)||M.a.isDeleteAllDBsQuery(e)||M.a.isDeleteDBQuery(e)||M.a.isCloseDBQuery(e))||(this.isShuttingDown?(this.pendingQueries.push(e),!1):!(!this.session&&(()=>this.configManager.getDatabaseBaseConfig(e.database).session)())||(this.pendingQueries.push(e),!1))}async computeDatabaseConfig(e){if(""===e.database){if(M.a.isCloseAllDBsQuery(e))return e.meta.dead=!0,this.isShuttingDown=!0,void(async()=>{const t=await this.getAvailableAdapters();let s=t.length;const i=(...e)=>{this.logger.zsymb(0,"vyZ-7a","[close-all-dbs]",...e)},n=(...e)=>{this.logger.zsymb(18,"Udb1sv","[close-all-dbs]",...e)};i("Start ..."),i(`Wait to close ${s} connection`);const a=setInterval((()=>{i((function(e){return e[0]})`Wait to close ${s} connection`)}),5e3);try{await Promise.all(t.map((t=>t.closeThisDatabase(e.params).then((()=>{s-=1}))))),e.deferrer.resolve(),i("Done!")}catch(r){e.deferrer.reject(r),n("Failed to close all dbs",r)}finally{clearInterval(a)}})();if(M.a.isDeleteAllDBsQuery(e)){e.meta.dead=!0,this.isShuttingDown=!0;const t=this.getAllDBNames();let s=[...t];const n=(...e)=>{this.logger.zsymb(0,"CiR3ix","[delete-all-dbs]",...e)},a=(...e)=>{this.logger.zsymb(18,"VjVrOu","[delete-all-dbs]",...e)};n("Start ..."),n(`Wait for dbs: ${s}`);const r=t.map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{type:m.e.DeleteDB,database:t,meta:Object(i.a)(Object(i.a)({},e.meta),{},{error:new Error}),deferrer:void 0})).then((()=>{s=s.filter((e=>e!==t)),n(`Wait for dbs: ${s}`)})).catch((()=>{a(`Failed to operate on db: '${t}'`)}))));return void Promise.all(r).then((()=>{n("Done!"),e.deferrer.resolve()})).catch(e.deferrer.reject)}}const t=await this.configManager.getDatabaseConfigs(e.database);if(0!==t.length){if(t.length>1&&this.shouldReplicate(e))for(let s=1;s<t.length;s++)this.replicate(e,t[s]);e.meta.databaseConfig=t[0]}else this.rejectQuery(e,new p.s(e.database))}getAllDBNames(){return Object.keys(this.dbSchema)}getTablesNameOfDB(e){const t=this.dbSchema[e];if(!t)throw new p.t(e);return Object.values(t).map((e=>e.name))}computeDatabaseName(e){var t,s;const{meta:n,table:a,database:r}=e;if(""===a){if(M.a.isCloseDBQuery(e))return e.meta.dead=!0,void(async()=>{const t=await this.getAvailableAdaptersOfDatabase(r);try{await Promise.all(t.map((t=>t.closeThisDatabase(e.params)))),e.deferrer.resolve()}catch(s){e.deferrer.reject(s)}})();if(M.a.isDeleteDBQuery(e)){e.meta.dead=!0;const t=this.getTablesNameOfDB(r).map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{table:t,meta:Object(i.a)(Object(i.a)({},e.meta),{},{error:new Error}),deferrer:void 0}))));return void Promise.all(t).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}}const o=null!==(t=null===(s=this.session)||void 0===s?void 0:s.userId)&&void 0!==t?t:"",l=n.databaseConfig.computeDatabaseName(o,a);n.databaseName=l}async computePartitionConfig(e){const t=await e.meta.databaseConfig.getPartition(e.table,this.session);t?e.meta.partitionConfig=t:this.rejectQuery(e,new p.v(e.table,this.session))}computeTableConfig(e){const{partitionConfig:t}=e.meta,s=t.getTableConfig(e.table);if(!s)return void this.rejectQuery(e,new p.x(e.table));s.dbName=e.database,e.meta.tableConfig=s;const{type:i}=t;if(s.doesUsePartitionTable(i)&&M.a.isUpdateQuery(e)){const{key:t,attributes:i,value:n}=e.params,{type:a}=e.meta.partitionConfig,r=s.getPartitionField(a);if(i.includes(r)){const s=n[r],i=Array.isArray(t)?t.join("-"):`${t}`;this.internalData.getValue().Meta.PartitionKey.insert({database:e.database,table:e.table,key:i,value:s},{replace:!0}).catch((e=>{this.logger.zsymb(18,"2T60gv","Failed to update partition key mapping",e)}))}}}computePartitionKey(e){const{databaseConfig:t,tableConfig:s,partitionConfig:i}=e.meta;if(t.supportPartitionByField&&s.doesHavePartitionByField(i.type))switch(e.type){case m.e.BeginTransaction:return void(e.meta.partitionKey="");case m.e.Clear:return;case m.e.Insert:return void this.computePartitionForInsertQuery(e);case m.e.InsertMulti:return void this.computePartitionForInsertMultiQuery(e);case m.e.Get:case m.e.GetAndUpdate:case m.e.Update:case m.e.Delete:return void this.computePartitionForIndexedQuery(e);case m.e.FindAndDelete:case m.e.GetAllKey:case m.e.GetAll:case m.e.Count:return void this.computePartitionForRangedQuery(e);case m.e.DeleteMulti:case m.e.GetMulti:case m.e.GetMultiIfExists:return void this.computePartitionForGetMultiAndDeleteMultiQuery(e);case m.e.UpdateMulti:return void this.computePartitionForUpdateMultiQuery(e);case m.e.CloseDB:case m.e.DeleteDB:return void this.computePartitionForCloseDBAndDeleteDBQuery(e)}else e.meta.partitionKey=""}computePartitionForInsertQuery(e){const{tableConfig:t,partitionConfig:s}=e.meta,{type:i}=s;let n=this.computePartitionKeyFromEntityValue(t,i,e.params.value);if(void 0!==n){if(n=`${n}`,e.meta.partitionKey=n,t.doesUsePartitionTable(i)){const s=t.primaryIndex.createKey(e.params.value).join("-");this.internalData.getValue().Meta.PartitionKey.insert({database:e.database,table:e.table,key:s,value:n}).catch((e=>{this.logger.zsymb(18,"YqEnu0","Failed to insert partition key mapping",e)}))}}else this.rejectQuery(e,new p.w("Partition key is required"))}computePartitionForInsertMultiQuery(e){const{tableConfig:t,partitionConfig:s}=e.meta,{type:n}=s,a={groupByPartitions:{},partitions:[]};for(const i of e.params.values){const s=this.computePartitionKeyFromEntityValue(e.meta.tableConfig,e.meta.partitionConfig.type,i);if(void 0===s)return void this.rejectQuery(e,new p.w("Partition key is required"));if(a.groupByPartitions[s]||(a.groupByPartitions[s]=[]),a.groupByPartitions[s].push(i),t.doesUsePartitionTable(n)){const n=t.primaryIndex.createKey(i).join("-");a.partitions.push({database:e.database,table:e.table,key:n,value:`${s}`})}}let r;const o=Object.entries(a.groupByPartitions);if(1===o.length)r=o[0][0],t.doesUsePartitionTable(n)&&a.partitions.length>0&&this.internalData.getValue().Meta.PartitionKey.insertMulti(a.partitions).catch((e=>{this.logger.zsymb(18,"7Yx0MD","Failed to insert partition key mapping",e)})),e.meta.partitionKey=r;else{e.meta.dead=!0;const t=o.map((([t,s])=>{const n=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:n,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{values:s}),deferrer:void 0}))}));Promise.all(t).then((t=>{const s={success:[],fail:[]};t.forEach((({success:e,fail:t})=>{s.success.push(...e),s.fail.push(...t)})),e.deferrer.resolve(s)})).catch(e.deferrer.reject)}}computePartitionForIndexedQuery(e){const{key:t,index:s}=e.params,{tableConfig:n,partitionConfig:a}=e.meta,{type:r}=a,o=this.computePartitionKeyFromEntityKey(n,a.type,t,s);if(void 0!==o)e.meta.partitionKey=`${o}`;else if(n.doesUsePartitionTable(r))if("primary"===s){e.meta.dead=!0,this.logger.zsymb(6,"3_34a6","Partition key is missing! Please fix it!");const s=Array.isArray(t)?t.join("-"):t;this.internalData.getValue().Meta.PartitionKey.get([e.database,e.table,s]).then((t=>{if(t){const s=t.value;this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:`${s}`,dead:!1,error:new Error}),deferrer:void 0})).then(e.deferrer.resolve).catch(e.deferrer.reject)}else this.rejectQuery(e,new p.w("No partition key mapping found"))})).catch((t=>{this.rejectQuery(e,new p.w("Partition key mapping failed",t))}))}else this.rejectQuery(e,new p.w("Partition key is required (indexed query)"));else this.rejectQuery(e,new p.w("Partition key is required"))}computePartitionForRangedQuery(e){var t,s;if(!e.params.range){const t=new p.z("Get all data in partitioned table");return void this.rejectQuery(e,t)}let i="";i=e.type===m.e.FindAndDelete||e.type===m.e.Count?"primary":e.params.index;const{partitionConfig:n,tableConfig:a}=e.meta,{type:r}=n;if(-1===a.getIndexPartitionField(r,i)){if(a.doesUsePartitionTable(r)){const t=new p.w("Partition key is required (ranged query)");this.rejectQuery(e,t)}else{const t=new p.z("Get all data by index in partitioned table");this.rejectQuery(e,t)}return}if(null===(t=e.params.range)||void 0===t||!t.from||null===(s=e.params.range)||void 0===s||!s.to){const t=new p.z("Get data with open boundary in partition table");return void this.rejectQuery(e,t)}const o=e.params.range.from,l=e.params.range.to,c=this.computePartitionKeyFromEntityKey(e.meta.tableConfig,o,i);if(c!==this.computePartitionKeyFromEntityKey(e.meta.tableConfig,l,i)){const t=new p.z("Get data from multiple partition");return void this.rejectQuery(e,t)}let d=c;void 0!==d?e.meta.partitionKey=`${d}`:this.rejectQuery(e,new p.w("Partition key is required (ranged query)"))}computePartitionForGetMultiAndDeleteMultiQuery(e){let t="";t=e.type===m.e.DeleteMulti?"primary":e.params.index;const{tableConfig:s,partitionConfig:n}=e.meta,{type:a}=n,r={},o=[];for(const i of e.params.keys){const n=this.computePartitionKeyFromEntityKey(s,a,i,t);if(void 0===n){if(!s.doesUsePartitionTable(a))return void this.rejectQuery(e,new p.w("Partition key is required"));if("primary"!==t)return void this.rejectQuery(e,new p.w("Partition key is required (indexed query)"));o.push(i)}else r[n]||(r[n]=[]),r[n].push(i)}if(s.doesUsePartitionTable(a)&&0!==o.length)return e.meta.dead=!0,this.logger.zsymb(6,"NOuLS2","Partition key is missing! Please fix it!"),void Promise.all(o.map((async t=>{const s=Array.isArray(t)?t.join("-"):t,i=await this.internalData.getValue().Meta.PartitionKey.get([e.database,e.table,s]).catch((e=>{throw this.logger.zsymb(18,"qd1-4I","Failed to get partition key mapping",e),new p.w("Failed to get partition key mapping")}));if(!i)throw new p.w("No partition key mapping found");{const e=i.value;r[e]||(r[e]=[]),r[e].push(t)}}))).then((()=>{const t=Object.entries(r).map((([t,s])=>{const n=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:n,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{keys:s}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)})).catch((t=>{this.rejectQuery(e,t)}));const l=Object.entries(r);let c;if(1===l.length)c=l[0][0],e.meta.partitionKey=`${c}`;else{e.meta.dead=!0;const t=l.map((([t,s])=>{const n=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:n,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{keys:s}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)}}computePartitionForUpdateMultiQuery(e){const{tableConfig:t,partitionConfig:s}=e.meta,{type:n}=s,{patches:a}=e.params,r={},o=[];for(const i of a){const{key:s}=i;let a=this.computePartitionKeyFromEntityKey(t,n,s);if(void 0===a){if(!t.doesUsePartitionTable(n))return void this.rejectQuery(e,new p.w("Partition key is required"));o.push(i)}else r[a]||(r[a]=[]),r[a].push(i)}if(t.doesUsePartitionTable(n)&&0!==o.length)return e.meta.dead=!0,this.logger.zsymb(6,"HfTUPl","Partition key is missing! Please fix it!"),void Promise.all(o.map((async t=>{const{key:s}=t,i=Array.isArray(s)?s.join("-"):s,n=await this.internalData.getValue().Meta.PartitionKey.get([e.database,e.table,i]).catch((e=>{throw this.logger.zsymb(18,"D7uPVx","Failed to get partition key mapping",e),new p.w("Failed to get partition key mapping")}));if(!n)throw new p.w("No partition key mapping found");{const e=n.value;r[e]||(r[e]=[]),r[e].push(t)}}))).then((()=>{const t=Object.entries(r).map((([t,s])=>{const n=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:n,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{patches:s}),deferrer:void 0}))}));Promise.all(t).then((t=>{const s={success:[],fail:[]};t.forEach((({success:e,fail:t})=>{s.success.push(...e),s.fail.push(...t)})),e.deferrer.resolve(s)})).catch(e.deferrer.reject)})).catch((t=>{this.rejectQuery(e,t)}));let l;const c=Object.entries(r);if(1===c.length)l=c[0][0],e.meta.partitionKey=l;else{const t=c.map((([t,s])=>{const n=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:n,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{patches:s}),deferrer:void 0}))}));Promise.all(t).then((t=>{const s={success:[],fail:[]};t.forEach((({success:e,fail:t})=>{s.success.push(...e),s.fail.push(...t)})),e.deferrer.resolve(s)})).catch(e.deferrer.reject)}}async computePartitionForCloseDBAndDeleteDBQuery(e){e.meta.dead=!0;const{meta:t}=e,s=(await this.adapterManager.getExistedPartitionKeys(t.databaseName,t.databaseConfig.type)).map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:t,error:new Error}),deferrer:void 0}))));Promise.all(s).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}computePartitionKeyFromEntityValue(e,t,s){const i=e.getPartitionField(t);if(void 0!==i)return s[i]}computePartitionKeyFromEntityKey(e,t,s,i="primary"){const n=e.getPartitionField(t);if(void 0!==n)return e.getIndex(i).getValue(s,n)}shouldReplicate(e){switch(e.type){case m.e.Clear:case m.e.Delete:case m.e.DeleteMulti:case m.e.FindAndDelete:case m.e.Insert:case m.e.InsertMulti:case m.e.Update:case m.e.UpdateMulti:case m.e.GetAndUpdate:case m.e.CloseDB:case m.e.CloseAllDBs:case m.e.DeleteDB:case m.e.DeleteAllDBs:return!0;default:return!1}}logQueryInfo(e){const t=Object(y.b)(e);this.logger.zsymb(12,"cPpgnC",t)}rejectQuery(e,t){e.meta.dead=!0,e.deferrer.reject(t)}})||I)||I)||I)||I)||I)||I)||I)||I;a.ModuleContainer.registerSingleton(S.b,T)},i15Q:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("KRcn");class n{constructor(){this._session=null,this._processStart=void 0,this._enableConsole=void 0,this.isReady=()=>!!this._session,this.getSession=()=>{if(!this._session)throw new Error("session is not ready");return this._session},this.getProcessStartTime=()=>this._processStart,this.setSession=e=>{this._session=e},this._processStart=Date.now(),this._session={build:"df9aab9f233d8a6c7e6c83b75d079752315899e3",zlgv:"4Tuwq6Bb",env:"prod",buildType:"release",pversion:"25.6.1",process:Object(i.getProcess)()},this._enableConsole=!1}enableConsole(){}disableConsole(){}isEnabledConsole(){return this._enableConsole||!1}}},i2tm:function(e,t,s){"use strict";s.r(t);var i=s("3rNm");s.d(t,"cast",(function(){return i.a}));var n=s("kaMP");s.d(t,"gather",(function(){return n.a}));var a=s("3hph");s.d(t,"stridedSlice",(function(){return a.a}));var r=s("kRdc");s.d(t,"add",(function(){return r.a}));var o=s("zvA9");s.d(t,"greater",(function(){return o.a}));var l=s("SHv8");s.d(t,"matMul",(function(){return l.a}));var c=s("AV8V");s.d(t,"scalar",(function(){return c.a}));var d=s("parS");s.d(t,"mul",(function(){return d.a}));var u=s("/7N0");s.d(t,"sigmoid",(function(){return u.a}));var h=s("QYQ3");s.d(t,"squaredDifference",(function(){return h.a}));var g=s("oAkI");s.d(t,"sub",(function(){return g.a}));var m=s("Ei6o");s.d(t,"mean",(function(){return m.a}));var p=s("2ugP");s.d(t,"expandDims",(function(){return p.a}));var f=s("k7Jv");s.d(t,"square",(function(){return f.a}));var v=s("4FMF");s.d(t,"sum",(function(){return v.a}));var b=s("Z5Ez");s.d(t,"where",(function(){return b.a}));var I=s("Fjpt");s.d(t,"sqrt",(function(){return I.a}));var y=s("CfTU");s.d(t,"maximum",(function(){return y.a}));var _=s("x3y4");s.d(t,"div",(function(){return _.a}))},j6JD:function(e,t,s){"use strict";function i(e,t){"string"==typeof e&&(e=parseInt(e));const s=new Date(e),i=s.getDate(),a=s.getMonth()+1,r=(s.getFullYear(),s.getHours()),o=s.getMinutes(),l=s.getSeconds();return null!=t&&t.dayOnly?`${i}.${a}`:null!=t&&t.timeOnly?`${n(r,2)}:${n(o,2)}:${n(l,2)}`:`${i}.${a} ${n(r,2)}:${n(o,2)}:${n(l,2)}`}function n(e,t){const s=e.toString();return s.length<t?"0".repeat(t-s.length)+s:s}s.d(t,"a",(function(){return i}))},jw3m:function(e,t,s){},jx7S:function(e,t,s){"use strict";function i(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s];"ready"===i.state&&(t.push(i),e.splice(s,1),s--)}return t}function n(e){return`Name: ${e.name} - ID: ${e.id}`}s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return n}))},o0oJ:function(e,t,s){(function(e){const t={};function s(e){return t[e]||(t[e]=0),t[e]+=1,100*e+t[e]}if(!e.perf){let t=()=>Date.now();const i={STARTUP:s(1),MIGRATION_DONE:s(2),MAIN_SCRIPT:s(2),LOADED_MAIN_SCRIPT:s(3),MAIN_APP_READY:s(3),LOADED_STARTUP_SCRIPT:s(2),STARTUP_BEFORE_HEAVY:s(3),CREATE_MAIN_WINDOW:s(3),SHOW_MAIN_WINDOW:s(3),MAIN_WINDOW_LOADING:s(3),MAIN_WINDOW_LOADED:s(3),APP_STARTUP:s(2),LOAD_APP_SCRIPT:s(3),APP_DID_MOUNT:s(3),CHATBOX_DID_MOUNT:s(3),SELECT_CONVERSATION:s(1),SELECTED_CONVERSATION:s(2)};e.perf={...i,perfRecords:[],record:s=>{s||(s=0);const i=[s,t()];e.perf.perfRecords.push(i)}}}}).call(this,s("yLpj"))},oM1A:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("+iAT"),n=s("K5Y3");const a={Meta:i.a.schema,DBState:n.a.schema}},oSk7:function(e,t,s){"use strict";class i{constructor(e){this.stream=void 0,this.stream=e}pipe(e){return this.stream=i.transformStream(this.stream,e),this}getStream(){return this.stream}static transformStream(e,t,s){try{return e.pipeThrough(new TransformStream(t))}catch(i){const s=e.getReader();return new ReadableStream({start(e){var s;const i={desiredSize:null,enqueue(t){e.enqueue(t)},error(e){},terminate(){}};return null===(s=t.start)||void 0===s?void 0:s.call(t,i)},async pull(e){let i=!1;const n={desiredSize:null,enqueue(t){i=!0,t&&e.enqueue(t)},error(e){},terminate(){}};for(;!i;){var a;const i=await s.read();var r;if(i.done)return await(null===(r=t.flush)||void 0===r?void 0:r.call(t,n)),e.close();await(null===(a=t.transform)||void 0===a?void 0:a.call(t,i.value,n))}}})}}static createReadbleStreamFromArrayBuffer(e,t=2**20){const s=Math.ceil(e.byteLength/t);return new ReadableStream({start(i){for(let n=0;n<=s;n++)i.enqueue(new Uint8Array(e,n*t,t));i.close()}})}}t.a=i},qLCR:function(e,t,s){"use strict";s.r(t);s("cOPa"),s("mNvP"),s("QxEN"),s("BtX6"),s("ZfyH");var i=s("jDHv"),n=s("7wvk");i.ModuleContainer.registerSingleton(n.TFactoryMainless,class{constructor(){this.map=new Map,this.mainless=new Map}registerMainless(e,t){if(this.mainless.has(t))throw Error("mainless registered");this.mainless.set(t,e)}registerMethod(e,t){if(this.map.has(e))throw Error("method registered");this.map.set(e,t)}getMethodTarget(e){return this.map.get(e)}getMainless(e){const t=this.map.get(e);return this.mainless.get(t)}});var a=s("wq09");const r=i.ModuleContainer.resolve(n.TFactoryMainless),o={zip:a.b.node,unzip:a.b.node,md5:a.b.node,fileEexc:a.b.node,getDirSize:a.b.node,getDirSizeNoCaching:a.b.node,genThumbMacOfficeBuffer:a.b.node,genThumbWinOfficeBuffer:a.b.node,parseLink:a.b.node,parseBank:a.b.node,getLocalSize:a.b.node,cleanLocalResourceFolder:a.b.node},l={fileType:a.b.render,sha256:a.b.render,rmd5:a.b.render,genThumbPicBuffer:a.b.render,genPreviewThumb:a.b.render,resizeImage:a.b.render},c={sha256:a.b.web,genPreviewThumb:a.b.web,resizeImage:a.b.web,fileType:a.b.web,wmd5:a.b.web,parseBank:a.b.web};for(let p$ in c)r.registerMethod(p$,c[p$]);if("render"==__ZaBUNDLENAME__){for(let e in l)r.registerMethod(e,l[e]);for(let e in o)r.registerMethod(e,o[e])}var d=s("9jPG");class u{get instance(){return this._instance||(this._instance=new u),this._instance}constructor(){this._instance=void 0,this._do_not_use_me_pool=void 0,this._do_not_use_me_pool=Object(d.pool)(__SRC_MAINLESS_WORKER__,{workerType:"web",maxWorkers:1,minWorkers:1})}get pool(){return this.instance._do_not_use_me_pool}get proxy(){return this.pool.proxy()}exec(e,t,s){return Promise.resolve(this.execRaw(e,t,s))}execRaw(e,t,s){return this.pool.exec(e,t,s)}}const h=i.ModuleContainer.resolve(n.TFactoryMainless);{const e=new u;h.registerMainless(e,a.b.web),i.ModuleContainer.registerValue(n.TWebMainless,e)}var g=s("hzFW");class m{}class p{constructor(){this.instance=void 0}createAppPathManager(){return this.instance||(this.instance=new m),this.instance}}"function"==typeof importScripts||i.ModuleContainer.registerSingleton(g.a,p);var f=s("VTBJ"),v=s("mwIZ"),b=s.n(v),I=s("D1y2"),y=s.n(I),_=s("Y58e");i.ModuleContainer.registerSingleton(_.a,class{get(e){const t=s("NDmK").default;return b()(t,e)}set(e,t){const i=s("NDmK").default,n=Object(f.a)(Object(f.a)({},b()(i,e)),t);return y()(i,e,n)}});var C,O=s("jGDt"),E=s("igA5"),M=s("PLj1"),S=s("KRcn"),T=s("7FSS"),w=s("i15Q"),R=s("1pet");let L=Object(i.injectable)()(C=Reflect.metadata("design:type",Function)(C=Reflect.metadata("design:paramtypes",[])(C=class extends w.a{constructor(){super();const e=Object(S.getProcess)();if(M.BLACKLISTED_PROCESSES.includes(e))this._enableConsole=!1;else{var t;const e=null===(t=E.default.getInstance())||void 0===t?void 0:t.getItem(R.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE);this._enableConsole="true"===e||!1}T.a.log("[ZLL]: Console logging",this._enableConsole?"enabled":"disabled")}enableConsole(){T.a.log("[ZLL]: Console logging enabled"),this._enableConsole=!0;const e=Object(S.getProcess)();var t;M.BLACKLISTED_PROCESSES.includes(e)||(null===(t=E.default.getInstance())||void 0===t||t.setItem(R.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE,"true"))}disableConsole(){T.a.log("[ZLL]: Console logging disabled"),this._enableConsole=!1;const e=Object(S.getProcess)();var t;M.BLACKLISTED_PROCESSES.includes(e)||(null===(t=E.default.getInstance())||void 0===t||t.setItem(R.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE,"false"))}})||C)||C)||C;i.ModuleContainer.registerSingleton(O.a,L);const D=Object(i.define)("zlog-binary-file-system");var A=s("Wc52");let F=function(e){return e.Binary="zlog",e.Text="log",e}({});const j={[F.Binary]:{logExt:".zlog",metaExt:".meta",moduleExt:".module"},[F.Text]:{logExt:".log",metaExt:".dmeta",moduleExt:".module"}},P={[F.Binary]:{logExt:".calf"},[F.Text]:{logExt:".txt"}};var k=s("UJDs"),N=s("HhRM"),U=s("5FGm"),B=s("HD3z");const x=self.performance;class G{constructor(){var e;this.status="init",this.queue=[],this.lastFlush=0,this.flushTimeout=0,this.flushTimer=null,this.logFolderName=U.b,this.EncodeMode=F.Binary,this.logFileName=`${Object(S.getProcess)()}${P[this.EncodeMode].logExt}`,this._tryFlushAll=U.a.None,this.MAX_FLUSH_DURATION=80,this.supported=null,this.isWriterReady=!1,this.lock=null,this.filePath="",this._lockedForSingleWebInstanceAccess=!1,this.write=async e=>{if((await Object(B.b)()).enable_calf)if(null===this.supported&&(this.supported=await N.a.async("OPFS")),!1!==this.supported){if(this.queue.push(e),this.flushable)if(x.now()-this.lastFlush>=this.flushTimeout)this._flush();else{const e=this.flushTimeout-(x.now()-this.lastFlush);this._scheduleNextFlush(e)}}else this.size>0&&this.queue.splice(0,this.size)},this.tryFlushAll=async()=>{if(!(await Object(B.b)()).enable_calf)return;const e={metadata:{tags:["ZLL.F".toUpperCase()],level:k.b.info,tick:Date.now(),ln:0,targetTransporter:"toFile",template:[]},args:[`====FLUSHALL: ${this.size}====`]};if(this.queue.push(e),"busy"===this.status)return this._tryFlushAll=U.a.FlushOnNextRun,this.releaseTryFlushLock(),this.lock=this.createDeferredPromise(),void(await this.lock.promise);this._tryFlushAll=U.a.FlushNow,await this._flush()},this.resetFlushAll=()=>{this._tryFlushAll=U.a.None},this._addSession=e=>{this.queue.unshift(e),this.status="idle"},this.getFilePath=async()=>this.logFileName,this.createLogDir=async()=>"",this.isLogDirExists=async()=>!0,this.createDeferredPromise=()=>{let e,t;return{promise:new Promise(((s,i)=>{e=s,t=i})),resolve:e,reject:t}},this.ensureDir=e=>new Promise(((t,s)=>{$znode.fsExtra.ensureDir(e,1533,(e=>{if(e)return s(e);t()}))})),this.getAppVersion=async()=>"25.6.1",this.cleanupOldLogs=async()=>{await Object(B.b)()},this.buildSession=async e=>{if(!(await Object(B.b)()).enable_calf)return;const t=i.ModuleContainer.resolve(O.a);const s=`zlgvers:4Tuwq6Bb ps:${Object(S.getProcess)()} build:production-release pversion:25.6.1 avers: bhash:df9aab9f233d8a6c7e6c83b75d079752315899e3`,n={metadata:{tags:["Session".toUpperCase()],level:k.b.info,tick:t.getProcessStartTime(),ln:0,targetTransporter:"toFile",template:[]},args:[s]};e&&e(n)},this._scheduleNextFlush=e=>{if((this._tryFlushAll===U.a.FlushNow||this.size<=0)&&(this.releaseTryFlushLock(),this._tryFlushAll=U.a.None),this.lastFlush=x.now(),this.clearFlushTimer(),this.status="idle",!(this.size<=0)){if(this._tryFlushAll===U.a.FlushOnNextRun)return this._tryFlushAll=U.a.FlushNow,void this._flush();this.status="sleeping",this.flushTimer=setTimeout((()=>{this.status="idle",this._flush()}),e)}},this.clearFlushTimer=()=>{this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=null,"sleeping"===this.status&&(this.status="idle")},this.releaseTryFlushLock=()=>{var e;null===(e=this.lock)||void 0===e||e.resolve(),this.lock=null},this._lockAccessForSingleWeb=()=>{this._lockedForSingleWebInstanceAccess=!0,s("3a9X").subscribeZLogAccessGranted(this._unlockAccessForSingleWeb)},this._unlockAccessForSingleWeb=()=>{this._lockedForSingleWebInstanceAccess=!1,s("3a9X").unsubscribeZLogAccessGranted(this._unlockAccessForSingleWeb)},this.flushTimeout=(null===(e=A.a[Object(S.getProcess)()])||void 0===e?void 0:e.fileInterval)||5e3,this.buildSession(this._addSession),this.cleanupOldLogs()}get size(){return this.queue.length}get flushable(){return!this._lockedForSingleWebInstanceAccess&&(this.supported&&this.isWriterReady&&"idle"===this.status&&this.size>0)}}var z=s("fsQs"),V=s("ebA4"),H=s("yBqK"),W=s("Lrq5"),$=s("6xEa"),K=s.n($);class q{constructor(){this._TextEncoder=new TextEncoder}encodeUi8(e,t,s){return e.setUint8(t,s),t+z.b.ui8}encodeUi16(e,t,s){return e.setUint16(t,s),t+z.b.ui16}encodeUi32(e,t,s){return e.setUint32(t,s),t+z.b.ui32}encodeFloat32(e,t,s){return e.setFloat32(t,s),t+z.b.float32}encodeFloat64(e,t,s){return e.setFloat64(t,s),t+z.b.float64}encodeBigInt64(e,t,s){const i=Object(V.a)(s),n=new Uint8Array(i);for(let a=0;a<n.byteLength;a++)t=this.encodeUi8(e,t,n[a]);return t}encodeTotalSize(e,t,s){return this.encodeUi16(e,t,s)}encodeTotalSizeEnd(e,t){return this.encodeUi16(e,t,t+z.b.ui16)}encodesSeparator(e,t){return t=this.encodeUi8(e,t,z.r[0]),t=this.encodeUi8(e,t,z.r[1])}encodeTick(e,t,s){const i=Object(V.a)(s),n=new Uint8Array(i);return this.copyCache(e,t,n)}encodeZlogVersion(e,t,s){const i=this._TextEncoder.encode(s);return t=this.encodeUi8(e,t,i.byteLength),this.copyCache(e,t,i)}encodeEncoderVers(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeLevel(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeHeaderNum(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding numOfHeader is TOO BIG!");return this.encodeUi8(e,t,s)}encodeStringOnly(e,t,s){const i=this._TextEncoder.encode(s),n=i.byteLength;return t=this.encodeUi8(e,t,n),this.copyCache(e,t,i)}copyCache(e,t,s){for(let i=0;i<s.byteLength;i++)t=this.encodeUi8(e,t,s[i]);return t}encodeTags(e){return K.a.compress(e.join("."))}encodePayload(e,t,s){const{ln:i,tags:n,template:a,args:r}=s,o=[],l=this.encodeTags(n),c=a||"";let d=e+4+l.length+c.length;for(let g of r){const e=Object(V.c)(g);if(W.d(e)&&(d+=z.b.ubig64),W.f(e)&&(d+=z.b.ui16*e.length),(W.a(e)||W.g(e)||W.c(e))&&(d+=z.b.ui8),d>z.d.line_malloc)break;o.push(e)}const u={$1:i,$2:l,$3:o,$4:c};o.length||delete u.$3,c.length||delete u.$4;const h=H.encode(u);return this.copyCache(t,e,h)}}q.getters=e=>({[z.b.ui8]:(...t)=>e.getUint8(...t),[z.b.ui16]:(...t)=>e.getUint16(...t),[z.b.ui32]:(...t)=>e.getUint32(...t),[z.b.ubig64]:(...t)=>e.getBigUint64(...t)}),q.setters=e=>({[z.b.ui8]:(...t)=>e.setUint8(...t),[z.b.ui16]:(...t)=>e.setUint16(...t),[z.b.ui32]:(...t)=>e.setUint32(...t),[z.b.ubig64]:(...t)=>e.setBigUint64(...t)});var Q=s("JRkD");const Z=(e,t)=>{const s="number"==typeof t?t:e.reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(s);let n=0;for(const a of e)i.set(new Uint8Array(a),n),n+=a.byteLength;return i};class J{}J.writeNoiseLogs=async(e,t,s)=>{const{FileSizeLimit:i,ReservedBytesStructure:n}=s;Object(Q.a)(!!e,"[writeBinLog]: filePath is invalid"),Object(Q.a)(!!t,"[writeBinLog]: data is invalid"),Object(Q.a)("number"==typeof i&&i>0,`[writeBinLog]: FileSizeLimit is invalid. Got ${i}`),Object(Q.a)(Array.isArray(n),`[writeBinLog]: ReservedBytes is invalid. Got ${n}`);const a=n.reduce(((e,t)=>e+t),0);if(0===t.length)return!0;let[r,o]=await J._readInstructions(e,n),l=0;for(;l<t.length;){const s=[];let c=0;for(;l<t.length&&r+c+t[l].byteLength<i;)s.push(t[l]),c+=t[l].byteLength,l++;if(s.length>0&&r+c<i){const t=await J._overwriteRange(e,Z(s,c),r);if("ERROR"===t.type)throw t.data;r+=c,o=Math.max(r,o),await J._updateInstructions(e,n,[r,o]),c=0}l<t.length&&r+t[l].byteLength>=i&&(r=a,await J._updateInstructions(e,n,[r,r]))}return!0},J.getFileHandler=()=>{{const e=s("3a9X");return{initBinaryLogFile:e.initBinaryLogFile,readRange:e.readRange,writeRange:e.writeRange}}},J._readInstructions=async(e,t)=>{const s=J.getFileHandler(),i=t.reduce(((e,t)=>e+t),0),n=await s.readRange(e,0,i);if("ERROR"===n.type){const n=await J._getInitialData(t,[i,i]);return await s.initBinaryLogFile(e,n),[i,i]}const a=n.data,r=new DataView(a.buffer),o=[];let l=0;for(let c of t)o.push(q.getters(r)[c](l)),l+=c;return o},J._updateInstructions=async(e,t,s)=>{const i=J.getFileHandler(),n=t.reduce(((e,t)=>e+t),0),a=new Uint8Array(n),r=new DataView(a.buffer);let o=0;for(let l=0;l<t.length;l++)q.setters(r)[t[l]](o,s[l]),o+=t[l];return await i.writeRange(e,0,a)},J._overwriteRange=(e,t,s)=>J.getFileHandler().writeRange(e,s,t),J._getInitialData=async(e,t)=>{const s=e.reduce(((e,t)=>e+t),0),i=new Uint8Array(s),n=new DataView(i.buffer);let a=0;for(let r=0;r<e.length;r++){const s=e[r];q.setters(n)[s](a,t[r]),a+=s}return i};const Y={MAX_RETRY:0,INVALID_CONFIG_JITTER:1,INVALID_CONFIG_MIN:2,TIMEOUT:3,RETRY_ON_ERROR_CONDITION_FAIL:4};class X extends Error{constructor(e){super(`ExpBackoff error:${e}`),this.code=e}}function ee(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function te({step:e,nTry:t,jitter:s,min:i,max:n}){let a=i*Math.pow(e,t);if(s){const e=Math.random(),t=Math.floor(e*s*a);a=1&Math.floor(10*e)?a+t:a-t}return 0|Math.min(a,n)}function se(e,t){return async function(...s){let i=null;for await(const{sleep:a,duration:r,nTry:o}of function*(e){var t,s,i,n,a,r,o,l,c;const d=null!==(t=null==e?void 0:e.retries)&&void 0!==t?t:3,u=null!==(s=null==e?void 0:e.min)&&void 0!==s?s:100,h=null!==(i=null==e?void 0:e.max)&&void 0!==i?i:1e4,g=null!==(n=null==e?void 0:e.step)&&void 0!==n?n:2,m=null!==(a=null==e?void 0:e.jitter)&&void 0!==a?a:0,p="number"==typeof(null==e||null===(r=e.lastTryDelayTime)||void 0===r?void 0:r.min)?null==e||null===(o=e.lastTryDelayTime)||void 0===o?void 0:o.min:u,f={min:p,max:ee(p,"number"==typeof(null==e||null===(l=e.lastTryDelayTime)||void 0===l?void 0:l.max)?null==e||null===(c=e.lastTryDelayTime)||void 0===c?void 0:c.max:h)};if(u<=0)throw new X(Y.INVALID_CONFIG_MIN);if(m<0||m>1)throw new X(Y.INVALID_CONFIG_JITTER);let v=0;for(;v<=d;){let e=u,t=h;v===d-1&&(e=f.min,t=f.max);const s=te({nTry:v,step:g,jitter:m,min:e,max:t});yield{nTry:v,duration:s,sleep:()=>new Promise((e=>{setTimeout(e,s)}))},v++}}(t))try{const i=await e(...s);return o>0&&null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:o,duration:r,sleep:a,success:!0,shouldRetry:!1})),i}catch(n){i=n;const e=null!=t&&t.shouldRetryOnError?null==t?void 0:t.shouldRetryOnError:()=>Promise.resolve(!0),l=await e({error:n,currentState:{nTry:o,duration:r,sleep:a},input:s});if(null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:o,duration:r,sleep:a,shouldRetry:l,success:!1})),!l)throw i;await a()}throw new X(Y.MAX_RETRY)}}var ie=s("1BPm");const ne=self.performance;i.ModuleContainer.registerSingleton(D,class extends G{constructor(){super(),this._flush=async()=>{const e=[];try{if(this.clearFlushTimer(),"busy"===this.status)return;this.status="busy";const t=await this.getFilePath();let s=0;const i=ne.now();let n=0;for(;s<z.j&&this.size>0&&e.length<z.k&&ne.now()-i<this.MAX_FLUSH_DURATION||this._tryFlushAll===U.a.FlushNow&&this.size>0&&ne.now()-i<500;){const t=this.queue.shift();if(n++,t){const i=this._encode(t);s+=i.byteLength,e.push(i)}}const a=se(J.writeNoiseLogs,{min:z.e.min,max:z.e.max,retries:z.e.maxRetries,shouldRetryOnError:async({error:e})=>{if("number"==typeof(null==e?void 0:e.code)&&[ie.a.LockedForSingleWebInstance,ie.a.WorkerNotFound].includes(e.code))return this._lockAccessForSingleWeb(),!1;z.s&&zconsole.error(`ZLL: _flush: failed with error: ${e}`);await this.isLogDirExists();return!0},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:i})=>{z.s&&(e?zconsole.info(`ZLL: _flush try ${s}: success after ${i}ms`):zconsole.error(`ZLL: _flush try ${s}: failed. Should retry: ${t} after ${i}ms`)),e||t||zconsole.error(`ZLL: _flush failed after ${s} tries`)}});await a(t,e,{ReservedBytesStructure:[z.b.ui32,z.b.ui32],FileSizeLimit:z.d.file_lim})}catch(t){zconsole.error("ZLOG: _flush throws error",t)}finally{e.splice(0,e.length),this._scheduleNextFlush(this.flushTimeout)}},this._encode=e=>{try{var t;const{metadata:s,args:i}=e;let n=0;const a=new q,r=new Uint8Array(z.d.line_malloc+1),o=new DataView(r.buffer);n+=a.encodesSeparator(o,n);const l=n;n+=z.b.ui16,n=a.encodeTick(o,n,s.tick),n=a.encodeEncoderVers(o,n,z.v),n=a.encodeLevel(o,n,s.level),n=a.encodeZlogVersion(o,n,"4Tuwq6Bb"),n=a.encodePayload(n,o,{ln:s.ln,tags:s.tags,template:null==s||null===(t=s.template)||void 0===t?void 0:t[1],args:i}),a.encodeTotalSize(o,l,n);const c=n%2==0?n+1:n;return r.slice(0,c)}catch(s){throw T.a.error("BinEncoderImpl.encode error:",s),new Error("BinEncoderImpl.encode error")}},s("3a9X").initWebWorker((()=>{this.isWriterReady=!0,zconsole.info("ZLOG: opfs worker ready")}))}});var ae=s("/n5c");Object(i.define)("zlog-text-file-system");i.ModuleContainer.registerSingleton(ae.a,class{constructor(){this.write=async e=>{i.ModuleContainer.resolve(D).write(e)},this.tryFlushAll=async()=>{await i.ModuleContainer.resolve(D).tryFlushAll()}}});s("ezdo"),s("KdAX");var re=s("W8Xk");const oe=Object(i.define)("kv-cache"),le=Object(i.define)("kv-cache-in-mem");var ce;class de{constructor(e){this._prefix=void 0,this._prefix=`${e}-kv-db`}_buildKey(e){return`${this._prefix}-${e}`}async setItem(e,t){const s=this._buildKey(e),i=E.default.getInstance();return await i.setItemAsync(s,re.b(t)),t}async getItem(e){const t=this._buildKey(e),s=E.default.getInstance(),i=await s.getItemAsync(t);return Promise.resolve(i?re.a(i):void 0)}async removeItem(e){const t=this._buildKey(e),s=E.default.getInstance();return await s.removeItemAsync(t),this}}Object(i.singleton)(oe)(ce=class{createCache(e){return new de(`${e}`)}});var ue,he=s("ndDP");class ge{constructor(e,t){this._unused_name=e,this._lru=void 0,this._lru=new he.default(t)}setItem(e,t){return this._lru.set(e,t),Promise.resolve(t)}getItem(e){return Promise.resolve(this._lru.get(e))}removeItem(e){return this._lru.delete(e),Promise.resolve(this)}}Object(i.singleton)(le)(ue=class{constructor(){this._registry={}}createCache(e,t){return this._registry[e]||(this._registry[e]=new ge(e,t)),this._registry[e]}});var me=s("T0aS");class pe extends me.b{}i.ModuleContainer.registerSingleton(me.a,pe);s("0rWR"),s("Lq8m");var fe=s("NTiX");i.ModuleContainer.registerSingleton(fe.a,class{constructor(){this.store=E.default.getInstance(),this.getObject=this.store.getObject.bind(this.store),this.setObject=this.store.setObject.bind(this.store),this.getItem=this.store.getItem.bind(this.store),this.setItem=this.store.setItem.bind(this.store),this.removeItem=this.store.removeItem.bind(this.store),this.getItemForCurrentUser=this.store.getItemForCurrentUser.bind(this.store),this.getIntForCurrentUser=this.store.getIntForCurrentUser.bind(this.store),this.setItemForCurrentUser=this.store.setItemForCurrentUser.bind(this.store),this.removeItemForCurrentUser=this.store.removeItemForCurrentUser.bind(this.store)}authenticate(){}async getObjectAsync(e){return this.getObject(e)}async setObjectAsync(e,t){this.setObject(e,t)}async getItemAsync(e){return this.getItem(e)}async setItemAsync(e,t){this.setItem(e,t)}async removeItemAsync(e){this.removeItem(e)}async getIntForCurrentUserAsync(e,t){return this.getIntForCurrentUser(e,t)}async getItemForCurrentUserAsync(e){return this.getItemForCurrentUser(e)}async setItemForCurrentUserAsync(e,t){this.setItemForCurrentUser(e,t)}async removeItemForCurrentUserAsync(e){this.removeItemForCurrentUser(e)}});var ve=s("75pU"),be=s.n(ve),Ie=s("d/or"),ye=s("Brnv"),_e=s("JTyQ"),Ce=s("wudS");var Oe;let Ee=i.ModuleContainer.injectable()(Oe=function(e,t){return Object(i.inject)(ye.a)(e,void 0,0)}(Oe=Reflect.metadata("design:type",Function)(Oe=Reflect.metadata("design:paramtypes",[void 0===ye.IDatabaseStateStorage?Object:ye.IDatabaseStateStorage])(Oe=class{constructor(e){this.databaseStateStorage=e,this._userId=null,this.states=null,this.getAdapterTypeOfSharedDatabases=be()(this.getAdapterTypeOfSharedDatabases.bind(this)),this.getAdapterTypeOfUserScopedDatabases=be()(this.getAdapterTypeOfUserScopedDatabases.bind(this))}reset(){this.states=null,this.getAdapterTypeOfSharedDatabases=be()(this.getAdapterTypeOfSharedDatabases.bind(this)),this.getAdapterTypeOfUserScopedDatabases=be()(this.getAdapterTypeOfUserScopedDatabases.bind(this))}async getStates(){if(null!==this.states)return this.states;try{let e=await this.databaseStateStorage.getObjectAsync(_e.a);null===e&&(e=(()=>{const e=Object(Ce.f)(),t={shared:_e.c};return e.forEach((e=>{t[e]=_e.c})),t})(),await this.databaseStateStorage.setObjectAsync(_e.a,e)),this.states=e}catch(e){throw new Error("Invalid adapter type states")}return this.states}async saveStates(e){this.states=e,await this.databaseStateStorage.setObjectAsync(_e.a,e)}async getAdapterTypeOfSharedDatabases(){const e=await this.getStates();let t=!1;return void 0===e.shared&&(e.shared=_e.b,t=!0),t&&await this.saveStates(e),e.shared}async setAdapterTypeOfSharedDatabases(e){const t=await this.getStates();let s=!1;t.shared!==e&&(t.shared=e,s=!0),s&&await this.saveStates(t)}async getAdapterTypeOfUserScopedDatabases(e){const t=await this.getStates();let s=!1;return void 0===t[e]&&(t[e]=_e.b,s=!0),s&&await this.saveStates(t),t[e]}async setAdapterTypeOfUserScopedDatabases(e,t){const s=await this.getStates();let i=!1;s[e]!==t&&(s[e]=t,i=!0),i&&await this.saveStates(s)}async getInUseAdaperTypes(){const e=await this.getStates(),t=[];if(void 0!==e.shared){const s=e.shared;t.push(s)}if(null!==this._userId&&void 0!==e[this._userId]){const s=e[this._userId];t.includes(s)||t.push(s)}return t}init(e){this._userId=e,this.reset()}})||Oe)||Oe)||Oe)||Oe;i.ModuleContainer.registerSingleton(Ie.a,Ee);s("5yGw"),s("hRcX"),s("/2rj"),s("gpNb"),s("rhBN");var Me=s("Mgpg"),Se=s("1CsI");const Te="schverhis";i.ModuleContainer.registerSingleton(Se.a,class{constructor(){this.data=null,this.logger=void 0,this.flushTimeout=null;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory);this.logger=e.createZLogger("db",["schema-version-history"])}getHistoryData(){if(null===this.data){const t=E.default.getInstance().getItem(Te);if(null===t)this.data={};else try{const e=JSON.parse(t);this.data=e}catch(e){this.logger.zsymb(18,"YfgKNT","Can't parse schema version history data"),this.data={}}}return this.data}setHistoryData(e){this.data=e}verifySchemaVersion(e,t,s){const i={isAbnormal:!1,expectedVersion:null},n=this.getHistoryData()[`${e}`];if(void 0!==n){const e=n[t];void 0!==e&&(i.isAbnormal=s<e,i.expectedVersion=e)}return i}updateSchemaVersion(e,t,s,i={forceFlush:!1}){const n=this.getHistoryData();let a={},r=!1;const o=`${e}`,l=n[o];if(void 0===l)a[o]={[t]:s},r=!0;else{l[t]!==s&&(a=Object(f.a)(Object(f.a)({},n),{},{[o]:Object(f.a)(Object(f.a)({},n[o]),{},{[t]:s})}),r=!0)}r&&(this.setHistoryData(a),this.scheduleFlushData(i.forceFlush))}deleteSchemaVersion(e,t,s={forceFlush:!1}){const i=this.getHistoryData(),n=Object(f.a)({},i),a=i[`${e}`];a&&void 0!==a[t]&&(delete a[t],this.setHistoryData(n),this.scheduleFlushData(s.forceFlush))}scheduleFlushData(e=!1){if(e||null===this.flushTimeout){const t=()=>{const e=this.getHistoryData(),t=JSON.stringify(e);E.default.getInstance().setItem(Te,t)};e?(this.flushTimeout&&clearTimeout(this.flushTimeout),t()):this.flushTimeout=setTimeout((()=>{t(),this.flushTimeout=null}),5e3)}}});s("cF85");var we,Re=s("ggcH"),Le=s("wH4e"),De=s("pAGP"),Ae=s("zmG6"),Fe=s("AH6j"),je=s("Jz/+");let Pe=Object(i.injectable)()(we=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(we=Reflect.metadata("design:type",Function)(we=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(we=class extends Fe.b{constructor(e){super(),this.logger=void 0,this.corruptionDetectorAdapters=void 0,this.handleCorruptionEvent=e=>{this.logger.zsymb(0,"sjSIcm","Corrupt occurs"),this.dispatchEvent(e)},this.logger=e.createZLogger("db-corruption-detector",[]),this.corruptionDetectorAdapters=new Map,this.startDetectForSharedDB();i.ModuleContainer.resolve(me.a).addEventListener(je.a.SessionChange,(async({session:e})=>{null!==e&&this.startDetectForUserScopedDB(e.userId)}))}getAdapter(e){return i.ModuleContainer.resolveAll(Re.TDBCorruptionDetectorAdapter).find((t=>t.adapterType===e))}async startDetect(e){if(!i.ModuleContainer.isRegistered(Re.TDBCorruptionDetectorAdapter))return void this.logger.zsymb(0,"EjJfBO","Skip track corrupt, no available adapters.");const t=this.getAdapter(e);t&&!this.corruptionDetectorAdapters.has(e)&&(this.corruptionDetectorAdapters.set(e,t),t.addEventListener(Ae.a.DB_CORRUPTION_DETECTED,this.handleCorruptionEvent),t.start())}async startDetectForSharedDB(){const e=await i.ModuleContainer.resolve(De.a).getAdapterTypeOfSharedDatabases();this.startDetect(e)}async startDetectForUserScopedDB(e){const t=await i.ModuleContainer.resolve(De.a).getAdapterTypeOfUserScopedDatabases(e);this.startDetect(t)}async forceCheckDBCorruption(){this.logger.zsymb(0,"sEh1WO","forceCheckDBCorruption"),this.corruptionDetectorAdapters.forEach((e=>e.forceCheckDBCorruption()))}async forceCheckDBCorruptionFor(e){switch(this.logger.zsymb(0,"4qpK4f","forceCheckDBCorruptionFor",e),e){case Le.a.IDB:{const t=this.getAdapter(e);if(!t){this.logger.zsymb(0,"-q9zSQ","Adapter not found",e);break}await t.forceCheckDBCorruption(),t.corruptionHasOccurred()&&this.handleCorruptionEvent(new Re.IndexedDBCorruptionDetectedEvent(Date.now(),!1));break}default:throw new Error("Not support"+e)}}corruptionHasOccurred(){let e=!1;return this.corruptionDetectorAdapters.forEach((t=>{e=e||t.corruptionHasOccurred()})),e}})||we)||we)||we)||we;i.ModuleContainer.registerSingleton(Re.TDBCorruptionDetector,Pe),i.ModuleContainer.resolve(Re.TDBCorruptionDetector);var ke=s("teaq");const Ne=Object(i.define)("database-transform-reporter"),Ue=Object(i.define)("database-transform-migrate");var Be=s("Uzj0"),xe=s("8gV8"),Ge=s("yi2h"),ze=s("XB6V"),Ve=s("h0S/"),He=function(e){return e.NotStart="NotStart",e.Running="Running",e.Paused="Paused",e.Stoped="Stoped",e.Finished="Finished",e}(He||{});const We={gapTime:200,batchSize:100,version:0};class $e{constructor(e,t,s){this.scope=e,this.dbName=t,this.tableConfig=s}getState(){return xe.a.create(this.scope,this.dbName,this.tableConfig)}shouldResumeMigrate(e){return this.getState().then((t=>{let s=!1;return e==t.getCurrentVersion()&&(s=!t.isFinishedMigrate()),s}))}shouldUpgradeMigrate(e){return this.getState().then((t=>{const s=t.isFinishedMigrate(),i=e==t.getCurrentVersion()+1;return s&&i}))}async getMigrateVersion(e){const t=this.tableConfig.getTransformConfig(e);if(t){const e=Object.values(t.configs.version);for(let t=0;t<e.length;t++){const s=e[t],i=await this.shouldUpgradeMigrate(s.version),n=await this.shouldResumeMigrate(s.version);if(i||n)return s.version}}return-1}}class Ke{constructor(e,t,s,n,a,r){this.scope=e,this.dbName=t,this.tableConfig=s,this.partition=n,this.database=a,this.reporter=r,this.status=He.NotStart,this.configs=We,this.migrateDeferer=void 0,this.logger=void 0;const o=i.ModuleContainer.resolve(ze.a);this.migrateDeferer=new Be.c.Container,this.logger=o.createZLogger(Ve.ZLoggerNametags.dbDataTransform,["migrater"])}applyNewConfig(e){this.configs=Object(f.a)({},e)}getState(){return xe.a.create(this.scope,this.dbName,this.tableConfig)}shouldResumeMigrate(e){return new $e(this.scope,this.dbName,this.tableConfig).shouldResumeMigrate(e)}shouldUpgradeMigrate(e){return new $e(this.scope,this.dbName,this.tableConfig).shouldUpgradeMigrate(e)}async upgradeMigrateVersion(e){const{version:t,migrate:s}=e,i=await this.getState();return await this.doUpVersion(i,t),s?(this.logger.zsymb(0,"lbfzKX","upversion trigger migrate",this.tableConfig.name),this.startMigrate(t)):(this.logger.zsymb(0,"4nK4ov","upversion without migrate",this.tableConfig.name),this.doneMigrate())}async startMigrate(e){if(this.status!==He.NotStart)throw new Error("start migrate in valid status:"+this.status);if(this.migrateDeferer.value)return this.logger.zsymb(18,"E1e3PB","trigger migrate already settled",this.tableConfig.name),this.migrateDeferer.promise;const t=await this.getState();if(t.getCurrentVersion()!==e)throw new Error("migrate invalid version, please up version first:"+this.tableConfig.name);return await t.markStateAsRunning(),this.status=He.Running,this.reporter.onStart(this.tableConfig.name,e),this.doNextMigrateIterator(t),this.migrateDeferer.promise}async resumeMigrate(){if(this.status===He.Stoped)throw new Error("resume migrate in valid status:"+this.status);if(this.migrateDeferer.value)return this.logger.zsymb(18,"PomZOT","resume migrate already settled",this.tableConfig.name),this.migrateDeferer.promise;this.logger.zsymb(0,"adRUan","Resume migrate ",this.tableConfig.name);const e=await this.getState();return await e.markStateAsRunning(),this.status=He.Running,this.reporter.onStart(this.tableConfig.name,e.getCurrentVersion()),this.doNextMigrateIterator(e),this.migrateDeferer.promise}async pauseMigrate(e="unknown"){this.logger.zsymb(0,"FzREmP","Pause migrate ",this.tableConfig.name,e),this.status=He.Paused}async stopMigrate(e="unknown"){const t="string"==typeof e?e.slice(0,200):e;this.logger.zsymb(0,"IBsrTs","Stop migrate ",this.tableConfig.name,t);const s=await this.getState();this.status=He.Stoped,this.migrateDeferer.resolve({error:!0,message:t}),this.reporter.onError(this.tableConfig.name,s.getCurrentVersion(),e)}async doneMigrate(){if(this.migrateDeferer.value)return this.logger.zsymb(18,"Sr_4vZ","Migrate already settled!",this.tableConfig.name),this.migrateDeferer.promise;this.logger.zsymb(0,"Z1hifD","Done migrate: ",this.tableConfig.name);const e=await this.getState();return await e.markStateAsFinished()?this.migrateDeferer.resolve({error:!1,message:"Success"}):this.migrateDeferer.resolve({error:!0,message:"Persist state to fisk fail"}),this.reporter.onFinished(this.tableConfig.name,e.getCurrentVersion()),this.migrateDeferer.promise}doNextMigrateIterator(e){this.status===He.Running?setTimeout((()=>{this.doMigrate(e)}),this.configs.gapTime):this.logger.zsymb(0,"ulU3hk","stop migrate, not running")}async doMigrate(e){this.logger.zsymb(0,"nhqowC","Do migrate ",this.tableConfig.name,e.getCheckpoint());const t=async t=>{if(e.isDoneCheckpoint())return this.logger.zsymb(6,"9I4mnv","checkpoint reach upperbound",JSON.stringify(e.getCheckpoint())),[];const s={from:e.getCheckpoint(),to:e.getUpperbound(),excludeFrom:!0},i={partition:this.partition,limit:this.configs.batchSize,direction:Le.c.NEXT};return await t.getAll(s,i).catch((e=>{throw this.logger.zsymb(18,"6FjxhM","read error",JSON.stringify(e)),e}))},s=t=>{const s=this.tableConfig.getIndex("primary").createKey(t);e.updateCheckPoint(s)},i=async(t,s)=>{const i={replace:!0,partition:this.partition};await t.insertMulti(s,i).catch((t=>{throw e.rollback(),this.logger.zsymb(18,"XNgBbm","write error",JSON.stringify(t)),t}))},n=this.database[this.tableConfig.name];await this.database.runTransaction([n],(async([e])=>{const n=await t(e),a=n.length;return 0==a||(s(n[a-1]),await i(e,n)),a}),Le.j.READWRITE).then((async t=>{this.reporter.onProgress(this.tableConfig.name,e.getCurrentVersion(),t),await e.commitChange(),t<this.configs.batchSize?(this.logger.zsymb(0,"G_4jIt","reach to last batch",this.tableConfig.name),this.doneMigrate()):this.doNextMigrateIterator(e)})).catch((e=>{this.stopMigrate((null==e?void 0:e.message)||JSON.stringify(e))}))}doUpVersion(e,t){return new Promise(((s,i)=>{this.logger.zsymb(0,"caXkNo","start upgrade version:",this.tableConfig.name);const n=this.database[this.tableConfig.name],a=Object(Ge.b)(this.tableConfig),r=e=>{this.stopMigrate((null==e?void 0:e.message)||JSON.stringify(e))};this.database.runTransaction([n],(async([i])=>{const n=await i.getAll(void 0,{limit:1,direction:Le.c.PREV,partition:this.partition}),o=(()=>{if(0==n.length)return a;const e=n[n.length-1];return this.tableConfig.getIndex("primary").createKey(e)})();return e.upVersionTo(t,a,o).then(s).catch(r)}),Le.j.READWRITE).catch(r)}))}}var qe;const Qe={gapTime:100,version:0,batchSize:100};Object(i.injectable)()(qe=Object(i.singleton)(Ue)(qe=function(e,t){return i.ModuleContainer.inject(ke.b)(e,void 0,0)}(qe=function(e,t){return i.ModuleContainer.inject(ze.a)(e,void 0,1)}(qe=Reflect.metadata("design:type",Function)(qe=Reflect.metadata("design:paramtypes",[void 0===ke.b?Object:ke.b,void 0===ze.a?Object:ze.a])(qe=class{constructor(e,t){this.configManager=e,this.session=void 0,this.configs=void 0,this.logger=void 0,this.session=null,this.configs=Qe,this.logger=t.createZLogger(Ve.ZLoggerNametags.dbDataTransform,["manager"])}authenticate(e){this.session=e}async getMigrateVersion(e){if(!this.session)throw new Error("Get migrate version when the session has not yet been initialized.");const t=[],s=[];Object.entries(e).forEach((e=>{const t=e[0];Object.values(e[1]).forEach((e=>s.push([t,e])))}));for(let i=0;i<s.length;i++){const[e,n]=s[i],a=await this.configManager.getDatabaseConfigs(e),r=n.getTransformConfig(a[0].type);if(!r)continue;const o=await r.getScopedId(),l=new $e(o,e,n),c=await l.getMigrateVersion(a[0].type);-1!==c&&t.push(c)}return t.length?Math.min(...t):-1}async migrate(e,t,s){if(!this.session)throw new Error("Request migration when the session has not yet been initialized.");return this.configs=Object(f.a)(Object(f.a)({},this.configs),e),this.doMigrateUntilDie(Object.entries(s),(([e,s])=>this.migrateDB(t,e,s)))}async migrateDB(e,t,s){return this.logger.zsymb(0,"ztKdZo","migrate db",t),this.doMigrateUntilDie(Object.values(s),(s=>this.migrateTable(e,t,s)))}async migrateTable(e,t,s){const n=await this.configManager.getDatabaseConfigs(t),a={success:!0,type:"notMigrate"};if(0==n.length)throw new Error("Migrate on a database without a configured setup");const r=s.getTransformConfig(n[0].type);if(!r)return this.logger.zsymb(0,"khQlZg",`Transform config not found for table: ${s.name}`),a;this.logger.zsymb(0,"ULpzE8","Check migrate table: ",s.name);const o=i.ModuleContainer.resolve(Ne),l=await r.getScopedId(),c=new Ke(l,t,s,n[0].computePartitionName(this.session.userId,s.name),e[t],o);return c.applyNewConfig(this.configs),this.migrateToNextVersion(r,c)}async migrateToNextVersion(e,t){const s=Object.values(e.configs.version);for(let i=0;i<s.length;i++){const e=s[i];if(e.version>this.configs.version){this.logger.zsymb(0,"3NO_5n","Version too high",this.configs.version,e.version);break}const n=await t.shouldUpgradeMigrate(e.version),a=await t.shouldResumeMigrate(e.version);if(n){const s=await t.upgradeMigrateVersion(e);return{success:!s.error,type:"migrate",error:s.message}}if(a){const e=await t.resumeMigrate();return{success:!e.error,type:"migrate",error:e.message}}}return{success:!0,type:"notMigrate"}}async doMigrateUntilDie(e,t){const s=[];for(let i=0;i<e.length;i++){const n=await t(e[i]).catch((e=>({success:!1,type:"migrate",error:null==e?void 0:e.message})));if(!n.success)return n;s.push(n),await Be.c.delay(this.configs.gapTime)}return s.find((e=>"migrate"==e.type))||s[0]}})||qe)||qe)||qe)||qe)||qe);var Ze,Je=s("8/YW"),Ye=s("PmZf"),Xe=s("tHMN"),et=s("jIg3"),tt=s("fsN4"),st=s("Ugdv"),it=s("PObO");let nt=Object(Je.g)()(Ze=i.ModuleContainer.injectable()(Ze=function(e,t){return i.ModuleContainer.inject(Xe.b)(e,void 0,0)}(Ze=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,1)}(Ze=Reflect.metadata("design:type",Function)(Ze=Reflect.metadata("design:paramtypes",[void 0===Xe.a?Object:Xe.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Ze=class extends et.a{constructor(e,t){super(),this.engine=e,this.logger=void 0,this.removeListeners=()=>{},this.logger=t.createZLogger("db",["browser"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.engine.addEventListener(Ye.b.UnexpectedError,e)),t.push(this.engine.addEventListener(Ye.b.QueryExec,e)),t.push(this.engine.addEventListener(Ye.b.QueryError,e)),t.push(this.engine.addEventListener(Ye.b.SuccessOpenDB,e)),t.push(this.engine.addEventListener(Ye.b.LongOpenDB,e)),t.push(this.engine.addEventListener(Ye.b.ConnectionClosedAbnormally,e)),t.push(this.engine.addEventListener(Ye.b.SchemaMigratedAbnormally,e)),t.push(this.engine.addEventListener(Ye.b.Warning,e))}onDispose(){this.removeListeners()}install(){const e=i.ModuleContainer.resolve(Je.a);e.addEventListener(Je.b.Authenticated,(e=>{this.authenticate(e.getSession())})),e.currentSession&&this.authenticate(e.currentSession),this.logger.zsymb(3,"Xb3qxy",["installed","t7Yl4p"])}areYouOk(){return!0}authenticate(e){if(e){this.session=e,this.dispatchEvent(new Ye.g(e)),this.engine.authenticate(e),this.logger.zsymb(0,"sbL1qP",(()=>["authenticated",`id: ${e.userId}`]));i.ModuleContainer.resolve(it.a).authenticate(e);i.ModuleContainer.resolve(Ue).authenticate(this.session)}}checkShouldMigrate(){const e=i.ModuleContainer.resolve(st.a).getAppSchemas();return i.ModuleContainer.resolve(Ue).getMigrateVersion(e)}migrateData(e,t){const s=i.ModuleContainer.resolve(st.a).getAppSchemas();return i.ModuleContainer.resolve(Ue).migrate(e,t,s)}async closeDBs(e,t){const s=tt.default.getInstance();let i=[];e?e.length&&(i=e.map((e=>s[e].closeThisDatabase(t)))):i=[s.closeAllDatabases(t)],await Promise.all(i)}})||Ze)||Ze)||Ze)||Ze)||Ze)||Ze;i.ModuleContainer.registerSingleton(et.b,nt);var at=s("fc/q"),rt=s("PoHQ");i.ModuleContainer.registerSingleton(at.b,class{log(e){rt.p.triggerEvent(rt.h,[{commandId:e.commandId,success:!0===e.success,subCommandId:e.subCommandId||0,duration:e.duration||0,errorCode:e.errorCode||0,startTime:e.startTime||Date.now(),params:e.params||[]}])}});var ot,lt=s("W8fB");let ct=Object(i.injectable)()(ot=class{})||ot;i.ModuleContainer.registerSingleton(lt.b,ct);var dt=s("HPcM");let ut=function(e){return e.Init="Init",e.Idle="Idle",e.Busy="Busy",e.Paused="Paused",e.Disabled="Disabled",e}({});const ht=Object(i.define)("virtual-file-writer");var gt;let mt=Object(i.injectable)()(gt=function(e,t){return Object(i.inject)(dt.a)(e,void 0,0)}(gt=function(e,t){return Object(i.inject)(ht)(e,void 0,1)}(gt=Reflect.metadata("design:type",Function)(gt=Reflect.metadata("design:paramtypes",[void 0===dt.a?Object:dt.a,void 0===ht?Object:ht])(gt=class extends Fe.b{constructor(e,t){super(),this.bucket=e,this.logWriter=t,this._mode=void 0,this.status=ut.Init,this._mode=F.Binary}async init(){z.q&&T.a.log("DBLogWriterImpl.init()");try{await this.logWriter.loadMeta(),this._mode===F.Binary&&z.v<62&&await this.logWriter.loadModule()}catch(e){T.a.debug("[ZLL]: DBLogWriterImpl.init() failed",e)}this.status=ut.Idle,z.q&&T.a.log("[ZLL]: DBLogWriterImpl init() DONE",ut[this.status])}async flush(){if(this.status!==ut.Idle)return;let e=Date.now();if(0===this.bucket.size())return;z.q&&T.a.log(`FLUSHING: ${this.bucket.size()} logs => DB`),this.status=ut.Busy;const t=this.bucket.get(z.n),s=t.length;await this.logWriter.write(t)?(await this.logWriter.flushMetas(),this.bucket.removeFirst(s-t.length)):t.length>0&&T.a.error(`[ZLL]: flush failed: ${s-t.length}/${s}. failed:${t.length}/${s}`),this._mode===F.Binary&&z.v<62&&await this.logWriter.flushModules(),this.status=ut.Idle,z.q&&T.a.log(`FLUSHED: ${s-t.length}/${s} logs => DB. TOOK: ${Date.now()-e}ms`)}})||gt)||gt)||gt)||gt)||gt;var pt,ft=s("ez9R"),vt=s("XuBa"),bt=s("j6JD");const It={id:0,current:0,currentPage:0,startups:[],ss:-1,ss_ln:-1};let yt=Object(i.injectable)()(pt=Reflect.metadata("design:type",Function)(pt=Reflect.metadata("design:paramtypes",[])(pt=class{constructor(){this._status=void 0,this.BinEncoder=null,this.DB=void 0,this.currentPage=void 0,this.module=new Map,this.metas={data:It,updateRequired:!1},this._status=ut.Idle,this.DB=tt.default.getInstance().ZLog}get status(){return this._status}async write(e){try{return this._status=ut.Busy,await this.encodeFit(e,this.metas),this._status=ut.Idle,!0}catch(t){return T.a.error(`[ZLL]: VirtualFileWriterImpl.write err ${t}`),this._status=ut.Idle,!1}}async collectAllLogs(){try{const e=(await this.DB.Pages.getAll()).map((e=>e.data.slice(0,e.curoffs))),t=new Blob(e);return await t.arrayBuffer()}catch(e){return T.a.error(`[ZLL]:VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async read(e){try{return await this.DB.Pages.get(e)}catch(t){return void T.a.error(`[ZLL]: VirtualFileWriterImpl.reading ${e} err ${t}`)}}async delete(e){try{return await this.DB.Pages.delete(e),!0}catch(t){return T.a.error(`[ZLL]:VirtualFileWriterImpl.deleting ${e} err ${t}`),!1}}async encodeFit(e,t){var s;if(0===e.length)return;const i=[],n=z.d.page_limit;this.currentPage&&this.currentPage.id===t.data.currentPage||(this.currentPage=await this.DB.Pages.get(t.data.currentPage),this.currentPage&&(this.currentPage.curoffs=0));let a=0;const r=n-((null===(s=this.currentPage)||void 0===s?void 0:s.curoffs)||0);let o=z.c.OK;for(;e.length;){const t=await this.encodeBinary(e[0]);if(a+t.byteLength>r){o=z.c.OVERSIZE_NEXTPAGE;break}i.push(new Uint8Array(t)),a+=t.byteLength,e.shift()}if(0===i.length&&o===z.c.OVERSIZE_NEXTPAGE){if(this.currentPage&&this.currentPage.curoffs<this.currentPage.data.size){const e=this.currentPage.data.slice(0,this.currentPage.curoffs);this.currentPage.data=e,await this.DB.Pages.insert(this.currentPage,{replace:!0})}return this.nextPage(t),void(await this.DB.Metas.insert(t.data,{replace:!0}))}if(!i.length)return;const l=this.combineArrayBuffers(i);if(this.currentPage){if(l.byteLength){const e=this.currentPage.data.slice(0,this.currentPage.curoffs),t=new Blob([e,l]);this.currentPage.data=t,this.currentPage.curoffs+=l.byteLength,this.currentPage.max=z.d.page_limit,this.currentPage.mtime=Date.now()}o===z.c.OVERSIZE_NEXTPAGE?this.nextPage(t):t.data.current=this.currentPage.curoffs,l.byteLength&&await this.DB.Pages.insert(this.currentPage,{replace:!0});try{await this.DB.Metas.insert(t.data,{replace:!0})}catch(c){T.a.error("[ZLL]: VirtualFileWriterImpl.encodeFit err2",c)}}else{this.currentPage={id:t.data.currentPage,data:new Blob([l]),curoffs:l.byteLength,max:z.d.page_limit,mtime:Date.now()},t.data.current=l.byteLength;try{await this.DB.Pages.insert(this.currentPage,{replace:!0}),await this.DB.Metas.insert(t.data,{replace:!0})}catch(c){T.a.error("[ZLL]:VirtualFileWriterImpl.encodeFit err",c)}}}combineArrayBuffers(e){const t=e.reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;for(const n of e)s.set(new Uint8Array(n),i),i+=n.byteLength;return s.buffer}getSessionLineId(){let e=this.metas.data.ss;const t=(this.metas.data.ss_ln+1)%z.p.SESSION_LINE_MAX;return 0===t&&(e=(e+1)%z.p.SESSION_MAX),this.metas.data.ss=e,this.metas.data.ss_ln=t,{ss:e,ss_ln:t}}encodeText(e){const t=this.getSessionLineId();return Object(V.b)(e,t).buffer}async encodeBinary(e){this.BinEncoder||(this.BinEncoder=i.ModuleContainer.resolve(ft.a));return this.BinEncoder.encode(e)}nextPage(e){const t=z.d.page_limit,s=z.d.file_lim,i=Math.floor(s/t),n=(e.data.currentPage+1)%i;return e.updateRequired=!0,e.data.currentPage=n,e.data.current=0,e}async loadMeta(){try{let e=await this.DB.Metas.get(0);e||(e=It),e.startups.length>z.a&&(e.startups=e.startups.slice(0,z.a)),e.startups.unshift(Object(bt.a)(Date.now())),e.ss=void 0!==e.ss?e.ss:-1,e.ss_ln=-1,this.metas.data=e,this.metas.updateRequired=!1}catch(e){T.a.error(`[ZLL]: VirtualFileWriterImpl.loadMeta err ${e}`)}return await this._loadCurrentPage(),this.metas}async flushMetas(){this.metas.updateRequired&&await this.DB.Metas.insert(this.metas.data,{replace:!0,retry:1})}async loadModule(){try{const e=await this.DB.Modules.getAll();if(e){const t=e.map((e=>[vt.a.decrypt(e.hash),{data:e,updateRequired:!1}]));this.module=new Map(t)}}catch(e){T.a.error(`[ZLL]: VirtualFileWriterImpl.loadModule err ${e}`)}return this.module}async flushModules(){const e=Array.from(this.module.values());for(const t of e)t.updateRequired&&(await this.DB.Modules.insert(t.data,{retry:1}),t.updateRequired=!1)}async _loadCurrentPage(){this.metas||await this.loadMeta();const e=await this.DB.Pages.get(this.metas.data.currentPage);return this.currentPage=e,e}})||pt)||pt)||pt;i.ModuleContainer.registerSingleton(ht,yt),i.ModuleContainer.registerSingleton(lt.c,mt);var _t,Ct=s("5l/R"),Ot=s("Y41u"),Et=s("K8kB");let Mt=Object(i.injectable)()(_t=function(e,t){return Object(i.inject)(Et.a)(e,void 0,0)}(_t=function(e,t){return Object(i.inject)(lt.c)(e,void 0,1)}(_t=function(e,t){return Object(i.inject)(lt.b)(e,void 0,2)}(_t=Reflect.metadata("design:type",Function)(_t=Reflect.metadata("design:paramtypes",[void 0===Et.a?Object:Et.a,void 0===lt.c?Object:lt.c,void 0===lt.b?Object:lt.b])(_t=class{constructor(e,t,s){this._writeScheduler=e,this.zlogWriter=t,this.senWriter=s,this.setupWriters=async()=>{(await Object(B.b)()).enable_calf||(this.zlogWriter.init(),this._writeScheduler.start(),this._listenEvents())},this._handleFlushRequest=()=>{this.zlogWriter.flush()},this._handleWriterStatus=e=>{}}_listenEvents(){this._writeScheduler.addEventListener(Ot.c.WriteSchedulerRequestFlush,this._handleFlushRequest),this.zlogWriter.addEventListener(Ot.c.WriterStatus,this._handleWriterStatus)}})||_t)||_t)||_t)||_t)||_t)||_t;i.ModuleContainer.registerSingleton(Ct.a,Mt);var St,Tt=s("YrRS"),wt=s("OMsT"),Rt=s("XS0u");let Lt=Object(i.injectable)()(St=class{clientDeviceInfo(){return JSON.stringify({ua:navigator.userAgent,build:"production-release",pversion:"25.6.1",bhash:"df9aab9f233d8a6c7e6c83b75d079752315899e3"})}prepareLogBlob(e){return new Promise(((t,i)=>{let n=e.viewerKey;if(!n){n=Rt.default.getLastViewKey()||"";try{var a;n=null===(a=n)||void 0===a?void 0:a.split(".")[0]}catch{}}const r=new(s("xOOu")),o=`zlog_${n}_25.6.1-production_${Date.now()}.zip`;if(B.a){s("3a9X").getWebLogFileAsBuffer("web.calf").then((s=>{if("ERROR"===s.type)return void i(s.data);r.file("web.calf",s.data.buffer);const n=new TextEncoder;r.file("device.zinfo",n.encode(this.clientDeviceInfo()).buffer),r.generateAsync({type:"arraybuffer",compression:"DEFLATE"}).then((s=>{if(e.bareContent)t({name:o,data:new Uint8Array(s)});else{const e=new Blob([new Uint8Array(s)]);e.name=o,t(e)}})).catch((e=>{i(e)}))}))}else{const s=[this.collectLDBLogs(),this.collectLDBMetas(),this.collectLDBModules()];Promise.all(s).then((s=>{const[n,a,l]=s;{const e=F.Binary,t=`${Object(S.getProcess)()}.${j[e].logExt}`;r.file(t,n)}{const e=`${Object(S.getProcess)()}.meta`;r.file(e,a)}{const e=`${Object(S.getProcess)()}.module`;r.file(e,l)}{const e="device.zinfo",t=new TextEncoder;r.file(e,t.encode(this.clientDeviceInfo()).buffer)}r.generateAsync({type:"arraybuffer",compression:"DEFLATE"}).then((s=>{if(e.bareContent)t({name:o,data:new Uint8Array(s)});else{const e=new Blob([new Uint8Array(s)]);e.name=o,t(e)}})).catch((e=>{i(e)}))}))}}))}async collectLDBLogs(){try{const e=tt.default.getInstance().ZLog,t=(await e.Pages.getAll()).map((e=>e.data)),s=new Blob(t);return await s.arrayBuffer()}catch(e){return T.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async collectLDBMetas(){try{const e=tt.default.getInstance().ZLog,t=await e.Metas.get(0);if(t){const e=new Blob([JSON.stringify({current:t.current,currentPage:t.currentPage,startups:t.startups})]);return await e.arrayBuffer()}return new ArrayBuffer(0)}catch(e){return T.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async collectLDBModules(){try{const e=tt.default.getInstance().ZLog,t=await e.Modules.getAll();if(t){const e={size:0};t.forEach((t=>{e[t.hash]=t.id,e.size++}));const s=new Blob([JSON.stringify(e)]);return await s.arrayBuffer()}return new ArrayBuffer(0)}catch(e){return T.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}})||St;i.ModuleContainer.registerSingleton(wt.a,Lt);s("jw3m");var Dt=s("q1tI"),At=s.n(Dt),Ft=s("i8i4"),jt=s.n(Ft),Pt=s("Jcee");class kt extends Pt.b{constructor(e,t,s,i){super(e,t,s),this.container=void 0,this.component=void 0,this.container=i.container,this.component=i.component}async start(){await super.start(),this.render()}render(){jt.a.render(At.a.createElement(this.component),this.container)}}let Nt=function(e){return e.Idle="idle",e.Active="active",e}({}),Ut=function(e){return e[e.idle=0]="idle",e[e.active=1]="active",e}({});class Bt extends Fe.b{constructor(e){super(),this.status=Ut.active,this.window=void 0,this.idleDelay=void 0,this.minimumIdlePeriod=void 0,this.lastIdleTime=void 0,this.focusStateChangeDebounceTimer=void 0,this.handleDocumentBlur=()=>{this.resetFocusStateChangeDebounceTimer(),this.focusStateChangeDebounceTimer=setTimeout((()=>{this.setStateToIdle()}),this.idleDelay)},this.handleDocumentFocus=()=>{this.resetFocusStateChangeDebounceTimer(),this.setStateToActive()},this.idleDelay=e.idleDelay,this.minimumIdlePeriod=e.minimumIdlePeriod,this.window=e.window||window,this.lastIdleTime=0,this.focusStateChangeDebounceTimer=null}start(){this.window.addEventListener("blur",this.handleDocumentBlur),this.window.addEventListener("focus",this.handleDocumentFocus)}stop(){this.window.removeEventListener("blur",this.handleDocumentBlur),this.window.removeEventListener("focus",this.handleDocumentFocus)}onIdle(e){return this.addEventListener(Nt.Idle,e)}setStateToActive(){this.status!==Ut.idle||(this.status=Ut.active,this.dispatchEvent(new Event(Nt.Active)))}setStateToIdle(){if(this.status!==Ut.active)return;this.isThrottlingIdleState()||(this.lastIdleTime=Date.now(),this.status=Ut.idle,this.dispatchEvent(new Event(Nt.Idle)))}isThrottlingIdleState(){return Date.now()-this.lastIdleTime<this.minimumIdlePeriod}resetFocusStateChangeDebounceTimer(){this.focusStateChangeDebounceTimer&&(clearTimeout(this.focusStateChangeDebounceTimer),this.focusStateChangeDebounceTimer=null)}}var xt=s("wx14"),Gt=s("/MKj"),zt=s("FK2X"),Vt=s("HuPi"),Ht=s("emRR"),Wt=s("xrk1"),$t=s("ZBGy"),Kt=s("T1Xd"),qt=s("uzdi");const Qt=Object(qt.a)();function Zt(){const e=Qt.useRecoilSnapshot();return Qt.setSnapShot(e),null}var Jt=s("QVmZ"),Yt=s("72hn"),Xt=s("ZlRg"),es=s("VaDh"),ts=s("CzFt"),ss=s("h0sc"),is=s("L+5E"),ns=s("UiPd"),as=s("Yi2m"),rs=s("6uTC"),os=s("c51z"),ls=s("sqm0"),cs=s("NTw/"),ds=s("7NAg"),us=s("7TIh");var hs=s("hI9i"),gs=s("paDR");var ms=s("q9t1");const ps="o2o/ui",fs=Object(i.define)("o2o");var vs=s("Jq9Z");Object(i.define)("app-version-manager");let bs=function(e){return e.VERIFIED="VERIFIED",e.OLD_MAJOR_VERSION="OLD_MAJOR_VERSION",e.OLD_DB_VERSION="OLD_DB_VERSION",e.NONE="NONE",e}({});var Is=()=>{const[e,t]=Object(Dt.useState)(bs.VERIFIED);return Object(Dt.useEffect)((()=>{0}),[]),{appVersionState:e}};var ys=s("Jq/t"),_s=s("ro+J");const Cs=e=>{const t=Object(Gt.f)(),s=Object(Dt.useMemo)((()=>Object($t.d)(t)),[t]),i=Object($t.c)(),n=Object(Gt.g)((e=>({user:e.user,popup:e.popup,status:e.status,profile:e.profile,chatview:e.chatview})),((e,t)=>e.user==t.user&&e.popup==t.popup&&e.status==t.status&&e.profile==t.profile&&e.chatview==t.chatview));var a;return(e=>{const t=Object(Dt.useCallback)((()=>{const e=Rt.default.getFullDiskChatPopupNoti();let t=!0,s=!0;[ds.e.FULL,ds.e.ALMOST_FULL_2].includes(null==e?void 0:e.level)&&(t=!1,(null==e?void 0:e.level)===ds.e.FULL&&(s={data:{tab:us.h.RES_MANAGEMENT}})),ss.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.SETTINGS,params:s,forceCloseAll:t})}),[]),s=Object(Dt.useCallback)((()=>{ss.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.APP_INFO,params:!0})}),[]),i=Object(Dt.useCallback)(((e,t)=>{var s;ls.a.setFlagCopyFromCapture(!!t&&!!t.isCopyFromCap),ls.a.setTimeClipboardChanged(performance.now()),null===(s=Object(cs.b)())||void 0===s||s.setTimeClipboardChanged(performance.now())}),[]),n=(t,s)=>{const i=ns.default.getFriendsSync();is.a.doActionWithUri(s,e,i)},a=(t,{term:s,data:i})=>{switch(s){case"id":is.a.autoOpenConversationById(i,e),i.startsWith(R.GROUPID_PREFIX)?as.default.logAction(2220801):i.startsWith(R.OA_ID_PREFIX)?as.default.logAction(2220803):as.default.logAction(2220802);break;case"phone":as.default.logAction(2220804),is.a.autoOpenConversationByPhone(i,e);break;case"username":as.default.logAction(2220805),is.a.autoOpenConversationByUsername(i,e);break;default:rs.default.createError(os.a.str("STR_GROUP_NO_EXIST"))}};Object(Dt.useEffect)((()=>($zsub.$zuri.onNewRequest(n),$zsub.$zuri.onRequestOpenConv(a),()=>{$zsub.$zuri.removeListenNewRequest(n),$zsub.$zuri.removeListenRequestOpenConv(a)})),[e]),Object(Dt.useEffect)((()=>{$zsub.$zapp.onRequestShowPreference(t),$zsub.$zapp.onRequestShowAbout(s),$zsub.$zresource.onClipboardChange(i)}),[])})(s),a=s,Object(gs.b)(gs.a.Dispatch,((e,t,s)=>{a(s)})),function(e){Object(gs.b)(gs.a.Emit,((t,s,i)=>{e(i)}))}(i),At.a.createElement(zt.c,Object(xt.a)({emitter:i,dispatch:s},n,{shouldShowMigrateScreen:e.shouldShowMigrateScreen,shouldKeepLoadingScreenDueToStartUpPreload:e.shouldKeepLoadingScreenDueToStartUpPreload}))};function Os(e){const t=Object(hs.m)(ms.b,ms.c,(e=>{const{status:t}=e;return vs.b.includes(t)})),s=Object(hs.m)(fs,ps,(e=>e.shouldKeepLoadingScreen));return At.a.createElement(Cs,Object(xt.a)({},e,{shouldShowMigrateScreen:t,shouldKeepLoadingScreenDueToStartUpPreload:s}))}const Es=e=>{const{appVersionState:t}=Is(),{maintenanceMode:s}=Object(ys.d)({});if(t===bs.NONE)return null;bs.VERIFIED;return null===s?At.a.createElement(ys.a,null):s?At.a.createElement(ys.b,null):At.a.createElement(Os,e)},Ms=((...e)=>({children:t})=>e.reduceRight(((e,[t,s={}])=>At.a.createElement(t,s,e)),t))([Gt.a,{store:Ht.default}],[Gt.a,{store:ts.a,context:ts.b}],[Gt.a,{store:Jt.a,context:Yt.a}],[Gt.a,{store:Xt.a,context:es.a}],[Gt.a,{store:hs.b,context:hs.a}],[$t.b],[Wt.c],[Kt.a]),Ss=()=>At.a.createElement(Ms,null,At.a.createElement(Vt.a,{_window:window}),At.a.createElement(Zt,null),At.a.createElement(_s.a,null,At.a.createElement(Es,null)));var Ts=s("USLQ"),ws=s("XPd9"),Rs=s("RoG4"),Ls=s("Xb5w"),Ds=s("+pQO"),As=s("TmDO"),Fs=s("vtBH"),js=s("iwo6");const Ps=["category","label","value"],ks="zinstant-binded-content",Ns="zinstant-load-failed",Us="zinstant-reload",Bs="loading",xs="connected";var Gs,zs=Object(ws.a)("triggerRetry"),Vs=Object(ws.a)("retry"),Hs=Object(ws.a)("loaded"),Ws=Object(ws.a)("failed"),$s=Object(ws.a)("lang"),Ks=Object(ws.a)("debound"),qs=Object(ws.a)("zkey"),Qs=Object(ws.a)("data"),Zs=Object(ws.a)("msgId"),Js=Object(ws.a)("userId"),Ys=Object(ws.a)("extraData"),Xs=Object(ws.a)("onContextMenu"),ei=Object(ws.a)("onClose"),ti=Object(ws.a)("windowId"),si=Object(ws.a)("zinstantEle"),ii=Object(ws.a)("theme");class ni extends HTMLElement{constructor(){super(),Object.defineProperty(this,zs,{writable:!0,value:!1}),Object.defineProperty(this,Vs,{writable:!0,value:0}),Object.defineProperty(this,Hs,{writable:!0,value:!1}),Object.defineProperty(this,Ws,{writable:!0,value:!1}),Object.defineProperty(this,$s,{writable:!0,value:os.a.getCurrentLanguageName()}),Object.defineProperty(this,Ks,{writable:!0,value:null}),Object.defineProperty(this,qs,{writable:!0,value:""}),Object.defineProperty(this,Qs,{writable:!0,value:null}),Object.defineProperty(this,Zs,{writable:!0,value:""}),Object.defineProperty(this,Js,{writable:!0,value:""}),Object.defineProperty(this,Ys,{writable:!0,value:null}),Object.defineProperty(this,Xs,{writable:!0,value:null}),Object.defineProperty(this,ei,{writable:!0,value:null}),Object.defineProperty(this,ti,{writable:!0,value:""}),Object.defineProperty(this,si,{writable:!0,value:null}),Object.defineProperty(this,ii,{writable:!0,value:""}),this.onContextMenu&&(this.oncontextmenu=this.onContextMenu),Object(Ts.a)(this,ii)[ii]=js.a.getTheme()}connectedCallback(){var e,t,s;this.render(Bs),Object(Ts.a)(this,Qs)[Qs]=this.getAttribute("data")?JSON.parse(this.getAttribute("data")):null,Object(Ts.a)(this,Zs)[Zs]=null!==(e=this.getAttribute("msgId"))&&void 0!==e?e:"",Object(Ts.a)(this,Js)[Js]=null!==(t=this.getAttribute("userId"))&&void 0!==t?t:"",Object(Ts.a)(this,Ys)[Ys]=this.getAttribute("extraData")?JSON.parse(this.getAttribute("extraData")):null,Object(Ts.a)(this,ti)[ti]=null!==(s=this.getAttribute("windowId"))&&void 0!==s?s:"1",os.a.callUpdate(this.updateLang.bind(this)),this.render(xs),Fs.b.on(As.k.SETTING_UPDATED,(e=>{Object(Ts.a)(this,ii)[ii]=e.theme,Object(Ts.a)(this,si)[si].setAttribute("data-theme",Object(Ts.a)(this,ii)[ii])}))}disconnectedCallback(){Object(Ts.a)(this,ei)[ei]&&Object(Ts.a)(this,ei)[ei](),os.a.removeUpdate(this.updateLang.bind(this)),Rs.c.removeUICallback&&Rs.c.removeUICallback(Object(Ts.a)(this,qs)[qs])}static get observedAttributes(){return["data","msgId","userId","extraData","windowId"]}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"data":JSON.stringify(Object(Ts.a)(this,Qs)[Qs])!==s&&(Object(Ts.a)(this,Qs)[Qs]=s?JSON.parse(s):null);break;case"userId":Object(Ts.a)(this,Js)[Js]!==s&&(Object(Ts.a)(this,Js)[Js]=s);break;case"msgId":Object(Ts.a)(this,Zs)[Zs]!==s&&(Object(Ts.a)(this,Zs)[Zs]=s);break;case"windowId":Object(Ts.a)(this,ti)[ti]!==s&&(Object(Ts.a)(this,ti)[ti]=s);break;case"extraData":Object(Ts.a)(this,Ys)[Ys]=s?JSON.parse(s):null}}callbackFromZInstant(e){var t,s;let{type:i,payload:n}=e||{};switch(i){case"bindContent":if(Object(Ts.a)(this,Hs)[Hs]=!0,Object(Ts.a)(this,Ws)[Ws]=!1,Object(Ts.a)(this,Ys)[Ys]){let e=Ds.a.setMessageInfo;"function"==typeof e&&e(Object(Ts.a)(this,Zs)[Zs],Object(Ts.a)(this,Ys)[Ys])}else{let e=Ds.a.removeMessageInfo;"function"==typeof e&&e(Object(Ts.a)(this,Zs)[Zs])}this.render(ks);break;case"downloadUrlFail":this.setStatusFail();break;case"impressionTrigger":var a,r,o;if(Object.keys(n).some((e=>Ps.includes(e)&&null!==n[e]))&&((null===(t=Object(Ts.a)(this,Qs)[Qs])||void 0===t?void 0:t.pcItem)||(null===(s=Object(Ts.a)(this,Qs)[Qs])||void 0===s?void 0:s.bubbleItem)).zinstantdata_id)as.default.logActionInfoV2(as.FeaturesInfo.ZInstant,Rs.a.TYPE_TRACKING.IMPRESSION,{[Rs.a.TRACKING_CMD.ID]:null===(a=(null===(r=Object(Ts.a)(this,Qs)[Qs])||void 0===r?void 0:r.pcItem)||(null===(o=Object(Ts.a)(this,Qs)[Qs])||void 0===o?void 0:o.bubbleItem))||void 0===a?void 0:a.zinstantdata_id,[Rs.a.TRACKING_CMD.WIDGET_ID]:n.widget_id,[Rs.a.TRACKING_CMD.CATEGORY]:n.category,[Rs.a.TRACKING_CMD.LABEL]:n.label,[Rs.a.TRACKING_CMD.VALUE]:n.value});break;case"disconnectedCallback":Object(Ts.a)(this,si)[si].remove(),Object(Ts.a)(this,si)[si]=null,this.innerHTML=""}}set onContextMenu(e){Object(Ts.a)(this,Xs)[Xs]=e}get onContextMenu(){return Object(Ts.a)(this,Xs)[Xs]}set onClose(e){Object(Ts.a)(this,ei)[ei]=e}updateLang(){Object(Ts.a)(this,$s)[$s]=os.a.getCurrentLanguageName(),Object(Ts.a)(this,si)[si]&&(Object(Ts.a)(this,si)[si].className=`zinstant-container ${Object(Ts.a)(this,$s)[$s]}`)}setStatusFail(){if(!Object(Ts.a)(this,zs)[zs])return Object(Ts.a)(this,Hs)[Hs]=!0,Object(Ts.a)(this,Ws)[Ws]=!0,void this.render(Ns);Object(Ts.a)(this,Ks)[Ks]||(Object(Ts.a)(this,Ks)[Ks]=setTimeout((()=>{Object(Ts.a)(this,zs)[zs]=!1,Object(Ts.a)(this,Ks)[Ks]=null,Object(Ts.a)(this,Hs)[Hs]=!0,Object(Ts.a)(this,Ws)[Ws]=!0,this.render(Ns)}),1e3))}render(e){var t,s,i,n,a;(e===Bs&&(this.innerHTML=""),e===xs)?(Object(Ts.a)(this,si)[si]||(Object(Ts.a)(this,qs)[qs]=Rs.c.bindUICallback((e=>this.callbackFromZInstant(e))),Object(Ts.a)(this,si)[si]=document.createElement("z-instant")),Object(Ts.a)(this,si)[si].className=`zinstant-container ${Object(Ts.a)(this,$s)[$s]}`,Object(Ts.a)(this,si)[si].setAttribute("data-uikey",Object(Ts.a)(this,qs)[qs]),Object(Ts.a)(this,si)[si].setAttribute("data-url",null===(t=Object(Ts.a)(this,Qs)[Qs])||void 0===t||null===(s=t.pcItem)||void 0===s?void 0:s.data_url),Object(Ts.a)(this,si)[si].setAttribute("data-retry",Object(Ts.a)(this,Vs)[Vs]),Object(Ts.a)(this,si)[si].setAttribute("data-msg",Object(Ts.a)(this,Zs)[Zs]),Object(Ts.a)(this,si)[si].setAttribute("data-local",Ls.a.getFilePathFromUrl(null===(i=Object(Ts.a)(this,Qs)[Qs])||void 0===i||null===(n=i.pcItem)||void 0===n?void 0:n.data_url,Object(Ts.a)(this,Js)[Js])),Object(Ts.a)(this,si)[si].setAttribute("data-zns",JSON.stringify(null===(a=Object(Ts.a)(this,Qs)[Qs])||void 0===a?void 0:a.pcItem)),Object(Ts.a)(this,si)[si].setAttribute("data-theme",Object(Ts.a)(this,ii)[ii]),Object(Ts.a)(this,si)[si].setAttribute("data-locale",Object(Ts.a)(this,$s)[$s]),Object(Ts.a)(this,si)[si].oncontextmenu=this.onContextMenu,this.appendChild(Object(Ts.a)(this,si)[si])):e===ks||(e===Ns?(Object(Ts.a)(this,si)[si].remove(),Object(Ts.a)(this,si)[si]=null,this.innerHTML=""):e===Us&&(Object(Ts.a)(this,si)[si].remove(),Object(Ts.a)(this,si)[si]=null,this.innerHTML="",setTimeout((()=>{this.render(xs)}),1e3)))}}customElements.define("z-instant-anywhere",ni);let ai=Object(i.injectable)()(Gs=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Gs=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(Gs=Reflect.metadata("design:type",Function)(Gs=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Gs=class extends kt{constructor(e,t){super("zalo",e,t,{component:Ss,container:document.getElementById("app")})}async start(){this.setupIdleDetector(),await super.start()}getUserID(){var e;return(null===(e=this.getSession())||void 0===e?void 0:e.userId)||""}setupIdleDetector(){const e=this.config.get("idle_detector"),t=new Bt(e);t.addEventListener(Nt.Idle,(()=>{this.setStateToIdle()})),t.addEventListener(Nt.Active,(()=>this.setStateToActive())),t.start(),this.disposables.add((()=>t.stop())),document.hasFocus()?this.setStateToActive():this.setStateToIdle()}})||Gs)||Gs)||Gs)||Gs)||Gs;i.ModuleContainer.registerSingleton(Je.a,ai);var ri=s("sxU/"),oi=s("SZ0g");i.ModuleContainer.registerValue(oi.a,new class{constructor(){this._emitter=void 0,this._emitter=ri.a.instance}emit(e){return this._emitter.emit(e.topic,e),Promise.resolve()}on(e,t){return this._emitter.on(e,t),this}off(e,t){return this._emitter.off(e,t),this}});var li=s("ahRi");var ci=s("ptxg"),di=s("pUq9");let ui;ui=class{getOverrideDomain(e){}getDomainConfig(){return{}}setDomainConfig(e){return this}subscribe(e){return()=>{}}},Object(i.injectable)()(ui),Object(i.singleton)(ci.a)(ui);var hi,gi,mi=s("NDmK"),pi=s("qLo6"),fi=s("4prX");Object(Je.e)()(hi=class{onAuthenticated(e){mi.default.e2ee.enable_wasm&&pi.AesGcmWasmFactory.instance.installAndTestWasm().then((()=>{})).catch((e=>{}))}}),Object(Je.e)()(gi=class{onAuthenticated(e){try{WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))?fi.default.increaseSuccess(97135,0,0):fi.default.increaseFailed(97135,0,0,0,0)}catch{fi.default.increaseFailed(97135,0,0,1,0)}}});function vi(){const{ModalManagerV2:e}=s("h0sc"),{ModalIdentitiesDefine:t}=s("1pet");e.openModal({windowId:"1",name:t.VIDEO_CALL_SUGGEST,params:!0})}Object(gs.b)(gs.a.MakeCall,(function(e,t,s){vi()})),Object(gs.b)(gs.a.MakeVideoCall,(function(e,t,s){vi()})),Object(gs.b)(gs.a.MakeVoiceCall,(function(e,t,s){vi()}));var bi=s("FyUm");var Ii=s("WQAo");Object(gs.b)(gs.a.LoadMoreMessages,(function(e,t,s,i){const{chatID:n,windowID:a}=s;bi.default.GetManager().requestMessages(n,a,s,i)})),Object(gs.b)(gs.a.OpenChat,(function(e,t,s,n){if(null==s)return;const{chatID:a,source:r}=s;let o=null;switch(r){case Ii.a.MessageOnMessaging:o=Ii.c.fromMessageOnMessageing();break;case Ii.a.MessageMention:{const e=null;Ii.c.fromMessageMention(e);break}}i.ModuleContainer.resolve(Ii.b).openConversation(a,o).catch((e=>{}))})),Object(gs.b)(gs.a.ScrollToMessage,(function(e,t,i,n){var a;if(null==i)return;const{chatId:r,dispatch:o,handlers:{onError:l=(()=>{}),onFinally:c=(()=>{}),onSuccess:d=(()=>{})}={},message:u,options:h,tracking:g}=i,m=null===(a=s("4wTQ"))||void 0===a?void 0:a.default;m&&"function"==typeof m.jumpToMessage&&m.jumpToMessage(u,r,o,h).then(d).catch(l).finally(c)}));var yi=s("6ivO"),_i=s("XJ/a"),Ci=s("voUN");const Oi=new _i.a({context_menu:_i.b.field().schema({version:_i.b.field().number()})}),Ei=new class extends yi.ZFeatureConfig{constructor(){super({default:Ci.b,valiator:Oi})}selector(e){return e.ui_message||{}}getContextMenuConfig(){return this.config.context_menu}};var Mi=s("Xp+J");const Si={};function Ti(e){return Si[e]}Object(gs.b)(gs.a.CreateToDoTask,(function(e,t,i,n){var a,r;const{chatId:o,data:l,windowId:c}=i;if(!l)return;const d=l.message;if(!d)return;const u=s("BZLJ");if(!u||void 0===u.default)return;const{ModalManagerV2:h}=s("h0sc"),g=u.default,{TODO_DATE_TYPE:m,TODO_STATUS:p}=u;let f,v=null!==(a=l.selectedText)&&void 0!==a?a:"";f=v||g.getTodoContentFromAMsg(d);let b=l.assignees;(!b||b.length<=0)&&(b=[]);const I=null!==(r=null!=o?o:d.toUid)&&void 0!==r?r:"",y=I.startsWith(R.GROUPID_PREFIX);let _=I;y&&(_=I.slice(1));const C=rt.p.getSessionUserId(),O={creator:C,content:f,dueDate:-1,assignees:b,extra:{toUid:_,msgId:d.msgId,isGroup:y,cliMsgId:d.cliMsgId,msgType:d.msgType,mention:d.mentions||[],ownerMsgUId:"0"==d.fromUid?C:d.fromUid,message:d.message},dateDefaultType:m.NO_DATE,description:"",watchers:"[]",status:p.WAITING_FOR_RESPONSE};g.setCreateTodoSrc(l.trackingSource),h.openModal({windowId:c,name:R.ModalIdentitiesDefine.TODO_EDITOR,params:O})})),Object(gs.b)(gs.a.ShowMessageContextMenu,(function(e,t,i){const{context:n,oldData:a,data:r}=i||{};if(!1===Boolean(function(e){return null!=e&&void 0!==e.event&&null!==e.event&&void 0!==e.message&&null!==e.message&&void 0!==e.source&&null!==e.source}(n)))return;const o=function(e){if(!e)throw new Error("Window instance is invalid!");const t="?key=";let s="";const i=e.name;if(""===e.name)s="1";else{const e=i.indexOf(t);if(-1===e)s="1";else{const t=i.indexOf("&",e+1);s=-1!==t?i.substring(e+5,t):i.substring(e+5)}}return s}(n.event.view);!1===Boolean(Ei.getContextMenuConfig().version)&&"function"==typeof Ti(o)&&Ti(o)(n.event,onContextMenu,message,localPath,resendFunc,showInFolder,downloadFunc,onExtension,indexOAChild,folderPath);const{showContextMenu:l}=s("DOj/");if("function"==typeof l){let e=[];const t=Mi.a.get(r.UIMessageType);t&&(e=t(n,r.messageRef)),l(n,e)}}));var wi=s("WIhS");Object(gs.b)(gs.a.SaveToDevice,(function(e,t,i,n){const{message:a,selfWindow:r}=i||{},{isShowedProgress:o}=n||{};if(!a)return;const l=s("xHgQ").downloadWebV2ByMsg;Object(wi.a)(l)(null,r,a,Boolean(o))})),Object(gs.b)(gs.a.ShowInFolder,(()=>{}));var Ri=s("Vp9m"),Li=s("Py3H");function Di(e){let t=e;return t&&t.startsWith(R.GROUPID_PREFIX)&&(t=t.substring(1,t.length)),t}Object(gs.b)(gs.a.AddFriend,(function(e,t,s){if(null==s)return;const{userID:i,chatID:n,windowID:a}=s;if(!i)return;const r=()=>{const e=Di(n||"");Li.a.setFriendRequestSource(i,R.FRIEND_REQUEST_SRC_ECARD,{uidTo:e}),ss.ModalManagerV2.openModal({windowId:a||void 0,name:R.ModalIdentitiesDefine.ADD_FRIEND,params:i})};Li.a.getStatusFriendRequest(i).then((e=>{e.isRequested?Ri.default.show({textKey:"STR_PROFILE_FRIEND_REQ_SENT",noBackground:!0,type:Ri.TOAST_TYPE.INFO}):r()})).catch((()=>r()))}));var Ai=s("97kL"),Fi=s("Ydol"),ji=s("Xt6Q"),Pi=s("Z2tZ"),ki=s("Enw1"),Ni=s("JDlE"),Ui=s("EYv5");Object(gs.b)(gs.a.ManualDownloadMediaDoneHandler,(function(e,t,n,a){const{chatId:r,message:o,localPath:l,folderPath:c,isOpenedWhenCompleted:d=!0}=n;if(!r||!o)return;if(!l&&!c)return;if(ji.l)return;const u=o.msgId;if(d||Fi.default.send(Ai.FetchActions.DOWNLOAD_DONE,{msgId:u,localPath:l,folderPath:c}),ki.g.isSetSound(rt.p.getSessionUserId())&&Ni.a.playNoti(),i.ModuleContainer.resolve(Ui.a).updateFile(r,u,{localPath:l,folderPath:c},["localPath","folderPath"]),Fi.default.send(Ai.ChatBoxActions.FILEPATH_UPDATED,{msgId:u,localPath:l,folderPath:c}),Rt.default.updateMessage(u,{msgId:u,localPath:l,folderPath:c},["localPath","folderPath"],r),mi.default.recent_photo.enableFeature&&Object(ji.n)()){const e=s("z0WU").default,t=Date.now();Pi.a.setPhotoDownload({isLocalFile:!0,path:l,lastModified:t,name:$znode.path.basename(l||""),shortenPath:e.getShortenPath(l,40),fromSource:"DownloadedPhoto"})}if(!0===d){const e=s("Dprd").default;c?e.showInFolder(c):e.openItem(l)}})),Object(gs.b)(gs.a.OpenProfileModal,(function(e,t,s){if(null==s)return;const{userId:i,chatId:n,friendRequestSource:a,selectConversationSource:r,windowId:o}=s;if(null==i)return;let l=a;null==l&&(l=i.startsWith(R.GROUPID_PREFIX)?R.FRIEND_REQUEST_SRC_GROUP_CHAT:R.FRIEND_REQUEST_SRC_CHAT);const c=Di(n||"");let d;c&&(l===R.FRIEND_REQUEST_SRC_GROUP_CHAT?d={groupId:c}:l!==R.FRIEND_REQUEST_SRC_CHAT&&l!==R.FRIEND_REQUEST_SRC_ECARD||(d={toUid:c})),Li.a.setFriendRequestSource(i,l,d),null!=r&&rt.p.setSelectConversationSource(r),ss.ModalManagerV2.openModal({windowId:o||"1",name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:i})}));s("uAZB");var Bi=Object(i.define)("media-player-factory"),xi=s("ZsEe");var Gi=class{constructor(e){this._token=void 0,null!=e&&(this.token=e),this.token}static create(e){return new this(e)}isValidated(){return Boolean(this._token)}toString(){return void 0===this.token||null===this.token?"":String(this.token)}freeze(){return Object.freeze(this),this}get token(){return this._token}set token(e){this._token=e,this.freeze()}};let zi=function(e){return e.Audio="audio",e.Video="video",e}({});var Vi=class{constructor(e){if(e)try{Object.keys(e).forEach((t=>{t&&void 0===this[t]&&(this[t]=e[t])}))}catch(t){}}freeze(){return Object.freeze(this),this}};let Hi=function(e){return e[e.None=0]="None",e[e.Playing=1]="Playing",e[e.Paused=2]="Paused",e[e.Rewinding=3]="Rewinding",e[e.Stopped=4]="Stopped",e[e.Error=5]="Error",e}({});var Wi=class extends Vi{constructor(e){super(e),this.state=Hi.None,this.position=0,this.rate=1}};var $i=class{constructor(){this.builder=void 0,this.callerValidator=new WeakSet,this.playbackModel=new Wi,this.builder=new Proxy(this,{get:(e,t,s)=>Reflect.get(e,t,s)}),this.callerValidator.add(this.builder)}GetBuilder(){return this.builder}getState(){return this.playbackModel.state}getPosition(){return this.playbackModel.position}getRate(){return this.playbackModel.rate}isValidCaller(e){return this.callerValidator.has(e)}setState(e){this.playbackModel.state=e}setPosition(e){this.playbackModel.position=e}setRate(e){this.playbackModel.rate=e}};var Ki=class{constructor(e,t,s){this.token=e,this.mediaType=t,this.builtins=void 0,this.eventListeners=void 0,this.playback=void 0,this.source="",this.eventListeners=new Map,s&&this.setSource(s)}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]);const s=this.eventListeners.get(e);return s.push(t),this.eventListeners.set(e,s),()=>this.removeEventListener(e,t)}getDuration(){return this.isPrepared()&&this.builtins.duration||0}getPlaybackPosition(){return this.isPrepared()&&this.playback.getPosition()||0}getPlaybackState(){return this.isPrepared()?this.playback.getState()||Hi.None:0}getPlaybackRate(){return this.isPrepared()&&this.playback.getRate()||0}getRemainingTime(){return this.isPrepared()?this.getDuration()-this.getCurrentTime():0}getSource(){return this.source}getToken(){return this.token}pause(){this.isPrepared()&&(this.playback.setState(Hi.Paused),this.builtins.pause())}play(){return this.isPrepared()?(this.playback.setState(Hi.Playing),this.builtins.play()):Promise.reject()}prepare(){this.playback=new $i,this.mediaType===zi.Audio&&(this.builtins=new Audio,this.registerEventWhenReady(),this.updateBuiltins({src:this.getSource()}))}release(){delete this.builtins,this.builtins=void 0,this.playback=void 0}removeEventListener(e,t){const s=this.eventListeners.get(e);s&&this.eventListeners.set(e,s.filter((e=>e!==t)))}seekTo(e){this.setCurrentTime(e)}setSource(e){this.source=e,this.updateBuiltins({src:e})}stop(){this.isPrepared()&&(this.playback.setState(Hi.Stopped),this.builtins.pause(),this.setCurrentTime(0))}getCurrentTime(){var e;return(null===(e=this.builtins)||void 0===e?void 0:e.currentTime)||0}isPrepared(){return null!=this.builtins&&null!=this.playback}notifyEvent(e,t,...s){const i=this.eventListeners.get(e);i&&i.forEach((e=>{"function"==typeof e&&e(t,...s)}))}onEnded(){this.playback.setState(Hi.Stopped),this.setCurrentTime(0)}registerEventWhenReady(){this.isPrepared()&&(this.builtins.addEventListener("abort",(e=>{this.notifyEvent("onabort",e)})),this.builtins.addEventListener("canplay",(e=>{this.notifyEvent("canplay",e)})),this.builtins.addEventListener("durationchange",(e=>{this.notifyEvent("durationchange",e,this.getDuration())})),this.builtins.addEventListener("error",(e=>{this.notifyEvent("onerror",e)})),this.builtins.addEventListener("loadeddata",(e=>{this.notifyEvent("loadeddata",e)})),this.builtins.addEventListener("loadedmetadata",(e=>{this.notifyEvent("loadedmetadata",e)})),this.builtins.addEventListener("timeupdate",(e=>{const t=this.getCurrentTime();this.playback.setPosition(t),this.notifyEvent("timeupdate",e,{currentTime:t,remainingTime:this.getRemainingTime()})})),this.builtins.addEventListener("ended",(e=>{this.onEnded(),this.notifyEvent("ended",e)})))}setCurrentTime(e){this.playback.setPosition(e),this.updateBuiltins({currentTime:e})}updateBuiltins(e){if(!this.builtins)return;Object.keys(e).forEach((t=>{this.builtins[t]=e[t]}))}};var qi=class{constructor(){this.IDGenerator=new xi.a,this.instanceMap=new Map}createAudioPlayer(e){return this.createMediaPlayer(zi.Audio,e)}createMediaPlayer(e,t){const s=Gi.create(this.generateTokenID()),i=new Ki(s,e,t);return this.registerInstance(s,i),i}createVideoPlayer(e){return this.createMediaPlayer(zi.Video,e)}deleteMediaPlayer(e){this.unregisterInstance(e)}generateTokenID(){return"PL_"+this.IDGenerator.next()}registerInstance(e,t){this.instanceMap.set(e.toString(),t)}unregisterInstance(e){this.instanceMap.delete(e.toString())}};i.ModuleContainer.registerSingleton(Bi,qi);s("FCbV");var Qi=Object(i.define)("audio-manager");var Zi=Object(i.define)("audio-resource-manager"),Ji=Zi;var Yi,Xi=class{constructor(e){this.audioResourceManager=e}get AudioResourceManager(){return this.audioResourceManager}};var en=Object(i.injectable)()(Yi=function(e,t){return Object(i.inject)(Ji)(e,void 0,0)}(Yi=Reflect.metadata("design:type",Function)(Yi=Reflect.metadata("design:paramtypes",[Object])(Yi=class extends Xi{constructor(e){super(e)}async loadResourceFromMessage(e,t){if(!e)return Promise.reject("Invalid required params: message");try{const t=await this.AudioResourceManager.loadResourceFromMessage(e),s=t.data,i=t.extra;let n="playable";return i.isExpired?n="expired":i.isAvailable||(n="not-supported"),{localURL:"",URL:s.URL||"",status:n}}catch(s){return{localURL:"",URL:"",error:s,status:"failure"}}}async reloadResourceFromMessage(e,t){try{const t=await this.AudioResourceManager.reloadResourceFromMessage(e);return{localURL:"",URL:(null==t?void 0:t.data).URL,status:"playable"}}catch(s){return Promise.reject({localURL:"",URL:"",status:"playable"})}}})||Yi)||Yi)||Yi)||Yi;i.ModuleContainer.register(Qi,en);var tn=Object(i.define)("audio-resource-loader");var sn=class{};i.ModuleContainer.register(tn,sn);var nn=Object(i.define)("audio-resource-status"),an=s("q63S"),rn=s("w1k3");var on=class{async checkMediaStatus(e,t=[],s=!1,i=!0){try{let{status:t}=await Object(rn.a)(e);return{isExpired:"none"===t,autoDownloadPath:Object(an.b)(e)}}catch(n){return Promise.reject(n)}}};i.ModuleContainer.register(nn,on);var ln=s("KweF"),cn=s("A9FD"),dn=s("QZAi");function un(e,t){const s={status:dn.a.SUCCESS,data:e,extra:t};return void 0===t&&delete s.extra,s}var hn=s("/jDQ");var gn,mn=class{constructor(e,t){this.audioResourceLoader=e,this.audioResourceStatus=t,this.resourceCheckerResultCache=new Map}get AudioResourceLoader(){return this.audioResourceLoader}get AudioResourceStatus(){return this.audioResourceStatus}getCheckerResultCache(){return this.resourceCheckerResultCache}hasIn(e,t){return e.has(t)}},pn=tn,fn=nn,vn=s("Iy59");var bn=Object(i.injectable)()(gn=function(e,t){return Object(i.inject)(pn)(e,void 0,0)}(gn=function(e,t){return Object(i.inject)(fn)(e,void 0,1)}(gn=Reflect.metadata("design:type",Function)(gn=Reflect.metadata("design:paramtypes",[Object,Object])(gn=class extends mn{constructor(e,t){super(e,t)}async checkMediaStatusFromMessage(e,t,s,i){try{const n=Object(f.a)({},e);return un(await this.AudioResourceStatus.checkMediaStatus(n,t,s,i))}catch(n){return function(e,t,s,i){const n={status:dn.a.ERROR,data:{code:e,message:t||"",error:s},extra:i};return void 0===n.extra&&delete n.extra,n}(-1,"",n)}}async loadResourceFromMessage(e,t={enableAutoDownload:!0}){if(!e)return Promise.reject("Invalid required params: message");const s=this.getSourceFromMessage(e);let i=!1;try{const t=Object(f.a)(Object(f.a)({},e),{},{conversationId:e.toUid}),s=(await this.checkMediaStatusFromMessage(t,["expired"],!0)).data;let{flag:n}=Object(rn.b)(t);null==s||!s.isExpired||n&vn.d.clouded||(i=!0)}catch(n){}return un({localURL:"",URL:s},{isExpired:i,isAvailable:Boolean(s)})}async reloadResourceFromMessage(e,t){try{const t=Object(ln.j)(),s=this.getSourceFromMessage(e);let i=await Object(ln.h)(String(t),s,ln.a.manual,void 0,void 0,e);if(i&&i.data)return un({localURL:"",URL:i.data});if(i&&i.error)return un({localURL:"",URL:""})}catch(s){return un({localURL:"",URL:""})}}getSourceFromMessage(e){const t=e.message.href;let s=t;if(-1!==t.indexOf(cn.i.E2EE_SESSION))try{let t=e.message.params;"string"==typeof t&&(t=JSON.parse(t)),t.m4a||(s="")}catch(i){s=""}else Object(hn.a)(s)||(s=[mi.default.voice.voiceUrl,"/mp3?url=",encodeURIComponent(e.message.href),"&msgid=",e.msgId].filter(Boolean).join(""));return s}})||gn)||gn)||gn)||gn)||gn;i.ModuleContainer.register(Zi,bn);var In=s("J25b"),yn=s("bUXd");i.ModuleContainer.registerSingleton(In.b,class{getHourNow(){return new Date(yn.default.getTimeNow()).getHours()}getTimeNow(){return yn.default.getTimeNow()}getSystemTimeNow(){return yn.default.getSystemTimeNow()}});class _n{static getInstance(){return void 0===_n._instance&&(_n._instance=new _n),_n._instance}constructor(){if(this.menuConditionCheckers=new Map,this.menuCommandHandlers=new Map,_n._instance)throw new Error("Singleton classes can't be instantiated more than once.");return _n._instance=this,_n._instance}getConditionChecker(e){return this._getConditionalChecker(e)}getCommandHandler(e){return this._getCommandHandler(e)}registerCondition(e,t){this._hasConditionalChecker(e),this._setConditionalChecker(e,t)}registerCommand(e,t){this._setCommandHandler(e,t)}_hasConditionalChecker(e){return this.menuConditionCheckers.has(e)}_getConditionalChecker(e){return this.menuConditionCheckers.get(e)}_getCommandHandler(e){return this.menuCommandHandlers.get(e)}_setConditionalChecker(e,t){this.menuConditionCheckers.set(e,t)}_setCommandHandler(e,t){this.menuCommandHandlers.set(e,t)}}_n._instance=void 0;_n.getInstance();var Cn=s("NFKh"),On=s.n(Cn);const En=[203,74,172,242,223,61,219,195,156,131,108,139,128,115,1,33];var Mn,Sn=new class{constructor(){this.key=void 0,this.iv=void 0,this.key=On.a.enc.Utf8.parse("afe75eea0d3c4bd9a65439a54eabc988"),this.iv=On.a.lib.WordArray.create(En)}encryptString(e){return On.a.AES.encrypt(e,this.key,{iv:this.iv,mode:On.a.mode.CBC}).ciphertext.toString(On.a.enc.Base64)}decryptString(e){return On.a.AES.decrypt(e,this.key,{iv:this.iv,mode:On.a.mode.CBC}).toString(On.a.enc.Utf8)}isEncryptionAvailable(){return!0}},Tn=s("d/8x");const wn=["encryptString","decryptString","get","set"];Object(i.singleton)(Tn.a)(Mn=Reflect.metadata("design:type",Function)(Mn=Reflect.metadata("design:paramtypes",[])(Mn=class{constructor(){this.store=void 0,this.store=E.default.getInstance()}async encryptString(e){return this.secure.encryptString(e)}async decryptString(e){return this.secure.decryptString(e)}async get(e){const t=this.genKeyPath(e),s=this.store.getItem(t);return s&&"string"==typeof s?this.decryptString(s):null}async set(e,t){const s=this.genKeyPath(e),i=await this.encryptString(t);this.store.setItem(s,i)}execute(e,...t){if(wn.includes(e))return this[e](...t);throw new Error("Run invalid method: "+e)}get secure(){return Sn}genKeyPath(e){if(e.includes("."))throw new Error("Key contains '.' char is not allow in zsafe-storage");return`zsskd.${e}`}})||Mn)||Mn);const Rn=Object(i.define)("tensor-flow-lib");var Ln=s("Pswx"),Dn=s("c7gn"),An=(s("1JlB"),s("CtZu")),Fn=(s("PG0B"),s("+kvV")),jn=s("csRb"),Pn=s("+gpH"),kn=s("lzW/"),Nn=s("fn98"),Un=s("XTCE"),Bn=s("9q62"),xn=s("pGgd"),Gn=s("ThxY"),zn=s("UvZ8"),Vn=s("DJOk"),Hn=s("aea1"),Wn=s("2Gmx"),$n=s("HdJO"),Kn=s("eejg"),qn=s("N7VH"),Qn=s("i+Li"),Zn=s("egdQ"),Jn=s("Sm5c");Object(Dn.d)(Fn.a),Object(Dn.d)(jn.a),Object(Dn.d)(Pn.b),Object(Dn.d)(kn.a),Object(Dn.d)(Nn.a),Object(Dn.d)(Un.a),Object(Dn.d)(Bn.a),Object(Dn.d)(xn.a),Object(Dn.d)(Gn.a),Object(Dn.d)(zn.a),Object(Dn.d)(Vn.a),Object(Dn.d)(Hn.a),Object(Dn.d)(Wn.b),Object(Dn.d)($n.b),Object(Dn.d)(Kn.a),Object(Dn.d)(qn.a),Object(Dn.d)(Qn.a),Object(Dn.d)(Zn.b),Object(Dn.d)(Jn.a);i.ModuleContainer.registerSingleton(Rn,class{tensor(e,t,s){return Object(Ln.U)(e,t,s)}ones(e,t){return Object(Ln.M)(e,t)}loadGraphModel(e,t,s){return Object(An.a)(e,t,s)}io_browserFiles(e){return Ln.J.browserFiles(e)}profile(e){return Object(Ln.N)(e)}});var Yn=s("MRjZ");class Xn{constructor(){this.userId=null}init(e){this.userId=e}getUserId(){if(null===this.userId)throw new Error("Resource hasn't been initialized yet!");return this.userId}}class ea extends Xn{}const ta=Object(i.define)("ss-sticker-2-click-resource");var sa,ia=s("TISA");let na=Object(i.injectable)()(sa=Object(Je.g)()(sa=function(e,t){return Object(i.inject)(In.b)(e,void 0,0)}(sa=Reflect.metadata("design:type",Function)(sa=Reflect.metadata("design:paramtypes",[void 0===In.ISystemTime?Object:In.ISystemTime])(sa=class extends ea{constructor(e){super(),this.zSystemTime=e,this.timerId=null,this.logger=void 0,this.cachedUsage={};const t=i.ModuleContainer.resolve(Me.ZLoggerFactory);this.logger=t.createZLogger("e2ee-sticker-suggestion",["sticker-2-click"])}scheduleFlushTimeoutIfNeeded(){if(null!==this.timerId)return;this.timerId=setTimeout((async()=>{await this.flushData(),this.timerId=null}),3e4)}async get(e){const t=tt.default.getInstance(),s=this.getTodayDateObj(),i={from:this.getDateBeforeNDays(e).getTime(),to:s.getTime(),excludeFrom:!0},n=await t.Core.StickerUsage.getAll(i);if(0===n.length)return null;const a={};return n.forEach((({data:e})=>{for(const[t,s]of Object.entries(e))void 0===a[t]&&(a[t]=0),a[t]+=s})),a}async set(e){const t=tt.default.getInstance(),s=this.getTodayDateObj().getTime();await t.Core.StickerUsage.insert({dttm:s,data:e},{replace:!0})}async recordClickCount(e){const t=this.getTodayDateObj().getTime(),s=await this.getCurrentUsageOfSticker(t,e)+1;this.updateUsageOfSticker(t,e,s),this.scheduleFlushTimeoutIfNeeded()}async clearUnusedData(e){const t={to:this.getDateBeforeNDays(e).getTime()},s=tt.default.getInstance(),i=await s.Core.StickerUsage.findAndDelete(t);this.logger.zsymb(3,"EokwIy",["Unused data cleared: {}","7oTdbq"],i.length)}getDateBeforeNDays(e){const t=this.getTodayDateObj(),s=new Date(t);return s.setDate(t.getDate()-e),s}async initStickerUsageIfNeeded(e){if(void 0===this.cachedUsage[e]){const t=tt.default.getInstance(),s=await t.Core.StickerUsage.get(e);this.cachedUsage[e]=void 0!==s?s:{dttm:e,data:{}}}}async getCurrentUsageOfSticker(e,t){return await this.initStickerUsageIfNeeded(e),this.cachedUsage[e].data[t]||0}async updateUsageOfSticker(e,t,s){return await this.initStickerUsageIfNeeded(e),this.cachedUsage[e].data[t]=s}getAllUsageBeingTracking(){return this.cachedUsage}removeUsageOfGivenDateFromCache(e){delete this.cachedUsage[e]}async flushData(){try{const e=this.getAllUsageBeingTracking(),t=Object.values(e),s=t.length,i=tt.default.getInstance();if(await i.Core.StickerUsage.insertMulti(t,{replace:!0}),s>1){const e=this.getTodayDateObj().getTime(),s=[];t.forEach((({dttm:t})=>{t!==e&&s.push(t)}));for(const t of s)this.removeUsageOfGivenDateFromCache(t)}0}catch(e){0}}onDispose(){null!==this.timerId&&(clearTimeout(this.timerId),this.flushData())}getTodayDateObj(){const e=this.zSystemTime.getTimeNow(),t=new Date(e);return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t}})||sa)||sa)||sa)||sa)||sa;i.ModuleContainer.registerSingleton(ta,na);const aa=Object(i.define)("ss-sticker-2-score-resource"),ra="ss_stk2sc";i.ModuleContainer.registerSingleton(aa,class extends Xn{async get(){const e=E.default.getInstance();try{return await e.getObjectForCurrentUserAsync(ra)}catch(t){throw new Error("Failed to parse sticker2Score data")}}async set(e){const t=E.default.getInstance();await t.setObjectForCurrentUserAsync(ra,e)}});class oa extends Xn{formatData(e){return{modelName:void 0!==e.modelName?e.modelName:"mf_sticker_v3",numItems:Math.max(void 0!==e.numItems?e.numItems:6306,0),numLatentFactor:Math.max(void 0!==e.numLatentFactor?e.numLatentFactor:32,0),minItemReconstruction:Math.max(void 0!==e.minItemReconstruction?e.minItemReconstruction:5,0),minItemTraining:Math.max(void 0!==e.minItemTraining?e.minItemTraining:10,0),numReconstructionRound:Math.max(void 0!==e.numReconstructionRound?e.numReconstructionRound:3,0),numReconstructionRoundWhenTraining:Math.max(void 0!==e.numReconstructionRoundWhenTraining?e.numReconstructionRoundWhenTraining:3,0),numTrainingRound:Math.max(void 0!==e.numTrainingRound?e.numTrainingRound:3,0),batchSize:Math.max(void 0!==e.batchSize?e.batchSize:256,0),reconDataRatio:Math.max(void 0!==e.reconDataRatio?e.reconDataRatio:.5,0),numNegativePerEachPositive:Math.max(void 0!==e.numNegativePerEachPositive?e.numNegativePerEachPositive:50,0),stickerUsageMaxValue:Math.max(void 0!==e.stickerUsageMaxValue?e.stickerUsageMaxValue:100,0),splitDatasetWhenTraining:void 0!==e.splitDatasetWhenTraining&&e.splitDatasetWhenTraining}}}const la=Object(i.define)("ss-config-resource"),ca="ss-confg";i.ModuleContainer.registerSingleton(la,class extends oa{async get(){const e=E.default.getInstance();try{return await e.getObjectAsync(ca)}catch(t){throw new Error("Failed to parse SSConfig data")}}async set(e){const t=this.formatData(e),s=E.default.getInstance();await s.setObjectAsync(ca,t)}});const da=Object(i.define)("ss-item-2-sticker-resource"),ua="ss_itm2stk";i.ModuleContainer.registerSingleton(da,class extends Xn{constructor(...e){super(...e),this.cacheItem2Sticker=null}async get(){if(null!==this.cacheItem2Sticker)return this.cacheItem2Sticker;const e=E.default.getInstance();try{const t=await e.getObjectAsync(ua);return null!==t&&(this.cacheItem2Sticker=t),t}catch(t){throw new Error("Failed to parse ssItem2Sticker data")}}async set(e){this.cacheItem2Sticker=e;const t=E.default.getInstance();await t.setObjectAsync(ua,e)}});var ha=s("xE0C");const ga="ss_kwd2stk";i.ModuleContainer.registerSingleton(ha.b,class extends Xn{async get(){const e=E.default.getInstance();try{return await e.getObjectAsync(ga)}catch(t){throw new Error("Failed to parse Kwd2Sticker data")}}async set(e){const t=E.default.getInstance();await t.setObjectAsync(ga,e)}});const ma="tf_ss";class pa extends Xn{}const fa=Object(i.define)("ss-model-resource");i.ModuleContainer.registerSingleton(fa,class extends pa{constructor(...e){super(...e),this.url=null}async get(){const e=this.getURL();return{loadURL:e,saveURL:e}}set(e){throw new Error("Method not implemented.")}getURL(){if(null===this.url){const e=[ma,this.getUserId()].join("_");this.url=`indexeddb://${e}`}return this.url}async saveData(e){const t=i.ModuleContainer.resolve(Rn),s=e.map((({name:e,data:t})=>new File([t],e,{type:e.endsWith(".json")?"application/json":"application/octet-stream"})));let n=null;try{n=await t.loadGraphModel(t.io_browserFiles(s));const e=this.getURL();await n.save(e)}catch(r){throw r}finally{var a;null===(a=n)||void 0===a||a.dispose()}}});class va{constructor(){this.model=i.ModuleContainer.resolve(fa),this.config=i.ModuleContainer.resolve(la),this.item2Sticker=i.ModuleContainer.resolve(da),this.kwd2Stickers=i.ModuleContainer.resolve(ha.b),this.sticker2Click=i.ModuleContainer.resolve(ta),this.sticker2Score=i.ModuleContainer.resolve(aa)}}const ba=Object(i.define)("ss-resource-manager");let Ia;i.ModuleContainer.registerSingleton(ba,class extends va{init(e){this.model.init(e),this.config.init(e),this.item2Sticker.init(e),this.kwd2Stickers.init(e),this.sticker2Click.init(e),this.sticker2Score.init(e)}}),(Ia||(Ia={})).isUnavailableIDBModelResourceDataError=function(e){if(!(e instanceof Error))return!1;const{message:t}=e;return t.includes("Cannot find model with path")};let ya=function(e){return e.UnavailableModelResourceData="unavailable-model-resource-data",e.DoneReconstruct="done-reconstruct",e}({});class _a extends Fe.a{constructor(e){super(ya.UnavailableModelResourceData),this.url=e}}class Ca extends Fe.a{constructor(e){super(ya.DoneReconstruct),this.data=e}}function Oa(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}var Ea=s("X61T");class Ma{constructor(e,t){this.kwd2Stickers=e,this.sticker2Item=t,this.sameKWMap=function(e,t){const s={},{index:i,map:n}=e;for(const a of Object.values(n)){const e=new Set;for(const s of a){const n=i[s];if(Object(Ea.a)(n)){const{content:i}=n,{sticker_id:a}=i;void 0!==t[a]&&e.add(s)}}e.forEach((t=>{void 0===s[t]?s[t]=e:s[t]=Sa(s[t],e),void 0!==s[t]&&s[t].delete(t)}))}return s}(this.kwd2Stickers,this.sticker2Item)}sampleNegativeIndices(e,t,s){const i=new Set,n={};for(const[l,c]of Object.entries(e)){const e=t[l];void 0!==e&&(i.add(e),n[e]=c)}const a=Object.values(t),r=new Set;a.forEach((e=>{i.has(e)||r.add(e)}));let o=new Set;for(const l of Object.keys(n)){const e=this.sameKWMap[+l]||new Set;if(0===e.size){o=Sa(o,wa(r,s))}else{const t=new Set;for(const s of Object.keys(n))e.has(+s)||t.add(+s);if(t.size>=s){o=Sa(o,wa(t,s))}else{o=Sa(o,t);const e=s-t.size;o=Sa(o,wa(r,e))}if(o.size===r.size)break}}return o}}function Sa(e,t){const s=new Set(e.values());return t.forEach((t=>{e.has(t)||s.add(t)})),s}const Ta=1e3;function wa(e,t){if(0===e.size)return new Set;const s=Array.from(e.values());if(t>=e.size)return new Set(Oa(s));if(t>=Ta)return new Set(Oa(s).slice(0,t));let i=0;const n=new Set,a=new Ra(s);for(;i<t;){const e=a.getRandomItem();n.add(e),i+=1}return n}class Ra{constructor(e){this.items=void 0,this.items=[...e]}getRandomItem(){if(0===this.items.length)return;const e=Math.floor(Math.random()*this.items.length),t=this.items[this.items.length-1];return this.items[e]=t,this.items.pop()}}const La=[1,32];let Da=function(e){return e[e.DEFAULT=0]="DEFAULT",e[e.NON_DEFAULT=1]="NON_DEFAULT",e}({});class Aa{constructor(e,t,s){this.type=e,this.shape=t,this.values=s}}class Fa extends Aa{constructor(e){super(Da.DEFAULT,e,new Float32Array)}createTensor(e){return e.ones(this.shape)}}class ja extends Aa{constructor(e,t){super(Da.DEFAULT,e,t)}createTensor(e){return e.tensor(this.values,this.shape,"float32")}}class Pa{constructor(){this.shape=La}static getInstance(){return null===this.instance&&(this.instance=new Pa),this.instance}setShape(e){this.shape=[1,e]}createDefaultUserEmbedding(){return new Fa(this.shape)}createNonDefaultUserEmbedding(e){return new ja(this.shape,e)}}Pa.instance=null;class ka extends Fe.b{constructor(...e){super(...e),this.tfLib=i.ModuleContainer.resolve(Rn),this.resourceManager=i.ModuleContainer.resolve(ba),this.negativeSampler=null,this.userEmbeddingFactory=Pa.getInstance()}async reconstruct(e){const t=await this.getNegativeSampler(),s=await this.getSSConfig(),i=await this.getStickerToItem(),n=t.sampleNegativeIndices(e,i,s.numNegativePerEachPositive),a={};for(const[y,_]of Object.entries(e)){const e=i[y];void 0!==e&&(a[e]=Math.min(_,s.stickerUsageMaxValue))}n.forEach((e=>{a[e]=0}));const r=function(e,t){let s=[];for(const[r,o]of Object.entries(e))s.push([+r,o]);s=Oa(s);const i=[];let n=0,a=Math.max(t,1);for(;n<s.length;){const e=s.slice(n,Math.min(n+a,s.length));i.push(e),n+=a}return i}(a,s.batchSize);this.userEmbeddingFactory.setShape(s.numLatentFactor);const o=this.userEmbeddingFactory.createDefaultUserEmbedding();let l=0,c=0,d=0,u=this.userEmbeddingFactory.createDefaultUserEmbedding();for(;d<s.numReconstructionRound;){for(const e of r){const t=await this.runOneStepReconstruct(e,o);u=t.userEmbedding,l+=t.loss,c+=1}d+=1}const h=Object.values(i).length,g=await this.predict(u,h);0===c&&(c=1);const m=Object.entries(g).sort(((e,t)=>t[1]-e[1])).map((([e])=>e)),p=Object.keys(i),f=new Set(m.slice(0,Math.min(m.length,50))),v=[];p.forEach((e=>{f.has(e)&&v.push(e)}));const b=0===p.length?0:1*v.length/p.length,I={loss:l/c,precision50:0===f.size?0:1*v.length/f.size,recall50:b,scores:g,reconsCount:Object.keys(e).length};return this.dispatchEvent(new Ca(I)),I}async getTFModelInstance(){let e="";try{e=await this.getModelLoadURL();return await this.tfLib.loadGraphModel(e)}catch(t){throw Ia.isUnavailableIDBModelResourceDataError(t)&&this.dispatchEvent(new _a(e)),t}}async predict(e,t){const s=new Int32Array(t).fill(0),i=new Int32Array(t).fill(0);let n=0;for(;n<t;)s[n]=n,i[n]=0,n+=1;let a=null,r=null,o=null,l=null,c=null,d=null;try{a=this.tfLib.tensor(s,void 0,"int32"),r=this.tfLib.tensor(s,void 0,"int32"),o=e.createTensor(this.tfLib),l=await this.getTFModelInstance(),c=l.predict({stickers:a,clicks:r,user_embedding:o}),d=await c[1].data()}catch(I){throw I}finally{var u,h,g,m,p;null===(u=a)||void 0===u||u.dispose(),null===(h=r)||void 0===h||h.dispose(),null===(g=o)||void 0===g||g.dispose(),null===(m=l)||void 0===m||m.dispose(),null===(p=c)||void 0===p||p.forEach((e=>e.dispose()))}const f=Math.min(d.length,t),v=await this.getItem2Sticker(),b={};for(n=0;n<f;){const e=v[n];void 0!==e&&(b[e]=d[n]),n+=1}return b}async runOneStepReconstruct(e,t){const s=e.length,i=new Int32Array(s).fill(0),n=new Int32Array(s).fill(0);let a=0;for(;a<s;){const t=e[a];[i[a],n[a]]=t,a+=1}let r=null,o=null,l=null,c=null;try{r=this.tfLib.tensor(i,void 0,"int32"),o=this.tfLib.tensor(n,void 0,"int32"),l=t.createTensor(this.tfLib),c=await this.getTFModelInstance();const e=c.predict({stickers:r,clicks:o,user_embedding:l}),s=await Promise.all(e.map((e=>e.data()))),a=s[0][0],d=s[1],u=s[2];return{loss:a,scores:d,userEmbedding:this.userEmbeddingFactory.createNonDefaultUserEmbedding(u)}}catch(m){throw m}finally{var d,u,h,g;null===(d=r)||void 0===d||d.dispose(),null===(u=o)||void 0===u||u.dispose(),null===(h=l)||void 0===h||h.dispose(),null===(g=c)||void 0===g||g.dispose()}}async getModelLoadURL(){const e=await this.resourceManager.model.get();if(null===e)throw new Error("No 'model_url' data is available!");return e.loadURL}async getModelSaveURL(){const e=await this.resourceManager.model.get();if(null===e)throw new Error("No 'model_url' data is available!");return e.saveURL}async getItem2Sticker(){const e=await this.resourceManager.item2Sticker.get();if(null===e)throw new Error("No 'item2Sticker' data is available!");return e}async getStickerToItem(){const e=await this.getItem2Sticker(),t={};for(const[s,i]of Object.entries(e))t[i]=+s;return t}async getKwd2Sticker(){const e=await this.resourceManager.kwd2Stickers.get();if(null===e)throw new Error("No 'kwd2Sticker' data is available!");return e}async getSSConfig(){const e=await this.resourceManager.config.get();if(null===e)throw new Error("No 'ss-config' data is available!");return e}async getNegativeSampler(){if(null===this.negativeSampler){const e=await this.getKwd2Sticker(),t=await this.getStickerToItem();this.negativeSampler=new Ma(e,t)}return this.negativeSampler}}const Na=Object(i.define)("tf-model/sticker-suggestion");i.ModuleContainer.registerSingleton(Na,class extends ka{});var Ua=s("7rAU");let Ba;var xa;let Ga;var za;(xa=Ba||(Ba={})).getMetadataExpireDurationInMsFromRawExpireTime=function(e){return 1e3*e},xa.getReconstructExpireDurationInMsFromRawReconstructInterval=function(e){return 24*e*60*60*1e3},(za=Ga||(Ga={})).parseKwd2StickersResponse=function(e){const{index:t,map:s}=e;if(void 0===t)throw new Error("Missing 'index' field in kwd2Sticker response");if(void 0===s)throw new Error("Missing 'map' field in kwd2Sticker response");return{index:t,map:s}},za.parseSupportedItemsData=function(e){const t={};for(let s=0;s<e.length;s+=1){const[i,n]=e[s];t[s]=n}return t};var Va=s("T+bx");function Ha(e){const t=new Va.a(Va.b);let s=!1;function i(){s=!1,n()}function n(){const n=t.dequeue();null!==n&&function(t){s=!0;const{args:n,deferrer:a}=t;e(...n).then(a.resolve).catch(a.reject).finally(i)}(n)}return(...e)=>new Promise(((i,a)=>{var r;r={args:e,deferrer:{resolve:i,reject:a}},t.append(r),1===t.size&&(s||n())}))}var Wa=s("rdC+"),$a=s("bJrp");Fe.a;var Ka=s("a3bM");const qa=()=>{const e=E.default.getInstance(),t=e.getItemForCurrentUser(Ua.j);if(null===t)return null;let s=null;try{s=JSON.parse(t),"number"==typeof s&&(e.removeItemForCurrentUser(Ua.j),s=null)}catch(i){}return s},Qa=e=>{E.default.getInstance().setItemForCurrentUser(Ua.j,JSON.stringify(e))},Za=()=>{const e=E.default.getInstance(),t=e.getItemForCurrentUser(Ua.m);if(null===t)return null;let s=null;try{s=JSON.parse(t),"number"==typeof s&&(e.removeItemForCurrentUser(Ua.m),s=null)}catch(i){}return s},Ja=e=>{E.default.getInstance().setItemForCurrentUser(Ua.m,JSON.stringify(e))},Ya=()=>{const e=E.default.getInstance().getItemForCurrentUser(Ua.o);if(null===e)return null;let t=null;try{t=JSON.parse(e)}catch(s){}return t},Xa=e=>{E.default.getInstance().setItemForCurrentUser(Ua.o,JSON.stringify(e))};var er=s("bBj6"),tr=s("/bDn");class sr{static getInstance(){return null===this.instance&&(this.instance=new sr),this.instance}constructor(){this.data=null,this.loadDataContainer=null,this.logger=void 0;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory);this.logger=e.createZLogger("e2ee-sticker-suggestion",["kwd-2-last-clicked-sticker"])}async loadData(){if(null!==this.loadDataContainer)return this.loadDataContainer.promise;this.loadDataContainer=new Be.c.Container;try{const t=E.default.getInstance(),s=await t.getItemForCurrentUserAsync(Ua.b);let i={};if(null!==s)try{i=JSON.parse(s)}catch(e){this.logger.zsymb(18,"hjyS-R",`Failed to parse kwd2LastClickedSticker data: ${e}`)}this.data=i,this.loadDataContainer.resolve()}catch(e){this.logger.zsymb(18,"CyJ4p4",`Failed to load kwd2LastClickedSticker data: ${e}`),this.loadDataContainer.reject(e),this.loadDataContainer=null}}async getLastClickedSticker(e){return null===this.data&&await this.loadData(),this.data[e]||null}async setLastClickedSticker(e,t){null===this.data&&await this.loadData();const s=this.data[e];if(void 0===s||s.sticker_id!==t.sticker_id){this.data[e]=t;const s=E.default.getInstance(),i=JSON.stringify(this.data);await s.setItemForCurrentUserAsync(Ua.b,i)}}}sr.instance=null;class ir extends Fe.b{constructor(){super(),this.resourceManager=i.ModuleContainer.resolve(ba),this.cachedResourceStatus=null,this.tfModel=i.ModuleContainer.resolve(Na),this.kwd2Sticker=null,this.sticker2Score=null,this.ssResourceConfig=null,this.metadata=null,this.kwd2LastClickedStickerResource=sr.getInstance(),this.metadataExpireHandler=null,this.reconstructionExpireHandler=null,this.updateResourceIfNeededContainer=null,this.didStartup=!1,this.qos=null,this.logger=void 0,this.removeListeners=()=>{},this.didScheduleStickerUsageCleanup=!1,this.partialKwd2Sticker={map:{},index:{}},this.disposeKwd2StickersCacheTimer=null;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory);this.logger=e.createZLogger("e2ee-sticker-suggestion",["module"]),this.runReconstructionIfNeeded=Ha(this.runReconstructionIfNeeded.bind(this)),this.registerListeners();i.ModuleContainer.resolve(Je.a).addEventListener(Je.b.Exit,(()=>{this.removeListeners()}))}registerListeners(){const e=[];e.push(this.tfModel.addEventListener(ya.UnavailableModelResourceData,(()=>{this.reset()}))),e.push(this.tfModel.addEventListener(ya.DoneReconstruct,(async e=>{const t=$a.a.getInstance();await t.onDoneReconstruct(e.data)})));const t=i.ModuleContainer.resolve(Re.TDBCorruptionDetector);e.push(t.addEventListener(Ae.a.DB_CORRUPTION_DETECTED,(e=>{const{corruptionInfo:t}=e,{databaseCorruptInfo:s}=t,{database:i}=s;i===Wa.a.baseConfig.name&&this.reset()}))),this.removeListeners=()=>{e.forEach((e=>e()))}}async recordSuggestion(e,t){try{const s=this.getKeywordVariantsToProcess(e),i=await Promise.allSettled(s.map((e=>{this.kwd2LastClickedStickerResource.setLastClickedSticker(e,t)})));for(const e of i)if("rejected"===e.status)throw e.reason}catch(s){0,this.logQosError(Ua.i.RECORD_SUGGESTION_FAILED,s)}}async recordUsage(e){try{await this.resourceManager.sticker2Click.recordClickCount(e)}catch(t){0,this.logQosError(Ua.i.RECORD_USAGE_FAILED,t)}}init(e){try{this.resourceManager.init(e);const t=()=>{const e=this.getSSMetadata();if(null===e)throw new Error("Unavailable model version");return e.sort_sticker_model.version},s=$a.a.getInstance();s.registerGetModelVersionFn(t),s.ready()}catch(t){this.logger.zsymb(18,"Et3rE2",`[init] Failed: ${t}`),this.logQosError(Ua.i.INIT_FAILED,t)}}getKeywordVariantsToProcess(e){const t=er.a.prepare(e);return[t,er.a.stripVnmeseDiacritics(t)]}scheduleStickerUsageCleanUp(){if(this.didScheduleStickerUsageCleanup)return;this.didScheduleStickerUsageCleanup=!0;const e=new tr.a(Ya,Xa,Be.j.timeInMs("1D"));e.onExpired((()=>{try{this.resourceManager.sticker2Click.clearUnusedData(Ua.d)}catch(e){this.logger.zsymb(21,"t1SCle",["Sticker usage clean up error: {}","WXbVZt"],Object(Yn.c)(e))}})),e.start()}reset(){try{this.setSSMetadata(null),this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded(!0)}catch(e){this.logger.zsymb(18,"FjFhCg",`[reset] Failed: ${e}`),this.logQosError(Ua.i.RESET_FAILED,e)}}get enableFeature(){return!!Ka.a.nestedKey("metadata.sort_sticker_model.enable_feature")}getPriorityLastClick(){return!!Ka.a.key("priority_last_click").number}async predict(e){try{0;let t=null;this.getPriorityLastClick()&&(t=await this.kwd2LastClickedStickerResource.getLastClickedSticker(e));const s=await this.getSticker2Score(),i=null!==t;let n=[];const a=this.getKeywordVariantsToProcess(e);for(const e of a)if(n=await this.getStickerArtifactsMatchingKwd(e,(e=>{const{content:s}=e;if(i){return!(s.sticker_id===t.sticker_id)}return!0})),0!==n.length)break;if(0===n.length)return[];n=n.sort((({sticker_id:e},{sticker_id:t})=>s[t]-s[e]));return[...i?[t]:[],...n]}catch(t){throw this.logger.zsymb(21,"T2Sa5S",["[predict] Keyword: '{}' - Failed: {}","Pp_NXt"],e,t),this.logQosError(Ua.i.PREDICT_FAILED,t),$a.a.getInstance().onFailedToSuggest(t),t}}simulateErrorIfNeeded(){if(ia.a.enable()){if(ia.a.get("simulate_fail_suggest"))throw new Error("Oops! Something went wrong")}}async getStickerArtifactsMatchingKwd(e,t){let s=[],i={},n=!1;if(void 0!==this.partialKwd2Sticker.map[e])i=this.partialKwd2Sticker.index;else{const{map:t,index:s}=await this.getKwd2Stickers();this.partialKwd2Sticker.map[e]=t[e]||[],i=s,n=!0}s=this.partialKwd2Sticker.map[e];const a=[];for(const r of s){const e=i[r];void 0!==e&&(Object(Ea.a)(e)&&t(e)&&a.push(e.content),n&&(this.partialKwd2Sticker.index[r]=e))}return a}initExpireDuration(e,t){let s=!1,i=!1;{const t=Ba.getMetadataExpireDurationInMsFromRawExpireTime(e);null===this.metadataExpireHandler&&(this.metadataExpireHandler=new tr.a(qa,Qa,t),this.metadataExpireHandler.onExpired((()=>{try{0,this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded()}catch(e){this.logger.zsymb(21,"2pjIVY",["Metadata expire error: {}","0Rt6A8"],Object(Yn.c)(e))}})),s=!0)}{let e=Ba.getReconstructExpireDurationInMsFromRawReconstructInterval(t);0,null===this.reconstructionExpireHandler&&(this.reconstructionExpireHandler=new tr.a(Za,Ja,e),this.reconstructionExpireHandler.onExpired((()=>{try{0,this.runReconstructionIfNeeded(!0)}catch(e){this.logger.zsymb(21,"-SeB1P",["Reconstruct expire error: {}","yB6W9a"],Object(Yn.c)(e))}})),i=!0)}s&&this.metadataExpireHandler.start(),i&&this.reconstructionExpireHandler.start()}updateMetadataExpireDuration(e){const t=Ba.getMetadataExpireDurationInMsFromRawExpireTime(e);null===this.metadataExpireHandler?this.logger.zsymb(18,"twC33L","[ExpireHandler][metadata] Not init yet"):this.metadataExpireHandler.updateExpiredDuration(t)}updateReconstructExpireDuration(e){let t=Ba.getReconstructExpireDurationInMsFromRawReconstructInterval(e);null===this.reconstructionExpireHandler?this.logger.zsymb(18,"777wSw","[ExpireHandler][reconstruct] Not init yet"):this.reconstructionExpireHandler.updateExpiredDuration(t)}isEqualMetadata(e,t){return e.expired_time===t.expired_time&&(e.sort_sticker_model.enable_feature===t.sort_sticker_model.enable_feature&&(e.sort_sticker_model.version===t.sort_sticker_model.version&&(e.sort_sticker_model.reconstruct_range===t.sort_sticker_model.reconstruct_range&&(e.sort_sticker_model.reconstruct_interval===t.sort_sticker_model.reconstruct_interval&&(e.sort_sticker_model.url===t.sort_sticker_model.url&&(e.mapkwdsticker.url===t.mapkwdsticker.url&&e.mapkwdsticker.version===t.mapkwdsticker.version))))))}updateMetadataIfNeeded(){if(!this.enableFeature)return void 0;const e=this.getSSMetadata();let t=!1,s=null;if(null===e){s=this.fetchSSMetadata(),t=!0;const{expired_time:e,sort_sticker_model:i}=s;this.initExpireDuration(e,i.reconstruct_interval)}else if(s=this.fetchSSMetadata(),t=!this.isEqualMetadata(e,s),t){const{expired_time:e}=s;this.updateMetadataExpireDuration(e);const{reconstruct_interval:t}=s.sort_sticker_model;this.updateReconstructExpireDuration(t)}else 0;t&&this.updateResourceIfNeeded(e,s)}shouldReconstructAgainstResourceChangeStatus(e){return e===Ua.g.BOTH_CHANGED||e===Ua.g.TF_MODEL_CHANGED_ONLY}async runReconstructionIfNeeded(e=!1){if(!this.enableFeature)return void this.logger.zsymb(6,"ScFvna","[runReconstructionIfNeeded] Feature is disabled");let t=Ua.g.NOT_CHANGED;if(null!==this.updateResourceIfNeededContainer)t=await this.updateResourceIfNeededContainer.promise;else{switch(this.getResourceStatus()){case Ua.h.EMPTY:return void this.logger.zsymb(18,"05fcG-","Failed to reconstruct due to empty resource");case Ua.h.ERROR:return void this.logger.zsymb(18,"_9iXdk","Failed to reconstruct due to invalid resource")}}if(e||this.shouldReconstructAgainstResourceChangeStatus(t)){const e=this.getSSMetadata();if(null===e)throw new Error("Metadata is still unavailable after updating resource");let t=await this.getSticker2Click(e.sort_sticker_model.reconstruct_range);0;try{0;const{scores:e}=await this.tfModel.reconstruct(t);0,this.resourceManager.sticker2Score.set(e)}catch(s){throw this.logger.zsymb(21,"fbCdXj",["[runReconstructionIfNeeded] Run reconstruction failed: {}","LIL_pB"],s),this.logQosError(Ua.i.RUN_RECONSTRUCT_FAILED,s),s}}else 0}async startup(){if(!this.didStartup)if(this.didStartup=!0,this.enableFeature){0;try{const e=this.getSSMetadata();if(null===e)this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded();else{const{expired_time:t,sort_sticker_model:s}=e;0,this.initExpireDuration(t,s.reconstruct_interval)}this.scheduleStickerUsageCleanUp()}catch(e){0,this.logQosError(Ua.i.STARTUP_FAILED,e)}}else this.logger.zsymb(6,"QPFyD0","[startup] Feature is disabled!")}async updateResourceIfNeeded(e,t){if(null!==this.updateResourceIfNeededContainer)return this.updateResourceIfNeededContainer.promise;this.updateResourceIfNeededContainer=new Be.c.Container;let s=Ua.g.NOT_CHANGED;try{const i=null===e,n=[];if(i||this.isVersionOutDated(e.sort_sticker_model.version,t.sort_sticker_model.version)){s=Ua.g.TF_MODEL_CHANGED_ONLY;const{url:e,checksum_folder:i,checksum_zip:a}=t.sort_sticker_model,r=(async()=>{try{await this.updateModelResourceData({url:e,checksumFolder:i,checksumZip:a}),this.ssResourceConfig=null}catch(t){throw this.logQosError(Ua.i.UPDATE_MODEL_RESOURCE_DATA_FAILED,t),t}})();n.push(r)}if(i||this.isVersionOutDated(e.mapkwdsticker.version,t.mapkwdsticker.version)){s=s==Ua.g.NOT_CHANGED?Ua.g.KWD_2_STICKERS_CHANGED_ONLY:Ua.g.BOTH_CHANGED;const{url:e,checksum:i}=t.mapkwdsticker,a=(async()=>{try{await this.updateKwd2StickerResourceData({url:e,checksum:i}),this.kwd2Sticker=null,this.partialKwd2Sticker={map:{},index:{}}}catch(t){throw this.logQosError(Ua.i.UPDATE_KWD2STICKER_DATA_FAILED,t),t}})();n.push(a)}return await Promise.all(n),this.setSSMetadata(t),this.logger.zsymb(0,"Bi39tr","[updateResourceIfNeeded] Save new metadata"),this.setResourceStatus(Ua.h.READY),this.updateResourceIfNeededContainer.resolve(s),s}catch(i){throw this.setResourceStatus(Ua.h.ERROR),this.updateResourceIfNeededContainer.reject(i),this.logQosError(Ua.i.UPDATE_RESOURCE_FAILED_IN_GENERAL,i),i}finally{this.updateResourceIfNeededContainer=null}}fetchSSMetadata(){return Ka.a.key("metadata").object}isVersionOutDated(e,t){return e<t}getResourceStatus(){if(null!==this.cachedResourceStatus)return this.cachedResourceStatus;let e=Ua.h.EMPTY;const t=E.default.getInstance().getItemForCurrentUser(Ua.n);if(null!==t){const s=+t;Number.isNaN(s)||(e=s)}return this.cachedResourceStatus=e,e}setResourceStatus(e){if(this.cachedResourceStatus!==e){this.cachedResourceStatus=e;E.default.getInstance().setItemForCurrentUser(Ua.n,`${e}`)}}getSSMetadata(){if(null===this.metadata){const t=E.default.getInstance().getItemForCurrentUser(Ua.k);if(null===t)return null;try{this.metadata=JSON.parse(t)}catch(e){throw this.logQosError(Ua.i.PARSE_SS_METADATA_FAILED,e),new Error("Failed to parse ssMetadata data")}}return this.metadata}setSSMetadata(e){this.metadata=e;const t=E.default.getInstance();if(null===e)t.removeItemForCurrentUser(Ua.k);else{const s=JSON.stringify(e);t.setItemForCurrentUser(Ua.k,s)}}async getSticker2Click(e){const t=await this.resourceManager.sticker2Click.get(e);return null===t?{}:t}async getKwd2Stickers(){if(null===this.kwd2Sticker){const e=await this.resourceManager.kwd2Stickers.get();if(null===e)throw new Error("No 'kwd2Stickers' data is available!");this.kwd2Sticker=e}return null!==this.disposeKwd2StickersCacheTimer&&clearTimeout(this.disposeKwd2StickersCacheTimer),this.disposeKwd2StickersCacheTimer=setTimeout((()=>{this.kwd2Sticker=null}),Ua.c),this.kwd2Sticker}async getSSResourceConfig(){if(null===this.ssResourceConfig){const e=await this.resourceManager.config.get();if(null===e)throw new Error("No 'ssConfig' data is available!");this.ssResourceConfig=e}return this.ssResourceConfig}async getSticker2Score(){if(null===this.sticker2Score){const e=await this.resourceManager.sticker2Score.get();if(null===e)throw new Error("No 'sticker2Score' data is available!");this.sticker2Score=e}return this.sticker2Score}logQosError(e,t){null===this.qos&&(this.qos=i.ModuleContainer.resolve(at.b));let s="Unknown error";"string"==typeof t?s=t:t instanceof Error&&(s=t.message),this.qos.log({commandId:Ua.l,subCommandId:0,duration:0,success:!1,errorCode:e,params:[s]})}}var nr,ar=s("lL1k"),rr=s("9Pyw"),or=s("RrMd"),lr=s("xOOu"),cr=s.n(lr),dr=s("rP9a");let ur=Object(Je.d)()(nr=class extends ir{onApplicationReady(){this.startup()}async updateModelResourceData(e){try{const{url:t,checksumZip:s}=e,i=new rr.a(t,or.b.MANUAL,(()=>{}),{checksum:s}),n=await i.downloadBlob(),a=await n.arrayBuffer(),r=await cr.a.loadAsync(a),o=[];{const e=(async()=>{const e=new RegExp(`${Ua.f}/.*`),t=r.file(e);if(0===t.length)throw new Error("No model data folder is available!");let s=[];const i=new RegExp(`^${Ua.f}/`);for(const n of t){if(n.dir)throw new Error("Invalid nested folder in model data folder!");{const e=await n.async("blob"),t={name:n.name.replace(i,""),data:e};s.push(t)}}s=s.sort(((e,t)=>{const{name:s}=e,{name:i}=t;if(s.endsWith(".json"))return-1;if(i.endsWith(".json"))return 1;const n=s.replace(".bin",""),a=i.replace(".bin","");return n.localeCompare(a)})),await this.resourceManager.model.saveData(s)})();o.push(e)}{const e=(async()=>{const e=r.file(Ua.e);if(null===e)throw new Error("No 'ssConfig' file is found!");const t=await e.async("string");try{const e=JSON.parse(t);await this.resourceManager.config.set(e)}catch(s){throw new Error("Invalid 'ssConfig' data")}})();o.push(e)}{const e=(async()=>{const e=r.file(Ua.a);if(null===e)throw new Error("No 'item2Index' file is found!");let t={};const s=await e.async("string");try{const e=JSON.parse(s);t=Ga.parseSupportedItemsData(e)}catch(i){throw new Error("Invalid 'ssConfig' data")}await this.resourceManager.item2Sticker.set(t)})();o.push(e)}await Promise.all(o)}catch(t){throw new Error(`Failed to update model resource data: ${t}`)}}async updateKwd2StickerResourceData(e){try{const{url:t,checksum:s}=e,i=new rr.a(t,or.b.MANUAL,(()=>{}),{checksum:s}),n=await i.downloadBlob(),a=await n.arrayBuffer(),r=dr.a.inflate(a,{to:"string"}),o=JSON.parse(r),l=Ga.parseKwd2StickersResponse(o);await this.resourceManager.kwd2Stickers.set(l)}catch(t){throw new Error(`Failed to update kwd2Sticker resource data: ${t}`)}}})||nr;i.ModuleContainer.registerSingleton(ar.a,ur);var hr=s("3t1t"),gr=s("4b23"),mr=s("vNya");const pr=Object(gr.a)("1234567890abcdef",12);class fr{constructor(e){this.ONLOAD_TIMEOUT=1e4,this.instance=null,this.id=void 0,this.__createId__=void 0,this.__createName__=void 0,this.windowId="",this.popupTitle="",this.popupPath="",this.frame="",this.specs="",this.createWindow=async e=>{const{parentWindow:t,popupPath:s,frame:i,specs:n}=e;this.windowId=e.windowId,this.popupTitle=e.popupTitle,this.popupPath=s,this.frame=i||"",this.specs=n||"";const a=t.open(s,i,n);if(a){var r,o;null!==(r=a.document)&&void 0!==r&&r.body&&(a.document.body.style.backgroundColor="#1f1f1f"),this.instance=a,zconsole.zsymb(12,"E4UUkd","[MVR]: onWindowDOMContentLoaded event",null==a?void 0:a.document.readyState),e.onWindowCreated&&e.onWindowCreated(this.selfContext);const t=t=>{var s;zconsole.zsymb(12,"jIn4a2","[MVR]: onWindowDOMContentLoaded event",t.document.readyState),e.onWindowDOMContentLoaded&&e.onWindowDOMContentLoaded(t),"complete"===(null===(s=t.document)||void 0===s?void 0:s.readyState)?(zconsole.zsymb(0,"fZfeAu","[MVR]: Load is already fired. skip listener"),e.onWindowLoad&&e.onWindowLoad(t)):(zconsole.zsymb(0,"aBLUGk","[MVR]: listen mvr load event"),this.onLoad(e.onWindowLoad))};return["interactive"].includes((null===(o=a.document)||void 0===o?void 0:o.readyState)||"")?(zconsole.zsymb(0,"l58zrx","[MVR]: DOMContentLoaded is already fired. skip listener"),t(a)):(zconsole.zsymb(0,"1h-JRV","[MVR]: listen mvr DOMContentLoaded event"),this.onDOMContentLoaded(t)),zconsole.zsymb(12,"_kNUgp","[MVR]: onWindowDOMContentLoaded event",a.document.readyState),hr.d.centerPopupWeb(a,e.windowBoundary),hr.d.SUCCESS(a)}return hr.d.FAILURE({code:hr.b.CREATE_WINDOW_FAILED,message:"Cannot create new window"})},this.onBeforeUnload=()=>{Object(Q.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`),Object(Q.a)(!!this.windowId&&"string"==typeof this.windowId,`windowId must be a valid string. Received ${this.windowId}`);const e=()=>{var t;null===(t=this.instance)||void 0===t||t.removeEventListener("beforeunload",e),i.ModuleContainer.resolve(mr.a).close(this.windowId)};this.instance.addEventListener("beforeunload",e)},this.onDOMContentLoaded=e=>{Object(Q.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`);let t=null;const s=this.instance,i=()=>{s.removeEventListener("DOMContentLoaded",i),e&&"function"==typeof e&&e(s),this.onBeforeUnload(),t&&s.clearTimeout(t)};t=s.setTimeout((()=>{s.removeEventListener("DOMContentLoaded",i),e&&"function"==typeof e&&e(s)}),this.ONLOAD_TIMEOUT),s.addEventListener("DOMContentLoaded",i)},this.onLoad=e=>{Object(Q.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`);const t=this.instance;let s=null;const i=()=>{t.removeEventListener("load",i),e&&"function"==typeof e&&e(t),s&&t.clearTimeout(s)};s=t.setTimeout((()=>{t.removeEventListener("load",i),e&&"function"==typeof e&&e(t)}),this.ONLOAD_TIMEOUT),t.addEventListener("load",i)},this.__createName__=e,this.__createId__=pr(),this.id=`zalo_popup_${pr(7)}`}cleanup(){var e;null===(e=this.instance)||void 0===e||e.removeEventListener("beforeunload",this.onBeforeUnload)}getCurrentWindowSizes(){try{var e,t,s,i,n,a;return Object(Q.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`),Object(Q.a)(!(null===(e=this.instance)||void 0===e||!e.outerWidth)&&"number"==typeof(null===(t=this.instance)||void 0===t?void 0:t.outerWidth),`outerWidth must be a valid number. Received ${null===(s=this.instance)||void 0===s?void 0:s.outerWidth}`),Object(Q.a)(!(null===(i=this.instance)||void 0===i||!i.outerHeight)&&"number"==typeof(null===(n=this.instance)||void 0===n?void 0:n.outerHeight),`outerHeight must be a valid number. Received ${null===(a=this.instance)||void 0===a?void 0:a.outerHeight}`),{w:this.instance.outerWidth,h:this.instance.outerHeight}}catch(r){return zconsole.zsymb(18,"aMMICM","[MVR]: getCurrentWindowSizes error",r),null}}}var vr,br=s("W0O7");let Ir=Object(i.injectable)()(vr=Reflect.metadata("design:type",Function)(vr=Reflect.metadata("design:paramtypes",[])(vr=class extends fr{constructor(){super("__web.window__"),this._focused=!1,this._resizedDimension=null,this._resized=!1,this.create=async e=>{var t,s;Object(Q.a)(!!e.parentWindow,"parentWindow must be a valid window object"),Object(Q.a)("string"==typeof e.windowId,"windowId must be a string. Received "+typeof e.windowId),Object(Q.a)("string"==typeof e.popupPath&&!!e.popupPath,`popupPath must be a valid string. Received ${e.popupPath}`),Object(Q.a)("string"==typeof e.popupTitle,"popupTitle must be a string. Received "+typeof e.popupTitle),this._resizedDimension={w:(null===(t=e.windowBoundary)||void 0===t?void 0:t.w)||-1,h:(null===(s=e.windowBoundary)||void 0===s?void 0:s.h)||-1};const i=await this.createWindow(e);if("ERROR"===i.type)throw i;return this._setupListeners(),hr.d.SUCCESS(this)},this.focus=async()=>{if(this._focused)zconsole.zsymb(0,"RghDRv",`[MVR]: zpopup: Already Focused window ${this.windowId} => Return`);else{if(!this.instance)throw hr.d.FAILURE({code:hr.b.FOCUS_NULL_WINDOW,message:"WINDOW NOT FOUND",stack:null});try{this.instance.focus()}catch(e){throw hr.d.FAILURE({code:hr.b.FOCUS_WINDOW_FAILED,message:`Failed to focus ${this.windowId}`,stack:e})}}},this.close=async()=>{if(!this.instance)return;try{this.instance.close()}catch(e){}finally{this.cleanup()}},this.getInfoScreenOfMouse=e=>(Object(Q.a)(!!e&&"object"==typeof e,"parentWindow must be a valid window object"),Object(br.getWebScreenBoundary)(e)),this.onFocus=()=>{this._focused=!0},this.onBlur=()=>{this._focused=!1},this.listenBeforeUnload=()=>{var e;null===(e=this.instance)||void 0===e||e.addEventListener("beforeunload",this.onBeforeUnload)},this.handleResize=e=>{this._resized=!0},this._setupListeners=()=>{this.instance&&(this.instance.addEventListener("focus",this.onFocus),this.instance.addEventListener("blur",this.onBlur),this.onLoad(this.listenBeforeUnload),this.instance.addEventListener("resize",this.handleResize))},this.cleanup=()=>{this.instance&&(super.cleanup(),this.instance.removeEventListener("focus",this.onFocus),this.instance.removeEventListener("blur",this.onBlur),this.instance.removeEventListener("load",this.listenBeforeUnload),this.instance.removeEventListener("resize",this.handleResize),this.instance=null)},this.getCurrentWindowSizes=()=>{var e,t;return this._resized||"number"!=typeof(null===(e=this._resizedDimension)||void 0===e?void 0:e.w)||"number"!=typeof(null===(t=this._resizedDimension)||void 0===t?void 0:t.h)?super.getCurrentWindowSizes():this._resizedDimension}}get selfContext(){return this}})||vr)||vr)||vr;i.ModuleContainer.register(hr.c,Ir);const yr=Object(i.define)("pulloffline-reporter");var _r;const Cr="rp_ofl_p";Object(i.singleton)(yr)(_r=Reflect.metadata("design:type",Function)(_r=Reflect.metadata("design:paramtypes",[])(_r=class{constructor(){this.logger=void 0,this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("offline-monitor",["reporter"])}reportLastSession(){const e=E.default.getInstance().getObject(Cr);e&&(this.logger.zsymb(0,"hN78TB","detect last session"),this.report(e))}report(e){this.logger.zsymb(0,"Lmevlp","report: ",JSON.stringify(e)),as.default.logActionInfoV2(as.FeaturesInfo.PullOffline,1,e,[],!0);E.default.getInstance().removeItem(Cr)}saveDraft(e){E.default.getInstance().setObject(Cr,e),this.logger.zsymb(0,"itdC_0","draft saved: ",JSON.stringify(e))}log(e){this.logger.zsymb(0,"eqhTFe","log: ",JSON.stringify(e))}})||_r)||_r);var Or,Er=s("BkRI"),Mr=s.n(Er),Sr=s("AtyM"),Tr=s("eBe7"),wr=s("yrNp"),Rr=function(e){return e.AfterApi="afterApi",e.AfterSavedDB="afterSavedDB",e}(Rr||{});Object(i.singleton)(wr.a)(Or=class extends Fe.b{constructor(...e){super(...e),this.timeUsage={startTrackingTime:0,afterApi:0,afterSavedDB:0},this.info=null,this.started=!1}onStart(){this.started||(this.resetMonitor(),this.started=!0,this.timeUsage.startTrackingTime=Sr.a.now(),this.dispatchEvent(new Tr.d))}onDoneApi(){this.takeSnapshot(Rr.AfterApi)}onSavedDB(){this.takeSnapshot(Rr.AfterSavedDB)}onSettled(e,t){this.started&&(this.started=!1,this.info=null!=e?{error:e}:{result:t},this.dispatchEvent(new Tr.b(e,t)))}onSkip(){this.resetMonitor(),this.dispatchEvent(new Tr.c)}getCollectedMetrics(){let e={error:new Error("Incompleted metric")};return null===this.info||(e="error"in this.info?{error:this.info.error}:{result:this.info.result}),Mr()(Object(f.a)({timeUsage:Object(f.a)({},this.timeUsage)},e))}takeSnapshot(e){this.timeUsage[e]=Sr.a.now()-this.timeUsage.startTrackingTime}resetMonitor(){this.timeUsage={startTrackingTime:0,afterApi:0,afterSavedDB:0},this.info=null}});var Lr=s("oq0C");const Dr=()=>void 0!==mi.default.socket.offline_monitor.enable&&mi.default.socket.offline_monitor.enable,Ar=()=>void 0!==mi.default.socket.offline_monitor.latency_time?mi.default.socket.offline_monitor.latency_time:3e4,Fr=()=>void 0!==mi.default.socket.offline_monitor.exclude_monitors_queues?mi.default.socket.offline_monitor.exclude_monitors_queues:["516","517","518","519"];var jr=s("rkiK");let Pr;!function(e){function t(e,t,s){const i={lowestFPS:60,dropTime:e[s].ts-e[t].ts};for(let n=t;n<=s;n++)e[n].fps<i.lowestFPS&&(i.lowestFPS=e[n].fps);return i}e.getDroppeds=function(e,s){let i=0,n=0,a=s[0].fps<=e;const r=[];return s.forEach(((o,l)=>{a?(o.fps>e&&(n=l,a=!1,r.push(t(s,i,n))),l==s.length-1&&o.fps<=e&&(n=l,a=!1,r.push(t(s,i,n)))):o.fps>e?(i=l,a=!1):l==s.length-1?(n=l,a=!1,r.push(t(s,i,n))):a=!0})),r}}(Pr||(Pr={}));var kr,Nr=s("m0Bc");const Ur={dropCount:0,min:60,dropTime:0};var Br=function(e){return e.BeforePull="beforePull",e.InPull="inPull",e.InSaveDB="inSaveDB",e.AfterSaveDB="afterSaveDB",e}(Br||{});let xr=Object(i.singleton)(Lr.a)(kr=Reflect.metadata("design:type",Function)(kr=Reflect.metadata("design:paramtypes",[void 0===yr?Object:yr])(kr=class extends Fe.b{constructor(e){super(),this.reporter=e,this.cpuUsage=void 0,this.fpsUsage=void 0,this.timeUsage=void 0,this.lastActionId=void 0,this.countData={},this.countConv={},this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.callStartPullCount=0,this.actionIdSnapshot={},this.monitorQueues=new Set,this.timeStartChat={},this.isFirstSnapshot=!0,this.fpsRecorder={},this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(f.a)({},Ur),inPull:Object(f.a)({},Ur),inSaveDB:Object(f.a)({},Ur),afterSaveDB:Object(f.a)({},Ur)},this.lastActionId={}}startMonitor(){return Dr(),this.reporter.reportLastSession(),Dr()?(this.getCPU(),this.trackFPS(Br.BeforePull),Promise.resolve()):Promise.resolve()}async stopMonitor(){this.timeStartChat.group&&!this.timeUsage.waitSendGr&&(this.timeUsage.waitSendGr=Sr.a.now()-this.timeStartChat.group),this.timeStartChat.oneone&&!this.timeUsage.waitSendOO&&(this.timeUsage.waitSendOO=Sr.a.now()-this.timeStartChat.oneone),await this.takeSnapshot(Br.AfterSaveDB),this.reporter.report({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}getCollectedMetrics(){const e=Object.entries(this.countConv).reduce(((e,[t,s])=>Object(f.a)(Object(f.a)({},e),{},{[t]:s.size})),{});return{isFirstSnapshot:this.isFirstSnapshot,cpuUsage:Object(f.a)({},this.cpuUsage),fpsUsage:Object(f.a)({},this.fpsUsage),timeUsage:Object(f.a)({},this.timeUsage),countData:Object(f.a)({},this.countData),countConv:e}}resetMonitor(){this.monitorQueues.clear(),this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(f.a)({},Ur),inPull:Object(f.a)({},Ur),inSaveDB:Object(f.a)({},Ur),afterSaveDB:Object(f.a)({},Ur)},this.lastActionId={},this.actionIdSnapshot={},this.countData={},this.countConv={},this.timeStartChat={}}addMonitorQueues(e){const t=Fr();e.forEach((e=>{t.some((t=>e.startsWith(t)))||this.monitorQueues.add(e)})),this.monitorQueues}async onStartPoll(e){if(this.callStartPullCount++,!Dr())return;if(this.callStartPullCount%2==1&&this.resetMonitor(),this.addMonitorQueues(e),this.started,this.callStartPullCount,this.started)return;this.started=!0,this.timeUsage.startTrackTime=Sr.a.now();const t=this.callStartPullCount<=2?Nr.e.Startup:Nr.e.Resume;this.dispatchEvent(new Nr.d(t)),await this.takeSnapshot(Br.BeforePull),this.trackFPS(Br.InPull)}async onEndPoll(e,t){Dr()&&this.monitorQueues.has(e)&&(Dr(),this.lastActionId[e]=t,this.donePullCount++,this.monitorQueues.size==this.donePullCount&&(await this.takeSnapshot(Br.InPull),this.trackFPS(Br.InSaveDB)))}onPollData(e,t){if(Dr()&&!this.isDoneMonitor&&this.monitorQueues.has(e))switch(this.countData[e]||(this.countData[e]=0),this.countConv[e]||(this.countConv[e]=new Set),e){case"510_0":case"513_0":case"515_0":case"510_1":case"513_1":case"515_1":this.countData[e]+=t.data.msgs.length,this.countData[e]+=t.data.pageMsgs.length;for(const i of t.data.msgs)try{this.countConv[e].add(i.idTo)}catch(s){}for(const i of t.data.pageMsgs)try{this.countConv[e].add(i.idTo)}catch(s){}break;case"511_0":case"514_0":case"511_1":case"514_1":this.countData[e]+=t.data.groupMsgs.length;for(const i of t.data.groupMsgs)try{this.countConv[e].add(i.idTo)}catch(s){}break;case"610_0":case"611_0":case"610_1":case"611_1":this.countData[e]+=t.data.reacts.length,this.countData[e]+=t.data.reactGroups.length;for(const i of t.data.reacts)try{this.countConv[e].add(i.idTo)}catch(s){}for(const i of t.data.reactGroups)try{this.countConv[e].add(i.idTo)}catch(s){}break;case"603_0":case"603_1":this.countData[e]+=t.data.controls.length}}onSavedData(e){if(!this.isDoneMonitor&&Dr()){this.actionIdSnapshot;for(const t in e)this.monitorQueues.has(t)&&this.lastActionId[t]&&this.actionIdSnapshot[t]!==e[t]&&(this.checkDoneDoOffline(t,e[t]),this.actionIdSnapshot[t]=e[t])}}onOpenConversation(e){"string"==typeof e&&0===this.timeUsage.openConv&&(this.timeUsage.openConv=Sr.a.now()-this.timeUsage.startTrackTime)}onStartChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeStartChat.group?this.timeStartChat.group=Sr.a.now():this.timeStartChat.oneone||(this.timeStartChat.oneone=Sr.a.now()))}onEncryptChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeUsage.waitSendGr?this.timeUsage.waitSendGr=Sr.a.now()-this.timeStartChat.group:this.timeUsage.waitSendOO||(this.timeUsage.waitSendOO=Sr.a.now()-this.timeStartChat.oneone))}async checkDoneDoOffline(e,t){if(this.lastActionId[e],this.doneOfflineCount==this.monitorQueues.size)return;const s=this.lastActionId[e];s&&Number(t)==Number(s)&&(this.doneOfflineCount++,this.doneOfflineCount==this.monitorQueues.size&&(this.isDoneMonitor=!0,await this.takeSnapshot(Br.InSaveDB),this.trackFPS(Br.AfterSaveDB),this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),this.isFirstSnapshot=!1,this.dispatchEvent(new Nr.a),setTimeout((()=>{this.stopMonitor(),this.dispatchEvent(new Nr.b)}),Ar())))}async takeSnapshot(e){const t=await this.getCPU(),s=this.getFPS(e);this.cpuUsage[e]=t,this.fpsUsage[e]=s,this.timeUsage[e]=Sr.a.now()-this.timeUsage.startTrackTime,this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}async getCPU(){return 0}trackFPS(e){this.fpsRecorder[e]=jr.default.Fps.registerSectionRecorder(e),this.fpsRecorder[e].start()}getFPS(e){var t;const s=null===(t=this.fpsRecorder[e])||void 0===t?void 0:t.end();if(delete this.fpsRecorder[e],!s||0==s.fpsHistory.length)return Ur;const i=Pr.getDroppeds(50,s.fpsHistory);if(0==i.length)return Ur;const n=i.reduce(((e,t)=>e+=t.dropTime),0),a=Math.min(...i.map((e=>e.lowestFPS)));return{dropCount:i.length,dropTime:n,min:a}}})||kr)||kr)||kr;var Gr;Object(i.injectable)()(Gr=Object(i.singleton)(Lr.a)(Gr=function(e,t){return Object(i.inject)(yr)(e,void 0,0)}(Gr=Reflect.metadata("design:type",Function)(Gr=Reflect.metadata("design:paramtypes",[void 0===yr?Object:yr])(Gr=class extends xr{constructor(e){super(e)}async getCPU(){return 0}})||Gr)||Gr)||Gr)||Gr);var zr=s("BuY5"),Vr=s("QOJ3"),Hr=s("JUJ1"),Wr=s("//ub");let $r=function(e){return e.HandleOfflineData="HANDLE_OFFLINE_DATA",e.Sample="SAMPLE",e}({}),Kr=function(e){return e[e.FRESH_START=1]="FRESH_START",e[e.RESUME=2]="RESUME",e[e.UNKNOWN=-1]="UNKNOWN",e}({});var qr;let Qr=Object(Wr.b)()(qr=Reflect.metadata("design:type",Function)(qr=Reflect.metadata("design:paramtypes",[])(qr=class e extends Hr.a{static getInstance(){return Vr.a.resolve(e)}constructor(){super({collections:Object.values($r)})}collect(e){if("end"===e.action)this.report()}start(e){Be.c.Macrotask.push((()=>{var t,s;null===(t=this.collection(e))||void 0===t||null===(s=t.metric())||void 0===s||s.start()}))}end(e,t){Be.c.Macrotask.push((()=>{var s,i;null===(s=this.collection(e))||void 0===s||null===(i=s.metric())||void 0===i||i.end(t)}))}once(e,t){Be.c.Macrotask.push((()=>{var s,i;null===(s=this.collection(e))||void 0===s||null===(i=s.metric())||void 0===i||i.once(t)}))}record(e,t){Be.c.Macrotask.push((()=>{var s;null===(s=this.collection(e))||void 0===s||s.metric().record(t)}))}cancel(e){const t=this.collection(e);if(!t)return;const s=t.defaultId;t.removeMetric(s)}submitActionLog(e){as.default.logActionInfoV2(e.id,e.subType,e.data)}report(){const e=Object.values($r);for(const s of e){var t;const e=null===(t=this.collection(s))||void 0===t?void 0:t.metric();if(!e||!e.isReadyToGetReport)continue;const i=e.report();if(!i)continue;let n;switch(s){case $r.HandleOfflineData:{const{convListSort:e,workload:t,result:s,error:a,timeUsage:r,offlineInfo:o}=i.metadata;if(0===o.tsOffline)n={id:-1,subType:-1,data:{}};else{n={id:as.FeaturesInfo.Offline2Online,subType:1,data:{conv_list_sort:{count:e.count},pull:{count_msg_data:t.msgPull,count_conv_data:t.convPull,count_msg_success:s.msgPull,time:r.pull},offline_info:{offline_time:o.tsOffline,online_time:o.tsOnline,online_type:o.onlineType}}};!!t.msgPreProcess&&(n.data.pre=Object(f.a)({count_msg_data:t.msgPreProcess,time:r.preProcess},a&&a.preProcess?{error:a.preProcess}:{}))}break}case $r.Sample:default:n={id:-1,subType:-1,data:{}}}-1!==n.id&&this.submitActionLog(n)}}})||qr)||qr)||qr;var Zr=s("FlN1");Object(i.define)("offline-detector");const Jr=Object(i.define)("event-bus"),Yr="last-online-detector",Xr=Object(i.define)(Yr),eo=Object(i.define)(`${Yr}-socket-polling`),to=Object(i.define)(`${Yr}-local-storage`);var so=s("rXIX"),io=s("rQsU");class no{constructor(){this.result={numOfOrderChanges:0},this.unregisterListeners=()=>{},this.prevConvListOrderSnapshot=null}static getInstance(){return null===this.instance&&(this.instance=new no),this.instance}startTracking(){this.registerListeners()}stopTracking(){this.unregisterListeners()}getTrackingResult(){return Mr()(this.result)}reset(){this.result={numOfOrderChanges:0},this.prevConvListOrderSnapshot=null}registerListeners(){const e=[],t=i.ModuleContainer.resolve(io.b);e.push(t.addEventListener(so.c.SignalRenderList,(e=>{this.recordSnapshotChange(e.listVisible)}))),this.unregisterListeners=()=>{e.forEach((e=>e()))}}recordSnapshotChange(e){const t=this.isConvListOrderChanged(e);t&&(this.result.numOfOrderChanges+=1),t&&this.result.numOfOrderChanges}isConvListOrderChanged(e){let t=!1;if(Array.isArray(e)&&null!==this.prevConvListOrderSnapshot){const s=this.prevConvListOrderSnapshot,i=e;for(let e=i.length-1;e>=0;e-=1)if(s[e]!==i[e]){t=!0;break}}return this.prevConvListOrderSnapshot=e,t}}no.instance=null;var ao=s("3NFW"),ro=s("s40A"),oo=s("IfQO"),lo=s("JhTw");class co{static getInstance(){return null===this.instance&&(this.instance=new co),this.instance}constructor(){this.logger=void 0;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory);this.logger=e.createZLogger(Ve.ZLoggerNametags.offline2Online,["offline-data"])}init(){oo.a.getInstance().init(),this.registerAllListeners()}registerAllListeners(){const e=oo.a.getInstance();e.addEventListener(lo.c.Start,(()=>{zr.a.reset(),this.setConvListAnimationMode(Zr.b.ADVANCED),this.resetConvListOrderTracker(),this.startTrackingConvListOrder(),this.cancelO2OMetric(),this.startO2OMetric(),this.signalKeepLoadingScreenIfNeed()})),e.addEventListener(lo.c.End,(async e=>{await Object(ro.c)(2e3),this.stopTrackingConvListOrder();const t=this.getTrackingConvListOrderResult();this.resetConvListOrderTracker();const{result:s}=e,i=await this.getOfflineInfo();this.endO2OMetric(s,t,{tsOffline:i.tsOffline,tsOnline:i.tsOnline,onlineType:s.offlineInfo.onlineType});const n=ao.a.getInstance();await n.stop()})),e.addEventListener(lo.c.PreProcessingSettle,(e=>{this.recordPreProcessingResultForO2OMetric(e.error,e.result),this.signalDismissLoadingScreen()})),e.addEventListener(lo.c.OfflineProcessingUIDone,(()=>{this.setConvListAnimationMode(Zr.b.NORMAL),zr.a.reset()}))}setConvListAnimationMode(e){Zr.a.getInstance().setAnimationMode(e)}cancelO2OMetric(){Qr.getInstance().cancel($r.HandleOfflineData)}startO2OMetric(){Qr.getInstance().start($r.HandleOfflineData)}startTrackingConvListOrder(){no.getInstance().startTracking()}endO2OMetric(e,t,s){Qr.getInstance().end($r.HandleOfflineData,{convListSort:{count:t.numOfOrderChanges},fps:e.fps,cpu:e.cpu,workload:{msgPull:e.workload.msgPull,convPull:e.workload.convPull,msgPreProcess:e.workload.msgPreProcess},timeUsage:{pull:e.timeUsage.pull,preProcess:e.timeUsage.preProcess},result:{msgPull:e.result.msgPull},offlineInfo:{tsOffline:s.tsOffline,tsOnline:s.tsOnline,onlineType:(()=>{switch(s.onlineType){case lo.a.FRESH_START:return Kr.FRESH_START;case lo.a.RESUME:return Kr.RESUME;default:return Kr.UNKNOWN}})()}})}stopTrackingConvListOrder(){no.getInstance().stopTracking()}getTrackingConvListOrderResult(){return no.getInstance().getTrackingResult()}resetConvListOrderTracker(){no.getInstance().reset()}async getOfflineInfo(){const e={tsOffline:-1,tsOnline:-1};try{const t=i.ModuleContainer.resolve(Xr),[s,n]=await Promise.all([t.getStartTsOnlineCurrSession(),t.getLastTsOnlinePrevSession()]);e.tsOffline=n,e.tsOnline=s}catch(t){this.logger.zsymb(21,"_B50o9",["Failed to get offline info: {}","cGKAtN"],Object(Yn.c)(t))}return e}recordPreProcessingResultForO2OMetric(e,t){const s=Qr.getInstance();if(null!==e)s.record($r.HandleOfflineData,{error:{preProcess:Object(Yn.c)(e)}});else{if(!t)return void this.logger.zsymb(0,"CrtgoZ","[recordPreProcessingResultForO2OMetric] Empty result");if(!["allmsgs","clearUnreads","clearUnreadsReact"].every((e=>e in t)))return void this.logger.zsymb(18,"rqAzue","[recordPreProcessingResultForO2OMetric] Invalid result");let e=0,i=0,n=0,a=0;t.allmsgs.forEach((t=>{const{isGroup:s,cmd:r}=t;s?122===r?i+=1:a+=1:122===r?e+=1:n+=1})),s.record($r.HandleOfflineData,{workload:{msgPreProcess:{"1_1":e,group:i,e2ee1_1:n,e2eeGroup:a,clearUnreads:t.clearUnreads.length,clearUnreadsReact:t.clearUnreadsReact.length}}})}}signalKeepLoadingScreenIfNeed(){i.ModuleContainer.resolve(fs).startKeepLoadingIfNeeded()}async signalDismissLoadingScreen(){i.ModuleContainer.resolve(fs).dismissLoadingScreen()}}co.instance=null,co.getInstance().init();s("o0oJ");var uo=s("dThN"),ho=s("z0WU"),go=s("vSga");perf.record(perf.LOAD_APP_SCRIPT),function(){window.__loadTimer&&clearTimeout(window.__loadTimer);window.__startTime&&$zlogger.loadShellQos(Date.now()-window.__startTime)}();s("FcQj");var mo=s("eSGF");let po;function fo(){return po||(po=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("utils",["event-bus-effects"])),po}const vo={[Ai.FetchActions.DELETE_MESSAGE]:(e,t)=>{var s;bo(e.toUid||e.userId||(null===(s=e.conversation)||void 0===s?void 0:s.userId),e.msgId)},[Ai.FetchActions.DELETE_EVERYONE]:(e,t)=>{bo(e.toUid,e.msgId)},[Ai.FetchActions.UNDO_MULTI]:(e,t)=>{var s;null==e||null===(s=e.forEach)||void 0===s||s.call(e,(e=>bo(e.toUid||e.userId,e.msgId)))},[Ai.FetchActions.UNDO]:(e,t)=>{bo(e.toUid||e.userId,e.msgId)},[Ai.FetchActions.REMOVE_MEDIA]:(e,t)=>{for(let s of e.items)bo(null==e?void 0:e.conversationId,null==s?void 0:s.msgId)},[Ai.ChatBoxActions.REMOVE_EXPIRED_MEDIA]:(e,t)=>{bo(null==e?void 0:e.conversationId,(null==e?void 0:e.msgIds)||(null==e?void 0:e.msgId))},[Ai.ChatBoxActions.DELETE_MESSAGE]:(e,t)=>{const s=e.toUid||e.userId||e.conversation&&e.conversation.userId;s!==mi.default.sendToMeId&&bo(s,e.msgId)}};function bo(e,t){if(!e)return;if(!t)return;let s=Object(mo.a)(t);ri.a.instance.emit("media-removed",{convId:e,msgIds:s})}Fi.default.subscribe((function(e,t){let s=vo[e];if(s)try{s(t,e)}catch(i){fo().zsymb(18,"0kbdzU","Failed to run side effect for event:"+e),fo().zsymb(18,"se7Q7H",[i])}}));var Io=s("2ua2");s.p;Io.a.init(),ho.default.checkSupport(),ho.default.showWarningMsg();var yo,_o=s("Kvb3"),Co=s("QPNp"),Oo=s("lTs8"),Eo=s("DvVh"),Mo=s("Y4eg"),So=s("+2cI");Object(i.singleton)(_o.a)(yo=Object(Je.e)()(yo=Reflect.metadata("design:type",Function)(yo=Reflect.metadata("design:paramtypes",[])(yo=class{constructor(){this._isConnectSignalChangeInfo=void 0,this._dispatch=void 0,this._authEvent=void 0,this._isConnectSignalChangeInfo=!1,this.signalInfoChange=this.signalInfoChange.bind(this)}isWeb(){return!0}bindDispatch(e){this._dispatch=e}getDispatch(){return this._dispatch}get dispatch(){return this._dispatch}async preFormatPayload(e){var t;let s=Object(f.a)({},e);if(s.conversation){var i,n;if(null===(i=s.conversation.userId)||void 0===i||null===(n=i.startsWith)||void 0===n?void 0:n.call(i,R.GROUPID_PREFIX)){const e=s.conversation.userId,t=await Co.a.GroupManager.get(e);if(t&&(s.conversation.topMember=t.topMembers,s.conversation.displayName=t.displayName),s.conversation.topMember)for(const i of s.conversation.topMember){const e=ns.default.getMiniInfo(i.id);e&&(i.dName=e.dName,i.avatar=e.avatar)}}else{const e=ns.default.getMiniInfo(s.conversation.userId);e&&(s.conversation.displayName=e.dName,s.conversation.avatar=e.avatar)}}return(null===(t=s.images)||void 0===t?void 0:t.length)>1&&s.message&&(s.images=[s.message]),s}signalInfoChange(e){this.isWeb()}connectSignalToFriendWorker(){this._isConnectSignalChangeInfo||(this._isConnectSignalChangeInfo=!0,ns.default.connectSignalChangeDNameAndAvatar(this.signalInfoChange))}onAuthenticated(e){this._authEvent=e}_addSession(e){var t;return(e=Object(f.a)({},e)).session=null===(t=this._authEvent)||void 0===t?void 0:t.getSession(),e}async openPhotoViewer(e){var t;let s=await this.preFormatPayload(e);s=this._addSession(s),this.connectSignalToFriendWorker();const i=this.getDispatch();i&&i({type:Ai.ChatBoxActions.SHOW_FULL_IMAGE,payload:s}),Mo.a.initLog(),So.a.startSession(),Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,null!==(t=s)&&void 0!==t&&t.isVideo?Eo.d.openVideo:Eo.d.openPhoto)}async openImageCaptionEditor(e){let t=await this.preFormatPayload(e);t=this._addSession(t),this.connectSignalToFriendWorker();const s=this.getDispatch();s&&s({type:Ai.ChatBoxActions.SHOW_MEDIA_CAPTION_EDITOR,payload:t})}})||yo)||yo)||yo);var To,wo=s("MLNQ"),Ro=s("Gd06");Object(i.singleton)(Ro.a)(To=class extends wo.a{initialize(e){this.createModuleInstances(e)}onCloseChildWindow(e){this.getModules(e).forEach((t=>{t&&t.onCloseChildWindow&&"function"==typeof t.onCloseChildWindow&&t.onCloseChildWindow(e)})),this.releaseModules(e)}onOpenChildWindow(e){this.initialize(e);this.getModules(e).forEach((t=>{t&&t.onOpenChildWindow&&"function"==typeof t.onOpenChildWindow&&t.onOpenChildWindow(e)}))}});var Lo,Do=s("vQ8b"),Ao=s("smi1"),Fo=s("gEkt"),jo=s("yzMR");let Po=Object(i.injectable)()(Lo=function(e,t){return i.ModuleContainer.inject(jo.UnreadDataManager)(e,void 0,0)}(Lo=function(e,t){return i.ModuleContainer.inject(jo.PreviewDataManager)(e,void 0,1)}(Lo=Reflect.metadata("design:type",Function)(Lo=Reflect.metadata("design:paramtypes",[void 0===jo.UnreadDataManager?Object:jo.UnreadDataManager,void 0===jo.PreviewDataManager?Object:jo.PreviewDataManager])(Lo=class{constructor(e,t){this.unreadDataManager=e,this.previewManager=t,this.menuRef=void 0,this.menuRef={}}deleteConversation(e,t=!0,s){e!=R.CONV_FILTER.STRANGER&&(ho.default.logCoreError(`[user call del conv] ${e}`),Ao.default.deleteConversation(e,t,void 0,s).then((e=>{e&&e.delConversationId&&Object($t.f)({type:Ai.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{ho.default.logCoreError("Delete conversation fail - "+JSON.stringify(e))})))}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Fo.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]&&this.menuRef[e].close()}showConvActionMenu(e,t){if(t&&t.friendItem)return;const s=Object(f.a)({},t),i=s.userId;if(s&&!ho.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=ns.default.getProfileFriendByIdSync(i)||{},n=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.type=t.type,s.unreadMark=null==n?void 0:n.unreadMark,s.smsUnreadCount=null==n?void 0:n.smsUnreadCount}this.menuRef[Fo.b].updateTargetInfo(s),this.menuRef[Fo.b].showAction(Object(f.a)({},e))}})||Lo)||Lo)||Lo)||Lo)||Lo;var ko=s("rCQs"),No=s("iZzu"),Uo=s("6Vk1"),Bo=s("RojW"),xo=s("EFQ6"),Go=s("3xbP"),zo=s("l+Gc"),Vo=s("VTLO"),Ho=s("LJTV"),Wo=s("M7kw"),$o=s("Ws4b"),Ko=s("Ja3U"),qo=s("SdS7"),Qo=s("TeAh"),Zo=s("Gm1y"),Jo=s("P6UB"),Yo=s("FEfs"),Xo=s("u1t/");const el="[@CONVERSATION_OPERATION]",tl="[@CONVERSATION_RESOURCES]",sl="[@CONVERSATION_DELETION_CACHE]",il="999999999999999999999",nl="9999999999999999",al="c_d_c_k__";var rl;const ol={typeFilter:No.FilterType.ALL,labelFilters:[],loaded:!1,isEnableArchivedChat:!!Yo.a.isEnableArchivedChat(),typeFilterSrc:No.FilterSrcType.ALL},ll="z_sendtome_bubbledot";Object(ko.b)(No.ConvListController)(rl=function(e,t){return i.ModuleContainer.inject(jo.ConvInfoDataManager)(e,void 0,0)}(rl=function(e,t){return i.ModuleContainer.inject(Uo.b)(e,void 0,1)}(rl=function(e,t){return i.ModuleContainer.inject(jo.UnreadDataManager)(e,void 0,2)}(rl=function(e,t){return i.ModuleContainer.inject(jo.MuteDataManager)(e,void 0,3)}(rl=function(e,t){return i.ModuleContainer.inject(jo.PinDataManager)(e,void 0,4)}(rl=function(e,t){return i.ModuleContainer.inject(jo.ArchivedChatManager)(e,void 0,5)}(rl=function(e,t){return i.ModuleContainer.inject(jo.ConversationUIUpdater)(e,void 0,6)}(rl=Reflect.metadata("design:type",Function)(rl=Reflect.metadata("design:paramtypes",[void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager,void 0===Uo.b?Object:Uo.b,void 0===jo.UnreadDataManager?Object:jo.UnreadDataManager,void 0===jo.MuteDataManager?Object:jo.MuteDataManager,void 0===jo.PinDataManager?Object:jo.PinDataManager,void 0===jo.ArchivedChatManager?Object:jo.ArchivedChatManager,void 0===jo.ConversationUIUpdater?Object:jo.ConversationUIUpdater])(rl=class extends Fe.b{constructor(e,t,s,i,n,a,r){super(),this.convDataManager=e,this.labelDataManager=t,this.unreadDataManager=s,this.muteDataManager=i,this.pinDataManager=n,this.archivedChatManager=a,this.conversationUIUpdater=r,this.typeFilter=void 0,this.labelFilters=void 0,this.listRawAll=void 0,this.listVisible=void 0,this.listStrangers=void 0,this.listHiddens=void 0,this.listFiltered=void 0,this.newestStrangerId=void 0,this.menuRef=void 0,this.convUIListContainer=void 0,this.showedOnboarding=void 0,this.loaded=void 0,this.isEnableArchivedChat=void 0,this.typeFilterSrc=void 0,this._logger=void 0,this._pm=null,this._sbc=null,this.handleMuteChange=e=>{const t=e.convId,s=e.payload,i=this.listFiltered.includes(t);this.logger.zsymb(0,"Jmel9v","handleMuteChange",t,i,this.typeFilter,s),i&&(this.typeFilter===No.FilterType.UNREAD||this.isEnableArchivedChat&&this.typeFilterSrc===No.FilterSrcType.UNREAD)&&this.addConvToUnreadFilterV2(t)},this.deleteConversation=(e,t=!0,s)=>{e!=R.CONV_FILTER.STRANGER&&(this.logger.zsymb(18,"YcQIBU",`[user call del conv] ${e}`),Ao.default.deleteConversation(e,t,void 0,s).then((e=>{e&&e.delConversationId&&Object($t.f)({type:Ai.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{this.logger.zsymb(18,"RV8wDW","Delete conversation fail - "+JSON.stringify(e))})))},this.name=No.CONV_LIST_CONTROLLER,this.data=new Map,this.key="windowId",this.isEnableArchivedChat=!1,this.typeFilter=No.FilterType.ALL,this.labelFilters=[],this.typeFilterSrc=No.FilterSrcType.ALL,this.listRawAll=new Set,this.listVisible=[],this.listStrangers=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="",this.menuRef={},this.showedOnboarding=!1,this.loaded=!1,this.getRecentContactWithId=this.getRecentContactWithId.bind(this),this.selectConversation=this.selectConversation.bind(this),this.showBroadCastMsgModal=this.showBroadCastMsgModal.bind(this),this.markAsRead=this.markAsRead.bind(this),this.addListener()}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.conversation,[Ve.ZLoggerNametags.convList])),this._logger}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(jo.PreviewDataManager)),this._pm}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve(No.SidebarController)),this._sbc}get currUser(){return Object($o.c)()}onTypeFilterChange(e,t){if(e===No.FilterType.UNREAD){const e=this.labelFilters.length>0?1453215:1453214;as.default.logAction(e),setTimeout((()=>{this.scrollToTop(!1)}))}else e!==No.FilterType.ARCHIVED&&e!==No.FilterType.FOCUSED||this.typeFilter===e||setTimeout((()=>{this.scrollToTop(!1)}));const s=this.typeFilter,n=e,a=i.ModuleContainer.resolve(Xo.TUnreadSubChatTabStateManager),r=a.convetFilterTypeToSubChatTabType(s),o=a.convetFilterTypeToSubChatTabType(n);a.isValidSubChatTabType(o)&&a.handleChangeSubtab(r,o),this.applyTypeFilter(e,t)}onLabelFilterChange(e){this.typeFilter===No.FilterType.UNREAD&&setTimeout((()=>{this.scrollToTop(!1)})),this.applyLabelFilter(e)}rerenderList(){this.signalRenderList()}async onPreviewChange(e,t){if(!e||!t)return;const s=e.convId;if(this.listRawAll.add(s),xo.a.isThreadHidden(s))return void(this.listHiddens.includes(s)||this.listHiddens.push(s));let i=s,n=!1,a=!1,r=!1;if(await Bo.ConvList.isOATypeAsync(s)){if(!(await Bo.ConvList.checkIfOAShouldShowInConvList(s))&&!this.listVisible.includes(s))return}else if(Bo.ConvList.isStrangerV2(s)&&(n=!0,this.listStrangers.includes(s)||(this.logger.zsymb(0,"6ldBld",`first new stranger msg ${s}`),this.listStrangers.push(s)),!this.isUnboxStrangerAccount())){const t="0"==e.fromUid||this.convDataManager.isRespondedByMeSync(s),n=this.listVisible.includes(s);t||(n&&(r=!0,this.listVisible=this.listVisible.filter((e=>e!==s))),this.updateNewestStrangerId(this.listStrangers),i=R.CONV_FILTER.STRANGER),t&&!n&&(a=!0,this.listVisible.unshift(s),this.newestStrangerId===s&&this.updateNewestStrangerId(this.listStrangers))}const[o,l]=Bo.ConvList.insertToProperPosition(this.listVisible,i,this.getAlterId());this.listVisible=o,e.msgId!==R.FAKE_DRAFT_MSG_ID||e.draft||(this.listVisible=this.listVisible.filter((e=>e!==s)),r=!0);const c=zo.a.getLabelObjByConversaionId(s),d=c&&c.id&&this.labelFilters.includes(""+c.id),u=n&&this.labelFilters.includes(Fo.g),h=d||u,g=l||a||r,m="server"===e.src;if(this.typeFilter===No.FilterType.ALL)this.addTabAllFiltered(s,h,g,m);else if(this.typeFilter===No.FilterType.UNREAD)this.addTabUnreadFiltered(s,h,n,m);else if(this.typeFilter===No.FilterType.STRANGER){const e=d||!this.labelFilters.length,t=n&&e;this.addTabStrangerFiltered(s,t,m)}else if(this.isEnableArchivedChat){const e=this.typeFilter===No.FilterType.ARCHIVED;this.typeFilterSrc===No.FilterSrcType.UNREAD?(Yo.a.isArchivedChat(s)&&e||!Yo.a.isArchivedChat(s)&&!e)&&!xo.a.isThreadHidden(s)&&this.addTabUnreadFiltered(s,h,n,m):this.listFiltered=this.genListArchivedChat(this.listVisible,e,this.labelFilters),this.signalRenderList("all",m)}this.smartDispatchEvent(so.c.PreviewChanged,(()=>new so.a(so.c.PreviewChanged,e.convId,{changedItem:e})))}addTabAllFiltered(e,t,s,i=!1){if(t){const[t,s]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList("all",i))}else s&&this.signalRenderList("all",i)}addTabUnreadFiltered(e,t,s,i=!1){if(this.listFiltered.includes(e)||!Jo.default.isMyMessage(this.previewManager.getPreviewByIDSync(e)))if(t)this.addConvToUnreadFilterV2(e,i);else{if(this.labelFilters.length)return;this.isUnboxStrangerAccount()||!s?this.addConvToUnreadFilterV2(e,i):this.addConvToUnreadFilterV2(R.CONV_FILTER.STRANGER,i)}}addTabStrangerFiltered(e,t,s=!1){if(!t)return;const[i,n]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());n&&(this.listFiltered=i,this.signalRenderList("all",s))}addConvToUnreadFilterV2(e,t=!1){const[s,i]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());i&&(this.listFiltered=this.safeSortConvList(s,!1),this.signalRenderList("all",t))}onPinChange(e){let t=!1;for(let s=0;s<e.length;s++){const i=e[s].priority,n=e[s].id;i?(this.onPreviewChange({convId:n},[]),t=!1):(t=!0,(!this.previewManager.getPreviewByIDSync(n)||!this.convDataManager.isRespondedByMeSync(n)&&Bo.ConvList.isStrangerV2(n))&&(this.listVisible=this.listVisible.filter((e=>e!==n))))}t&&(this.listVisible=this.safeSortConvList(this.listVisible,!1),(this.typeFilter!==No.FilterType.ALL||this.labelFilters.length)&&(this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0))),this.signalRenderList()}onHiddenChat(e,t){const s=this.convDataManager.getConvByIdSync(e);if(this.logger.zsymb(0,"ReNYFR","onHiddenChat ",e,t,!!s),t)this.listHiddens.push(e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.signalRenderList();else{if(!s&&!Co.a.PinDataManager.isPinned(e))return;if(this.listHiddens=this.listHiddens.filter((t=>t!==e)),this.isUnboxStrangerAccount()||!Bo.ConvList.isStrangerV2(e)||this.listStrangers.includes(e)){const[t,s]=Bo.ConvList.insertToProperPosition(this.listVisible,e,this.getAlterId());this.listVisible=t}else this.listStrangers.push(e);if(this.listFiltered){const[t,s]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());this.listFiltered=t,this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===No.FilterType.ARCHIVED,this.labelFilters))}}this.signalRenderList()}getCurrentFilter(){return{type:this.typeFilter,labels:this.labelFilters}}getRecentContacts(){const e=[];return this.listRawAll.forEach((t=>{const s=this.convDataManager.getConvByIdSync(t);s&&e.push(s)})),e}getRecentContactWithId(e){if(this.listRawAll.has(e)){return this.convDataManager.getConvByIdSync(e)||null}return null}addConvToLabel(e,t){let s=zo.a.getItem(t);ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.MANAGE_LABEL,params:{view:Vo.b.ADD_CONVERSATION,info:s}}),e&&(e.preventDefault(),e.stopPropagation()),as.default.logAction(14521)}selectConversation(e){if(Ho.b.startPerf(Ho.a),e.userId===R.CONV_FILTER.MEDIA)return void this.logger.zsymb(18,"xH6xfT","No handler for mediabox. This feat disable!!!");if(e.userId===R.CONV_FILTER.STRANGER)return void(2==Number(Rt.default.getConvUXVersion())?this.applyTypeFilter(No.FilterType.STRANGER):this.labelDataManager.onSelectLabel(Fo.g));const t=this.sidebarController.getState(Go.c).selectedId;e.userId===t&&e.userId!==R.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object($t.f)({type:Ai.ConversationListActions.SELECT_CONV_MINOR,payload:e}):(this.convUIListContainer&&this.convUIListContainer.focus(),e.userId===mi.default.sendToMeId&&(ki.g.getFlagForCurrentUser(this.currUser.userId,ll)||(rt.p.getHasShownSendToMeTip()?ki.g.setFlagForCurrentUser(this.currUser.userId,ll,1):setTimeout((()=>{Fi.default.send(Ai.ConversationListActions.SHOW_BUBBLE_DOT),rt.p.setHasShownSendToMeTip(!0)}),144e5)),Wo.b.getCurrentStepKey()!==Wo.a.UPLOAD_IMAGES||this.showedOnboarding||(Wo.b.show(),this.showedOnboarding=!0),as.default.logAction(13901)),e.userId===R.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object($t.f)({type:Ai.SideBarActions.SELECT_FRIEND_CENTER,payload:Object(f.a)({},e)}):i.ModuleContainer.resolve(Ii.b).openConversation(e.userId,Ii.c.fromConvItem(e))),this.logActionSelectConv(e.userId)}showBroadCastMsgModal(){var e;if(!Rt.default.checkBroadcastTime())return void rs.default.createError(os.a.str("STR_BROADCAST_OVER_LIMIT_TIP"));let t=!0;1===this.labelFilters.length&&(t=zo.a.getItem(this.labelFilters[0])||!0),null!==(e=mi.default.broadcast_resend_config)&&void 0!==e&&e.enable?ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.BROADCAST_RESEND,params:t}):ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.BROADCAST_COMPSE,params:{label:t}}),as.default.logAction(1453102)}markAsRead(e,t=null){e&&(e.preventDefault(),e.stopPropagation()),as.default.logAction(164),Rt.default.isShowMarkAsReadAgain()?Ko.ConfirmManagerV2.openConfirm({windowId:Go.c,name:R.MODAL_CONFIRM.confirmIdentities,params:{message:os.a.str("STR_MARK_READ_CONFIRM_TEXT"),okText:os.a.str("STR_CONFIRM"),okType:"primary",cancelText:os.a.str("STR_LOGOUT_NO"),onOk:e=>{Rt.default.setShowMarkAsReadAgain(!(e&&e.dont_show_mark_as_read)),this.markConvsAsRead(t)},options:[{default_val:!1,key:"dont_show_mark_as_read",title:"STR_DONT_SHOW_AGAIN"}]}}):this.markConvsAsRead(t)}scrollToTop(e){const t=qo.b.instance().getConvList();t&&t.scrollToTop(e)}scrollToConv(e){const t=qo.b.instance().getConvList();t&&t.scrollToConversation(e)}openInNewWindow(e,t){if(!e||!e.userId)return;const s=this.menuRef[Fo.b];s&&s.openInNewWindow&&(s.updateTargetInfo(e),s.openInNewWindow(t))}getStrangerInfo(){let e="";if(this.newestStrangerId){const t=this.previewManager.getPreviewByIDSync(this.newestStrangerId);e=t?t.messageTime:""}return this.logger.zsymb(0,"xAesZm","getStrangerInfo ",this.newestStrangerId,e),{messageTime:e}}getTopMostConv(){return this.typeFilter!==No.FilterType.ALL||this.labelFilters.length?this.listFiltered[0]:this.listVisible[0]}isPreviewLoaded(){return this.loaded}addListener(){setTimeout((()=>{this.labelDataManager.addEventListener(Uo.d.SelectedLabelChange,(e=>{this.onLabelFilterChange(e.payload)})),this.labelDataManager.addEventListener(Uo.d.LabelAddConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"add")})),this.labelDataManager.addEventListener(Uo.d.LabelRemoveConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"remove")}));const e=i.ModuleContainer.resolve(jo.PreviewDataManager);e.addEventListener(so.b.DoneLoadPreview,(e=>{this.onLoadPreview(e.payload)})),e.addEventListener(so.b.DoneMigratePreview,(()=>{this.onMigratedPreview()})),e.addEventListener(so.b.PreviewChanged,(e=>{const{changedItem:t,all:s}=e.payload;this.onPreviewChange(t,s)})),e.addEventListener(so.b.DraftChanged,(e=>{})),this.convDataManager.addEventListener(so.b.DeleteConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(so.b.EmptyConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(so.b.LeaveGroup,(e=>{this.moveConvOutConvList(e.convId)})),this.pinDataManager.addEventListener(so.b.ChangePinConv,(e=>{this.onPinChange(e.payload)})),this.archivedChatManager.addEventListener(so.b.UpdateListArchivedChat,(e=>{this.updateListArchivedChat()})),this.archivedChatManager.addEventListener(so.b.OnOffArchivedChat,(e=>{this.onOffArchivedChat(e.payload.status)})),this.muteDataManager.addEventListener(so.b.MuteChanged,this.handleMuteChange),ns.default.subscribeEventFriend(R.EventFriend.ADD_FRIEND,(({userId:e})=>{let t=0;this.listStrangers.includes(e)&&(t++,this.listStrangers=this.listStrangers.filter((t=>t!==e)),e==this.newestStrangerId&&(t++,this.updateNewestStrangerId(this.listStrangers))),this.onPreviewChange({convId:e},[]);const s=ns.default.isFriend(e);this.logger.zsymb(0,"02gLd3",`on add friend ${e} ${t} ${s}`)})),ns.default.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,(({userId:e})=>{let t=0;!this.listStrangers.includes(e)&&this.listVisible.some((t=>t===e))&&(t++,this.listStrangers.push(e)),this.logger.zsymb(0,"K-fB-Q",`on remove friend ${e} ${t}`)})),ns.default.subscribeEventFriend(R.EventFriend.DOWNGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),ns.default.subscribeEventFriend(R.EventFriend.UPGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),this.conversationUIUpdater.addEventListener(jo.ConversationUIUpdaterEvent.FLUSH_QUEUE_LIST,(()=>{this.smartDispatchEvent(so.c.SignalRenderList,(()=>new so.g(this.listVisible.slice(0,100))))})),this.conversationUIUpdater.addEventListener(jo.ConversationUIUpdaterEvent.SIGNAL_RENDER_LIST,(()=>{this.smartDispatchEvent(so.c.SignalRenderList,(()=>new so.g(this.listVisible.slice(0,100))))}))}),0)}addToListFiltered(e,t=!1){e.forEach((e=>{if(t){const t=this.unreadDataManager.getUnreadByConvIdSync(e);if(!t||!t.smsUnreadCount&&!t.unreadMark)return}const[s]=Bo.ConvList.insertToProperPosition(this.listFiltered,e);this.listFiltered=s}))}applyTypeFilter(e,t=!1){if(this.typeFilter===e&&!t)return;this.logger.zsymb(0,"tY8NLf","applyTypeFilter ",e,t);const s=this.typeFilter;switch(this.typeFilter=e,e){case No.FilterType.ALL:if(0!==this.labelFilters.length){if(this.listFiltered=Bo.ConvList.filterByLabel(this.listVisible,this.labelFilters),this.labelFilters.includes(Fo.g)){let e=this.listStrangers;this.showStrangerNROnly()&&(e=Bo.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}else this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters);this.addLikeConvToFilterListV2(this.listFiltered,this.labelFilters)}break;case No.FilterType.UNREAD:if(0!==this.labelFilters.length){const e=s==No.FilterType.ALL?this.listFiltered:this.listVisible;this.listFiltered=Bo.ConvList.filterByLabel(e,this.labelFilters),this.labelFilters.includes(Fo.g)?this.addToListFiltered(this.listStrangers):this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.listFiltered=Bo.ConvList.filterByUnread(this.listFiltered),this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0)}else this.listFiltered=Bo.ConvList.filterByUnread(this.listVisible),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case No.FilterType.STRANGER:this.listFiltered=Bo.ConvList.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=Bo.ConvList.filterByResponsed(this.listFiltered,!1));break;case No.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,this.labelFilters);break;case No.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,this.labelFilters)}const i=this.getList({key:"all",version:0,extraData:{}});this.dispatchEvent(new so.h(i.slice(0,50))),this.signalRenderState(),this.signalRenderList()}applyLabelFilter(e){if(this.labelFilters===e)return;switch(this.logger.zsymb(0,"JSi8T_","applyLabelFilter ",e.join("-")),this.labelFilters=e.map((e=>""+e)),this.typeFilter){case No.FilterType.ALL:if(this.listFiltered=Bo.ConvList.filterByLabel(this.listVisible,this.labelFilters),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.addLikeConvToFilterListV2(this.listFiltered,e),this.labelFilters.some((e=>e==Fo.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=Bo.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}break;case No.FilterType.UNREAD:if(this.listFiltered=Bo.ConvList.filterByLabel(this.listVisible,e),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.labelFilters.some((e=>e==Fo.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=Bo.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}this.listFiltered=Bo.ConvList.filterByUnread(this.listFiltered),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case No.FilterType.STRANGER:this.listFiltered=Bo.ConvList.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=Bo.ConvList.filterByResponsed(this.listFiltered,!1));break;case No.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,e);break;case No.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,e)}const t=this.getList({key:"all",version:1,extraData:{}});this.dispatchEvent(new so.i(t.slice(0,50))),this.signalRenderState(),this.signalRenderList()}showStrangerNROnly(){return!this.isUnboxStrangerAccount()}isUnboxStrangerAccount(){const e=Qo.c.isUnboxStranger();return this.logger.zsymb(0,"9V80ms","isUnboxStrangerAccount ",e),e}doAddStrangerHasLabel(e,t){if(t.length){const s=Bo.ConvList.filterByLabel(this.listStrangers,t);if(s.length){const t=new Set(s);for(let s=0;s<e.length;s++)t.has(e[s])&&t.delete(e[s]);this.addToListFiltered(t)}}return e}isConvExists(e){const t=this.convDataManager.getConvByIdSync(e);return!!(null!=t&&t.firstSmsLocalId||null!=t&&t.lastSmsLocalId)}safeSortConvList(e,t=!0){const s=e.indexOf(R.CONV_FILTER.STRANGER);if(-1!==s){e[s]=this.newestStrangerId;const i=(e=Bo.ConvList.sortConvId(e,t,!0)).indexOf(this.newestStrangerId);e[i]=R.CONV_FILTER.STRANGER}else e=Bo.ConvList.sortConvId(e,t,!0);return e}isValidFakeConv(e,t,s){if(e.some((e=>e==s))||xo.a.isThreadHidden(s))return!1;const i=zo.a.getLabelObjByConversaionId(s);return!(!i||!t.some((e=>e==i.id)))}isValidFakeConvV2(e,t){if(!t||e.some((e=>e==t))||xo.a.isThreadHidden(t))return!1;return!(t&&t.startsWith(R.GROUPID_PREFIX))||!!Zo.default.getGroupByIdSync(t)}addLikeConvToFilterListV2(e,t){if(t.length&&this.typeFilter!==No.FilterType.UNREAD){this.logger.zsymb(0,"reU_tQ","addLikeConvToFilterListV2 ",t);for(const s of t){const t=this.labelDataManager.getLabelById(s);if(t&&t.conversations)for(const s of t.conversations)this.isValidFakeConvV2(e,s)&&e.push(s)}}}markConvsAsRead(e){const t=[],s=0===this.labelFilters.length;this.logger.zsymb(0,"9wMURX",`markConvsAsRead #1  ${null==e?void 0:e.join("-")}`),this.listRawAll.forEach((i=>{const n=this.unreadDataManager.getUnreadByConvIdSync(i);if(n&&(n.smsUnreadCount>0||n.unreadMark)){if(this.logger.zsymb(0,"wgSSwD",`markConvsAsRead #2, ${i}, ${n.smsUnreadCount}`),e&&!e.hasOwnProperty(i)||i===R.FAKE_CONVERSATION_ID.FRIEND_CENTER)return;const a=zo.a.getLabelObjByConversaionId(i)||{},r=this.convDataManager.getConvByIdSync(i)||{userId:i};(s||this.labelFilters.some((e=>e==a.id))||Bo.ConvList.isInStrangerBoxV2(i)&&this.typeFilter===No.FilterType.STRANGER)&&t.push(r)}})),this.logger.zsymb(0,"cHCGJL",`markConvsAsRead #3 ${t.length} ${t.map((e=>e.userId)).join("-")}`),t.length>0&&(Fi.default.send(Ai.SideBarActions.MARK_AS_READ,{conversations:t}),as.default.logAction(1453304))}onLoadPreview(e){this.logger.zsymb(0,"WLBSO0",`onload Preview 1: ${this.listRawAll.size}`);let t=e.map((e=>e.convId));const s=Rt.default.getConvUXVersion();this.isEnableArchivedChat=!!Yo.a.isEnableArchivedChat()&&"3"==s,this.typeFilter=this.isEnableArchivedChat?No.FilterType.FOCUSED:No.FilterType.ALL,this.listRawAll.size&&this.listRawAll.forEach((e=>{t.some((t=>t===e))||t.push(e)})),this.listRawAll=new Set(t);const i=mi.default.sendToMeId;this.listRawAll.has(i)||(t.push(i),this.listRawAll.add(i)),this.logger.zsymb(0,"zy9X9y",`onload Preview 2: ${t.length}`),Bo.ConvList.groupConversation(t).then((e=>{if(this.logger.zsymb(0,"YyjQNV",`grouped list #1: \n\t\t\t\t${e.hidden.length}\n\t\t\t\t- ${e.stranger.length}\n\t\t\t\t- ${e.outdate.length}\n\t\t\t\t- ${e.visible.length}\n\t\t\t`),mi.default.stagingAccount)for(const i in e)this.logger.zsymb(0,"t6zZgf",`${i}: ${e[i]}`);this.listStrangers=e.stranger,this.listHiddens=e.hidden;const t=this.addStrangersToVisible(e.visible,this.listStrangers);let s=t;if(this.listVisible.length){this.logger.zsymb(0,"bjCCfL",`preview changed while group csc #1: ${this.listVisible}`),s=this.listVisible;const e=new Set(this.listVisible);t.forEach((t=>{e.has(t)||s.push(t)}))}this.listVisible=this.safeSortConvList(s,!1),this.initMyCloud(),this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===No.FilterType.ARCHIVED,this.labelFilters)),this.logger.zsymb(0,"YCO2uY",`visible sorted #1: ${this.listVisible}`),this.loaded=!0,this.signalRenderList(),this.signalRenderState(),this.dispatchEvent(new so.a(so.c.LoadPreviewDone,"",this.listVisible.slice()))}))}onMigratedPreview(){this.logger.zsymb(0,"LBQVAJ",`onMigratedPreview #1: ${this.listVisible}`);const e=Rt.default.getConvUXVersion();this.isEnableArchivedChat=!!Yo.a.isEnableArchivedChat()&&"3"==e,this.typeFilter=this.isEnableArchivedChat?No.FilterType.FOCUSED:No.FilterType.ALL;const t=mi.default.sendToMeId;this.listRawAll.has(t)||this.initMyCloud(),this.convDataManager.getConvByIdSync(t)&&!this.listVisible.includes(t)&&(this.logger.zsymb(0,"5n3l-C","onMigratedPreview #2"),this.onPreviewChange({convId:t},[])),this.loaded=!0,this.signalRenderList(),this.signalRenderState()}initMyCloud(){const e=ki.g.getFlagForCurrentUser(null,"z_sendtome"),t=mi.default.sendToMeId,s=!(mi.default.isOffSendToMe||e&&1!==e);if(this.logger.zsymb(0,"Nf-Eo1","initMyCloud",e,mi.default.isOffSendToMe),this.listVisible.some((e=>e===t))){const e=this.convDataManager.getConvByIdSync(t);e&&e.pinned?as.default.logAction(1390703):(ki.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),as.default.logAction(1390702))}else if(s){const e=Co.a.PinDataManager.getTotalPinnedConversation()>=mi.default.limit_pin_messages,s=mi.default.auto_pin_send2me&&!ki.g.getFlagForCurrentUser(null,"z_sendtome_pinned")&&!e;this.convDataManager.createEmptyConvForUser(t,s?1:0,R.CONV_OT_STATE.none,{}),s&&(Co.a.PinDataManager.pin([t]),ki.g.setFlagForCurrentUser(null,"z_sendtome_pinned",1)),ki.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),this.onPreviewChange({convId:t},[])}}addStrangersToVisible(e,t){if(!t||!t.length)return e;if(this.isUnboxStrangerAccount())return e.concat(t);{const s=Bo.ConvList.filterByResponsed(t,!1);if(s.length){this.newestStrangerId=Bo.ConvList.getNewestConvFromIds(s);e.includes(R.CONV_FILTER.STRANGER)||e.push(R.CONV_FILTER.STRANGER)}return t.forEach((t=>{this.convDataManager.isRespondedByMeSync(t)&&e.push(t)})),e}}onLabelChangeConvs(e,t,s){if(this.logger.zsymb(0,"T9qIcD","onLabelChangeConvs",t.length,e),t.length&&this.labelFilters.includes(e))if("add"==s){const e=t.filter((e=>!this.listFiltered.includes(e)&&!this.listHiddens.includes(e)));if(!e.length)return;this.listFiltered=[...this.listFiltered,...e],this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!1),this.signalRenderList()}else{let e=!1;t.forEach((t=>{const s=zo.a.getLabelObjByConversaionId(t),i=s?s.id:null;this.labelFilters.includes(""+i)||(this.listFiltered=this.listFiltered.filter((e=>e!==t)),e=!0)})),e&&this.signalRenderList()}}moveConvOutConvList(e){this.logger.zsymb(0,"tNHbM7","moveConvOutConvList",e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.listStrangers=this.listStrangers.filter((t=>t!==e)),e!==this.newestStrangerId||this.isUnboxStrangerAccount()||this.updateNewestStrangerId(this.listStrangers),this.signalRenderList()}getAlterId(){return new Map([[R.CONV_FILTER.STRANGER,this.newestStrangerId]])}updateNewestStrangerId(e){if(this.isUnboxStrangerAccount())return;const t=Bo.ConvList.filterByResponsed(e,!1),s=this.newestStrangerId;if(this.newestStrangerId=Bo.ConvList.getNewestConvFromIds(t),this.newestStrangerId||(this.listVisible=this.listVisible.filter((e=>e!==R.CONV_FILTER.STRANGER)),this.signalRenderList()),this.previewManager.updateStrangerBox(this.newestStrangerId),s!==this.newestStrangerId&&this.newestStrangerId){const[e,t]=Bo.ConvList.insertToProperPosition(this.listVisible,R.CONV_FILTER.STRANGER,this.getAlterId());this.listVisible=e,this.signalRenderList()}}async rebuildList(){this.logger.zsymb(0,"DVqXT-",`rebuildList 1: ${this.listRawAll.size} ${this.listVisible.length} ${this.listStrangers.length}`),this.listStrangers=[],this.listVisible=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="";const e=Array.from(this.listRawAll),t=await Bo.ConvList.groupConversation(e);if(this.logger.zsymb(0,"xAmzKv",`grouped list #2: \n\t\t\t${t.hidden.length}\n\t\t\t- ${t.stranger.length}\n\t\t\t- ${t.outdate.length}\n\t\t\t- ${t.visible.length}\n\t\t`),mi.default.stagingAccount)for(const n in t)this.logger.zsymb(0,"JrTdtm",`${n}:, ${t[n]}`);this.listStrangers=t.stranger,this.listHiddens=t.hidden;const s=this.addStrangersToVisible(t.visible,this.listStrangers),i=this.safeSortConvList(s,!1);this.listVisible=i,this.logger.zsymb(0,"xX2P6s",`visible sorted #2: ${this.listVisible}`),this.labelFilters.length&&this.applyLabelFilter(this.labelFilters),this.typeFilter!==No.FilterType.ALL&&this.applyTypeFilter(this.typeFilter,mi.default.should_force_genlist_conv),this.signalRenderList(),this.signalRenderState()}handleUserPackageChange(){this.logger.zsymb(0,"AEyQAR",`handleUserPackageChange: ${ns.default.isMeBAAccount()}}`),this.rebuildList()}signalRenderList(e="all",t=!1){this.logger.zsymb(12,"HciH9G","signalRenderList shouldBatching",t),t?this.conversationUIUpdater.signalRenderList(this.name,e):(Object(hs.j)(this.name,e),this.smartDispatchEvent(so.c.SignalRenderList,(()=>new so.g(this.listVisible.slice(0,100)))))}signalRenderState(){Object(hs.h)(this.name,Go.c)}logActionSelectConv(e){const t=this.labelFilters.length>0;if(this.typeFilter===No.FilterType.UNREAD?(as.default.logAction(1453103),t||as.default.logAction(1453107)):this.typeFilter===No.FilterType.ALL?(as.default.logAction(1453104),t&&as.default.logAction(1453108)):this.typeFilter===No.FilterType.FOCUSED?as.default.logAction(1453501):this.typeFilter===No.FilterType.ARCHIVED&&as.default.logAction(1453502),t)as.default.logAction(1453105);else{as.default.logAction(1453106);for(let e=0;e<this.labelFilters.length;e++){if(parseInt(this.labelFilters[e])>0){as.default.logAction(1453109);break}}}this.typeFilter==No.FilterType.ARCHIVED&&Yo.a.sendTrackSrc(e,4,!1)}init(){}getItem(e){return e.key===Go.c?{labelFilters:this.labelFilters,typeFilter:this.typeFilter,loaded:this.loaded,isEnableArchivedChat:this.isEnableArchivedChat,typeFilterSrc:this.typeFilterSrc}:ol}getList(e){return e.key===Go.c||this.typeFilter==No.FilterType.ALL&&0===this.labelFilters.length?this.listVisible:this.listFiltered}onGetItemFailure(e){}onGetListFailure(e){}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Fo.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]}showConvActionMenu(e,t){if(t&&t.friendItem)return;if(t.userId===R.CONV_FILTER.STRANGER||t.userId===R.CONV_FILTER.MEDIA)return;const s=Object(f.a)({},t),i=s.userId;if(s&&!ho.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=ns.default.getProfileFriendByIdSync(i)||{},n=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.unreadMark=null==n?void 0:n.unreadMark,s.smsUnreadCount=null==n?void 0:n.smsUnreadCount}this.menuRef[Fo.b].updateTargetInfo(s),this.menuRef[Fo.b].showAction(Object(f.a)({},e))}bindUIContainer(e){this.convUIListContainer=e}cleanUpUIContainer(){this.convUIListContainer=null}getEnableArchivedChat(){return this.isEnableArchivedChat}getListFilterSrc(e){return this.typeFilterSrc===No.FilterSrcType.UNREAD?Bo.ConvList.filterByUnread(e):e}setTypeFilterSrc(e){if(this.typeFilterSrc!==e&&(this.typeFilterSrc=e,this.applyTypeFilter(this.typeFilter,!0),e===No.FilterSrcType.UNREAD)){const e=this.labelFilters.length>0?1453215:1453214;as.default.logAction(e)}}genListArchivedChat(e,t,s,i=!0,n=!0){let a=[];a=Bo.ConvList.filterByLabel(this.getListFilterSrc(e),s),s.length&&n&&this.typeFilterSrc!==No.FilterSrcType.UNREAD&&this.addLikeConvToFilterListV2(a,s);let r=this.getListFilterSrc(this.listStrangers).filter((e=>(Yo.a.isArchivedChat(e)&&t||!Yo.a.isArchivedChat(e)&&!t)&&!xo.a.isThreadHidden(e)));return s.includes(Fo.g)&&1==s.length?this.isUnboxStrangerAccount()||(r=Bo.ConvList.filterByResponsed(r,!1)):s.includes(Fo.g)||(r=Bo.ConvList.filterByLabel(r,s)),a=a.filter((e=>!(this.typeFilter===No.FilterType.ARCHIVED||!r.length||e!=R.CONV_FILTER.STRANGER)||(Yo.a.isArchivedChat(e)&&t||!Yo.a.isArchivedChat(e)&&!t)&&e!==R.CONV_FILTER.STRANGER&&!Bo.ConvList.isStrangerV2(e)&&!xo.a.isThreadHidden(e))),i&&(this.typeFilter===No.FilterType.ARCHIVED?a=a.concat(r):this.isUnboxStrangerAccount()||s.length?(this.isUnboxStrangerAccount()&&(null==s||!s.length)||null!=s&&s.length)&&(a=a.concat(r)):a=this.addStrangersToVisible(a,r)),a=a.filter(((e,t)=>a.indexOf(e)==t)),this.safeSortConvList(a,!1)}isChatVisible(e){return this.listVisible.includes(e)}updateListArchivedChat(){this.typeFilter==No.FilterType.FOCUSED?this.onTypeFilterChange(No.FilterType.FOCUSED,!0):this.typeFilter==No.FilterType.ARCHIVED&&this.onTypeFilterChange(No.FilterType.ARCHIVED,!0)}onOffArchivedChat(e){if(!mi.default.enable_archived_chat)return;const t=Rt.default.getConvUXVersion();this.isEnableArchivedChat&&e&&"2"==t&&(this.isEnableArchivedChat=!1,this.signalRenderState()),this.isEnableArchivedChat!=e&&(e||this.typeFilter!==No.FilterType.ARCHIVED&&this.typeFilter!==No.FilterType.FOCUSED?e&&this.onTypeFilterChange(No.FilterType.FOCUSED,!0):this.onTypeFilterChange(No.FilterType.ALL,!0),this.labelDataManager.onClearFilter(),this.setTypeFilterSrc(No.FilterSrcType.ALL),this.isEnableArchivedChat=e&&"3"==t,this.signalRenderState())}})||rl)||rl)||rl)||rl)||rl)||rl)||rl)||rl)||rl);var cl,dl=s("BR4E"),ul=s("R5gT"),hl=s("Xzw3"),gl=s("d+hT"),ml=s("uEOi"),pl=s("kTC5"),fl=s("4wTQ"),vl=s("ES/k"),bl=s("uAQs"),Il=s("WBqA"),yl=s("qa8q"),_l=s("vAzq");const Cl={isFocusSearchBox:!1,isFocusOnRecentSearch:!1,searchText:"",searchResult:{},searching:!1,conversation:null,highlightId:"",filter:{timeFrom:0,timeTo:Date.now()}},Ol=new ho.LocalId;var El=function(e){return e[e.STEP_CONTACT=0]="STEP_CONTACT",e[e.STEP_MESSAGES=1]="STEP_MESSAGES",e[e.STEP_FILES=2]="STEP_FILES",e[e.STEP_DIRECTORY=3]="STEP_DIRECTORY",e}(El||{});const Ml=e=>ho.default.md5(e);Object(Je.d)()(cl=Object(ko.b)(No.SearchController)(cl=function(e,t){return i.ModuleContainer.inject(io.b)(e,void 0,0)}(cl=function(e,t){return i.ModuleContainer.inject(jo.ConvInfoDataManager)(e,void 0,1)}(cl=function(e,t){return i.ModuleContainer.inject(jo.PreviewDataManager)(e,void 0,2)}(cl=Reflect.metadata("design:type",Function)(cl=Reflect.metadata("design:paramtypes",[void 0===io.b?Object:io.b,void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager,void 0===jo.PreviewDataManager?Object:jo.PreviewDataManager])(cl=class{constructor(e,t,s){this.convListController=e,this.convDataManager=t,this.previewDataManager=s,this.state=void 0,this.pageLoad=void 0,this.curQuery=void 0,this.cacheResSearch=void 0,this.countQuery=void 0,this.countTimeUseGlobalSearch=void 0,this.countSelectTopRes=void 0,this.cacheSearch=void 0,this.trackSearch=void 0,this.trackSearchVietnamese=void 0,this.lastTextSearch=void 0,this.lastTextSearchTs=void 0,this.isShowRecentSearch=void 0,this.isFirstLoadSuccess=void 0,this.isSearchingMsg=void 0,this.searchDelay=void 0,this.closeBySendingMsg=void 0,this.clearAdminMode=void 0,this.timeouResetDataMsg=void 0,this.searchResultList=void 0,this.recentSearchList=void 0,this.searchInput=void 0,this.loadingMore=void 0,this.loadingMoreFiles=void 0,this.oldestTime=void 0,this.functionSearchByName=void 0,this.timeoutLog=void 0,this._timeDebounceSearch=null,this.dataLoaded=void 0,this._sbc=null,this._removeSearchResult=(e,t)=>{const s=this.getSearchState();if(s&&!s.conversation&&s.searchResult)if(t){if(!s.searchResult.groups)return;const t=[...s.searchResult.groups];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(f.a)(Object(f.a)({},s),{},{searchResult:Object(f.a)(Object(f.a)({},s.searchResult),{},{groups:t})}));break}}else{if(!s.searchResult.friends)return;const t=[...s.searchResult.friends];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(f.a)(Object(f.a)({},s),{},{searchResult:Object(f.a)(Object(f.a)({},s.searchResult),{},{friends:t})}));break}}},this._recordedCPUUsageTs=void 0,this.name=No.SEARCH_CONTROLLER,this.key="windowId",this.state=Cl,this.pageLoad=0,this.curQuery="",this.countQuery=0,this.countTimeUseGlobalSearch=0,this.countSelectTopRes=0,this.cacheSearch={items:[],keywords:null},this.trackSearch=!1,this.trackSearchVietnamese=!1,this.lastTextSearch="",this.lastTextSearchTs=0,this.isShowRecentSearch=!1,this.searchDelay=this._getSearchDelaySetting(),this.closeBySendingMsg=!1,this.loadingMore=!1,this.loadingMoreFiles=!1,this.oldestTime=0,this.timeoutLog=null,this.isFirstLoadSuccess=!1,this.isSearchingMsg=!1,this.dataLoaded=null,this._innerSearchFunc=this._innerSearchFunc.bind(this),this.functionSearchByName=ho.default.throttle(this._innerSearchFunc,this.searchDelay),this.onKeywordChange=this.onKeywordChange.bind(this),this.loadMoreMessagesV2=this.loadMoreMessagesV2.bind(this),this.loadMessagesV2=this.loadMessagesV2.bind(this),this.loadMoreFiles=this.loadMoreFiles.bind(this),this.onKeyPressInput=this.onKeyPressInput.bind(this),this.onFocusInput=this.onFocusInput.bind(this),this.onBlurInput=this.onBlurInput.bind(this),this.onclickCloseSearchButton=this.onclickCloseSearchButton.bind(this),this.onClickClearSearch=this.onClickClearSearch.bind(this),this.onSearchKeyword=this.onSearchKeyword.bind(this),this.setRecentSearchFocusState=this.setRecentSearchFocusState.bind(this),this.focusSearchBox=this.focusSearchBox.bind(this),this.selectResult=this.selectResult.bind(this),this.onFileSelect=this.onFileSelect.bind(this),this.selectTopRes=this.selectTopRes.bind(this),this.listenEvents()}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve(No.SidebarController)),this._sbc}listenEvents(){Fi.default.subscribe(((e,t)=>{switch(e){case Ai.SideBarActions.FOCUS_SEARCH_INPUT:this.focusSearchBox();break;case Ai.FetchActions.FRIENDS_REMOVED:this._removeSearchResult(t,!1);break;case Ai.FetchActions.GROUP_LEAVE:this._removeSearchResult(t,!0);break;case Ai.SideBarActions.SEARCH_FILE_DONE:this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}));break;case Ai.SideBarActions.CLEAR_SEARCH:this.clearSearch();break;case Ai.ConversationListActions.SELECT_CONVERSATION:setTimeout((()=>{this.state.highlightId!==t.userId&&this.setRecentSearchFocusState(!1,!1,!0),t.callPoint!==Ii.a.JumpMessage&&this.updateStateOf("highlightId",null==t?void 0:t.userId)}),0)}}))}logSearch(e){rt.p.getDebugSearch().showLogSearchFlow}updateState(e,t=!0){this.state=e,t&&Object(hs.h)(this.name,Go.c)}isTextKey(e){return e.match(/^[a-zA-Z0-9!@#$%^&*)(+=._-|\\\[\]{}~`"\';:?/<>,-\s\n]$/)}isMultipleKeyPressed(e){return e.ctrlKey||e.metaKey||e.altKey}isKeywordStale(e){return vl.a.formatTextSearch(e)!==vl.a.formatTextSearch(this.state.searchText)}bindUIList(e,t){this._updateListRef(e,t)}cleanUpUIList(e){this._updateListRef(e,null)}bindUISearchInput(e){this.searchInput=e}cleanUpUISearchInput(){this.searchInput=null}_updateListRef(e,t){switch(e){case pl.c.SEARCH_RESULT:this.searchResultList=t;break;case pl.c.RECENT_SEARCH:this.recentSearchList=t}}resetState(){this.searchInput.value="",this.updateState(Object(f.a)({},Cl))}updateStateOf(e,t){this.state.hasOwnProperty(e)&&this.state[e]!==t&&("searchText"===e&&(this.searchInput.value=t),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{[e]:t})))}onKeyPressInput(e){if(this._isSelectAllSearchText()&&this.searchResultList&&this.isTextKey(e.key)&&!this.isMultipleKeyPressed(e)&&(this.searchResultList.openTabAll(),this.searchResultList.resetContactList()),e.which==R.K_BACK_SPACE?this.state&&this.state.searchText&&""!==this.state.searchText&&as.default.logAction(12307):""===this.state.searchText&&!this.timeoutLog&&this.isTextKey(e.key)&&(this.timeoutLog=setTimeout((()=>{this.timeoutLog=null,as.default.logAction(1232002)}),3e3)),e.which==R.K_ESC)!0===this.isShowRecentSearch&&(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusOnRecentSearch:!1,isFocusSearchBox:!1})),this.searchInput&&this.searchInput.blur(),this.onCloseSearch()),""!=this.searchInput.value?this.clearSearch(!1):this.clearSearch(!0);else if(e.which==R.K_ENTER){let e=this.searchResultList||this.recentSearchList;if(e&&this.state.searchText){let t=e.selectFocusedConversation(!0);setTimeout((()=>{this.state.conversation?this.focusSearchBox():xo.a.isThreadHidden(t)||Fi.default.send(Ai.ChatBoxActions.FOCUS_INPUT,{userId:t,windowId:Go.c})}),0)}}else if(e.which==R.K_UP||e.which==R.K_DOWN){this.searchResultList&&as.default.logAction(12317);let t=this.searchResultList||this.recentSearchList;t&&(e.stopPropagation(),e.preventDefault(),e.which==R.K_UP?t.moveUp():t.moveDown())}}onAbortSearch(){ul.a.getInstance().abortSearch()}onKeywordChange(e,t){let s="";if(s=!e&&t?t:e.target.value,s&&(s=ho.default.ZSafeFunction((()=>s.normalize()),s)),this.countTimeUseGlobalSearch||(this.countTimeUseGlobalSearch=Sr.a.now(),this.countSelectTopRes=0),s){const e=vl.a.formatTextSearch(this.lastTextSearch),t=vl.a.formatTextSearch(s);ho.default.log("searching: true"),mi.default.stagingAccount&&this._checkOnAdminMode(s),this.trackSearch||(this.trackSearch=!0,as.default.logAction(12318)),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchText:s})),this.countQuery=Ol.next(),this.functionSearchByName(s,this.countQuery,e!==t)}else{this._resetCacheResultSearch();ul.a.getInstance().abortSearch(),this.clearSearch(!1)}}onFocusInput(){Il.a.onNewSession(Go.c),this.searchInput&&""!==this.searchInput.value&&this.searchInput.select(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusSearchBox:!0})),as.default.logAction(1232001)}onBlurInput(){setTimeout((()=>{this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusSearchBox:!1})),this.searchInput&&""==this.searchInput.value&&this.qosLogSearch()}),20)}onclickCloseSearchButton(e){this.setRecentSearchFocusState(!1),this.onCloseSearch(),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),as.default.logAction(1232003),e&&(e.stopPropagation(),e.preventDefault())}onClickClearSearch(){rt.p.resetGlobalSearchMode(),this.state.conversation&&as.default.logAction(12314),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),this.focusSearchBox(),as.default.logAction(1232006)}onSearchKeyword(e){"string"==typeof e&&this.searchInput&&(this.searchInput.value=e,this.onKeywordChange(null,e),ml.a.addCacheKeyword(e))}onRemoveKeyword(e){"string"==typeof e&&ml.a.removeCacheKeyword(e)}onFileSelect(e){null!=e&&e.msgId&&(this.updateStateOf("highlightId",e.msgId),this.state.searchText&&ml.a.addCacheKeyword(this.state.searchText))}setRecentSearchFocusState(e,t=!1,s=!1){if(!s){const t=this.sidebarController.getSelectedId();if(this.state.isFocusOnRecentSearch===e||t&&this.state.highlightId===t&&!e)return}this.state.isFocusOnRecentSearch=e,e&&(this.closeBySendingMsg=!1),Object(hs.h)(this.name,Go.c)}onCloseSearch(){var e,t;as.default.logAction(1232004),0==(null===(e=this.state.searchResult)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.length)&&as.default.logAction(1232202),this.qosLogSearch()}focusSearchBox(e=!1){this.searchInput&&(this.searchInput.focus(),e&&setTimeout((()=>{this.searchInput.select()}),0))}isSearchMode(){return!!(this.state.searchText||this.state.isFocusOnRecentSearch||this.state.isFocusSearchBox)}openRecentSearch(){this.searchInput?this.searchInput.focus():this.setRecentSearchFocusState(!0)}loadCachedMessages(e,t,s){var i,n;if(!this.dataLoaded)return void(s&&s(null,-1));let a="";if(!this.state.searchText)return;a=this.state.searchText;const r=()=>!(!this.state.searchText||!this.isKeywordStale(a)),o=!(!e||!e.timeFrom&&!e.timeTo&&"string"!=typeof e.sender),l=[],c=t?this.dataLoaded.indexCurrent:0,d=Math.min(c+20,this.dataLoaded.allSearchedMsgs.length);if(t||delete this.dataLoaded.oldestIndex,e&&e.timeFrom&&this.dataLoaded.oldestIndex&&d>=this.dataLoaded.oldestIndex)return void(s&&s(null,-1,!1));if(d<=c)return void(s&&s(null,-1,!1));this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!0}));let u=this.dataLoaded.allSearchedMsgs.slice(c,d);this.dataLoaded.indexCurrent=d;const h=i=>{let n=[];if(this.loadingMore=!1,this.isSearchingMsg=!1,r())s&&s(null,-1);else if(i&&i.listConv&&i.arr){const c=new Map(this.convDataManager.getAllConvSync().map((e=>[e.userId,e])));for(let e=0;e<i.listConv.length;++e){const t=i.listConv[e],s=c.get(t);s&&!xo.a.isThreadHidden(t)&&(i.arr[e].conversation=s)}if(i.arr.forEach((t=>{if(o){if(!t.message)return;if(e&&"string"==typeof e.sender&&e.sender!==t.message.fromUid)return;if(e&&e.timeFrom&&e.timeFrom>t.message.sendDttm)return void(this.dataLoaded.oldestIndex=this.dataLoaded.indexCurrent);if(e&&e.timeTo&&e.timeTo<t.message.sendDttm)return}Object.keys(t.conversation).length>1&&n.push(t)})),Array.prototype.push.apply(l,n),!r()&&this.isFirstLoadSuccess){if(t&&this.state.searchResult.messages){var a;const e=null===(a=this.state.searchResult.messages[this.state.searchResult.messages.length-1])||void 0===a?void 0:a.message;e&&e.sendDttm<i.maxTime?(n=this.state.searchResult.messages.concat(n),n=n.sort(((e,t)=>t.message.sendDttm-e.message.sendDttm))):n=this.state.searchResult.messages.concat(n)}this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{isMoreMsg:d<this.dataLoaded.allSearchedMsgs.length,messages:n}),searching:!1}));const r=!(o&&e.timeFrom&&d>=this.dataLoaded.allSearchedMsgs.length);s&&s(l,this.pageLoad,r)}}};dl.a.logTrace(`load more msg with key ${Ml(a)} - msgID length: ${u.length} - ${d}/${null===(i=this.dataLoaded)||void 0===i||null===(n=i.allSearchedMsgs)||void 0===n?void 0:n.length}`),this.isSearchingMsg=!0;ul.a.getInstance().getMessages(u,r).then((e=>{h(e)})).catch((e=>{s&&s(null,-1)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}))}))}loadMessagesV2(e,t=!1,s){return this.loadCachedMessages(e,t,s)}loadMoreMessagesWithMsgIdsLoaded(e,t=!1,s){return this.loadCachedMessages(e,t,s)}isCanLoadMoreWithMsgIdsLoaded(){return!!(this.dataLoaded&&ho.default.valueValid(this.dataLoaded.indexCurrent)&&ho.default.valueValid(this.dataLoaded.allSearchedMsgs))&&!(this.dataLoaded.allSearchedMsgs.length<=this.dataLoaded.indexCurrent)}loadMoreMessagesWithRange(e,t,s,i){var n,a,r;let o=this.state.searchText;if(!o)return;let l=null===(n=this.searchResultList)||void 0===n?void 0:n.getRange(!t);if(!this.oldestTime||l.timeTo<this.oldestTime)return;const c=!(!i||!i.timeFrom&&!i.timeTo&&"string"!=typeof i.sender),d=()=>!(!this.state.searchText||!this.isKeywordStale(o));this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:t?null===(a=this.state.searchResult)||void 0===a?void 0:a.messages:null,isMoreMsg:!!t&&(null===(r=this.state.searchResult)||void 0===r?void 0:r.isMoreMsg)}),searching:!0}));const u=e=>{this.isSearchingMsg=!1;let n=[],a=[];if(d())return this.pageLoad++,void(s&&s(null,-1));if(!e||!e.listConv||!e.arr)return void(s&&s(null,-1));const r=new Map(this.convDataManager.getAllConvSync().map((e=>[e.userId,e])));for(let t=0;t<e.listConv.length;++t){const s=e.listConv[t],i=r.get(s);i&&!xo.a.isThreadHidden(s)&&(e.arr[t].conversation=i)}e.arr.forEach((e=>{c&&i&&"string"==typeof i.sender&&i.sender!==e.message.fromUid||Object.keys(e.conversation).length>1&&a.push(e)})),Array.prototype.push.apply(n,a),t&&(a=this.state.searchResult.messages.concat(a)),this.dataLoaded?(e.dataLoaded.allSearchedMsgs&&(this.dataLoaded.allSearchedMsgs=this.dataLoaded.allSearchedMsgs.concat(e.dataLoaded.allSearchedMsgs)),e.dataLoaded.indexCurrent&&(this.dataLoaded.indexCurrent+=e.dataLoaded.indexCurrent)):this.dataLoaded=e.dataLoaded;const o=!(c&&i.timeFrom&&a.length<this.dataLoaded.allSearchedMsgs.length);this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:a,isMoreMsg:!(!a.length&&!this.dataLoaded.allSearchedMsgs.length)&&a.length<this.dataLoaded.allSearchedMsgs.length}),searching:!1})),s&&s(n,this.pageLoad,o)};let h={totalItemReq:4};dl.a.logTrace(`load more msg with range: ${l.timeFrom} - ${l.timeTo}`),this.isSearchingMsg=!0;ul.a.getInstance().searchGlobalMessagesV3(o,d,void 0,null,mi.default.limit_result_msg_search+1,l,h).then((e=>u(e))).catch((e=>{this.loadingMore=!1,s&&s(null,-1),ho.default.logCoreError("searchGlobalMsg v2 "+e)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}))}))}loadMoreMessagesV2(e,t=!1,s,i){if(this.isFirstLoadSuccess&&!this.isSearchingMsg)return mi.default.enable_optimize_search&&!bl.a.isSearchOnSqlite3()?this.loadCachedMessages(i,t,s):t&&this.isCanLoadMoreWithMsgIdsLoaded()?this.loadMoreMessagesWithMsgIdsLoaded(i,t,s):(t||(this.dataLoaded=null),this.loadMoreMessagesWithRange(e,t,s,i));s&&s(null,-1)}loadMoreMessages(){let e=this.state.searchResult;if(bl.a.isSearchOnSqlite3()&&e&&e.rawSearchResult&&e.messageList&&e.rawSearchResult.length>e.lastOffset&&!this.loadingMore){this.loadingMore=!0;const t=this.state.conversation.userId;ul.a.getInstance().getMessageOfConversation(e.rawSearchResult,this.state.conversation.userId,20,e.lastOffset).then((s=>{let i=s.list;if(this.state.conversation&&t==this.state.conversation.userId){let t=ho.default.ZSafeFunction((()=>Math.max(0,e.rawSearchResult.length-e.lastOffset-20)+e.messageList.length+i.length),s.len);i.length>0?this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messageList:this.state.searchResult.messageList.concat(i.map((e=>({message:e,conversation:this.state.conversation})))),realLen:t,lastOffset:this.state.searchResult.lastOffset+20})})):this.state&&this.state.searchResult&&(this.state.searchResult.realLen!==t?this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{realLen:t,lastOffset:e.lastOffset+20})})):this.state.searchResult.lastOffset+=20)}this.loadingMore=!1}))}}loadMoreFiles(){let e=this.state.searchResult,t=this.state.searchText;if(e&&e.rawFileResult&&e.files&&e.rawFileResult.length>e.lastFileOffset&&!this.loadingMoreFiles){this.loadingMoreFiles=!0;const s=e.rawFileResult.slice(e.lastFileOffset,e.lastFileOffset+20),n=new Map;s.forEach((e=>{const t=e.convId;n.has(t)||n.set(t,[]),n.set(t,n.get(t).concat(e.msgId))}));const a=i.ModuleContainer.resolve(Ui.a),r=[];n.forEach(((e,t)=>{r.push(a.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(r).then((i=>{if(this.loadingMoreFiles=!1,this.isKeywordStale(t))return;e=this.state.searchResult;const n=s.map((e=>{const t=i.find((t=>t.convID===e.convId));if(t)return t.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let a=ho.default.ZSafeFunction((()=>Math.max(0,e.rawFileResult.length-e.lastFileOffset-20)+e.files.length+n.length),e.realFileLen),r=this.state.searchResult.files.concat(n);r.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{files:r,realFileLen:a,lastFileOffset:e.lastFileOffset+20})}))})).catch((e=>{this.loadingMoreFiles=!1,ho.default.logCoreError("_loadMoreFiles ",e)}))}}qosLogSearch(){this.countTimeUseGlobalSearch&&(fi.default.increaseSuccess(97111,0,Sr.a.now()-this.countTimeUseGlobalSearch),this.countTimeUseGlobalSearch=0),this.countSelectTopRes>=0&&(fi.default.increaseSuccess(97112,0,this.countSelectTopRes),this.countSelectTopRes=-1)}selectTopRes(){this.countSelectTopRes>=0&&this.countSelectTopRes++}selectResult(e,t=!1,s=!1,i=!1){var n;const a=mi.default.search_message.global.enable_ux_enhance?vl.a.formatTextSearch(this.state.searchText):this.state.searchText;let r=!!this.state.conversation;fl.default.jumpToMessage(e.message,null===(n=e.conversation)||void 0===n?void 0:n.userId,$t.f).then((t=>{const{groupMsgs:s=[]}=t;let i=null;ho.default.ZSafeFunction((()=>{if(s)for(let t=0;t<s.length;t++)if(s[t].msgId==e.message.msgId)return i=Object(f.a)({},s[t]),void(i.searchKeyWord=a)}),null),this.state.searchText&&ml.a.addCacheKeyword(this.state.searchText),Fi.default.send(Ai.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:s,focusId:[""+e.message.msgId],conversation:e.conversation}),i&&Object($t.f)({type:Ai.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:i})})).catch((t=>{ho.default.logCoreError(t),rs.default.createWarning(os.a.str("STR_MESSAGE_NOT_FOUND")),i||Fi.default.send(Ai.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:[],focusId:[],conversation:e.conversation})})),r?(s&&this.focusSearchBox(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{highlightId:e.message.msgId}))):t||this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{highlightId:e.message.msgId}))}getRecentSearchItems(){if(0===mi.default.recent_search.is_enable)return[];let e=ml.a.getLocalRecentSearchList();if(!e)return[];let t=Zo.default.getGroupsListSync(),s=t||[];return e=e.filter((e=>{if(e&&e.userId&&!xo.a.isThreadHidden(e.userId)){if(e.userId.startsWith(R.GROUPID_PREFIX)||1===e.type){let t=!1;1!==e.type||e.userId.startsWith(R.GROUPID_PREFIX)||(e.userId=R.GROUPID_PREFIX+e.userId);for(let i of s)if(i.userId&&e.userId==i.userId){t=!0;break}return!!t||(ml.a.removeLocalRecentSearchList(e.userId),!1)}return!0}return!1})),e}getCacheRecentSearch(){return this.cacheSearch.items=this.getRecentSearchItems(),mi.default.sync_recent_search.enable_kw&&(this.cacheSearch.keywords=ml.a.getLocalKeywordList()),this.cacheSearch}getPageLoad(){return this.pageLoad}getSearchInputRef(){return this.searchInput}getSearchState(){return this.state}clearSearch(e=!0){if(this._resetCacheResultSearch(),this.onAbortSearch(),this.dataLoaded=null,this.searchInput.value="",this.lastTextSearch="",e){if(hl.b.setMode(hl.a.NORMAL),this.updateState(Object(f.a)({},Cl)),this.sidebarController.getState(Go.c).currentTab==No.SidebarTab.FILE_TAB)return void this.functionSearchByName(null,this.countQuery,!0)}else this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchText:"",searching:!0,highlightId:""})),this.functionSearchByName("",this.countQuery,!0)}_resetCacheResultSearch(){this.curQuery="",this.cacheResSearch=null,this.trackSearch=!1,this.trackSearchVietnamese=!1}_checkOnAdminMode(e){let t=this.__checkOnAdminMode(e);t&&(1===t?(this.clearAdminMode&&clearTimeout(this.clearAdminMode),mi.default.adminMode=!0,this.sidebarController.togglePerfTab(!0),this.clearAdminMode=setTimeout((()=>{this.clearAdminMode=void 0,mi.default.adminMode=void 0,this.sidebarController.togglePerfTab()}),216e5)):2===t&&(this.clearAdminMode&&(clearTimeout(this.clearAdminMode),this.clearAdminMode=void 0),mi.default.adminMode=!1,this.sidebarController.togglePerfTab(!1)))}__checkOnAdminMode(e){if(e&&"string"==typeof e&&e.startsWith("$##")){return e.substring(3)===mi.default.zAminKey?1:2}return 0}_innerSearchFunc(e,t,s=!0){if(!Ol.valid(t))return;if(this.sidebarController.getState(Go.c).currentTab===No.SidebarTab.FILE_TAB)Fi.default.send(Ai.SideBarActions.SEARCH_FILE,{term:e});else if(this.state.conversation)this.filterByConversation(e,this.state.conversation);else{const t=s&&this.isKeywordStale(this.lastTextSearch),n=vl.a.formatTextSearch(e);var i;if(this.logSearch(`[Search flow] start search-------: ${t}, ${Ml(n)}`),!n)null===(i=this.searchResultList)||void 0===i||i.forceStopSearch(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null,files:[],rawFileResult:[]})}));this._searchGlobal(e,t)}}debounceSearchMsgAndFile(e,t){this._timeDebounceSearch&&clearTimeout(this._timeDebounceSearch),this._timeDebounceSearch=setTimeout((()=>{e()}),t)}getTimeDebounceSearchMsgAndFile(){ul.a.getInstance();return mi.default.debounce_search_msg_optimize}_searchGlobal(e,t=!0){var s,n,a,r,o,l;jr.default.createCPUUsageRecorder(jr.CPUMetricName.search_global).start().then((e=>this._trackCPUUsageOnSearching(e))),this.lastTextSearchTs=Date.now(),this.lastTextSearch=e;let c=2,d=0,u={},h=this.convDataManager.getAllConvSync(),g=this.previewDataManager.getAllPreviewsForSearch(),m=ho.default.simpleStripVietnamese(e,!1);const p=(s,i)=>{s!==El.STEP_DIRECTORY&&s!==El.STEP_FILES&&c--;let n,a=1==c&&s===El.STEP_CONTACT&&0==d;if(n=!!(c>1||a),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:i,searching:n})),s===El.STEP_CONTACT&&t&&(mi.default.enable_optimize_search?this.debounceSearchMsgAndFile((()=>{v()?dl.a.logTrace(`abort debound search msg: ${Ml(e)}`):(dl.a.logTrace(`do search msg & file: ${Ml(e)}`),I(i&&!i.all.length),mi.default.tabbedGlobalSearchResult&&hl.b.setMode(hl.a.SEARCHING),mi.default.enableFileGlobalSearch&&b())}),this.getTimeDebounceSearchMsgAndFile()):(I(i&&!i.all.length),mi.default.tabbedGlobalSearchResult&&hl.b.setMode(hl.a.SEARCHING),mi.default.enableFileGlobalSearch&&b())),0==c&&!this.isKeywordStale(e)){let e=Date.now()-this.lastTextSearchTs;e>2e3?this._upSearchDelay():e<600&&this._downSearchDelay()}this.isKeywordStale(e)||this._trackPerformanceSearch(s,i,Date.now()-this.lastTextSearchTs)},v=()=>!!this.isKeywordStale(e),b=()=>{if(mi.default.adminConfig&&mi.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(El.STEP_FILES,this.state.searchResult)}),100);const t=(t,s=!0)=>{var n,a;if(this.isKeywordStale(e))return;(null!=t&&t.length||!s)&&yl.a.fileUIVisible(Sr.a.now(),(null==t?void 0:t.length)||0);let r=new Set;const o=[];var l,c,u,h,g,m;if((t.forEach((e=>{const t=e.msgId;t&&!r.has(t)&&(r.add(t),o.push({msgId:t,convId:e.convId}))})),(null===(n=this.state.searchResult)||void 0===n||null===(a=n.rawFileResult)||void 0===a?void 0:a.length)>=20&&(null==o?void 0:o.length)>=20)&&((null===(l=this.state.searchResult)||void 0===l||null===(c=l.rawFileResult[0])||void 0===c?void 0:c.msgId)==(null===(u=o[0])||void 0===u?void 0:u.msgId)&&(null===(h=this.state.searchResult)||void 0===h||null===(g=h.rawFileResult[19])||void 0===g?void 0:g.msgId)==(null===(m=o[19])||void 0===m?void 0:m.msgId)))return void this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{rawFileResult:o,realFileLen:o.length})}),!1);const v=o.slice(0,20),b=new Map;v.forEach((e=>{const t=e.convId;b.has(t)||b.set(t,[]),b.set(t,b.get(t).concat(e.msgId))}));const I=i.ModuleContainer.resolve(Ui.a),y=[];b.forEach(((e,t)=>{y.push(I.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(y).then((t=>{if(this.isKeywordStale(e))return;const s=v.map((e=>{const s=t.find((t=>t.convID===e.convId));if(s)return s.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let i=[],n=0,a=0;for(const e of s)e?(i.push(e),n++):a++;i.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm)));let r=this.state.searchResult;ho.default.log("search files: cur = "+r.searchKey+" this query = "+Ml(e),i.length),r=r?Object(f.a)({},r):{},r.files=i,r.realFileLen=o.length-a,r.rawFileResult=o,r.lastFileOffset=v.length,r.searchKey=e,d+=n,p(El.STEP_FILES,r)})).catch((t=>{ho.default.logCoreError("doSearchFiles "+t),this.state&&!this.isKeywordStale(e)&&p(El.STEP_FILES,this.state.searchResult)}))};yl.a.startQueryFile(Sr.a.now());ul.a.getInstance().search(e,null,{msgType:R.MSG_FILE},t,{enableReject:!0}).then((e=>{t(e,!1)})).catch((e=>{this.state.searchResult.files&&this.state.searchResult.files.length||this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{files:[]})}),!0)}))},I=(t=!1)=>{if(mi.default.adminConfig&&mi.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(El.STEP_MESSAGES,this.state.searchResult)}),100);this.logSearch(`[Search flow] search msg: ${Ml(e)}`);const s=(t,s=!1)=>{var i;if(s&&(this.isSearchingMsg=!1),this.logSearch(`[Search flow] search msg res first load: ${Ml(e)}, ${null===(i=t.arr)||void 0===i?void 0:i.length}`),this.pageLoad=0,this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null})}),!1)),!this.isKeywordStale(e)&&t){let i=[],r=0;t&&t.listConv&&t.arr&&h.forEach((e=>{let s=t.listConv.indexOf(e.userId);if(s>=0&&!xo.a.isThreadHidden(e.userId))for(let n=s;n<t.listConv.length;++n)t.listConv[n]==e.userId&&(t.arr[n].conversation=e,r+=1,i.push(t.arr[n]))}));let o=this.state.searchResult,l=i;var n;if(o.messages&&(l=o.messages.slice(),Array.prototype.push.apply(l,i)),l.sort(((e,t)=>parseInt(t.message.sendDttm)-parseInt(e.message.sendDttm))),o=o?Object(f.a)({},o):{},o.messages=l,o.searchKey=e,o.isMoreMsg=t.isMoreMsg,this.dataLoaded=t.dataLoaded,d+=r,s)this.isFirstLoadSuccess=!0,this.searchResultList&&a&&this.searchResultList.updateFirstLoadPos(a.timeFrom),ho.default.logCoreError("[Global search] check First data",Ml(e),null===(n=this.state.searchResult.messages)||void 0===n?void 0:n.length);else if(!i.length)return;p(El.STEP_MESSAGES,o)}};let i=null;var n;this.searchResultList&&(!this.timeouResetDataMsg&&this.state.searchResult.messages&&(this.timeouResetDataMsg=setTimeout((()=>{this.timeouResetDataMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null})})),this.searchResultList&&this.searchResultList.resetDataSearch()}),1e3)),this.searchResultList.resetDataSearch(),bl.a.isSearchOnSqlite3()&&(i=null===(n=this.searchResultList)||void 0===n?void 0:n.getRange(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{filter:{timeFrom:i.timeFrom,timeTo:i.timeTo}}),!1)));const a=Object(f.a)({},i);this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!0,highlightId:"",searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:!this.lastTextSearch||e.length<this.lastTextSearch.length?null:this.state.searchResult.messages})})),this.loadingMore=!1,this.isFirstLoadSuccess=!1;let r={};t||(r.totalItemReq=4);const o=ul.a.getInstance();yl.a.startQueryMsg(Sr.a.now(),o.isEnableSearchSqlite),this.isSearchingMsg=!0,o.searchGlobalMessagesV3(e,(()=>!(!bl.a.isSearchOnSqlite3()||this.state.filter.timeFrom==a.timeFrom&&this.state.filter.timeTo==a.timeTo)||v()),void 0,s,mi.default.limit_result_msg_search+1,i,r).then((e=>s(e,!0))).catch((t=>{if(this.logSearch(`[Search flow] search msg fail: ${t}`),ho.default.logCoreError("searchGlobalMsg "+t),this.state&&!this.isKeywordStale(e)){this.searchResultList&&this.searchResultList.forceStopSearch(),this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1);let e=this.state.searchResult;e.messages=[],p(El.STEP_MESSAGES,e)}})).finally((()=>{this.isSearchingMsg=!1}))};if(this.curQuery&&0!==e.indexOf(this.curQuery)&&this._resetCacheResultSearch(),!this.cacheResSearch){const e=e=>{for(const t of e){const e=t.userId||t.convId;t&&!u[e]&&(null!=t&&t.userId||(t.userId=e),null!=t&&t.infoSearch&&delete t.infoSearch,null!=t&&t.isDirectory&&delete t.isDirectory,u[e]=t)}};g.length&&e(g),e(ns.default.getFriendsSync()),e(Zo.default.getGroupsListSync())}const y=Sr.a.now();yl.a.setKeyword(e),yl.a.resetTracking(),gl.a.search(e,this.cacheResSearch?this.cacheResSearch:u,{hasSection:!0,suggestGroupWithMember:!0,searchFriendInGroup:!0,isCalc:!0,updateLastChat:!this.cacheResSearch,searchPb:!0,searchZName:!0,searchNumPhone:!0,filterHidden:xo.a.isKeyPIN(e)}).then((t=>{var s;yl.a.trackingContact(Sr.a.now()-y,null==t||null===(s=t.all)||void 0===s?void 0:s.length);let i=this.state.searchResult;if(!this.isKeywordStale(e)){{var n;let s=[];if(xo.a.isKeyPIN(e)){as.default.logAction(1970601);const e=xo.a.getUidsHiddenChat();if(e.length)for(let t of e){let e=!1;for(let i of h)if(i&&i.userId==t){s.push(Object(f.a)(Object(f.a)({},i),{},{infoSearch:{}})),e=!0;break}if(!e){let e=null;e=t.startsWith(R.GROUPID_PREFIX)?Zo.default.getGroupByIdSync(t):ns.default.getProfileFriendSync(t),e&&(e.lastMessageTime||(e.lastMessageTime=0),s.push(Object(f.a)(Object(f.a)({},e),{},{infoSearch:{}})))}}}this.curQuery||(this.curQuery=e),!this.cacheResSearch&&t.orderAll&&t.orderAll.constructor==Array&&t.orderAll.length>0&&(this.cacheResSearch=u),null!==(n=t.phone)&&void 0!==n&&n.length&&(t.phone=t.phone.filter((e=>e.userId))),i=i?Object(f.a)({},i):{},i.recentChat=t.recentChat,i.groups=t.groups,i.friends=t.friends,i.oa=t.oa,i.directory=t.directory,i.searchKey=e,i.phone=t.phone,i.hiddenChat=s,i.all=t.all,i.orderAll=t.orderAll,d+=(i.groups?i.groups.length:0)+(i.friends?i.friends.length:0)+(i.oa?i.oa.length:0),d+=(i.recentChat?i.recentChat.length:0)+i.hiddenChat.length}p(El.STEP_CONTACT,i)}})).catch((e=>{ho.default.logCoreError(e)})),0==(null===(s=this.state.searchResult)||void 0===s||null===(n=s.messages)||void 0===n?void 0:n.length)&&0==(null===(a=this.state.searchResult)||void 0===a||null===(r=a.all)||void 0===r?void 0:r.length)&&0==(null===(o=this.state.searchResult)||void 0===o||null===(l=o.files)||void 0===l?void 0:l.length)&&as.default.logAction(1232201),m===e||this.trackSearchVietnamese||(this.trackSearchVietnamese=!0,as.default.logAction(1232010))}filterByConversation(e,t){if(!e)return this.searchInput.value="",void this.updateState(Object(f.a)(Object(f.a)({},Cl),{},{conversation:t,searching:!1,highlightId:""}));let s=(s,i=!1)=>{if(this.isKeywordStale(e))return void ho.default.logCoreError("search: abort filtermode 1",Ml(this.state.searchText),Ml(e));if(i&&(!s||0==s.length))return;ul.a.getInstance().getMessageOfConversation(s,t.userId,20).then((n=>{if(this.isKeywordStale(e))return void ho.default.logCoreError("search: abort filtermode 2",Ml(this.state.searchText),Ml(e));let a=n.list;if(i&&(!a||0===a.length))return;let r=a.length<20&&s.length>20;a.length>0?(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{conversation:t,searchResult:{messageList:a.map((e=>({message:e,conversation:t}))),realLen:n.len,rawSearchResult:s,lastOffset:20,progress:i},searching:!1,highlightId:a[0].msgId})),i||(this.focusSearchBox(),r&&this.loadMoreMessages()),!i&&this.searchResultList&&this.searchResultList.scrollToTop&&this.searchResultList.scrollToTop()):(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{conversation:t,searchResult:{messageList:[],realLen:0,lastOffset:0,progress:!1},searching:!1,highlightId:""})),this.focusSearchBox(),!i&&r&&this.loadMoreMessages())}))};ul.a.getInstance().search(e,null,{convId:t.userId+""},(e=>{s(e,!0)})).then((e=>{s(e)}))}_getSearchDelaySetting(){return 70}_upSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.min(400,Math.round(1.1*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_downSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.max(70,Math.round(.9*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_resetSearchFunction(){ho.default.logCoreError("__rssf__",this.searchDelay),this.functionSearchByName=ho.default.throttle(this._innerSearchFunc,this.searchDelay)}_isSelectAllSearchText(){if(this.searchInput){const e=this.searchInput.selectionStart,t=this.searchInput.selectionEnd;return!(!this.searchInput.value.length||0!=e||t!=this.searchInput.value.length)}return!1}_trackPerformanceSearch(e,t,s){var i,n,a,r,o;const l={[El.STEP_MESSAGES]:"msg",[El.STEP_FILES]:"file",[El.STEP_CONTACT]:"contact"}[e];let c={[El.STEP_MESSAGES]:null==t||null===(i=t.messages)||void 0===i?void 0:i.length,[El.STEP_FILES]:null==t||null===(n=t.files)||void 0===n?void 0:n.length,[El.STEP_CONTACT]:((null==t||null===(a=t.groups)||void 0===a?void 0:a.length)||0)+((null==t||null===(r=t.friends)||void 0===r?void 0:r.length)||0)+((null==t||null===(o=t.oa)||void 0===o?void 0:o.length)||0)}[e]||0;if(l&&c){Object(_l.b)().logInfo(_l.a.GlobalSearch,{duration:s,search_type:l,result_size:c})}}_trackCPUUsageOnSearching(e){if(!e||this._recordedCPUUsageTs&&this._recordedCPUUsageTs>=e.endAt)return;this._recordedCPUUsageTs=e.endAt;Object(_l.b)().logInfo(_l.a.CPU_GlobalSearch,{cpu:e.cpu,duration:e.endAt-e.startAt,process:e.processes.map((e=>({cpu:e.cpu,name:e.name,type:e.type})))})}init(){}getItem(e){return this.state}getList(e){throw new Error("No imp!!!")}onGetItemFailure(e){}onGetListFailure(e){}onApplicationReady(){0}loadOldestTime(){this.loadOldestTimeWithRetry(mi.default.sqlite_mac.max_load_oldest_time_retry).then((e=>{this.oldestTime=e})).catch((e=>{dl.a.logError("loadOldestTime fail after retrying",e),this.oldestTime=0}))}async loadOldestTimeWithRetry(e){return new Promise(((t,s)=>{ul.a.getInstance().getOldestTime().then((e=>{e&&e.length&&!isNaN(e[0].ts)?t(Math.max(+e[0].ts,1e12)):t(0)})).catch((i=>{dl.a.logError("loadOldestTime fail",`remaining times: ${e}`,i),e>0?setTimeout((()=>{this.loadOldestTimeWithRetry(e-1).then(t).catch(s)}),0):s(i)}))}))}getOldestTime(){return this.oldestTime}getTotalQueriedMsgIds(){var e,t;return null===(e=this.dataLoaded)||void 0===e||null===(t=e.allSearchedMsgs)||void 0===t?void 0:t.length}})||cl)||cl)||cl)||cl)||cl)||cl);var Sl,Tl=s("B5Cg"),wl=s("jnrz"),Rl=s("Anfm"),Ll=s("BZLJ"),Dl=s("BKm0"),Al=s("iKSP"),Fl=s("uglG"),jl=s("oMqy");const Pl={windowId:Go.c,theme:Tl.e.LIGHT,currentTab:No.SidebarTab.MESSAGE_TAB,previousTab:No.SidebarTab.MESSAGE_TAB,selectedId:null,previousId:null,showExportImportEntry:!0},kl="z_sendtome_bubbledot",Nl="SIDEBAR CONTROLLER";function Ul(...e){ho.default.logCoreInfo(`[${Nl}] - `,e)}Object(Je.i)()(Sl=Object(ko.b)(No.SidebarController)(Sl=function(e,t){return i.ModuleContainer.inject(No.ConvListController)(e,void 0,0)}(Sl=function(e,t){return i.ModuleContainer.inject(pl.b)(e,void 0,1)}(Sl=Reflect.metadata("design:type",Function)(Sl=Reflect.metadata("design:paramtypes",[void 0===No.ConvListController?Object:No.ConvListController,void 0===pl.b?Object:pl.b])(Sl=class{constructor(e,t){this.convListController=e,this.searchController=t,this.changeTabFromSearch=void 0,this._firstTimePageLoad=void 0,this._querySelect=void 0,this._convsLoaded=void 0,this._exportImportFinished=void 0,this._exportImportProgressError=void 0,this._allowAutoJumpFC=void 0,this._es=void 0,this._onSendMsg=e=>{var t,s;const i=(null==e||null===(t=e.messages)||void 0===t||null===(s=t[0])||void 0===s?void 0:s.upSrc)&R.FILE_UP_SRC.TextEditor,n=this.getState();if(n.currentTab==No.SidebarTab.TODO_TAB||n.currentTab==No.SidebarTab.CATALOG_TAB||i||e.isChild)return;const a=this.searchController.getSearchState();n.currentTab!==No.SidebarTab.MESSAGE_TAB||a&&a.searchText?(n.currentTab=No.SidebarTab.MESSAGE_TAB,Object(hs.h)(this.name,Go.c),Object($t.f)({type:Ai.SideBarActions.SHOW_CHAT_VIEW}),a&&a.searchText&&as.default.logAction(1232007),this.searchController.clearSearch(!0)):n.currentTab==No.SidebarTab.MESSAGE_TAB&&this.searchController.setRecentSearchFocusState(!1,!1,!0),this.searchController.closeBySendingMsg=!0,setTimeout((()=>{this.convListController.scrollToTop(!1)}),100)},this.changeTab=(e,t=Go.c)=>{const s=this._getStateByWindowId(t);let i=s.currentTab;s.currentTab!==e&&(s.currentTab=e,Object(hs.h)(this.name,t)),this._onChangeTab(s.currentTab,i)},this.togglePerfTab=e=>{const t=this._getStateByWindowId(Go.c);t.showPerfTab!==e&&(t.showPerfTab=e,Object(hs.h)(this.name,Go.c))},this.changeTheme=async e=>{},this.selectMessageTab=()=>{this.changeTab(No.SidebarTab.MESSAGE_TAB)},this.selectTodoTab=()=>{this.changeTab(No.SidebarTab.TODO_TAB),as.default.logAction(171),Ll.default.setViewPopupTodoSrc(Ll.POPUP_TODO_SRC.TAB_ICON)},this.selectContactFromSearch=async(e,t=!1)=>{if(!e)return Ul("Select friend null!"),Promise.resolve(!1);const s=await i.ModuleContainer.resolve(Ii.b).openConversation(e.userId,Ii.c.fromSearchList(e));return!0===t?(this.searchController.onCloseSearch(),this.searchController.resetState()):this.searchController.updateStateOf("highlightId",e.userId),s?(e&&e.userId===mi.default.sendToMeId&&(ki.g.getFlagForCurrentUser(this.currUser.userId,kl)||(rt.p.getHasShownSendToMeTip()?ki.g.setFlagForCurrentUser(this.currUser.userId,kl,1):setTimeout((()=>{Fi.default.send(Ai.ConversationListActions.SHOW_BUBBLE_DOT),rt.p.setHasShownSendToMeTip(!0)}),144e5)),as.default.logAction(1390101)),Promise.resolve(!0)):(Ul("Open conv failure"),Promise.resolve(!1))},this.setupSelectConvOnPageLoad=()=>{if(!this._firstTimePageLoad)return;let e=this._getQueryParams();if(e.c){ho.default.logCoreInfo(`[${this.name}] - setup select conv c`);const t=e=>{const t={[e]:!0};this._querySelect=()=>{let s;s=e.startsWith(R.GROUPID_PREFIX)?uo.default.fetchGroupsIfNotExpire(t):uo.default.fetchFriendsIfNotExist(t),s.then((t=>{t&&t[e]?this.selectContactFromSearch(t[e]):ho.default.logCoreInfo(`[${this.name}] - auto open conv with id ${e} does not exist`)})).catch((e=>{ho.default.logCoreError(e)}))},this._autoSelectConv()},s=e.c;e.convert?uo.default.convertOAIds([s]).then((e=>{e&&e[s]&&t(e[s])})):t(s),this._firstTimePageLoad=!1}else if(e.g)ho.default.logCoreInfo(`[${this.name}] - setup select conv g`),is.a.autoSelectGroupByLink(`https://${mi.default.CONFIG_DOMAIN}/g/`+encodeURIComponent(e.g));else if(e.zs);else if(e.phone){let t=e.phone,s=e.openConv;!t||isNaN(t)||this._querySelect||(ho.default.logCoreInfo(`[${this.name}] - setup select conv p`),this._querySelect=()=>{s?is.a.autoOpenConversationByPhone(t,$t.e):is.a.autoSelectConversationByPhone(t,$t.e)},this._autoSelectConv())}else if(e.alias){ho.default.logCoreInfo(`[${this.name}] - setup select conv a`);let t=e.alias;this._querySelect||(this._querySelect=()=>{is.a.autoSelectConversationByAlias(t,$t.e)},this._autoSelectConv())}},this.name=No.SIDEBAR_CONTROLLER,this.data=new Map,this.key="windowId",this.changeTabFromSearch=!1,this._firstTimePageLoad=!0,this._convsLoaded=!1,this._allowAutoJumpFC=!1,this.selectConversationForFriend=this.selectConversationForFriend.bind(this),this.listenEvents()}get currUser(){return Object($o.c)()}get autoJumFC(){return this._allowAutoJumpFC}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}onStart(e){i.ModuleContainer.resolve(Ii.b)}listenEvents(){Fi.default.subscribe(((e,t)=>{switch(e){case Ai.ChatBoxActions.SEND_MSG:this._onSendMsg(t);break;case Ai.ChatBoxActions.SELECT_FRIEND:this.selectConversationForFriend(t);break;case Ai.SideBarActions.SHOW_FILE_MANAGER:this.getState().currentTab=No.SidebarTab.FILE_TAB,Object(hs.h)(this.name,Go.c);break;case Ai.SideBarActions.SELECT_TAB_MSG:this.changeTab(No.SidebarTab.MESSAGE_TAB);break;case Ai.FetchActions.DELETE_CONVERSATION:case Ai.FetchActions.GROUP_LEAVE:{const e=this.getState();e.previousId&&t===e.previousId&&(e.previousId=null);break}case Ai.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:case Ai.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH:this.getState().currentTab!=No.SidebarTab.FILE_TAB&&this.getState().currentTab!=No.SidebarTab.ZCLOUD_TAB||this.changeTab(No.SidebarTab.MESSAGE_TAB);break;case Ai.TodoActions.OPEN_TODO_LIST:{const e=qo.b.instance().getTodoView();e?e.onCheckOpenTab():this.changeTab(No.SidebarTab.TODO_TAB);break}case Ai.ActionList.ACT_OPEN_TAB_CHAT:this.selectMessageTab();break;case Ai.ActionList.ACT_OPEN_TAB_CONTACT:this.changeTab(No.SidebarTab.CONTACT_TAB);break;case Ai.ActionList.ACT_OPEN_GROUPLIST:if(this.getState().currentTab===No.SidebarTab.CONTACT_TAB){const e=qo.b.instance().getContactList();e&&e.onJumpGroupCenter()}else this.changeTab(No.SidebarTab.CONTACT_TAB);break;case Dl.b.EXPORT_IMPORT_START:this._exportImportFinished=!1,this._exportImportProgressError=!1;break;case Dl.b.EXPORT_IMPORT_FINISHED:this._exportImportFinished=!0,this._exportImportProgressError=!1;break;case Dl.b.IMPORT_DB_PROGRESS:case Dl.b.IMPORT_PROGRESS:case Dl.b.EXPORT_PROGRESS:case Dl.b.EXPORT_DB_PROGRESS:t&&t.error&&(this._exportImportProgressError=!0);break;case Ai.ConversationListActions.SELECT_CONVERSATION:{const e=this.getState();e.currentTab!==No.SidebarTab.FILE_TAB&&e.currentTab!==No.SidebarTab.CATALOG_TAB&&e.currentTab!==No.SidebarTab.ZCLOUD_TAB||this.changeTab(No.SidebarTab.MESSAGE_TAB);break}}})),Co.a.ConvInfoDataManager.addEventListener(so.b.DoneLoadDB,(e=>{this._convsLoaded=!0,this._autoSelectConv()})),Co.a.UnreadDataManager.addEventListener(so.b.DoneLoadDB,(e=>{wl.b.onDoneLoadUnreadDB(null==e?void 0:e.payload)}))}getState(e=Go.c){return this._getStateByWindowId(e)}getSelectedId(e){return this.getState(e).selectedId||null}getCurrMainConvId(){const e=this.eventStore.getState();return e&&e.chatview.view===Al.c.CHAT_VIEW?this.getSelectedId():null}updateSelectedId(e,t=Go.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=e?null:s.selectedId,s.selectedId=e,Object(hs.h)(this.name,t))}updateSelectedIdWithoutPrevious(e,t=Go.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=null,s.selectedId=e,Object(hs.h)(this.name,t))}isInImportExportProcess(){const e=this._exportImportFinished||this._exportImportProgressError;return void 0!==e&&!e}openFriendCenter(){}selectConversationForFriend(e,t=!1){if(!e)return void ho.default.logCoreError("friend null");if($t.f&&(Object($t.f)({type:Ai.ConversationListActions.SELECT_CONV_MINOR,payload:e}),Object($t.f)({type:Ai.ChatBoxActions.READ_CONVERSATION,payload:{conversationId:e.userId}})),e.userId==this.currUser.userId)return void this._showMyProfile();let s=this.convListController.getRecentContactWithId(e.userId),i=!1;if(s)i=!0;else{let t=t=>{t&&t.includes(e.userId)&&(s=Object(f.a)({},t[e.userId]))};s||t(Zo.default.getGroupsListSync()),s||t(ns.default.getFriendsSync()),s||(s={}),Object.assign(s,e),s.isFr=s.isFr||0,s.type=s.type||R.FRIEND_TYPE_NORMAL}e.byPassPIN?s.byPassPIN=1:s.byPassPIN&&delete s.byPassPIN,setTimeout((()=>{Object($t.f)({type:Ai.ConversationListActions.SELECT_CONVERSATION,payload:s})}),0);const n=this.data.get(Go.c);let a=null==n?void 0:n.currentTab;!0===t?(a=i?No.SidebarTab.MESSAGE_TAB:No.SidebarTab.CONTACT_TAB,a===No.SidebarTab.CONTACT_TAB&&(ho.default.log("sidebar: select from search, should highlight thread"),this.changeTabFromSearch=!0),this.searchController.onCloseSearch(),this.searchController.resetState(),!e.userId||!e.byPassPIN&&xo.a.isThreadHidden(e.userId)||setTimeout((()=>{Fi.default.send(Ai.ChatBoxActions.FOCUS_INPUT,{userId:e.userId,windowId:Go.c})}),0)):this.searchController.updateStateOf("highlightId",e.userId),this.updateState(Object(f.a)(Object(f.a)({},n),{},{currentTab:a,selectedId:e.userId})),e&&e.userId===mi.default.sendToMeId&&(ki.g.getFlagForCurrentUser(this.currUser.userId,kl)||(rt.p.getHasShownSendToMeTip()?ki.g.setFlagForCurrentUser(this.currUser.userId,kl,1):setTimeout((()=>{Fi.default.send(Ai.ConversationListActions.SHOW_BUBBLE_DOT),rt.p.setHasShownSendToMeTip(!0)}),144e5)))}showAddFriendModal(){as.default.logAction(1020203),as.default.logAction(12316),ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.FIND_FRIEND})}async showGroupCompose(){as.default.logAction(1020202),Rl.c.markStart(Rl.a.CREATE_GROUP,Rl.b.Group.CREATE_GR_HEADER_ICON);const e=jl.q.isAllowCreateCommunity();if(e)try{await i.ModuleContainer.resolve(jl.e).checkCreateCondition(jl.n.NORMAL)}catch{return Object(Fl.b)({windowId:Go.c})}const t=rt.p.getSessionUserId(),s=(e=!0,t=!1)=>{ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.CREATE_GROUP_COMPOSE,params:{needInitE2ee:e,showCreateOptions:t},forceCloseAll:!1})};!ki.g.getTimeEntryPointE2eGroup(t,Rl.b.Group.CREATE_GR_HEADER_ICON)&&mi.default.e2ee.enable_group&&mi.default.e2ee.group.can_enable_right_in_creation_step?ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.E2EE_ONBOARDING,params:{entry:cn.e.CREATE_GROUP,entrySrc:Rl.b.Group.CREATE_GR_HEADER_ICON,isGroup:!0,userId:"",callback:s,callbackCancel:s},forceCloseAll:!1}):s(!1,e)}enableAutoJupmFC(){this._allowAutoJumpFC=!0}disableAutoJupmFC(){this._allowAutoJumpFC=!1}init(){}getItem(e){const t=e.key;return this._getStateByWindowId(t)}getList(e){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}updateState(e,t=Go.c,s=!0){this.data.set(t,e),s&&Object(hs.h)(this.name,t)}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(f.a)({},Pl),this.data.set(e,t)),t}_onChangeTab(e,t){switch(function(){switch(e){case No.SidebarTab.MESSAGE_TAB:as.default.logAction(12801);break;case No.SidebarTab.CONTACT_TAB:as.default.logAction(12802),3===mi.default.noti_center_config.entry_position&&as.default.logAction(1281205);break;case No.SidebarTab.MENTION_TAB:as.default.logAction(12805);break;case No.SidebarTab.STAR_TAB:as.default.logAction(12806);break;case No.SidebarTab.FILE_TAB:as.default.logAction(133);break;case No.SidebarTab.TODO_TAB:3===mi.default.noti_center_config.entry_position&&as.default.logAction(1281206)}}(),rt.p.resetGlobalSearchMode(),this.searchController.getSearchInputRef()&&this.searchController.clearSearch(!0),e){case No.SidebarTab.MESSAGE_TAB:{this._resetConversationList();const e=this.getState();!e.selectedId&&e.previousId&&this.updateSelectedId(e.previousId),Object($t.f)({type:Ai.SideBarActions.SHOW_CHAT_VIEW});break}case No.SidebarTab.STAR_TAB:case No.SidebarTab.TODO_TAB:t===No.SidebarTab.ZCLOUD_TAB&&Object($t.f)({type:Ai.SideBarActions.SHOW_CHAT_VIEW})}}_showMyProfile(){ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:this.currUser.userId})}_resetConversationList(){}_getQueryParams(){let e={},t=window.location.search;if(t=t?t.substr(1).split("&"):null,t)for(let s=0;s<t.length;s++){let i=t[s].indexOf("=");if(i>=0){let n=t[s].slice(0,i),a=t[s].slice(i+1,t[s].length);n&&n.length>0&&a&&a.length>0&&(e[n]=decodeURIComponent(a))}}return e}_autoSelectConv(){this._querySelect&&this._convsLoaded&&(ho.default.logCoreInfo(`[${this.name}] - auto select conv start`),this._querySelect(),this._querySelect=null)}})||Sl)||Sl)||Sl)||Sl)||Sl);var Bl;const xl={id:Fo.f,color:"#EA87FF",conversations:[],createTime:1634956772046,emoij:"",offset:100,text:"default"};var Gl=function(e){return e.ALL="all",e.SELECTED="selected",e}(Gl||{});Object(ko.b)(No.LabelDataManager)(Bl=Reflect.metadata("design:type",Function)(Bl=Reflect.metadata("design:paramtypes",[])(Bl=class extends Fe.b{constructor(){super(),this.allLabels=void 0,this.selectedLabel=void 0,this.name=No.LABEL_DATA_MANAGER,this.data=new Map,this.key="labelId",this.allLabels=[],this.selectedLabel=[]}onLabelChange(e){const{color:t,conversations:s,createTime:i,emoij:n,offset:a,text:r}=e,o=""+e.id,l=this.data.get(o);if(!o||l&&s===l.conversations&&i==(null==l?void 0:l.createTime)&&n==l.emoij&&a==l.offset&&r===l.text&&t==l.color||(this.data.set(o,e),Object(hs.h)(this.name,o),Object(hs.j)(this.name,"all")),l&&l.conversations&&l.conversations.length!==s.length){let e=[];s.length>l.conversations.length?(e=s.filter((e=>!l.conversations.includes(e))),this.dispatchEvent(new Uo.c(Uo.d.LabelAddConvs,{labelId:o,convIds:e}))):(e=l.conversations.filter((e=>!s.includes(e))),this.dispatchEvent(new Uo.c(Uo.d.LabelRemoveConvs,{labelId:o,convIds:e})))}}onFetchLabels(e){if(Array.isArray(e)&&!(e.length<0)){for(let t=0;t<e.length;t++)this.onLabelChange(e[t]);this.data.forEach((t=>{const s=""+t.id;e.some((e=>e.id==s))||this.data.delete(s)})),this._updateAllLabels(e.map((e=>e.id)))}}onLabelDeleted(e){if("string"!=typeof e&&(ho.default.logCoreError(`[${this.name}] - delete label invalid lid type ${e}`),e=""+e),!this.data.has(e))return void ho.default.logCoreError(this.name+"Deleted not exists item!!!");const t=this.data.get(e);let s=[];t&&t.conversations&&(s=[...t.conversations]),this.data.delete(e),this._updateAllLabels(this.allLabels.filter((t=>t!==e))),this.selectedLabel.includes(e)&&this.onDeSelectLabel(e),this.dispatchEvent(new Uo.c(Uo.d.RemoveLabel,{labelId:e,convs:s})),Object(hs.f)(this.name,e)}_updateAllLabels(e){return!ho.default.shallowEqual(this.allLabels,e)&&(this.allLabels=e,Object(hs.j)(this.name,Gl.ALL),!0)}onSelectLabel(e){this.selectedLabel=[""+e],Object(hs.j)(this.name,Gl.SELECTED),this.selectedLabelChanged()}onDeSelectLabel(e){this.selectedLabel=this.selectedLabel.filter((t=>t!==e)),Object(hs.j)(this.name,Gl.SELECTED),this.selectedLabelChanged()}onClearFilter(){this.selectedLabel=[],Object(hs.j)(this.name,Gl.SELECTED),this.selectedLabelChanged()}getLabelById(e){return e?("string"!=typeof e&&(e=e.toString()),e==Fo.f?xl:e==Fo.g?{id:Fo.g}:this.data.get(e)||null):null}getAllLabels(){return Array.from(this.data.values())}getAllLabelIds(){return this.allLabels}applyNewFilter(e){this.selectedLabel=e,Object(hs.j)(this.name,Gl.SELECTED),this.selectedLabelChanged()}selectedLabelChanged(){this.dispatchEvent(new Uo.c(Uo.d.SelectedLabelChange,this.selectedLabel))}init(){zo.a.getAll().then((e=>{this.onFetchLabels(e)}))}getItem(e){const t=e.key;return this.getLabelById(t)}getList(e){const t=e.key;return t===Gl.ALL?this.allLabels:t===Gl.SELECTED?this.selectedLabel:[]}onGetItemFailure(e){}onGetListFailure(e){}})||Bl)||Bl);i.ModuleContainer.register(Do.b,Po);var zl=s("k+R1");let Vl=function(e){return e[e.FULL=0]="FULL",e[e.WINDOWED=1]="WINDOWED",e}({});var Hl=s("tQbm"),Wl=s("qzuk"),$l=s("NMlV"),Kl=s("4HQc"),ql=s("GpwQ");const Ql={message:{action:"recommened.link",childnumber:0,description:"Zalo cho máy tính gửi file cực nhanh, chụp màn hình tiện lợi, trò chuyện nhóm không giới hạn.",href:`https://${mi.default.CONFIG_DOMAIN}/may-tinh?utm_source=chatview&utm_campaign=reinstallpc&utm_medium=web`,params:`{"mediaTitle":"Zalo cho máy tính – Windows, Mac, Ubuntu","artist":"","src":"${mi.default.CONFIG_DOMAIN}","stream_icon":"","streamUrl":"","type":0}`,thumb:"https://stc-chat.zdn.vn/images/banner/zalo-thumb-link.png",title:"Zalo cho máy tính – Windows, Mac, Ubuntu",type:"",copyLinkActionCode:null,confirmActionCode:null},msgType:6};var Zl,Jl=s("OU7N"),Yl=s("UYGI"),Xl=s("X4fA"),ec=s("V8Oy"),tc=s("7WX+");let sc;ho.default.isWeb()||(sc=s("Dprd").default);const ic={conversationId:null,mode:Vl.FULL,windowId:Go.c};Object(ko.b)(Hl.b)(Zl=function(e,t){return i.ModuleContainer.inject(No.SidebarController)(e,void 0,0)}(Zl=Reflect.metadata("design:type",Function)(Zl=Reflect.metadata("design:paramtypes",[void 0===No.SidebarController?Object:No.SidebarController])(Zl=class extends Fe.b{constructor(e){super(),this.sidebar=e,this.data=new Map,this.onLogOut=()=>{if(Jl.c.isCalling())return void rs.default.createWarning(os.a.str("STR_SIGNOUT_WITH_CALL"));let e=rt.p.getSessionUserId(),t="STR_LOGOUT_CONFIRM",s=+Yl.a.isUploading();if(!s&&sc&&sc.isDownloading()&&(s=2),s>0){const e=1===s?os.a.str("STR_TITLE_BAR_SEND"):os.a.str("STR_TITLE_BAR_RECEIVE");t=os.a.str("STR_LOGOUT_CANCEL_FILE")+` ${e} `+os.a.str("STR_TITLE_BAR_EXIT_ZALO_P2")}Xl.a.getLogoutToken(),Ko.ConfirmManagerV2.openConfirm({windowId:Go.c,name:R.MODAL_CONFIRM.confirmIdentities,params:{message:os.a.str(t),okText:os.a.str("STR_LOGOUT_YES"),cancelText:os.a.str("STR_LOGOUT_NO"),onOk:this.doLogout,options:[{default_val:ki.g.isSetClearData(e),key:"del_history",title:"STR_LOGOUT_DEL_HISTORY"}],"data-id":{confirmBtn:"btn_Logout_Logout",cancelBtn:"btn_Logout_No"}}})},this.openConversationInNewWindow=async e=>{throw new Error("Method not implemented.")},this.openScreenCapture=async()=>{as.default.logAction(12808),Fi.default.send(Ai.ChatBoxActions.SIDEBAR_CAPTURE)},this.openZaloSupport=async()=>{const e=mi.default.supportPage;return e?i.ModuleContainer.resolve(Ii.b).openConversation(e,Ii.c.fromSupport()):Promise.resolve(!1)},this.openUpdateMyProfile=async()=>{ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.UPDATE_PROFILE,params:{showCloseButton:!0}})},this.openUserInfo=async e=>{Li.a.setFriendRequestSource(e,R.FRIEND_REQUEST_SRC_CONTACT_LIST_SUGGESTION),rt.p.setSelectConversationSource(178012),ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})},this.openEditAlias=async e=>{const t={windowId:Go.c,name:R.ModalIdentitiesDefine.EDIT_ALIAS,params:Object(f.a)({},e)};ss.ModalManagerV2.openModal(t)},this.sendFile=async(e,t)=>{const s=this._getStateByWindowId(Go.c),i=zl.default.getChatBoxControllerByConvId(t||s.conversationId);null==i||i._uploadDragFile(e,null,t)},this.getConvId=()=>this._getStateByWindowId(Go.c).conversationId,this.sendDirectMsgToSendToMe=(e,t)=>{!mi.default.isOffSendToMe&&this.chatboxController&&Rt.default.getConversation(mi.default.sendToMeId).then((s=>{if(e===R.MSG_GIF&&t.url){var i;let e={hd:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},original:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},normal:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url}};null===(i=this.chatboxController)||void 0===i||i._sendMessage(s,R.MSG_GIF,e,null,null,null,null,null)}Object($t.e)({type:Ai.ConversationListActions.SELECT_CONVERSATION,payload:s}),this.sidebar.updateSelectedId(mi.default.sendToMeId)}))},this.handleSendMessageError=(e,t,s)=>{var i,n;if(Rt.default.deleteMessageById(t.msgId,t.conversationId),null===(i=this.chatboxController)||void 0===i||i._cleanUpLocalTTLItem(t),rt.p.isDelSendingMsg(t.clientId))return;const a=t.convertToUIMessageObject();return null===(n=this.chatboxController)||void 0===n||n._handleMessageFailure(e,t,a,s,!0),e},this.broadCastMessage=(e,t,s,i)=>{if(e&&t)for(let o=0;o<e.length;o++){const l=e[o];if(l){let e=l.userId,o=e.startsWith(R.GROUPID_PREFIX);if(t.msgType===R.MSG_STICKER){var n;const c=$l.a.next();t&&t.sendSrc&&Rl.c.track(c,t.sendSrc);const d=ho.default.getMsgIdSendingFromCliMsgId(c),u=new Kl.c(rt.p.getSessionUserId(),e,d,c,R.MSG_STICKER,o),h=ql.a.instance().isOnE2ee(l.userId);if(u.updateMessageContentProp(Kl.a.STICKER,t.message),h){var a;const e={id:u.content.sticker.id,catId:u.content.sticker.cateId,type:u.content.sticker.type};var r;if(null!==(a=t.message)&&void 0!==a&&a.fssInfo)e.extInfo=null===(r=t.message)||void 0===r?void 0:r.fssInfo;u.updateMessageContentProp(Kl.a.STICKER,e),u.e2eeStatus=R.MSG_E2EE}uo.default.sendMsgObject(u,null,null,R.RETRY_MSG_TIMEOUT_DEFAULT).then((t=>{if(s){var n;const t=$l.a.next(),i=ho.default.getMsgIdSendingFromCliMsgId(t);let a=new Kl.c(rt.p.getSessionUserId(),e,i,t,R.MSG_TEXT,o);a.updateMessageContentProp(Kl.a.TEXT,s),h&&(a.e2eeStatus=R.MSG_E2EE),uo.default.sendMsgObject(a,null,null,R.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{h&&(e=ho.default.parseE2eeResp(e),this.chatboxController._sentMessage(a,e))})).catch((e=>{this.handleSendMessageError(e,a,l)})),null===(n=this.chatboxController)||void 0===n||n._showLocalMessage(a,l)}h&&(t=ho.default.parseE2eeResp(t),this.chatboxController._sentMessage(u,t)),i&&i(t)})).catch((e=>{ho.default.logCoreError("BroadcastErr: ",e),this.handleSendMessageError(e,u,l),i&&i(e)})),null===(n=this.chatboxController)||void 0===n||n._showLocalMessage(u,l)}else if(t.msgType===R.MSG_TEXT&&s){const t=$l.a.next(),n=ho.default.getMsgIdSendingFromCliMsgId(t);let a=new Kl.c(rt.p.getSessionUserId(),e,n,t,R.MSG_TEXT,o);a.updateMessageContentProp(Kl.a.TEXT,s);ql.a.instance().isOnE2ee(l.userId)&&(a.e2eeStatus=R.MSG_E2EE),uo.default.sendMsgObject(a,null,null,R.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{i&&i(e)})).catch((e=>{this.handleSendMessageError(e,a,l),i&&i(e)}))}}}},this.handleEvent=(e,t)=>{if(e===Ai.ConversationListActions.SELECT_CONVERSATION){const e=this._getStateByWindowId(Go.c);if(t.userId!==e.conversationId)return this._updateStateByWindowId(Go.c,(e=>Object(f.a)(Object(f.a)({},e),{},{conversationId:t.userId}))),Object(hs.h)(this.name,Go.c),void this.dispatchEvent(new Wl.a(t.userId,Go.c))}},this.name=Hl.a,this.key="windowId",this.init()}get chatboxController(){const e=this.sidebar.getState().selectedId;return zl.default.getChatBoxControllerByConvId(e||Go.b)}onInviteFriend(){const e=[Ql];ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.SHARE_MSG_COMPOSE,params:{messages:e,title:os.a.str("STR_INVITE_FRIEND_1"),disableGroup:!0,disablePcUser:!0,callback:(e,t)=>{Fi.default.send(Ai.SideBarActions.SEND_INVITATION,{target:e,message:(null==t?void 0:t.length)>0?t[0]:"",link:`https://${mi.default.CONFIG_DOMAIN}/may-tinh`})}}})}onWhatNew(){ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.APP_UPDATE_INFO,params:{data:Rt.default.getCacheRecentUpdate(),isManual:!0}})}showMyProfile(){let e=rt.p.getSessionUserId();ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})}get mainWindowConversationId(){return this._getStateByWindowId(Go.c).conversationId}doLogout(e){let t=rt.p.getSessionUserId();e&&e.del_history?ki.g.setClearData(t,1):ki.g.setClearData(t,0),ec.a.logout(),tc.a.logout(),Xl.a.logout().catch((e=>{e.error_code&&18032===e.error_code&&ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.CHANGE_PW})}))}init(){Fi.default.subscribe(this.handleEvent)}getItem(e,t){return this._getStateByWindowId(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(f.a)({},ic),this.data.set(e,t)),t}_updateStateByWindowId(e,t){const s=t(this._getStateByWindowId(e));this.data.set(e,s)}})||Zl)||Zl)||Zl);var nc,ac=s("OI//");let rc=i.ModuleContainer.injectable()(nc=class{async get(e){return Zo.default.getGroupById(e)}async getMulti(e){const t=await Zo.default.getGroupsByIds(e);return Object.values(t)}async getAll(){return await Zo.default.getGroupsList()}})||nc;var oc;let lc=i.ModuleContainer.injectable()(oc=function(e,t){return i.ModuleContainer.inject(ac.c)(e,void 0,0)}(oc=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,1)}(oc=Reflect.metadata("design:type",Function)(oc=Reflect.metadata("design:paramtypes",[void 0===ac.c?Object:ac.c,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(oc=class{constructor(e,t){this.groupRepository=e,this.logger=void 0,this.logger=t.createZLogger("groups",["group-manager"])}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new ac.a(e))))).catch((e=>(this.logger.zsymb(18,"2jovyB",(()=>["getAll error. return [].",{reason:e}])),[])))}getMulti(e){return this.groupRepository.getMulti(e).then((e=>e.map((e=>new ac.a(e)))))}get(e){return this.groupRepository.get(e).then((e=>e?new ac.a(e):void 0)).catch((e=>{this.logger.zsymb(18,"bXbqZv",(()=>["get error. return undefined.",{reason:e}]))}))}})||oc)||oc)||oc)||oc)||oc;i.ModuleContainer.registerSingleton(ac.c,rc),i.ModuleContainer.registerSingleton(ac.b,lc);var cc=s("MqnV"),dc=s("+wBa");const uc=Object(i.define)("message-controller");var hc;let gc=Object(i.injectable)()(hc=function(e,t){return Object(i.inject)(jo.ConversationRepository)(e,void 0,0)}(hc=function(e,t){return Object(i.inject)(uc)(e,void 0,1)}(hc=function(e,t){return Object(i.inject)(jo.MuteDataManager)(e,void 0,2)}(hc=Reflect.metadata("design:type",Function)(hc=Reflect.metadata("design:paramtypes",[void 0===jo.ConversationRepository?Object:jo.ConversationRepository,"undefined"==typeof IMessageController?Object:IMessageController,void 0===jo.MuteDataManager?Object:jo.MuteDataManager])(hc=class{constructor(e,t,s){this.conversationRepository=e,this.messageLocalController=t,this.muteManager=s}getAllConvIds(){return this.conversationRepository.getAllConvIds()}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new jo.Conversation(t,this,this.messageLocalController)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){return!!this.muteManager.isMuted(e)}})||hc)||hc)||hc)||hc)||hc)||hc;var mc;let pc=i.ModuleContainer.injectable()(mc=function(e,t){return i.ModuleContainer.inject(jo.ConvInfoDataManager)(e,void 0,0)}(mc=Reflect.metadata("design:type",Function)(mc=Reflect.metadata("design:paramtypes",[void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager])(mc=class{constructor(e){this.convManager=e}getAllConvIds(){return this.convManager.getAllConvIds()}get(e){return this.convManager.getConvById(e)}})||mc)||mc)||mc)||mc;var fc=s("SVh1");var vc=new class{constructor(){}showMyProfile(){ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:rt.p.getSessionUserId()})}},bc=s("idnp"),Ic=s("mT88");var yc=Object(i.define)("conversation-life-cycle-broadcast-channel");let _c=function(e){return e.WillClose="WillClose",e.DidClose="DidClose",e.WillOpen="WillOpen",e.DidOpen="DidOpen",e.WillDelete="WillDelete",e.DidDelete="DidDelete",e}({});class Cc extends Fe.a{constructor(e,t){super(e),this.type=e,this.conversationID=t}}class Oc extends Cc{constructor(e,t){super(_c.WillClose,e),this.conversationID=e,this.windowID=t}}class Ec extends Cc{constructor(e,t){super(_c.DidClose,e),this.conversationID=e,this.windowID=t}}class Mc extends Cc{constructor(e,t){super(_c.WillDelete,e),this.conversationID=e,this.windowID=t}}class Sc extends Cc{constructor(e,t){super(_c.DidDelete,e),this.conversationID=e,this.windowID=t}}class Tc extends Cc{constructor(e,t){super(_c.WillOpen,e),this.conversationID=e,this.windowID=t}}class wc extends Cc{constructor(e,t){super(_c.DidOpen,e),this.conversationID=e,this.windowID=t}}const Rc=[],Lc=[],Dc=[],Ac=[],Fc=[],jc=[],Pc={[_c.WillClose]:{targets:Rc,callback:"onConversationWillClose"},[_c.DidClose]:{targets:Lc,callback:"onConversationDidClose"},[_c.WillDelete]:{targets:Dc,callback:"onConversationWillDelete"},[_c.DidDelete]:{targets:Ac,callback:"onConversationDidDelete"},[_c.WillOpen]:{targets:Fc,callback:"onConversationWillOpen"},[_c.DidOpen]:{targets:jc,callback:"onConversationDidOpen"}};function kc(e,t){return e.push(t),function(e){const t=new Set,s=[];for(let i=0;i<e.length;i++){const n=e[i];t.has(n)||(t.add(n),s.push(n))}return s}(e)}function Nc(){return function(e){kc(Lc,e)}}function Uc(){return function(e){kc(Fc,e)}}let Bc;var xc={GetModule:function(){return Bc||(Bc=i.ModuleContainer.resolve(yc)),Bc}},Gc=s("s9sK"),zc=s("44Ud"),Vc=s("E/Lo");Kl.c;var Hc,Wc=s("SWHF"),$c=s("7gRy");function Kc(e,t,s){if(ns.default.isOA(t)){let n=0;switch(e){case Ii.a.ConvItem:n=8001;break;case Ii.a.Support:n=1500;break;case Ii.a.Notify:n=1402;break;case Ii.a.SearchList:n=i.ModuleContainer.resolve(No.SearchController).isShowRecentSearch?1252:1251;break;case Ii.a.MessageOnMessaging:n=ho.default.isGroup(s)?1058:s&&ns.default.isOA(s)?1108:1008;break;case Ii.a.UriHelper:n=100}as.default.logActionInfoV2(as.FeaturesInfo.OpenOfficalAccount,1,{src_open:n,oa_id:t},[t])}}const qc="[Conversation controller]";function Qc(...e){ho.default.logCoreInfo(`${qc} - `,e)}let Zc=Object(i.singleton)()(Hc=Object(i.injectable)()(Hc=function(e){Ic.d.GetChildWindowModuleManager().registerModule(Gc.a,e,{isSingleton:!0})}(Hc=function(e,t){return Object(i.inject)(jo.PreviewDataManager)(e,void 0,0)}(Hc=function(e,t){return Object(i.inject)(Wc.b)(e,void 0,1)}(Hc=function(e,t){return Object(i.inject)(jl.e)(e,void 0,2)}(Hc=function(e,t){return Object(i.inject)(jl.o)(e,void 0,3)}(Hc=function(e,t){return Object(i.inject)(No.SidebarController)(e,void 0,4)}(Hc=function(e,t){return Object(i.inject)(jo.ConvInfoDataManager)(e,void 0,5)}(Hc=Reflect.metadata("design:type",Function)(Hc=Reflect.metadata("design:paramtypes",[void 0===jo.PreviewDataManager?Object:jo.PreviewDataManager,void 0===Wc.b?Object:Wc.b,void 0===jl.e?Object:jl.e,void 0===jl.o?Object:jl.o,void 0===No.SidebarController?Object:No.SidebarController,void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager])(Hc=class{constructor(e,t,s,i,n,a){this.previewManager=e,this.adminSettingController=t,this.communityController=s,this.groupLoadInfoController=i,this.sidebar=n,this.convDataManager=a,this.ipc=void 0,this.lastOpenConv=new Map,this._es=void 0,this.onRequestJumtoMsg=(e,t)=>{const s=t.conversation,i=e===Ai.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT||xo.a.getListChatBoxViewCurrent().includes(null==s?void 0:s.userId)||s.byPassPIN;if(!s)return;if(s&&!i&&xo.a.isThreadHidden(s.userId))return Object($o.b)({type:e,payload:t},!0),void Qc("req jum to msg rejected because hidden chat");jr.default.Fps.record(jr.MetricName.fps_jump_to_msg),Qc("req jum to msg open on main"),Object($o.b)({type:e,payload:t},!0);const n=bc.b.fromJumpMessage();this.openConversationForJump(s.userId,n)},this.tryToFocusChild=(e,t)=>!!zl.default.isOpenChildWindowByConvId(e)&&(Qc("Open conv forward because already open in child => call focus"),zl.default.focusOnChildWindow(e,null==t?void 0:t.callPoint),!0),this.handleOutConversation=e=>{this.closeConversation(e.convId,{removed:!0})},this.listenEvent()}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}listenEvent(){Fi.default.subscribe(((e,t)=>{switch(e){case Ai.ConversationListActions.SELECT_CONVERSATION_HIDDEN:this.sidebar.updateSelectedId(t.userId);break;case Ai.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH:this.onRequestJumtoMsg(Ai.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH,t);break;case Ai.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:this.onRequestJumtoMsg(Ai.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT,t)}})),this.convDataManager.addEventListener(so.b.DeleteConv,this.handleOutConversation),this.convDataManager.addEventListener(so.b.EmptyConv,this.handleOutConversation),this.convDataManager.addEventListener(so.b.LeaveGroup,this.handleOutConversation)}isConvOpeningInMain(e){const t=this.eventStore.getState(),s=this.sidebar.getState().selectedId;return t&&t.chatview.view===Al.c.CHAT_VIEW&&s===e}openConversationForJump(e,t=bc.a){return new Promise((async s=>{if(Qc(`Request open conv for jum: ${e}`),!e||this.isConvOpeningInMain(e)){if(Qc(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||zl.default.focusOnMainWindow()}return s(!1)}let i=Go.c;if(!(await this.conversationShouldOpen(e)))return s(!1);this.conversationWillOpen(e,i);const n=this.sidebar.getSelectedId(i);n&&n!==e&&this.conversationWillClose(n,i);let a=!1;if(t.window===fc.b.Child)return a=this.tryToFocusChild(e,t),s(a);if(t.window===fc.b.PreferChild){if(a=this.tryToFocusChild(e,t),a)return s(!0)}else t.window===fc.b.MainAndChild&&(a=this.tryToFocusChild(e,t));a||zl.default.focusOnMainWindow(),Fi.default.send(Ai.ConversationListActions.SELECT_CONV_MINOR,{userId:e}),Object($o.b)({type:Ai.ConversationListActions.OPEN_CONV_FOR_JUMP,payload:{userId:e}}),this.sidebar.updateSelectedId(e),s(!0),n&&n!==e&&this.conversationDidClose(n,i),this.conversationDidOpen(e,i),Kc(t.callPoint,e)}))}openConversationInChildWindow(e,t,s){return this.conversationWillOpen(e,e),zl.default.openConvInNewWindow(e,t,s),this.conversationDidOpen(e,e),Kc(fc.a.ConvItem,e),Promise.resolve(!0)}onCloseChildWindow(e){this.conversationDidClose(e,e)}onOpenChildWindow(e){}openConversation(e,t=bc.a){return new Promise((async(s,n)=>{var a;if(Qc(`Request open conv from: ${e} - ${t.callPoint}`),!e||this.isConvOpeningInMain(e)&&!t.force){if(Qc(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||t.silently||zl.default.focusOnMainWindow()}return s(!1)}let r=Go.c;const o=this.sidebar.getSelectedId(r),l=rt.p.getSessionUserId();if(e==l)return vc.showMyProfile(),s(!1);jr.default.Fps.record(jr.MetricName.fps_switch_conv);if(!(await this.conversationShouldOpen(e)))return s(!1);this.conversationWillOpen(e,r),o&&o!==e&&this.conversationWillClose(o,r);let c=!1;if(t.window===fc.b.Child)return c=this.tryToFocusChild(e,t),s(c);if(t.window===fc.b.PreferChild){if(c=this.tryToFocusChild(e,t),c)return s(!0)}else t.window===fc.b.MainAndChild&&(c=this.tryToFocusChild(e,t));let d=t.credentConv;if(d||(d=await Rt.default.getLikeConversation(e).catch((e=>{Qc(`Failure to load conv from store ${e}`)})),Qc(`Try to use storage conv: ${!!d}`)),d||(d=t.defaultConv,Qc(`Try to use default conv: ${!!d}`)),!d)return Qc(`Open conv not exists: ${e}`),s(!1);c||t.silently||zl.default.focusOnMainWindow(),Fi.default.send(Ai.ConversationListActions.SELECT_CONV_MINOR,d);const u=xo.a.isThreadHidden(e);u&&xo.a.checkShowUnreadHiddenChat(e),t.byPassPIN?(d=Object(f.a)({},d),d.byPassPIN=1):delete d.byPassPIN,this.eventStore.dispatch({type:Ai.ConversationListActions.SELECT_CONVERSATION,payload:d}),Fi.default.send(Ai.ConversationListActions.SELECT_CONVERSATION,{userId:d.userId,needScroll:t.callPoint!==fc.a.ConvItem,callPoint:t.callPoint});(!u||t.byPassPIN||xo.a.getListChatBoxViewCurrent().includes(d.userId))&&this.sidebar.updateSelectedId(e),s(!0),o&&o!==e&&this.conversationDidClose(o,r),this.conversationDidOpen(e,r),i.ModuleContainer.resolve(ms.b).promoteMigrateByOpenConv(e),Kc(t.callPoint,e,null===(a=t.credentConv)||void 0===a?void 0:a.userId)}))}closeConversation(e,t={}){return new Promise((s=>{if(e&&this.sidebar.getState().selectedId!==e)return s(!1);const{windowId:i=Go.c,removed:n}=t;if(this.conversationWillClose(e,i),i===Go.c){const e={conversation:null,convId:null};this.eventStore.dispatch({type:Ai.ConversationListActions.SELECT_CONVERSATION,payload:e}),Fi.default.send(Ai.ConversationListActions.SELECT_CONVERSATION,e),n?this.sidebar.updateSelectedIdWithoutPrevious(null):this.sidebar.updateSelectedId(null)}this.conversationDidClose(e,i),s(!0)}))}closeAllConversations(){return Promise.resolve(!0)}deleteConversation(e,t=Go.c){return new Promise((async s=>{if(this.conversationWillDelete(e,t),await Ao.default.deleteConversation(e,!0,t),t===Go.c){const i={userId:null};this.eventStore.dispatch({type:Ai.ConversationListActions.SELECT_CONVERSATION,payload:i}),Fi.default.send(Ai.ConversationListActions.SELECT_CONVERSATION,i),this.sidebar.updateSelectedId(null),s(!0),this.conversationDidDelete(e,t)}else s(!1)}))}pinConversation(e){return Promise.resolve(!0)}renameConversation(e){return Promise.resolve(!0)}getLastOpenConv(e){return this.lastOpenConv.get(e)}isOpeningConversation(e){const t=this.sidebar.getSelectedId();return!(!t||t!=e)||zl.default.isOpenChildWindowByConvId(e)}conversationWillClose(e,t){xc.GetModule().conversationWillClose(e,t)}conversationDidClose(e,t){xc.GetModule().conversationDidClose(e,t)}conversationShouldOpen(e){return Qc(`Should open conv ${e}`),Qc(`Will open conv ${e}`),this.lastOpenConv.set(e,Date.now()),Promise.resolve(!0)}conversationWillOpen(e,t){zc.b.start(zc.a.ART,{convId:e}),Qc(`Conversation ${e} will be opened on windowID:${t}`),xc.GetModule().conversationWillOpen(e,t)}conversationDidOpen(e,t){jr.default.start(jr.MetricName.open_conversation,e),jr.default.start(jr.MetricName.open_conversation_no_preload,e),Qc(`Did open conv ${e}`);const s=i.ModuleContainer.resolve(jo.ConvInfoDataManager).getConvByIdSync(e);!i.ModuleContainer.resolve(jo.ConvInfoDataManager).getLeaveType(s)&&this.adminSettingController.onLoadSetting(e),this.communityController.onConversationDidOpen(e),this.groupLoadInfoController.onOpenConversation(e),i.ModuleContainer.resolve(Lr.a).onOpenConversation(e),i.ModuleContainer.resolve($c.a).onOpenConversation(e),setTimeout((()=>{this.previewManager.revalidate(e)}),0),xc.GetModule().conversationDidOpen(e,t)}conversationWillDelete(e,t){return Qc(`Will delete conv ${e}`),xc.GetModule().conversationWillDelete(e,t),Promise.resolve()}conversationDidDelete(e,t){Qc(`Did delete conv ${e}`),this.lastOpenConv.delete(e),xc.GetModule().conversationDidDelete(e,t)}})||Hc)||Hc)||Hc)||Hc)||Hc)||Hc)||Hc)||Hc)||Hc)||Hc)||Hc;var Jc,Yc=s("UYQr");let Xc=Object(i.injectable)()(Jc=class{constructor(){this._activeConversationInfo=new Map}activateConversation(e,t){const s=this._getKey(e),i=this._activeConversationInfo.get(s);i?-1===i.windowIds.indexOf(t)&&(i.windowIds.push(t),this._activeConversationInfo.set(s,i)):this._activeConversationInfo.set(s,{convId:e,windowIds:[t]})}deactivateConversation(e,t){const s=this._getKey(e),i=this._activeConversationInfo.get(s);if(i){const e=i.windowIds.indexOf(t);-1!==e&&i.windowIds.splice(e,1),0===i.windowIds.length?this._activeConversationInfo.delete(s):this._activeConversationInfo.set(s,i)}}getActiveConversationInfo(e){const t=this._activeConversationInfo.get(this._getKey(e));return t?{convId:t.convId,windowIds:[...t.windowIds]}:{convId:"",windowIds:[]}}getActiveConvIdList(){let e=[];return this._activeConversationInfo.size>0&&(e=Array.from(this._activeConversationInfo.keys())),e}_getKey(e){return e}})||Jc;var ed=s("2rzQ"),td=s("S8fy"),sd=s("+tVb"),id=s("UkBb"),nd=s("Qtro"),ad=s("oiWN"),rd=s("zo6P");let od=function(e){return e.ABORTED="ABORTED",e.LAST_MSG_PROCESSED="LAST_MSG_PROCESSED",e}({});const ld=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.offline2Online,["last-message-processed-tracker"]);class cd extends Fe.b{constructor(...e){super(...e),this.lastMsgId=null,this.lastProcessedMsgId=null}abort(){this.dispatchEvent(new Fe.a(od.ABORTED)),this.removeAllEventListener()}onLastMessage(e){e?(this.lastMsgId=e,this.checkAndDispatchEventIfNeeded()):this.dispatchEventLastMessageProcessed()}onProcessedMessage(e){this.lastMsgId&&this.lastMsgId<e||(!this.lastProcessedMsgId||this.lastProcessedMsgId<e)&&(this.lastProcessedMsgId=e,this.checkAndDispatchEventIfNeeded())}checkAndDispatchEventIfNeeded(){const e=Number(this.lastMsgId),t=Number(this.lastProcessedMsgId),s=e&&t&&e===t;ld.zsymb(0,"LOW4vf","checkAndDispatchEventIfNeeded",{lastMsgId:e,lastProcessedMsgId:t,shouldDispatchEvent:s}),s&&this.dispatchEventLastMessageProcessed()}dispatchEventLastMessageProcessed(){this.dispatchEvent(new Fe.a(od.LAST_MSG_PROCESSED)),this.removeAllEventListener()}}var dd,ud=function(e){return e[e.BATCHING=0]="BATCHING",e[e.IMMEDIATELY=1]="IMMEDIATELY",e}(ud||{});let hd=Object(i.injectable)()(dd=Object(td.g)()(dd=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(dd=Reflect.metadata("design:type",Function)(dd=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(dd=class extends Fe.b{constructor(e){super(),this.logger=void 0,this.config=void 0,this.mode=void 0,this.intervalBatching=void 0,this.lastProcessedMessageTracker=void 0,this.queueSignalRenderItems=void 0,this.queueSignalRenderLists=void 0,this.signalRenderItem=(...e)=>{switch(this.mode){case ud.BATCHING:this.pushQueueSignalRenderItems(...e);break;case ud.IMMEDIATELY:default:Object(hs.h)(...e),this.dispatchEvent(new Fe.a(rd.b.SIGNAL_RENDER_ITEM))}},this.signalRenderList=(...e)=>{switch(this.mode){case ud.BATCHING:this.pushQueueSignalRenderLists(...e);break;case ud.IMMEDIATELY:default:Object(hs.j)(...e),this.dispatchEvent(new Fe.a(rd.b.SIGNAL_RENDER_LIST))}},this.onStartPreprocessing=()=>{this.config.nestedKey("conv_ui_batching_updater.enable")&&this.startBatching()},this.onDonePullOfflineData=e=>{var t;this.mode===ud.BATCHING&&(this.logger.zsymb(3,"HQ5-_U",["receive done pull offline event","TppDX-"]),null!=e&&e.maxMsgId?this.logger.zsymb(3,"aK_6Ro",["receive last max msg {}","-m_8RG"],null==e?void 0:e.maxMsgId):this.logger.zsymb(3,"mo15iq",["don't have any offline data","WumDq6"]),null===(t=this.lastProcessedMessageTracker)||void 0===t||t.onLastMessage(null==e?void 0:e.maxMsgId))},this.logger=e.createZLogger(Ve.ZLoggerNametags.offline2Online,["conversation-ui-updater"]),this.config=ad.b,this.mode=ud.IMMEDIATELY,this.intervalBatching=null,this.lastProcessedMessageTracker=null,this.queueSignalRenderItems=[],this.queueSignalRenderLists=[],this.registerListener()}registerListener(){sd.a.getInstance().addEventListener("start-preprocess",this.onStartPreprocessing),id.default.addEventListener(id.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{const{nextChatHandler:t,prevChatHandler:s}=e;null==s||s.unsubcribe(nd.b.ON_DONE_OFFLINE,this.onDonePullOfflineData),null==t||t.subcribe(nd.b.ON_DONE_OFFLINE,this.onDonePullOfflineData)})),this.config.addEventListener("update",(()=>{0===this.config.nestedKey("conv_ui_batching_updater.enable")&&(this.logger.zsymb(3,"LeXGLQ",["receive disable config, let stop batching immediately","39G648"]),this.stopBatchingImmediately())}))}pushQueueSignalRenderItems(...e){this.queueSignalRenderItems.push(e)}pushQueueSignalRenderLists(...e){this.queueSignalRenderLists.push(e)}flushQueueSignalRender(){if(ad.b.nestedKey("debug.enable_ui_batching_log")&&ro.b.logUIBatching([...this.queueSignalRenderItems],[...this.queueSignalRenderLists]),this.queueSignalRenderItems.length>0){this.logger.zsymb(0,"AMA5SQ","flush queue items, queue size",this.queueSignalRenderItems.length);const e=Date.now().toString();Object(hs.k)(e);for(const t of this.queueSignalRenderItems)Object(hs.g)(e,...t);Object(hs.c)(e),this.queueSignalRenderItems=[],this.dispatchEvent(new Fe.a(rd.b.FLUSH_QUEUE_ITEM))}if(this.queueSignalRenderLists.length>0){this.logger.zsymb(0,"w9yhsw","flush queue list, queue size",this.queueSignalRenderLists.length);const e=[];for(const[t,s,i]of this.queueSignalRenderLists){const n=[t,s,Boolean(i)].join("::");e.includes(n)||(e.push(n),Object(hs.j)(t,s,i))}this.queueSignalRenderLists=[],this.dispatchEvent(new Fe.a(rd.b.FLUSH_QUEUE_LIST))}}startBatching(){this.logger.zsymb(0,"VEj49f","start batching"),this.mode=ud.BATCHING,this.startIntervalFlushQueue(),this.setupStopBatching()}setupStopBatching(){var e;this.logger.zsymb(0,"QhQ1l4","setup stop batching"),null===(e=this.lastProcessedMessageTracker)||void 0===e||e.abort();const t=i.ModuleContainer.resolve(No.ConvListController),s=this.lastProcessedMessageTracker=new cd,n=t.addEventListener(so.c.PreviewChanged,(e=>{var t;const i=null===(t=e.payload)||void 0===t?void 0:t.changedItem;null!=i&&i.msgId&&s.onProcessedMessage(null==i?void 0:i.msgId)}));s.addEventListenerOnce(od.ABORTED,(()=>{this.logger.zsymb(3,"yxKRSe",["aborted listener","Y6vp6Q"]),n()})),s.addEventListenerOnce(od.LAST_MSG_PROCESSED,(()=>{this.logger.zsymb(3,"cONLDM",["last message processed, let stop batching","H0kPWJ"]),this.stopBatchingWithDelay(),n()}))}stopBatchingWithDelay(){const e=this.config.nestedKey("conv_ui_batching_updater.delay_after_stop_batching");this.logger.zsymb(3,"JiwI9y",["will stop batching after {}ms","QQRny3"],e),setTimeout((()=>{this.stopBatchingImmediately()}),e)}stopBatchingImmediately(){this.flushQueueSignalRender(),this.stopIntervalFlushQueue(),this.mode=ud.IMMEDIATELY,this.logger.zsymb(0,"Zc-qmt","stop batching")}startIntervalFlushQueue(){var e;null===this.intervalBatching&&this.logger.zsymb(0,"jzYO_N","start interval flush queue"),null!==(e=this.intervalBatching)&&void 0!==e||(this.intervalBatching=setInterval((()=>{this.flushQueueSignalRender()}),this.config.nestedKey("conv_ui_batching_updater.interval_batching_update")))}stopIntervalFlushQueue(){this.intervalBatching&&clearInterval(this.intervalBatching),this.intervalBatching=null,this.logger.zsymb(0,"-56mAQ","stop interval flush queue")}})||dd)||dd)||dd)||dd)||dd;i.ModuleContainer.registerSingleton(rd.a,hd);var gd,md=s("TeMN"),pd=s("Bzy+"),fd=(s("EHdh"),s("Ln14")),vd=s("bdot"),bd=s("cfFl"),Id=s.n(bd);const yd={userId:R.CONV_FILTER.STRANGER,label:null,isGroup:!1,respondedByMe:!1,numMsg:0,pinned:0,outside:0,topOut:!1,infoCheckSearch:null},_d=["userId","label","firstSmsLocalId","lastSmsLocalId","isGroup","respondedByMe","numMsg","pinned","outside","lastActionId","topOutImprTimeOut","topOutTimeOut","syncFromMobile","topOut","localType","infoCheckSearch","preLastSmsLocalId"];Object(ko.b)(fd.c)(gd=function(e,t){return i.ModuleContainer.inject(md.b)(e,void 0,0)}(gd=Reflect.metadata("design:type",Function)(gd=Reflect.metadata("design:paramtypes",[void 0===so.IReactiveDB?Object:so.IReactiveDB])(gd=class extends Fe.b{constructor(e){super(),this.DBConvInfo=e,this.name=void 0,this.key=void 0,this.data=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.fetchAllHolder=void 0,this.preloadCached=void 0,this._pm=void 0,this.pinEventQueue=void 0,this.labelEventQueue=void 0,this.doneEventQueue=void 0,this.name=fd.a,this.key="convId",this.data=new Map,this.didInit=!1,this.doneLoadDB=!1,this.fetchAllHolder=null,this.preloadCached=pd.a.getInstance(),this._pm=null,this.pinEventQueue=[],this.labelEventQueue=[],this.doneEventQueue=!1}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(jo.PreviewDataManager)),this._pm}get unreadManager(){return Co.a.UnreadDataManager}init(){if(this.didInit)return Promise.resolve();const e=jr.default.start(jr.MetricName.load_conversation_list),t=()=>{e.end(),Co.a.ConvListController.removeEventListener(so.c.LoadPreviewDone,t)};return Co.a.ConvListController.addEventListener(so.c.LoadPreviewDone,t),this.didInit=!0,this.loadData()}async loadData(){this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll());const e=await this.fetchAllHolder.catch((e=>{ho.default.logCoreInfo(`[${this.name}] - load conv from DB got error ${e}`)}))||[],t=await this.onLoadDataFromDB(e);ho.default.logCoreInfo(`[${this.name}] - done load db ${e.length}`),this.doneLoadDB=!0,this.doIdleTask(),this.broadcastEvent(so.b.DoneLoadDB,"",e),this.previewManager.migrate(t.map((e=>e.userId))),this.setCacheData(R.CONV_FILTER.STRANGER,yd,!0)}async doIdleTask(){const e=this.pinEventQueue.slice(),t=this.labelEventQueue.slice();this.pinEventQueue=[],this.labelEventQueue=[];const s=Id.a.series(e),i=Id.a.series(t);return Promise.all([s,i]).then((e=>this.pinEventQueue.length||this.labelEventQueue.length?this.doIdleTask():(this.doneEventQueue=!0,e)))}getItem(e,t){return this.data.get(e.key)}getList(e,t){return e.key===fd.b.ALL?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}async onLoadDataFromDB(e){const t=await Bo.ConvList.filterOutdatedConv(e);ho.default.logCoreInfo(`[${this.name}] - done filter outdate ${e.length} ${t.length}`);const s=(new Date).getTime().toString(),i=[];Object(hs.k)(s);for(let n=0;n<t.length;n++){if(!t[n].userId)continue;const e=Object(f.a)({},t[n]),a=this.data.get(e.userId);if(e.verified=!0,void 0===e.isGroup&&(e.isGroup=e.userId.startsWith(R.GROUPID_PREFIX)),a){if(!a.verified){const t=this.mergeConv(e,a);t.verified=!0,this.setCacheData(e.userId,t),Object(hs.g)(s,this.name,e.userId),this.updateInDB(t)}}else this.setCacheData(e.userId,e),Object(hs.g)(s,this.name,e.userId);e.infoCheckSearch&&(e.infoCheckSearch&&ho.default.msgTypeValid(e.infoCheckSearch.lastType)?gl.a.pushCacheLastChat(e.userId,e.infoCheckSearch.lastMessageTime):e.numMsg&&e.numMsg>1&&i.push(e.userId))}return i.length>0&&gl.a.cacheCheckLastChatInDb(i),Object(hs.c)(s),t}onReceiveNewMessages(e,t,s={outside:void 0,isGroup:!1}){return new Promise(((i,n)=>{var a,r;if(!t||t.length<0)return n("Empty msgs");const o=t[t.length-1],l=t[0],c=this.data.get(e),d=Bo.ConvList.getLastValidMsg(t);let u,h;d&&(u={lastMessageTime:Number(d.sendDttm),lastType:d.msgType},gl.a.pushCacheLastChat(e,u.lastMessageTime)),o.msgType===R.MSG_INFO&&(null==c||null===(a=c.infoCheckSearch)||void 0===a?void 0:a.lastMessageTime)>Number(o.sendDttm)&&(h=null==c?void 0:c.lastSmsLocalId);const g={userId:e,firstSmsLocalId:l.msgId,isGroup:s.isGroup||e.startsWith(R.GROUPID_PREFIX),numMsg:t.length,respondedByMe:Jo.default.includeMyMessage(t),pinned:0,label:null,topOut:o.topOut,verified:!1,lastSmsLocalId:h||o.msgId,outside:s.outside,cloudMore:!1,infoCheckSearch:u};if(this.preloadCached&&this.preloadCached.onNewMsg(e,o),c){const t=this.mergeConv(Object(f.a)({},c),g);this.setCacheData(e,t),this.shouldSignalUpdate(c,t)&&Object(hs.h)(this.name,e),c.verified&&this.updateInDB(t),i(t)}else{const s=zo.a.getLabelObjByConversaionId(e);if(g.label=s?s.id:null,this.setCacheData(e,g,!0),this.doneLoadDB){g.verified=!0,this.updateInDB(g);return Jo.default.includeJoinEvent(t)&&(ho.default.logCoreInfo(`[${this.name}] - Detect join msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e)),i(g)}this.DBConvInfo.getById(e).then((t=>{const s=this.data.get(e);if(!s)return n("Internal logic handle wrong");let a=Object(f.a)({},s);a.verified=!0,t?s.verified||(a=this.mergeConv(a,t),this.setCacheData(e,a),this.shouldSignalUpdate(a,s)&&Object(hs.h)(this.name,e),this.updateInDB(a)):this.updateInDB(a),i(a)}))}c&&c.respondedByMe||null===(r=this.data.get(e))||void 0===r||!r.respondedByMe||(ho.default.logCoreInfo(`[${this.name}] - Detect first my msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e))}))}async onDeleteMessages(e,t){const s=this.data.get(e);if(ho.default.logCoreInfo(`[${this.name}] - onDeleteMessages #1 ${e} ${t.length}`),s&&s.verified){let i=!1;if(t.find((({msgId:e})=>s.firstSmsLocalId===e))){const t=await(await vd.b.getFirstMessage(e)).firstMsg;if(!t)return ho.default.logCoreInfo(`[${this.name}] - onDeleteMessages #4 ${e} `),this.forkDeleteCacheAndDB(e),{deletedId:e};s.firstSmsLocalId=null==t?void 0:t.msgId,i=!0}if(t.find((({msgId:e})=>s.lastSmsLocalId===e))){const t=await vd.b.getLastMessage(e,s.lastSmsLocalId);if(!t||t.length<1)return ho.default.logCoreInfo(`[${this.name}] - onDeleteMessages #5 ${e} ${!!t}`),this.forkDeleteCacheAndDB(e),{deletedId:e};s.lastSmsLocalId=t[0].msgId,i=!0}return ho.default.logCoreInfo(`[${this.name}] - onDeleteMessages #6 ${e} ${i}`),i&&(this.setCacheData(e,Object(f.a)({},s)),this.updateInDB(s)),{conversation:s,updated:i}}{const t=await(await vd.b.getFirstMessage(e)).firstMsg,s=await vd.b.getLastMessage(e),i=s&&s[0];if(!t||!i)return ho.default.logCoreInfo(`[${this.name}] - onDeleteMessages #2 ${e} ${!!t} ${!!i}`),Co.a.PinDataManager.isPinned(e)||this.onDeleteConversation(e),{deletedId:e};const n=await this.DBConvInfo.getById(e);let a=ho.default.msgTypeValid(i)?{lastMessageTime:i.sendDttm,lastType:i.msgType}:void 0;if(ho.default.logCoreInfo(`[${this.name}] - onDeleteMessages #3 ${e} ${!!n}`),n){let s=!1;n.firstSmsLocalId!==(null==t?void 0:t.msgId)&&(n.firstSmsLocalId=null==t?void 0:t.msgId,s=!0),n.lastSmsLocalId!==i.msgId&&(n.lastSmsLocalId=null==i?void 0:i.msgId,s=!0);const a=Object(f.a)(Object(f.a)({},n),{},{verified:!0});return this.setCacheData(e,a,!0),s&&this.updateInDB(a),{conversation:a,updated:!0}}{const s={userId:e,isGroup:e.startsWith(R.GROUPID_PREFIX),pinned:0,label:null,topOut:void 0,verified:!0,outside:null,cloudMore:!1,firstSmsLocalId:t.msgId,lastSmsLocalId:i.msgId,numMsg:2,respondedByMe:"0"==t.fromUid||"0"==i.fromUid,infoCheckSearch:a};return this.setCacheData(e,s,!0),this.updateInDB(s),{conversation:s,updated:!0}}}}getLeaveType(e){const t=null==e?void 0:e.localType;return t===R.LOCAL_CONVERSATION_TYPE.KICK_GROUP?"kick":t===R.LOCAL_CONVERSATION_TYPE.DISBAND_GROUP?"disband":void 0}mergeConv(e,t){const s=e=>null!=e&&("string"==typeof e?!e.includes("undefined")&&!e.includes("null"):"number"==typeof e&&!isNaN(e));let i=!1;return s(e.lastSmsLocalId)?s(t.lastSmsLocalId)&&(i=t.lastSmsLocalId>e.lastSmsLocalId):i=!0,i&&(e.preLastSmsLocalId=e.lastSmsLocalId||t.lastSmsLocalId,e.lastSmsLocalId=t.lastSmsLocalId,e.outside=t.outside),e.numMsg=(e.numMsg||0)+t.numMsg,e.respondedByMe=e.respondedByMe||t.respondedByMe,(!e.firstSmsLocalId||t.firstSmsLocalId&&t.firstSmsLocalId<e.firstSmsLocalId)&&(e.firstSmsLocalId=t.firstSmsLocalId),(!e.infoCheckSearch||!e.infoCheckSearch.lastMessageTime||t.infoCheckSearch&&t.infoCheckSearch.lastMessageTime>e.infoCheckSearch.lastMessageTime)&&(e.infoCheckSearch=t.infoCheckSearch),e.preLastSmsLocalId||(e.preLastSmsLocalId=t.lastSmsLocalId),!t.respondedByMe&&t.topOut&&(e.topOut=t.topOut),"string"!=typeof e.firstSmsLocalId&&(e.firstSmsLocalId=""+e.firstSmsLocalId),ho.default.isKickOrDisbandGroup(e)&&(e.localType=void 0),e}async onEmptyConversation(e){const t=await this.getConvById(e);if(ho.default.logCoreInfo(`[${this.name}] - onEmptyConversation ${e} ${!!t}`),!t)return;const s=Object(f.a)({},t);return delete s.firstSmsLocalId,delete s.lastSmsLocalId,s.numMsg=0,s.respondedByMe=!1,this.setCacheData(e,s,!0),this.broadcastEvent(so.b.EmptyConv,e),Object(hs.h)(this.name,e),Co.a.PinDataManager.isPinned(e)&&Co.a.PinDataManager.unpin([e]),this.updateInDB(s)}onDeleteConversation(e,t){ho.default.logCoreInfo(`[${this.name}] - onDeleteConversation ${e}`);const s=this.data.get(e);return s&&(s.leaveType=t),this.doDeleteConversation(e).then((i=>{let n;this.broadcastEvent(so.b.DeleteConv,e,s),"kick"===t?n=R.LOCAL_CONVERSATION_TYPE.KICK_GROUP:"disband"===t&&(n=R.LOCAL_CONVERSATION_TYPE.DISBAND_GROUP),n&&s&&this.createEmptyConvForUser(e,0,R.CONV_OT_STATE.none,Object(f.a)(Object(f.a)({},s),{},{localType:n}))}))}doDeleteConversation(e){const t=this.data.get(e);return ho.default.logCoreInfo(`[${this.name}] - doDeleteConversation ${e} ${!!t}`),t&&(this.data.delete(e),Object(hs.f)(this.name,e)),Co.a.PinDataManager.isPinned(e)&&Co.a.PinDataManager.unpinLocal([e]),this.deleteInDB(e)}onPinConversation(e,t){return new Promise((s=>{this.doneEventQueue?this.doUpdatePin(e,t).then(s):this.pinEventQueue.push((async()=>{const i=await this.doUpdatePin(e,t);s(i)}))}))}doUpdatePin(e,t){if(t&&Bo.ConvList.isStrangerV2(e))return Promise.resolve(null);if(!this.data.get(e)){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const s=new Map;return s.set("pinned",t),this.updateFields(e,s).then((s=>(this.broadcastEvent(so.b.ChangePinConv,e,t),s))).catch((t=>(ho.default.logCoreInfo(`[${this.name}] - doUpdatePin err`,t),this.data.get(e))))}onLeaveGroup(e,t){return t?(this.broadcastEvent(so.b.LeaveGroup,e),Promise.resolve()):(ho.default.logCoreInfo(`[${this.name}] - onLeaveGroup ${e}`),this.doDeleteConversation(e).then((t=>{this.broadcastEvent(so.b.LeaveGroup,e)})))}async onChangeConvLabel(e,t){return new Promise((s=>{const i=this.data.get(e);if(i&&i.label===t)return s(i);this.doneEventQueue?this.doUpdateConvLabel(e,t).then(s):this.labelEventQueue.push((async()=>{const i=await this.doUpdateConvLabel(e,t);s(i)}))}))}doUpdateConvLabel(e,t){if(!e)return ho.default.logCoreInfo(`[${this.name}] - doUpdateConvLabel with undefined ${t}`),Promise.resolve(null);const s=this.data.get(e);if(s&&s.label===t)return Promise.resolve(s);if(!s){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const i=new Map;return i.set("label",t),this.updateFields(e,i).then((i=>(this.unreadManager.onChangeConvLabel(e,null==s?void 0:s.label,t),i)))}onFetchConvLabels(e){if(!e||!Array.isArray(e))return;ho.default.logCoreInfo(`[${this.name}] - onChangeConvLabel ${e.length}`);const t={};this.getAllConv().then((s=>{for(let e=0;e<s.length;e++)t[s[e].userId]=1;for(let i=0;i<e.length;i++){const s=e[i].id,n=e[i].conversations;if(n)for(let e=0;e<n.length;e++){const i=n[e];delete t[i],this.onChangeConvLabel(i,s)}}for(const e in t)Object.hasOwnProperty.call(t,e)&&this.onChangeConvLabel(e,null)}))}onDeleteConvLabels(e){ho.default.logCoreInfo(`[${this.name}] - onDeleteConvLabels ${e.length}`),e.forEach((e=>{const t=e.conversations;if(t&&t.length)for(let s=0;s<t.length;s++)this.data.has(t[s])&&this.onChangeConvLabel(t[s],null)}))}async onUpdateMsgId(e,t,s){if(!t||!s||t===s)return Promise.reject("[Conv-info-manager]- call update with invalid params!");const i=this.data.get(e);let n=i||{},a=!1;if(!i||!i.verified){const t=await this.DBConvInfo.getById(e);if(!i&&!t){const t=await this.createEmptyConvForUser(e,0,void 0,{firstSmsLocalId:s,lastSmsLocalId:s});return this.setCacheData(e,t),t}i&&t?(n=this.mergeConv(i,t),a=!0):(n=i||t,n.verified=!0,a=!0)}return n.firstSmsLocalId&&n.firstSmsLocalId!==t||(a=!0,n.firstSmsLocalId=s),n.lastSmsLocalId&&n.lastSmsLocalId!==t||(a=!0,n.lastSmsLocalId=s),a&&(this.setCacheData(e,n),this.updateInDB(n)),n}async addOrUpdateConv(e,t,s,i,n,a){"number"==typeof t&&(t=""+t),"number"==typeof s&&(s=""+s);const r=this.data.get(e);ho.default.logCoreInfo(`[${this.name}] - addOrUpdateConv ${e} ${!!r} ${s}`);const o=e=>((!e.firstSmsLocalId||t&&t<e.firstSmsLocalId)&&(e.firstSmsLocalId=t),(!e.lastSmsLocalId||s&&s>e.lastSmsLocalId)&&(e.lastSmsLocalId=s),e.cloudMore=i,e.respondedByMe=e.respondedByMe||n,e.numMsg=(e.numMsg||0)+a,e);if(r&&r.verified){const t=o(r);return this.setCacheData(e,Object(f.a)({},t)),this.updateInDB(t),t}{const r=await this.DBConvInfo.getById(e);if(ho.default.logCoreInfo(`[${this.name}] - addOrUpdateConv #2 ${e} ${!!r}`),r){const t=o(r);return this.setCacheData(e,Object(f.a)(Object(f.a)({},t),{},{verified:!0})),this.updateInDB(t),t}{const r={userId:e,firstSmsLocalId:t,lastSmsLocalId:s,isGroup:e.startsWith(R.GROUPID_PREFIX),respondedByMe:n,numMsg:a||2,label:null,pinned:0,verified:!0,cloudMore:i,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),r}}}async addIfNotExistsConv(e,t,s,i,n,a){const r=this.data.get(e);if(ho.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #1 ${e} ${!!r} ${i}`),r)return!1;const o=await this.DBConvInfo.getById(e);if(ho.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #2 ${!!o}`),o)return!1;{const r={userId:e,firstSmsLocalId:s,lastSmsLocalId:i,isGroup:t||e.startsWith(R.GROUPID_PREFIX),respondedByMe:n,numMsg:a||1,label:null,pinned:0,verified:!0,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),!0}}createEmptyConvForUser(e,t,s=R.CONV_OT_STATE.none,i){return new Promise(((n,a)=>{this.getConvById(e).then((n=>{let a;if(ho.default.logCoreInfo(`[${this.name}] - createEmptyConvForUser ${e} ${!!n}`),n){const i=new Map;return a=n,s!==R.CONV_OT_STATE.none&&void 0!==s&&(a.outside=s,i.set("outside",s)),t&&!Co.a.PinDataManager.isPinned(a.userId)&&Co.a.PinDataManager.pin([a.userId]),this.updateFields(e,i),a}return a=Object(f.a)({userId:e,lastMessageTime:t?0:yn.default.getTimeNow(),isGroup:e.startsWith(R.GROUPID_PREFIX)},i),s!==R.CONV_OT_STATE.none&&void 0!==s&&(a.outside=s),t&&Co.a.PinDataManager.pin([a.userId]),a.verified=!0,this.setCacheData(e,a,!0),this.updateInDB(a),a})).then((e=>{n(e)})).catch((e=>{ho.default.logCoreError(e),a(e)}))}))}updateLastMsgId(e,t){const s=this.data.get(e);if(s&&s.lastSmsLocalId===t)return Promise.resolve(s);const i=new Map;return i.set("lastSmsLocalId",t),this.updateFields(e,i)}updateInfoCheckSearch(e,t,s){const i=this.data.get(e);if(i&&i.infoCheckSearch&&i.infoCheckSearch.lastMessageTime===t)return Promise.resolve(i);const n=new Map;return n.set("infoCheckSearch",{lastMessageTime:t,lastType:s}),this.updateFields(e,n)}updateConvSetting(e,t){let s=this.data.get(e);if(!s){const i=!!this.doneLoadDB;s={userId:e,verified:i},i||ho.default.logCoreInfo(`[${this.name}] - update conv setting before done load db ${e}`,t)}ho.default.shallowEqual(s.setting,t)||(s.setting=t,this.setCacheData(e,s,!0),ho.default.logCoreInfo(`[${this.name}] - update conv setting for conv ${e}`,t))}async isRespondedByMe(e){const t=await this.getConvById(e);return!!t&&Boolean(t.respondedByMe)}isRespondedByMeSync(e){const t=this.data.get(e);return!!t&&Boolean(t.respondedByMe)}isDoneLoadDB(){return this.doneLoadDB}getConvByIdSync(e){return"string"!=typeof e&&ho.default.logCoreInfo(`[${this.name}] - getConvByIdSync with invalid id type`,e,!!this.data.get(e),!!this.data.get(""+e)),this.data.get(e)}getConvById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvInfo.getById(e).then((e=>{t(e)})).catch(s)}))}getAllConvSync(){return Array.from(this.data.values())||[]}getAllConv(){return new Promise(((e,t)=>{if(this.doneLoadDB){return e(this.getAllConvSync())}this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll()),this.fetchAllHolder.then(e).catch(t)}))}getAllConvIds(){return this.getAllConv().then((e=>e.map((({userId:e})=>e))))}getAllConvIdsSync(){return Array.from(this.data.keys())}onDoneSyncMobile(){ho.default.logCoreInfo(`[${this.name}] - onDoneSyncMobile`),this.getAllConv().then((e=>{e&&this.previewManager.migrate(e.map((e=>e.userId)),!0)}))}setCacheData(e,t,s=!1){this.data.set(t.userId,t),s&&Object(hs.h)(this.name,e)}updateFields(e,t){return new Promise(((s,i)=>{const n=this.data.get(e),a=n=>{ho.default.logCoreInfo(`[${this.name}] - updateFields #2`);const a=Object(f.a)({},n);t.forEach(((e,t)=>{a[t]=e})),this.setCacheData(e,a,!0),this.updateInDB(a).then((()=>{s(a)})).catch(i)};n?a(n):this.DBConvInfo.getById(e).then((e=>{e&&a(e)}))}))}forkDeleteCacheAndDB(e){if(ho.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e}`),!Co.a.PinDataManager.isPinned(e)){const t=this.data.get(e);ho.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e} ${!!t}`),this.data.delete(e),Object(hs.f)(this.name,e),this.deleteInDB(e).then((s=>{this.broadcastEvent(so.b.DeleteConv,e,t)}))}}broadcastEvent(e,t="",s){this.dispatchEvent(new so.a(e,t,s))}shouldSignalUpdate(e,t){return Co.a.PinDataManager.isPinned(e.userId)!==Co.a.PinDataManager.isPinned(t.userId)||e.label!==t.label||e.respondedByMe!==t.respondedByMe}cleanConversation(e){return Object.keys(e).forEach((t=>{_d.includes(t)||delete e[t]})),e}getEmptyConv(e){return{userId:e,isGroup:e.startsWith(R.GROUPID_PREFIX),numMsg:0,respondedByMe:!1,pinned:0,label:null,outside:null,infoCheckSearch:null,topOut:null}}updateInDB(e){const t=this.cleanConversation(Object(f.a)({},e));return this.DBConvInfo.addOrUpdate(t).catch((e=>{ho.default.logCoreInfo(`[${this.name}] - updateInDB got error ${e}`)}))}deleteInDB(e){return this.DBConvInfo.remove(e).catch((e=>{ho.default.logCoreInfo(`[${this.name}] - deleteInDB got error ${e}`)}))}})||gd)||gd)||gd);var Cd,Od=s("NSWB"),Ed=s("1Abx"),Md=s("XEtq"),Sd=s("ZRfj"),Td=s("oH3T"),wd=s("13iL"),Rd=s("mea/"),Ld=s("MPLC"),Dd=s("WK05"),Ad=s("bSQ5"),Fd=s("dwTj"),jd=s("RVT8"),Pd=s("hkvp"),kd=s("6tnf"),Nd=s("sg3c"),Ud=s("ofhN"),Bd=s("D8f9"),xd=s("bgEr"),Gd=s("PGx3");const zd="9999999999999999",Vd="zum_m",Hd="1.0.0",Wd="paucfoa_ts_key",$d=!1,Kd="total",qd=e=>({convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"",lastSeenReactId:"",unreadMark:void 0}),Qd={CALL_INIT:!1},Zd=1,Jd=2;Object(ko.b)(jd.b)(Cd=function(e,t){return i.ModuleContainer.inject(Pd.b)(e,void 0,0)}(Cd=function(e,t){return i.ModuleContainer.inject(jo.ConversationUIUpdater)(e,void 0,1)}(Cd=Reflect.metadata("design:type",Function)(Cd=Reflect.metadata("design:paramtypes",[void 0===so.IReactiveDB?Object:so.IReactiveDB,void 0===jo.ConversationUIUpdater?Object:jo.ConversationUIUpdater])(Cd=class extends Fe.b{constructor(e,t){super(),this.DBConvUnread=e,this.conversationUIUpdater=t,this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this.pendingMessage=void 0,this.previewMsgs=void 0,this.pendingClearUnread=void 0,this.fetchAllHolder=void 0,this.total=void 0,this.loadState=Qd,this.isLoadDBStarted=void 0,this.updateTotalQueue=void 0,this._logger=void 0,this.setupQueue=()=>Object(bd.queue)((async e=>{this.doneLoadDB&&await this.calculateComputeUnreadCount(e)}),1),this._getDeletedMsgByTTLItem=(e,t)=>{if(t)return t.find((t=>e.msgId?e.msgId===t.msgId:e.cliMsgId===t.cliMsgId))},this.name=jd.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.isLoadDBStarted=!1,this.pendingMessage=new Map,this.previewMsgs=[],this.pendingClearUnread=new Map,this.fetchAllHolder=null,this.total=this.getEmptyTotal(),this.updateTotalQueue=this.setupQueue(),this.resetToUnreadReddotOAIfNeeded_=this.resetToUnreadReddotOAIfNeeded_.bind(this),this.handleConvUnreadCountConfigChange_=this.handleConvUnreadCountConfigChange_.bind(this)}init(){this.didInit||(this.logger.zsymb(3,"bkS9Nt",["call init unread","DmZH3-"]),this.didInit=!0,this.addListener(),this.onState("CALL_INIT"))}onState(e){this.loadState[e]=!0;const t=Object.values(this.loadState).every((e=>!0===e));t&&!this.isLoadDBStarted&&(this.logger.zsymb(3,"s7S0Bk",["done all state, ready to load db...","7zzaWP"]),this.loadData())}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.conversation,[Ve.ZLoggerNametags.unread])),this._logger}getEmptyTotal(){return{convId:"total",smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:0,smsUnreadNomute:0}}loadData(){const e=E.default.getInstance().getItemForCurrentUser(Vd);if(e===Hd)this.isLoadDBStarted=!0,this.logger.zsymb(3,"bpqFg9",["start load unread {}","HU2tuG"],e),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((e=>{this.onLoadUnreadFromDBV2(Jd,e.map(this.toUnreadItem)),this.doDoneLoadDBTask()}));else{Co.a.ConvInfoDataManager.isDoneLoadDB()&&(this.isLoadDBStarted=!0,this.migrateV2())}}async resetToUnreadReddotOAIfNeeded_(){try{let e=xd.b().enable_for_oa,t=await E.default.getInstance().getItemForCurrentUserAsync(Wd),s=!1,i=!1;if(null==t)this.logger.zsymb(0,"mnr_p4","Force reset to unread reddot OA at first time."),s=!0;else{const[s,n]=t.split("_").map(Number);if(e===s)return;const a=!e&&1==s,r=Boolean(e)&&0==s;i=a||r,this.logger.zsymb(3,"Nxwko3",["shouldResetToUnreadReddotByRule by mainRule: {} - subRule: {}","tozfdU"],a,r)}if(s||i){if(this.data.size>0){this.logger.zsymb(0,"Ofjsm5","perf reset to default unread reddot OA.");const e=e=>{const t=e.smsUnreadCount||0;let s=e.smsUnreadNotCount||0;const i=t-s;return i>0?(this.logger.zsymb(3,"LikCay",["resetToDefaultUnreadReddotItemIfNeeded - OAConvId: {} - count: {} - smsUnreadNotCount: {}","HR1xrS"],e.convId,i,s),s=s||1,{shouldReset:!0,data:Object(f.a)(Object(f.a)({},e),{},{smsUnreadCount:s,smsUnreadNotCount:s,strangerUnreadCount:s})}):{shouldReset:!1,data:e}},t=Array.from(this.data.values()),s=new Map;t.forEach((e=>s.set(e.convId,Object(f.a)({},e))));const i=t.map((e=>e.convId));this.logger.zsymb(3,"pNmGyJ",["before verify oa convs: {}","x0fBQm"],Date.now());const n=(await Bo.ConvList.verifyOATypeAsync(i)).reduce(((t,i)=>{if(i.isOA&&s.has(i.cid)){const n=s.get(i.cid),{shouldReset:a,data:r}=e(n);a&&t.push(r)}return t}),[]);if(this.logger.zsymb(3,"gcDYtG",["Reset to default unread reddot OA - count: {} - ts: {}","bhZDQr"],n.length,Date.now()),n.length){const e=Date.now().toString();Object(hs.k)(e),n.forEach((t=>{this.data.set(t.convId,t),Object(hs.g)(e,this.name,t.convId),this.updateInDB(t)})),Object(hs.c)(e),this.unreadChanged("reset")}}}const n=`${e}_${Date.now()}`;this.logger.zsymb(3,"hoQ_mC",["apply new unread count for OA config - newAppliedConfigAndTS: {}","eMIvd-"],n),E.default.getInstance().setItemForCurrentUserAsync(Wd,n)}catch(e){this.logger.zsymb(21,"x_ycWN",["reset to unread reddot OA if needed error: {}","Vbwjrv"],null==e?void 0:e.message)}}handleConvUnreadCountConfigChange_(e){const{prevConfig:t,nextConfig:s}=e;t.enable_for_oa!==s.enable_for_oa&&this.doneLoadDB&&this.resetToUnreadReddotOAIfNeeded_()}shouldForceShowReddotForOAMessages_(e,t=!1){const s=xd.b().enable_for_oa;return Boolean(!s&&(t||e&&Bo.ConvList.isOAType({userId:e})))}async migrateV2(){const e=E.default.getInstance(),t=e.getItemForCurrentUser(Vd)===Hd;if(this.logger.zsymb(3,"lpTDVv",["call migrate unread {}","g6DU4-"],t),t)return;const s=Co.a.ConvInfoDataManager.getAllConvSync(),i=[];s.forEach((e=>{const t=e.smsUnreadCount||0,s=e.smsUnreadNotCount||0,n=e.mentionUnreadCount||0,a=e.unreadMark||null;if(!(e&&e.userId&&(t||s||n||a)))return;const r={convId:e.userId,smsUnreadCount:t,smsUnreadNotCount:s,strangerUnreadCount:0,mentionUnreadCount:n,lastProcessMsgId:e.lastMessageIdFromServerv2||"0",lastSeenReactId:e.lastSeenReactId||"0",unreadMark:a};i.push(r)})),this.onLoadUnreadFromDBV2(Zd,i),this.doDoneLoadDBTask(),this.logger.zsymb(3,"HB_fue",["done migrate unread {}","5CleDB"],i.length),e.setItemForCurrentUser(Vd,Hd)}async doDoneLoadDBTask(){await this.resetToUnreadReddotOAIfNeeded_();const e=Array.from(this.data.values());this.doneLoadDB=!0,this.broadcastEvent(so.b.DoneLoadDB,"total",e),this.logger.zsymb(3,"SEWiAh",["done load unread {}","zai-gh"],e.length),Object(Gd.e)(e),setTimeout((()=>{this.unreadChanged("init")}),200)}addListener(){Co.a.MuteDataManager.addEventListener(so.b.MuteChanged,(e=>{this.onMuteConversation(e.convId,!!e.payload)})),Co.a.ConvInfoDataManager.addEventListener(so.b.LeaveGroup,(e=>{this.doDeleteUnread(e.convId)})),Co.a.ConvInfoDataManager.addEventListener(so.b.DeleteConv,(e=>{this.doDeleteUnread(e.convId)})),Co.a.ConvInfoDataManager.addEventListener(so.b.EmptyConv,(e=>{this.doDeleteUnread(e.convId)})),Co.a.ConvInfoDataManager.addEventListener(so.b.DoneLoadDB,(e=>{this.onState("CALL_INIT")})),Co.a.ArchivedChatManager.addEventListener(so.b.UpdateListArchivedChat,(e=>{this.onArchivedChat(e.convId)})),Fi.default.subscribe(((e,t)=>{if(null!=t&&t.length&&e===Ai.ConversationListActions.CLEAR_MARK_AS_UNREAD)t.forEach((e=>{this.updateUnreadMark(e,null)}));else if(null!=t&&t.length&&e===Ai.GeneralActions.UPDATE_HIDDEN_CHAT)for(let s=0;s<t.length;s++){const e=t[s];this.onHiddenConversation(e.uid,e.isHide)}})),xd.a(this.handleConvUnreadCountConfigChange_)}getItem(e,t){if(e.key===Kd)return this.total;return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){throw new Error("Method not implemented.")}onMuteConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||xo.a.isThreadHidden(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"VzSef6","onMuteConversation:",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onHiddenConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||Rt.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"CSmlMt","onHiddenConversation: ",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onArchivedChat(e){const t=this.data.get(e);!t||t.smsUnreadCount<1&&!t.unreadMark||Rt.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||this.unreadChanged(e)}onChangeConvLabel(e,t,s){const i=this.data.get(e);t===s||!i||i.smsUnreadCount<1||Rt.default.isMuted(e)||this.unreadChanged(e)}onReceivePreviewMessages(e){e.length>0&&(this.previewMsgs=[...this.previewMsgs,...e])}onReceiveNewMessagesOld(e,t,s){if(!s||!t)return;const i=this.data.get(e);if(i)this.logger.zsymb(0,"O6q5sF","receive msg",e,i.lastProcessMsgId,s),(!i.lastProcessMsgId||i.lastProcessMsgId<t)&&this.handleNewMessages(e,s,t).then((()=>{this.signalRenderItem(this.name,e)}));else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i),i.length===s.length&&this.DBConvUnread.getById(e).then((t=>{if(!t){const t=this.pendingMessage.get(e);if(t){const s=t.filter(((e,t,s)=>s.indexOf(e)===t)),i=Jo.default.getLastMessageInList(s);if(!i)return;this.pendingMessage.delete(e),this.handleNewMessages(e,s,i.msgId).then((()=>{this.signalRenderItem(this.name,e)}))}}}))}}async onReceiveNewMessages(e,t,s){if(!s||!s.length||!t)return;const n=this.data.get(e);if(this.doneLoadDB){if(!n||!n.lastProcessMsgId||n.lastProcessMsgId<t){const i=s.map((e=>e.msgId)).join("-");this.logger.zsymb(0,"1aRgmm",`onReceiveNewMessages: ${null==n?void 0:n.lastProcessMsgId} ${e} ${t} ${i}`),await this.handleNewMessages(e,s,t),this.signalRenderItem(this.name,e)}}else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i)}i.ModuleContainer.resolve(Xo.TUnreadSubChatTabStateManager).handleReceiveLatestMessage({convId:e,msgId:t})}onDoneOffLineMessages(){this.logger.zsymb(0,"l41pe5","ph7 done offline"),wl.b.onDoneEntry(wl.a.FIRST_FETCH),this.previewMsgs.length>0&&setTimeout((()=>{this.handlePreviewMsgs()}),0)}doDeleteUnread(e){if(!e)return;Object(Gd.a)([e]);const t=this.data.get(e);this.logger.zsymb(0,"efsUw3",`doDeleteUnread ${!!t}`),this.data.delete(e)&&(Object(hs.f)(this.name,e),this.unreadChanged(e)),this.deleteInDB(e)}onReceiveDeleteConvMsg(e,t){if(this.doneLoadDB){const s=this.safeGetUnreadCached(e);if(0===s.smsUnreadCount)return;if(t>=+s.lastProcessMsgId){const t=Object(f.a)(Object(f.a)({},s),{},{smsUnreadCount:0,smsUnreadNotCount:0});this.data.set(t.convId,t),this.signalRenderItem(this.name,e),this.unreadChanged(e)}}else this.pendingClearUnread.set(e,t)}onClearUnreadConversations(e){if(!e||e.length<0)return;let t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this.data.get(i.userId)||qd(i.userId);this.logger.zsymb(0,"9W-PeT","onClearUnreadConversations",!!i,null==n?void 0:n.smsUnreadCount),i&&(t.push(i.userId),n.smsUnreadCount>0&&Rt.default.getLastMessageFrom(i.userId,i.lastSmsLocalId,zd,n.smsUnreadCount,!0).then((e=>{let t={};if(e&&e.length>0)for(let i=0;i<e.length;i++){let s=e[i];ho.default.validMessageFromOther(s)&&(t[s.msgId]=s)}const s={userId:i.userId,lastSmsLocalId:i.lastSmsLocalId,smsUnreadCount:n.smsUnreadCount};this.clearUnreadConversation(s,t),this.resetUnreadToZero(i.userId,n.lastProcessMsgId)})).catch((e=>{this.logger.zsymb(21,"7gauuB",["clear unread conv failure {}","GChxc2"],e)})),Dd.a.clearUnreadIfExist({userId:i.userId,lastSeenReactId:n.lastSeenReactId}))}Object(Gd.a)(t,e.length>0)}onReadConversation(e,t){var s;if(mi.default.mark_unread.enable&&!Object(Gd.c)(e))return this.logger.zsymb(0,"NL2d2l",`[read-message] dont clear ${e}`,mi.default.mark_unread.enable,Object(Gd.c)(e)),!1;Object(Gd.b)(e)&&(e.startsWith(R.GROUPID_PREFIX)?as.default.logAction(2160024):as.default.logAction(2160023),as.default.logAction(2160022));const i=this.data.get(e)||qd(e),n=i.smsUnreadCount;if(!t&&!n){this.logger.zsymb(0,"aQWrgf",`[read-message] dont clear ${e} unread `,n,t);const s=Dd.a.sendClearUnread(e,i.lastSeenReactId);return Object(Gd.a)([e],!1),s!=i.lastSeenReactId&&(i.lastSeenReactId=s,this.data.set(e,Object(f.a)({},i)),this.signalRenderItem(this.name,e),this.updateInDB(i)),!1}const a=this.acquireConvManager().getConvByIdSync(e);if(!a)return this.logger.zsymb(0,"rxQBt9",`[read-message] convinfo not exists ${e}`),!1;const r=[],o={},l=a.lastSmsLocalId?a.lastSmsLocalId.toString().split("_")[0]:"";let c=!1;const d=null===(s=Ld.b.messageCache)||void 0===s?void 0:s.getLast({userId:e},n);for(let g=d.length-1;g>-1;g--){let e=d[g];if(ho.default.validMessageFromOther(e)&&!r.includes(e.msgId)&&(r.push(e.msgId),o[e.msgId]=e,e.msgId==l&&(c=!0),r.length==n))break}const u={userId:e,lastSmsLocalId:a.lastSmsLocalId,smsUnreadCount:n};var h;!l||c||o[l]?this.clearUnreadConversation(u,o):(this.logger.zsymb(0,"Lc0D1F",`[read-message] append lastMsgIdInConv ${l} ${Object.keys(o).length}`),null===(h=Ld.b.messageCache)||void 0===h||h.getMessageByMsgIdAsync(l,e).then((e=>{o[l]=Object(f.a)({},e),this.clearUnreadConversation(u,o)})).catch((e=>{this.clearUnreadConversation(u,o)})));return Object(Gd.a)([e],!1),i.lastSeenReactId=Dd.a.sendClearUnread(e,i.lastSeenReactId),this.resetUnreadToZero(e,i.lastProcessMsgId),!0}getUnreadByConvIdSync(e){return this.data.get(e)}getUnreadByConvId(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.getUnreadByConvIdSync(e));this.DBConvUnread.getById(e).then((e=>t(void 0===e?void 0:this.toUnreadItem(e)))).catch(s)}))}getAllUnreadsSync(){return Array.from(this.data.values())}getAllUnreads(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllUnreadsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((t=>e(t.map(this.toUnreadItem)))).catch(t)}))}resetUnreadToZero(e,t){return this.getUnreadByConvId(e).then((s=>{if(Td.b.onClearUnreadConv(e),!s||!s.smsUnreadCount&&!s.smsUnreadNotCount)return this.logger.zsymb(3,"GiPQvn",["resetUnreadToZero {} {} skipped","4gYpjX"],e,t),!1;if(this.logger.zsymb(3,"yoOrtp",["resetUnreadToZero {} {} {}","gfs3bl"],e,t,s.smsUnreadCount),!Bo.Validator.assertString(t,this.logger))return!1;const i={convId:e,smsUnreadCount:0,mentionUnreadCount:0,strangerUnreadCount:0,smsUnreadNotCount:0,lastProcessMsgId:t,lastSeenReactId:s.lastSeenReactId||"",unreadMark:s.unreadMark};return s.smsUnreadCount>0&&Sd.a.notiMainClearunread(e),this.forkUpdateCacheAndDB(i).then((t=>(this.broadcastEvent(so.b.ReadConv,e),!0))).catch((t=>(this.logger.zsymb(21,"izluAd",["resetUnreadToZero failure {} {}","xGaijR"],e,t),!1)))}))}isUnreadMessage(e){const{message:t,convId:s,lastProcessMsgId:i}=e,n=Jo.default.isMyMessage(t),a=Ed.b.isRead({userId:s,msgId:t.msgId,msgSendDttm:t.ts||t.serverTime||t.sendDttm,msgLocalId:void 0,e2eeStatus:Object(Nd.f)(t)}),r=!t.msgId||!i||t.msgId<=i;return!a&&r&&!n}_updateTTLUnreadCount(e,t,s){const i=this.data.get(e)||null;if(this.logger.zsymb(0,"QN9U9d","_updateTTLUnreadCount",e,null==i?void 0:i.smsUnreadCount),i&&i.smsUnreadCount===t&&i.smsUnreadNotCount===s)return;let n=this.safeGetUnreadCached(e);n.smsUnreadCount=t,n.smsUnreadNotCount=s,this.forkUpdateCacheAndDB(n)}updateUnreadTTLConversation(e,t,s){const i=this.getUnreadByConvIdSync(e);if(i){let n=i.smsUnreadCount,a=i.smsUnreadNotCount;t.filter((t=>t.ttlType===Bd.a.Message&&this.isUnreadMessage({message:this._getDeletedMsgByTTLItem(t,s),convId:e,lastProcessMsgId:i.lastProcessMsgId}))).forEach((e=>{const t=this._getDeletedMsgByTTLItem(e,s),i=ho.default.getDataReminder(t),r=Jo.default.isMyMessage(t);i&&r&&(t.idTo===mi.default.sendToMeId||r)?(a-=1,n-=1):n-=1})),this._updateTTLUnreadCount(e,Math.max(n,0),Math.max(a,0))}}updateUnreadCount(e,t){const s=this.data.get(e)||null;if(this.logger.zsymb(0,"zZb-mG","updateUnreadCount",e,null==s?void 0:s.smsUnreadCount),s&&s.smsUnreadCount===t)return;let i=this.safeGetUnreadCached(e);i.smsUnreadCount=t,this.forkUpdateCacheAndDB(i)}updateMentionCount(e,t){this.logger.zsymb(0,"k6Tm0R","updateMentionCount",e,t);let s=this.safeGetUnreadCached(e);s.mentionUnreadCount=t,this.forkUpdateCacheAndDB(s,!1),kd.a.updateUnreadMentions(this.getTotalMentionCount())}updateLastSeenReactId(e,t){let s=this.safeGetUnreadCached(e);s.lastSeenReactId=t,this.forkUpdateCacheAndDB(s,!1)}updateUnreadMark(e,t){let s=this.safeGetUnreadCached(e);s.unreadMark||(s.unreadMark=null),t||(t=null),t!==s.unreadMark&&(s.unreadMark=t,this.forkUpdateCacheAndDB(s))}shouldClearUnread(e,t){const s=this.data.get(e),i=null==s?void 0:s.smsUnreadCount,n=null==s?void 0:s.lastProcessMsgId;return!!i&&!!(n&&t&&+t>=+n)}onRollMessage(){}async forkUpdateCacheAndDB(e,t=!0){this.data.set(e.convId,e),this.signalRenderItem(this.name,e.convId),t&&this.isValidConvKey(e.convId)&&this.unreadChanged(e.convId),await this.updateInDB(e)}safeGetUnreadCached(e){const t=this.data.get(e);let s;return s=t?Object(f.a)({},t):{convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:null},s}getTotalMentionCount(){let e=0;return this.data.forEach((t=>{e+=t.mentionUnreadCount})),e}isValidConvKey(e){return!(!e||e.length<3)&&("null"!=e&&(e!==R.CONV_FILTER.STRANGER&&e!==Kd))}unreadChanged(e){"null"!=e&&(this.updateTotalQueue.remove((e=>!0)),this.updateTotalQueue.push(e))}async calculateComputeUnreadCount(e){try{var t;const n=this.getEmptyTotal(),a=(null===(t=this.data.get(R.CONV_FILTER.STRANGER))||void 0===t?void 0:t.smsUnreadCount)||0;let r=0;const o=i.ModuleContainer.resolve(Xo.TUnreadSubChatTabStateManager),l=o.getAllSeenMilestones(),c={[Xo.SubChatTabType.FOCUSED]:!1,[Xo.SubChatTabType.ARCHIVED]:!1},d=new Map,u=new Map,h=new Map;Co.a.LabelDataManager.getAllLabelIds().map((e=>{const t=""+e;h.set(t,t)}));const g=new Map,m=[];for(let e of Array.from(this.data.keys())){if(!this.isValidConvKey(e))continue;const t=this.data.get(e);if(!t)continue;if(!(Boolean(t.smsUnreadCount)||Boolean(t.smsUnreadNotCount)||Boolean(t.unreadMark)))continue;const s=o.getSubtabTypeOfConv(e),i=Rt.default.isMuted(e),n=t.lastProcessMsgId;!i&&o.isValidSubChatTabType(s)&&n>l[s]&&(c[s]=!0);if(xo.a.isThreadHidden(e))continue;Yo.a.isArchivedChat(e)||(g.set(e,t),m.push(e))}$d;const p=await Bo.ConvList.verifyOATypeAsync(m),f=async({cid:e,isOA:t,oaInfo:s})=>{const a=g.get(e),o=a.convId,l=this.acquireConvManager().getConvByIdSync(o),c=Rt.default.isMuted(o);if(t&&!(await Bo.ConvList.checkIfOAShouldShowInConvList(o))){const e=i.ModuleContainer.resolve(io.b);if(!e||!e.isChatVisible(o))return void this.logger.zsymb(0,"Muzxop","calc total unread count, skip OA no topOut conv: ",o,t,null==l?void 0:l.topOut)}const h=a.smsUnreadCount||0,m=a.smsUnreadNotCount||0;if(n.smsUnreadCount+=h,l&&!c&&!this.shouldForceShowReddotForOAMessages_(o,t)&&l.userId!==R.FAKE_CONVERSATION_ID.FRIEND_CENTER){const e=Math.max(h-m,0);n.smsUnreadNomute+=e;const t=l.label?""+l.label:"",s="0"==t||!!t;if(s&&(d.has(t)?d.set(t,d.get(t)+e):d.set(t,e)),a.unreadMark){const e=n.unreadMark||0;n.unreadMark=e+1,s&&(u.has(t)?u.set(t,u.get(t)+1):u.set(t,1))}e>0&&this.isInStrangerBox(o)&&(r+=e)}};for(const{cid:e,isOA:t,oaInfo:s}of p)await f({cid:e,isOA:t,oaInfo:s});if(this.total.smsUnreadCount!==n.smsUnreadCount||this.total.smsUnreadNomute!==n.smsUnreadNomute||this.total.unreadMark!==n.unreadMark){var s;const t=null===(s=this.data.get(e))||void 0===s?void 0:s.smsUnreadCount,i=Rt.default.isMuted(e);this.total=n,this.dispatchEvent(new so.a(so.b.ChangeUnreadCount,Kd,{unreadNoMute:n.smsUnreadNomute,totalUnread:n.smsUnreadCount,convId:e,currentUnread:t,curentUnreadNoMute:i?0:t})),this.data.set(Kd,n),this.signalRenderItem(this.name,Kd)}if(o.handleShowReddotsAtSubChatTab(c),a!==r){const e=this.safeGetUnreadCached("");e.smsUnreadCount=r,e.convId=R.CONV_FILTER.STRANGER,this.data.set(R.CONV_FILTER.STRANGER,e),this.signalRenderItem(this.name,R.CONV_FILTER.STRANGER)}for(let e of Array.from(d.keys())){const t=this.safeGetUnreadCached("");t.smsUnreadCount=d.get(e),t.unreadMark=u.get(e),this.data.set(e,t),h.delete(e),this.signalRenderItem(this.name,e)}for(let e of Array.from(h.keys()))this.data.delete(e)&&this.signalRenderItem(this.name,e)}catch(n){this.logger.zsymb(21,"yHdFAh",[" unread err - contact phucnh7 please!!! {}","secskH"],n)}}acquireConvManager(){return Co.a.ConvInfoDataManager}onLoadUnreadFromDBV2(e,t){if(this.logger.zsymb(0,"jqvYpu","onLoadUnreadFromDB",t.length),t.length<1)return;const s=(new Date).getTime().toString();Object(hs.k)(s);const n=i.ModuleContainer.resolve(jo.PreviewDataManager),a={};n.getAllPreviewsSync().forEach((e=>{a[e.convId]=!0}));for(let i=0;i<t.length;i++){const n=t[i];if(a[n.convId]){if("object"==typeof n.lastProcessMsgId||"string"==typeof n.lastProcessMsgId&&n.lastProcessMsgId.includes("object")?(n.lastProcessMsgId="0",this.logger.zsymb(18,"77n8io","Corrected lastProcessMsgId!"),fi.default.increaseFailed(151101,0,0,0,Date.now())):Ed.b.isRead({userId:n.convId,msgId:+n.lastProcessMsgId,e2eeStatus:void 0,msgSendDttm:void 0,msgLocalId:void 0})&&(n.smsUnreadCount||n.smsUnreadNotCount)&&(this.logger.zsymb(0,"D2evWp","clear offline",n.convId,n.smsUnreadCount),n.smsUnreadCount=0,n.strangerUnreadCount=0,n.smsUnreadNotCount=0),this.pendingClearUnread.has(n.convId)){const e=this.pendingClearUnread.get(n.convId);e&&e>=+n.lastProcessMsgId&&(this.logger.zsymb(0,"R9jzk8","clear pending",this.pendingClearUnread.size,n.convId),n.smsUnreadCount=0,n.strangerUnreadCount=0,n.smsUnreadNotCount=0)}"null"===n.lastProcessMsgId&&(n.lastProcessMsgId=""),this.data.set(n.convId,n),Object(hs.g)(s,this.name,n.convId),e===Zd&&this.updateInDB(n),n.unreadMark&&this.total.unreadMark++}}this.pendingClearUnread.clear(),this.processPendingMessages(),Object(hs.c)(s)}processPendingMessages(){this.logger.zsymb(0,"dvfIUy","start processPendingMessages",this.pendingMessage.size),this.pendingMessage.forEach(((e,t)=>{const s=new Map,i=this.data.get(t);e.forEach((e=>{var t;(!i||i.lastProcessMsgId<e.msgId)&&s.set(`${(t=e).uidFrom||t.fromUid}_${t.idTo||t.toUid}_${t.cliMsgId}`,e)})),this.logger.zsymb(0,"R9Sqfg","check processPendingMessages #2",t,null==i?void 0:i.smsUnreadCount,e.map((e=>e.msgId)),s.keys());const n=Array.from(s.values()),a=Jo.default.getLastMessageInList(n);this.handleNewMessages(t,n,null==a?void 0:a.msgId)})),this.pendingMessage.clear()}async handleNewMessages(e,t,s){var i,n;if(!t||!t.length)return;if(!Bo.Validator.assertString(s,this.logger))return;let a=!1;const r={convId:e,strangerUnreadCount:0,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,lastProcessMsgId:s,lastSeenReactId:"0"},o=Date.now(),l=new Set,{isOA:c}=null!==(i=null===(n=await Bo.ConvList.verifyOATypeAsync([e]))||void 0===n?void 0:n[0])&&void 0!==i?i:{isOA:!1};if(t.forEach((t=>{const i=Jo.default.isMyMessage(t);if(t.status!==R.MSG_READ&&!i){const s=t.ts||t.serverTime||t.sendDttm;Ed.b.isRead({userId:e,msgId:t.msgId,msgSendDttm:s,msgLocalId:void 0,e2eeStatus:Object(Nd.f)(t)})&&(mi.default.stagingAccount&&this.logger.zsymb(0,"5IKhuh",`mark msg status as read ${e} ${t.msgId}`),t.status=R.MSG_READ)}let n=Md.a.get(t.msgId,t.status);n!=t.status&&mi.default.stagingAccount&&this.logger.zsymb(0,"PL6YYx",`change msg status ${t.status} => ${n}`),t.status=n;let d=!1;if("chat.todo"===t.msgType){let e=t.content;if(e){"todo.remind"===e.action&&(d=!0)}}let u=ho.default.getDataReminder(t);if(t.status!==R.MSG_READ&&!i||!0===d){if(t.paramsExt&&ho.default.valueValid(t.paramsExt.countUnread)){const s=this.shouldForceShowReddotForOAMessages_(e,c);(0==t.paramsExt.countUnread||1==t.paramsExt.countUnread&&s)&&(r.smsUnreadNotCount+=1)}this.isCallTimeMessage(t)||(r.smsUnreadCount+=1,r.strangerUnreadCount+=1),Od.b.isMessageMentionMe(t)&&r.mentionUnreadCount++}else u&&i&&(t.idTo===mi.default.sendToMeId||i)?(r.smsUnreadCount+=1,r.smsUnreadNotCount+=1,this.logger.zsymb(0,"-cAEuY",`new unread #2: ${o} ${e} ${t.msgId} ${t.idTo} ${t.toUid} ${t.src} ${s}`)):Ad.a(t)?t.isCallMessage||(r.smsUnreadCount=0,r.strangerUnreadCount=0,r.mentionUnreadCount=0,a=!0):(l.add(t.msgId),this.logger.zsymb(0,"zejL4W","_addMessages: skipped clear unread for",t.idTo));r.smsUnreadCount>0&&wl.b.markGotUnread(e,t.msgId),wl.b.isLastMsgV2(t)&&this.onDoneOffLineMessages()})),l.has(s))for(let u=t.length-1;u>=0;u--){const s=t[u];if(ho.default.validMessageFromServer(s)&&!l.has(s.msgId)){if(this.logger.zsymb(0,"LT-i50","update last process id",e,r.lastProcessMsgId,s.msgId),r.lastProcessMsgId=s.msgId,!Bo.Validator.assertString(s.msgId,this.logger))return;break}var d;0==u&&(r.lastProcessMsgId=(null===(d=this.data.get(e))||void 0===d?void 0:d.lastProcessMsgId)||"0")}return Object(Gd.a)([e]),this.updateUnread(e,a,r)}handlePreviewMsgs(){if(!this.previewMsgs.length)return;const e=[...this.previewMsgs];this.previewMsgs=[],this.logger.zsymb(0,"nGXnOZ","handle preview",e.map((e=>e.msgId))),e.forEach((e=>{const t=e.toUid,s=Fd.default.checkDuplicate(t,{uidFrom:e.fromUid,cliMsgId:e.cliMsgId});s&&s.src&&s.msgId!==e.msgId&&(this.logger.zsymb(0,"Y2OJgm","detect dup msg",e.msgId,s.msgId),e.msgId=s.msgId),this.onReceiveNewMessages(t,e.msgId,[e])}))}updateUnread(e,t,s){let i=this.data.get(e);if(i){const e=i.lastSeenReactId||"0";t?i=s:(i.smsUnreadNotCount+=s.smsUnreadNotCount,i.smsUnreadCount+=s.smsUnreadCount,i.strangerUnreadCount+=s.strangerUnreadCount,i.mentionUnreadCount+=s.mentionUnreadCount,i.lastProcessMsgId=s.lastProcessMsgId),i.lastSeenReactId=e}else{if(i=s,!i)return void this.logger.zsymb(18,"pt7s8j",`updateUnread undefined item ${e}`);i.lastSeenReactId=Ud.b.getLastSeen(e)||"0"}this.data.set(e,Object.assign({},i)),this.updateInDB(i),0!=s.mentionUnreadCount&&kd.a.updateUnreadMentions(this.getTotalMentionCount()),this.unreadChanged(e)}isInStrangerBox(e){const t=Co.a.ConvInfoDataManager.getConvByIdSync(e);return Sd.a.isInStrangerBox(t)}isCallTimeMessage(e){if("chat.recommended"===e.msgType&&e.content){if(e.content.action===R.CallMessageAction.CallTime)return!0;if(e.content.action===R.CallMessageAction.MissCall){let s=e.content.params;if("string"==typeof s)try{s=JSON.parse(e.content.params)}catch(t){}if(s&&3===s.reason)return!0}}return!1}clearUnreadConversation(e,t={}){if(e&&e.smsUnreadCount)try{let s=!0,i=Object.keys(t);i&&0!=i.length||(s=!1,this.logger.zsymb(0,"WnDhXK",`[read-message] actually, no need send seen in that case 2: ${i.length}`)),!s&&mi.default.chat_aggressive_send_seen&&(s=!0),s?(i&&0!==i.length?this.sendClearUnreadToServer(t,e.userId):Rt.default.getLastMessageFrom(e.userId,e.lastSmsLocalId,zd,e.smsUnreadCount,!0).then((t=>{let s=[],i={};if(t&&t.length)for(let e=0;e<t.length;e++){let n=t[e];ho.default.validMessageFromOther(n)&&(s.push(n.msgId),i[n.msgId]=n)}0===s.length?this.logger.zsymb(3,"LJD8CT",["- [read-message] get ids.length == 0 {}","-39nf0"],e.userId):this.sendClearUnreadToServer(i,e.userId)})).catch((e=>{this.logger.zsymb(21,"kceT3P",[" [read-message] get msgs err {}","aLfvj8"],e)})),Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,Eo.d.clearUnreadMessages,{convId:e.userId})):this.logger.zsymb(3,"rDKE1T",["[read-message] no send {}","U_6V9n"],e.userId)}catch(s){this.logger.zsymb(21,"vrJyju",["[read-message] err {}","8gzVqd"],s)}else this.logger.zsymb(0,"b5Ay7B",`[read-message] actually, no need send seen in that case 1: ${null==e?void 0:e.userId}`)}async sendClearUnreadToServer(e={},t){const s=Object.keys(e),i=Sd.a.isGroup(t),n=Rd.a.newReq();try{await uo.default.sendSeen(e,t,i,n),mi.default.stagingAccount&&this.logger.zsymb(0,"Ee0jZW",`[read-message] done ${t} msgId:\n\t\t\t\t\t${s&&s.length?s[s.length-1]:0}`)}catch(a){if(this.logger.zsymb(21,"gSyJre",["[read-message] err {}","8gzVqd"],a),!(s&&s.length>0))throw this.logger.zsymb(21,"80uAAI",["[read-message] send seen fail!!! convId:{} msgId len = 0","VymTAx"],t),a;if(this.logger.zsymb(21,"g5MRss",["[read-message] send seen fail!! convId:{} msgId:{}","c9eGIg"],t,s[s.length-1]),a&&(114===a.error_code||-69===a.error_code))throw this.logger.zsymb(21,"HSkNqO",["[read-message] send seen fail!!! no need retry {}","r54GM2"],a.error_code),a;throw mi.default.retrySendSeen?(this.logger.zsymb(21,"bA4Gac",["[read-message] send seen fail!!! retry","3fGjpQ"]),wd.b.retryAction(wd.a.SEND_SEEN_V2,[e,t,i,n],{startedTime:Date.now(),duration:mi.default.retrySendSeen.timeout})):this.logger.zsymb(21,"t1lue2",["[read-message] send seen fail!!! not retry","wDLCVV"]),a}}broadcastEvent(e,t,s){this.dispatchEvent(new so.a(e,t,s))}signalRenderItem(e,t,s){this.conversationUIUpdater.signalRenderItem(e,t,s)}updateInDB(e){if(null==e.lastSeenReactId&&(e.lastSeenReactId=Ud.b.getLastSeen(e.convId)||"0",this.logger.zsymb(18,"rNHGEX",`update invalid lastSeen ${e.convId}`)),!Bo.Validator.assertString(e.lastProcessMsgId,this.logger))return;const t=this.toUnreadConvItemEntity(e);this.DBConvUnread.addOrUpdate(t)}deleteInDB(e){this.DBConvUnread.remove(e)}toUnreadItem(e){return Object(f.a)(Object(f.a)({},e),{},{unreadMark:e.unreadMark})}toUnreadConvItemEntity(e){return Object(f.a)({},e)}})||Cd)||Cd)||Cd)||Cd);var Yd=s("8Nax"),Xd=s("GSHL"),eu=s("w5bt");let tu;var su;(su=tu||(tu={})).modelToEntity=function(e){if(!e)throw new Error("[PreviewHelper] Convert undefined model to entity");return{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties?{type:e.properties.type}:null,mentions:e.mentions?e.mentions:null,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon}},su.entityToModel=function(e){return e?{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties,mentions:e.mentions,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon,src:"db.preview",verified:!1}:null};var iu,nu=s("yWVE");const au="zpm_m",ru="1.0.0";Object(ko.b)(eu.b)(iu=function(e,t){return i.ModuleContainer.inject(Xd.b)(e,void 0,0)}(iu=function(e,t){return i.ModuleContainer.inject(rd.a)(e,void 0,1)}(iu=Reflect.metadata("design:type",Function)(iu=Reflect.metadata("design:paramtypes",[void 0===so.IReactiveDB?Object:so.IReactiveDB,void 0===rd.a?Object:rd.a])(iu=class extends Fe.b{constructor(e,t){super(),this.DBConvPreview=e,this.conversationUIUpdater=t,this.name=void 0,this.key=void 0,this.didInit=void 0,this.data=void 0,this.expiredConvs=void 0,this.list=void 0,this.deleteQueue=void 0,this.doneLoadDB=void 0,this.migrating=void 0,this.fetchAllHolder=void 0,this._Logger=void 0,this.name=eu.a,this.key="convId",this.didInit=!1,this.data=new Map,this.expiredConvs=new Map,this.list=new Map,this.deleteQueue=[],this.doneLoadDB=!1,this.migrating=!1,this.fetchAllHolder=null}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}signalRenderItem(e,t,s=!1){this.Logger.zsymb(12,"NqzcO6","signalRenderItem allowAutoBatching",s);const i=s?this.conversationUIUpdater.signalRenderItem:hs.h,n=s?this.conversationUIUpdater.signalRenderList:hs.j;i(e,t),this.broadcastEvent(so.b.PreviewChanged,t,{changedItem:this.data.get(t),all:Array.from(this.data.values())}),n(e,"all")}loadData(){return new Promise(((e,t)=>{E.default.getInstance().getItemForCurrentUser(au)!==ru||this.migrating?e():(this.Logger.zsymb(3,"R6cjgD",["start load preview","26hT-O"]),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{this.onLoadPreviewsFromDB(t).then(e).catch((t=>{this.Logger.zsymb(21,"x0gidb",["load previews from db failure #1! {}","Narl46"],t),e()}))})).catch((t=>{this.Logger.zsymb(21,"kwhKm0",["load preview from db failure #2! {}","SdrdXP"],t),e()})))}))}async revalidate(e){const t=!!this.getPreviewByIDSync(e),s=await vd.b.getPreviewMessage(e).catch((s=>(this.Logger.zsymb(21,"18JZFy",["revalidate failure #1 {} {} {}","nXgApz"],e,t,s),{previewMsg:void 0})));return!!s.previewMsg&&this.onReceiveNewMessage("db.message",s.previewMsg).then((s=>(this.Logger.zsymb(3,"3g6IJe",["revalidate success {} {} {}","ppr04t"],e,t,s),!0))).catch((s=>(this.Logger.zsymb(21,"QWJWu0",["revalidate failure #2 {} {} {}","CoW8tY"],e,t,s),!1)))}migrate(e,t=!1){return new Promise((s=>{const i=E.default.getInstance().getItemForCurrentUser(au);if(i===ru&&!t)return;if(this.Logger.zsymb(3,"xvtyjV",["start migrate {} {}","YPTsI5"],i,t),this.migrating=!0,0===e.length)return this.doneMigratePreivew(0),s(0);let n=0,a=0;const r=()=>{if(n++,n===e.length)return this.doneMigratePreivew(a),s(a)},o=()=>{a++,r()},l=()=>{for(let t=0;t<e.length;t++)vd.b.getPreviewMessage(e[t]).then((s=>{s&&s.previewMsg?this.onReceiveNewMessage("db.message",s.previewMsg).then(o).catch(r):(this.Logger.zsymb(3,"KMMxyZ",["migrate not exists msg {}","AesfEj"],e[t]),r())})).catch((s=>{r(),this.Logger.zsymb(21,"HmOIYe",["migrate failure for conv {} {}","3Cq1ir"],e[t],s)}))};let c=e.filter((e=>e!==R.FAKE_CONVERSATION_ID.FRIEND_CENTER&&e!==R.FAKE_CONVERSATION_ID.GROUP_CENTER&&!e.startsWith(R.GROUPID_PREFIX)));if(c.length>0)return ns.default.getProfileFriendByIds(c,R.SRC_GET_PROFILE.FETCH_MINI_INFO).then((()=>{l()})).catch((()=>{l()}));l()}))}doneMigratePreivew(e){this.Logger.zsymb(3,"Wxtq8Z",["done migrate preview {}","IdVuIG"],e);E.default.getInstance().setItemForCurrentUser(au,ru),this.broadcastEvent(so.b.DoneMigratePreview,"")}upgradeItemsVersion(e=[]){this.Logger.zsymb(3,"RmJnBU",["upgradeItemsVersion","kgDUSU"]);const t=(new Date).getTime().toString();Object(hs.k)(t),0!==e.length?e.forEach((e=>{Object(hs.g)(t,this.name,e)})):this.data.forEach((e=>{Object(hs.g)(t,this.name,e.convId)})),Object(hs.c)(t)}updateStrangerBox(e){const t=this.data.get(e);t&&(this.data.set(R.CONV_FILTER.STRANGER,Object(f.a)({},t)),this.conversationUIUpdater.signalRenderItem(this.name,R.CONV_FILTER.STRANGER))}forceChangeItem(e){this.signalRenderItem(this.name,e)}getItem(e,t){const s=this.data.get(e.key);return s||this.Logger.zsymb(5,"UEv3ey",["try to get item not exist in cache {}","RIEeTm"],e.key),s}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){this.Logger.zsymb(11,"22B7_F",["onGetItemFailure {}","1qMdFt"],e)}onGetListFailure(e,t){this.Logger.zsymb(11,"Q92x8N",["onGetListFailure {} {}","RayGhd"],e,t)}onLoadPreviewsFromDB(e){return new Promise(((t,s)=>{if(this.Logger.zsymb(3,"h7gA2i",["onLoadPreviewsFromDB {}","fOHr0H"],null==e?void 0:e.length),!e||0===e.length)return this.doneLoadPreview(0),t();let i=0;const n=()=>{i++,i===e.length&&(this.doneLoadPreview(i),t())};for(let a=0;a<e.length;a++){const t=tu.entityToModel(e[a]);t&&!Yd.a.instance.filterExpiredPreview(t)&&(t.messageType=R.MSG_VANISH,t.message="",this.updateInDB(t)),this.addPreviewToManager(t).then((()=>{n()})).catch((e=>{n(),this.Logger.zsymb(21,"iGyLTD",["onload preview failure for item {} {}","oUf1rI"],null==t?void 0:t.convId,e)}))}}))}doneLoadPreview(e){this.Logger.zsymb(3,"e6QN_y",["doneLoadPreview {}","LMCP9_"],e),this.doneLoadDB=!0,this.broadcastEvent(so.b.DoneLoadPreview,"",Array.from(this.data.values())),Object(hs.j)(this.name,"all")}onReceiveNewMessage(e,t){return new Promise(((s,i)=>{if(!t)return s(!1);const n=this.convertDBMessageToPreviewItem(e,t);this.addPreviewToManager(n).then((i=>{if(i){const i="server"===e;return this.signalRenderItem(this.name,t.toUid,i),s(!0)}return s(!1)})).catch(i),this.smartDispatchEvent(so.b.ReceiveNewMsg,(()=>new so.f(e,t)))}))}onReceiveNewMessages(e,t){return new Promise((s=>{if(!t)return s(!1);const i=this.groupMessageByConvId(t),n=[];for(const e in i){if(!Object.prototype.hasOwnProperty.call(i,e))continue;const t=i[e];for(let e=t.length-1;e>=0;e--){if(Jo.default.isValidPreviewMessage(t[e])){n.push(t[e]);break}this.Logger.zsymb(3,"CMEoiA",["receive msg but not preview {}","XBPn7a"],t[e].msgId)}}return n.length?Promise.all(n.map((async t=>this.onReceiveNewMessage(e,t)))).then((e=>{const t=e.some((e=>1==e));s(t)})).catch((e=>{this.Logger.zsymb(21,"3eQJVt",["add messages to preview got error {}","gUr00O"],e),s(!1)})):s(!1)}))}onUndoMessage(e,t){if(!t)return;this.Logger.zsymb(3,"h9A7Mr",["onUndoMessage {}","wsjU0Q"],t.msgId);const s=this.convertDBMessageToPreviewItem(e,t);s.messageType=R.MSG_UNDO,s.message="",this.addPreviewToManager(s).then((e=>{e&&this.signalRenderItem(this.name,t.toUid)}))}onUpdateE2EEMessage(e,t){if(!t)return;const s=t.toUid,i=this.data.get(s);if(this.Logger.zsymb(3,"mAlFtz",["onUpdateE2EEMessage {} {} {}","sOPBWM"],s,null==i?void 0:i.msgId,t.msgId),i&&(i.msgId!==t.msgId||!Od.b.isSameMsg(i,t)))return;const n=this.convertDBMessageToPreviewItem(e,t),a=ho.default.normalizeMessageTypeFromSubState(null==t?void 0:t.e2eeStatus)||t.msgType;n.message=n.message||Jo.default.getPlainText({msgType:a}),n.verified=!0,n.messageType=a,this.data.set(t.toUid,n),this.updateInDB(n),this.signalRenderItem(this.name,t.toUid)}onDeleteMessage(e,t){return new Promise(((e,s)=>{if(!t)return e(!1);this.Logger.zsymb(3,"9TF0gI",["onDeleteMessage {}","wPC5wD"],t.msgId);const i=this.convertDBMessageToPreviewItem("db.message",t);t.msgType===R.MSG_DEL_EVERYONE&&(i.messageType=R.MSG_DEL_EVERYONE,i.message=""),this.deleteMessageInManager(i).then((s=>{s?(this.Logger.zsymb(3,"_AcgSM",["onDeleteMessage success {}","Y9Ncqx"],t.msgId),this.signalRenderItem(this.name,t.toUid),e(!0)):e(!1)}))}))}onRollMessage(){const e=new Map;this.data.forEach((t=>{Object(nu.c)(t)?this.expiredConvs.set(t.convId,t):e.set(t.convId,t)})),this.data=e,Object(hs.j)(this.name,"all")}onDeleteMessages(e,t){if(!t||t.length<1)return;const s=this.groupMessageByConvId(t);for(const i in s)if(Object.prototype.hasOwnProperty.call(s,i)){const t=s[i];let n=this.convertDBMessageToPreviewItem(e,t[0]),a=0;for(let s=1;s<t.length;s++){const i=this.convertDBMessageToPreviewItem(e,t[s]);this.isSecondItemNewer(n,i)&&(a=s,n=i)}this.onDeleteMessage(e,t[a])}}onDeleteConversation(e,t){e&&(this.Logger.zsymb(3,"0P6PL3",["onDeleteConversation {}","-fbxym"],e),"kick"!==t&&"disband"!==t?(this.expiredConvs.has(e)&&this.expiredConvs.delete(e),this.data.delete(e)&&Object(hs.f)(this.name,e),this.deleteInDB(e)):this.onLeaveConversation(e,t))}async onLeaveConversation(e,t){try{const s=this.data.get(e);if(!s)return void this.Logger.zsymb(21,"IZrLiy",["onLeaveConversation leavePreview not exist {}","YMb3Wz"],e);s.message="",s.messageType="disband"===t?R.MSG_DISBAND_GROUP:R.MSG_KICK_GROUP,this.data.set(e,s),this.signalRenderItem(this.name,e),this.updateInDB(s)}catch(s){this.Logger.zsymb(21,"yVQxyJ",["onLeaveConversation error {}","ChT-mf"],e)}}onChangeDraft(e,t){let s=this.getPreviewByIDSync(e);return!e||!s||s.draft===t||s.draft&&t&&s.draft.draftTime===t.draftTime?(!s&&t&&(this.data.set(e,{convId:e,msgId:R.FAKE_DRAFT_MSG_ID,draft:t,messageTime:-1}),this.signalRenderItem(this.name,e)),void this.Logger.zsymb(3,"SWxxPC",["onChangeDraft - reject {}","O-ub36"],!!s)):(this.Logger.zsymb(3,"ZWs6dt",["onChangeDraft - call update {}","utJzXa"],!!s),s.msgId!==R.FAKE_DRAFT_MSG_ID||t?void((s.draft||t)&&(s=Object(f.a)(Object(f.a)({},s),{},{draft:t}),this.data.set(e,s),this.signalRenderItem(this.name,e),this.broadcastEvent(so.b.DraftChanged))):(this.data.set(e,{convId:e,msgId:R.FAKE_DRAFT_MSG_ID,draft:void 0,messageTime:-1}),this.signalRenderItem(this.name,e),void this.data.delete(e)))}getPreviewById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvPreview.getById(e).then((s=>{s||this.Logger.zsymb(3,"flu34V",["get item not exist with id {}","_980cr"],e);const i=tu.entityToModel(s);t(i||void 0)})).catch(s)}))}getPreviewByIDSync(e){return this.data.get(e)}getAllPreviews(e){return new Promise(((t,s)=>{if(this.doneLoadDB&&!e)return t(this.getAllPreviewsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((e=>{const s=e.map((e=>tu.entityToModel(e)));t(s)})).catch(s)}))}getAllPreviewsSync(){return Array.from(this.data.values())||[]}getAllPreviewsForSearch(){return[...this.getAllPreviewsSync(),...Array.from(this.expiredConvs.values())]}setPreview(e,t,s,i,n,a=1,r={}){const o=this.data.get(e);this.Logger.zsymb(3,"8tHyk-",["call set preview {} {}","iwqqk5"],e,!!o);const l={convId:e,msgId:r.msgId||"unset",src:"ui",dName:r.dName||"",message:t,messageType:"",isGroup:e.startsWith(R.GROUPID_PREFIX),messageTime:s,fromUid:i,toUid:n,urgencyLevel:r.urgencyLevel,properties:null,verified:!0,status:a,computedMessage:t,computedIcon:r.icon};this.data.set(e,l),this.signalRenderItem(this.name,e),this.updateInDB(l)}setPreviewContentIfMatched(e,t,s){const i=this.data.get(e);if(void 0===i||i.msgId!==t)return;const n=Object(f.a)(Object(f.a)({},i),{},{message:s});this.data.set(e,n),this.signalRenderItem(this.name,e),this.updateInDB(n)}async rejectLatestPreview(e){void 0!==this.data.get(e)&&(this.data.delete(e),await this.DBConvPreview.remove(e),await this.revalidate(e))}async addPreviewToManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);let i=!1;if(Object(nu.c)(e))return this.expiredConvs.set(t,e),!1;if(this.expiredConvs.has(t)&&this.expiredConvs.delete(t),s){const n=!(s.messageType||s.message||!e.messageType||!e.message);n&&(s.verified=!0,this.Logger.zsymb(3,"283wet",["force update new preview item {}","Qrk2y6"],t)),(n||this.isSecondItemNewer(s,e))&&(this.data.set(t,e),i=!0,s.verified?(e.verified=!0,this.updateInDB(e)):i=await this.compareCacheWithDBAndUpdate(t,e))}else this.data.set(t,e),i=!0,"db.preview"!==e.src&&(i=await this.compareCacheWithDBAndUpdate(t,e));return i}async deleteMessageInManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);if(!s||!Od.b.isSameMsg(e,s)&&this.isSecondItemNewer(e,s))return 0!==this.deleteQueue.length&&this.deleteQueue.push(e),!1;const i=async()=>{const i=await vd.b.getPreviewMessage(t),n=this.deleteQueue.find((e=>{var t;return e.msgId===(null===(t=i.previewMsg)||void 0===t?void 0:t.msgId)}));if(n)return e.messageType===R.MSG_DEL_EVERYONE&&(n.messageType=R.MSG_DEL_EVERYONE,n.message=""),this.data.set(t,n),await this.deleteMessageInManager(n);this.deleteQueue=[];const a=this.data.get(t);if(a&&this.isSecondItemNewer(s,a))return!1;if(i.previewMsg){const s=this.convertDBMessageToPreviewItem("db.message",i.previewMsg);return s.verified=!0,e.messageType===R.MSG_DEL_EVERYONE&&(s.messageType=R.MSG_DEL_EVERYONE,s.message=""),this.data.set(t,s),this.updateInDB(s),!0}return this.data.delete(t),this.deleteInDB(t),Object(hs.f)(this.name,t),!1};if(s.verified)return await i();{const s=await this.DBConvPreview.getById(t),n=s&&tu.entityToModel(s);return n&&this.isSecondItemNewer(e,n)?(this.data.set(t,n),!0):await i()}}convertDBMessageToPreviewItem(e,t){let s=t.sendDttm||t.serverTime;s=s?s.toString():"";const i=t.fromUid||t.uidFrom,n=t.toUid||t.idTo,a=n&&n.startsWith(R.GROUPID_PREFIX);return{convId:t.toUid,msgId:t.msgId,src:e,dName:t.dName||"",message:t.message,messageType:t.msgType,mentions:t.mentions,isGroup:a,messageTime:s,fromUid:i,properties:t.properties,urgencyLevel:t.urgency,verified:!1,ttl:t.ttl,status:t.status||1,substate:t.e2eeStatus,cliMsgId:t.cliMsgId,toUid:t.toUid}}isSecondItemNewer(e,t){return!e||(t.msgId===e.msgId&&t.messageTime===e.messageTime||Od.b.isSameMsg(e,t)?t.messageType===R.MSG_UNDO&&e.messageType!==R.MSG_UNDO||Bo.ConvList.comparePreviewStt(t.status,e.status)>0:e.messageTime!==t.messageTime?t.messageTime>e.messageTime:t.msgId>e.msgId)}compareCacheWithDBAndUpdate(e,t){return new Promise(((s,i)=>{this.DBConvPreview.getById(e).then((i=>{this.Logger.zsymb(3,"vxzMjG",["compareCacheWithDBAndUpdate {} {}","K8Ia8e"],e,!!i);const n=tu.entityToModel(i),a=this.data.get(e);if(JSON.stringify(a)!==JSON.stringify(t))return s(!1);!n&&a||n&&a&&this.isSecondItemNewer(n,a)?(a.verified=!0,this.updateInDB(a)):n&&this.data.set(e,n),s(!0)})).catch(i)}))}groupMessageByConvId(e){const t={};for(let s=0;s<e.length;s++)t[e[s].toUid]?t[e[s].toUid].push(e[s]):t[e[s].toUid]=[e[s]];return t}broadcastEvent(e,t="",s){this.dispatchEvent(new so.a(e,t,s))}updateInDB(e){this.Logger.zsymb(3,"-MkBWf",["update in db {}","E1NbSl"],e.msgId);try{const t=tu.modelToEntity(e);this.DBConvPreview.addOrUpdate(t)}catch(t){this.Logger.zsymb(21,"EkmAQU",["update in db got err{}","PG7GuM"],t)}}deleteInDB(e){this.DBConvPreview.remove(e).catch((e=>{this.Logger.zsymb(18,"B-Ce2j",`[${this.name}] - deleteInDB got error ${e}`)}))}})||iu)||iu)||iu)||iu);var ou=s("rKwX"),lu=s("SWKE");const cu="z_ml";class du{constructor(){this.cache=void 0,this.cache={}}localKey(e){return cu+"_"+e}muteConversation(e,t){const s=E.default.getInstance(),i=cu+"_"+e;t?t.constructor===Object?s.setItemForCurrentUser(this.localKey(e),JSON.stringify(t)):s.setItemForCurrentUser(this.localKey(e),`${t}`):s.removeItemForCurrentUser(i),this.cache[e]=t||!1}isMuted(e){if(this.cache.hasOwnProperty(e))return this.cache[e];let t,s=E.default.getInstance().getItemForCurrentUser(this.localKey(e));if(!s)return null;try{return t=JSON.parse(s),this.cache[e]=t,t}catch(i){ho.default.logCoreError(i)}return this.cache[e]=!1,!1}setMutedConversations(e){let t=[];e.chatEntries&&e.chatEntries.length>0&&e.chatEntries.reduce(((e,t)=>(e.push(t),e)),t),e.groupChatEntries&&e.groupChatEntries.length>0&&e.groupChatEntries.reduce(((e,t)=>(t.id=R.GROUPID_PREFIX+t.id,e.push(t),e)),t);lu.a.getInstance().cleanupLocalStorageMatchConditions((e=>{const t=E.default.getInstance().getKeyNameForCurrentUser(this.localKey(""));return e.startsWith(t)})),this.cache={};for(let s=0;s<t.length;s++)this.muteConversation(t[s].id,t[s]);return t}}var uu;Object(ko.b)(jo.MuteDataManager)(uu=Reflect.metadata("design:type",Function)(uu=Reflect.metadata("design:paramtypes",[])(uu=class extends Fe.b{constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this._muteManager=void 0,this.userId=void 0,this.mapTimeout=void 0,this.name=jo.MUTE_MANAGER_NAME,this.key="id",this.didInit=!1,this.userId="",this.mapTimeout={}}init(e){this.didInit||(this.didInit=!0,this.userId=e)}get muteManager(){return this._muteManager&&""!==this.userId||(this.userId,this._muteManager=new du),this._muteManager}getItem(e,t){return this.muteManager.isMuted(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e){}onGetListFailure(e,t){}onMute(e,t){return new Promise(((s,i)=>{this._clearTimeout(e);let n=-1;switch(t){case 1:n=3600;break;case 2:n=14400;break;case 3:n=Math.round(this._getNowTo8Am()/1e3)}ho.default.logCoreInfo(`[${this.name}] - onMute ${e} ${n}`),ou.a.lock(e,n,!0).then((t=>{this.muteManager.muteConversation(e,{id:e,startTime:t.startTime,duration:t.duration,systemTime:t.systemTime,currentTime:t.currentTime,muteMode:t.muteMode}),s(!0)})).catch(i)}))}onUnMute(e,t=!0,s=!1){return new Promise(((i,n)=>{this._clearTimeout(e),ho.default.logCoreInfo(`[${this.name}] - onUnMute ${e} ${t} ${s}`),ou.a.unlock(e,t,s).then((t=>{this.muteManager.muteConversation(e,0),i(!!t)})).catch(n)}))}onFetchMute(e){ho.default.logCoreInfo(`[${this.name}] - onFetchMute`);let t=this.muteManager.setMutedConversations(e);return this.processFetchData(e),t}onCtrMute(e,t){t?(this.doLock(t,!1),this.muteManager.muteConversation(e,t),this.muteChanged(e,!!t)):this.onUnMute(e,!1).then((s=>{this.muteChanged(e,!!t)}))}isMuted(e){return this.muteManager.isMuted(e)}processFetchData(e){try{e.chatEntries&&(e.chatEntries.forEach((e=>{this.doLock(e,!0)})),e.groupChatEntries.forEach((e=>{this.doLock(e,!0)})))}catch(t){ho.default.logCoreError(t)}}doLock(e,t=!0){if(this.mapTimeout.hasOwnProperty(e.id)&&(t=!0),this._clearTimeout(e.id),-1!=e.duration){ho.default.log("setTimer",e);let s=e.duration-(e.currentTime-e.systemTime);s>=0?(ho.default.log("setTimer: lock1",e.id),ho.default.logCoreInfo("[Unmute timeout] setTimer: lock1",e.id,s),this.mapTimeout[e.id]=setTimeout((()=>{this.onUnMute(e.id,t,!0),ho.default.logCoreInfo("[Unmute timeout] setTimer: unlock1",e.id)}),1e3*s)):(ho.default.log("setTimer: unlock",s),ho.default.logCoreInfo("[Unmute timeout] setTimer: unlock",e.id),this.onUnMute(e.id,t))}}_clearTimeout(e){this.mapTimeout.hasOwnProperty(e)&&(clearTimeout(this.mapTimeout[e]),delete this.mapTimeout[e])}_getNowTo8Am(){let e=(new Date).getTime(),t=new Date(e);return t.setHours(8,0,0,0),t.getTime()<=e?t.getTime()+864e5-e:t.getTime()-e}muteChanged(e,t){Object(hs.h)(this.name,e),this.broadcastEvent(so.b.MuteChanged,e,t)}broadcastEvent(e,t="",s){this.dispatchEvent(new so.a(e,t,s))}})||uu)||uu);var hu,gu=s("kCOK"),mu=s("qvRd"),pu=s("fBUP"),fu=s("gwig");const vu="zpinc",bu="ver_pin",Iu=0,yu=1,_u=2;Object(ko.b)(mu.b)(hu=Reflect.metadata("design:type",Function)(hu=Reflect.metadata("design:paramtypes",[])(hu=class extends Fe.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this._Logger=void 0,this.reFetchCount=void 0,this.retryTimeout=void 0,this.refetchInterval=void 0,this.lastFetchTime=void 0,this.isDataLastest=void 0,this.requestingIds=void 0,this.name=mu.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.reFetchCount=0,this.isDataLastest=!1,this.lastFetchTime=0,this.requestingIds=new Map}init(){this.didInit||(this.didInit=!0,this._loadData(),this._fetchPinnedConversations(),this._addListener())}async _loadData(){const e=E.default.getInstance().getItemForCurrentUser(vu);if(e&&e.length)try{const s=JSON.parse(e),i=Object.keys(s).map((async e=>{await this._verifyPin(s[e].id)&&this.data.set(s[e].id,{id:s[e].id,priority:Number(s[e].priority)||yn.default.getTimeNow()})}));await Promise.all(i);try{this.Logger.zsymb(0,"fOJat2","pin conversations loaded from local",JSON.stringify(Object.fromEntries(this.data)))}catch(t){this.Logger.zsymb(18,"NF3Ch6","stringify fail")}this.doneLoadDB=!0;const n=this.getAllPinnedConversations();n.length&&this._broadcastEvent(so.b.ChangePinConv,n)}catch(s){0}}_addListener(){ns.default.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,(e=>{this.Logger.zsymb(0,"Y_Ibqy","remove friend - unpin",e.userId),this.updateListPin([e.userId],_u)})),this._setFetchInterval()}_setFetchInterval(){this.refetchInterval&&clearTimeout(this.refetchInterval),this.refetchInterval=setInterval((()=>{this._fetchPinnedConversations()}),864e5)}_broadcastEvent(e,t){this.dispatchEvent(new so.e(e,t))}_newPinItem(e,t){return{id:e,priority:t}}_syncServer(e,t){return this._updatePinnedConversationsV2(e,t)}getLastFetchTime(){return this.lastFetchTime}isPinned(e){return this.data.has(e)}getPinTime(e){const t=this.data.get(e);return t?t.priority:0}async _checkAndSyncDataBeforeAction(){if(!this.isDataLastest)try{return await this._fetchPinnedConversations(),!0}catch(e){return!1}return!0}pin(e){return this.Logger.zsymb(0,"7OEmG6","client pin",e),new Promise((async(t,s)=>{const i=await this._checkAndSyncDataBeforeAction();if(!e||!e.length)return s(null);if(i){if(this.data.size+e.length>mi.default.limit_pin_messages)return s(null);let i=[];for(let t=0;t<e.length;++t)this.isPinned(e[t])||i.push(e[t]);if(i.length>0)try{const s=await this._syncServer(i,yu);return this.updateListPin(e,yu),t(s)}catch(n){return s(n)}}return s(null)}))}pinLocal(e){this.updateListPin(e,yu)}unpin(e,t=!1){return this.Logger.zsymb(0,"xb8v0c","client unpin",e,"force sync",t),new Promise((async(s,i)=>{if(!e||!e.length)return i(null);if(await this._checkAndSyncDataBeforeAction()){let a=[];for(let s=0;s<e.length;++s)(this.isPinned(e[s])||t)&&a.push(e[s]);if(a.length>0)try{await this._syncServer(a,_u),this.updateListPin(e,_u),s(1)}catch(n){i(n)}}return i(null)}))}unpinLocal(e){this.Logger.zsymb(0,"S13Y99","unpin local",e),this.updateListPin(e,_u)}getAllPinnedConversations(){return Array.from(this.data.values())}getAllPinnedConversationsSync(){return Array.from(this.data.values())}getTotalPinnedConversation(){return this.data.size+Array.from(this.requestingIds.values()).filter((e=>e===yu)).length}async _verifyPin(e){try{const{isOk:t,index:s}=await this.checkPromises([()=>Promise.resolve(ns.default.isFriend(e)),()=>Promise.resolve(Zo.default.getGroupByIdSync(e)),()=>Promise.resolve(e===mi.default.sendToMeId),()=>new Promise((t=>{ns.default.getProfileFriendByIds([e],R.SRC_GET_PROFILE.FETCH_MINI_INFO,{isReqOAInfo:!0}).then((s=>{var i;return t((null==s||null===(i=s[e])||void 0===i?void 0:i.type)>=1)})).catch((()=>t(!1)))}))]);return this.Logger.zsymb(3,"VjWVCr",["verify pinned conversation","AEFlBk"],e,t,s),t}catch(t){return this.Logger.zsymb(21,"93qhwU",["Error checking if conversation is OA","aisFAg"],e,t),!1}}async checkPromises(e){for(let s=0;s<e.length;s++)try{if(await e[s]())return{isOk:!0,index:s}}catch(t){continue}return{isOk:!1,index:-1}}async updateListPin(e,t){if(this.Logger.zsymb(0,"N-vM79","updateListPin",e,t),!e||!e.length)return;const s=[];switch(t){case yu:{let t=yn.default.getTimeNow();const i=e.map((async e=>{if(await this._verifyPin(e)&&!this.data.has(e)){++t,this.requestingIds.get(e)&&this.requestingIds.set(e,Iu);return{convId:e,pin:this._newPinItem(e,t)}}return null}));(await Promise.all(i)).forEach((e=>{e&&(this.data.set(e.convId,e.pin),s.push(e.pin),Object(hs.h)(this.name,e.convId))}));break}case _u:for(let t=0;t<e.length;t++)if(this.data.has(e[t])){this.requestingIds.get(e[t])&&this.requestingIds.set(e[t],Iu),this.data.delete(e[t]);const i=this._newPinItem(e[t],0);s.push(i),Object(hs.h)(this.name,e[t])}break;default:return}s.length&&this._broadcastEvent(so.b.ChangePinConv,s),this._updateInDB()}_retryFetch(e){if(this.reFetchCount>5)return;let t=0;switch(e){case"ERR_NO_NETWORK":case-69:break;case 212:this.Logger.zsymb(20,"xPX2ek","hasn't pinned conversation from server");E.default.getInstance().setItemForCurrentUser(bu,"0"),this._sendToServer();break;case"ERR_CONNECTION_TIMED_OUT":case 112:t=5e3*this.reFetchCount;break;default:t=36e5}this.Logger.zsymb(21,"Evob7a",["Handle request error fail with error: {}, retry after time= {}","CoomfN"],e,t),this.retryTimeout||t>0&&(this.retryTimeout=setTimeout((()=>{this._fetchPinnedConversations(),this.retryTimeout=void 0}),t))}_parseData(e){let t=[];for(let s=0;s<e.length;++s)"m1"===e[s]||(e[s].startsWith("g")?t.push(e[s]):t.push(e[s].slice(1)));return t}_fetchPinnedConversations(){return this.reFetchCount++,this.Logger.zsymb(0,"8r6DrL","_fetchPinnedConversations",this.reFetchCount),new Promise(((e,t)=>{pu.default.getPinnedConversations().then(gu.a).then((t=>{if(t&&t.conversations){const e=E.default.getInstance();void 0===t.version&&null===t.version||e.setItemForCurrentUser(bu,t.version),this._onFetchPin(this._parseData(t.conversations))}e(t)})).catch((e=>{this.isDataLastest=!1,e&&(e.error_code?this._retryFetch(e.error_code):e.code?this._retryFetch(e.code):this._retryFetch("UNKNOWN_ERROR")),t(e)}))}))}_updatePinnedConversationsV2(e,t){return new Promise(((s,i)=>{if(!mi.default.enable_sync_pinned)return;if(!fu.b.getStateNetwork())return void i(t===yu?os.a.str("STR_ERR_NETWORK_PIN_CONVERSATION"):os.a.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));let n=[];for(let a=0;a<e.length;++a)e[a].startsWith("g")||e[a].startsWith("u")||(e[a]="u"+e[a]),n.includes(e[a])||this.requestingIds.has(e[a])&&this.requestingIds.get(e[a])!==Iu||(n.push(e[a]),this.requestingIds.set(e[a],t));n.length&&pu.default.updatePinnedConversationsV2(n,t).then(gu.a).then((()=>{n.forEach((e=>{this.requestingIds.set(e,Iu)})),s(!0)})).catch((e=>{n.forEach((e=>{this.requestingIds.set(e,Iu)})),this.Logger.zsymb(20,"CFuGl9","Update sync pin conv v2 FAIL: "+e);let s="";if(e)if(e.error_code)if(160===e.error_code)this._fetchPinnedConversations();else s=os.a.str("STR_ERR_PIN_CONVERSATION")+" ("+e.error_code+")";else"ERR_NO_NETWORK"===e.code&&fu.b.getStateNetwork()==fu.a.DISCONNECT&&(s=t===yu?os.a.str("STR_ERR_NETWORK_PIN_CONVERSATION"):os.a.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));i(s)}))}))}_isRemoteDataChanged(e){const t=Array.from(this.data.values()).sort(((e,t)=>t.priority-e.priority)).map((e=>e.id));if(e.length!==t.length)return!0;let s=!1;return e.forEach(((e,i)=>{e!==t[i]&&(s=!0)})),s}async _onFetchPin(e){this.Logger.zsymb(0,"cC53Lc","onFetchPin",e),this.isDataLastest=!0,this.lastFetchTime=yn.default.getTimeNow(),this.reFetchCount=0;let t=yn.default.getTimeNow();this._setFetchInterval();const s=[],i=[];for(let a=0;a<e.length;a++)try{await this._verifyPin(e[a])?i.push(e[a]):this.unpin([e[a]],!0)}catch(n){this.Logger.zsymb(18,"ar5hJZ","Error verifying pin for conversation",e[a],n)}if(this._isRemoteDataChanged(i)){for(const e of Array.from(this.data.values()))i.find((t=>t===e.id))||(this.data.delete(e.id),Object(hs.h)(this.name,e.id),s.push({id:e.id,priority:0}));for(let e=0;e<i.length;e++){const n=this._newPinItem(i[e],t),a=this.isPinned(i[e]);this.data.set(i[e],n),a||Object(hs.h)(this.name,i[e]),t--,s.push(n)}this.Logger.zsymb(0,"4w-lci","[After Fetch]",Array.from(this.data.values())),s.length&&this._broadcastEvent(so.b.ChangePinConv,s),this._updateInDB()}}_sendToServer(){this._syncServer(Array.from(this.data.keys()),yu)}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){this.Logger.zsymb(18,"rVXWjo","onGetItemFailure - key:",e," - error",t)}onGetListFailure(e,t){this.Logger.zsymb(18,"9pk6Lp","onGetItemFailure - key:",e," - error",t)}_updateInDB(){if(!this.data)return;const e=E.default.getInstance();this.data.size?e.setItemForCurrentUser(vu,JSON.stringify(Array.from(this.data.values()))):e.removeItemForCurrentUser(vu)}})||hu)||hu);var Cu,Ou=s("MnJw");Object(ko.b)(Ou.b)(Cu=Reflect.metadata("design:type",Function)(Cu=Reflect.metadata("design:paramtypes",[])(Cu=class extends Fe.b{constructor(){super()}onUpdateListArchivedChat(e){this.dispatchEvent(new so.a(so.b.UpdateListArchivedChat,e))}onOffArchivedChat(e){this.dispatchEvent(new so.a(so.b.OnOffArchivedChat,"",{status:e}))}})||Cu)||Cu);var Eu=s("413w"),Mu=s("KGrx"),Su=s("YZUF"),Tu=s("k1WO"),wu=s("DS8e");class Ru extends Error{constructor(e){super(e.message||e.code),this._code=void 0,this._code=wu.a[e.code]}get code(){return this._code}}var Lu=s("8Isn"),Du=s("iRKH"),Au=s("hNYB"),Fu=s("jnJr"),ju=s("2+pv"),Pu=s("QDKs");function ku(e){if(!e)return!1;if(!["string","number"].includes(typeof e))return!1;if("string"==typeof e){const t=Number(e);if(isNaN(t)||(t+"").length!==e.length)return!1}return!0}function Nu(e){return(e+"").startsWith(R.GROUPID_PREFIX)}function Uu(e,t){return new Promise((async(s,i)=>{try{const i=null==t?void 0:t.limit;let o=await Bu(e);var n,a,r;if(o)e.cliMsgId=null===(n=o.msg)||void 0===n?void 0:n.cliMsgId,e.fromUid=null===(a=o.msg)||void 0===a?void 0:a.fromUid,e.toUid=null===(r=o.msg)||void 0===r?void 0:r.toUid;let l=await function(e,t){return new Promise((async(s,i)=>{try{if(!e.convId||!e.cliMsgId)return s(void 0);const i={msgId:e.msgId+"",cliMsgId:e.cliMsgId+"",fromUid:e.fromUid+"",toUid:e.convId+""},n=tt.default.getInstance(),a={index:"cliMsgIdIndex",limit:t,direction:Le.c.PREV,predicate:e=>Object(Lu.a)(e,i),partition:e.convId},r={from:e.cliMsgId+"",to:e.cliMsgId+"",excludeFrom:!1,excludeTo:!1},o=await n.Core.Message.getAll(r,a);let l=o[0];const c=o.map((e=>e.msgId)),d=[];o.length>1&&i.fromUid&&(l=o.reduce(((e,t)=>{var s,n;return t.fromUid!==i.fromUid?e:(e||(e=t),t.isLocalMsgId||null!==(s=t.msgId)&&void 0!==s&&s.includes("_")?(e.msgId!==t.msgId&&d.push(t.msgId),e):e.isLocalMsgId||null!==(n=e.msgId)&&void 0!==n&&n.includes("_")?(d.push(e.msgId),e=t):(Number.isInteger(parseInt(e.msgId))&&Number.isInteger(parseInt(t.msgId))&&(parseInt(e.msgId)>parseInt(t.msgId)||parseInt(e.msgId)==parseInt(t.msgId)&&e.msgId>t.msgId)&&(d.push(e.msgId),e=t),e))}))),s({msg:l,msgIds:c,duplicatedMsgIds:d})}catch(n){Bu(e).then(s).catch(i)}}))}(e,i);if(o)return s({msg:o.msg,msgIds:(null==l?void 0:l.msgIds)||[],duplicatedMsgIds:(null==l?void 0:l.duplicatedMsgIds)||[]});if(null!=l&&l.msg)return s(l);s(void 0)}catch(o){i(o)}}))}function Bu(e){return new Promise((async(t,s)=>{try{if(!e.convId)return t(void 0);if(!e.msgId)return t(void 0);const s=tt.default.getInstance(),i=await s.Core.Message.get(e.msgId,{partition:e.convId});if(i)return t({msg:i,msgIds:[i.msgId],duplicatedMsgIds:[]});t(void 0)}catch(i){s(i)}}))}function xu(e){if(!e)return;const{msgId:t,cliMsgId:s,fromUid:i,toUid:n}=Object(Du.c)(e);if(ku(s)&&ku(i)&&t)return{ownerId:i+"",cliMsgId:s+"",globalMsgId:Eu.a.normalize(t),destId:n}}async function Gu(e){try{const t=tt.default.getInstance(),s={from:[e,"",""],to:[e,nl,il],excludeFrom:!1,excludeTo:!1},i={index:"userId_sendDttm_msgId",limit:1,direction:Le.c.PREV,partition:e,predicate:e=>!!(e.cliMsgId&&e.fromUid&&e.msgId)},n=await t.Core.Message.getAll(s,i);return null==n?void 0:n[0]}catch(t){return}}const zu=Object(Vc.d)()?Pu.a:{info:void 0,warn:void 0,error:void 0,zlog:Pu.a.zlog};var Vu;let Hu=Object(i.injectable)()(Vu=function(e,t){return Object(i.inject)(jo.ConvInfoDataManager)(e,void 0,0)}(Vu=function(e,t){return Object(i.inject)(jo.PreviewDataManager)(e,void 0,1)}(Vu=Reflect.metadata("design:type",Function)(Vu=Reflect.metadata("design:paramtypes",[void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager,void 0===jo.PreviewDataManager?Object:jo.PreviewDataManager])(Vu=class extends Fe.b{constructor(e,t){super(),this.convInfoDataManager=e,this.previewDataManager=t,this.database=void 0,this.taskManager=void 0,this.joinGroupTime={},this.receivedActions={},this.database=tt.default.getInstance(),this.taskManager=(new Mu.TaskManager).setup("conversation-operation");const s=()=>{Tu.a.key("enable_restore_task").boolean&&(Tu.a.remove(s),this.restoreBackupTasks())};Tu.a.add(s)}deleteConversation(e,t){return new Promise((async(s,i)=>{try{var n,a,r,o,l;if(null===(n=zu.info)||void 0===n||n.call(zu,el,`${e} Delete conversation start`,t),zu.zlog.zsymb(0,"c9EIvp",`${e} ${el} Delete conversation start`),Su.b.start(Su.a.ART_delete_conversation_v2),!e)throw new Ru({code:"INVALID_CONVERSATION_DATA",message:`${e} Delete conversation info is invalid`});const i=await this.convInfoDataManager.getConvById(e),u=await this.previewDataManager.getPreviewById(e),h=(null==t?void 0:t.deleteTime)||yn.default.getTimeNow();let g=(null==t||null===(a=t.messageInfo)||void 0===a?void 0:a.msgId)||(null==u?void 0:u.msgId),m=(null==t||null===(r=t.messageInfo)||void 0===r?void 0:r.cliMsgId)||(null==u?void 0:u.cliMsgId);if(void 0===g){const t=await Gu(e);g=null==t?void 0:t.msgId,m=null==t?void 0:t.cliMsgId}const p={convId:e,msgId:g,cliMsgId:m,toUid:e,fromUid:null==t||null===(o=t.messageInfo)||void 0===o?void 0:o.fromUid,initialDeleteTime:h,deleteTime:h,isGroup:Nu(e),isLeaveGroup:null==t?void 0:t.isLeaveGroup,isLeaveGroupInSilentMode:null==t?void 0:t.isLeaveGroupInSilentMode,leaveType:null==t?void 0:t.leaveType,isForceDelete:null==t?void 0:t.isForceDelete,isDeleteResource:"boolean"!=typeof(null==t?void 0:t.isDeleteResource)||t.isDeleteResource,isExistConvInfo:!!i,isExistPreviewInfo:!!u,delConversationId:e},f=`${p.convId}_${p.msgId}_${p.cliMsgId}`;if("client"!==(null==t?void 0:t.source)||null!=t&&t.isDisableSync){if("server"===(null==t?void 0:t.source)&&this.receivedActions[f]){var c;return delete this.receivedActions[f],null===(c=zu.warn)||void 0===c||c.call(zu,el,`${p.convId} Delete conversation is duplicate action ${f}`),Su.b.cancel(Su.a.ART_delete_conversation_v2),s(p)}}else this.receivedActions[f]=!0;if(!this.isNewDeleteEvent(e,p.initialDeleteTime))throw new Ru({code:"CANCEL_DELETE_CONVERSATION",message:`${e} Delete conversation info is old event`});var d;if(!p.isForceDelete&&(ho.default.isKickOrDisbandGroup(i)||(null==u?void 0:u.messageType)===R.MSG_KICK_GROUP||(null==u?void 0:u.messageType)===R.MSG_DISBAND_GROUP))return null===(d=zu.warn)||void 0===d||d.call(zu,el,`${e} Delete conversation info is kick or disband group`),Su.b.cancel(Su.a.ART_delete_conversation_v2),s(p);this.fireEventsBeforeDeleteConversation(p);if(Tu.a.key("sync_delete_conversation").boolean&&!(null!=t&&t.isDisableSync)){const t=await this.createSyncDeleteConversationData(e,{msgId:p.msgId,cliMsgId:p.cliMsgId,fromUid:p.fromUid});this.syncDeleteConversation(e,t)}await this.deleteConversationInfo(p),this.deleteMessagesWithConversationInfo(p),this.fireEventsAfterDeleteConversation(p),null===(l=zu.info)||void 0===l||l.call(zu,el,`${e} Delete conversation success`,p),zu.zlog.zsymb(0,"05TYlP",`${e} ${el} Delete conversation success`),Su.b.end(Su.a.ART_delete_conversation_v2),s(p)}catch(h){var u;const t=h;null===(u=zu.error)||void 0===u||u.call(zu,el,`${e} Delete conversation error`,t.code||-1,t),zu.zlog.zsymb(18,"8utJbo",`${el} ${e} Delete conversation error ${t.message}`),Su.b.end(Su.a.ART_delete_conversation_v2,{isFailed:!0,errorCode:t.code||-1}),i(t)}}))}deleteMessage(e,t){return new Promise((async(s,i)=>{const{convId:n,msgId:a,cliMsgId:r,fromUid:o,toUid:l,uidSenderDel:c}=e;try{var d,u;const i=(null==t?void 0:t.type)||"only-me";null===(d=zu.info)||void 0===d||d.call(zu,el,`${a} Delete message start`,e,t),zu.zlog.zsymb(0,"E2L9cX",`${el} ${a} Delete message start`),Su.b.start(Su.a.ART_delete_message_v2);const h={convId:n,msgId:a,cliMsgId:r,fromUid:o,toUid:l,uidSenderDel:c,type:i,isDisableSync:(null==t?void 0:t.isDisableSync)||!0,isDeleteResource:"boolean"!=typeof(null==t?void 0:t.isDeleteResource)||t.isDeleteResource,conversation:{userId:n}};if(!function(e){return!(!e.convId||!e.cliMsgId)}(h))throw new Ru({code:"INVALID_MESSAGE_DATA",message:`${a} Delete message info is invalid`});const g=await this.deleteMessageWithMessageInfo(h)||{};null===(u=zu.info)||void 0===u||u.call(zu,el,`${a} Delete message success`,h),zu.zlog.zsymb(0,"5hwcy9",`${el} ${a} Delete message success`),Su.b.end(Su.a.ART_delete_message_v2),s(Object(f.a)(Object(f.a)({},h),g))}catch(g){var h;const e=g;null===(h=zu.error)||void 0===h||h.call(zu,el,`${a} Delete message error`,e.code||-1,e),zu.zlog.zsymb(18,"9NYvZL",`${el} ${a} Delete message error ${e.message}`),Su.b.end(Su.a.ART_delete_message_v2,{isFailed:!0,errorCode:e.code||-1}),i(e)}}))}setJoinGroupTime(e,t){e&&t&&(!this.joinGroupTime[e]||this.joinGroupTime[e]<t)&&(this.joinGroupTime[e]=t)}restoreBackupTasks(){const e=this.createDeleteConversationTask();e.onRestore((t=>{if(t)for(let e in t)this.deleteMessagesWithConversationInfo(t[e],!1);e.close(!0,"Restore delete conversations")}));const t=this.createDeleteMessageTask();t.onRestore((e=>{if(e)for(let t in e)this.deleteMessageWithMessageInfo(e[t],!1);t.close(!0,"Restore delete messages")}))}isNewDeleteEvent(e,t){return!this.joinGroupTime[e]||!t||this.joinGroupTime[e]<t}syncDeleteConversation(e,t){return new Promise((async(s,i)=>{try{var n,a;if(null===(n=zu.info)||void 0===n||n.call(zu,el,`${e} Sync delete conversation start`,t),zu.zlog.zsymb(0,"urEsdR",`${el} ${e} Sync delete conversation start`),Su.b.start(Su.a.ART_delete_conversation_sync_v2),!t)throw new Ru({code:"INVALID_CONVERSATION_DATA",message:`${e} Sync delete conversation data is invalid`});await uo.default.syncDeleteConversation(e,Nu(e),t,$l.a.next()+""),null===(a=zu.info)||void 0===a||a.call(zu,el,`${e} Sync delete conversation success`),zu.zlog.zsymb(0,"nlQ9nn",`${el} ${e} Sync delete conversation success`),Su.b.end(Su.a.ART_delete_conversation_sync_v2),s()}catch(o){var r;const t=new Ru({code:"SYNC_CONVERSATION_ERROR",message:`${e} Sync delete conversation failed`});null===(r=zu.error)||void 0===r||r.call(zu,el,`${e} Sync delete conversation failed`),zu.zlog.zsymb(18,"bzke6K",`${el} ${e} Sync delete conversation failed`),Su.b.end(Su.a.ART_delete_conversation_sync_v2,{isFailed:!0,errorCode:t.code||-1}),i(t)}}))}deleteConversationInfo(e){return new Promise((async(t,s)=>{try{if(!e.convId)throw new Ru({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete conversation info is invalid`});if(Tu.a.key("leave_conversation_ui").boolean&&!jl.q.isCommunity(e.convId)||delete e.leaveType,"disband"===e.leaveType){const t=Zo.default.getGroupByIdSync(e.convId);(null==t?void 0:t.creatorId)&&t.creatorId===ns.default.getUidMe()&&delete e.leaveType}const s=e.isLeaveGroup||e.convId===mi.default.sendToMeId;this.previewDataManager.onDeleteConversation(e.convId,e.leaveType),s?await this.convInfoDataManager.onDeleteConversation(e.convId,e.leaveType):await this.convInfoDataManager.onEmptyConversation(e.convId),e.isForceDelete&&Zo.default.removeGroupById(e.convId),t()}catch(i){s(new Ru({code:"CONVERSATION_INFO_ERROR",message:`${e.convId} Delete conversation info failed`}))}}))}deleteMessagesWithConversationInfo(e,t=!0){return new Promise((async(s,i)=>{const n=this.createDeleteConversationTask(),a=n=>{var a;null===(a=zu.error)||void 0===a||a.call(zu,el,`${e.convId} Run delete messages error`,n.code||-1,n),zu.zlog.zsymb(18,"yEj_N8",`${el} ${e.convId} Run delete messages error ${n.message}`),Su.b.end(Su.a.ART_delete_messages_in_batch_v2,{isFailed:!0,errorCode:n.code||-1}),t?i(n):s()};n.execute((()=>{Su.b.start(Su.a.ART_delete_messages_in_batch_v2),this.runDeleteMessages(e,(()=>{Su.b.end(Su.a.ART_delete_messages_in_batch_v2),s(),n.close()}),(e=>{a(e),n.close()}))}),e),n.onError((e=>a(e)))}))}async runDeleteMessages(e,t,s){try{if(e.convId&&!this.isNewDeleteEvent(e.convId,e.initialDeleteTime))return void s(new Ru({code:"CANCEL_DELETE_CONVERSATION",message:`${e.convId} Delete batch messages is canceled`}));const i=await this.getDeleteInfoByThread(e);if(!i)throw e.isExistConvInfo&&e.isExistPreviewInfo?new Ru({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete conversation info is invalid`}):new Ru({code:"NOT_FOUND_CONVERSATION",message:`${e.convId} Conversation not found`});const n=Object(f.a)({},e);n.msgId!=i.maxMsgId&&(n.msgId=i.maxMsgId),n.deleteTime&&i.maxSendDttm&&n.deleteTime!=i.maxSendDttm&&(n.deleteTime=i.maxSendDttm),n.cliMsgId!=i.maxCliMsgId&&(n.cliMsgId=i.maxCliMsgId),this.database.Core.runFakeTransaction([this.database.Core.Message],(async([a])=>new Promise((async()=>{try{var r,o,l;if(null===(r=zu.info)||void 0===r||r.call(zu,el,`${e.convId} Delete batch messages start`),null!==(o=i.duplicatedMsgIds)&&void 0!==o&&o.length)null===(l=zu.info)||void 0===l||l.call(zu,el,`${e.convId} Delete duplicated messages for first message in batch`,i.duplicatedMsgIds),await a.deleteMulti(i.duplicatedMsgIds,{partition:e.convId});const u=await this.deleteBatchMessages(n,a);var c,d;if(u.isContinue)return null===(c=zu.info)||void 0===c||c.call(zu,el,`${e.convId} Delete batch messages success`,n),n.msgId=u.nextRoundMsgId,n.cliMsgId=u.nextRoundCliMsgId,n.fromUid=u.nextRoundFromUid,n.rangeMessage=u.oldRoundRangeMessage,this.runDeleteMessages(n,t,s);null===(d=zu.info)||void 0===d||d.call(zu,el,`${e.convId} Delete batch messages success`),t()}catch(u){const e=u;s(e.code?e:new Ru({code:"DB_ERROR",message:`${n.convId} Delete batch messages failed`}))}}))))}catch(i){s(i)}}deleteBatchMessages(e,t){return new Promise((async(s,i)=>{try{var n;if(!e.convId)return i(new Ru({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete batch messages data is invalid`}));const r={isContinue:!1,nextRoundMsgId:void 0};if(!e.msgId)return s(r);const o=this.getBatchMessagesLimit();if(o<1)return s(r);const l={from:[e.convId+"","",""],to:[e.convId+"",e.deleteTime+"",e.msgId+""],excludeFrom:!1,excludeTo:!1},c={index:"userId_sendDttm_msgId",limit:o+1,direction:Le.c.PREV,partition:e.convId,useLGKeyRange:!0},d=await t.getAll(l,c),u=d.map((e=>e.msgId));if(0===d.length)return s(r);if(d.length>o){r.isContinue=!0;const e=d.pop();u.pop(),r.nextRoundMsgId=null==e?void 0:e.msgId,r.nextRoundCliMsgId=null==e?void 0:e.cliMsgId,r.nextRoundFromUid=null==e?void 0:e.fromUid}null===(n=zu.info)||void 0===n||n.call(zu,el,`${e.convId} Delete batch messages list`,d);const h={fromId:d[0].msgId,toId:d[d.length-1].msgId};if(e.rangeMessage){if(e.rangeMessage.fromId===d[0].msgId&&e.rangeMessage.toId===d[d.length-1].msgId)return i(new Ru({code:"LOOP_ERROR",message:`${e.convId} Loop delete batch messages`}));r.oldRoundRangeMessage=h}else r.oldRoundRangeMessage=h;this.fireEventsBeforeDeleteBatchMessages(e,d),await t.deleteMulti(u,{partition:e.convId}),this.fireEventsAfterDeleteBatchMessages(e,d),void 0===e.countDeleted&&(e.countDeleted=0),e.countDeleted++;const g=this.getBatchThrottleTime();var a;if(r.isContinue&&g>0)null===(a=zu.info)||void 0===a||a.call(zu,el,`${e.convId} Delete batch messages sleep`,g),await Object(Vc.i)(g);s(r)}catch(o){var r;null===(r=zu.error)||void 0===r||r.call(zu,el,`${e.convId} Delete batch messages failed`,o),i(o)}}))}syncDeleteMessage(e,t){const{convId:s}=e;return s?new Promise((async(i,n)=>{try{var a,r;null===(a=zu.info)||void 0===a||a.call(zu,el,`${t.msgId} Sync delete message start`),zu.zlog.zsymb(0,"C5OqIs",`${el} ${t.msgId} Sync delete message start`),Su.b.start(Su.a.ART_delete_message_sync_v2),await uo.default.syncDeleteMessage(s,Nu(s),[xu(t)],$l.a.next(),"only-me"===e.type?1:0,void 0,Object(Nd.f)(t)===R.MSG_E2EE),null===(r=zu.info)||void 0===r||r.call(zu,el,`${t.msgId} Sync delete message success`),zu.zlog.zsymb(0,"1IXiGP",`${el} ${t.msgId} Sync delete message success`),Su.b.end(Su.a.ART_delete_message_sync_v2),i()}catch(o){const e=new Ru({code:"SYNC_MESSAGE_ERROR",message:`${t.msgId} Sync delete message failed`});Su.b.end(Su.a.ART_delete_message_sync_v2,{isFailed:!0,errorCode:e.code||-1}),n(e)}})):Promise.resolve()}deleteMessageWithMessageInfo(e,t=!0){return new Promise((async(s,i)=>{try{const n=await Uu({convId:e.convId,msgId:e.msgId,cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid}),a=null==n?void 0:n.msg,r=(null==n?void 0:n.msgIds)||[],o=(null==n?void 0:n.duplicatedMsgIds)||[];if(!a)throw new Ru({code:"NOT_FOUND_MESSAGE",message:`${e.msgId} Message not found`});Tu.a.key("sync_delete_message").boolean&&!(null!=e&&e.isDisableSync)&&this.syncDeleteMessage(e,a),this.fireEventsBeforeDeleteMessage(e,[a]);const l=this.createDeleteMessageTask(),c=e=>{t?i(e):s(void 0)};l.execute((async()=>{var t;o.length&&(null===(t=zu.info)||void 0===t||t.call(zu,el,`${e.msgId} Delete duplicated messages`,o),await this.database.Core.Message.deleteMulti(o,{partition:e.convId}));let i=Object(f.a)({},a);switch(e.uidSenderDel&&(i.uidSenderDel=e.uidSenderDel),e.type){case"only-me":await this.database.Core.Message.delete(a.msgId,{partition:e.convId});break;case"recall":i=Jo.default.convertToRecalled(i),i.msgType=R.MSG_UNDO,i.originMsgType="chat.undo",Object(Nd.f)(i)!==R.MSG_E2EE_PENDING&&Object(Nd.f)(i)!==R.MSG_E2EE_FAILED||(i.e2eeStatus=R.MSG_E2EE_UNDO),await this.database.Core.Message.insert(i,{replace:!0});break;case"everyone":i=Jo.default.convertToDelEveryone(i),i.msgType=R.MSG_DEL_EVERYONE,await this.database.Core.Message.insert(i,{replace:!0})}await this.deleteMessageInfo(e,i,r),this.fireEventsAfterDeleteMessage(e,[a]),s(i);const n=this.getMessageThrottleTime();var c;n>0&&(null===(c=zu.info)||void 0===c||c.call(zu,el,`${e.msgId} Delete message sleep`,n),await Object(Vc.i)(n));l.close()}),e),l.onError((e=>c(e)))}catch(n){t&&i(n)}}))}deleteMessageInfo(e,t,s){return new Promise((async(i,n)=>{try{switch(e.type){case"only-me":await this.previewDataManager.onDeleteMessage("server",t),e.convId&&await this.convInfoDataManager.onDeleteMessages(e.convId,s.map((e=>({msgId:e}))));break;case"recall":await this.previewDataManager.onUndoMessage("server",t);break;case"everyone":await this.previewDataManager.onDeleteMessage("server",t)}i()}catch(a){n(new Ru({code:"MESSAGE_INFO_ERROR",message:`${t.msgId} Delete message info failed`}))}}))}createSyncDeleteConversationData(e,t){return new Promise((async(s,i)=>{try{const i=e=>"0"==e?ns.default.getUidMe():e;if(ku(t.fromUid)&&ku(t.cliMsgId)&&t.msgId)return s({ownerId:i(t.fromUid+""),cliMsgId:t.cliMsgId+"",globalMsgId:Eu.a.normalize(t.msgId)});const n=await Gu(e);if(n&&n.fromUid&&n.cliMsgId&&n.msgId)return s({ownerId:i(n.fromUid+""),cliMsgId:n.cliMsgId+"",globalMsgId:Eu.a.normalize(n.msgId)});s(void 0)}catch(n){i(n)}}))}createDeleteConversationTask(){return this.taskManager.createTask("runDeleteMessages",{priority:"normal",backup:{key:"runDeleteMessages"},retry:Tu.a.key("retry_time").number,waitForRetry:Tu.a.key("wait_for_retry").number})}createDeleteMessageTask(){return this.taskManager.createTask("deleteMessage",{priority:"high",backup:{key:"deleteMessage"},retry:Tu.a.key("retry_time").number,waitForRetry:Tu.a.key("wait_for_retry").number})}getDeleteInfoByThread(e){return new Promise((async(t,s)=>{try{if(!e.convId)return t(void 0);const s=await Uu({convId:e.convId,msgId:e.msgId,cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid}),i=null==s?void 0:s.msg,n=null==s?void 0:s.duplicatedMsgIds;if(i)return t({maxMsgId:i.msgId,maxSendDttm:parseInt(i.sendDttm),maxCliMsgId:i.cliMsgId,duplicatedMsgIds:n});if(e.msgId&&e.deleteTime)return t({maxMsgId:e.msgId,maxSendDttm:e.deleteTime,maxCliMsgId:e.cliMsgId});t(void 0)}catch(i){s(i)}}))}getBatchMessagesLimit(){return ji.l?Tu.a.key("batch_messages_limit_for_web").number:Tu.a.key("batch_messages_limit").number}getBatchThrottleTime(){return ji.l?Tu.a.key("batch_messages_throttle_for_web").number:Tu.a.key("batch_messages_throttle").number}getMessageThrottleTime(){return ji.l?Tu.a.key("message_throttle_for_web").number:Tu.a.key("message_throttle").number}fireEventsBeforeDeleteConversation(e){try{this.dispatchEvent(new wu.b(wu.c.BeforeDeleteConversation,{data:e}))}catch(t){}}fireEventsAfterDeleteConversation(e){try{this.dispatchEvent(new wu.b(wu.c.AfterDeleteConversation,{data:e}))}catch(t){}}fireEventsBeforeDeleteBatchMessages(e,t){try{this.dispatchEvent(new wu.b(wu.c.BeforeDeleteBatchMessages,{data:e,messages:t}))}catch(s){}}fireEventsAfterDeleteBatchMessages(e,t){try{this.dispatchEvent(new wu.b(wu.c.AfterDeleteBatchMessages,{data:e,messages:t}))}catch(s){}}fireEventsBeforeDeleteMessage(e,t){try{this.dispatchEvent(new wu.b(wu.c.BeforeDeleteMessage,{data:e,messages:t}))}catch(s){}}fireEventsAfterDeleteMessage(e,t){try{this.dispatchEvent(new wu.b(wu.c.AfterDeleteMessage,{data:e,messages:t}))}catch(s){}}})||Vu)||Vu)||Vu)||Vu)||Vu;var Wu;i.ModuleContainer.registerSingleton(jo.ConversationOperation,Hu);let $u=Object(i.injectable)()(Wu=Reflect.metadata("design:type",Function)(Wu=Reflect.metadata("design:paramtypes",[])(Wu=class{constructor(){this.isInitial=!1,this.isReady=!1,this.storage=void 0,this.timeoutSaveCache=null,this.data={},this.setTemp={},this.removeTempArr=[],this.storage=E.default.getInstance()}async init(e){if(Tu.a.key("enable").boolean&&Tu.a.key("cache_conversation_deletion").boolean)try{if(this.isInitial)return void(null==e||e());this.isInitial=!0;const t=await this.storage.getItemForCurrentUserAsync(al);t&&(this.data=JSON.parse(t)),this.data=Object(f.a)(Object(f.a)({},this.data),this.setTemp),this.setTemp={};for(const e of this.removeTempArr)delete this.data[e];this.removeTempArr=[],this.runTimeoutSaveCache(),this.isReady=!0,null==e||e()}catch(s){var t;this.isInitial=!1,null===(t=zu.error)||void 0===t||t.call(zu,sl,"Init conversation deletion cache fail"),zu.zlog.zsymb(18,"5qb6MI",`${sl} Init conversation deletion cache fail`)}}getDeletedConversations(){return Tu.a.key("cache_conversation_deletion").boolean&&this.isReady?Object.values(this.data):[]}setDeletedConversation(e,t){Tu.a.key("cache_conversation_deletion").boolean&&e&&t&&(this.isReady?(this.data[e]=t,this.runTimeoutSaveCache()):this.setTemp[e]=t)}removeDeletedConversation(e){Tu.a.key("cache_conversation_deletion").boolean&&e&&(this.isReady?(delete this.data[e],this.runTimeoutSaveCache()):this.removeTempArr.push(e))}runTimeoutSaveCache(){this.timeoutSaveCache||(this.timeoutSaveCache=setTimeout((()=>{this.timeoutSaveCache=null;try{this.storage.setItemForCurrentUserAsync(al,JSON.stringify(this.data))}catch(t){var e;null===(e=zu.error)||void 0===e||e.call(zu,sl,"Save conversation deletion cache fail"),zu.zlog.zsymb(18,"JVgGA-",`${sl} Save conversation deletion cache fail`)}}),0))}})||Wu)||Wu)||Wu;i.ModuleContainer.registerSingleton(jo.ConversationDeletionCache,$u);var Ku,qu=s("ezRR"),Qu=s("3AlX"),Zu=s("yXlY"),Ju=s("jDFw"),Yu=s("mlG1"),Xu=s("ZCU6"),eh=s("9Cxg"),th=s("2gQH"),sh=s("JsDs"),ih=s("u8fi"),nh=s("JprO"),ah=s("UQla"),rh=s("vDlm"),oh=s("V0Mo");let lh;ji.l||(lh=s("Dprd").default);let ch=Object(qu.c)()(Ku=Object(i.injectable)()(Ku=function(e,t){return Object(i.inject)(jo.ConvInfoDataManager)(e,void 0,0)}(Ku=function(e,t){return Object(i.inject)(jo.PreviewDataManager)(e,void 0,1)}(Ku=function(e,t){return Object(i.inject)(jo.ConversationOperation)(e,void 0,2)}(Ku=function(e,t){return Object(i.inject)(jo.ConversationDeletionCache)(e,void 0,3)}(Ku=Reflect.metadata("design:type",Function)(Ku=Reflect.metadata("design:paramtypes",[void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager,void 0===jo.PreviewDataManager?Object:jo.PreviewDataManager,void 0===jo.ConversationOperation?Object:jo.ConversationOperation,void 0===jo.ConversationDeletionCache?Object:jo.ConversationDeletionCache])(Ku=class extends qu.b{constructor(e,t,s,i){super(),this.convInfoDataManager=e,this.previewDataManager=t,this.conversationOperation=s,this.conversationDeletionCache=i,this.database=void 0,this.deleteMediaManager=void 0,this.database=tt.default.getInstance(),this.deleteMediaManager=new Zu.a}start(){this.addEventListeners()}running(){const e=()=>{Tu.a.key("enable").boolean&&this.conversationDeletionCache.init((()=>{this.conversationDeletionCache.getDeletedConversations().forEach((e=>{Yu.d.setDeleteConversation(e)}))}))};e();const t=()=>{e(),Tu.a.remove(t)};Tu.a.add(t)}getConversationResources(e){return new Promise((async(t,s)=>{try{var n;if(!Tu.a.isStaging)return t(void 0);const s={},a=await this.convInfoDataManager.getConvById(e),r=await this.previewDataManager.getPreviewById(e);s.convInfo=a,s.previewInfo=r;const o=i.ModuleContainer.resolve(jo.PinDataManager).isPinned(e);s.isPinned=o;const l={from:[e,"",""],to:[e,(null==r?void 0:r.messageTime)||"",(null==r?void 0:r.msgId)||""],excludeFrom:!1,excludeTo:!1},c={index:"userId_sendDttm_msgId",direction:Le.c.PREV,partition:e,useLGKeyRange:!0},d=await this.database.Core.Message.getAll(l,c);s.msgNum=d.length,s.messageTypes={},s.media={};let u=0,h=0,g=0,m=0,p=0,f=0,v=0,b=0;for(let e=0;e<d.length;e++){d[e].staredDttm&&u++;const t=parseInt(d[e].msgId);if(!isNaN(t)){await this.database.Core.Mention.get(t)&&h++}d[e].msgType===R.MSG_FILE&&g++,d[e].msgType!==R.MSG_PHOTO&&d[e].msgType!==R.MSG_PHOTO_2&&d[e].msgType!==R.MSG_DOODLE||m++,d[e].msgType===R.MSG_GIF&&p++,d[e].msgType===R.MSG_VIDEO&&f++,d[e].msgType===R.MSG_CONTACT&&"object"==typeof d[e].message&&"recommened.link"===d[e].message.action&&v++,d[e].msgType===R.MSG_VOICE&&b++}s.starMsgNum=u,s.mentionMsgNum=h,s.messageTypes.fileMsgNum=g,s.messageTypes.imageMsgNum=m,s.messageTypes.gifMsgNum=p,s.messageTypes.videoMsgNum=f,s.messageTypes.linkMsgNum=v,s.messageTypes.audioMsgNum=b;const I=ul.a.getInstance(),y=await I.getMessageOfConversation([],e);if(s.searchMsgNum=y.len||0,mi.default.change_media_db.should_use_new_media_db_flow){const t={from:[e,"",""],to:[e,"",""],excludeFrom:!1,excludeTo:!1},i={index:"convId_sendDttm_cliMsgId",direction:Le.c.PREV,partition:e},n=await this.database.Media.File.getAllKey(t,i),a=await this.database.Media.Image.getAllKey(t,i),r=await this.database.Media.Link.getAllKey(t,i);s.media.fileMsgNum=n.length,s.media.imageAndVideoMsgNum=a.length,s.media.linkMsgNum=r.length}else{const t={from:[e,"",""],to:[e,"",""],excludeFrom:!1,excludeTo:!1},i={index:"userId_sendDttm_msgId",direction:Le.c.PREV,partition:e},n=await this.database.Core.File.getAllKey(t,i),a=await this.database.Core.Image.getAllKey(t,i),r=await this.database.Core.Link.getAllKey(t,i);s.media.fileMsgNum=n.length,s.media.imageAndVideoMsgNum=a.length,s.media.linkMsgNum=r.length}null===(n=zu.info)||void 0===n||n.call(zu,tl,`${e} Conversation resources`,s),t(s)}catch(r){var a;null===(a=zu.error)||void 0===a||a.call(zu,tl,`${e} Error when getting conversation resources`,r),s(r)}}))}addEventListeners(){this.conversationOperation.addEventListener(wu.c.BeforeDeleteConversation,(e=>{var t,s,i,n;const a=null===(t=e.payload)||void 0===t?void 0:t.data;if(!a)return;const r=null===(s=e.payload)||void 0===s||null===(i=s.data)||void 0===i?void 0:i.convId;r&&Ju.a.clearCache(r);const o={msgId:a.msgId,conversationId:a.convId,isLeaveGroup:a.isLeaveGroup,deleteAllPrior:!0,sendDttm:a.deleteTime,clientMsgId:a.cliMsgId,fromUid:a.fromUid};Yu.d.setDeleteConversation(o),null===(n=Ld.b.messageCache)||void 0===n||n.deleteMessageBefore(o)})),this.conversationOperation.addEventListener(wu.c.AfterDeleteConversation,(e=>{var t;const s=null===(t=e.payload)||void 0===t?void 0:t.data;if(s&&(s.convId&&(i.ModuleContainer.resolve(jo.PinDataManager).isPinned(s.convId)&&i.ModuleContainer.resolve(jo.PinDataManager).unpin([s.convId]),ji.l||i.ModuleContainer.resolve(ih.a).removeConvToList(s.convId)),this.deleteConversationInMediaStore(s),s.isLeaveGroup)){Xu.b.getInstance().removeCloudSegmentByConvId(s.convId)}})),this.conversationOperation.addEventListener(wu.c.BeforeDeleteBatchMessages,(e=>{})),this.conversationOperation.addEventListener(wu.c.AfterDeleteBatchMessages,(e=>{var t,s;const i=null===(t=e.payload)||void 0===t?void 0:t.data,n=null===(s=e.payload)||void 0===s?void 0:s.messages;i&&i.convId&&n&&this.cleanResourcesOfMessages(i.convId,n,i.isDeleteResource)})),this.conversationOperation.addEventListener(wu.c.BeforeDeleteMessage,(e=>{var t,s,i;const n=null===(t=e.payload)||void 0===t?void 0:t.data,a=null===(s=e.payload)||void 0===s?void 0:s.messages;if(!n||!n.convId||!a)return;const r=oh.b.getZQuoteBannerDataById(n.convId);var o;r&&null!==(i=r.quote)&&void 0!==i&&i.msgId&&r.quote.msgId===n.msgId&&(null===(o=r._clear)||void 0===o||o.call(r));const l={msgId:n.msgId,conversationId:n.convId,isLeaveGroup:n.isLeaveGroup,deleteAllPrior:!0,sendDttm:n.deleteTime,clientMsgId:n.cliMsgId,fromUid:n.fromUid,toUid:n.toUid};switch(Ju.a.clearCache(n.convId),n.type){case"only-me":Yu.d.setDeleteMessage(l);break;case"everyone":Yu.d.setDeleteEveryoneCache(l);break;case"recall":Yu.d.setRecallMessage(l)}})),this.conversationOperation.addEventListener(wu.c.AfterDeleteMessage,(e=>{var t,s;const i=null===(t=e.payload)||void 0===t?void 0:t.data,n=null===(s=e.payload)||void 0===s?void 0:s.messages;i&&i.convId&&n&&(this.cleanResourcesOfMessages(i.convId,n,i.isDeleteResource),this.deleteMessageInMediaStore(i.convId,n[0]),this.cleanReplyMessages(i,n[0]),i.convId&&i.msgId)}))}cleanResourcesOfMessages(e,t,s){var i;if(!t.length)return;const n=`${e} Clean resources of messages ${t.length}`;null===(i=zu.info)||void 0===i||i.call(zu,tl,n),zu.zlog.zsymb(0,"54jIGv",n);const a={ids:[],pendingIds:[]},r=[],o=[];t.forEach((e=>{var t;s&&this.deleteMediaManager.deleteLocalRes(e),!ji.l&&nh.default.abortByMsg(Object(f.a)({},e)),null===(t=Rt.default.cbMessageToMsgThread)||void 0===t||t.call(Rt.default,"delete",e);let i=e.msgType;if(i=Object(rh.a)(i,e),ah.c.includes(i)){const t=Object(rh.b)(e);r.push(t)}if(e&&e.status===R.MSG_LOCAL&&e.cliMsgId){const t={code:Qu.a.DeleteConversationHasSendingMsg,message:"Delete conversation has sending message"};Qu.b.cancel(+e.cliMsgId,t)||e.msgType!==R.MSG_FILE||(rt.p.setHasCancelledSending(e.cliMsgId),Yl.a.cancelUpload(e.cliMsgId))}if(e.msgType===R.MSG_FILE&&e.message&&e.message.href){var n,l;const t=null===(n=lh)||void 0===n?void 0:n.getDownloadKey(e);null===(l=lh)||void 0===l||l.cancelDownload(t)}if(e.staredDttm){const t=Rt.default.getTsStarMsgSchemaChanged();e.staredDttm&&e.staredDttm>=t?a.ids.push(e.msgId):a.pendingIds.push(e.msgId)}e&&e.msgType==R.MSG_ZINSTANT&&Rs.b.removeFileFromMessage(e,Rt.default.getUserId()),o.push(e.msgId)}));ul.a.getInstance().deleteMessages(t),r.length>0&&this.database.Res.Meta.deleteMulti(r),th.a.increaseNumberOfMessages(-t.length);const l=this.database.Core.Mention;o.length>0&&l.deleteMulti(o),Ud.b.deleteReactions(t.map((e=>e.msgId)));const c=this.database.Core.StarMessage;a.pendingIds.forEach((async(e,t)=>{try{await c.get(e)||(a.pendingIds[t]=parseInt(e))}catch(s){}})),c.deleteMulti([...a.ids,...a.pendingIds],{partition:e})}deleteConversationInMediaStore(e){var t;if(!e.convId){var s;const e=new Ru({code:"RESOURCE_ERROR",message:"Delete conversation media store failed: conversationId is not provided"});return void(null===(s=zu.error)||void 0===s||s.call(zu,tl,e))}const n=this.canDeleteMediaStore(e.convId),a=`${e.convId} Delete conversation media store ${mi.default.change_media_db.should_use_new_media_db_flow} ${n}`;if(null===(t=zu.info)||void 0===t||t.call(zu,tl,a),zu.zlog.zsymb(0,"ioHna5",a),n)if(mi.default.change_media_db.should_use_new_media_db_flow){i.ModuleContainer.resolve(Ui.a).emptyMediaStores(e.convId,["image","file","link"])}else sh.a.runCleanUpMedia({conversationId:e.convId,msgId:e.msgId,sendDttm:e.deleteTime,clientMsgId:e.cliMsgId,ignoreDeleteRes:!0},"del-conv")}deleteMessageInMediaStore(e,t){var s;const n=this.canDeleteMediaStore(e),a=`${t.msgId} Delete message media store ${mi.default.change_media_db.should_use_new_media_db_flow} ${n}`;if(null===(s=zu.info)||void 0===s||s.call(zu,tl,a),zu.zlog.zsymb(0,"Axg1xE",a),n)if(mi.default.change_media_db.should_use_new_media_db_flow){if(!t.toUid)return;const e=t.toUid,s=s=>{var n;null===(n=i.ModuleContainer.resolve(Ui.a))||void 0===n||n.deleteMediasById(s,e,{newId:`${t.cliMsgId}_${t.fromUid}_${e}`,oldId:t.msgId})};Object(eh.isPhotoOrVideoMessage)(t)&&s("image"),Object(eh.isFileMessage)(t)&&s("file"),Object(eh.isLinkMessage)(t)&&s("link")}else{const e=[this.database.Core.File,this.database.Core.Image,this.database.Core.Link,this.database.Core.Notifications];for(let s=0;s<e.length;s++)e[s].delete(t.msgId)}}async cleanReplyMessages(e,t){try{const s=Rt.default.getUserId(),i={index:"userId_sendDttm_msgId",limit:500,direction:Le.c.NEXT,predicate:e=>function(e,t,s){if(!(e&&t&&t.quote&&s))return!1;if(t.quote.cliMsgType===R.MSG_DEL_EVERYONE)return!1;if(t.quote.cliMsgType===R.MSG_UNDO)return!1;const i="0"==s.fromUid?e:s.fromUid;return!(!t.quote.globalMsgId||!t.quote.cliMsgId||t.quote.globalMsgId.toString()!=s.msgId||t.quote.cliMsgId!=s.cliMsgId||i!=t.quote.ownerId)||t.quote.cliMsgId==s.cliMsgId&&i==t.quote.ownerId&&t.toUid===s.toUid}(s,e,t),partition:e.convId,useLGKeyRange:!0},n={from:[e.convId+"",t.sendDttm+"",t.msgId+""],to:[e.convId+"",nl,il],excludeFrom:!1,excludeTo:!1},a=await this.database.Core.Message.getAll(n,i);if(!a.length)return;const r=[];for(let t=0;t<a.length;t++){const s=a[t];s.quote&&("everyone"===e.type?(s.quote.cliMsgType=R.MSG_DEL_EVERYONE,s.quote.msg="[Tin nhắn đã bị xóa]"):"recall"===e.type&&(s.quote.cliMsgType=R.MSG_UNDO,s.quote.msg="[Tin nhắn đã được thu hồi]"),r.push(s))}r.length&&await this.database.Core.Message.insertMulti(r,{replace:!0})}catch(s){}}canDeleteMediaStore(e){return!Nu(e)||!mi.default.media_settings.media_cloud}})||Ku)||Ku)||Ku)||Ku)||Ku)||Ku)||Ku)||Ku;i.ModuleContainer.registerSingleton(jo.ConversationResources,ch),i.ModuleContainer.registerSingleton(cc.b,pc),i.ModuleContainer.registerSingleton(Gc.b,Zc),i.ModuleContainer.registerSingleton(cc.a,gc),i.ModuleContainer.registerSingleton(dc.a,class{constructor(){this.name=void 0,this.key=void 0,this.dependencies={},this.name="conv-notification-controller",this.key=this.name,this.dependencies=new Proxy({},{get:async(e,t)=>e[t]?await e[t]():Promise.resolve(void 0),set:(e,t,s)=>(e[t]=s,!0)}),this._registerResolvers({friendsManager:()=>Promise.resolve().then(s.bind(null,"UiPd")).then((e=>e.default)),convListUtils:()=>Promise.resolve().then(s.bind(null,"RojW")).then((e=>e.ConvList)),convListController:()=>Promise.resolve(i.ModuleContainer.resolve(io.b))})}async checkIfConvCanNotify(e,t){try{return await this._checkIfConvCanNotify(e,t)}catch(s){return!1}}registerResolvers(e){return this._registerResolvers(e)}async _checkIfConvCanNotify(e,t){if(Object(Yc.a)(e))return!0;let s=await this._getModule("friendsManager",t);if(await s.isOA(e)){let s=await this._getModule("convListUtils",t);if(!(await s.checkIfOAShouldShowInConvList(e))){return!!(await this._getModule("convListController",t)).isChatVisible(e)}return!0}return!0}async _getModule(e,t){return t&&t[e]?await t[e]():await this.dependencies[e]}_registerResolvers(e){for(const[t,s]of Object.entries(e))this.dependencies[t]=s}}),i.ModuleContainer.registerSingleton(ed.a,Xc);var dh,uh=s("Xvw2"),hh=s("5uwv"),gh=s("lCn6"),mh=s("kg13"),ph=s("dJFb");const fh=2,vh={userId:"",friendRequestType:fh,friendRequestSource:85};var bh=function(e){return e.SUGGEST="suggest",e.REQUEST="request",e.UNREADREQ="unread-req",e}(bh||{});Object(ko.b)(uh.b)(dh=Reflect.metadata("design:type",Function)(dh=Reflect.metadata("design:paramtypes",[])(dh=class extends Fe.b{constructor(){super(),this.sugguestList=void 0,this.requestList=void 0,this.unreadFRList=void 0,this._ebFriendRequestSend=e=>{const t=this.unreadFRList.filter((t=>t!==e));t.length!==this.unreadFRList.length&&(Rt.default.changeFriendsToStranger(e),ho.default.logCoreError("[reddot-check] SEND_FRIEND_REQUEST: "+JSON.stringify(e)),this.unreadFRList=t,Object(hs.j)(this.name,bh.UNREADREQ))},this._ebFriendFetch=e=>{for(let t in e)if(e.hasOwnProperty(t)){const e=this.requestList.slice();for(let s=0;s<e.length;s++)if(e[s]===t){e.splice(s,1);break}e.length!==this.requestList.length&&(this.requestList=e,Object(hs.j)(this.name,bh.REQUEST))}},this._ebFrReqFetch=e=>{ho.default.log("friendNotificationAction: friend requests fetched",e);const t=this.requestList.reduce(((e,t)=>(e[t]||(e[t]=!0),e)),{}),s=this.requestList.slice();for(let i of e)t[i.userId]||s.unshift(i);this.requestList=s,Object(hs.j)(this.name,bh.REQUEST)},this._ebFrReqRemove=e=>{ho.default.log("friendNotificationAction: friend requests removed",e);const t=this.requestList.filter((t=>-1===e.indexOf(t)));t.length!==this.requestList.length&&(this.requestList=t,Object(hs.j)(this.name,bh.REQUEST)),this.onFriendListNotificationsChange({action:"remove",ids:e})},this.name=uh.a,this.data=new Map,this.key="userId",this.sugguestList=[],this.requestList=[],this.unreadFRList=[],this.listenEvents()}listenEvents(){Fi.default.subscribe(((e,t)=>{switch(e){case Ai.ChatBoxActions.SEND_FRIEND_REQUEST:this._ebFriendRequestSend(t);break;case Ai.FetchActions.FRIENDS_FETCHED:this._ebFriendFetch(t);break;case Ai.FetchActions.FRIEND_REQUESTS_FETCHED:this._ebFrReqFetch(t);break;case Ai.FetchActions.FRIEND_REQUESTS_REMOVED:this._ebFrReqRemove(t)}}))}onAddFriend(e){mh.a.removeSuggest(e.userId),this.onFriendListNotificationsChange({action:"remove",ids:[e.userId]})}onReceiveFriendRequests(e){if(!e||e.length<1)return;for(let s=0;s<e.length;s++){let t=e[s];t&&mh.a.removeSuggest(t.userId)}ph.d.setUnreadRequest(1);for(let s=0;s<e.length;s++)e[s]&&rt.p.addNewFriendItem(e[s].userId);Co.a.UnreadDataManager.updateUnreadCount(R.FAKE_CONVERSATION_ID.FRIEND_CENTER,ph.d.getUnreadRequest());let t=e.map((e=>({dataInfo:Object(f.a)(Object(f.a)({},e),{},{recommInfo:{message:e.friendRequestMsg,source:e.friendRequestSource},recommType:fh}),recommItemType:e.friendRequestType})));mh.a.addRequest(t),this.broadcastEvent(hh.b.ReceiveRequest,"",{uids:e.map((e=>e.userId))})}onRemoveSuggest(e,t,s){return mh.a.removeSuggestFriend(e,t,s).then((t=>{this.broadcastEvent(hh.b.RemoveSuggest,e)}))}onPromoteFriends(){Co.a.UnreadDataManager.updateUnreadCount(R.FAKE_CONVERSATION_ID.FRIEND_CENTER,1)}onFriendRequestFetched(){}onFriendListNotificationsChange(e){if(!e.ids||!e.ids.length)return void("clear"===e.action&&(this.unreadFRList=[],Object(hs.j)(this.name,bh.UNREADREQ)));let t=this.unreadFRList;if("remove"===e.action)t=t.filter((t=>-1===e.ids.indexOf(t)));else if("add"===e.action){const s=[];for(let i of e.ids)-1===t.indexOf(i)&&s.push(i);s.length&&(t=t.concat(s))}t.length!==this.unreadFRList.length&&(this.unreadFRList=t,Object(hs.j)(this.name,bh.UNREADREQ))}acceptFriendRequest(e,t=Go.c){return new Promise(((s,i)=>{const n=this.data.get(e);if(!n)return Li.a.acceptAddFriend(e,t).then((i=>{ss.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch(i);let a;if(n.friendRequestType===R.FRIEND_REQUEST_TYPE_SUGGEST){if(n.requested)return a=104097,as.default.logAction(a),s(!1);const r=os.a.trans("STR_MSG_DEFAULT_REQ_ADD_FR",ns.default.getMiniProfileMe().zaloName);Li.a.requestAddFriend(e,r,n.friendRequestSource,t).then((()=>{ss.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),Rt.default.changeFriendsToStranger(e),mh.a.removeSuggest(e);const i=Object(f.a)(Object(f.a)({},n),{},{requested:!0});this.broadcastEvent(hh.b.SentFriendReq,e),this.data.set(e,i),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),a=104096}else Li.a.acceptAddFriend(e,t).then((()=>{this.data.delete(e),Object(hs.f)(this.name,e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),this.broadcastEvent(hh.b.AcceptRequest,e),gh.a.getUser(e).then((t=>{Fi.default.send(Ai.FetchActions.FRIENDS_FETCHED,{[e]:Object(f.a)(Object(f.a)({},ho.default.reformatConversationFromFriend(t)),{},{isFr:1})})})),Rt.default.getAcceptNewFriend(n),ss.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),a=104095;a&&as.default.logAction(a)}))}async rejectFriendRequest(e){const t=this.data.get(e),s=()=>{rs.default.createSuccess(os.a.str("STR_TOAST_REJECT_REQUEST")),Rt.default.changeFriendsToStranger(e),mh.a.removeSuggest(e),this.broadcastEvent(hh.b.RejectRequest,e)},i=e=>{ho.default.logCoreError(e),e&&e.error_message&&rs.default.createError(e.error_message)};t&&t.friendRequestSource?uo.default.removeRecommendedFriend(e,t.friendRequestSource).then(s).catch(i):Li.a.rejectRequestAddFriend(e).then(s).catch(i),this.data.delete(e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),as.default.logAction(104094)}undoRequestFriend(e){e&&Li.a.undoRequestAddFriend(e).catch((e=>{e.error_message&&rs.default.createError(e.error_message)}))}clearUnreadFriendRequest(){Co.a.UnreadDataManager.updateUnreadCount(R.FAKE_CONVERSATION_ID.FRIEND_CENTER,0),this.unreadFRList=[],Object(hs.j)(this.name,bh.UNREADREQ)}getAllFriendRequests(){return new Promise(((e,t)=>{const s=mh.a.getRecommendedFriendsV2(!1,!1);if(!s)return e({});e(this.filterFriendRequest(s))}))}getAllFriendRequestsSync(){const e=mh.a.getRecommendedFriendsSync();return e?this.filterFriendRequest(e):{}}init(){Rt.default.getFriends(null,!0).then((e=>{if(e){const t=Rt.default.getLastContactListOpenTime(),s=e.filter((e=>e&&e.friendRequestFetchTime>t)).map((e=>e.userId));s.length&&this.onFriendListNotificationsChange({action:"add",ids:s})}}))}getItem(e){return vh}getList(e){return e.key===bh.UNREADREQ?this.unreadFRList:[]}onGetItemFailure(e){}onGetListFailure(e){}handleFailureFriendRq(e){if(ho.default.logCoreError(e),e&&e.error_message){let t=e.error_message;[224,251].includes(e.error_code)&&(t=os.a.trans(`STR_FRIEND_REQUEST_FAIL_${e.error_code}`,[""+mi.default.limitFriends])),rs.default.createMessage(t,3e3)}}filterFriendRequest(e){const t={};for(let s in e)if(e.hasOwnProperty(s)){let i=e[s];i&&i.dataInfo.recommType===fh&&(t[s]=i,t[s].friendRequestType=i.dataInfo.recommType)}return t}broadcastEvent(e,t,s){this.dispatchEvent(new hh.a(e,t,s)),this.dispatchEvent(new hh.a(hh.b.FriendCenterChange,t,Object(f.a)(Object(f.a)({},s),{},{act:e})))}})||dh)||dh);var Ih,yh=s("5cla"),_h=s("WV6O"),Ch=s("8JBC");const Oh={currentView:_h.j.FRIEND_LIST,unread:{newFriendRequests:[],newGroupRequests:[],newGroupInvitations:new Set,isUnread:!1}};Object(ko.b)(yh.b)(Ih=Reflect.metadata("design:type",Function)(Ih=Reflect.metadata("design:paramtypes",[])(Ih=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.currentTab=void 0,this.data=new Map,this._Logger=void 0,this.name=yh.a,this.key=yh.a,this.data.set(Go.c,Oh),this.currentTab=""}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_updateState(e,t=Go.c,s=!0){this.data.set(t,e),s&&Object(hs.h)(this.name,t)}_getState(e=Go.c){return this.data.get(e)}_getAccessTime(){try{return JSON.parse(E.default.getInstance().getItemForCurrentUser(_h.g))}catch(e){return this.Logger.zsymb(18,"kE-LGJ","[_getAccessTime], error: "+JSON.stringify(e)),null}}_setAccessTime(e){E.default.getInstance().setItemForCurrentUser(_h.g,JSON.stringify(e))}_setLastRequestFriendTime(e,t,s){let i=[];try{i=JSON.parse(E.default.getInstance().getItemForCurrentUser(_h.i))||[]}catch(a){this.Logger.zsymb(18,"eeodHi","[_setLastRequestFriendTime], error: "+JSON.stringify(a))}let n=[];switch(e){case"NEW":i.find((e=>(null==e?void 0:e.userId)===s))?(n=i.filter((e=>e.userId!==s)),n=[{ts:t,userId:s},...i]):n=[{ts:t,userId:s},...i];break;case"REMOVE":n=i.filter((e=>e.userId!==s))}E.default.getInstance().setItemForCurrentUser(_h.i,JSON.stringify(n))}_setLastReceivedGroupInvitationTime(e,t,s){let i=[];try{const e=E.default.getInstance().getItemForCurrentUser(_h.h);i=e&&JSON.parse(e)||[]}catch(a){this.Logger.zsymb(18,"bYySrS","[_setListReceivedGroupInvitationTime], error: "+JSON.stringify(a))}let n=[];switch(e){case"NEW":i.some((e=>(null==e?void 0:e.groupId)==s))&&(n=i.filter((e=>e.groupId!=s))),n=[{ts:t,groupId:s},...i];break;case"REMOVE":n=i.filter((e=>(null==e?void 0:e.groupId)!==s))}E.default.getInstance().setItemForCurrentUser(_h.h,JSON.stringify(n))}_getLastRequestAddFriendTime(){let e;try{e=JSON.parse(E.default.getInstance().getItemForCurrentUser(_h.i))}catch(t){this.Logger.zsymb(18,"8PclSx","[_getLastRequestAddFriendTime], error: "+JSON.stringify(t))}return e?e[0]:null}_getLastReceivedGroupInvitationTime(){let e;try{const t=E.default.getInstance().getItemForCurrentUser(_h.h);e=t?JSON.parse(t):null}catch(t){this.Logger.zsymb(18,"bhJi0U","[_getLastReceivedGroupInvitationTime], error: "+JSON.stringify(t))}return e?e[0]:null}_onChangeView(e){switch(i.ModuleContainer.resolve(No.SidebarController).updateSelectedId(null),e){case _h.j.FRIEND_LIST:Object($t.f)({type:Ai.SideBarActions.SELECT_FRIEND_LIST,payload:{userId:"999"}});break;case _h.j.GROUP_LIST:Object($t.f)({type:Ai.SideBarActions.SELECT_GROUP_CENTER,payload:{userId:"999"}});break;case _h.j.FRIEND_REQUEST:Object($t.f)({type:Ai.SideBarActions.SELECT_FRIEND_CENTER,payload:{userId:"999"}});break;case _h.j.GROUP_INVITATION:Object($t.f)({type:Ai.SideBarActions.SELECT_GROUP_INVITATION_CENTER,payload:{userId:"999"}})}}_onUpdateUnreadRequest(e,t){const s=this._getState();if(!s)return;let i=s.unread;switch(t){case"FRIEND":s.currentView!==_h.j.FRIEND_REQUEST&&(i.newFriendRequests.push(e),i.isUnread=!0);break;case"GROUP":i.newGroupRequests.push(e);break;case"GROUP_INV":mi.default.group_privacy.invitation_box.enable&&s.currentView!==_h.j.GROUP_INVITATION&&(i.newGroupInvitations.add(e),i.isUnread=!0)}this._updateState(Object(f.a)(Object(f.a)({},s),{},{unread:i}),Go.c,!0)}_clearUnreadOnOpenView(){const e=this._getState();if(!e)return;let t=e.unread;if(e.currentView===_h.j.GROUP_INVITATION){t.newGroupInvitations.size>0&&(t.isUnread=!1),t.newGroupInvitations.clear();const e=this._getLastReceivedGroupInvitationTime();e&&E.default.getInstance().setItemForCurrentUser(_h.h,JSON.stringify([e]))}else t.newFriendRequests.length+t.newGroupRequests.length>0&&(t.isUnread=!1),t.newFriendRequests=[],t.newGroupRequests=[];this._updateState(Object(f.a)(Object(f.a)({},e),{},{unread:t}),Go.c,!0)}_clearGroupInvitationUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newGroupInvitations.delete(e);0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(f.a)(Object(f.a)({},t),{},{unread:s}),Go.c,!0)}_clearFriendRequestUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newFriendRequests=s.newFriendRequests.filter((t=>t!==e));0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(f.a)(Object(f.a)({},t),{},{unread:s}),Go.c,!0)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetTabData(){this.currentTab="",Ch.a.resetNewFriendList(),i.ModuleContainer.resolve(yh.b).resetData(),i.ModuleContainer.resolve(yh.g).resetData(),i.ModuleContainer.resolve(yh.f).resetData(),i.ModuleContainer.resolve(yh.l).resetData(),i.ModuleContainer.resolve(yh.j).resetData(),i.ModuleContainer.resolve(yh.o).resetData()}resetData(){const e=this._getState();e&&this._updateState(Object(f.a)(Object(f.a)({},e),{},{currentView:_h.j.FRIEND_LIST}))}changeView(e){const t=this._getState();t&&this._updateState(Object(f.a)(Object(f.a)({},t),{},{currentView:e}),Go.c,!0),this.currentTab=e,this._onChangeView(e)}onClickContabTabEntry(){if(document.getElementById("ContactTabV2")){const e=this._getState(),t=(null==e?void 0:e.currentView)||Oh.currentView;this._onChangeView(t)}}onContactTab(e){i.ModuleContainer.resolve(yh.c).onOpenContactTab(e),this._setAccessTime(e),this._clearUnreadOnOpenView()}getDefaultView(){if(this.currentTab)return this.currentTab;const e=this._getAccessTime(),t=this._getLastRequestAddFriendTime(),s=this._getLastReceivedGroupInvitationTime();if(!t)return mi.default.group_privacy.invitation_box.enable&&s&&s.ts>=yn.default.getTimeNow()-mi.default.group_privacy.invitation_box.max_auto_focus_time?this.currentTab=_h.j.GROUP_INVITATION:this.currentTab=_h.j.FRIEND_LIST,this.currentTab;const i=!mi.default.contactTabV2.enable_rule_last_view_friend_req||e&&t.ts<e,n=t.ts<yn.default.getTimeNow()-864e5;return mi.default.group_privacy.invitation_box.enable&&s&&s.ts>t.ts&&s.ts>=yn.default.getTimeNow()-mi.default.group_privacy.invitation_box.max_auto_focus_time?(this.currentTab=_h.j.GROUP_INVITATION,this.currentTab):(this.currentTab=n&&i?_h.j.FRIEND_LIST:_h.j.FRIEND_REQUEST,this.currentTab)}getState(e){return this._getState(e)||Oh}clearFriendRequestUnread(e){const t=this._getState();if(e.length>0&&t){const s=new Set(e),i=t.unread,n=i.newFriendRequests.filter((e=>!s.has(e)));n.length!==i.newFriendRequests.length&&(i.newFriendRequests=n,i.isUnread=i.newFriendRequests.length>0||i.newGroupInvitations.size>0,this._updateState(Object(f.a)(Object(f.a)({},t),{},{unread:i}),Go.c,!0))}for(const s of e)this._setLastRequestFriendTime("REMOVE",0,s)}clearGroupInvitationUnread(e){const t=this._getState();if(e.length>0&&t){const s=t.unread,i=new Set(s.newGroupInvitations.values());e.forEach((e=>i.delete(e))),i.size!==s.newGroupInvitations.size&&(s.newGroupInvitations=i,s.isUnread=s.newFriendRequests.length>0||s.newGroupInvitations.size>0,this._updateState(Object(f.a)(Object(f.a)({},t),{},{unread:s}),Go.c,!0))}for(const s of e)this._setLastReceivedGroupInvitationTime("REMOVE",0,s)}onUpdateRequestTracking(e,t,s,i){switch("NEW"===t?this._onUpdateUnreadRequest(i,e):"REMOVE"===t&&(mi.default.group_privacy.invitation_box.enable&&"GROUP_INV"===e&&i?this._clearGroupInvitationUnreadItem(i):this._clearFriendRequestUnreadItem(i)),e){case"FRIEND":this._setLastRequestFriendTime(t,s||0,i);break;case"GROUP":default:break;case"GROUP_INV":mi.default.group_privacy.invitation_box.enable&&this._setLastReceivedGroupInvitationTime(t,s||0,i)}}computeUpdateUnread(){const e=this._getState();let t=(null==e?void 0:e.unread)||Oh.unread;const s=(null==e?void 0:e.currentView)||Oh.currentView,i=this._getAccessTime(),n=this._getLastRequestAddFriendTime(),a=this._getLastReceivedGroupInvitationTime();i&&(n&&i<n.ts&&t.newFriendRequests.push(n.userId),mi.default.group_privacy.invitation_box.enable&&a&&i<a.ts&&t.newGroupInvitations.add(a.groupId),t.isUnread=t.newFriendRequests.length>0||t.newGroupInvitations.size>0,this._updateState({currentView:s,unread:t},Go.c,!0))}onInitUnreadRequest(){this.computeUpdateUnread()}onReceivedControlEvents(e){for(const t of e)if(t.act===_h.a.CLICKED)t.data.ts_clicked&&(this._setAccessTime(t.data.ts_clicked),this._clearUnreadOnOpenView());else this.Logger.zsymb(18,"V56FFZ","unhandled event",t)}})||Ih)||Ih);var Eh,Mh=s("iq5K"),Sh=s("d++c");Object(ko.b)(yh.g)(Eh=Object(i.injectable)()(Eh=function(e,t){return i.ModuleContainer.inject(yh.f)(e,void 0,0)}(Eh=function(e,t){return i.ModuleContainer.inject(No.LabelDataManager)(e,void 0,1)}(Eh=Reflect.metadata("design:type",Function)(Eh=Reflect.metadata("design:paramtypes",[void 0===yh.f?Object:yh.f,void 0===No.LabelDataManager?Object:No.LabelDataManager])(Eh=class{constructor(e,t){this.friendInfoManager=e,this.labelDataManager=t,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listFriend=void 0,this.initListFriend=void 0,this.currentPage=void 0,this.didSort=void 0,this.eventBusInstance=void 0,this._Logger=void 0,this.name=yh.e,this.key=yh.e,this.listState=Mh.d,this.listFriend=[],this.initListFriend=[],this.currentPage=1,this.didSort=!1,this.eventBusInstance=null,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(hs.j)(this.name,"all")}_signalRenderItem(){Object(hs.h)(this.name,"all")}_signalRenderBoth(){Object(hs.h)(this.name,"all"),Object(hs.j)(this.name,"all")}_onRemoveFriend(e){this.listFriend.includes(e.userId)&&(this.listFriend.splice(this.listFriend.indexOf(e.userId),1),this.initListFriend.splice(this.initListFriend.indexOf(e.userId),1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth())}_onAddFriend(e){this.listFriend.includes(e.userId)||(this.listFriend.unshift(e.userId),this.initListFriend.unshift(e.userId),Ch.a.addNewFriendUid(e.userId),this._signalRenderList())}_getItemInfo(e){return this.friendInfoManager.getItem({key:e,version:1,extraData:null},null)||this.friendInfoManager.loadInfoNotRender({userId:e})}_onBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onUnBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onEditAlias(e){this.friendInfoManager.onLoadInfo({userId:e.userId}),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!this.isDidSort(),!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((i=>{if(this.friendInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listFriend.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listFriend.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listFriend.push(i),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1,!1),this.listState.totalRecord=this.listFriend.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.friendInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}addComponentListeners(){ns.default.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),ns.default.subscribeEventFriend(R.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),ns.default.subscribeEventFriend(R.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),ns.default.subscribeEventFriend(R.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance=Fi.default.on(Ai.FetchActions.UPDATE_NAME,this._onEditAlias.bind(this)),this.labelDataManager.addEventListener(No.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(No.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(No.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){ns.default.unsubscribeEventFriend(R.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),ns.default.unsubscribeEventFriend(R.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),ns.default.unsubscribeEventFriend(R.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),ns.default.unsubscribeEventFriend(R.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance&&this.eventBusInstance.remove(),this.labelDataManager.removeEventListener(No.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(No.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(No.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}async onLoadList(e){try{const t=await Ch.a.getFriendList(e);this.listFriend=t,this.initListFriend=t,this.listState.totalRecord=t.length,this.listFriend=this._handleFilter(Mh.g.searching.searchText,Mh.g.searching.sorter,Mh.g.searching.filter,!0,!1),this.initListFriend=this._handleFilter(Mh.g.searching.searchText,Mh.g.searching.sorter,Mh.g.searching.filter,!0,!0),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}catch(t){this.Logger.zsymb(18,"8wfRGM","[FriendListController] -> [onLoadList], error: "+JSON.stringify(t))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListFriend];return[...this.initListFriend].filter((t=>{const s=this._getItemInfo(t);return Object(Sh.a)((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterAll(e){return e}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!xo.a.isThreadHidden(e)))}onSortAlpha(e,t){if(e===Mh.p.DEFAULT)return t;return t.sort(((t,s)=>{const i=this._getItemInfo(t),n=this._getItemInfo(s);return((t,s)=>{const i=/^[a-zA-Z]/,n=i.test(ho.default.simpleStripVietnamese(t)),a=i.test(ho.default.simpleStripVietnamese(s));switch(e){case Mh.p.ALPHA_INCREASE:return!n&&a?1:n&&!a?-1:t.localeCompare(s);case Mh.p.ALPHA_DECREASE:return!n&&a?-1:n&&!a?1:s.localeCompare(t);default:return 0}})((null==i?void 0:i.displayName.toLowerCase())||(null==i?void 0:i.zaloName.toLowerCase())||"",(null==n?void 0:n.displayName.toLowerCase())||(null==n?void 0:n.zaloName.toLowerCase())||"")}))}onMovingNewFriend(e){let t=[],s=[];for(let i=e.length-1;i>=0;i--){const n=this._getItemInfo(e[i]);null!=n&&n.isNewFriend?t.unshift(null==n?void 0:n.userId):s.unshift(null==n?void 0:n.userId)}return[...t,...s]}_handleFilter(e,t,s,i,n){var a;let r=[];return r=this.onFilterByName(e),r=this.onFilterByLabel(null==s||null===(a=s.label)||void 0===a?void 0:a.convs,r),r=this.onFilterAll(r),r=this.onSortAlpha(t,r),r=this.onFilterHidden(n,e,r),i&&(r=this.onMovingNewFriend(r)),r}_checkDidSort(e){return e!==Mh.p.ALPHA_INCREASE?this.didSort=!0:this.didSort=!1,this.didSort}isDidSort(){return this.didSort}_updateInitListFriendWithoutDockNewFriends(){this.initListFriend=this._handleFilter(Mh.g.searching.searchText,Mh.g.searching.sorter,Mh.g.searching.filter,!1,!0),this.listState.totalRecord=this.listFriend.length}onFilter(e,t,s){const i=this._checkDidSort(t);i&&this._updateInitListFriendWithoutDockNewFriends(),this.listFriend=this._handleFilter(e,t,s,!i,!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}getList(e,t){return this.listFriend}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listFriend=[],this.initListFriend=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:Mh.p.ALPHA_INCREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1,this.didSort=!1}})||Eh)||Eh)||Eh)||Eh)||Eh);var Th;Object(ko.b)(yh.f)(Th=Reflect.metadata("design:type",Function)(Th=Reflect.metadata("design:paramtypes",[])(Th=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=yh.d,this.key=yh.d}init(e){throw new Error("Method not implemented.")}onLoadInfo(e){const t=Ch.a.getFriendInfo(e);t&&(this.data.set(e.userId,t),Object(hs.h)(this.name,e.userId))}loadInfoNotRender(e){const t=Ch.a.getFriendInfo(e);return t?(this.data.set(e.userId,t),t):null}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||Th)||Th);var wh;Object(ko.b)(yh.l)(wh=Object(i.injectable)()(wh=function(e,t){return i.ModuleContainer.inject(yh.j)(e,void 0,0)}(wh=function(e,t){return i.ModuleContainer.inject(jo.PreviewDataManager)(e,void 0,1)}(wh=function(e,t){return i.ModuleContainer.inject(No.LabelDataManager)(e,void 0,2)}(wh=Reflect.metadata("design:type",Function)(wh=Reflect.metadata("design:paramtypes",[void 0===yh.j?Object:yh.j,void 0===jo.PreviewDataManager?Object:jo.PreviewDataManager,void 0===No.LabelDataManager?Object:No.LabelDataManager])(wh=class{constructor(e,t,s){this.groupInfoManager=e,this.previewDataManager=t,this.labelDataManager=s,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listGroup=void 0,this.initListGroup=void 0,this.currentPage=void 0,this._Logger=void 0,this.name=yh.i,this.key=yh.i,this.listState=Mh.e,this.listGroup=[],this.initListGroup=[],this.currentPage=1,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(hs.j)(this.name,"all")}_signalRenderItem(){Object(hs.h)(this.name,"all")}_signalRenderBoth(){Object(hs.h)(this.name,"all"),Object(hs.j)(this.name,"all")}_getItemInfo(e){return this.groupInfoManager.getItem({key:e,version:1,extraData:null},null)||this.groupInfoManager.loadInfoNotRender({userId:e})}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}async onLoadList(){try{const e=await Ch.b.getGroupList(),t=e.map((e=>e.userId));this.listGroup=t,this.initListGroup=t,this.listState.totalRecord=t.length,this.groupInfoManager.setMultiGroupInfo(e),this.listGroup=this._handleFilter(Mh.h.searching.searchText,Mh.h.searching.sorter,Mh.h.searching.filter,!1),this.initListGroup=this._handleFilter(Mh.h.searching.searchText,Mh.h.searching.sorter,Mh.h.searching.filter,!0),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}catch(e){this.Logger.zsymb(18,"ioc7R4","[GroupListController] -> [onLoadList], error: "+JSON.stringify(e))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListGroup];return this.initListGroup.filter((t=>{const s=this._getItemInfo(t);return Object(Sh.a)((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterMyAdminGroup(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e&&!jl.q.isCommunityFromInfo(s)}))}onFilterMyAdminCommunity(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e&&jl.q.isCommunityFromInfo(s)}))}onFilterAll(e){return e}onSortAlpha(e,t){return e===Mh.p.DEFAULT||e===Mh.p.ACTION_INCREASE||e===Mh.p.ACTION_DECREASE?t:t.sort(((t,s)=>{const i=this._getItemInfo(t),n=this._getItemInfo(s),a=(null==i?void 0:i.displayName.toLowerCase())||"",r=(null==n?void 0:n.displayName.toLowerCase())||"";switch(e){case Mh.p.ALPHA_INCREASE:return a.localeCompare(r);case Mh.p.ALPHA_DECREASE:return r.localeCompare(a);default:return 0}}))}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!xo.a.isThreadHidden(e)))}onSortActionTime(e,t){return e===Mh.p.DEFAULT||e===Mh.p.ALPHA_INCREASE||e===Mh.p.ALPHA_DECREASE?t:t.sort(((t,s)=>{var i,n;const a=(null===(i=this.previewDataManager.getPreviewByIDSync(t))||void 0===i?void 0:i.messageTime)||0,r=(null===(n=this.previewDataManager.getPreviewByIDSync(s))||void 0===n?void 0:n.messageTime)||0;switch(e){case Mh.p.ACTION_DECREASE:if(r&&a){if(r>a)return 1;if(r<a)return-1}return r&&!a?1:!r&&a?-1:0;case Mh.p.ACTION_INCREASE:if(r&&a){if(r<a)return 1;if(r>a)return-1}return!r&&a?1:r&&!a?-1:0;default:return 0}}))}_handleFilter(e,t,s,i){var n;let a=[];return a=this.onFilterByName(e),a=this.onFilterByLabel(null==s||null===(n=s.label)||void 0===n?void 0:n.convs,a),a=this.onFilterMyAdminGroup((null==s?void 0:s.admin)||"",a),s&&s.adminComm&&(a=this.onFilterMyAdminCommunity(s.adminComm,a)),a=this.onFilterAll(a),a=this.onSortAlpha(t,a),a=this.onSortActionTime(t,a),a=this.onFilterHidden(i,e,a),a}onFilter(e,t,s){this.listGroup=this._handleFilter(e,t,s,!1),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((i=>{if(this.groupInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listGroup.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listGroup.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listGroup.push(i),this.listGroup=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1),this.listState.totalRecord=this.listGroup.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.groupInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}_onLeaveGroup(e){for(let t=0;t<e.length;t++){if(!this.listGroup.includes(e[t]))return;this.listGroup.splice(this.listGroup.indexOf(e[t]),1),this.initListGroup.splice(this.listGroup.indexOf(e[t]),1),this.listState.totalRecord=this.listGroup.length}this._signalRenderBoth()}addComponentListeners(){Zo.default.subscribeEventGroup(R.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.addEventListener(No.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(No.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(No.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){Zo.default.unsubscribeEventGroup(R.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.removeEventListener(No.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(No.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(No.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}getList(e,t){return this.listGroup}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listGroup=[],this.initListGroup=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:Mh.p.ACTION_DECREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1}})||wh)||wh)||wh)||wh)||wh)||wh);var Rh;Object(ko.b)(yh.j)(Rh=Reflect.metadata("design:type",Function)(Rh=Reflect.metadata("design:paramtypes",[])(Rh=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=yh.h,this.key=yh.h}init(e){throw new Error("Method not implemented.")}async onLoadInfo(e){const t=Ch.b.getGroupInfoSync(e);t&&(this.data.set(e.userId,t),Object(hs.h)(this.name,e.userId))}loadInfoNotRender(e){const t=Ch.b.getGroupInfoSync(e);return t?(this.data.set(e.userId,t),t):null}loadMultiGroupInfo(e){for(const t of e)this.loadInfoNotRender({userId:t})}setMultiGroupInfo(e){for(const t of e)this.data.set(t.userId,t)}openGroupMemberPopup(e){const t=this.data.get(e);ss.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:{group_member:t}})}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||Rh)||Rh);let Lh=function(e){return e[e.RECOMMEND=1]="RECOMMEND",e[e.RECEIVE=2]="RECEIVE",e}({});const Dh=500,Ah=500;var Fh;Object(ko.b)(yh.o)(Fh=function(e,t){return i.ModuleContainer.inject(yh.b)(e,void 0,0)}(Fh=Reflect.metadata("design:type",Function)(Fh=Reflect.metadata("design:paramtypes",[void 0===yh.b?Object:yh.b])(Fh=class extends Fe.b{constructor(e){super(),this.contactTabController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this._Logger=void 0,this.name=yh.m,this.key=yh.m,this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}}),this.addPublicListeners()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderItem(){Object(hs.h)(this.name,"all")}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.data.get(e.key)}_updateLoadingState(e,t){const{listFriendReceived:s=[],listFriendSuggest:i=[],listFriendSent:n=[]}=this.data.get("all")||{};let{isLoadingRecommendFriendList:a,isLoadingRequestedFriendList:r}=this.data.get("all")||{};if("RecommendFriendList"===e)switch(t){case"ON":a||0!==s.length||0!==i.length||(a=!0);break;case"OFF":a&&(a=!1)}if("RequestedFriendList"===e)switch(t){case"ON":r||0!==n.length||(r=!0);break;case"OFF":r&&(r=!1)}this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{isLoadingRecommendFriendList:a,isLoadingRequestedFriendList:r})),this._signalRenderItem()}async onLoadRequestedFriendList(){const e=Date.now();try{this._updateLoadingState("RequestedFriendList","ON");const t=await Ch.c.getRequestedFriendList();Date.now()-e<Dh&&await Object(Sh.b)(Ah),this._updateLoadingState("RequestedFriendList","OFF");const s=Object.keys(t).map((e=>t[e])).sort(((e,t)=>{var s,i;const n=null===(s=e.fReqInfo)||void 0===s?void 0:s.time,a=null===(i=t.fReqInfo)||void 0===i?void 0:i.time;return a>n?1:a<n?-1:0})),{listFriendReceived:i=[],listFriendSuggest:n=[],mapRelatedGroup:a={}}=this.data.get("all")||{};this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:s,listFriendSuggest:n,mapRelatedGroup:a})),this._signalRenderItem()}catch(t){Date.now()-e<Dh&&await Object(Sh.b)(Ah),this._updateLoadingState("RequestedFriendList","OFF"),this.Logger.zsymb(18,"nR_zz3","[InvitationController] -> [onLoadRequestedFriendList], error: "+JSON.stringify(t))}}async onLoadRecommendFriendList(){const e=Date.now();try{this._updateLoadingState("RecommendFriendList","ON");const t=await Ch.c.getRecommendFriendList();if(Date.now()-e<Dh&&await Object(Sh.b)(Ah),this._updateLoadingState("RecommendFriendList","OFF"),Array.isArray(t)&&t.length>0){const e=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===Lh.RECEIVE})),s=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===Lh.RECOMMEND})),{listFriendSent:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{};this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:i,listFriendSuggest:s,mapRelatedGroup:n})),s.length>0&&this.dispatchEvent(new _h.f(_h.e.LoadRelatedGroups,"",{})),this._signalRenderItem()}}catch(t){Date.now()-e<Dh&&await Object(Sh.b)(Ah),this._updateLoadingState("RecommendFriendList","OFF"),this.Logger.zsymb(18,"k5r1EV","[InvitationController] -> [onLoadRecommendFriendList], error: "+JSON.stringify(t))}}_handleSortFriendSuggestList(e,t){return 0===e.length?e:e.sort(((e,s)=>{var i,n,a,r,o,l;const c=t[null===(i=e.dataInfo)||void 0===i?void 0:i.userId]&&t[null===(n=e.dataInfo)||void 0===n?void 0:n.userId].length,d=(null===(a=e.dataInfo)||void 0===a?void 0:a.displayName)||"",u=t[null===(r=s.dataInfo)||void 0===r?void 0:r.userId]&&t[null===(o=s.dataInfo)||void 0===o?void 0:o.userId].length,h=(null===(l=s.dataInfo)||void 0===l?void 0:l.displayName)||"";return c&&u?c===u?d.localeCompare(h):u>c?1:-1:c&&!u?-1:!c&&u?1:c||u?0:d.localeCompare(h)}))}async onLoadRelatedGroupList(){try{const{listFriendSuggest:e=[]}=this.data.get("all")||{},t=e.map((e=>{var t;return null==e||null===(t=e.dataInfo)||void 0===t?void 0:t.userId})),s=await Ch.c.getRelatedGroup(t),{listFriendReceived:i=[],listFriendSent:n=[]}=this.data.get("all")||{},a=this._handleSortFriendSuggestList(e,s.groupRelateds);this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:n,listFriendSuggest:a,mapRelatedGroup:s.groupRelateds||{}})),this._signalRenderItem()}catch(e){this.Logger.zsymb(18,"7n8q_X","[InvitationController] -> [onLoadRelatedGroupList], error: "+JSON.stringify(e))}}handleFriendProfileChange(e){const{listFriendReceived:t=[],listFriendSuggest:s=[],listFriendSent:i=[]}=this.data.get("all")||{};Object.keys(e).forEach((e=>{const n=ns.default.getDName(e),a=t.findIndex((t=>t.dataInfo.userId===e));-1!==a&&(t[a].displayName=n);const r=s.findIndex((t=>t.dataInfo.userId===e));-1!==r&&(s[r].displayName=n);const o=i.findIndex((t=>t.userId===e));-1!==o&&(i[o].displayName=n)})),this._signalRenderItem()}handlePublicFriendEvents(e){const t=e.payload;if(t)for(let i=0;i<t.length;i++){var s;const n=t[i].ts,a="add"===t[i].act&&t[i].data||(null===(s=t[i].data)||void 0===s?void 0:s.fromUid),r=a===e.userId;if(n&&a&&!r&&"fr"===t[i].act_type)switch(t[i].act){case"req_v2":this.contactTabController.onUpdateRequestTracking("FRIEND","NEW",n,a);break;case"undo_req":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",n,a),this.dispatchEvent(new _h.f(_h.e.UndoAddFriendEvent,"",a));break;case"add":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",n,a),this.dispatchEvent(new _h.f(_h.e.AcceptAddFriendEvent,"",a));break;case"reject":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",n,a),this.dispatchEvent(new _h.f(_h.e.RejectAddFriendEvent,"",a))}}}handlePublicAddFriendEvent(e){let t=[];const s=e.payload;if(s){for(let e=0;e<s.length;e++){let i={};i.userId=s[e].userId,i.zaloName=s[e].zaloName,i.avatar=s[e].avatar,i.displayName=s[e].displayName,i.recommInfo={message:s[e].friendRequestMsg,source:s[e].friendRequestSource},i.recommTime=s[e].friendRequestFetchTime,i.recommType=s[e].friendRequestType,t.push({dataInfo:i,recommItemType:1})}this.dispatchEvent(new _h.f(_h.e.ReceiveAddFriendEvent,"",t))}}addPublicListeners(){this.addEventListener(_h.e.PublicInvitationEvents,this.handlePublicFriendEvents.bind(this)),this.addEventListener(_h.e.PublicReceiveAddFriendEvent,this.handlePublicAddFriendEvent.bind(this)),ns.default.connectSignalChangeDNameAndAvatar(this.handleFriendProfileChange.bind(this))}addComponentListeners(){}removeComponentListeners(){}_addFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},a=e.concat(t);this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:a,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}_removeFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},a=t.filter((t=>{var s;return(null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:a,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}onUpdateFriendRequests(e,t){switch(t){case"ADD":this._addFriendReceived(e);break;case"REMOVE":this._removeFriendReceived(e)}}async onRejectFriend(e){return new Promise(((t,s)=>{Ch.c.rejectAddFriend(e).then((()=>{this._removeFriendReceived(e),t(e)})).catch((e=>{this.Logger.zsymb(18,"4Uo0aQ","[InvitationController] -> [onRejectFriend], error: "+JSON.stringify(e)),s(e)}))}))}async onAddFriend(e){return new Promise(((t,s)=>{Ch.c.acceptAddFriend(e).then(t).catch((e=>{this.Logger.zsymb(18,"XGttI8","[InvitationController] -> [onAddFriend], error: "+JSON.stringify(e)),s(e)}))}))}removeFriendSent(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},a=s.filter((t=>(null==t?void 0:t.userId)!==e));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:a,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}onRemoveFriendSent(e){Ch.c.makeUndoSentRequestFriend(e).then((()=>{this.removeFriendSent(e.userId)})).catch((e=>{this.Logger.zsymb(18,"XA3ruD","[InvitationController] -> [onRemoveFriendSent], error: "+JSON.stringify(e)),e&&301==e.error_code?rs.default.createError(os.a.str("STR_UNDO_REQUEST_ERROR_301")):e&&"ERR_NO_NETWORK"===e.code?rs.default.createError(os.a.str("STR_CHECK_NET")):rs.default.createError(os.a.str("STR_UNDO_REQUEST_ERROR_UNKNOWN"))}))}_removeFriendSuggest(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{},a=i.filter((t=>{var s;return(null==t||null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:n})),this._signalRenderItem()}onAddFriendSuggest(e){gh.a.doAddFriend(e.uid,e.src,null,e.windowId).then((()=>{this._removeFriendSuggest(e.uid),this.onLoadRequestedFriendList()})).catch((e=>{this.Logger.zsymb(18,"3-xBNo","[InvitationController] -> [onAddFriendSuggest], error: "+JSON.stringify(e))}))}onRemoveFriendSuggest(e){Ch.c.removeSuggestFriend(e).then((()=>{this._removeFriendSuggest(e.uid)})).catch((e=>{this.Logger.zsymb(18,"fKXAOR","[InvitationController] -> [onRemoveFriendSuggest], error: "+JSON.stringify(e))}))}openMutualGroupPopup(e){ss.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:{userId:e,showMutualGroups:!0}})}resetData(){this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}})}makeExpiredReceivedFriendRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==e.length){for(let t=0;t<e.length;t++)e[t].dataInfo.recommTime=-1,e[t].dataInfo.recommInfo.source=-1,e[t].dataInfo.recommInfo.message="";this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}makeExpiredSentFriendSentRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==t.length){for(let e=0;e<t.length;e++)t[e].fReqInfo.time=-1,t[e].fReqInfo.src=-1,t[e].fReqInfo.message="";this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}markSeenFriendRequests(e){const t=this.data.get("all")||{},{listFriendReceived:s=[]}=t;if(e.length>0&&s.length>0){const i=new Set(e);let n=!1;for(const e of s){const t=e.dataInfo;t&&!t.isSeenFriendReq&&i.has(t.userId)&&(e.dataInfo.isSeenFriendReq=!0,n=!0)}n&&(this.data.set("all",Object(f.a)(Object(f.a)({},t),{},{listFriendReceived:s})),this._signalRenderItem())}}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Fh)||Fh)||Fh);var jh,Ph=s("2x/M"),kh=s("FhUL"),Nh=s("zU/x"),Uh=s("dhU0"),Bh=s("2e02"),xh=s("HnA5");function Gh(e){return{avatar:e.avatar,displayName:ns.default.getDName(e.id)||e.dName||e.zaloName,userId:e.id,zaloName:e.zaloName,type:e.type}}Object(ko.b)(Bh.b)(jh=Reflect.metadata("design:type",Function)(jh=Reflect.metadata("design:paramtypes",[])(jh=class extends Fe.b{constructor(){super(),this.name=void 0,this.key=void 0,this._Logger=void 0,this.data=void 0,this.metadata=void 0,this.timer=void 0,this.isOpeningInvitationBox=void 0,this.handleNetworkStatusChange=e=>{e===fu.a.CONNECTED&&0===this.data.size&&this.getReceivedInvitations({page:0})},this.name=Bh.a,this.key="groupId",this.data=new Map,this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.timer={instance:new li.b,intervalId:null},this.isOpeningInvitationBox=!1}init(){throw new Error("Method not implemented.")}getList(){return Array.from(this.data.keys())}getItem(e){const t=this.data.get(e.key);return t||this.Logger.zsymb(5,"7Gkey5",["try to get item not exist in cache {}","RIEeTm"],e.key),t}onGetItemFailure(e){this.Logger.zsymb(18,"5zk7iC","Get group invitation item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(18,"R8xRG2","Get group invitation list failed",e)}signalUpdateList(){Object(hs.j)(this.name,"all")}signalUpdateItem(e){Object(hs.h)(this.name,e)}signalUpdateListMeta(){this.dispatchEvent(new _h.d(_h.b.UpdateUIListMetadata,this.metadata))}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}async getCreatorInfos(e){const t=await ns.default.getProfileFriendForGroup(Object.fromEntries(e.map((e=>[e.creatorId||e,0]))));return new Map(e.map((e=>[e.groupId,t[e.creatorId]])))}async getCreatorInfoForGroup(e){return ns.default.getProfileFriendForGroup({[e]:0})}startTimer(){this.stopTimer(),this.timer.intervalId=window.setInterval((()=>this.timer.instance.publish(yn.default.getTimeNow())),_h.c.COUNT_INTERVAL)}stopTimer(){null!==this.timer.intervalId&&window.clearInterval(this.timer.intervalId),this.timer.intervalId=null}getTimer(){return this.timer.instance}isValidInvitation(e){var t;return!!(null!==(t=e.groupInfo)&&void 0!==t&&t.groupId&&e.grCreatorInfo&&e.inviterInfo)&&e.expiredTs-yn.default.getTimeNow()>0}convertToGroupInvitation(e){const t=R.GROUPID_PREFIX+e.groupInfo.groupId,s=function(e){return{avatar:e.avt,creatorId:e.creatorId,displayName:e.name,name:e.name,setting:e.setting,adminIds:e.adminIds,totalMember:e.totalMember,userId:e.groupId,type:e.type,topMember:e.currentMems.map(Gh),isGroup:!0}}(e.groupInfo),i=Gh(e.inviterInfo),n=Gh(e.grCreatorInfo);return Object(f.a)(Object(f.a)({},e),{},{groupId:t,groupInfo:s,inviterInfo:i,grCreatorInfo:n})}async loadServerReceivedInvitations(){var e;const{invitations:t,hasMore:s,total:i}=await uo.default.getGroupInvitationList(this.metadata.page,mi.default.group_privacy.invitation_box.paging_limit,mi.default.group_privacy.invitation_box.mcount_item,null===(e=this.metadata)||void 0===e?void 0:e.lastGroupId);this.metadata=Object(f.a)(Object(f.a)({},this.metadata),{},{hasMore:s,total:i});const n=await this.getCreatorInfos(t.map((e=>e.groupInfo))),a=[];for(let r=0;r<t.length;r++){const e=t[r];if(e.grCreatorInfo||(e.grCreatorInfo=n.get(e.groupInfo.groupId)),this.isValidInvitation(e)){const s=R.GROUPID_PREFIX+e.groupInfo.groupId,i=this.convertToGroupInvitation(e);a.push(i),r===t.length-1&&(this.metadata.lastGroupId=s)}}return a}onInvitationListUIAppear(){this.isOpeningInvitationBox=!0,this.startTimer(),this.getReceivedInvitations({page:0}).catch((e=>{this.Logger.zsymb(18,"JL5sGZ","Init load invitation failed",e)})).finally((()=>{this.metadata.loading&&(this.metadata.loading=!1,setTimeout((()=>{this.signalUpdateListMeta()}),300))})),rt.p.listenEvent(rt.j,this.handleNetworkStatusChange)}onInvitationListUIDisappear(){this.stopTimer(),this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.data.clear(),rt.p.removeListenEvent(rt.j,this.handleNetworkStatusChange),this.isOpeningInvitationBox=!1}getUIListMeta(){return this.metadata}async getReceivedInvitations(e={}){const{page:t=0}=e;if(!this.metadata.hasMore)return[];this.metadata.page=t,this.data=new Map(this.data);const s=await this.loadServerReceivedInvitations();return s.forEach((e=>{this.data.set(e.groupId,e)})),this.signalUpdateListMeta(),this.signalUpdateList(),s}async loadMoreReceivedInvitations(){const e=mi.default.group_privacy.invitation_box.paging_limit,t=Math.trunc(this.data.size/e);return this.getReceivedInvitations({page:t})}handleNewInvitation(e,t){this.metadata.total+=1,this.data=new Map([[e,t],...Array.from(this.data.entries())]),this.signalUpdateListMeta(),this.signalUpdateList()}async acceptInvitation(e,t){try{if(e.type===kh.a.PENDING_REVIEW)throw{error_code:Nh.a.WAITING_APPROVE};const t=ho.default.getRawGroupId(e.groupId);await uo.default.joinGroupFromInvitation(t),this.Logger.zsymb(2,"g81WoA","Join group success",e.groupId),i.ModuleContainer.resolve(Ii.b).openConversation(e.groupId,Ii.c.fromGroupInvitation()),this.deleteInvitationsFromCache([e.groupId])}catch(s){this.Logger.zsymb(18,"LlQHOk","Join group failed",e.groupId,s),this.handleJoinInvitationError(e,null==s?void 0:s.error_code,t)}}async rejectInvitation(e,t={}){try{if(e.type===kh.a.PENDING_REVIEW)throw{error_code:Nh.a.WAITING_APPROVE};const s=ho.default.getRawGroupId(e.groupId);await uo.default.deleteGroupInvitation([{grid:s}],t.blockGroup),this.Logger.zsymb(2,"YCnGKR","Reject group invitation success",e.groupId,t),t.blockInviter&&ns.default.blockFriend(e.inviterInfo.userId,R.SET_BLOCK),this.deleteInvitationsFromCache([e.groupId]),rs.default.createInfo(os.a.str(xh.a.get("STR_GROUP_INVITATION_DELETED",e.groupInfo)))}catch(s){this.Logger.zsymb(18,"2Q-et3","Reject group invitation failed",e.groupId,s),rs.default.createError(os.a.str("STR_ERROR_OCCUR"))}}async deleteInvitations(e){const t=e.map((e=>({grid:ho.default.getRawGroupId(e.groupId)})));try{await uo.default.deleteGroupInvitation(t,!1),this.Logger.zsymb(2,"S0IQXX","Delete group invitations success",t),this.deleteInvitationsFromCache(e.map((e=>e.groupId)))}catch(s){this.Logger.zsymb(18,"ak1gTL","Delete group invitations failed",t,s),rs.default.createError(os.a.str("STR_ERROR_OCCUR"))}}deleteInvitationsFromCache(e){let t=0;for(const s of e)this.data.has(s)&&(this.data.delete(s),t+=1);0!==t&&(this.metadata.total=Math.max(this.metadata.total-t,0),this.signalUpdateListMeta(),this.signalUpdateList(),this.metadata.hasMore&&this.data.size<mi.default.group_privacy.invitation_box.paging_limit&&this.loadMoreReceivedInvitations())}getInvitationSync(e){return this.data.get(e)||null}getInvitation(e){return new Promise((t=>{const s=ho.default.getRawGroupId(e);uo.default.getGroupInvitationInfo(s).then((e=>{e.grCreatorInfo?t(this.convertToGroupInvitation(e)):this.getCreatorInfoForGroup(e.groupInfo.creatorId).then((s=>{e.grCreatorInfo=s,t(this.convertToGroupInvitation(e))})).catch((()=>t(null)))})).catch((s=>{this.Logger.zsymb(18,"u_r6H3","Get invitation info failed",e,s),t(null)}))}))}updateInvitationFromCache(e){const{groupId:t}=e;this.data.has(t)&&this.data.set(t,e)}updateInvitationStatus(e,t){const s=this.data.get(e);if(s){const i=Object(f.a)(Object(f.a)({},s),{},{type:t});this.updateInvitationFromCache(i),this.data.set(e,i),this.signalUpdateItem(e)}}onReceivedInvitationEvents(e,t){const s=t.groupId;if(!s)return;const n=R.GROUPID_PREFIX+s;switch(this.Logger.zsymb(0,"7WNeS8","Received new event",e,n),e){case Ph.b.NEW_INVITATION:this.isOpeningInvitationBox&&this.getInvitation(n).then((e=>{e&&this.handleNewInvitation(n,e)})).catch((e=>{this.Logger.zsymb(18,"84FrKH","Load new invitation item by event failed",n,e)})),i.ModuleContainer.resolve(Uh.b).onUpdateRequestTracking("GROUP_INV","NEW",yn.default.getTimeNow(),n);break;case Ph.b.UPDATE_INVITATION:const e=this.data.get(n);"number"==typeof t.invitationType&&(null==e?void 0:e.type)!==t.invitationType&&this.updateInvitationStatus(n,t.invitationType);break;case Ph.b.REMOVE_INVITATION:this.deleteInvitationsFromCache([n]),i.ModuleContainer.resolve(Uh.b).onUpdateRequestTracking("GROUP_INV","REMOVE",yn.default.getTimeNow(),n)}}handleJoinInvitationError(e,t,s){switch(t){case Nh.a.WAITING_APPROVE:this.updateInvitationStatus(e.groupId,kh.a.PENDING_REVIEW),rs.default.createInfo(os.a.str(xh.a.get("STR_GROUP_INVITATION_JOIN_ERR_240",e.groupInfo)));break;case Nh.a.EXCEED_MAX_GROUP:case Nh.a.CANNOT_CHANGE:case Nh.a.BANNED:case Nh.a.NOT_PERMITTED:rs.default.createInfo(os.a.str(xh.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case Nh.a.NOT_EXIST:case Nh.a.ALREADY_MEMBER:case Nh.a.EXPIRED:this.deleteInvitationsFromCache([e.groupId]),rs.default.createInfo(os.a.str(xh.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case R.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:case R.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:mi.default.group_privacy.community.enable_upgrade?i.ModuleContainer.resolve(jl.e).onReceivedCommunityError({errorCode:t,windowId:s,groupId:e.groupId}):rs.default.createError(os.a.str("STR_ERROR_OCCUR"));break;default:rs.default.createError(os.a.str("STR_ERROR_OCCUR"))}}})||jh)||jh);var zh;Object(Je.i)()(zh=Object(Je.g)()(zh=Object(Je.d)()(zh=Object(i.singleton)(yh.c)(zh=class{constructor(){this.logger=void 0,this.handleFetchClearUnread=async()=>{if(mi.default.contactTabV2.seen_friendrequest){this.Logger.zsymb(18,"iSyVA3","overflow queue -> fetch clear unread");try{const{ts:e}=await uo.default.getLastReadContactTab(),t=this.getLastCachedAccessTs();"number"==typeof e&&e>t&&(this.Logger.zsymb(0,"hWxBPd",`do reinit unread lastTs=${t} ts=${e}`),E.default.getInstance().setItemForCurrentUser(_h.g,String(e)),i.ModuleContainer.resolve(yh.b).computeUpdateUnread())}catch(e){this.Logger.zsymb(18,"Gq0mCq","fetch clear unread fail",e)}}}}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.contactTabV2,["unread-manager"])),this.logger}getLastCachedAccessTs(){const e=E.default.getInstance().getItemForCurrentUser(_h.g);return e&&!isNaN(+e)?+e:0}clearFriendRequestUnread(e,t=!1){i.ModuleContainer.resolve(yh.o).markSeenFriendRequests(e),i.ModuleContainer.resolve(yh.b).clearFriendRequestUnread(e),t&&uo.default.sendClearUnreadFriendRequest(e).then((()=>{this.Logger.zsymb(0,"oH-Yea","sync read friend req tab success total=",e.length)})).catch((e=>{this.Logger.zsymb(18,"ejZnnn","sync read friend req tab fail",e)}))}onStart(){rt.p.listenEvent(rt.n,this.handleFetchClearUnread)}onApplicationReady(){i.ModuleContainer.resolve(yh.b).onInitUnreadRequest()}onDispose(){rt.p.removeListenEvent(rt.n,this.handleFetchClearUnread)}onOpenContactTab(e){const t=i.ModuleContainer.resolve(yh.b).getState(Go.c).unread,s=t.isUnread&&t.newFriendRequests.length>0&&mi.default.contactTabV2.seen_friendrequest;this.Logger.zsymb(0,"BTGP51",`open contact tab -> friend req=${t.newFriendRequests.length} group inv=${t.newGroupInvitations.size}`),s&&uo.default.readContactTab(e).then((()=>{this.Logger.zsymb(0,"iQSWAE","sync read contact tab success",e)})).catch((t=>{this.Logger.zsymb(18,"uhK3Mp","sync read contact tab fail",e,t)}))}onOpenFriendRequestTab(e){const t=e.filter((({dataInfo:e})=>e&&!e.isSeenFriendReq)).map((({dataInfo:e})=>e.userId));t.length>0&&this.clearFriendRequestUnread(t,!!mi.default.contactTabV2.seen_friendrequest)}onOpenGroupInvitationTab(){const e=i.ModuleContainer.resolve(yh.b),t=e.getState(Go.c).unread;if(t.newGroupInvitations.size){const s=Array.from(t.newGroupInvitations);e.clearGroupInvitationUnread(s)}}onSeenBannerFriendRequest(e){if(mi.default.contactTabV2.seen_friendrequest&&mi.default.contactTabV2.seen_friendrequest_chat_view){i.ModuleContainer.resolve(yh.b).getState(Go.c).unread.newFriendRequests.includes(e)&&this.clearFriendRequestUnread([e],!0)}}onSeenFriendRequests(e){mi.default.contactTabV2.seen_friendrequest&&this.clearFriendRequestUnread(e,!1)}})||zh)||zh)||zh);var Vh,Hh=s("hLuk");Object(Je.i)()(Vh=class{onStart(){Hh.default.init()}});var Wh,$h=s("xdZB"),Kh=s("hWjG"),qh=s("mE25");let Qh=Object(i.singleton)()(Wh=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Wh=Reflect.metadata("design:type",Function)(Wh=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Wh=class extends Kh.a{constructor(e){super("Core","Message","",e)}countMessages(e,t={from:["0","0"],to:[qh.b,qh.a]}){return this._dbCollection.count({from:[e,...t.from],to:[e,...t.to]},{index:"userId_sendDttm_msgId",partition:e})}async getLastMessage(e){var t;let s=null;const i={from:[e,"",""],to:[e,qh.b,qh.a],excludeFrom:!0,excludeTo:!0},n={index:"userId_sendDttm_msgId",direction:Le.c.PREV,limit:1,predicate:t=>{!s&&t&&(s=t);const i=Yu.d.reduceDeleteMsgs(e,[t],!0);return Jo.default.isValidPreviewMessage(t)&&0!==i.length},partition:e},a=await this._dbCollection.getAll(i,n);return null!==(t=null==a?void 0:a[0])&&void 0!==t?t:s}async getPrevMessageIds(e,t,s){const i={from:[e,"",""],to:[e,(await this.get(t)).sendDttm,t],excludeFrom:!0,excludeTo:!0},n={index:"userId_sendDttm_msgId",direction:Le.c.PREV,limit:s,predicate:e=>!isNaN(Number(e.msgId)),partition:e};return(await this._dbCollection.getAll(i,n)).map((e=>e.msgId))}})||Wh)||Wh)||Wh)||Wh;const Zh=(e,t)=>{if(e)throw t};var Jh=s("1izJ");let Yh=function(e){return e[e.FETCH_ERROR=0]="FETCH_ERROR",e[e.FETCH_CONV_HAS_MSG_OFFLINE_ERROR=1]="FETCH_CONV_HAS_MSG_OFFLINE_ERROR",e[e.INVALID_RESPONSE=2]="INVALID_RESPONSE",e[e.INSERT_MULTI_ERROR=3]="INSERT_MULTI_ERROR",e}({});class Xh extends Jh.a{constructor(e,t,s,i){super("FetchMessageCloudError",Yh.FETCH_ERROR,`ConvId: ${e}. RequestMsgId: ${t}. OriginError: ${JSON.stringify(s)}`,i)}}class eg extends Jh.a{constructor(e,t){super("InvalidResponse",Yh.INVALID_RESPONSE,e,t)}}class tg extends Jh.a{constructor(e,t){super("FetchConvHasMessageOfflineError",Yh.FETCH_CONV_HAS_MSG_OFFLINE_ERROR,e,t)}}Jh.a;var sg;let ig=Object(td.h)()(sg=class{async fetchMessagesCloud(e,t,s,i,n){const a=Rd.a.newReq(),[r,o]=await Be.c.catchPromise(pu.default.getCM(e,Number(t),0,s,a,n,i));Zh(r,new Xh(e,t,r));const[l,c]=await Be.c.catchPromise(Object(gu.a)(o));Zh(l,new eg(`ConvId: ${e}. RequestMsgId: ${t}. Cannot handle response: ${JSON.stringify(l)}`));const[d,u]=Be.c.catchFn((()=>JSON.parse(c)));return Zh(d,new eg(`ConvId: ${e}. RequestMsgId: ${t}. Cannot parse json object`)),u}async fetchListConvHasMessageOffline(e,t,s){const[i,n]=await Be.c.catchPromise(pu.default.getConvHasMessageOffline(e,t,s));Zh(i,new tg(JSON.stringify(i)));const[a,r]=await Be.c.catchPromise(Object(gu.a)(n));return Zh(a,new eg(`Cannot handle response: ${JSON.stringify(a)}`)),r}})||sg;var ng,ag=s("/Bne");class rg{constructor(e,t){this.convId=e,this.messageCloudRaw=t,this.userId=void 0,this.idTo=void 0,this.uidFrom=void 0,this.uin=void 0,this.cliMsgId=void 0,this.msgId=void 0,this.content=void 0,this.dName=void 0,this.msgType=void 0,this.status=void 0,this.ts=void 0,this.isFromCloud=void 0,this.msgKey=void 0,this.isGroup=void 0,this.mentions=void 0,this.quote=void 0,this.st=void 0,this.at=void 0,this.ttl=void 0,this.src=void 0,this.cmd=void 0,this.footer=void 0,this.footerv2=void 0,this.previewThumb=void 0,this.property=void 0,this.propertyExt=void 0,this.specialMsgType=void 0,this.topOut=void 0,this.topOutImprTimeOut=void 0,this.topOutTimeOut=void 0,this.userId=t.userId,this.idTo=t.idTo,this.uidFrom=t.uidFrom,this.uin=t.uin,this.cliMsgId=t.cliMsgId,this.msgId=t.msgId,this.content=t.content,this.dName=t.dName,this.msgType=t.msgType,this.status=t.status,this.ts=t.ts,this.mentions=t.mentions,this.quote=t.quote,this.st=t.st,this.at=t.at,this.ttl=t.ttl,this.cmd=t.cmd,this.footer=t.footer,this.footerv2=t.footerv2,this.previewThumb=t.previewThumb,this.property=t.property,this.propertyExt=t.propertyExt,this.specialMsgType=t.specialMsgType,this.topOut=t.topOut,this.topOutImprTimeOut=t.topOutImprTimeOut,this.topOutTimeOut=t.topOutTimeOut,this.isFromCloud=!0,this.msgKey=e,this.isGroup=t.isGroup}toEntity(){return ag.a.transformMessageFromServer(this.messageCloudRaw,this.convId)}setSrc(e){this.src=e}}let og=Object(td.h)()(ng=Reflect.metadata("design:type",Function)(ng=Reflect.metadata("design:paramtypes",[])(ng=class{constructor(){this.apiAdapter=void 0,this.apiAdapter=i.ModuleContainer.resolveToken(ig)}async fetchMessagesCloud(e,t,s,i){var n;const[a,r]=await Be.c.catchPromise(this.apiAdapter.fetchMessagesCloud(e,t,s,i));Zh(a,a);const o=(null!==(n=r.groupMsgs)&&void 0!==n?n:[]).map((t=>new rg(e,t)));return Object(f.a)(Object(f.a)({},r),{},{groupMsgs:o})}async fetchConvHasMessageOffline(e,t,s){return await this.apiAdapter.fetchListConvHasMessageOffline(e,t,s)}})||ng)||ng)||ng;var lg;Object(i.singleton)(uc)(lg=Reflect.metadata("design:type",Function)(lg=Reflect.metadata("design:paramtypes",[])(lg=class{constructor(){this.messageRespository=void 0,this.messageService=void 0,this.messageRespository=i.ModuleContainer.resolveToken(Qh),this.messageService=i.ModuleContainer.resolveToken(og)}async fetchMessagesCloud(e,t,s,i){return await this.messageService.fetchMessagesCloud(e,t,s,i)}async getLastMessage(e){return await this.messageRespository.getLastMessage(e)}async getPrevMessageIds(e,t,s){return this.messageRespository.getPrevMessageIds(e,t,s)}async countMessages(e,t){return await this.messageRespository.countMessages(e,t)}async getGroupHasMessageOffline(e,t,s){const i=await this.messageService.fetchConvHasMessageOffline(e,t,s);return{listConvIds:i.grids.map((e=>R.GROUPID_PREFIX+e)),evict:!!i.evict}}reloadMessage(e){var t;null===(t=Ld.b.messageCache)||void 0===t||t.deleteConversation(e);$h.a.getExistConvIds().includes(e)&&fl.default.getLastMessagesForConversation(e,{})}})||lg)||lg);const cg=Object(i.define)("cloud-segment-controller");var dg=s("npvr"),ug=s("t3h5");let hg=function(e){return e[e.UPDATE_FAILED=0]="UPDATE_FAILED",e}({});class gg extends Jh.a{constructor(e,t){super("UpdateSegmentError",hg.UPDATE_FAILED,e,t)}}var mg;let pg=Object(i.singleton)()(mg=class{async get(e){return ug.a.getSegmentByConvId(e)}async update(e,t){const[s]=await Be.c.catchPromise(dg.b.updateSegmentDB(e,t));return Zh(s,new gg(JSON.stringify(s))),ug.a.setSegmentCacheByConvId(e,t),t}})||mg;var fg;Object(i.injectable)()(fg=Object(i.singleton)(cg)(fg=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(fg=Reflect.metadata("design:type",Function)(fg=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(fg=class{constructor(e){this.logger=void 0,this.repository=void 0,this.repository=i.ModuleContainer.resolveToken(pg),this.logger=e.createZLogger(Ve.ZLoggerNametags.messageCloudSegment,[Ve.ZLoggerNametags.controller])}async get(e){return this.repository.get(e)}async update(e){return await this.repository.update(e.conversationId,e)}async updateSegment(e,t){const s=Xu.a.addOrUpdateSegmentCache(e.conversationId,t.messages,e,{requestMsgId:t.requestMsgId,lastMsgId:t.lastMsgId,checkLoadTop:t.checkLoadTop,hasMore:t.hasMore,minMsgIdFromServer:t.minMsgIdFromServer,maxMsgIdFromServer:t.requestMsgId===R.MessageConstants.MAX_MSG_ID?t.maxMsgIdFromServer:t.requestMsgId}).segmentObj;return await this.repository.update(e.conversationId,s)}})||fg)||fg)||fg)||fg);const vg=Object(i.define)("cloud-segment-repository"),bg=Object(i.define)("cloud-segment-manager"),Ig=Object(i.define)("cloud-message-manager");class yg{constructor(e){this.entity=e}get conversationId(){return this.entity.conversationId}get cloudFirstSmsLocalId(){return this.entity.cloudFirstSmsLocalId}get cloudSegmentCheck(){return this.entity.cloudSegmentCheck}get hasMore(){return this.entity.hasMore}get lastCloudVerifiedDttm(){return this.entity.lastCloudVerifiedDttm}get lastDeletedMsgID(){return this.entity.lastDeletedMsgID}get lastGetMaxRecentTs(){return this.entity.lastGetMaxRecentTs}get maxCloudMsgId(){return this.entity.maxCloudMsgId}}var _g;let Cg=i.ModuleContainer.injectable()(_g=Reflect.metadata("design:type",Function)(_g=Reflect.metadata("design:paramtypes",[])(_g=class{constructor(){}get(e){return ug.a.getSegmentByConvId(e)}})||_g)||_g)||_g;var Og,Eg=s("D8Ji");let Mg=i.ModuleContainer.injectable()(Og=function(e,t){return i.ModuleContainer.inject(vg)(e,void 0,0)}(Og=Reflect.metadata("design:type",Function)(Og=Reflect.metadata("design:paramtypes",[void 0===vg?Object:vg])(Og=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new yg(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const s=await this.segmentRepository.get(e);s.cloudSegmentCheck=Eg.a.mergeNewSegment(t.verifiedRange,null==s?void 0:s.cloudSegmentCheck),s.maxCloudMsgId=Math.max(s.maxCloudMsgId||0,t.verifiedRange[1]),ug.a.setSegmentCacheByConvId(e,s),await dg.b.updateSegmentDB(e,s)}})||Og)||Og)||Og)||Og;class Sg extends Error{constructor(e,t,s){super(s),this.code=e,this.data=t}}var Tg;let wg=i.ModuleContainer.injectable()(Tg=function(e,t){return i.ModuleContainer.inject(_.a)(e,void 0,0)}(Tg=Reflect.metadata("design:type",Function)(Tg=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(Tg=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t={nRetry:0,count:50}){let s=e.conversationId;s.startsWith("g")&&(s=s.slice(1));const i=`${s}_${e.requestMsgId}`;let n=this.settings.limit.minMsgDttm,a=this.settings.limit.maxMsgFirstSegment;const r={groupId:s,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:n,maxTotalSyncMsg:a};return await pu.default.crawlMissingMessage(i,r,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(gu.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[s];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let s=e.data;try{s=JSON.parse(s)}catch(t){}throw new Sg(e.error_code,s,e.error_message)}throw e}))}})||Tg)||Tg)||Tg)||Tg;var Rg,Lg=s("yEZN"),Dg=s("EO3V"),Ag=s("enz2");const Fg={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let jg=i.ModuleContainer.injectable()(Rg=function(e,t){return i.ModuleContainer.injectToken(wg)(e,void 0,0)}(Rg=function(e,t){return i.ModuleContainer.inject(bg)(e,void 0,1)}(Rg=function(e,t){return i.ModuleContainer.inject(Lg.c)(e,void 0,2)}(Rg=function(e,t){return i.ModuleContainer.inject(Lg.b)(e,void 0,3)}(Rg=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,4)}(Rg=Reflect.metadata("design:type",Function)(Rg=Reflect.metadata("design:paramtypes",[void 0===wg?Object:wg,void 0===bg?Object:bg,void 0===Lg.c?Object:Lg.c,void 0===Lg.b?Object:Lg.b,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Rg=class{constructor(e,t,s,i,n){this.api=e,this.segmentManager=t,this.messageRepository=s,this.messageManager=i,this.logger=void 0,this.logger=n.createZLogger("cld-msg",["manager"])}async crawlMissingMessage(e,t,s){const i=await this.segmentManager.get(e),n=(()=>{var e;let t=s.minMsgId&&Number.parseInt(s.minMsgId);return i&&i.lastDeletedMsgID&&(t=t?Math.max(i.lastDeletedMsgID,t):i.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),a="0"!==t,r=a?s.count+1:s.count;if(a&&t<=n)return Fg;const o=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:n,limit:r}).then((e=>e.map((e=>e.entity)))),l=new Set;o.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&l.add(t.toString())}catch(t){}}));const c=Array.from(l.values()),d=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:c,curTotalMsgs:s.curTotalMsgs,tsJoinGroup:s.tsJoinGroup},{nRetry:s.nRetry,count:s.count});if(0===d.groupMsgs.length&&"0"===d.maxMsgId)return Fg;let u=Dg.a.checkDupMessageFromCloud(e,d.groupMsgs);n&&n>"0"&&(u=u.filter((e=>e.msgId>n)));const h=[...o,...u];if(0===h.length)return Fg;const g=Number.parseInt(d.lastMsgId,10);let m=Number.parseInt(t);const p=Dg.a.findMinMaxGroupMsg(h,m,g,null==i?void 0:i.lastDeletedMsgID),{groupMsgsToView:v,groupMsgsAddDb:b,groupMsgsSearch:I}=Ag.a.findMsgsAddDb(t,u,[],o,Object(f.a)({apiType:2,conversationId:e},p));b.forEach((e=>{e.src=R.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(e,b),await Ag.a.updateSearchV3(I,e);const y=!!d.isFilteredByPhase,_=d.maxMsgId;p.minMsgId&&p.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[p.minMsgId,p.maxMsgId]});let C="0";Number.isInteger(Number.parseInt(d.tsJoinGroup))?C=d.tsJoinGroup:this.logger.zsymb(18,"dT_PJG",(()=>["api res invalid ts join group",{tsJoinGroup:d.tsJoinGroup}]));const O=!!d.isFilteredByTimeJoin,E={totalMsgCount:v.length,fetchedMsgCount:b.length,serverMsgCount:u.length,newMsgCount:b.length,phaseDone:y,isFilteredByTimeJoin:O,done:!(y||!O&&d.hasMore),minMsgId:n,maxMsgId:_.toString(),tsJoinGroup:C};return this.logger.zsymb(3,"gr3rTK",["[auto-dl-msg] crawl result","HITYGU"],E),E}})||Rg)||Rg)||Rg)||Rg)||Rg)||Rg)||Rg)||Rg;i.ModuleContainer.registerSingleton(vg,Cg),i.ModuleContainer.registerSingleton(bg,Mg),i.ModuleContainer.registerSingleton(Ig,jg);var Pg,kg=s("rfrl"),Ng=s("KP/S"),Ug=s("wiGx"),Bg=s("ttnr");const xg={screen:Ug.a.Hidden,error:Ng.b.NO_ERROR,progress:0,totalProgress:0,numOfSyncedConv:0,popupVisible:!1,startSyncTime:0,closing:!1,syncingConversation:null};Object(ko.b)(Ug.b)(Pg=Reflect.metadata("design:type",Function)(Pg=Reflect.metadata("design:paramtypes",[])(Pg=class{constructor(){this.progressRecording=void 0,this.downloadBackupTime=void 0,this.state=Object(f.a)({},xg),this.name="sync-message-ui",this.key="window_id",this.progressRecording=new Map,this.initialRecordProgress(),this.downloadBackupTime=null}initialRecordProgress(){this.progressRecording.set(Ug.a.DownloadingBackup,0),this.progressRecording.set(Ug.a.DecryptingBackup,0),this.progressRecording.set(Ug.a.SyncInProgress,0)}recordProgress(e){const t=this.state.screen,s=e=>e>100?100:e;switch(t){case Ug.a.DownloadingBackup:this.progressRecording.set(t,s(e));break;case Ug.a.DecryptingBackup:this.progressRecording.set(Ug.a.DownloadingBackup,100),this.progressRecording.set(t,s(e));break;case Ug.a.SyncInProgress:this.progressRecording.set(Ug.a.DownloadingBackup,100),this.progressRecording.set(Ug.a.DecryptingBackup,100),this.progressRecording.set(t,s(e))}}calculateTotalProgressTransfer(){const e=this.state.screen,t=this.progressRecording.get(Ug.a.DownloadingBackup)||0,s=this.progressRecording.get(Ug.a.DecryptingBackup)||0,i=this.progressRecording.get(Ug.a.SyncInProgress)||0,n=(e,t)=>{let s=0;switch(t){case Ug.a.DownloadingBackup:s=Bg.a.getPercentDownload();break;case Ug.a.DecryptingBackup:s=Bg.a.getPercentDecrypt();break;case Ug.a.SyncInProgress:s=Bg.a.getPercentRestore()}return Math.round(e*s/100)};switch(e){case Ug.a.DownloadingBackup:return n(t,e);case Ug.a.DecryptingBackup:return n(t,Ug.a.DownloadingBackup)+n(s,e);case Ug.a.SyncInProgress:return n(t,Ug.a.DownloadingBackup)+n(s,Ug.a.DecryptingBackup)+n(i,e);default:return 0}}showPopup(){this.setState((e=>{e.popupVisible=!0}))}setSyncingConversation(e){this.setState((t=>{t.syncingConversation=e}))}hidePopup(){this.setState((e=>{e.popupVisible=!1}))}hideAllUI(){this.setState((e=>{e.screen=Ug.a.Hidden,e.closing=!1}))}showError(e){this.setState((t=>{t.error=e,t.screen=Ug.a.Error,t.syncingConversation=null}))}showSuggestNewSync(e){this.setState((t=>{t.screen=Ug.a.SuggestNewSync,t.popupVisible=e}))}showSuggestResume(){this.setState((e=>{e.screen=Ug.a.SuggestResume,e.popupVisible=!1}))}showSyncGuide(){this.setState((e=>{e.screen=Ug.a.SyncGuide,e.popupVisible=!0}))}showWaitForBackup(){this.setState((e=>{e.screen=Ug.a.WaitForBackup}))}showMobileIdleInBackup(){this.setState((e=>{e.screen=Ug.a.MobileIdleInBackup}))}showDownloadingBackup(){this.setDownloadBackupTime(performance.now()),this.setState((e=>{e.screen=Ug.a.DownloadingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showDecryptingBackup(){this.setState((e=>{e.screen=Ug.a.DecryptingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showInProgress(){this.setState((e=>{e.screen=Ug.a.SyncInProgress,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showCloseNotice(){this.setState((e=>{e.closing=!0}))}showSuccessMessage(){this.setState((e=>{e.screen=Ug.a.SyncSuccess,e.syncingConversation=null}))}showWaitForNetwork(){this.setState((e=>{e.screen=Ug.a.WaitForNetwork}))}setProgress(e){this.recordProgress(e),this.setState((t=>{t.progress=e,t.totalProgress=this.calculateTotalProgressTransfer()}))}setNumOfSyncedConv(e){this.setState((t=>{t.numOfSyncedConv=e}))}resetStartSyncTime(){this.setState((e=>{e.startSyncTime=Date.now()}))}clearError(){this.setState((e=>{e.error=Ng.b.NO_ERROR}))}getStartSyncTime(){return this.state.startSyncTime}getCurrentError(){return this.state.error}getCurrentScreen(){return this.state.screen}getPopupVisible(){return this.state.popupVisible}setDownloadBackupTime(e){this.downloadBackupTime=e}getDownloadBackupTime(){return this.downloadBackupTime}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(kg.a)(this.state,e);this.state!==t&&(this.state=t,Object(hs.h)(this.name,"current"))}})||Pg)||Pg);var Gg,zg=s("cPHW");let Vg=i.ModuleContainer.injectable()(Gg=class{start(){}isEnable(){return!1}canSync(){return Ng.a.DISABLED}delayedSuggestSync(){throw new Error("Method not implemented.")}suggestSync(){throw new Error("Method not implemented.")}suggestResume(){throw new Error("Method not implemented.")}sync(){throw new Error("Method not implemented.")}resume(){throw new Error("Method not implemented.")}cancel(){throw new Error("Method not implemented.")}confirmCancelSyncInSuggestingPopup(){throw new Error("Method not implemented.")}cleanupInMobileBusyBackup(){throw new Error("Method not implemented.")}closeCancelSyncInSuggestingPopup(){throw new Error("Method not implemented.")}pause(){throw new Error("Method not implemented.")}retry(){throw new Error("Method not implemented.")}rejectSuggest(){throw new Error("Method not implemented.")}showSuggestPopup(){throw new Error("Method not implemented.")}closeSuggestPopup(){throw new Error("Method not implemented.")}setRequestBackupTimeout(){throw new Error("Method not implemented.")}setMobileTransferConfirmTimeout(){throw new Error("Method not implemented.")}clearRequestBackupTimeout(){throw new Error("Method not implemented.")}setAutoCloseSuccessTimeout(){throw new Error("Method not implemented.")}clearAutoCloseSuccessTimeout(){throw new Error("Method not implemented.")}resendRequest(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}hideProgress(){throw new Error("Method not implemented.")}handleCtrlEvents(){}handleTransferAfterLoginCtrlEvents(){}makeMobileIdle(){throw new Error("Method not implemented.")}makeMobileActive(){throw new Error("Method not implemented.")}set tempKeySource(e){throw new Error("Method not implemented.")}get tempKeySource(){throw new Error("Method not implemented.")}})||Gg;i.ModuleContainer.registerSingleton(zg.a,Vg);var Hg=s("Erqw");const{setTimeoutUnlimited:Wg,clearTimeoutUnlimited:$g}=function(e={}){var t,s;const i=null!==(t=e.step)&&void 0!==t&&t?1e4:36e5,n=null!==(s=e.registry)&&void 0!==s?s:{};return{setTimeoutUnlimited:(e,t,...s)=>{const a=(e=>{var t;const s=e.step,i=e.registry;let n=null!==(t=e.timeout)&&void 0!==t?t:0;const a=e.callback,r=e.args,o=performance.now()+n;let l;function c(){let e=Math.min(o-performance.now(),s);return performance.now()>o?i[l]=setTimeout(a,0,r):i[l]=setTimeout(c,e),i[l]}return function(){let e=Math.min(o-performance.now(),s);return l=setTimeout(c,e),i[l]=l,l}()})({step:i,registry:n,callback:e,timeout:t,args:s});return a},clearTimeoutUnlimited:e=>{(e=>{const t=e.id,s=e.registry;clearTimeout(s[t]),delete s[t]})({id:e,registry:n})}}}({registry:{}});var Kg,qg=s("1p+n"),Qg=s("UYft"),Zg=s("AULX");Object(i.injectable)()(Kg=Object(i.singleton)(Zg.a)(Kg=Object(Je.g)()(Kg=Object(Je.e)()(Kg=function(e,t){return Object(i.inject)(le)(e,void 0,0)}(Kg=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(Kg=Reflect.metadata("design:type",Function)(Kg=Reflect.metadata("design:paramtypes",[void 0===oe?Object:oe,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Kg=class{constructor(e,t){this.kvCacheFactory=e,this.loggerFactory=t,this._logger=void 0,this._authEvent=void 0,this.__cache=void 0,this._renewRegistry={},this.updateEmitter=new qg.a,this._logger=this.loggerFactory.createZLogger("feat",["group-link"])}onAuthenticated(e){this._authEvent=e}_makeCache(){if(!this._authEvent)throw new Error("Not authenticated");return this.kvCacheFactory.createCache(`group-link-v3-${this._authEvent.getSession().userId}`,{maxSize:50})}get _cache(){return this.__cache||(this.__cache=this._makeCache()),this.__cache}_scheduleRenew(e,t){if(this._clearRenewSchedule(e),!t.enabled)return this;if(!mi.default.groupLink.enableScheduleRenew)return this._logger.debug(["_scheduleRenew skipped, enableScheduleRenew:",mi.default.groupLink.enableScheduleRenew]),this;let s=t.expirationDate-yn.default.getTimeNow(),i=Wg((()=>{this._clearRenewSchedule(e),this._emitGroupLinkUpdated(e,!0)}),s);return this._renewRegistry[e]=()=>{$g(i),delete this._renewRegistry[e]},this}_clearRenewSchedule(e){var t,s;return null===(t=(s=this._renewRegistry)[e])||void 0===t||t.call(s),this}onDispose(){this._authEvent=void 0,this.__cache=void 0}async _getFromCache(e){if(!mi.default.groupLink.enableCache)return void this._logger.debug(["cache skipped, enableCache:",mi.default.groupLink.enableCache]);e=Jg(e);let t=await this._cache.getItem(e);if(t){if(function(e){if(!e)return!1;let{data:t,meta:s}=e;if(!t)return!1;if(!s)return!1;if(Hg.a.isOverflowAtTime(s.ts))return!1;const i=yn.default.getTimeNow();if(s.ts+mi.default.groupLink.maxCacheDuration<i)return!1;if(t.enabled&&t.expirationDate<i)return!1;return!0}(t))return t.data;await this._cache.removeItem(e)}}async _fetchAndPutToCache(e,t){const s=yn.default.getTimeNow(),i=await t(),n={enabled:i.enabled,expirationDate:i.expiration_date,link:i.link};let a={ts:s};return await this._cache.setItem(e,{data:n,meta:a}),n}async _deleteCache(e){await this._cache.removeItem(e)}async getGroupLinkDetail(e,t=!1){this._logger.zsymb(12,"u4zkyy",["getting",e]);let s=Jg(e),i=await this._getFromCache(s);if(i&&!t)return this._logger.zsymb(12,"kjBAF2",["cache hit",s]),this._scheduleRenew(s,i),i;this._logger.zsymb(12,"td8lW4",["fetching",s]);let n=ho.default.getRawGroupId(s);let a=await this._fetchAndPutToCache(s,(()=>uo.default.getGroupLinkDetail(n))).catch(Qg.a.catch((e=>this._logger.zsymb(18,"yzBUAs",["get failed",s,e]))));return this._scheduleRenew(s,a),t&&await this._emitGroupLinkUpdated(e),this._logger.zsymb(12,"hY8qlT",["done",s]),a}async renewGroupLink(e){this._logger.zsymb(12,"hyJiNc",["renewing",e]);let t=Jg(e),s=ho.default.getRawGroupId(t);let i=await this._fetchAndPutToCache(t,(()=>uo.default.renewGroupLink(s))).catch(Qg.a.catch((e=>this._logger.zsymb(18,"M1s5TI",["renew failed",t,e]))));return this._scheduleRenew(t,i),await this._emitGroupLinkUpdated(t),this._logger.zsymb(12,"B_xYDm",["renew done",e]),i}async disableGroupLink(e){this._logger.zsymb(12,"FTvqOS",["disabling",e]);let t=Jg(e),s=ho.default.getRawGroupId(t);await uo.default.disableGroupLink(s).catch(Qg.a.catch((e=>this._logger.zsymb(18,"-UC9v6",["disable failed",t,e])))),await this._emitGroupLinkUpdated(t,!0),this._logger.zsymb(12,"VQlv6W",["disable done",e])}async _emitGroupLinkUpdated(e,t=!1){const s=Jg(e);t&&await this._deleteCache(s),this.updateEmitter.emit(s,s),this.updateEmitter.emit("*",s)}async emitGroupLinkUpdated(e){return await this._emitGroupLinkUpdated(e,!0)}})||Kg)||Kg)||Kg)||Kg)||Kg)||Kg)||Kg);function Jg(e){return R.GROUPID_PREFIX+ho.default.getRawGroupId(e)}var Yg,Xg=s("TO4U");const em={loading:!0};Object(ko.b)(Xg.a)(Yg=function(e,t){return Object(i.inject)(Zg.a)(e,void 0,0)}(Yg=Reflect.metadata("design:type",Function)(Yg=Reflect.metadata("design:paramtypes",[void 0===Zg.a?Object:Zg.a])(Yg=class e{constructor(e){this._groupLink=e,this.type=void 0,this.name="group-link-ui",this.key="group-link-ui",this._cache=new he.default({maxSize:50}),this._handleUpdate=e=>{const t=tm(e);this._cache.delete(t),this._startFetchAndSetToSession(t)},this._groupLink.updateEmitter.on("*",this._handleUpdate)}init(){}getItem(e,t){if(!e.key.startsWith(R.GROUPID_PREFIX))return;const s=tm(e.key);this._startFetchAndSetToSession(s);let i=this._cache.get(s);return i||em}static shouldSignal(e,t){var s,i,n,a,r,o;return!e||(null==e||e.error,null==t||t.error,null==t||null===(s=t.data)||void 0===s||s.enabled,null==t||null===(i=t.data)||void 0===i||i.enabled,null!=e&&null!==(n=e.data)&&void 0!==n&&n.enabled&&null!=t&&null!==(a=t.data)&&void 0!==a&&a.enabled&&(null==e||null===(r=e.data)||void 0===r||r.link,null==t||null===(o=t.data)||void 0===o||o.link),!1)}signalIfNeeded(t,s,i){e.shouldSignal(s,i)&&Object(hs.h)(this.name,t)}_startFetchAndSetToSession(e){const t=this._cache.get(e);setTimeout((()=>{this._groupLink.getGroupLinkDetail(e).then((s=>{const i={loading:!1,data:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)})).catch((s=>{const i={loading:!1,error:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)}))}),0)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Yg)||Yg)||Yg);function tm(e){return R.GROUPID_PREFIX+ho.default.getRawGroupId(e)}var sm=s("akSd"),im=s("xQyS"),nm=s("fqRP"),am=s("L904"),rm=s("EiAw"),om=s("IoRb");let lm;class cm{static get instance(){return lm||(lm=new cm),lm}get _eventStore(){return this.__eventStore||(this.__eventStore=s("emRR").default),this.__eventStore}constructor(){this.__eventStore=void 0,this._emitConversationDeleted=e=>{let t,s,i=[];if(e.ok?({conversation:t,toUid:s,allItems:i}=e.value):({conversation:t,toUid:s,allItems:i}=e.error),t)return;if(i.length&&i.every((e=>e.ttlType===Bd.a.Quote)))return;const n={type:Ai.FetchActions.DELETE_CONVERSATION,payload:s};this._eventStore.dispatch(n),ts.a.dispatch(n),Fi.default.send(n.type,n.payload)},this._emitDeletedMsgs=e=>{let t,s;e.ok?({allItems:s,conversation:t}=e.value):({allItems:s,conversation:t}=e.error);const i=s.filter((e=>e.ttlType===Bd.a.Message)),n=i.map((e=>e.msgId));Object(rm.a)({msgId:n,conversation:t,messages:i.map((e=>JSON.parse(JSON.stringify(e)))),trackingSource:"ttlPrune"})},this._emitUpdateUnread=(e,t)=>{let s,i=[];e.ok?({toUid:s,allItems:i}=e.value):({toUid:s,allItems:i}=e.error),Co.a.UnreadDataManager.updateUnreadTTLConversation(s,i,null==t?void 0:t.get(s))},this.emitPerConversation=async(e,t)=>{let s=await Object(im.a)(this._emitConversationDeleted,e);s.ok||Object(om.a)("_emitConversationDeleted failed",s.error),s=await Object(im.a)(this._emitDeletedMsgs,e),s.ok||Object(om.a)("_emitDeletedMsgs failed",s.error),s=await Object(im.a)(this._emitUpdateUnread,e,t),s.ok||Object(om.a)("_emitUpdateUnread failed",s.error)}}}var dm,um=s("LA52"),hm=s("GSaP");const gm=e=>null==e?void 0:e.toUid,mm=e=>null!=e&&e.ok?"success":"error";Object(i.singleton)(um.a)(dm=Reflect.metadata("design:type",Function)(dm=Reflect.metadata("design:paramtypes",[])(dm=class{constructor(){this._pruning=!1,this._task=void 0,this._ttl=i.ModuleContainer.resolve(nm.a),this._logger=void 0,this.dispose=()=>{},this.prune=async()=>this._pruning?await this._task:(this._pruning=!0,this._task=this._pruneFromDB(),this._pruning=!1,this._task),this._pruneFromDB=async()=>{const e=yn.default.getTimeNow();this._logger.zsymb(0,"MBP57u","Pruner execute task",e);const t=await Object(im.b)(this._ttl.getExpireItemsBefore,e);if(!t.ok)return this._logger.zsymb(18,"soyVPj","Pruner getExpireItemsBefore failed",t.error),{ok:!1,error:null};const s=t.ok?t.value:[];return await this._pruneTTLItems(s)},this._pruneByMsgsBatch=[],this.pruneByMsgs=async e=>{const t=Object(mo.a)(e);this._pruneByMsgsBatch.push(...t),setTimeout((()=>{const e=this._pruneByMsgsBatch;this._pruneByMsgsBatch=[],e.length&&(this._logger.zsymb(15,"mFbCrf",["running a batch {}","6DkPwC"],e.length),this._pruneByMsgs(e))}),2e3)},this._pruneByMsgs=async e=>{const t=yn.default.getTimeNow();this._logger.zsymb(15,"DYL__F",["deriving {}","yGSyeT"],e.length);let s=hm.a.createFromCurrentSession().deriveTTLItems(e);this._logger.zsymb(15,"TuHTW6",["ttlItems count: {}","Cx5SkY"],s.length),s=s.filter((e=>{const s=+e.expireOn+mi.default.ttl.enable_delete_on_filter_minimum_overtime;return!isNaN(s)&&s<t})),this._logger.zsymb(15,"x1OE5P",["expired count: {}","U9l8my"],s.length),s=s.filter((e=>!this._hasPruneMsgCache(e))),s.forEach((e=>{this._setPruneMsgCache(e)})),this._logger.zsymb(15,"QnM0m2",["no cache count: {}","kDDHgw"],s.length),s.length?(this._logger.zsymb(3,"N2K9lE",["pruning {}, {}","r7FC7N"],s.length,s),await this._deleteMsgsAndEmit(s)):this._logger.zsymb(15,"BZm8fO",["no items to prune","PI0O81"])},this._pruneMsgCache=new he.default({maxSize:1e4}),this._pruneTTLItems=async e=>{const t=e.map((e=>[e.msgId,e.ttlType]));this._logger.zsymb(3,"IKz2-B",["pruning {} items: {}","sNN9Kb"],t.length,t),await this._deleteMsgsAndEmit(e);const s=await Object(im.b)(this._ttl.deletes,t);return s.ok||this._logger.zsymb(18,"-8OAZG","Pruner deletes ttl failed",s.error),s},this._retryErrorMsgsIfNeeded=e=>{for(const s of e){var t;if(s.ok)continue;const{errorItems:e,toUid:i}=s.error;this._logger.zsymb(0,"hAJ874","_retryErrorDelete "+i,null==e||null===(t=e[0])||void 0===t?void 0:t.msgId),setTimeout((()=>{Object(im.b)(this._deleteMsgsBelongToTTLItems,e)}),5e3)}},this._retryErrorDelete=e=>setTimeout((async()=>{const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(im.b)(this._deleteMsgsBelongToTTLItems,e);!s.ok&&this._logger.zsymb(18,"tyuj1Z","Pruner _retryErrorDelete",s.error),s.ok&&this._emitPruneResult(s.value,t)}),5e3),this._emitPruneResult=async(e,t)=>{for(const s of e)await Object(im.b)(cm.instance.emitPerConversation,s,t)},this._deletePerConversation=async(e,t=[])=>{var s,i,n,a,r,o,l,c,d;const u=await Object(im.b)(vd.b.vanishMessages,e,t);if(!u.ok)return{ok:!1,error:{toUid:e,allItems:[],errorItems:t,successItems:[]}};const h=null===(s=u.value.vanish)||void 0===s?void 0:s[0],g=null===(i=u.value.quote)||void 0===i?void 0:i[0];if(!h&&!g)return{ok:!1,error:{toUid:e,conversation:{},allItems:[],errorItems:t,successItems:[]}};const m=null===(n=u.value.vanish)||void 0===n||null===(a=n[0])||void 0===a||null===(r=a.conv)||void 0===r?void 0:r.conversation;let p=[...null!==(o=null===(l=u.value.vanish)||void 0===l?void 0:l.map((e=>e.res)).flat())&&void 0!==o?o:[],...null!==(c=null===(d=u.value.quote)||void 0===d?void 0:d.flat())&&void 0!==c?c:[]];p=p.filter((e=>e));const{success:f=[],error:v=[]}=Object(am.a)(p,mm),b=f.map((e=>e.info)),I=v.map((e=>e.info)),y=[...b,...I];return I.length?{ok:!1,error:{toUid:e,conversation:m,allItems:y,successItems:b,errorItems:I}}:{ok:!0,value:{toUid:e,conversation:m,allItems:y,successItems:b}}},this._deleteMsgsBelongToTTLItems=async e=>{const t=Object(am.a)(e,gm),s=Object.keys(t).map((async e=>(Object(im.b)(this._sideEffect,e,t[e]),this._deletePerConversation(e,t[e]))));return await Promise.all(s)},this._sideEffect=async(e,t=[])=>setTimeout((async()=>{const s=await Object(im.b)(this._cancelSendingPerConversation,e,t);s.ok||this._logger.zsymb(18,"vnEVLf","cancelSendingPerConversation failed",s.error);const i=await Object(im.b)(this._syncDeletePerConversation,e,t);i.ok||this._logger.zsymb(18,"F39Pg8","syncDeletePerConversation failed",i.error)}),0),this._cancelSendingPerConversation=async(e,t=[])=>{t.forEach((t=>Object(im.b)((()=>{}),e,null==t?void 0:t.cliMsgId)))},this._syncDeletePerConversation=async(e,t=[])=>{if(!mi.default.ttl.enable_sync_delete)return;const s=t=>{+t.msgId&&Object(sm.e)(e,{cliMsgId:t.cliMsgId,msgId:t.msgId,sendDttm:t.sendDttm,toUid:e,fromUid:t.fromUid})};t.forEach((e=>Object(im.b)(s,e)))},this._pruning=!1,this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("utils",["ttl","destructor","pruner"])}_getPruneMsgKey(e){return e?`${e.msgId}|${e.ttlType}`:""}_hasPruneMsgCache(e){return this._pruneMsgCache.has(this._getPruneMsgKey(e))}_setPruneMsgCache(e){this._pruneMsgCache.set(this._getPruneMsgKey(e),void 0)}async _deleteMsgsAndEmit(e){const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(im.b)(this._deleteMsgsBelongToTTLItems,e);s.ok||(this._logger.zsymb(18,"rLnqC5","Pruner","deleteMessages failed"),this._retryErrorDelete(e)),s.ok&&this._retryErrorMsgsIfNeeded(s.value),s.ok&&this._emitPruneResult(s.value,t)}})||dm)||dm);function pm(e,t){return e.reduce(((e,s,i,n)=>(e[t(s,i,n)?0:1].push(s),e)),[[],[]])}var fm;const vm=R.MessageConstants.MAX_MSG_ID;Object(i.singleton)(nm.a)(fm=Reflect.metadata("design:type",Function)(fm=Reflect.metadata("design:paramtypes",[])(fm=class{constructor(){this._logger=void 0,this.dispose=()=>{},this.correctTTLItemEntity=e=>{function t(e,t){return null==e?t:e}const s=Object(f.a)({},e);return s.beginTime=t(s.beginTime,0),s.cliMsgId=t(s.cliMsgId,""),s.expireOn=t(s.expireOn,Date.now()),s.fromUid=t(s.fromUid,""),s.mediaType=t(s.mediaType,""),s.msgId=t(s.msgId,""),s.sendDttm=t(s.sendDttm,"")+"",s.serverTime=t(s.serverTime,"")+"",s.toUid=t(s.toUid,""),s.ttl=t(s.ttl,0),s.ttlType=t(s.ttlType,""),s},this._safePut=async e=>{const t=[],s=[],i=tt.default.getInstance();for(const a of e)try{const e=this.correctTTLItemEntity(a);await i.MsgInfo.TTLItem.insert(e,{replace:!0}),t.push(a)}catch(n){s.push([a,n])}return[t,s]},this.putMsgs=async e=>{let t=e.map((e=>ym(e)));const[s,i]=pm(t,(e=>e.ok)),n=s.map((e=>e.value));let a=[],r=[];[r,a]=await this._safePut(n);const o=i.map((e=>e.error));return a.lastItem||o.length?{ok:!1,error:{invalidItems:o,errorItems:a}}:{ok:!0,value:r}},this.deletes=e=>tt.default.getInstance().MsgInfo.TTLItem.deleteMulti(e),this.getExpireItemsBefore=async(e,t)=>{const s=t?{from:[t.expireOn,t.toUid,t.msgId,t.ttlType],to:[e,R.MessageConstants.MAX_CONVERSATION_ID,vm,Bd.b],excludeFrom:!1,excludeTo:!0}:{to:[e,R.MessageConstants.MAX_CONVERSATION_ID,vm,Bd.b],excludeTo:!1},i={limit:50,index:"expireOn_toUid_pk",useLGKeyRange:!0},n=tt.default.getInstance();return await n.MsgInfo.TTLItem.getAll(s,i)},this.getYoungestExpiredItem=async()=>{const e={to:[Number.MAX_VALUE,R.MessageConstants.MAX_CONVERSATION_ID,vm,Bd.b],excludeTo:!0},t=tt.default.getInstance();return(await t.MsgInfo.TTLItem.getAll(e,{limit:1,index:"expireOn_toUid_pk",useLGKeyRange:!0}))[0]},this.getMappedMsgsByConvIdFromTTLItems=async e=>{const t=Ld.b.messageCache;let s;return t&&(s=await t.getMappedMessagesByConvIdAsync(e)),s},this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("utils",["ttl","destructor","ttl"])}})||fm)||fm);const bm=e=>"number"==typeof e?String(e):e,Im=[Bd.a.Message,Bd.a.Quote],ym=(e={})=>{const t=Object(f.a)({},e);return t.cliMsgId=bm(t.cliMsgId),t.cliMsgId?(t.fromUid=bm(t.fromUid),t.fromUid?(t.toUid=bm(t.toUid),t.toUid?(t.msgId=bm(t.msgId),s=t.ttlType,Im.includes(s)?(t.expireOn=+t.expireOn,"number"!=typeof t.expireOn?{ok:!1,error:e}:{ok:!0,value:t}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e};var s};var _m=s("oOjv"),Cm=s("bB26"),Om=s("lteq");const Em={[Go.c]:{}};i.ModuleContainer.registerSingleton(_m.b,class{constructor(){this.state=Em,this.animationControllers=new Map,this._manuallyOff=!1,this.name=_m.a,this.key="convId",this.isFeatEnabled=()=>!this._manuallyOff&&mi.default.preview_msg_time.enable,this.state=Em}offFeature(){this._manuallyOff=!0}enableFeature(){this._manuallyOff=!1}getAnimController(e){if(!this.isFeatEnabled())return null;if(!this.animationControllers.has(e)){const t=new Cm.a(e);this.animationControllers.set(e,t)}return this.animationControllers.get(e)||null}setScrollDirection(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.setScrollDirection(t)}hasNewMsgInView(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasNewMsgInView(t)}hasViewOverflowMsg(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasViewOverflowMsg(t)}hitBottom(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hitBottom(t)}triggerActiveScroll(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.triggerActiveScroll(t)}onChangeConversation(e){var t;const s=this.getAnimController(e);null==s||s.resetAnimation(),null===(t=Om.a.getInViewController(e))||void 0===t||t.resetPreviewTimestamp(),Il.a.onNewSession(e)}clearAnimations(e){const t=this.getAnimController(e);null==t||t.clearAnimations()}onMouseEnterPreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.pause())}onMouseLeavePreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.resume())}setTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setTopMost(t,s)}setSecondTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setSecondTopMost(t,s)}init(){}getItem(e){return this.state[e.key]}getList(e){return Object.keys(this.state)}onGetItemFailure(e){}onGetListFailure(e){}});const Mm=Object(i.define)("IMAGE_REGENERATOR_NAME");var Sm=s("AqnK"),Tm=s("X2DH"),wm=s("3Rxw"),Rm=s("xwfN"),Lm=s("V2fg"),Dm=s("RUx3"),Am=s("DhYn"),Fm=s("Bvld"),jm=s("bavj"),Pm=s("KgJV");var km,Nm=s("QmNg"),Um=s("ACSi"),Bm=s("KkZn"),xm=s("TjvF");let Gm=Object(i.injectable)()(km=class{constructor(){this.MAX_REGEN_TASKS=10,this.MAX_MEMORY_USAGE=52428800,this.MetadataCache=new he.default({maxSize:100,maxAge:3e5}),this.requests=[],this.availableTask=this.MAX_REGEN_TASKS,this.totalMemoryUsage=0,this.regenImageFromLocal=async e=>{var t,s;const{getSourcePath:i,getGenThumbPath:n}=e;Object(Q.a)(!!i,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(Q.a)(!!n,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const a=await i(),r=this.checkSize(a);await this.acquireTaskLock(r);const o=`${null==e||null===(t=e.log)||void 0===t?void 0:t.mediaId}-${null==e||null===(s=e.log)||void 0===s?void 0:s.entry}`;let l=Sm.n.oriUrl,c="";e.sizes||(e.sizes={originalWidth:void 0,originalHeight:void 0,maxDimension:void 0});try{var d;let t={type:"",width:e.sizes.originalWidth,height:e.sizes.originalHeight,size:0};if(void 0!==this.MetadataCache.peek(a))t=this.MetadataCache.get(a);else{const s=$znode.path.extname(a);if(Object(Um.c)(e.sizes.originalWidth)&&Object(Um.c)(e.sizes.originalHeight)&&s)t.size=r,t.type=s.replace(".","");else{const s=await $zFileManager.getFileArrayBuffer(a);t=await Object(Pm.a)(s),t.size=r,e.sizes.originalWidth=t.width,e.sizes.originalHeight=t.height}this.MetadataCache.set(a,t)}Lm.a.log(null===(d=e.log)||void 0===d?void 0:d.clientId,{msgFormat:`image/${t.type}`,originalSize:r,originalWidth:t.width,originalHeight:t.height}),l=function(e,t,s=mi.default.image_loader.max_original){const i=mi.default.image_loader.max_original,n=mi.default.image_loader.max_hd,a=mi.default.image_loader.max_normal,r=mi.default.image_loader.max_thumb,o=[{quality:Sm.n.oriUrl,min:n,max:i},{quality:Sm.n.hdUrl,min:a,max:n},{quality:Sm.n.normalUrl,min:r,max:a},{quality:Sm.n.thumbUrl,min:1,max:r}].sort(((e,t)=>t.max-e.max)),[l,c]=Object(jm.d)(e,t,s,s,!1);let d=Sm.n.oriUrl;for(let u of o){const[e,t,s]=Object(jm.d)(l,c,u.max,u.max,!1);if(s)break;d=u.quality}return d}(t.width,t.height,e.sizes.maxDimension),c=await n();const s=new Nm.b(c);s.q=l,c=s.getGenPath();if(c&&Object(Bm.a)(c)){if(Object(Um.b)(e.getOldLocalPathForMigration)){let t=await(null==e?void 0:e.getOldLocalPathForMigration());t=t?this._toJpeg(t):t,t&&Object(Bm.a)(t)&&(zconsole.zsymb(3,"orHDvi",["MediaDiskFetcher: delete existed old. no regen","V9tbFx"],t,"->",c),await this._deleteLocalSource(t))}return Sm.l.Success({mediaURL:c})}if(Object(Um.b)(e.getOldLocalPathForMigration)){let t=await e.getOldLocalPathForMigration();t=t?this._toJpeg(t):t,t&&Object(Bm.a)(t)&&(zconsole.zsymb(3,"e-j925",["MediaDiskFetcher: delete existed old. regen","6xFw_7"],t,"->",c),await this._deleteLocalSource(t))}const[i,u,g]=Object(jm.d)(t.width,t.height,e.sizes.maxDimension,e.sizes.maxDimension,!1);if(!g&&"jxl"!==t.type)return c=a,Sm.l.Success({mediaURL:a});xm.b.getInstance().record(xm.a.RenderPhotoHighQuality,{logId:o,resizeWidth:i,resizeHeight:u});const m=Object(f.a)(Object(f.a)({},e),{},{getGenThumbPath:()=>Promise.resolve(c),metadata:t,output:{width:i,height:u}});try{const e=await this.regenImageFromLocalUsingNativelibs(m);return fi.default.increaseSuccess(Dm.a,0,0),fi.default.increaseSuccess(Dm.c,0,0),e}catch(h){fi.default.increaseFailed(Dm.a,0,0,Object(Dm.k)(),Date.now())}try{const e=await this.regenImageFromUrlUsingNativeElectron(m);return fi.default.increaseSuccess(Dm.c,0,0),e}catch(h){throw h}}catch(h){throw fi.default.increaseFailed(Dm.c,0,0,Object(Dm.i)(),Date.now()),h}finally{try{var u;const t=this.checkSize(c);xm.b.getInstance().record(xm.a.RenderPhotoHighQuality,{logId:o,resizeSize:t});const s=l===Sm.n.normalUrl,i=l===Sm.n.thumbUrl;Lm.a.endLog(null===(u=e.log)||void 0===u?void 0:u.clientId,{regenStatus:1,localSize:t,hdSize:t,normalSize:s?t:void 0,thumbSize:i?t:void 0}),this.releaseTaskLock(r)}catch(h){zconsole.zsymb(18,"UfDk-4","ImageRegeneratorImpl: regenImageFromLocal finally error",h)}}},this.regenImageFromLocalUsingNativelibs=async e=>{try{const{getSourcePath:r,getGenThumbPath:o,sizes:l={width:void 0,height:void 0},removeOriginalAfterGenerate:c=!1,priority:d=-1}=e;Object(Q.a)(!!r,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(Q.a)(!!o,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const u=await o();if($znode.fs.existsSync(u))return Sm.l.Success({mediaURL:u});const h=await r(),g="jxl"===e.metadata.type;try{if(Am.a.jxl.version===Fm.a.V2&&g){var t,s;zconsole.zsymb(14,"0r_w-L","JXL: regen jxl using native libs",e);const i="number"==typeof(null==e||null===(t=e.sizes)||void 0===t?void 0:t.maxDimension)?(null==e||null===(s=e.sizes)||void 0===s?void 0:s.maxDimension)+1:void 0;await Object(Tm.b)(h,{tasks:[{width:e.sizes.originalWidth,height:e.sizes.originalHeight,outputPath:u,maxWidth:i,maxHeight:i}]},{priority:d})}else{const t=await $zFileManager.getFileArrayBuffer(h),s=new Blob([t]),i=await Object(wm.a)(s,{width:e.output.width,priority:d,quality:.9}),n=$znode.path.dirname(u);this.ensureDir(n),await $zFileManager.writeBufferToPath(u,await i.arrayBuffer())}}catch(n){var i;throw Lm.a.endLog(null===(i=e.log)||void 0===i?void 0:i.clientId,{regenStatus:0}),n}if(c)try{$znode.fs.unlinkSync(h)}catch(a){}return Sm.l.Success({mediaURL:u})}catch(n){throw n}},this.regenImageFromUrlUsingNativeElectron=async e=>{try{const{getSourcePath:n,getGenThumbPath:a,removeOriginalAfterGenerate:r=!1}=e;Object(Q.a)(!!n,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(Q.a)(!!a,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const o=await a();if($znode.fs.existsSync(o))return Sm.l.Success({mediaURL:o});const l=await n();let c=null;try{const t=await $zFileManager.getFileArrayBuffer(l),s=new Blob([t]),i=await createImageBitmap(s);c=document.createElement("canvas"),c.width=e.output.width,c.height=e.output.height;const n=c.getContext("2d");null==n||n.drawImage(i,0,0,e.output.width,e.output.height);const a=await new Promise(((e,t)=>{c.toBlob((s=>{s?e(s):t(new Error("Failed to convert canvas to blob"))}),"image/jpeg",.9)})),r=$znode.path.dirname(o);this.ensureDir(r),await $zFileManager.writeBufferToPath(o,await a.arrayBuffer())}catch(s){throw zconsole.error("[JXL]: regen erorr",s),s}finally{var t;const e=null===(t=c)||void 0===t?void 0:t.getContext("2d");e&&e.clearRect(0,0,c.width,c.height),c&&(c.width=0,c.height=0)}if(r)try{$znode.fs.unlinkSync(l)}catch(i){}return Sm.l.Success({mediaURL:o})}catch(s){throw s}},this.ensureDir=e=>{},this.createDeferred=(e=0)=>{let t,s;return{promise:new Promise(((e,i)=>{t=e,s=i})),resolve:t,reject:s,fileSize:e}},this.acquireTaskLock=async e=>{const t=this.createDeferred(e),s=this.availableTask<this.MAX_REGEN_TASKS;(this.availableTask<=0||this.totalMemoryUsage+e>this.MAX_MEMORY_USAGE&&s)&&(this.requests.push(t),await t.promise),this.totalMemoryUsage+=e,this.availableTask--},this.releaseTaskLock=e=>{if(this.availableTask=Math.min(this.MAX_REGEN_TASKS,this.availableTask+1),this.totalMemoryUsage=Math.max(0,this.totalMemoryUsage-e),this.availableTask>0&&this.requests.length>0){const e=this.requests[0],t=this.availableTask<this.MAX_REGEN_TASKS;if(e.fileSize+this.totalMemoryUsage<=this.MAX_MEMORY_USAGE||!t){this.requests.shift().resolve()}}},this.checkSize=e=>{try{return $znode.fs.statSync(e).size}catch(t){return 0}},this._deleteLocalSource=async e=>{if(e)try{await new Promise(((t,s)=>{$znode.fs.unlink(e,(i=>{i?(zconsole.zsymb(18,"HFbK5V","MediaDiskFetcher: deleteLocalSource error",e,i),s(i)):t(!0)}))}))}catch(t){zconsole.zsymb(15,"CTtryR",["MediaDiskFetcher: deleteLocalSource error","XFGCpL"],t)}else zconsole.zsymb(21,"_LRNeh",["MediaDiskFetcher: deleteLocalSource localPath cannot be null","5C2iFW"],e)},this._copySource=async(e,t,s=!0)=>{if(e&&t)try{const i=`${e}.tmp`;await new Promise(((t,s)=>{$znode.fsExtra.rename(e,i,(i=>{i?(zconsole.zsymb(18,"37eL-o","MediaDiskFetcher: migrateSource error",e,i),s(i)):t(!0)}))})),await $znode.fsExtra.copy(i,t,{dereference:!0,overwrite:!0}),s||await this._deleteLocalSource(i)}catch(i){zconsole.zsymb(15,"n3NnVF",["MediaDiskFetcher: migrateSource error","JvNagq"],i)}else zconsole.zsymb(21,"kuVcle",["MediaDiskFetcher: migrateSource oldPath and newPath cannot be null","6XjURY"],e,t)},this._toJpeg=(e,t="")=>{if(".jxl"===$znode.path.extname(e))return e.replace(/\.jxl$/,".jpg");if(t){const s=$znode.path.basename(e),i=$znode.path.dirname(e);return $znode.path.join(i,`${t}-${s}`)}return e}}})||km;i.ModuleContainer.registerSingleton(Mm,Gm);var zm=s("tDXj");const Vm=Object(i.define)("JIT_MEDIA_CODEC");var Hm;let Wm=Object(i.injectable)()(Hm=class{constructor(){this._blobURLMapping=new Map,this._conversationCache=new Map}async preload(e,t,s){let i=e;if(this._isHttpURL(e))try{if(this._blobURLMapping.has(e))return Sm.l.Success({mediaURL:e});const t=Object(ln.j)().toString(),s=await Object(ln.h)(t,e,ln.a.dev,void 0,{useDiskCache:!1});if(s.error)return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:s.error});i=s.data}catch(n){return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:n})}else if(this._isBlobURL(e)){if(this._blobURLMapping.has(e))return Sm.l.Success({mediaURL:e});if(!(await this.isBlobURLAlive(e)))return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:"blob url expired"})}return this._cache(i,t,s),Sm.l.Success({mediaURL:i})}async isBlobURLAlive(e,t){const s=null!=t&&t.document?t.document.createElement("img"):new Image;s.src=e;try{return await s.decode(),!0}catch(i){return!1}}async preloadImageDOM(e,t){let s=0,n=null,a=1,r=t&&"async"!==(null==t?void 0:t.mode)&&"auto"!==(null==t?void 0:t.mode)?"sync":"async";const o=e.src,l=null==o?void 0:o.endsWith("jxl"),c=(Am.a.jxl.enable_native_electron_jxl,!1);if(l&&!c)try{var d,u;const t=null===(d=e.rawSrc)||void 0===d||null===(u=d.replace("file://",""))||void 0===u?void 0:u.replace("zfile://",""),s=await i.ModuleContainer.resolve(Vm).decodeLocalImage(t);if(!s)throw new Error("JXL decode failed. Empty url");e.src=s}catch(h){zconsole.zsymb(21,"ghC39S",["Failed to decode JXL image","w2c8F9"],h)}if("async"===r){a=2;try{return await this._preloadImageAsync(e)}catch(h){s++,n=h}}try{return await this.preloadImageSync(e)}catch(h){s++,n=h}if(s===a)throw new Error(`preloadImageDOM failed ${n}`);return null}async _preloadImageAsync(e){try{const t=new Image;t.draggable=!1;for(const s in e)s&&e[s]&&t.setAttribute(s,e[s]);return await t.decode(),t}catch(t){throw t}}async preloadImageSync(e){const t=new Image;t.draggable=!1;for(const n in e)n&&e[n]&&t.setAttribute(n,e[n]);const s=new Promise(((e,s)=>{t.onload=e,t.onerror=s}));try{return await s,t}catch(i){throw i}}_cache(e,t,s){if(this._blobURLMapping.set(e,{blobURL:e,cacheMode:t,convId:s}),s){const t=this._conversationCache.get(s)||[];t.push(e),this._conversationCache.set(s,t)}}_isHttpURL(e){return e.startsWith("http")||e.startsWith("https")}_isBlobURL(e){return e.startsWith("blob")}})||Hm;i.ModuleContainer.registerSingleton(zm.a,Wm);var $m=s("UeuQ"),Km=s("XDVU");function qm(e){return e.startsWith("http")||e.startsWith("https")}function Qm(e){return e.startsWith("blob")}var Zm=s("tqrY");var Jm=s("Q8nW"),Ym=s("Ageb"),Xm=s("qvbK"),ep=s("5+PA"),tp=s("dog1"),sp=s("6e5J");const ip=(e,t)=>{if(!t)return e;const s=new URL(e);return s.pathname=`${t}${s.pathname}`,s.search=decodeURIComponent(s.search),s.href},np=new he.default({maxSize:300,maxAge:3e5}),ap=3;async function rp(e,t={}){var s;if("boolean"==typeof(null===(s=np.peek(e))||void 0===s?void 0:s.alive))return!0===np.get(e).alive;const{retries:i=ap,cacheResponse:n=!1,retryableErrorCodes:a=[]}=t,r=se((async e=>{try{return await ho.default.checkAlive(e),!0}catch(t){throw t}}),{min:5e5,max:1e3,retries:i,lastTryDelayTime:{min:5e3,max:1e4},shouldRetryOnError:async({error:e,currentState:t})=>(zconsole.debug((function(e){return e[0]})`checkAlive: should retry on error`,e,t),t.nTry!=ap||Array.isArray(a)&&a.length>0&&a.some((t=>t===e))),afterRetry:async({success:e,nTry:t})=>{const s=t===ap;zconsole.debug((function(e){return e[0]})`checkAlive: afterRetry`,{success:e,nTry:t,isLastTry:s})}});let o=!1;try{o=await r(e)}catch(l){zconsole.zsymb(18,"QrJ9r9","checkAlive with cache caught error",l)}return n&&np.set(e,{alive:o,contentLength:null,contentType:null}),o}class op{constructor(){this.aborted=void 0,this.aborted=!0}}class lp{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const i=()=>{this._aborted=!0,s(new op),this._abortController.signal.removeEventListener("abort",i)};this._abortController.signal.addEventListener("abort",i),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",i),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}}function cp(e,...t){return new lp(e,t)}class dp{constructor(e,t){this.taskId=e,this.executor=t}}class up{constructor(e,t){this.limit=void 0,this.runningTasks=void 0,this.taskQueue=void 0,this.taskMap=void 0,this.onTaskCompleted=void 0,this.isRunning=e=>this.runningTasks.has(e),this.abortTask=e=>{const t=this.taskMap.get(e);t&&(t.executor.abort(),this.removeTask(e))},this.limit=e,this.runningTasks=new Set,this.taskQueue=[],this.taskMap=new Map,this.onTaskCompleted=t||(()=>{})}addTask(e){this.runningTasks.has(e.taskId)||(this.taskMap.has(e.taskId)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e.taskId))),this.taskQueue.push(e),this.taskMap.set(e.taskId,e),this._tryToRunTasks())}removeTask(e){const t=this.taskMap.get(e);t&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e)),this.taskMap.delete(e)),this.runningTasks.has(e)&&(this.runningTasks.delete(e),t&&t.executor.abort())}_tryToRunTasks(){if(!(this.runningTasks.size>=this.limit))for(;this.runningTasks.size<this.limit&&this.taskQueue.length>0;){const e=this.taskQueue.pop();e&&this._runTask(e)}}_runTask(e){this.runningTasks.add(e.taskId),e.executor.promise.then((()=>{this._taskFinished(e.taskId)})).catch((()=>{this._taskFinished(e.taskId)}))}_taskFinished(e){this.removeTask(e),this._tryToRunTasks(),this.onTaskCompleted(e)}}var hp;let gp=Object(i.injectable)()(hp=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(hp=Reflect.metadata("design:type",Function)(hp=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(hp=class{constructor(e){this.Logger=void 0,this.BigFileTaskQueue=new up(1),this.BIG_FILE_THRESHOLD=10485760,this.fetch=async e=>{const t=await(s=e.source,void 0!==np.peek(s)?Promise.resolve(np.get(s)):new Promise(((e,t)=>{const i=new XMLHttpRequest;let n=s.replace("http://","https://");n=ho.default.removeE2eeProtocol(n),i.open("HEAD",n),i.responseType="arraybuffer",i.timeout=5e3,i.onload=()=>{const t={contentType:i.getResponseHeader("Content-Type"),contentLength:ho.default.ZSafeFunction((()=>parseInt(i.getResponseHeader("Content-Length"))),null),alive:!(404===i.status||i.responseURL&&i.responseURL.indexOf("default")>=0),status:i.status};np.set(s,t),e(t)},i.onerror=t=>{zconsole.error((function(e){return e[0]})`checkHEAD error`,t);const n={contentType:null,contentLength:null,alive:!1,status:i.status};np.set(s,n),e(n)},i.ontimeout=t=>{const n={contentType:null,contentLength:null,alive:!1,status:i.status};np.set(s,n,{maxAge:6e4}),e(n)},i.onabort&&(i.onabort=()=>{const t={contentType:null,contentLength:null,alive:!1,status:i.status};np.set(s,t,{maxAge:6e4}),e(t)}),i.send()})));var s;if(zconsole.zsymb(0,"MdL6xI","MediaBlobFetcher: check HEAD response",e.source,t),"number"==typeof(null==t?void 0:t.contentLength)&&t.contentLength>=this.BIG_FILE_THRESHOLD){var i,n;const t=`${e.mediaId}-${(null===(i=e.options)||void 0===i||null===(n=i.regenerateFromSource)||void 0===n?void 0:n.regenId)||""}`,s=cp(this._fetch,e),a=new dp(t,s);return this.BigFileTaskQueue.addTask(a),await a.executor.promise}return await this._fetch(e)},this._fetch=async e=>{var t;let{mediaId:s,source:i,options:n={},entry:a}=e;Object(Km.a)("string"==typeof i&&qm(i),`Media source must be a (http|https) URL. Got ${i}`);const r={start:performance.now(),end:performance.now()};zconsole.zsymb(3,"oOHhZy",["MediaBlobFetcher: fetch start. {} {} {}","V2t-Pg"],s,a,i,null===(t=n.regenerateFromSource)||void 0===t?void 0:t.regenId);try{var o;let t=(null===(o=n.regenerateFromSource)||void 0===o?void 0:o.maxDimension)||mi.default.image_loader.max_original,a=t,d=t;if(null!=n&&n.regenerateFromSource){delete n.regenerateFromSource.getLocalPath;const e=n.regenerateFromSource;Object(Um.c)(e.originalWidth)&&e.originalWidth>0&&Object(Um.c)(e.originalHeight)&&e.originalHeight>0&&([a,d]=Object(jm.d)(e.originalWidth,e.originalHeight,t,t,!1),t=a)}const u=Object(f.a)(Object(f.a)({cacheControl:"cache",useMemCache:!0,useDiskCache:!1},n),{},{convertible:Object(Jm.g)(i)});if(null!=n&&n.regenerateFromSource){u.regenerateJXL={outputWidth:a,outputHeight:d};const s=n.regenerateFromSource.regenId;i=Object(Jm.b)(n.regenerateFromSource.url,"regenw",t.toString()),"cache"===u.cacheControl&&(u.useDiskCache="thumb"===s||"normal"===s,u.useDiskCache&&(i=Object(Ym.d)(i))),e.source=i}if("cache"==u.cacheControl){var l;if(ep.b.has(i)){var c;const e=null===(c=ep.b.get(i))||void 0===c?void 0:c.prepared;return Sm.l.Success({mediaURL:e})}const e=ip(i,(null===(l=n.regenerateFromSource)||void 0===l?void 0:l.regenId)||""),t=await ep.a.getFile(e);if(t){const e=URL.createObjectURL(t);return ep.b.set(i,t.size,e),Sm.l.Success({mediaURL:e})}}const h=await this.getFetcher()(Object(ln.j)().toString(),i,"dev",void 0,u,void 0,(e=>{if(!e)return null;const[t,s,i]=e.split(".");return{cliMsgId:t,fromUid:s,toUid:i}||null})(s),ln.c.IMAGE_COMPONENT);return r.end=performance.now(),h.error||!h.data?(zconsole.zsymb(18,"UaENsG",`MediaBlobFetcher: fetch failed. ${s} ${i}. took: ${Date.now()-r.start}`,h),await this.handleFailure(e,u,h,r)):await this.handleSuccess(e,u,h,r)}catch(d){return this.Logger.zsymb(0,"dUlPfk",`MediaBlobFetcher: fetch caught error. ${s} ${i}. took: ${Date.now()-r.start}`,d,null==d?void 0:d.code),Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:i,error:d}})}},this.getFetcher=()=>{const e={[tp.a.V1]:ln.h,[tp.a.V2]:ln.i}[Zm.a.image_loader.version];Object(Km.a)(!!e,`Invalid fetcher: targeting ${Zm.a.image_loader.version}`);return se(e,{min:Zm.a.image_loader.retryMin,max:Zm.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Zm.a.image_loader.lastTryDelayTime.min,max:Zm.a.image_loader.lastTryDelayTime.max},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:i})=>{e||this.Logger.zsymb(0,"sCAm8t",`MediaBlobFetcher: Try ${s}: failed. Should retry: ${t} after ${i}ms`),e||t||this.Logger.zsymb(0,"qNcqjz",`MediaBlobFetcher: Download failed after ${s} tries`)}})},this.handleFailure=async(e,t,s,i)=>{var n;const{mediaId:a,source:r}=e;this.Logger.zsymb(0,"onTW9f",`MediaBlobFetcher: fetch failed. ${a} ${r}. took: ${Date.now()-i.start}`,s.error,s.data,null==s||null===(n=s.error)||void 0===n?void 0:n.code);const o=i.end-i.start;if(Object(Xm.k)(s.error)){var l;const e=Object(Xm.l)(null===(l=s.error)||void 0===l?void 0:l.code);if(e){const{qosCommand:t,errorCode:s}=e;fi.default.increaseFailed(t,0,o,s,i.start)}return fi.default.increaseFailed(Dm.a,0,o,Object(Dm.k)(),i.start),Sm.l.Failure({code:Sm.d.LIBJXL_ERROR,mediaURL:r,error:{mediaURL:r,error:s.error}})}return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:r,error:s.error}})},this.handleSuccess=async(e,t,s,i)=>{Object(Km.a)(!!s.data,"Data must be present in response");try{var n,a;const{source:l,mediaId:c,entry:d}=e,u=i.end-i.start;if(Object(Jm.g)(l)&&s.data&&(fi.default.increaseSuccess(Dm.b,0,u),fi.default.increaseSuccess(Dm.a,0,u)),"string"==typeof s.data)return Sm.l.Success({mediaURL:s.data});let h=s.data;const g=null===(n=e.options)||void 0===n?void 0:n.regenerateFromSource;if(g){const e=g.maxDimension||mi.default.image_loader.max_original;let t=g.originalWidth,s=g.originalHeight,i=!1,n=0,a=0;if(Object(Um.c)(t)&&Object(Um.c)(s)&&Object(Um.c)(e))[n,a,i]=Object(jm.d)(t,s,e,e,!1);else{const[r,o]=await Be.c.catchAsyncFn((()=>sp.default.getDimension({key:l,file:h})));!r&&o&&(t=o.width,s=o.height,[n,a,i]=Object(jm.d)(o.width,o.height,e,e,!1))}i&&(h=await Object(wm.a)(h,{width:n,height:a,priority:0,quality:.75})),xm.b.getInstance().record(xm.a.RenderPhotoHighQuality,{logId:`${c}-${d}`,resizeSize:h.size,resizeWidth:n,resizeHeight:a})}"image/jxl"!==(null===(a=h)||void 0===a?void 0:a.type)||null!=t&&t.downloadAsJxl||(h=Object(Ym.b)(h,"image/jpeg"));const m=URL.createObjectURL(h);if("cache"===t.cacheControl&&(ep.b.set(l,h.size,m),!0===t.useDiskCache)){var r,o;const t=ip(l,(null==e||null===(r=e.options)||void 0===r||null===(o=r.regenerateFromSource)||void 0===o?void 0:o.regenId)||"");await ep.a.putFile(t,h)}return Sm.l.Success({mediaURL:m})}catch(l){return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:e.source,error:l}})}},this.createDeferredTask=e=>{let t=()=>{},s=()=>{};return{promise:new Promise(((e,i)=>{t=e,s=i})),resolve:t,reject:s,source:e}},this.Logger=e.createZLogger(Ve.ZLoggerNametags.imageLoader,[Ve.ZLoggerNametags.mediaBlobFetcher])}})||hp)||hp)||hp)||hp;var mp;i.ModuleContainer.registerSingleton($m.a,gp);let pp=Object(i.injectable)()(mp=class extends Fe.b{async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:n,sendDttm:a,isLastFallbackUrl:r=!1,regenerateFromSource:o,entry:l}=e;let c;Object(Km.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Km.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),c=Sm.j.MemoryCache;const d=qm(s),u=Qm(s);if(!d&&u)return Sm.l.Success({mediaURL:s});if(e.useHttpsSource){try{return await ho.default.checkAlive(s),Sm.l.Success({mediaURL:s})}catch(f){}return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH})}if(c===Sm.j.MemoryCache)try{return await i.ModuleContainer.resolve($m.a).fetch({mediaId:t,source:s,options:{cacheControl:"cache",sendDttm:a,regenerateFromSource:o,isLastFallbackUrl:r,useDiskCache:!1,useMemCache:!0},entry:l})}catch(v){return Promise.reject(v)}Object(Km.a)("object"==typeof n&&"string"==typeof n.savePath&&!!n.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${n}`);const{savePath:h,downloadEntrySerial:g,getSavePath:m,getOldLocalPathForMigration:p}=n;return i.ModuleContainer.resolve($m.b).fetch({mediaId:t,source:s,options:{entrySerial:g,savePath:h,sendDttm:a,regenerateFromSource:o,isLastFallbackUrl:r,getSavePath:m,getOldLocalPathForMigration:p},entry:l})}async fetchSocialMediaStandalone(e){const{mediaId:t,source:s,entry:n=Sm.k.UNKNOWN}=e;Object(Km.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Km.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`);const a=qm(s),r=Qm(s);if(!a&&r)return Sm.l.Success({mediaURL:s});try{return await i.ModuleContainer.resolve($m.a).fetch({mediaId:t,source:s,options:{cacheControl:"noCache"},entry:n})}catch(o){return Promise.reject(o)}}})||mp;i.ModuleContainer.registerSingleton($m.c,pp);var fp,vp=s("Evs5");let bp=Object(i.injectable)()(fp=class{constructor(){this.loadMedia=async(e,t)=>{const{mediaId:s,entry:i,qualityFallback:n,fetchStrategy:a}=e,{fetcher:r,diskCacheConfig:o,disableLocalCache:l}=a,c=null==t?void 0:t.onFirstAvailable;let d=n,u=null;const h=new Set;let g=!1;for(;d;){const t=d.data.url,n=d.data.getLocalPath,a=d.data.getOldLocalPathForMigration;let p=d.data.regenerateFromSource;if(!t){d=d.nextOR||d.next;continue}const f=!d.nextOR&&!d.next;if(h.has(t)&&!f){d=d.nextOR||d.next;continue}g=!0;const v=await this._buildFetchConfig({mediaId:s,entry:i,source:t,getLocalPath:()=>null==n?void 0:n(t),downloadEntrySerial:null==o?void 0:o.downloadEntrySerial,autoDownload:!!u,sendDttm:e.sendDttm,isLastFallbackUrl:f,regenerateFromSource:p,disableLocalCache:l,getOldLocalPathForMigration:a}),b=await r(v);if("ERROR"==b.type){if(b.data.error&&Object(Xm.k)(b.data.error))return Sm.l.Failure({code:Sm.d.LIBJXL_ERROR,error:b.data.error});h.add(t),d=d.nextOR||d.next;continue}let I=null,y=null,_=null;try{const t=e.mediaId.split(".");3===t.length&&(I=t[0],y=t[1],_=t[2])}catch(m){}if(I&&Lm.b.log(I,{msgFormat:Object(Jm.g)(t)?".jxl":".jpg"}),!u){u={mediaURL:b.data.mediaURL},null==c||c(Sm.l.Success(u));break}d=d.next}return g?null===u?Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:s}):Sm.l.Success(u):Sm.l.Failure({code:Sm.d.EMPTY_SOURCE,error:s})},this.loadImage=async(e,t)=>{const{mediaId:s,entry:n,srcs:a,downloadAllResources:r}=e,o=i.ModuleContainer.resolve($m.c).fetch,l=null==t?void 0:t.onFirstAvailable;let c=null;const d=new Set;let u=!1;const h=(e=>{const t={},s=[];for(const i of e)i.src&&!t[i.src]&&(s.push(i),t[i.src]=!0);return s})(a);for(let i=0;i<h.length;i++){var g,m,p,f;const t=h[i],a=t.src,r=null===(g=t.downloadConfig)||void 0===g?void 0:g.getLocalPath,b=null===(m=t.downloadConfig)||void 0===m?void 0:m.getOldLocalPathForMigration;let I=t.regenerateFromSource;const y=i===h.length-1;if(d.has(a)&&!y)continue;u=!0;if(e.useHttpsSource)try{if(qm(a)){if(!(await rp(a,{cacheResponse:!0,retryableErrorCodes:Zm.a.image_loader.retryErrorCodes})))throw new Error("url is not alive. Continue to the next source");return Sm.l.Success({mediaURL:a})}return Sm.l.Success({mediaURL:a})}catch(v){d.add(a);continue}const _=await this._buildFetchConfig({mediaId:s,entry:n,source:a,getLocalPath:()=>null==r?void 0:r(a),downloadEntrySerial:null===(p=t.downloadConfig)||void 0===p?void 0:p.downloadEntrySerial,autoDownload:!!c,sendDttm:null===(f=t.downloadConfig)||void 0===f?void 0:f.sendDttm,isLastFallbackUrl:y,regenerateFromSource:I,useHttpsSource:e.useHttpsSource,getOldLocalPathForMigration:b}),C=await o(_);if("ERROR"==C.type){if(zconsole.error((function(e){return e[0]})`MediaPackageManager: fetch error`,C),C.data.error&&Object(Xm.k)(C.data.error))return Sm.l.Failure({code:Sm.d.LIBJXL_ERROR,error:C.data.error});if(d.add(a),i===h.length-1)return C;continue}let O=null,E=null,M=null;try{const t=e.mediaId.split(".");3===t.length&&(O=t[0],E=t[1],M=t[2]),O&&Lm.b.log(O,{msgFormat:Object(Jm.g)(a)?".jxl":".jpg"})}catch(v){}if(!c){c={mediaURL:C.data.mediaURL},null==l||l(Sm.l.Success(c));break}}return u?null===c?Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:s}):Sm.l.Success(c):Sm.l.Failure({code:Sm.d.EMPTY_SOURCE,error:s})},this._buildFetchConfig=async e=>{Object(Km.a)(!!e&&"object"==typeof e,`_buildDownloadConfig: config must be object, got ${e}`);const t=Object(e);Object(Km.a)("string"==typeof t.mediaId,`_buildDownloadConfig: mediaId must be string, got ${null==t?void 0:t.mediaId}`),Object(Km.a)(t.entry in Sm.k,`_buildDownloadConfig: entry must be MediaDisplayTarget, got ${null==t?void 0:t.entry}`),Object(Km.a)("string"==typeof t.source,`_buildDownloadConfig: source must be string, got ${null==t?void 0:t.source}`);const s={mediaId:t.mediaId,source:t.source,sendDttm:t.sendDttm,isLastFallbackUrl:t.isLastFallbackUrl,regenerateFromSource:t.regenerateFromSource,entry:t.entry};if(t.getLocalPath&&!t.disableLocalCache){const e=await t.getLocalPath();s.diskFetcherConfig={savePath:e,downloadEntrySerial:t.downloadEntrySerial,autoDownload:t.autoDownload,getSavePath:t.getLocalPath,getOldLocalPathForMigration:t.getOldLocalPathForMigration}}return s}}abort(e,t){}})||fp;i.ModuleContainer.registerSingleton(vp.a,bp);var Ip=s("Ff2n"),yp=s("o46R"),_p=s("UD1y"),Cp=s("OgkW"),Op=s.n(Cp);const Ep={FORWARD_MESSAGE:"FORWARD_MESSAGE",DOWNLOAD_MESSAGE:"DOWNLOAD_MESSAGE",RELOAD_MEDIA:"RELOAD_MEDIA"};var Mp=s("Mf3M");const Sp=["failure"];var Tp;Object(i.injectable)()(Tp=Object(ko.b)(_p.b)(Tp=function(e,t){return Object(i.inject)(vp.a)(e,void 0,0)}(Tp=function(e,t){return Object(i.inject)(Je.a)(e,void 0,1)}(Tp=Reflect.metadata("design:type",Function)(Tp=Reflect.metadata("design:paramtypes",[Object,void 0===Je.a?Object:Je.a])(Tp=class{constructor(e,t){this.mediaPackageManager=e,this.application=t,this._revokedBlobURL=new Map,this._activeContextWindow=null,this._retryItems=new he.default({maxSize:1e3}),this.TaskQueue=void 0,this.UserSourceTracker=new Map,this.MAX_LOAD_TASKS=8,this._eventEmitter=new Op.a,this.MAX_RETRIES=4,this._isOnline=!0,this.NETWORK_STABLE_TIMEOUT=2e3,this._networkRetryTimeout=null,this._retryNetworkWhenAliveQueue=new Map,this._PreTaskQueue=[],this.trackTempBlob=(e,t)=>{this.UserSourceTracker.set(e.toString(),t)},this.removeTrackTempBlob=e=>{this.UserSourceTracker.delete(e.toString())},this.setActiveWindowContext=e=>("WeakRef"in globalThis?this._activeContextWindow=new globalThis.WeakRef(e):this._activeContextWindow=e,this.removeActiveWindowContext),this.removeActiveWindowContext=()=>{this._activeContextWindow=null},this.getActiveWindowContext=()=>this._activeContextWindow instanceof globalThis.WeakRef?this._activeContextWindow.deref():this._activeContextWindow,this.manualRetry=async(e,t,s=!1)=>{var i,n,a,r,o,l;if(Zm.a.image_loader.version===tp.a.V2)return this.retryEntry(e,t,s);const c=this.data.get(e),d=`${e}-${t}`;if((null==c||null===(i=c.failure)||void 0===i?void 0:i.code)!==Sm.d.FORCE_EXPIRE&&!this.TaskQueue.isRunning(d)&&(s||(null==c||null===(n=c.view)||void 0===n||null===(a=n[t])||void 0===a||null===(r=a.failure)||void 0===r?void 0:r.code)!==Sm.d.FORCE_ERROR))if(this._retryable(d)||s)if(c){if(s&&this._retryItems.set(d,0),c&&c.view&&null!==(o=c.view)&&void 0!==o&&null!==(l=o[t])&&void 0!==l&&l.failure){var u,h;this._handleRevokeURL({payload:{blobURL:null==c||null===(u=c.view[t])||void 0===u?void 0:u.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==c||null===(h=c.view[t])||void 0===h?void 0:h.expected,mediaId:e}});const s=c.view,{[t]:i}=s,n=Object(Ip.a)(s,[t].map(yp.a)),{failure:a}=c,r=Object(Ip.a)(c,Sp),o=Object(f.a)(Object(f.a)({},r),{},{view:n});this.data.set(e,o)}this.emit(Ep.RELOAD_MEDIA,{mediaId:e,entry:t,hotSwapSource:!0})}else this.emit(Ep.RELOAD_MEDIA,{mediaId:e,entry:t});else this.forceError(e,t)},this.forceError=(e,t,s)=>{var i;const n=this.data.get(e)||{mediaId:e,view:{}},a=(null==n?void 0:n.view)||{},r=null==s||null===(i=s.data)||void 0===i?void 0:i.code,o=r&&Object.values(Sm.d).some((e=>e===r))?r:Sm.d.FORCE_ERROR;this.data.set(e,Object(f.a)(Object(f.a)({},n),{},{view:Object(f.a)(Object(f.a)({},a),{},{[t]:{failure:{code:o,message:`ForceError=${r}`}}})})),this._signalRenderItem(this.name,e)},this.loadMedia=async(e,t={})=>{const s=cp(this._loadMedia,e,t),i=`${e.mediaId}-${e.entry}`,n=new dp(i,s);this.TaskQueue.addTask(n)},this._handleTaskQueueCompleted=e=>{if(this._PreTaskQueue.length>0&&this._PreTaskQueue.some((t=>t.taskId===e))){const e=this.MAX_LOAD_TASKS-this.TaskQueueSize;if(e>0&&this._PreTaskQueue.length>0){const t=this._PreTaskQueue.slice(0,e);this._PreTaskQueue.splice(0,t.length);const s=new Set;for(let e of t){const{mediaId:t,entry:i}=e;this._mayInitState(t);const n=this.data.get(t),a=Array.from(new Set([...(null==n?void 0:n.hotLoad)||[],i]));this.data.set(t,Object(f.a)(Object(f.a)({},n),{},{hotLoad:a})),s.add(t)}Array.from(s).forEach((e=>{this._signalRenderItem(this.name,e)}))}}},this.enqueueNetworkRetry=(e,t)=>{const s=this._retryNetworkWhenAliveQueue.get(e)||{};s[t]={mediaId:e,entry:t},this._retryNetworkWhenAliveQueue.set(e,s)},this.dequeueNetworkRetry=(e,t)=>{const s=this._retryNetworkWhenAliveQueue.get(e)||{};s&&(delete s[Sm.k[t]],Object.values(s).length>0?this._retryNetworkWhenAliveQueue.set(e,s):this._retryNetworkWhenAliveQueue.delete(e))},this._removeEntryFromPreTaskQueue=(e,t)=>Array.isArray(e)&&0!==e.length?e.filter((e=>e!==t)):[],this._loadMedia=async(e,t={})=>{var s,i,n,a,r,o,l;const{forceLoad:c=!1}=t,d=(e.mediaId,e.entry,this.data.get(e.mediaId));if(globalThis.__alwaysForcePhotoExpired)return this.forceExpire(e.mediaId);if((null==d||null===(s=d.failure)||void 0===s?void 0:s.code)===Sm.d.FORCE_EXPIRE||(null==d||null===(i=d.view)||void 0===i||null===(n=i[e.entry])||void 0===n||null===(a=n.failure)||void 0===a?void 0:a.code)===Sm.d.FORCE_ERROR)return;const u=this._revokedBlobURL.get(e.mediaId),h=null==d||null===(r=d.view)||void 0===r?void 0:r[e.entry],g=!(null==h||!h.actual||null!=u&&u.has(h.actual)),m=[Sm.e.EmptySource,Sm.e.ZaloSource,Sm.e.ExpiredSource];if(g&&m.some((e=>e===h.dataSrcId))||null!=d&&d.failure&&!1===c)return;if(this._mayInitState(e.mediaId,{rotateDeg:90*e.vOrient}),null!==(o=e.uploadSource)&&void 0!==o&&null!==(l=o.oriUrl)&&void 0!==l&&l.startsWith("blob:"))return void this._updateViewUpload(e.mediaId,e.entry,e.uploadSource);let p=null,v=null,b=null;try{const t=e.mediaId.split(".");3===t.length&&(p=t[0],v=t[1],b=t[2])}catch(I){}p&&Lm.b.log(p,{clientId:p,dest_id:b,srcId:v});try{let s=!1;const i=this.data.get(e.mediaId),n=Object(f.a)(Object(f.a)({},t),{},{expiryCheck:e.expiryCheck}),a=await this.mediaPackageManager.loadMedia(e,{hasHd:null==i?void 0:i.hasHd,skipHdCheck:null==i?void 0:i.hasHd,onFirstAvailable:t=>{s=!0,this._handleLoadResponse(e.mediaId,e.entry,t,n)}});s||this._handleLoadResponse(e.mediaId,e.entry,a,n)}catch(I){zconsole.zsymb(18,"nlXjEx","ImageLoaderController: loadMedia error",I),p&&Lm.b.endLog(p,{clientId:p,dest_id:b,srcId:v,renderStatus:0})}},this._retryable=e=>!((this._retryItems.get(e)||0)>=this.MAX_RETRIES||this.TaskQueue.isRunning(e)),this.runFullflow=(e,t)=>{var s,i,n,a;const r=this.data.get(e),o=`${e}-${t}`;if((null==r||null===(s=r.failure)||void 0===s?void 0:s.code)===Sm.d.FORCE_EXPIRE||this.TaskQueue.isRunning(o)||(null==r||null===(i=r.view)||void 0===i||null===(n=i[t])||void 0===n||null===(a=n.failure)||void 0===a?void 0:a.code)===Sm.d.FORCE_ERROR)return;if(!this._retryable(o))return void this.forceError(e,t);this.abanbonMedia(e,t);const l=this._retryItems.get(o)||0;this._retryItems.set(o,l+1),this.manualRetry(e,t)},this.abort=e=>{const t=this._retryItems.get(e)||0;this._retryItems.set(e,Math.max(t-1,0)),this.TaskQueue.abortTask(e)},this.loadDOMSuccess=(e,t)=>{try{const t=e.split(".");if(t.length){const e=t[0];Lm.b.endLog(e,{renderStatus:1})}}catch(s){}this._retryItems.delete(`${e}-${t}`)},this.loadDOMError=(e,t)=>{},this._signalRenderItem=(...e)=>{Object(hs.i)(...e)},this._updateView=(e,t,s,i)=>{if(!s)return;const n=this.data.get(e);let a=n.view[t]||{};if(2===Zm.a.image_loader.version)for(const[d,u]of Object.entries(n.view))u.failure&&u.failure.code===Sm.d.FORCE_ERROR&&delete n.view[d];const r=this._revokedBlobURL.get(e);if(!a||!Boolean(a.actual)||a.actual&&null!=r&&r.has(a.actual))n.view=Object(f.a)(Object(f.a)({},n.view),{},{[t]:{actual:s,expected:s,dataSrcId:Sm.e.ZaloSource}}),this.data.set(e,n),a&&a.actual&&a.actual!==a.expected&&this._handleRevokeURL({payload:{blobURL:a.actual,mediaId:e}});else if(Boolean(a.actual)&&a.actual!==s){const i=Object(f.a)(Object(f.a)({},a),{},{expected:s});n.view=Object(f.a)(Object(f.a)({},n.view),{},{[t]:i}),this.data.set(e,n)}if(null!=i&&i.hotSwapSource){var o,l;const n=this.data.get(e);var c;if(a=n.view[t]||{},i.reloadUploadSource&&null!==(o=a)&&void 0!==o&&o.actual&&a.actual!==s)URL.revokeObjectURL(null===(c=a)||void 0===c?void 0:c.actual),this.UserSourceTracker.delete(e.split(".")[0]);this.data.set(e,Object(f.a)(Object(f.a)({},n),{},{view:Object(f.a)(Object(f.a)({},null==n?void 0:n.view),{},{[t]:Object(f.a)(Object(f.a)({},null==n||null===(l=n.view)||void 0===l?void 0:l[t]),{},{actual:s,expected:s,dataSrcId:Sm.e.ZaloSource})})})),a&&a.actual&&a.actual!==a.expected&&this._handleRevokeURL({payload:{blobURL:a.actual,mediaId:e}})}this._signalRenderItem(this.name,e)},this._handleRevokeURL=e=>{const t=null==e?void 0:e.payload;Object(Km.a)(!!t,"ImageLoaderController: revoke event payload undefined");const{blobURL:s,mediaId:i}=t;s&&URL.revokeObjectURL(s)},this.listenEvents=()=>{this.application.addEventListener(Je.b.Exit,this._cleanupEvents),Fi.default.subscribe(this._handleNetworkChange)},this._cleanupEvents=()=>{this.application.removeEventListener(Je.b.Exit,this._cleanupEvents),Fi.default.unsubscribe(this._handleNetworkChange)},this.loadImage=async e=>{const t=cp(this._loadImage,e),s=`${e.mediaId}-${e.entry}`,i=new dp(s,t);this.TaskQueue.addTask(i)},this.reloadImage=async(e,t)=>{const s=this.data.get(e);if(!s)return;s.view[t]&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{view:Object(f.a)(Object(f.a)({},s.view),{},{[t]:{}})})),this._signalRenderItem(this.name,e))},this.abortLoadImage=(e,t)=>{const s=`${e}-${t}`;this.TaskQueue.abortTask(s),this.dequeueNetworkRetry(e,Sm.k[t])},this.swapUploadSourceOutview=(e,t)=>{const s=this.data.get(e),i=null==s?void 0:s.view[t],n=(null==s?void 0:s.uploadSource)===(null==i?void 0:i.actual);return!!i&&(!(!n||i.actual===i.expected||!Boolean(i.expected))&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{view:Object(f.a)(Object(f.a)({},null==s?void 0:s.view),{},{[t]:Object(f.a)(Object(f.a)({},i),{},{actual:i.expected,dataSrcId:Sm.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,i.actual),!0))},this.freeImageCache=(e,t)=>{},this.retryEntry=(e,t,s=!1)=>{var i,n,a,r,o,l,c,d;const u=this.data.get(e);if(!u||null===(i=u.view)||void 0===i||null===(n=i[t])||void 0===n||!n.failure)return;const h=`${e}-${t}`;var g,m,p,f;if((null==u||null===(a=u.failure)||void 0===a?void 0:a.code)===Sm.d.FORCE_EXPIRE||this.TaskQueue.isRunning(h)||!s&&(null==u||null===(r=u.view)||void 0===r||null===(o=r[t])||void 0===o||null===(l=o.failure)||void 0===l?void 0:l.code)===Sm.d.FORCE_ERROR)zconsole.log("retryEntry: early return",e,t,(null==u||null===(g=u.failure)||void 0===g?void 0:g.code)===Sm.d.FORCE_EXPIRE,this.TaskQueue.isRunning(h),!s&&(null==u||null===(m=u.view)||void 0===m||null===(p=m[t])||void 0===p||null===(f=p.failure)||void 0===f?void 0:f.code)===Sm.d.FORCE_ERROR);else if(this._retryable(h)||s){var v,b;if(s&&this._retryItems.set(h,0),u&&u.view&&null!==(c=u.view)&&void 0!==c&&null!==(d=c[t])&&void 0!==d&&d.failure)this._handleRevokeURL({payload:{blobURL:null==u||null===(v=u.view[t])||void 0===v?void 0:v.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==u||null===(b=u.view[t])||void 0===b?void 0:b.expected,mediaId:e}}),null!=u&&u.view[t]&&(null==u||delete u.view[t]),null!=u&&u.failure&&(null==u||delete u.failure),this.data.set(e,u),u.hotLoad=this._removeEntryFromPreTaskQueue(u.hotLoad,t);this._signalRenderItem(this.name,e)}else this.forceError(e,t)},this._loadImage=async e=>{var t;const{mediaId:s,entry:i,uploadSource:n}=e,a=`${s}-${i}`;let r=null,o=null,l=null;try{const t=e.mediaId.split(".");3===t.length&&(r=t[0],o=t[1],l=t[2]),[Sm.k.IMAGE_VIEWER,Sm.k.IMAGE_VIEW_SLIDER,Sm.k.MESSAGE_LIST,Sm.k.MEDIA_STORE].some((e=>e===i))&&xm.b.getInstance().record(xm.a.RenderPhotoHighQuality,{logId:a,startRenderTs:performance.now()})}catch(d){}this._mayInitState(e.mediaId),null!=n&&n.blobUrl&&"string"==typeof n.blobUrl&&n.blobUrl.startsWith("blob:")&&await this._prepareUploadingSource(e);const c=this.data.get(s);if(n&&null!==(t=c.uploadSource)&&void 0!==t&&t.startsWith("blob:")&&!e.reloadUploadSource)this._updateViewUpload(s,Sm.k[i],{oriUrl:c.uploadSource});else{r&&Lm.b.log(r,{clientId:r,dest_id:l,srcId:o});try{let t=!1;const n={hotSwapSource:e.hotSwapSource,reloadUploadSource:e.reloadUploadSource},a=await this.mediaPackageManager.loadImage(e,{onFirstAvailable:s=>{t=!0,this._handleLoadResponse(e.mediaId,Sm.k[e.entry],s,n)}});if(!this.isOnline&&e.retryWhenOnline&&"ERROR"===a.type&&a.data.code===Sm.d.FAILURE_BY_FETCH)return this.enqueueNetworkRetry(s,Sm.k[e.entry]),void this.forceError(s,Sm.k[i],Sm.l.Failure({code:Sm.d.FAILURE_BY_NETWORK,error:a.data.error}));t||this._handleLoadResponse(e.mediaId,Sm.k[e.entry],a)}catch(d){this.forceError(s,Sm.k[i]),r&&Lm.b.endLog(r,{clientId:r,dest_id:l,renderStatus:0})}}},this._resetItemState=(e,t)=>{if(!this.data.has(e))return;const s=this.data.get(e)||{mediaId:e,view:{}};if(!s.view[t])return;const i=s.view;delete i[t],this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{view:Object(f.a)({},i)})),this._signalRenderItem(this.name,e)},this._retryNetworkTasks=()=>{const e=Array.from(this._retryNetworkWhenAliveQueue.values());this._retryNetworkWhenAliveQueue.clear();for(let t of e){const e=Object.values(t);for(let t of e)this._resetItemState(t.mediaId,Sm.k[t.entry])}},this._clearNetworkRetryTimeout=()=>{this._networkRetryTimeout&&(clearTimeout(this._networkRetryTimeout),this._networkRetryTimeout=null)},this._handleNetworkChange=(e,t)=>{e===Ai.GeneralActions.NETWORK_STATUS_CHANGED&&(this._isOnline=!0===t),this._isOnline&&this._retryNetworkWhenAliveQueue.size>0?(this._clearNetworkRetryTimeout(),this._networkRetryTimeout=setTimeout(this._retryNetworkTasks,this.NETWORK_STABLE_TIMEOUT)):this._clearNetworkRetryTimeout()},this._prepareUploadingSource=async e=>{var t;const{mediaId:s,uploadSource:i}=e;let n=this.data.get(s)||{mediaId:s,view:{}};if(null!=i&&null!==(t=i.blobUrl)&&void 0!==t&&t.startsWith("blob:")){const e=s.split(".")[0],t=this.UserSourceTracker.get(e);if(t)n=Object(f.a)(Object(f.a)({},n),{},{uploadSource:t});else{const[t,s,a]=Object(jm.d)(i.width,i.height,1024,1024);if(i.blobUrl){if(i.file&&(a||"image/jxl"===i.file.type)){const e=await Object(wm.a)(i.file,{width:t,height:s,priority:3}),a=URL.createObjectURL(e);n.uploadSource=a}}else 0;n.uploadSource&&this.UserSourceTracker.set(e,n.uploadSource)}}this.data.set(s,n)},this.name=_p.a,this.data=new Map,this.key="mediaId",this.init=()=>{this.listenEvents(),this._eventEmitter.setMaxListeners(50)},this.TaskQueue=new up(this.MAX_LOAD_TASKS,this._handleTaskQueueCompleted),this.init()}get TaskQueueSize(){return this.TaskQueue.taskQueue.length+this.TaskQueue.runningTasks.size}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in Ep&&this._eventEmitter.emit(e,t)}registerPreloadTask(e,t){const s=this._PreTaskQueue.findIndex((s=>s.mediaId===e&&s.entry===t));-1!==s&&this._PreTaskQueue.splice(s,1),this._PreTaskQueue.push({mediaId:e,entry:t,taskId:`${e}-${t}`})}unregisterPreloadTask(e,t){const s=this._PreTaskQueue.findIndex((s=>s.mediaId===e&&s.entry===t));-1!==s&&this._PreTaskQueue.splice(s,1)}getViewState(e,t){var s,i;return null===(s=this.data.get(e))||void 0===s||null===(i=s.view)||void 0===i?void 0:i[t]}allowOutviewUpdate(e,t){const s=this.data.get(e),i=null==s?void 0:s.view[t];i&&(i.dataSrcId!==Sm.e.Upload||i.expected)?i.actual!==i.expected&&Boolean(i.expected)&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{view:Object(f.a)(Object(f.a)({},null==s?void 0:s.view),{},{[t]:Object(f.a)(Object(f.a)({},i),{},{actual:i.expected,dataSrcId:Sm.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,i.actual)):this.emit("RELOAD_MEDIA",{mediaId:e,entry:t,hotSwapSource:!0,forceLoad:!0})}forceExpire(e){var t;this._retryNetworkWhenAliveQueue.has(e)&&this._retryNetworkWhenAliveQueue.delete(e);const s=this.data.get(e)||{mediaId:e,view:{}};(null==s||null===(t=s.failure)||void 0===t?void 0:t.code)!==Sm.d.FORCE_EXPIRE&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{failure:{code:Sm.d.FORCE_EXPIRE,message:"Force expire"},view:{}})),this._signalRenderItem(this.name,e))}rotateMedia(e,t){let s=this.data.get(e);if(!s)throw new Error(`rotateMedia failed with ${e}: ${t}`);let i=s.rotateDeg||0;i+=t,s=Object(f.a)(Object(f.a)({},s),{},{rotateDeg:i}),this.data.set(e,s),this._signalRenderItem(this.name,e)}abanbonMedia(e,t){if(!this.data.has(e))return;const s=this.data.get(e);null!=s&&s.view[t]&&(delete s.view[t],this.data.set(e,Object(f.a)({},s)),this._signalRenderItem(this.name,e))}clearItemData(e,t,s){const i=this.data.get(e);i&&(delete i.view[t],i.hotLoad=this._removeEntryFromPreTaskQueue(i.hotLoad,t),this.data.set(e,i),!0===(null==s?void 0:s.signalRenderItem)&&this._signalRenderItem(this.name,e))}_runCleanup(e,t){if(!t||!t.startsWith("blob:"))return;const s=this.data.get(e);if(!s)return void URL.revokeObjectURL(t);const i=s.view;Object.values(i).forEach((e=>{e.actual!==t&&e.expected})),URL.revokeObjectURL(t)}_mayInitState(e,t={},s=!0){let i=this.data.get(e);i||(i=Object(f.a)(Object(f.a)({mediaId:e,view:{}},t),{},{hotLoad:[]}),this.data.set(e,i)),s||this._signalRenderItem(this.name,e)}_handleLoadResponse(e,t,s,i){switch(s.type){case"ERROR":this._handleLoadError(s,e,t,i);break;case"SUCCESS":this._handleLoadSuccess(s,e,t,i);break;default:throw new Error(`Unknown response type: ${e} ${t} got ${null==s?void 0:s.type}`)}}_handleLoadError(e,t,s,i={}){const n=e.data,a=()=>{try{var e;const i=null==n||null===(e=n.error)||void 0===e?void 0:e.error;return[`id=${t}-${s}`,`stt=${n.code}`,`dlerr=${null==i?void 0:i.name}:${null==i?void 0:i.code}`].join("\n")}catch(i){return zconsole.zsymb(18,"sqI91y","ImageLoaderController: buildDebugInfo error",i),`status: ${n.code}`}};switch(n.code){case Sm.d.FAILURE_BY_FETCH:{const e=this.data.get(t);e.view=Object(f.a)(Object(f.a)({},e.view),{},{[s]:Object(f.a)(Object(f.a)({},e.view[s]),{},{failure:{code:n.code,message:a()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Sm.d.FAILURE_BY_PRELOAD:{const e=this.data.get(t);e.view=Object(f.a)(Object(f.a)({},e.view),{},{[s]:Object(f.a)(Object(f.a)({},e.view[s]),{},{failure:{code:n.code,message:a()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Sm.d.EMPTY_SOURCE:{const e=this.data.get(t);e.view=Object(f.a)(Object(f.a)({},e.view),{},{[s]:Object(f.a)(Object(f.a)({},e.view[s]),{},{failure:{code:n.code,message:a()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Sm.d.LIBJXL_ERROR:this.forceError(t,s)}}async _updateViewUpload(e,t,s){var i;if(null==s||!s.oriUrl)return;let n=this.data.get(e);const a=s.oriUrl;n?(null===(i=n.view[t])||void 0===i?void 0:i.actual)!==a&&Boolean(a)&&(n=Object(f.a)(Object(f.a)({},n),{},{view:Object(f.a)(Object(f.a)({},n.view),{},{[t]:{actual:a,expected:a,dataSrcId:Sm.e.Upload}})})):n={mediaId:e,view:{[t]:{actual:a,expected:a,dataSrcId:Sm.e.Upload}}},this.data.set(e,n),this._signalRenderItem(this.name,e)}_handleLoadSuccess(e,t,s,i){const n=e.data;this._updateView(t,s,n.mediaURL,i)}get isOnline(){return this._isOnline}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||Tp)||Tp)||Tp)||Tp)||Tp);var wp,Rp=s("7nHs");const Lp={isShown:!1,modalTitle:"",guideTitle:"",errorCode:"",guideItems:[],showPrimaryBtn:!0,primaryBtnName:"STR_BU_CONFIRM_TEXT_4",showSecondaryBtn:!0,secondaryBtnName:"STR_BU_CANCEL_TEXT_4",adapterType:_e.b};Object(ko.b)(Rp.a)(wp=class{constructor(){this.name=Rp.b,this.key="",this.state=Lp}setState(e){const t=Object(kg.a)(this.state,e);this.state!==t&&(this.state=t,Object(hs.h)(this.name,""))}showModal(e){this.state.isShown||this.setState((t=>Object(f.a)(Object(f.a)(Object(f.a)({},t),e),{},{isShown:!0})))}closeModal(){this.state.isShown&&this.setState((e=>Object(f.a)(Object(f.a)(Object(f.a)({},e),Lp),{},{isShown:!1})))}init(e){}getItem(e,t){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}});var Dp,Ap=s("Mf7h"),Fp=s("8c0e"),jp=s("alF8");const Pp=new ho.LocalId;Object(i.injectable)()(Dp=Object(i.singleton)(Fp.a)(Dp=class{constructor(){this._linkPreviewDatas=new Map,this._lastCheckLinks=new Map,this._listeners=new Map}addListenerAtConv(e,t){if(e&&"function"==typeof t){const s=this._listeners.get(e);this._listeners.set(e,[...s||[],t])}}removeListenerAtConv(e,t){let s=this._listeners.get(e);s&&s.length>0&&(s=s.filter((e=>e!==t)),this._listeners.set(e,s))}removeAllListenerAtConv(e){this._listeners.delete(e)}setLastCheckLinkByConvId(e,t){this._lastCheckLinks.set(e,t)}isLastCheckLinkOfConv(e,t){const s=this._lastCheckLinks.get(e);return!!s&&jp.a.isEqualUrl(s,t)}getLinkPreviewDataByConvId(e){return this._linkPreviewDatas.get(e)||null}addLinkDataToConv(e,t){const s=this._prepareLinkPreviewData(e,t);this._linkPreviewDatas.set(e,Object(f.a)({},s));const i={action:Ai.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(f.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),Ap.a.emit(Ai.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(f.a)({},s)})}createLoadingLinkPreview(e,t){const s={id:Pp.next(),convId:e,content:{title:os.a.str("STR_GETTING_LINK_INFO"),src:t,desc:"",thumb:"",loading:!0},link:t,shouldParseLinkOrContact:!0};e&&this._linkPreviewDatas.set(e,Object(f.a)({},s));const i={action:Ai.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(f.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),Ap.a.emit(Ai.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(f.a)({},s)})}removeLinkPreviewData(e){if(!e)return;this._linkPreviewDatas.delete(e);const t={action:Ai.LinkPreviewActions.HIDE_LINK_PREVIEW,payload:null};this._notifyLinkPreviewDataChangeToConv(e,t),Ap.a.emit(Ai.LinkPreviewActions.HIDE_LINK_PREVIEW,null)}_notifyLinkPreviewDataChangeToConv(e,t){const s=this._listeners.get(e);null==s||s.forEach((e=>{"function"==typeof e&&e({action:t.action,payload:t.payload})}))}_prepareLinkPreviewData(e,t){return{id:Pp.next(),convId:e,link:t.link,content:t.content,shouldParseLinkOrContact:!1}}})||Dp);var kp,Np=s("iy3m"),Up=s("twqL");Object(Je.i)()(kp=Object(i.singleton)(Up.a)(kp=Reflect.metadata("design:type",Function)(kp=Reflect.metadata("design:paramtypes",[])(kp=class{constructor(){this.changeTimeFlushNotiReactWhenResumeApp=this.changeTimeFlushNotiReactWhenResumeApp.bind(this),this.changeTimeFlushNotiReactWhenDisNetwork=this.changeTimeFlushNotiReactWhenDisNetwork.bind(this),this.changeTimeFlushNotiReactWhenStartApp=this.changeTimeFlushNotiReactWhenStartApp.bind(this)}onStart(e){this.changeTimeFlushNotiReactWhenStartApp()}changeTimeFlushNotiReactWhenResumeApp(){this.changeTimeFlushNotiReact(Object(Np.d)())}setupTimer(e){Ud.b.TimeFlushNotiReact=e,Ud.b.TimeMaxWaiting=Object(Np.a)(),Ud.b.setupIntervalToFlushNotiReact(),Ud.b.setupTimeoutToGoBackNormalCondition()}changeTimeFlushNotiReactWhenDisNetwork(e){if(e===fu.a.CONNECTED){const e=fu.b.getPreStateNetwork();e!==fu.a.CONNECTED&&e!==fu.a.NOT_SET&&this.changeTimeFlushNotiReact(Object(Np.b)())}}changeTimeFlushNotiReactWhenStartApp(){this.changeTimeFlushNotiReact(Object(Np.e)())}changeTimeFlushNotiReact(e){Ud.b.notiReactTimeoutId?(Ud.b.TimeFlushNotiReact!==e&&(Ud.b.TimeFlushNotiReact=e,Ud.b.setupIntervalToFlushNotiReact()),Ud.b.TimeMaxWaiting!==Object(Np.a)()&&(Ud.b.TimeMaxWaiting=Object(Np.a)(),Ud.b.setupTimeoutToGoBackNormalCondition())):this.setupTimer(e)}})||kp)||kp)||kp);var Bp,xp=s("K0f4"),Gp=s("buT3");Object(Je.i)()(Bp=Object(Je.e)()(Bp=class{onAuthenticated(e){const{userId:t}=e.getSession();if(t){const e=Object(Ce.d)(t),s=`${e}_${xp.m}`,i=Gp.a.getItem(s);if(!(null!==i))return;const n=97124,a="1"===i,r=`${e}_${xp.g}`,o=+(Gp.a.getItem(r)||"-1"),l=isNaN(o)?-1:o,c=`${e}_${xp.i}`,d=+(Gp.a.getItem(c)||"-1"),u=isNaN(d)?-1:d;if(a)fi.default.increaseSuccess(n,0,l,[u]);else{const t=`${e}_${xp.c}`,s=Gp.a.getItem(t),i=Number(s);fi.default.increaseFailed(n,0,l,i,Date.now(),[u])}Gp.a.removeItem(s),Gp.a.removeItem(r),Gp.a.removeItem(c)}}onStart(){const e=xp.l,t=Gp.a.getItem(e);if(!(null!==t))return;const s="1"===t,i=xp.f,n=+(Gp.a.getItem(i)||"-1"),a=isNaN(n)?-1:n,r=xp.h,o=+(Gp.a.getItem(r)||"-1"),l=isNaN(o)?-1:o;if(s)fi.default.increaseSuccess(97123,0,a,[l]);else{const e=Gp.a.getItem(xp.b),t=Number(e);fi.default.increaseFailed(97123,0,a,t,Date.now(),[l])}Gp.a.removeItem(e),Gp.a.removeItem(i),Gp.a.removeItem(r)}})||Bp);var zp,Vp=s("l9L4"),Hp=s("CDcE");Object(Je.d)()(zp=Object(i.injectable)()(zp=Object(i.singleton)(Vp.a)(zp=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(zp=Reflect.metadata("design:type",Function)(zp=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(zp=class{constructor(e){this._isFirstLoginMap=new Map,this._firstLoginTimeMap=new Map,this._logger=void 0,this._logger=e.createZLogger("utils",["first-login-checker"])}getFirstLoginTime(e){if(this.firstLoginTimeMap.has(e))return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime();try{const t=E.default.getInstance().getItemForCurrentUser(R.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME);null!=t&&this.firstLoginTimeMap.set(e,parseInt(t))}catch(t){this.logger.zsymb(21,"IL3lO4",["getFirstLoginTime error {} - {}","CaLiwa"],e,Object(Hp.f)(t,2))}return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime()}isFirstLogin(e){return!!this._isFirstLoginMap.get(e)}onApplicationReady(e){this.removeFirstLoginFlag()}setFirstLogin(e,t){this._isFirstLoginMap.set(e,t)}setFirstLoginTime(e,t){this.firstLoginTimeMap.set(e,t);try{E.default.getInstance().setItemForCurrentUser(R.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME,t&&t.toString()||"")}catch(s){this.logger.zsymb(21,"blwk8e",["setFirstLoginTime error {} - {} - {}","lkrwgS"],e,t,Object(Hp.f)(s,2))}}removeFirstLoginFlag(){const e=ns.default.getUidMe(),t=E.default.getInstance();t.getItem(R.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)===e&&t.removeItem(R.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)}getDefaultFirstLoginTime(){return yn.default.getTimeNow()}get firstLoginTimeMap(){return this._firstLoginTimeMap}get logger(){return this._logger}})||zp)||zp)||zp)||zp)||zp);var Wp;const $p="last-ts-online",Kp="last-ts-online-prev-session";let qp=Object(Je.i)()(Wp=Object(Je.g)()(Wp=Object(i.injectable)()(Wp=Object(td.g)([{token:Jr.token,useFactory:()=>Fi.default},{token:eo.token,useFactory:()=>id.default},{token:to.token,useFactory:()=>E.default.getInstance()}])(Wp=function(e,t){return Object(i.inject)(Jr)(e,void 0,0)}(Wp=function(e,t){return Object(i.inject)(In.b)(e,void 0,1)}(Wp=function(e,t){return Object(i.inject)(eo)(e,void 0,2)}(Wp=function(e,t){return Object(i.inject)(to)(e,void 0,3)}(Wp=Reflect.metadata("design:type",Function)(Wp=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,void 0===E.default?Object:E.default])(Wp=class{constructor(e,t,s,i){this.eventBus=e,this.systemTime=t,this.socketPolling=s,this.localStorage=i,this.lastTsOnline=void 0,this.intervalUpdate=void 0,this.prevNetworkState=void 0,this.lastTsOnlinePrevSession=void 0,this.startTsOnlineCurrSession=void 0,this.onNetworkStatusChanged=e=>{if(e!==this.prevNetworkState)switch(this.prevNetworkState=e,e){case fu.a.CONNECTED:this.startIntervalUpdate();break;case fu.a.DISCONNECT:this.updateLastTsUserOnline(),this.stopIntervalUpdate()}},this.onStartPullOffline=()=>{this.startTsOnlineCurrSession=this.systemTime.getTimeNow(),this.updateLastTsUserOnlineInPrevSession()},this.onDonePullOffline=()=>{this.updateLastTsUserOnline(),this.startIntervalUpdate()},this.updateLastTsUserOnline=()=>{const e=this.systemTime.getTimeNow();return this.lastTsOnline=e,this.localStorage.setItemForCurrentUserAsync($p,e.toString())},this.updateLastTsUserOnlineInPrevSession=async()=>{const e=await this.getLastTsOnline();return this.lastTsOnlinePrevSession=e,this.localStorage.setItemForCurrentUserAsync(Kp,e.toString())},this.lastTsOnline=null,this.intervalUpdate=null,this.prevNetworkState=null,this.lastTsOnlinePrevSession=null,this.startTsOnlineCurrSession=null}onStart(){this.registerListener()}onDispose(){this.updateLastTsUserOnline(),this.stopIntervalUpdate()}async getLastTsOnline(){var e;return null!==(e=this.lastTsOnline)&&void 0!==e?e:this.lastTsOnline=Number(await this.localStorage.getItemForCurrentUserAsync($p))||0}async getLastTsOnlinePrevSession(){var e;return null!==(e=this.lastTsOnlinePrevSession)&&void 0!==e?e:this.lastTsOnlinePrevSession=Number(await this.localStorage.getItemForCurrentUserAsync(Kp))||0}async getStartTsOnlineCurrSession(){var e;return null!==(e=this.startTsOnlineCurrSession)&&void 0!==e?e:this.startTsOnlineCurrSession=this.systemTime.getTimeNow()}registerListener(){this.eventBus.subscribe(((e,t)=>{if(e===Ai.GeneralActions.NETWORK_STATUS)return this.onNetworkStatusChanged(t)})),this.socketPolling.addEventListener(id.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(nd.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(nd.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(nd.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(nd.b.ON_DONE_OFFLINE,this.onDonePullOffline)}))}startIntervalUpdate(){var e;null!==(e=this.intervalUpdate)&&void 0!==e||(this.intervalUpdate=setInterval((()=>{this.updateLastTsUserOnline()}),Be.j.timeInMs("10m")))}stopIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||Wp)||Wp)||Wp)||Wp)||Wp)||Wp)||Wp)||Wp)||Wp)||Wp;i.ModuleContainer.registerSingleton(Xr,qp);var Qp=s("/7c0");const Zp=Object(i.define)("transfer-data-suggestion-loader");var Jp=s("cgeJ"),Yp=s("XVri"),Xp=s("bAqL");var ef=class{constructor(e){this._logger=void 0,this._moduleName=void 0,this._moduleName=e}log(){this.Logger.zsymb(0,"6vdxVe",this.moduleTagName,...arguments)}logError(e,t){const s=null==t?"":this.stringifyDepthLevel(t);this.Logger.zsymb(18,"7Hhe7n",this.moduleTagName,e,s)}stringifyDepthLevel(e){return Object(Xp.g)(e,Object(Xp.c)())}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("msg-sync",[Yp.a])),this._logger}get moduleTagName(){return this._moduleName+" - "}};var tf,sf=class{constructor(e){this.moduleName=e,this._logger=void 0,this._logger=new ef(this.moduleName)}get Logger(){return this._logger}};function nf(e){try{return JSON.stringify(e)}catch(t){return""}}function af(e){return JSON.parse(e)}Object(i.injectable)()(tf=Object(i.singleton)(Zp)(tf=Reflect.metadata("design:type",Function)(tf=Reflect.metadata("design:paramtypes",[])(tf=class extends sf{constructor(){super(Jp.f.LOADER),this._friendManager=void 0,this._groupManager=void 0}async loadLastCloseBannerDownloadPC(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load last close banner download pc failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Jp.b);return null!=t?af(t):(this.Logger.logError("Load last close banner download pc failed null"),null)}catch(t){return this.Logger.logError("Load last close banner download pc failed",t),t}}async loadListConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load list conversations from DB failed cause invalid storage"),Promise.reject([]);try{const t=await e.getItemForCurrentUserAsync(Jp.d);return null!=t?af(t):(this.Logger.logError("Load list conversations from DB failed null"),[])}catch(t){return this.Logger.logError("Load list conversations from DB failed",t),[]}}async loadRolledConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load rolled conversations from DB failed cause invalid storage"),Promise.reject([]);try{let t=[];const s=await e.getItemForCurrentUserAsync(Jp.e);null!=s&&(t=af(s));const n=i.ModuleContainer.resolve(jo.PreviewDataManager),a=await n.getAllPreviews(!0);for(let e=0;e<a.length;e++){const s=a[e].convId;if(s===mi.default.sendToMeId)continue;if(-1!==t.indexOf(s))continue;const i=await Qp.a.messageDBHandler.getOldestMsgsFromConv(s,Object(nu.a)(),1);i&&i.items&&i.items.length>0&&t.push(s)}return this.Logger.logError("Load list rolled conversations from DB failed null"),t}catch(t){return this.Logger.logError("Load list rolled conversations from DB failed",t),[]}}async loadListFriends(){const e=this.getFriendManagerModule();if(e)try{return await e.getFriends()}catch(t){return this.Logger.logError("Load list friends failed",t),[]}return this.Logger.log("Load list friends empty"),[]}async loadListGroups(){const e=this.getGroupManagerModule();if(e)try{return await e.getGroupsList()}catch(t){return this.Logger.logError("Load list groups failed",t),[]}return this.Logger.log("Load list groups empty"),[]}async loadRegisteredData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load registered data failed cause invalid storage"),Promise.reject();try{let t=e.getItemForCurrentUser(R.RegisterLocalStorageKeys.IS_REGISTERED_ON_THIS_DEVICE);return null!=t?{isRegisteredOnThisDevice:af(t)}:(this.Logger.log("Load registered data null"),null)}catch(t){return this.Logger.logError("Load registered data failed",t),t}}async loadSyncMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load sync messages data failed cause invalid storage"),Promise.reject();try{const t=e.getItemForCurrentUser("sync_cross_settings");return t?af(t):(this.Logger.log("Load sync messages data null"),null)}catch(t){return this.Logger.logError("Load sync messages data failed",t),t}}async loadTransferMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load transfer messages data failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Jp.m);return t?af(t):(this.Logger.logError("Load transfer messages data failed null"),null)}catch(t){return this.Logger.logError("Load transfer messages data failed",t),t}}async setLastCloseBannerDownloadPC(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Jp.b,nf(e)):Promise.reject("Invalid storage")}async setLastCloseFirstLoginTransferModal(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Jp.c,nf(e)):Promise.reject("Invalid storage")}async addRolledConversationToDB(e){const t=this.getSecureLocalStorageDB();if(!t)return Promise.reject("Invalid storage");let s=await this.loadRolledConversationsFromDB();return-1===s.indexOf(e)&&s.push(e),await t.setItemForCurrentUserAsync(Jp.e,nf(s))}async setListConversationsFirstLoginToDB(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Jp.d,nf(e)):Promise.reject("Invalid storage")}async updateTransferMessagesData(e){const t={lastTransferSuccessTime:e.lastTransferSuccessTime||Date.now()};try{return await this.getSecureLocalStorageDB().setItemForCurrentUserAsync(Jp.m,nf(t))}catch(s){return s}}getFriendManagerModule(){var e;this._friendManager||(this._friendManager=null===(e=s("UiPd"))||void 0===e?void 0:e.default);return this._friendManager}getGroupManagerModule(){var e;this._groupManager||(this._groupManager=null===(e=s("Gm1y"))||void 0===e?void 0:e.default);return this._groupManager}getSecureLocalStorageDB(){return E.default.getInstance()}})||tf)||tf)||tf);var rf=s("n09q"),of=s("31cx"),lf=s("a1r1"),cf=s("BO4k");var df,uf=class extends sf{constructor(e,t){super(Yp.c.MANAGER),this._eventMap=new Map,this._fistLoginTime=void 0,this._listConversationsBeforeLogin=[],this._isTransferAfterLogin=void 0,this._rolledConversations=[],this._moduleLoader=void 0,this._moduleUIManager=void 0,this._moduleLoader=e,this._moduleUIManager=t,this._isTransferAfterLogin=!1,this.handleUpdateConfigs=this.handleUpdateConfigs.bind(this),this.isDisplayedBannerDownloadPCSuggestion=this.isDisplayedBannerDownloadPCSuggestion.bind(this),this.isDisplayedBubbleInfoEcard=this.isDisplayedBubbleInfoEcard.bind(this),this.isDisplayedCloseButtonBannerDownloadPC=this.isDisplayedCloseButtonBannerDownloadPC.bind(this),this.isDisplayedConversationFooter=this.isDisplayedConversationFooter.bind(this),this.isDisplayedGlobalSearchFooter=this.isDisplayedGlobalSearchFooter.bind(this),this.isDisplayedSearchInConversationFooter=this.isDisplayedSearchInConversationFooter.bind(this),this.isDisplayedMilestoneInPreviewMedia=this.isDisplayedMilestoneInPreviewMedia.bind(this),this.isDisplayedSuggestionInMediaList=this.isDisplayedSuggestionInMediaList.bind(this),this.isDisplayedTransferModal=this.isDisplayedTransferModal.bind(this),this.isValidForTransferMessages=this.isValidForTransferMessages.bind(this)}addEventListeners(e,t){this.eventMap.set(e,[...this.eventMap.get(e)||[],t])}callTransferMessages(e){}closeBannerDownloadPCSuggestion(){}getConversationFooterRendererHeight(){return this.isDisplayedConversationFooter()?Yp.b.CONVERSATION:0}getFirstLoginTime(){return this.firstLoginTime}getGlobalSearchFooterRendererHeight(){return this.isDisplayedConversationFooter()?Yp.b.GLOBAL_SEARCH:0}getLogger(){return this.Logger}getUrlDownloadPC(){return""}getIsTransferAfterLogin(){return this.isTransferAfterLogin}hasConversationBeforeFirstLogin(e){return e!==mi.default.sendToMeId&&this._listConversationsBeforeLogin.includes(e)}hasRolledConversation(e){return e!==mi.default.sendToMeId&&this._rolledConversations.includes(e)}hideTransferMessagesModal(){}async initialize(){this.firstLoginTime=i.ModuleContainer.resolve(lf.a).getFirstLoginTime(this.getUserId()),this.handleUpdateConfigs(cf.a()),this.registerSubscriptions(),await this.initializeListConversationsBeforeFirstLogin(),this.initListRolledConversations()}isDisplayedBannerDownloadPCSuggestion(){return!!this.isEnabledFeature()&&cf.g()}isDisplayedBubbleInfoEcard(e){return!!this.isEnabledFeature()&&(!!cf.h()&&(!!this.hasConversationBeforeFirstLogin(e)||!!Object(nu.d)(this.firstLoginTime)&&this.hasRolledConversation(e)))}isRolledConversation(e){return mi.default.roll_msg.enable&&Object(nu.d)(this.firstLoginTime)&&(this.hasRolledConversation(e)||this.hasConversationBeforeFirstLogin(e))}isDisplayedCloseButtonBannerDownloadPC(){return!!this.isEnabledFeature()&&cf.k()}isDisplayedConversationFooter(){return!!this.isEnabledFeature()&&cf.l()}isDisplayedCTADownloadPC(){return!!this.isEnabledFeature()&&cf.i()}isDisplayedCTATransferMessages(){return!!this.isEnabledFeature()&&cf.j()}isDisplayedGlobalSearchFooter(){return!!this.isEnabledFeature()&&cf.m()}isDisplayedSearchInConversationFooter(e){return!!this.isEnabledFeature()&&(!!cf.p()&&(this.hasConversationBeforeFirstLogin(e)||this.hasRolledConversation(e)))}isDisplayedMilestoneInPreviewMedia(e){return!!this.isEnabledFeature()&&(!!cf.o()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedSuggestionInMediaList(e){return!!this.isEnabledFeature()&&(!!cf.n()&&(this.hasConversationBeforeFirstLogin(e)||this.hasRolledConversation(e)))}isDisplayedTransferModal(){return!!this.isEnabledFeature()&&cf.q()}isEnabledFeature(){return cf.r()}isValidSupportDownloadPC(){return!1}isValidForTransferMessages(){return this.isEnabledFeature()}needTransferMessages(){}removeEventListeners(e,t){const s=this.eventMap.get(e);if(Array.isArray(s)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1)}}setFirstLoginTime(e){this.firstLoginTime=e}setIsTransferAfterLogin(e){this.isTransferAfterLogin=e}shouldTransferMessages(){return!1}showTransferMessagesModal(){}canShowFirstTimeLoginTransferMessageModal(){return!1}async addRolledConversationToDB(e){}registerSubscriptions(){mi.$AppConfig.subscribe(this.handleUpdateConfigs)}isFirstLogin(){return i.ModuleContainer.resolve(lf.a).isFirstLogin(this.getUserId())}async initializeListConversationsBeforeFirstLogin(){this._listConversationsBeforeLogin=await this.loadListConversationsBeforeFirstLogin()}async initListRolledConversations(){const e=await this.loaderModule.loadRolledConversationsFromDB();this._rolledConversations=e}handleUpdateConfigs(e={}){const{data_content:t}=cf.b(e),{first_time_login_device:s}=e;t&&this.UIManager.updateDataContent(Object(of.a)(t)),null!=s&&(this.firstLoginTime=s)}async loadListConversations(){const e=[],t=await this.loaderModule.loadListFriends();Array.isArray(t)&&t.forEach((t=>{e.push(t.userId)}));const s=await this.loaderModule.loadListGroups();return Array.isArray(s)&&s.forEach((t=>{e.push(t.userId)})),e}async loadListConversationsBeforeFirstLogin(){let e;if(this.isFirstLogin())e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e);else{const t=await this.loaderModule.loadListConversationsFromDB();e=t,(t||[]).length||(e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e))}return e}notifyEvent(e,...t){const s=this.eventMap.get(e);Array.isArray(s)&&s.forEach((e=>Promise.resolve((()=>e(...t)))))}get firstLoginTime(){return this._fistLoginTime}set firstLoginTime(e){this._fistLoginTime=e}get isTransferAfterLogin(){return this._isTransferAfterLogin}set isTransferAfterLogin(e){this._isTransferAfterLogin=e}get eventMap(){return this._eventMap}get loaderModule(){return this._moduleLoader}get UIManager(){return this._moduleUIManager}getUserId(){const e=i.ModuleContainer.resolve(Je.a),{userId:t}=e.getSession()||{};return t||""}},hf=s("mgoj"),gf=s("JCvM");Object(i.injectable)()(df=Object(Je.d)()(df=Object(i.singleton)(rf.a)(df=function(e,t){return Object(i.inject)(Zp)(e,void 0,0)}(df=function(e,t){return Object(i.inject)(hf.a)(e,void 0,1)}(df=Reflect.metadata("design:type",Function)(df=Reflect.metadata("design:paramtypes",[Object,void 0===gf.ITransferDataSuggestionUIManager?Object:gf.ITransferDataSuggestionUIManager])(df=class extends uf{constructor(e,t){super(e,t),this._lastCloseBannerTimestamp=0,this.handleBeforeUnload=this.handleBeforeUnload.bind(this)}closeBannerDownloadPCSuggestion(){const e=yn.default.getTimeNow();this.lastCloseBannerTimestamp=e,this.UIManager.closeBannerDownloadPCSuggestion(),this.loaderModule.setLastCloseBannerDownloadPC(e)}getUrlDownloadPC(){return Object(cf.f)()}async initialize(){await super.initialize(),await this.loadLastCloseBannerTimestamp()}isDisplayedBannerDownloadPCSuggestion(){if(!super.isDisplayedBannerDownloadPCSuggestion())return!1;if(!this.isValidSupportDownloadPC())return!1;const e=Object(cf.e)();return this.lastCloseBannerTimestamp+e<=yn.default.getTimeNow()}isValidSupportDownloadPC(){const e=Object(Xp.d)().toLowerCase();return null!=Object(cf.d)().find((t=>e.indexOf(t)>-1))}isValidForTransferMessages(){return!1}onApplicationReady(e){this.isDisplayedBannerDownloadPCSuggestion()&&Xp.a.logAction(Xp.a.BannerDownloadPC.DISPLAYED),this.isEnabledFeature()&&Xp.a.logAction(Xp.a.Common.DISPLAYED_NOT_ENOUGH_DATA_MESSAGE)}addRolledConversationToDB(e){return this.loaderModule.addRolledConversationToDB(e)}handleBeforeUnload(){this.logActionBeforeUnload()}async loadLastCloseBannerTimestamp(){try{const e=await this.loaderModule.loadLastCloseBannerDownloadPC();e&&(this.lastCloseBannerTimestamp=e)}catch(e){}}logActionBeforeUnload(){const e=Object(Xp.b)();Xp.a.logActionInfo(e,!0)}registerSubscriptions(){super.registerSubscriptions(),i.ModuleContainer.resolve(Je.a).addEventListenerOnce(Je.b.BeforeUnload,this.handleBeforeUnload)}get lastCloseBannerTimestamp(){return this._lastCloseBannerTimestamp}set lastCloseBannerTimestamp(e){this._lastCloseBannerTimestamp=e}})||df)||df)||df)||df)||df)||df);var mf,pf=class extends sf{constructor(){super(Yp.c.UI),this.key=gf.c,this.name=gf.c,this.dataState=Object(f.a)({},Yp.f),this.UIState=Object(f.a)({},Yp.g)}closeBannerDownloadPCSuggestion(){}hideTransferMessagesModal(){}init(e){}initialize(){const{data_content:e}=Object(cf.b)(Object(cf.a)());this.handleUpdateContent(e)}getItem(e,t){return e.key===Yp.e?this.dataState:e.key===Yp.h?this.UIState:{}}getList(e,t){return[]}turnOffDisplayingEntryPoints(){this.handleUpdateRenderer({isDisplayedEntryPoints:!1})}onGetItemFailure(e,t){}onGetListFailure(e,t){}onProcessSync(e){}showTransferMessagesModal(){}updateDataContent(e){this.handleUpdateContent(e)}setDataState(e){const t=Object(kg.a)(this.dataState,e);this.dataState!==t&&(this.dataState=t,Object(hs.h)(this.name,Yp.e))}setUIState(e){const t=Object(kg.a)(this.UIState,e);this.UIState!==t&&(this.UIState=t,Object(hs.h)(this.name,Yp.h))}handleUpdateContent(e){this.setDataState((t=>{t.version=e.version,t.content=e.content}))}handleUpdateRenderer(e){this.setUIState((t=>{for(const s in e)t[s]=e[s]}))}};Object(ko.b)(gf.b)(mf=class extends pf{closeBannerDownloadPCSuggestion(){this.setUIState((e=>{e[Jp.l.BANNER_DOWNLOAD].isDisplayed=!1}))}getItem(e,t){const s=super.getItem(e,t);if(!s)return;let i={};if(e.key===Jp.h){const{content:e={}}=s;for(const t in e){const s=e[t];if(s)for(const e in s){var n;i[t]||(i[t]={}),i[t][e]=null===(n=s[e])||void 0===n?void 0:n.web}}}else i=s;return i}});var ff=Object(i.define)("forward-message-pool-factory"),vf=s("oAAg");var bf=class{createPool(e,t){return Object(vf.createPool)(e,t)}};i.ModuleContainer.register(ff,bf);var If=s("iuM+"),yf=s("WOYD"),_f=s("qWd+");function Cf(e){const t={success:[],failed:[]};for(const s of e)s.success&&s.success.length&&t.success.push(...s.success),s.failed&&s.failed.length&&t.failed.push(...s.failed);return t}function Of(e){let t=[],s=[],i="";return e.forEach((e=>{e===mi.default.sendToMeId?i=e:e.startsWith(R.GROUPID_PREFIX)?t.push(e):s.push(e)})),{groups:t,oneOnes:s,sendToMe:i}}function Ef(e,t=50){let s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}function Mf(e,t,s,n){const{userId:a}=i.ModuleContainer.resolve(Je.a).getSession()||{};let r=ho.default.getMsgIdSendingFromCliMsgId(t),o=e.startsWith(R.GROUPID_PREFIX);const l=new Kl.c(a,e,r,t,s,o,n);return ql.a.instance().isOnE2ee(e)&&(l.e2eeStatus=R.MSG_E2EE),l}var Sf=s("Eyfw");var Tf=async function(e,t,s){const i=zl.default.getChatBoxControllerByWindowId(Go.c);if(s.failed.length){const n=s.failed[0].error,a=null==n?void 0:n.code;if(a===Qu.a.DeleteConversationHasSendingMsg||a===Qu.a.DeleteSendingMsg||a===Qu.a.MsgArrivedBeforeAPIResponse)return;const r=s.failed[0].clientId;i._handleForwardedMessageFailure(n,{toUid:t.userId,message:e,clientId:r},t,e)}};const wf={USER:3,GROUP:6,OA:5};function Rf(e){let t=e;return t&&t.startsWith(R.GROUPID_PREFIX)&&(t=t.substr(R.GROUPID_PREFIX.length)),t}function Lf(e,t,s){if(!(e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm&&t))return{};if(s!==mi.default.sendToMeId)return{};let i=e.toUid||e.userId,n=function(e){if(!e)return!1;let t=e.userId||e.id;return"string"==typeof t&&!t.startsWith(R.GROUPID_PREFIX)&&e.type>=1}({userId:s})?wf.OA:i.startsWith(R.GROUPID_PREFIX)?wf.GROUP:wf.USER;return{tId:Rf(i),srcType:n,srcId:"0"==e.fromUid?t:e.fromUid,cmi:e.cliMsgId,gmi:e.msgId,ts:e.sendDttm+""}}function Df(e){const t=zl.default.getChatBoxControllerByWindowId(Go.c)._getConversationInfo(e);if(!t){if(e.startsWith(R.GROUPID_PREFIX)){return Zo.default.getGroupByIdSync(e)}return ns.default.getProfileFriendByIdSync(e)}return t}var Af=s("e2PW");var Ff=async function(e,t,s){const i=(null==s?void 0:s.retry)||!1,n=i?e.cliMsgId:$l.a.next(),a=(i&&e.msgId,Sf.a.preprocessMessage(n+"",e,void 0,!1,null)),r=Object(Af.b)(e,{send2Me:t===mi.default.sendToMeId});a.reference=Object(Af.c)(r);const o={forwardRefLog:r,decorLog:Object(Af.a)(r)},l=Df(t),c={success:[],failed:[]};try{const e=await Sf.a.forward(n+"",a,l,o);if(e){const s=e.msgId||e.minGlobalMsgId;c.success.push({clientId:n+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else c.failed.push({clientId:n+"",error:"invalid response",toUid:t})}catch(d){c.failed.push({clientId:n+"",error:d,toUid:t})}return Tf(a,l,c),c},jf=s("/5+7"),Pf=s("sANj"),kf=s("UyAE");var Nf=async function(e,t,s=[],n=!1){const a={},r={},o=n?e.msgId:"",l=Object(Af.b)(e,{send2Me:!1}),c=Object(Af.b)(e,{send2Me:!0});for(let d=0;d<t.length;d++){let n=s[d]||$l.a.next();const u=t[d];a[u]=n;const h=Mf(u,n,R.MSG_FILE,Object(f.a)({},e.message)),g=u===mi.default.sendToMeId?c:l;h.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(g)),h.localPath=e.localPath,h.folderPath=e.folderPath,r[u]=h;const m=zl.default.getChatBoxControllerByWindowId(Go.c),p=Df(u);if(mi.default.forward_messages.enable_tracking_log){i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("forward-log",["track forward file"]).zsymb(18,"z55qP1","call _showLocalMessage: ",JSON.stringify(h))}m._showLocalMessage(h,p,e,o,R.MSG_CHECKING_EXIST);const v=`${n}_${rt.p.getSessionUserId()}_${t[d]}`;jf.a.dispatch(Pf.FileActionType.ExtraInfo,{fileKey:jf.a.getFileKey(v),extraInfo:{sendFileError:void 0}}),kf.a.set(null==n?void 0:n.toString(),{localPath:e.localPath,folderPath:e.folderPath})}return{localMsgs:r}},Uf=s("D5jy");var Bf=async function(e,t,s){const i=zl.default.getChatBoxControllerByWindowId(Go.c),n={};for(const a in e)e[a]&&e[a].clientId&&(n[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{i&&i._sentMessage(n[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s,i){var n;const a=t.error;a===R.FORWARD_ERR_CODE.EXPIRED||a===Uf.a.FILE_EXPIRED||a===R.FORWARD_ERR_CODE.SERVER_YAWNING||R.FORWARD_ERR_CODE.SEND_FAIL;const r=null==t||null===(n=t.error)||void 0===n?void 0:n.code;r!==Qu.a.DeleteConversationHasSendingMsg&&r!==Qu.a.DeleteSendingMsg&&r!==Qu.a.MsgArrivedBeforeAPIResponse&&s._handleForwardedMessageFailure(a,e,Df(e.conversationId),i)}(n[e.clientId],e,i,s)}))};var xf=async function(e,t,s){var i;const n={success:[],failed:[]},a=null!=s&&s.retry?parseInt(e.cliMsgId):$l.a.next(),{localMsgs:r}=await Nf(e,[t],[a],null==s?void 0:s.retry),o=null===(i=r[t].reference)||void 0===i?void 0:i.data,l={forwardRefLog:o,decorLog:Object(Af.a)(o)};try{const s=await uo.default.forwardMessage(t,e,a,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,r[t],l);if(s){const e=s.msgId||s.minGlobalMsgId;n.success.push({clientId:a+"",msgId:e+"",minGlobalMsgId:s.minGlobalMsgId+"",toUid:t})}else n.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(c){n.failed.push({clientId:a+"",error:c,toUid:t})}return await Bf(r,n,e),n},Gf=function(e){return async function(e,t,s={}){const i=_f.a.checkIsMessageFileE2ee(e),n=[];for(let a=0;a<t.length;a++){const r=ql.a.instance().isOnE2ee(t[a]);_f.a.checkIsForwardCrossConversation(i,r)?n.push(Ff(e,t[a],s)):n.push(xf(e,t[a],s))}return Cf(await Promise.all(n))}(e.message,e.toUids,e.options)},zf=s("dm9D"),Vf=s("iEwR");const Hf=(e,t)=>{const[s,n]=Be.g.safeParseJson(null!=t?t:"");if(Number(null==n?void 0:n.is_original)){const t=mi.default.file_photo_limit,s=ql.a.instance().isOnE2ee(e);if(t.enable_upload_original&&t.free_user_can_reupload_original)return{photoResolutionMode:Mp.a.PHOTO_RESOLUTION_MODE.ORIGINAL,keepPhotoOriginalParamWhenForward:!0,isPhotoOriginal:1};switch(i.ModuleContainer.resolve(Mp.a.IPhotoMessageProcessorDef).getCurrentPhotoResolutionMode()){case Mp.a.PHOTO_RESOLUTION_MODE.ORIGINAL:return{photoResolutionMode:Mp.a.PHOTO_RESOLUTION_MODE.ORIGINAL,keepPhotoOriginalParamWhenForward:!0,skipGenThumbForPhotoE2EE:s,isPhotoOriginal:1};case Mp.a.PHOTO_RESOLUTION_MODE.HD:default:return t.keep_original_param_when_forward?{keepPhotoOriginalParamWhenForward:!0,skipGenThumbForPhotoE2EE:s,isPhotoOriginal:1}:{keepPhotoOriginalParamWhenForward:!1,isPhotoOriginal:1}}}return{}};var Wf=async function(e,t,s={}){var n;const{userId:a}=i.ModuleContainer.resolve(Je.a).getSession()||{},r={},o=(null==s?void 0:s.retry)||!1,l=o?e.msgId:"",c=Object(Af.b)(e,{send2Me:!1}),d=Object(Af.b)(e,{send2Me:!0});null!==(n=e.message)&&void 0!==n&&n.params&&(e.message.params=(e=>{const[t,s]=Be.g.safeParseJson(null!=e?e:"");if(s.is_original){const e=i.ModuleContainer.resolve(Mp.a.IPhotoMessageProcessorDef).getCurrentPhotoResolutionMode(),t=mi.default.file_photo_limit;if(e===Mp.a.PHOTO_RESOLUTION_MODE.HD&&!t.keep_original_param_when_forward)return delete s.is_original,JSON.stringify(s)}return e})(e.message.params));for(let i=0;i<t.length;i++){let s=o?e.cliMsgId:$l.a.next();const n=t[i],a=Mf(n,s,R.MSG_PHOTO,Object(f.a)({},e.message)),u=n===mi.default.sendToMeId?d:c;a.updateMessageProp("properties",e.properties),a.updateMessageProp("localPath",e.localPath),a.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(u)),r[n]=a;const h=zl.default.getChatBoxControllerByWindowId(Go.c),g=Df(n);h._showLocalMessage(a,g,e,l,R.MSG_CHECKING_EXIST)}return{localMsgs:r}},$f=s("tOSn");var Kf=async function(e,t,s){const i=zl.default.getChatBoxControllerByWindowId(Go.c),n={};for(const a in e)e[a]&&e[a].clientId&&(n[e[a].clientId]=e[a]);s.success.length&&s.success.forEach((e=>{i&&i._sentMessage(n[e.clientId],e),$f.b.getInstance().end($f.a.SendMsgPhotoHighQuality,{clientId:e.clientId,tsStopSubmitApi:performance.now(),sendStatus:"success"})})),s.failed.length&&s.failed.forEach((e=>{!async function(e,t,s,i){var n;const a=s.error;if(a===R.FORWARD_ERR_CODE.EXPIRED||a===Uf.a.FILE_EXPIRED);else{if(a===R.FORWARD_ERR_CODE.SERVER_YAWNING)return;if(a===R.FORWARD_ERR_CODE.SEND_FAIL)return}const r=null==s||null===(n=s.error)||void 0===n?void 0:n.code;r!==Qu.a.DeleteConversationHasSendingMsg&&r!==Qu.a.DeleteSendingMsg&&r!==Qu.a.MsgArrivedBeforeAPIResponse&&i._handleForwardedMessageFailure(a,e,Df(e.conversationId),t)}(n[e.clientId],t,e,i),$f.b.getInstance().end($f.a.SendMsgPhotoHighQuality,{clientId:e.clientId,tsStopSubmitApi:performance.now(),sendStatus:"fail",error:e.error})}))};var qf=async function(e,t,s){const{localMsgs:n,forwardLogData:a,forwardLogDataMyCloud:r}=await Wf(e,t,s),o={success:[],failed:[]},l=i.ModuleContainer.resolve(Vf.TAIStickerMessageAppService);for(let i=0;i<t.length;i++){var c;const s=n[t[i]],a=s.clientId,r=Object(f.a)({},e);ql.a.instance().isOnE2ee(t[i])&&(r.e2eeStatus=R.MSG_E2EE);const u=null===(c=s.reference)||void 0===c?void 0:c.data,h={forwardRefLog:u,decorLog:Object(Af.a)(u)};try{const e=await l.forwardAIStickerMessage(t[i],a,r,{retryTimeout:R.RETRY_MSG_TIMEOUT_DEFAULT,lowPriority:!1,fwAdditional:h});o.success.push(Object(f.a)(Object(f.a)({},e),{},{clientId:a+"",toUid:t[i]}))}catch(d){o.failed.push({clientId:a+"",error:d,toUid:t[i]})}}return await Kf(n,e,o),o},Qf=s("Ullg");var Zf=async function(e,t,s){const{localMsgs:i}=await Wf(e,t,s),n={success:[],failed:[]};for(let o=0;o<t.length;o++){var a;const s=t[o],l=i[s],c=l.clientId,d=Object(f.a)({},e);ql.a.instance().isOnE2ee(s)&&(d.e2eeStatus=R.MSG_E2EE);const u=null===(a=l.reference)||void 0===a?void 0:a.data,h={forwardRefLog:u,decorLog:Object(Af.a)(u)};try{const e=await Qf.a.Helper.forwardPhotoSticker(s,d,c,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,h);n.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:s,clientId:c+""}))}catch(r){n.failed.push({clientId:c+"",error:r,toUid:s})}}return await Kf(i,e,n),n};var Jf=async function(e,t,s){var i;const n=(null==s?void 0:s.retry)||!1?e.cliMsgId:$l.a.next(),a=Sf.a.preprocessMessage(n+"",e,s.photoBundle),r=Df(t),o=await async function(e,t){const s=Object(Af.b)(e,{send2Me:t===mi.default.sendToMeId});return Object(f.a)({forwardRefLog:s,decorLog:Object(Af.a)(s)},Hf(t,e.message.params))}(e,t),l={success:[],failed:[]};a.reference=Object(Af.c)(null==o?void 0:o.forwardRefLog),$f.b.getInstance().start($f.a.SendMsgPhotoHighQuality,{clientId:n,resolution:null!==(i=o.photoResolutionMode)&&void 0!==i?i:"hd",convId:t,sendType:"forward",forwardType:"reupload"});try{const e=await Sf.a.forward(n+"",a,r,o);if(e){let s=e.msgId||e.minGlobalMsgId;l.success.push({clientId:n+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else l.failed.push({clientId:n+"",error:"invalid response",toUid:t})}catch(c){l.failed.push({clientId:n+"",error:c,toUid:t})}return Tf(a,r,l),l};var Yf=async function(e,t,s){var i;const n={success:[],failed:[]};let a=ho.default.safeParseJson(null==e||null===(i=e.message)||void 0===i?void 0:i.params)||{};null!=a&&a.group_layout_id&&(delete a.group_layout_id,delete a.id_in_group,delete a.is_group_layout,delete a.total_item_in_group),s.photoBundle&&Object.assign(a,{is_group_layout:1,group_layout_id:s.photoBundle.groupLayoutId,id_in_group:s.photoBundle.idInGroup,total_item_in_group:s.photoBundle.totalItemInGroup});const r=Object(f.a)({},e.message);r.params=JSON.stringify(a);const o=Object(f.a)(Object(f.a)({},e),{},{message:r}),{localMsgs:l}=await Wf(o,[t],s),c=l[t].clientId+"";try{var d,u;let i=!1;s.photoBundle&&(i=Object(f.a)(Object(f.a)({},s.photoBundle),{},{clientId:c}));const a=null===(d=l[t].reference)||void 0===d?void 0:d.data,o=Object(f.a)({forwardRefLog:a,decorLog:Object(Af.a)(a)},Hf(t,e.message.params));$f.b.getInstance().start($f.a.SendMsgPhotoHighQuality,{clientId:c,resolution:null!==(u=o.photoResolutionMode)&&void 0!==u?u:"hd",convId:t,sendType:"forward"});const h=await uo.default.forwardMessage(t,Object(f.a)(Object(f.a)({},e),{},{message:r,forwardInGroup:i}),c,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,l[t],o);if(h){let e=h.msgId||h.minGlobalMsgId;n.success.push({clientId:c,msgId:e+"",minGlobalMsgId:h.minGlobalMsgId+"",toUid:t,thumbUrl:h.thumbUrl,oriUrl:h.oriUrl||h.hdUrl||h.rawUrl,hdUrl:h.hdUrl,fileMsgParams:h.fileMsgParams})}else n.failed.push({clientId:c,error:"invalid response",toUid:t})}catch(h){n.failed.push({clientId:c,error:h,toUid:t})}return await Kf(l,e,n),n};var Xf=async function(e,t,s){const i=_f.a.checkIsMessageFileE2ee(e),n=[];for(let a=0;a<t.length;a++){const r=ql.a.instance().isOnE2ee(t[a]);_f.a.checkIsForwardCrossConversation(i,r)?n.push(Jf(e,t[a],s)):n.push(Yf(e,t[a],s))}return Cf(await Promise.all(n))},ev=function(e){return async function(e,t,s={}){return Object(zf.a)(e)?await qf(e,t,s):Object(zf.E)(e)?await Zf(e,t,s):await Xf(e,t,s)}(e.message,e.toUids,e.options)};var tv=async function(e,t,s){const i={success:[],failed:[]},n=(null==s?void 0:s.retry)||!1?e.cliMsgId:$l.a.next(),a=Sf.a.preprocessMessage(n+"",e,s.photoBundle),r=Object(Af.b)(e,{send2Me:t===mi.default.sendToMeId});a.reference=Object(Af.c)(r);const o={forwardRefLog:r,decorLog:Object(Af.a)(r)},l=Df(t);try{const e=await Sf.a.forward(n+"",a,l,o);if(e){const s=e.msgId||e.minGlobalMsgId;i.success.push({clientId:n+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:n+"",error:"invalid response",toUid:t})}catch(c){i.failed.push({clientId:n+"",error:c,toUid:t})}return Tf(a,l,i),i};var sv=async function(e,t,s){const i=(null==s?void 0:s.retry)||!1,n=i?e.msgId:"",a=i?e.cliMsgId:$l.a.next(),r=Sf.a.preprocessMessage(a+"",e,s.photoBundle),o=Mf(t,a,R.MSG_VIDEO,Object(f.a)({},r.message)),l=Object(Af.b)(e,{send2Me:t===mi.default.sendToMeId});o.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(l)),o.localPath=e.localPath;const c=zl.default.getChatBoxControllerByWindowId(Go.c),d=Df(t);return c._showLocalMessage(o,d,null,n,R.MSG_CHECKING_EXIST),[o,r]};var iv=async function(e,t,s){const i=zl.default.getChatBoxControllerByWindowId(Go.c),n={};for(const a in e)e[a]&&e[a].clientId&&(n[e[a].clientId]=e[a]);s.success.length&&s.success.forEach((e=>{i&&i._sentMessage(n[e.clientId],e)})),s.failed.length&&s.failed.forEach((e=>{!async function(e,t,s,i){var n;const a=s.error;a===R.FORWARD_ERR_CODE.EXPIRED||a===Uf.a.FILE_EXPIRED||a===R.FORWARD_ERR_CODE.SERVER_YAWNING||R.FORWARD_ERR_CODE.SEND_FAIL;const r=null==s||null===(n=s.error)||void 0===n?void 0:n.code;r!==Qu.a.DeleteConversationHasSendingMsg&&r!==Qu.a.DeleteSendingMsg&&r!==Qu.a.MsgArrivedBeforeAPIResponse&&i._handleForwardedMessageFailure(a,e,Df(e.conversationId),t)}(n[e.clientId],t,e,i)}))};var nv=async function(e,t,s){const i={success:[],failed:[]},[n,a]=await sv(e,t,s),r=n.clientId+"";let o=!1;s.photoBundle&&(o=Object(f.a)(Object(f.a)({},s.photoBundle),{},{clientId:r}));try{var l;const e=null===(l=n.reference)||void 0===l?void 0:l.data,s={forwardRefLog:e,decorLog:Object(Af.a)(e)},o=await uo.default.forwardMessage(t,a,r,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,n,s);if(o){const e=o.msgId||o.minGlobalMsgId;i.success.push({clientId:r,msgId:e+"",minGlobalMsgId:o.minGlobalMsgId+"",toUid:t,_msgObject:o._msgObject||null})}else i.failed.push({clientId:r,error:"invalid response",toUid:t})}catch(c){i.failed.push({clientId:r,error:c,toUid:t})}return await iv({[t]:n},e,i),i};var av=async function(e,t,s={}){const i=[];for(let n=0;n<t.length;n++){const a=t[n],r=ql.a.instance().isOnE2ee(a),o=_f.a.checkIsMessageFileE2ee(e);_f.a.checkIsForwardCrossConversation(o,r)?i.push(tv(e,t[n],s)):i.push(nv(e,t[n],s))}return Cf(await Promise.all(i))};var rv=async function(e){return av(e.message,e.toUids,e.options)};var ov=async function(e,t,s={}){const i=e.message,n=[];for(let a=0;a<t.length;a++){const e=t[a];let r=$l.a.next();for(let t=0;t<i.length;t++){const a=i[t],o={isGroupLayout:1,groupLayoutId:r,totalItemInGroup:i.length,idInGroup:t};s.photoBundle=o,a.msgType===R.MSG_VIDEO?n.push(rv({message:a,toUids:[e],options:s})):n.push(ev({message:a,toUids:[e],options:s}))}}return Cf(await Promise.all(n))},lv=function(e){return ov(e.message,e.toUids,e.options)},cv=s("Hllb"),dv=s("KZut"),uv=s("nWXR");var hv=async function(e,t,s={}){var i;const n=e.message&&"object"==typeof e.message&&"rtf"===e.message.action,a=ho.default.getSubtypeMessage(e);let r=null;const o=(null==s?void 0:s.retry)||!1,l=o?e.msgId:"",c={},d={};let u=ho.default.ZSafeFunction((()=>-1==a||a==R.MSG_SUBTYPE_LINK||n?ho.default.stripInvalidChar(e.message):e.message&&"object"==typeof e.message?e.message.title:""),"");if(!u)throw Object(cv.c)("Empty message",cv.a.EmptyString,e);let h=Jo.default.findFirstUrl(u,!0,!1);h&&dv.a.checkValidSuffix(h)&&e.shouldParseLinkOrContact&&(e.containType=2),n&&"object"==typeof e.message&&null!==(i=e.message)&&void 0!==i&&i.params&&(c.rtfProps=function(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return""}}(e.message.params),c.styles=c.rtfProps);const g=Object(Af.b)(e,{send2Me:!1}),m=Object(Af.b)(e,{send2Me:!0});for(let p=0;p<t.length;p++){const s=t[p];const i=Mf(s,(o?e.cliMsgId:$l.a.next())+"",R.MSG_TEXT),a=s===mi.default.sendToMeId?m:g;i.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(a)),n&&"object"==typeof e.message?(i.updateMessageContentProp(Kl.a.RTF,e.message),i.updateMessageContentProp(Kl.a.TEXT,e.message.title)):i.updateMessageContentProp(Kl.a.TEXT,u),e.containType&&(i.containType=e.containType,i.shouldParseLinkOrContact=e.shouldParseLinkOrContact),d[s]=i;const c=zl.default.getChatBoxControllerByWindowId(Go.c),v=Df(s);if(c._showLocalMessage(i,v,null,l),h&&e.shouldParseLinkOrContact){const t=uv.c.create(h).withTimeout(Co.a.ParserConfig.get("max_delay_send_message"));Co.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[uv.a.SHARE_MESSAGE,s]):t.do("parse",[uv.a.SHARE_MESSAGE]);const n=await t.exec().toPromise();n&&(i.type=R.MSG_LINK_CLIENT,i.updateMessageContentProp(Kl.a.LINK,Object(f.a)({},n)),d[s]=i,r=i.convertToUIMessageObject(),c._showLocalMessage(i,v,null,l)),uv.b.getInstance().report({key:null==e?void 0:e.msgId,href:h,entry:uv.a.SHARE_MESSAGE,preview:n})}}return{localMsgs:d,additional:c,updatedForwardMsgItem:r}};async function gv(e,t){const s=zl.default.getChatBoxControllerByWindowId(Go.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{var t;const n=null==e||null===(t=e.error)||void 0===t?void 0:t.code;if(n!==Qu.a.DeleteConversationHasSendingMsg&&n!==Qu.a.DeleteSendingMsg&&n!==Qu.a.MsgArrivedBeforeAPIResponse&&s){const t=i[e.clientId],n=t.conversationId;Rt.default.deleteMessageById(ho.default.getMsgIdSendingFromCliMsgId(e.clientId),n),s._handleForwardedMessageFailure(e.error,t,Df(n))}}))}async function mv(e,t,s){var i,n;const a=mi.default.sendToMeId||"",r={forwardRefLog:null===(i=t.reference)||void 0===i?void 0:i.data,decorLog:Object(Af.a)(null===(n=t.reference)||void 0===n?void 0:n.data)};let o=s?Object(f.a)(Object(f.a)({},s),r):r,l=t.clientId;const c={success:[],failed:[]};try{const t=await uo.default.forwardMultiMessage([{clientId:l,toUid:a}],e,!1,1e4,!1,o);t.success&&t.success.length&&t.success.forEach((e=>{c.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:a}))})),t.failed&&t.failed.length&&t.failed.forEach((e=>{c.failed.push(Object(f.a)(Object(f.a)({},e),{},{toUid:a}))}))}catch(d){c.failed.push({clientId:""+l,error:d,toUid:a})}return c}var pv=s("A/lx");async function fv(e,t,s,i){const n=[],a=[],r={success:[],failed:[]};if(t.forEach((e=>{const t=Zo.default.getGroupByIdSync(e);var i;t&&t.totalMember>=mi.default.forward_group_limit_mem?a.push(e):n.push({clientId:(null===(i=s[e])||void 0===i?void 0:i.clientId)||$l.a.next(),grid:Object(pv.a)(e)})})),a.length)for(let c=0;c<a.length;c++){var o;const e=a[c],t=null===(o=s[R.GROUPID_PREFIX+e].reference)||void 0===o?void 0:o.data,n={forwardRefLog:t,decorLog:Object(Af.a)(t)},d=i?Object(f.a)(Object(f.a)({},i),n):n;try{const t=await uo.default.sendMsgObject(s[e],null,null,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,d);r.success.push({clientId:s[e].clientId,msgId:t.msgId,toUid:R.GROUPID_PREFIX+e})}catch(l){r.failed.push({clientId:s[e].clientId,error:l,toUid:R.GROUPID_PREFIX+e})}}if(n.length){const t=Ef(n),s={};n.forEach((e=>{s[e.clientId]=e.grid}));try{for(let n=0;n<t.length;n++){const a=await uo.default.forwardMultiMessage(t[n],e,!0,1e4,!1,i);a.success&&a.success.length&&a.success.forEach((e=>{r.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:R.GROUPID_PREFIX+s[e.clientId]}))})),a.failed&&a.failed.length&&a.failed.forEach((e=>{r.failed.push(Object(f.a)(Object(f.a)({},e),{},{toUid:R.GROUPID_PREFIX+s[e.clientId]}))}))}}catch(l){for(let e=0;e<n.length;e++)r.failed.push({clientId:""+n[e].clientId,error:l,toUid:R.GROUPID_PREFIX+n[e].grid})}}return r}async function vv(e,t,s,i){const n=[];t.forEach((e=>{var t;n.push({clientId:(null===(t=s[e])||void 0===t?void 0:t.clientId)||$l.a.next(),toUid:e})}));const a={success:[],failed:[]},r=Ef(n),o={};n.forEach((e=>{o[e.clientId]=e.toUid}));for(let c=0;c<r.length;c++){const t=r[c];try{const s=await uo.default.forwardMultiMessage(t,e,!1,1e4,!1,i);s.success&&s.success.length&&s.success.forEach((e=>{a.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:o[e.clientId]}))})),s.failed&&s.failed.length&&s.failed.forEach((e=>{a.failed.push(Object(f.a)(Object(f.a)({},e),{},{toUid:o[e.clientId]}))}))}catch(l){for(let e=0;e<t.length;e++)a.failed.push({clientId:""+t[e].clientId,error:l,toUid:t[e].toUid})}}return a}var bv=async function(e,t,s={}){const{groups:i,oneOnes:n,sendToMe:a}=Of(t),{localMsgs:r,additional:o,updatedForwardMsgItem:l}=await hv(e,t,Object(f.a)(Object(f.a)({},s),{},{send2Me:!!a})),c=l||e,d=[];if(a){const e=await mv(c,r[a],o);d.push(e)}if(i.length){const e=await fv(c,i,r,o);d.push(e)}if(n.length){const e=await vv(c,n,r,o);d.push(e)}const u=({success:[],failed:[]}=Cf(d));return await gv(r,u),u};var Iv=async function(e){return bv(e.message,e.toUids,e.options)};var yv=async function(e,t,s={}){const n={},a={},{userId:r}=i.ModuleContainer.resolve(Je.a).getSession()||{},o=zl.default.getChatBoxControllerByWindowId(Go.c),l=(null==s?void 0:s.retry)||!1,c=l?e.msgId:"",d=Object(Af.b)(e,{send2Me:!1}),u=Object(Af.b)(e,{send2Me:!0});for(let i=0;i<t.length;i++){const s=t[i];const n=Mf(s,l?e.cliMsgId:$l.a.next(),R.MSG_STICKER),r=s===mi.default.sendToMeId?u:d;n.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(r)),n.updateMessageContentProp(Kl.a.STICKER,e.message),a[s]=n;const h=Df(s);o._showLocalMessage(n,h,null,c)}for(let i=0;i<t.length;i++){const s=Lf(e,r||"",t[i]);n[t[i]]=s}return{localMsgs:a,additionalList:n}};var _v=async function(e,t,s={}){const{groups:i,oneOnes:n,sendToMe:a}=Of(t),{localMsgs:r,additionalList:o}=await yv(e,t,s),l=[];if(a){const t=await mv(e,r[a]);l.push(t)}if(i.length){const t=await fv(e,i,r);l.push(t)}if(n.length){const t=await vv(e,n,r);l.push(t)}const c=({success:[],failed:[]}=Cf(l));return await gv(r,c),c};var Cv=async function(e){return _v(e.message,e.toUids,e.options)};var Ov=async function(e,t,s={}){const[i,n]=Jo.default.shouldReparseLink(e),a=zl.default.getChatBoxControllerByWindowId(Go.c),r=(null==s?void 0:s.retry)||!1,o=r?e.msgId:"";let l={localMsgs:{},preview:null};l=i&&s.isForwardSingleMsg?await async function(e,t,s,i){var n;const a=Jo.default.isLongUrl(e||""),r=Co.a.LinkPreviewRespository.getKey("meta-data",[e]),o=null===(n=Co.a.LinkPreviewRespository.metaData.get(r))||void 0===n?void 0:n.value,l={localMsgs:{},preview:null};for(let g=0;g<s.length;g++){const n=s[g],r=Mf(n,i?t.cliMsgId:$l.a.next(),R.MSG_LINK_CLIENT),m=Object(Af.b)(t,{send2Me:n===mi.default.sendToMeId});r.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(m)),o&&!a?(r.updateMessageContentProp(Kl.a.TEXT,t.message.title),r.updateMessageContentProp(Kl.a.LINK,o)):(r.updateMessageContentProp(Kl.a.TEXT,t.message.title||t.message.href),r.type=R.MSG_TEXT);let p=new Promise((e=>e(null)));if(a){uv.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:uv.a.SHARE_MESSAGE,preview:null}),l.localMsgs[n]=r;continue}if(o){let t=!1;const s=uv.c.create(e);if(Co.a.ParserConfig.get("enable_upload_thumb_for_delay_send")){var c,d;const i=Co.a.LinkPreviewRespository.getKey("meta-data",[e]);t=!(null===(c=Co.a.LinkPreviewRespository.metaData.get(i))||void 0===c||null===(d=c.value)||void 0===d||!d.thumbOrigin),t&&s.do("download-thumb")}else{var u,h;const s=Co.a.LinkPreviewRespository.getKey("thumb-local",[e]);t=!(null===(u=Co.a.LinkPreviewRespository.thumbLocal.get(s))||void 0===u||null===(h=u.value)||void 0===h||!h.thumbLocal)}t&&(p=s.do("upload-thumb",[n]).exec().toPromise())}else if(null!==o){const t=uv.c.create(e).withTimeout(Co.a.ParserConfig.get("max_delay_send_message"));Co.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[uv.a.SHARE_MESSAGE,n]):t.do("parse",[uv.a.SHARE_MESSAGE]),p=t.exec().toPromise()}const f=await p;uv.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:uv.a.SHARE_MESSAGE,preview:f}),f&&(r.type=R.MSG_LINK_CLIENT,r.updateMessageContentProp(Kl.a.LINK,Be.g.clone(f)),l.preview=f),l.localMsgs[n]=r}return l}(n||"",e,t,r):await async function(e,t,s,i){const n={localMsgs:{},preview:null},a=Jo.default.isLongUrl(e||""),[,r]=Be.g.safeParseJson(t.message.params);for(let o=0;o<s.length;o++){const l=i?t.cliMsgId:$l.a.next(),c=s[o],d=Mf(c,l,R.MSG_TEXT),u=Object(Af.b)(t,{send2Me:c===mi.default.sendToMeId});d.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(u)),a||(d.type=R.MSG_LINK_CLIENT,d.updateMessageContentProp(Kl.a.LINK,{width:r.width,height:r.height,desc:t.message.description,href:t.message.href,src:r.src,media:r,thumb:t.message.thumb,title:r.mediaTitle})),uv.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:uv.a.SHARE_MESSAGE,preview:null}),t.message.title&&d.updateMessageContentProp("text",t.message.title),n.localMsgs[c]=d}return n}(n||"",e,t,r);for(let c in l.localMsgs){const t=l.localMsgs[c],s=Df(c);a._showLocalMessage(t,s,e,o)}return l};var Ev=async function(e,t,s={}){const{localMsgs:i,preview:n}=await Ov(e,t,s),a=Object(f.a)({},e);if(n){var r;const t=n.media||{};let s="";if(Object.keys(t).length>0)s=JSON.stringify(t);else{const[t,i]=Be.g.safeParseJson(e.message.params);i.mediaTitle=n.title,s=JSON.stringify(i)}a.message={action:"recommened.link",childnumber:0,description:n.desc||"",href:n.href,params:s,thumb:n.thumb||"",title:e.message.title,type:(null===(r=n.media)||void 0===r?void 0:r.type)||""}}const{groups:o,oneOnes:l,sendToMe:c}=Of(t),d=[];if(c){const e=await mv(a,i[c]);d.push(e)}if(o.length){const e=await fv(a,o,i);d.push(e)}if(l.length){const e=await vv(a,l,i);d.push(e)}const u=({success:[],failed:[]}=Cf(d));return await gv(i,u),u};var Mv=async function(e){return Ev(e.message,e.toUids,e.options)};var Sv=async function(e,t,s){const i={localMsgs:{}},n=zl.default.getChatBoxControllerByWindowId(Go.c),a=(null==s?void 0:s.retry)||!1,r=a?e.msgId:"",o=Object(Af.b)(e,{send2Me:!1}),l=Object(Af.b)(e,{send2Me:!0});for(let c=0;c<t.length;c++){const s=t[c];const d=Mf(s,(a?e.cliMsgId:$l.a.next())+"",e.msgType,e.message),u=s===mi.default.sendToMeId?l:o;d.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(u)),i.localMsgs[s]=d;const h=Df(s);n._showLocalMessage(d,h,null,r)}return i};var Tv=async function(e,t,s={}){const{localMsgs:i}=await Sv(e,t,s),n={success:[],failed:[]};for(let o=0;o<t.length;o++){var a;const s=t[o],l=i[s],c=null===(a=l.reference)||void 0===a?void 0:a.data,d={forwardRefLog:c,decorLog:Object(Af.a)(c)};try{const i=await uo.default.forwardMessage(t[o],e,l.clientId,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,l,d);n.success.push({clientId:l.clientId+"",msgId:(i.msgId||i.minGlobalMsgId)+"",minGlobalMsgId:i.minGlobalMsgId+"",toUid:s})}catch(r){n.failed.push({clientId:l.clientId+"",error:r,toUid:s})}}return await gv(i,n),n};var wv=async function(e){return Tv(e.message,e.toUids,e.options)};var Rv=async function(e,t,s={}){const i=[];for(let a=0;a<t.length;a++){const r={success:[],failed:[]},o=s.retry?e.cliMsgId:$l.a.next(),l=Sf.a.preprocessMessage(o+"",e,null),c=Df(t[a]),d=t[a]===mi.default.sendToMeId,u=Object(Af.b)(e,{send2Me:d}),h={forwardRefLog:u,decorLog:Object(Af.a)(u)};l.reference=Object(Af.c)(u);try{const e=await Sf.a.forward(o+"",l,c,h);e?r.success.push({clientId:o+"",msgId:(e.msgId||e.minGlobalMsgId)+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t[a]}):r.failed.push({clientId:o+"",error:"invalid response",toUid:t[a]})}catch(n){r.failed.push({clientId:o+"",error:n,toUid:t[a]})}Tf(l,c,r),i.push(r)}return Cf(i)};var Lv=async function(e){return Rv(e.message,e.toUids,e.options)};var Dv=async function(e,t,s={}){const i={},n=zl.default.getChatBoxControllerByWindowId(Go.c),a=(null==s?void 0:s.retry)||!1,r=a?e.msgId:"",o=Object(Af.b)(e,{send2Me:!1}),l=Object(Af.b)(e,{send2Me:!0});for(let c=0;c<t.length;c++){const s=t[c];const d=Mf(s,a?e.cliMsgId:$l.a.next(),R.MSG_GIF);let{oriUrl:u,normalUrl:h,params:g}=e.message;if(g){let e=jf.a.utils.safeParseJSON(g);const{width:t=0,height:s=0}=e,i={};u&&(i.original={width:t,height:s,url:u}),h&&(i.normal={width:t,height:s,url:h}),d.updateMessageContentProp(Kl.a.GIF,i)}d.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(s===mi.default.sendToMeId?l:o)),i[s]=d;const m=Df(s);n._showLocalMessage(d,m,e,r)}return{localMsgs:i}};var Av=async function(e,t,s={}){const i={success:[],failed:[]},{localMsgs:n}=await Dv(e,t,s);for(let o=0;o<t.length;o++){var a;const s=t[o],l=n[s],c=null===(a=l.reference)||void 0===a?void 0:a.data,d={forwardRefLog:c,decorLog:Object(Af.a)(c)};try{const t=await uo.default.forwardMessage(s,e,l.clientId,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,l,d);t?i.success.push({clientId:l.clientId+"",msgId:(t.msgId||t.minGlobalMsgId)+"",minGlobalMsgId:t.minGlobalMsgId+"",toUid:s}):i.failed.push({clientId:l.clientId+"",error:"invalid response",toUid:s})}catch(r){i.failed.push({clientId:l.clientId+"",error:r,toUid:s})}}return await gv(n,i),i};var Fv=async function(e){return Av(e.message,e.toUids,e.options)};var jv=async function(e,t,s,i={}){const{localMsgs:n,additionalList:a}=s,r={success:[],failed:[]};for(let c=0;c<t.length;c++){var o;const s=t[c],i=n[s],d=null===(o=i.reference)||void 0===o?void 0:o.data,u=Object(f.a)(Object(f.a)({},a[s]||{}),{},{forwardRefLog:d,decorLog:Object(Af.a)(d)});try{const n=await uo.default.forwardMessage(t[c],e,i.clientId,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,i,u);r.success.push({clientId:i.clientId+"",msgId:(n.msgId||n.minGlobalMsgId)+"",minGlobalMsgId:n.minGlobalMsgId+"",toUid:s})}catch(l){r.failed.push({clientId:i.clientId+"",error:l,toUid:s})}}return r};var Pv=class{constructor(e,t,s){this.message=e,this.toUids=t,this.options=s,this.preprocessResult=void 0,this.result=void 0,this.preprocessResult={},this.result={success:[],failed:[]}}async execute(){return this.preprocessResult=await this.preprocess(),this.result=await this.process(),this.postprocess(),this.result}};var kv=async function(e,t,s){const i={localMsgs:{},additionalList:{}},n=zl.default.getChatBoxControllerByWindowId(Go.c),a=(null==s?void 0:s.retry)||!1,r=a?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const l=Mf(s,(a?e.cliMsgId:$l.a.next())+"",e.msgType,e.message),c=Object(Af.b)(e,{send2Me:s===mi.default.sendToMeId});l.updateMessageProp(Kl.b.REFERENCE,Object(Af.c)(c)),i.localMsgs[s]=l;const d=Df(s);n._showLocalMessage(l,d,null,r)}return i};class Nv extends Pv{async preprocess(){return kv(this.message,this.toUids,this.options)}async process(){return jv(this.message,this.toUids,this.preprocessResult,this.options)}async postprocess(){return gv(this.preprocessResult.localMsgs,this.result)}}var Uv=async function(e){return new Nv(e.message,e.toUids,e.options).execute()};yf.a.registerHandler(If.a.PHOTO,ev),yf.a.registerHandler(If.a.FILE,Gf),yf.a.registerHandler(If.a.VIDEO,rv),yf.a.registerHandler(If.a.TEXT,Iv),yf.a.registerHandler(If.a.STICKER,Cv),yf.a.registerHandler(If.a.LINK,Mv),yf.a.registerHandler(If.a.CONTACT,wv),yf.a.registerHandler(If.a.VOICE,Lv),yf.a.registerHandler(If.a.GIF,Fv),yf.a.registerHandler(If.a.GROUP_PHOTO,lv),yf.a.registerHandler(If.a.DEFAULT,Uv);class Bv{constructor(e){this._state=Bv.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=void 0,this._reject=void 0,this._promise=new e(((e,t)=>{this._resolve=e,this._reject=t}))}reject(e){this._state===Bv.PENDING&&(this._state=Bv.REJECTED,this._reject(e))}resolve(e){this._state===Bv.PENDING&&(this._state=Bv.FULFILLED,this._resolve(e))}get state(){return this._state}get promise(){return this._promise}}Bv.PENDING="PENDING",Bv.FULFILLED="FULFILLED",Bv.REJECTED="REJECTED";var xv=Bv;const Gv={cancelledReason:"Task cancelled",timeoutReason:"Task timeout"};class zv extends xv{constructor(e,t=void 0,s=Gv){super(Promise),this.executor=e,this.ttl=t,this.options=s,this._events=new Map,this._creationTimestamp=0,this._timeout=0,this.creationTimestamp=performance.now(),this.timeout=0,void 0!==t&&this.setTimeout()}addEventListener(e,t){let s=this.events.get(e);s||(s=[],this.events.set(e,s)),s.push(t)}cancel(){this.reject(this.getOptions().cancelledReason)}execute(...e){return this.executor.apply(this,e).then(this.resolve.bind(this)).catch(this.reject.bind(this)),this.promise}removeEventListener(e,t){const s=this.events.get(e);if(!s)return;this.events.set(e,s.filter((e=>e!==t)))}getOptions(){return Object(f.a)(Object(f.a)({},Gv),this.options)}removeTimeout(){this.timeout&&clearTimeout(this.timeout),this.timeout=0}setTimeout(){if(this.state!==zv.PENDING)return;if(isNaN(this.ttl)||this.ttl<=0)throw new Error("delay must be a positive int");const e=performance.now()-this.creationTimestamp;this.timeout&&this.removeTimeout(),this.timeout=window.setTimeout((()=>this.reject(this.getOptions().timeoutReason)),Math.max(this.ttl-e,0))}get events(){return this._events}get creationTimestamp(){return this._creationTimestamp}set creationTimestamp(e){this._creationTimestamp=e}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var Vv=zv,Hv=s("gOiJ"),Wv=s("1OYu");var $v=function(e){const t=e.msgType;return t===R.MSG_PHOTO_GROUP?[If.a.GROUP_PHOTO,yf.a.getHandler(If.a.GROUP_PHOTO)]:t===R.MSG_PHOTO||t===R.MSG_PHOTO_2||t===R.MSG_DOODLE?[If.a.PHOTO,yf.a.getHandler(If.a.PHOTO)]:t===R.MSG_FILE?[If.a.FILE,yf.a.getHandler(If.a.FILE)]:t===R.MSG_VIDEO?[If.a.VIDEO,yf.a.getHandler(If.a.VIDEO)]:t===R.MSG_TEXT?[If.a.TEXT,yf.a.getHandler(If.a.TEXT)]:t===R.MSG_STICKER?[If.a.STICKER,yf.a.getHandler(If.a.STICKER)]:t===R.MSG_CONTACT&&"recommened.link"==e.message.action||"link"===e.type?[If.a.LINK,yf.a.getHandler(If.a.LINK)]:t!==R.MSG_CONTACT||"recommened.user"!=e.message.action&&"recommened.vip"!=e.message.action?t===R.MSG_VOICE?[If.a.VOICE,yf.a.getHandler(If.a.VOICE)]:t===R.MSG_GIF?[If.a.GIF,yf.a.getHandler(If.a.GIF)]:[If.a.DEFAULT,yf.a.getHandler(If.a.DEFAULT)]:[If.a.CONTACT,yf.a.getHandler(If.a.CONTACT)]};var Kv,qv=class{constructor(e,t){this.messages=e,this.toUids=t,this.startTime=0,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("forward-log",["track forward message"])),this._Logger}startForward(){this.startTime=performance.now()}endForward(e){for(let t=0;t<e.length;t++)this.logForMsg(this.messages[t],e[t]);this.logForwardDone()}logForwardDone(){let e=0,t=0,s=0,i=0;for(let n=0;n<this.toUids.length;n++){const a=this.toUids[n];a.startsWith(R.GROUPID_PREFIX)?e++:a===mi.default.sendToMeId?i++:(t++,ns.default.isFriend(a)||s++)}for(let n=0;n<this.messages.length;n++){const a=this.messages[n];as.default.logActionInfoV2(as.FeaturesInfo.ForwardMessage,0,{src_id:a.toUid||a.userId,msgType:a.msgType,gapTime:Date.now()-+a.sendDttm,duration:performance.now()-this.startTime,totalConv:this.toUids.length,chatgroup:e,chat11:t,stranger:s,mycloud:i})}}logForMsg(e,t){t.success.length>0&&this.logSuccess(e,t.success),t.failed.length>0&&this.logFail(e,t.failed)}logSuccess(e,t){}logFail(e,t){const s=e.toUid||e.userId,i=ql.a.instance().isOnE2ee(s);for(let n=0;n<t.length;n++){const{error:a,toUid:r}=t[n],o=ql.a.instance().isOnE2ee(r);let l=0;l=i||o?i&&o?1:2:0;let c=1;r.startsWith(R.GROUPID_PREFIX)?c=2:r===mi.default.sendToMeId&&(c=3);let d=0;if(d="string"==typeof a||"number"==typeof a?a:(null==a?void 0:a.code)||(null==a?void 0:a.errorCode)||(null==a?void 0:a.error_code)||a.message,d===Qu.a.DeleteConversationHasSendingMsg||d===Qu.a.DeleteSendingMsg||d===Qu.a.MsgArrivedBeforeAPIResponse)return;const u={fail_error:d,e2ee:l,msgtype:e.msgType,src_id:s,chat_type:c,duration:performance.now()-this.startTime,number_conversation:this.toUids.length};mi.default.forward_messages.enable_tracking_log?this.Logger.zsymb(21,"Vpzm_L",["forwardMessageFromLocal fail : {} {}","_FOvNo"],JSON.stringify(u),e):this.Logger.zsymb(21,"ucU4pf",["forwardMessageFromLocal fail : {}","5Z8ZlU"],JSON.stringify(u)),as.default.logActionInfoV2(as.FeaturesInfo.ForwardMsgFail,0,u)}}};Object(i.injectable)()(Kv=Object(i.singleton)(Wv.a)(Kv=function(e,t){return Object(i.inject)(ff)(e,void 0,0)}(Kv=Reflect.metadata("design:type",Function)(Kv=Reflect.metadata("design:paramtypes",[Object])(Kv=class{constructor(e){this.poolFactory=e,this._pool=void 0}async forwardMessages(e,t,s={}){this.pool||this.initializePool(),e.forEach((e=>{e.toUid||(e.toUid=e.userId)}));const i=this.buildTask(e,t,s||{});return this.pool.use(i).then((e=>Promise.resolve(e)))}async retryForwardMessages(e,t={}){const s=Object(f.a)(Object(f.a)({},t),{},{retry:!0});this.pool||this.initializePool();const i=e.map((e=>e.toUid)),n=this.buildTask(e,i,s);return this.pool.use(n).then((e=>Promise.resolve(e)))}buildTask(e,t,s){return async()=>{try{return await this.runTaskInSerialization(e,t,s)}catch(i){return Promise.reject(i)}}}cleanUp(){this.pool&&this.pool.drain(),this.pool=void 0}initializePool(){const e={max:Object(Hv.b)(),min:Object(Hv.c)(),autostart:!0};this.pool=this.poolFactory.createPool({create:async()=>({}),destroy:async()=>{}},e)}async runSubTask(e,t,s){const[i,n]=$v(e);if(null==n)return Promise.reject("Invalid handler");try{const i=new Vv(n,Object(Hv.a)());return await i.execute({message:e,toUids:t,options:s})}catch(a){return Promise.reject(a)}}async runTaskInSerialization(e,t,s){const i=[];e.forEach((e=>{i.push(this.runSubTask.bind(null,Object(f.a)(Object(f.a)({},e),{},{mentions:null}),t,s))}));const n=new qv(e,t);n.startForward();const a=await async function(e){if(!Array.isArray(e))return Promise.reject("Params functions is invalid");const t=[...e],s=[];for(const n of t)try{const e=await n();s.push({isSuccess:!0,data:e})}catch(i){s.push({isSuccess:!1,error:i})}return s}(i);try{const e=a.map(((e,t)=>e.data));n.endForward(e)}catch(o){}const r=a.map(((t,s)=>({id:e[s].msgId,isSuccess:t.isSuccess,data:t.data,error:t.error})));return Promise.resolve(r)}get pool(){return this._pool}set pool(e){this._pool=e}})||Kv)||Kv)||Kv)||Kv);const Qv=Object(i.define)("ACTIVE_CONVERSATION_INFO_LIST_FOR_PIN_TOPIC");var Zv;Object(i.injectable)()(Zv=Object(i.singleton)(Qv)(Zv=class{constructor(){this._activeConversationInfoList=new Map}activateConversation(e,t){if(!e||!t)return;const s=this._activeConversationInfoList.get(e);if(s){const i=s.tokens.indexOf(this._getToken(e,t));-1===i&&s.tokens.push(this._getToken(e,t));const n=s.windowIds.indexOf(t);-1===n&&s.windowIds.push(t),-1!==i&&-1!==n||(s.lastModified=Date.now(),this._activeConversationInfoList.set(this._getKey(e),s))}else this._activeConversationInfoList.set(this._getKey(e),{lastModified:Date.now(),tokens:[this._getToken(e,t)],windowIds:[t]})}deactivateConversation(e,t){const s=this._activeConversationInfoList.get(e);if(s){s.lastModified=Date.now();let i=s.tokens.indexOf(this._getToken(e,t));i>-1&&s.tokens.splice(i,1);const n=s.windowIds.indexOf(t);n>-1&&s.windowIds.splice(n,1),0===s.windowIds.length&&0===s.tokens.length?this._activeConversationInfoList.delete(e):this._activeConversationInfoList.set(e,s)}}getActiveConversationInfo(e){const t=this._activeConversationInfoList.get(e);return t?{lastModified:t.lastModified,tokens:[...t.tokens],windowIds:[...t.windowIds]}:{lastModified:0,tokens:[],windowIds:[]}}getActiveConvIdList(){let e=[];return this._activeConversationInfoList.size>0&&(e=Array.from(this._activeConversationInfoList.keys())),e}_getKey(e){return e}_getToken(e,t){return`${e}_${t}`}})||Zv);var Jv=s("+3r3"),Yv=s("YYsv"),Xv=s("3ZdV");var eb=Object(i.define)("pin-topic-data-repository");var tb=Object(i.define)("pin-topic-message-loader"),sb=s("0URt"),ib=s("DRpF");function nb(e){return!(-1===Object(sb.g)().indexOf(e.msgType))&&!Object(ib.a)(e)}function ab(e,t,s){return s===e?1:s<t?0:-1}function rb(e){const t={needFetch:!1,reason:""};if(null==e||null==e||!e.lastFetch)return t.needFetch=!0,t.reason="empty",t;const{lastFetch:s}=e,i=function(e){return Hg.a.isOverflowAtTime(e)}(s);if(i)return t.needFetch=!0,t.reason="overflow",t;const n=function(e){return Date.now()-e>Object(Xv.e)()}(s);if(n)return t.needFetch=!0,t.reason="expired",t;const a=function(e){const t=E.default.getInstance().getItemForCurrentUser(Yv.g.FORCE_FETCH_MILESTONE);return!(!t||isNaN(+t))&&e<+t}(s);return a?(t.needFetch=!0,t.reason="forcedByServer",t):t}function ob(e){const t=[];return e.forEach((e=>{t.push({topicId:e.id,topicType:e.type})})),t}var lb=s("UIHX");function cb(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.client_msg_id)||""}function db(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.global_msg_id)||""}function ub(e,t,s){let i=t;const{topics:n}=s;if(!Array.isArray(n))return i;switch(e){case lb.a.ADD:{const{index:e}=s;i=null==e?[...n,...t]:[...t.slice(0,e),...n,...t.slice(e)];break}case lb.a.REMOVE:{const e={};n.forEach((t=>{e[t.id]=t.type})),i=[],t.forEach((t=>{(!e.hasOwnProperty(t.id)||e.hasOwnProperty(t.id)&&e[t.id]!==t.type)&&i.push(t)}));break}}return i}function hb(e){const t=e=>{if(!Array.isArray(e))return e;const t=[];for(let s=0;s<e.length;s++){const i=e[s];i&&(null!=i.id&&(i.id=i.id.toString()),null!=i.topicId&&(i.topicId=i.topicId.toString()),null!=i.type&&(i.type=parseInt(i.type)),null!=i.topicType&&(i.topicType=parseInt(i.topicType)),t.push(i))}return t},s=Object(f.a)({},e);return null!=s.oldTopic&&(s.oldTopic=t([s.oldTopic])[0]),null!=s.topic&&(s.topic=t([s.topic])[0]),null!=s.topics&&(s.topics=t(s.topics)),s}function gb(e){let t={};if(!e.params)return e;try{t=JSON.parse(e.params)}catch(s){return}if(t.extra&&t.extra.constructor===String)try{t.extra=JSON.parse(t.extra)}catch(s){return}return e.params=t,e}function mb(e){return new Promise((t=>{let s=0,i=0,n={};for(let a in e)s++,e[a].then((e=>{n[a]=e,i++,i===s&&t(n)})).catch((()=>{n[a]=null,i++,i===s&&t(n)}));0===s&&t({})}))}function pb(e,t){return Object(Hp.f)(e,Number.isInteger(+t)?t:1/0)}var fb=Object(i.define)("pin-topic-one-on-one-controller");var vb=class{constructor(e,t){this.moduleName=e,this.instanceNames=t,this.instanceMap=new Map}error(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(18,"gonzEd",...t)}info(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(0,"MMf736",...t)}getLogger(e){if(this.instanceNames.includes(e)&&void 0===this.instanceMap.get(e)){const t=this.LoggerFactory.createZLogger(Ve.ZLoggerNametags.pinTopic,[this.moduleName,e]);this.instanceMap.set(e,t)}return this.instanceMap.get(e)}get LoggerFactory(){return i.ModuleContainer.resolve(Me.ZLoggerFactory)}},bb=function(e){return e.CONTROL="control",e.CREATE="create",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(bb||{});var Ib,yb=class extends vb{constructor(){super(lb.f.OneOnOneController,[bb.CONTROL,bb.CREATE,bb.LOAD,bb.REORDER,bb.UNPIN])}infoControl(...e){this.logInfo(bb.CONTROL,...e)}infoCreate(...e){this.logInfo(bb.CREATE,...e)}infoLoad(...e){this.logInfo(bb.LOAD,...e)}infoReorder(...e){this.logInfo(bb.REORDER,...e)}infoUnpin(...e){this.logInfo(bb.UNPIN,...e)}errorControl(...e){this.logError(bb.CONTROL,...e)}errorCreate(...e){this.logError(bb.CREATE,...e)}errorLoad(...e){this.logError(bb.LOAD,...e)}errorReorder(...e){this.logError(bb.REORDER,...e)}errorUnpin(...e){this.logError(bb.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Xv.g)()}};Object(i.injectable)()(Ib=Object(i.singleton)(fb)(Ib=function(e,t){return Object(i.inject)(eb)(e,void 0,0)}(Ib=function(e,t){return Object(i.inject)(tb)(e,void 0,1)}(Ib=Reflect.metadata("design:type",Function)(Ib=Reflect.metadata("design:paramtypes",[Object,Object])(Ib=class{constructor(e,t){this.dataRepository=e,this.messageLoader=t,this.events={},this.logger=void 0,this.requestID=void 0,this.initialize(),this.logger=new yb,this.requestID=new xi.a}getPinTopic(e,t,s){return new Promise(((i,n)=>{this.loadPinTopics(e).then((e=>{const{topics:a}=e,r=a.find((e=>e.id===(null==t?void 0:t.toString())&&e.type===s));r?i(r):n(null)})).catch(n)}))}getMessageFromTopic(e){return this.MessageLoader.getMessageFromTopic(e)}displayEntryPointPromotionalTooltip(){this.DataRepository.setEntryPointPromotionalTooltipShowedStatus(!0)}isDisplayedEntryPointPromotionalTooltip(){if(!Object(Xv.l)())return!0;const e=this.DataRepository.getEntryPointPromotionalTooltipShowedStatus();return null!==e&&Boolean(e)}async loadPinTopics(e,t=!1){if(!Object(Xv.k)())return Promise.reject({code:Yv.c.OFF_FEATURE,message:""});const s=this.getRequestID();try{var i;let n;t&&(n=Yv.e.OPEN_DIALOG),this.Logger.infoLoad(s,`call cId:${e}`,t);const a=await this.DataRepository.loadPinTopics(e,n);return this.Logger.infoLoad(s,`res cId:${e}`,!!a,a.conversationId,null===(i=a.topics)||void 0===i?void 0:i.length),{conversationId:a.conversationId,topics:a.topics}}catch(n){return this.Logger.errorLoad(s,`err cId:${e}`,pb(n,Object(Xv.a)())),Promise.reject(n)}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}removeEventListener(e,t){const s=this.events[e],i=(this.events[e]||[]).length;for(let n=0;n<i;n++)if(s[n]===t){s.splice(n,1);break}0===s.length&&delete this.events[e]}removeEventListeners(e){delete this.events[e]}handleEventControl(e){if(!Object(Xv.k)())return;const t=this.getRequestID();this.Logger.infoControl(t,"recv",e.act,pb(e.data,Object(Xv.a)())),this.DataRepository.handleReceivingEvent(e.act,e.data).then((s=>{if(this.Logger.infoControl(t,"res",e.act,pb(s,Object(Xv.a)())),e.act===Yv.d.UNPIN){let t=[];if(Array.isArray(e.data.topics)&&e.data.topics.forEach((e=>{s.topics.find((t=>t.id===e.topicId&&t.type===e.topicType))||t.push({topicId:e.topicId,topicType:e.topicType})})),t.length>0){const s={};t.forEach((t=>{s[`${t.topicId}_${t.topicType}`]=this.getPinTopic(e.data.conversationId,t.topicId,t.topicType)})),mb(s).then((e=>{const t=Object.keys(e).map((t=>e[t]));this.MessageLoader.removeMessages(t)}))}}this.MessageLoader.loadMessages(s.conversationId,s.topics),this.notifyChangeEvent(s.conversationId,s.topics)})).catch((s=>{this.Logger.errorControl(t,"err",e.act,pb(s,Object(Xv.a)()))}))}async createPinTopic(e,t,s=2){if(!Object(Xv.k)())return Promise.reject({code:Yv.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var n;if(this.Logger.infoCreate(i,`call cId:${e}`,!!t,s),!this.isValidNetwork())return Promise.reject({code:Yv.c.NO_NETWORK,message:"STR_CHECK_NET"});const a=await this.retryable(s,(()=>this.processCreatePinTopic(e,t,s)));return this.Logger.infoCreate(i,`res cId:${e}`,!!a,null==a?void 0:a.conversationId,null==a||null===(n=a.topics)||void 0===n?void 0:n.length),a}catch(a){return this.Logger.errorCreate(i,`err cId:${e}`,pb(a,Object(Xv.a)())),Promise.reject(a)}}async reorderPinTopics(e,t,s=2){if(!Object(Xv.k)())return Promise.reject({code:Yv.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var n;if(this.Logger.infoReorder(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Yv.c.NO_NETWORK,message:"STR_CHECK_NET"});const a=await this.retryable(s,(()=>this.processReorderPinTopics(e,t,s)));return this.Logger.infoReorder(i,`res cId:${e}`,!!a,null==a?void 0:a.conversationId,null==a||null===(n=a.topics)||void 0===n?void 0:n.length),a}catch(a){return this.Logger.errorReorder(i,`err cId:${e}`,pb(a,Object(Xv.a)())),Promise.reject(a)}}async unpinPinTopics(e,t,s=2){if(!Object(Xv.k)())return Promise.reject({code:Yv.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var n;if(this.Logger.infoUnpin(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Yv.c.NO_NETWORK,message:"STR_CHECK_NET"});const a=await this.retryable(s,(()=>this.processUnpinPinTopics(e,t,s)));return this.Logger.infoUnpin(i,`res cId:${e}`,!!a,null==a?void 0:a.conversationId,null==a||null===(n=a.topics)||void 0===n?void 0:n.length),a}catch(a){return this.Logger.errorUnpin(i,`err cId:${e}`,pb(a,Object(Xv.a)())),Promise.reject(a)}}isMessagePinnable(e){return function(e){return nb(e)}(e)}initialize(){this.FriendManager.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,(e=>{const{userId:t}=e;t&&this.clearTopics(t)})),Object(Jv.b)(this.clear)}clear(){this.DataRepository.clear(),this.MessageLoader.clear()}checkEnableToCreate(e,t,s){const i=(()=>{if(t.type===Yv.i.MESSAGE){const i=s.topics,n=t.params.global_msg_id,a=t.params.client_msg_id,r=t.params.senderUid;for(let t=0;t<i.length;t++){const s=i[t];if(s.type===Yv.i.MESSAGE){const t=this.MessageLoader.getMessageFromTopic(s);if(null!=t&&null!=n&&t.msgId===n)return s;if(null!=t&&null!=a&&t.cliMsgId===a&&t.fromUid===r&&t.toUid===e)return s}}}return null})();return s.topics.length<Object(Xv.c)()||i?{enable:!0,oldTopic:i}:{enable:!1,oldTopic:null}}clearTopics(e){this.DataRepository.loadPinTopics(e,Yv.e.NONE).then((t=>{this.DataRepository.clearPinTopicsForConversation(e,!0),this.MessageLoader.removeMessages(t.topics),this.notifyChangeEvent(e,[])})).catch()}getRequestID(){return this.requestID.next()}async fetchTopicsForHandleTopLevelErrors(e,t){return await this.DataRepository.loadPinTopics(e,t)}async handleTopLevelErrorInvalidBoardVersion(e,t,s){const{conversationId:i}=t;try{const e=await this.fetchTopicsForHandleTopLevelErrors(i,Yv.e.OUT_OF_DATE);return s?await s():e}catch(n){return Promise.reject(e)}}async handleTopLevelErrorRolledData(e,t){const{conversationId:s}=t;try{const t=await this.fetchTopicsForHandleTopLevelErrors(s,Yv.e.ROLLED_DATA);return this.notifyChangeEvent(t.conversationId,t.topics),Promise.reject({code:Yv.c.TOPIC_NOT_IN_PIN_LIST,message:e.message||"STR_PIN_GENERAL_ERROR"})}catch(i){return Promise.reject(e)}}async handleTopLevelErrorUserBlockFriend(e){return Promise.reject({code:Yv.c.USER_BLOCK_FRIEND,message:e.message||"STR_TOAST_BLOCK"})}async handleTopLevelErrorUserNonFriend(e){return Promise.reject({code:Yv.c.USER_NON_FRIEND,message:e.message||"STR_PIN_NOT_ZALO_FRIEND"})}async handleTopLevelErrors(e,t,s){return e.code===Yv.c.INVALID_BOARD_VERSION?await this.handleTopLevelErrorInvalidBoardVersion(e,t,s):e.code===Yv.c.TOPIC_NOT_IN_PIN_LIST?await this.handleTopLevelErrorRolledData(e,t):e.code===Yv.c.USER_BLOCK_FRIEND?await this.handleTopLevelErrorUserBlockFriend(e):e.code===Yv.c.USER_NON_FRIEND?await this.handleTopLevelErrorUserNonFriend(e):Promise.reject(e)}isValidNetwork(){return fu.b.getStateNetwork()===fu.a.CONNECTED}notifyEvent(e,...t){const s=this.events[e],i=(this.events[e]||[]).length;for(let n=0;n<i;n++)"function"==typeof s[n]&&s[n](...t)}notifyChangeEvent(e,t){this.notifyEvent("onchange",e,t)}notifyExceedEvent(e,t,s){this.notifyEvent("onexceed",e,t,s)}async processCreatePinTopic(e,t,s=2){if(!this.FriendManager.isFriend(e))return Promise.reject({code:Yv.c.USER_NON_FRIEND,message:"STR_PIN_NOT_ZALO_FRIEND"});if(this.FriendManager.isBlocked(e))return Promise.reject({code:Yv.c.USER_BLOCK_FRIEND,message:"STR_TOAST_BLOCK"});try{const s=await this.DataRepository.createPinTopic(e,t,{checkEnableToCreate:this.checkEnableToCreate.bind(this)});return this.MessageLoader.loadMessages(e,s.topics),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(n){try{const i=await this.handleTopLevelErrors(n,{conversationId:e},this.createPinTopic.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(a){if(a.code===Yv.c.PINBOARD_OVER_MAXIMUM){var i;const s=null==a||null===(i=a.data)||void 0===i?void 0:i.cache;this.notifyExceedEvent(e,(null==s?void 0:s.topics)||[],t)}return Promise.reject(a)}}}async processReorderPinTopics(e,t,s=2){try{const s=await this.DataRepository.reorderPinTopics(e,t);return this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const n=await this.handleTopLevelErrors(i,{conversationId:e},this.reorderPinTopics.bind(this,e,t,s-1));return{conversationId:n.conversationId,topics:n.topics}}catch(n){return Promise.reject(n)}}}async processUnpinPinTopics(e,t,s=2){try{const s=await this.DataRepository.unpinTopics(e,t);return this.MessageLoader.removeMessages(t),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const n=await this.handleTopLevelErrors(i,{conversationId:e},this.unpinPinTopics.bind(this,e,t,s-1));return{conversationId:n.conversationId,topics:n.topics}}catch(n){return Promise.reject(n)}}}async retryable(e,t){return null!=e&&e<0?Promise.reject({code:Yv.c.STOP_RETRY_CLIENT,message:"STR_PIN_GENERAL_ERROR"}):await t()}get DataRepository(){return this.dataRepository}get FriendManager(){return ns.default}get Logger(){return this.logger}get MessageLoader(){return this.messageLoader}})||Ib)||Ib)||Ib)||Ib)||Ib);var _b,Cb=s("74m0");Object(i.injectable)()(_b=Object(i.singleton)(Cb.a)(_b=function(e,t){return Object(i.inject)(fb)(e,void 0,0)}(_b=Reflect.metadata("design:type",Function)(_b=Reflect.metadata("design:paramtypes",[Object])(_b=class{constructor(e){this.oneOnOneController=e}addEventListener(e,t){this.OneOnOneController.addEventListener(e,t)}createPinTopic(e,t){return Object(ib.d)(e)?Promise.resolve():this.OneOnOneController.createPinTopic(e,t)}displayOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.displayEntryPointPromotionalTooltip()}getPinTopic(e,t,s){return Object(ib.d)(e)?Promise.resolve():this.OneOnOneController.getPinTopic(e,t,s)}getMessageFromTopic(e,t){if(!Object(ib.d)(e))return this.OneOnOneController.getMessageFromTopic(t)}handleEventControl(e){}handleOneOnOneEventsControl(e){this.OneOnOneController.handleEventControl(e)}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.isDisplayedEntryPointPromotionalTooltip()}isEnablePinTopicOneOnOneFeature(){return Xv.k()}isEnablePinTopicOneOnOneEntryPoint(){return Xv.j()}isMessagePinnable(e,t){return!!this.isMessagePinnableForAllConversations(e)&&(t!==R.CONVERSATION_TYPE.FRIEND||this.OneOnOneController.isMessagePinnable(e))}loadPinTopics(e,t){return Object(ib.d)(e)?Promise.resolve():this.OneOnOneController.loadPinTopics(e,t)}removeEventListener(e,t){this.OneOnOneController.removeEventListener(e,t)}removeEventListeners(e){this.OneOnOneController.removeEventListeners(e)}reorderPinTopics(e,t){return Object(ib.d)(e)?Promise.resolve():this.OneOnOneController.reorderPinTopics(e,t)}unpinPinTopics(e,t){return Object(ib.d)(e)?Promise.resolve():this.OneOnOneController.unpinPinTopics(e,t)}isMessagePinnableForAllConversations(e){return nb(e)}get OneOnOneController(){return this.oneOnOneController}})||_b)||_b)||_b)||_b);var Ob=Object(i.define)("pin-topic-storage"),Eb=Ob;var Mb,Sb=function(){const e={};return{clear:()=>{for(const t in e)delete e[t]},get:t=>e[t],getCache:()=>e,set:(t,s)=>{e[t]=s},has:t=>e.hasOwnProperty(t),remove:t=>{delete e[t]}}};var Tb=Object(i.injectable)()(Mb=function(e,t){return Object(i.inject)(Eb)(e,void 0,0)}(Mb=Reflect.metadata("design:type",Function)(Mb=Reflect.metadata("design:paramtypes",[Object])(Mb=class{constructor(e){this.storage=e,this.clientMsgCache=void 0,this.globalMsgCache=void 0,this.globalMsgCache=Sb(),this.clientMsgCache=Sb()}clear(e){switch(e){case lb.g.GLOBAL:return void this.globalMsgCache.clear();case lb.g.CLIENT:return void this.clientMsgCache.clear();default:return this.globalMsgCache.clear(),void this.clientMsgCache.clear()}}loadMessages(e,t){return new Promise(((s,i)=>{t&&0!==t.length||i("Invalid topics");const n=t.length;for(let a=0;a<n;a++){const s=t[a];if(!s)continue;let n=db(s);if(n&&"0"!==n)this.getMessage(e,lb.g.GLOBAL,n).then().catch((e=>{i(e)}));else{let t=cb(s);if(t){let n=s.params&&s.params.senderUid;this.getMessage(e,lb.g.CLIENT,t,{userId:n}).then().catch((e=>{i(e)}))}}}s()}))}getMessageFromTopic(e){if(e.type!==lb.i.MESSAGE||!e.params)return{};let t=db(e);if(this.globalMsgCache&&this.globalMsgCache.has(t))return this.globalMsgCache.get(t)||{};let s=cb(e);return this.clientMsgCache&&this.clientMsgCache.has(s)&&this.clientMsgCache.get(s)||{}}removeMessages(e){Array.isArray(e)&&e.forEach((e=>{const t=db(e),s=cb(e);this.globalMsgCache.remove(t),this.clientMsgCache.remove(s)}))}getMessage(e,t,s,i={}){return new Promise(((n,a)=>{switch(t){case lb.g.GLOBAL:{let i=this.globalMsgCache.get(s);i?n(i):this.storage.getMessagesByIds(e,[s]).then((e=>{e?(this.setMessage(t,s,e),n(e)):a("Not found")})).catch((e=>{a(e)}));break}case lb.g.CLIENT:{const{userId:r}=i;let o=this.clientMsgCache.get(s);o?n(o):this.storage.getMessageByCliMsgId(e,s,{myUID:ns.default.getUidMe(),userId:r}).then((e=>{e?(this.setMessage(t,s,e),n(e)):a("Not found")})).catch((e=>{a(e)}));break}default:a("Unknown")}}))}setMessage(e,t,s){switch(e){case lb.g.GLOBAL:return void this.globalMsgCache.set(t,s);case lb.g.CLIENT:return void this.clientMsgCache.set(t,s);default:return}}})||Mb)||Mb)||Mb)||Mb;i.ModuleContainer.register(tb,Tb);var wb=function(){const e={},t=t=>e[t]||null;return{clear:()=>{for(const t in e)delete e[t]},get:t,getAll:()=>e,getLastFetch:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastFetch)||0},getLastModified:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastModified)||0},getTopics:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.topics)||[]},getVersion:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.version)||0},has:t=>!!e[t],remove:t=>{delete e[t]},set:(t,s)=>{e[t]=s}}};var Rb=function(e){const t=[];let s=!1;const i=e||(()=>{}),n=()=>t.length,a=e=>{s=e},r=()=>{if(s)return;if(!n())return void i();const e=t.shift();e&&(a(!0),e().then((()=>{a(!1),r()})).catch((()=>{a(!1),r()})))};return{enqueue:e=>{t.push(e),r()},dequeue:r,getLength:n}};var Lb=function(){const e=[];let t;const s=()=>e.length,i=(n,a)=>{if(a&&(t=a),!s())return t&&t(n);const r=e.shift();r&&((e,t)=>{const{callback:s}=e;let n;"function"==typeof s&&(n=s(e.data,t)),i(n)})(r,n)};return{enqueue:t=>{e.push(t)},dequeue:i,getLength:s}},Db=s("u+F0");var Ab=Object(i.define)("pin-topic-request-handler"),Fb=function(e){return e.CONTROL="control",e.CREATE="create",e.FETCH="fetch",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(Fb||{});var jb,Pb=class extends vb{constructor(){super(lb.f.DataRepository,[Fb.CONTROL,Fb.CREATE,Fb.FETCH,Fb.LOAD,Fb.REORDER,Fb.UNPIN])}infoControl(...e){this.logInfo(Fb.CONTROL,...e)}infoCreate(...e){this.logInfo(Fb.CREATE,...e)}infoFetch(...e){this.logInfo(Fb.FETCH,...e)}infoLoad(...e){this.logInfo(Fb.LOAD,...e)}infoReorder(...e){this.logInfo(Fb.REORDER,...e)}infoUnpin(...e){this.logInfo(Fb.UNPIN,...e)}errorControl(...e){this.logError(Fb.CONTROL,...e)}errorCreate(...e){this.logError(Fb.CREATE,...e)}errorFetch(...e){this.logError(Fb.FETCH,...e)}errorLoad(...e){this.logError(Fb.LOAD,...e)}errorReorder(...e){this.logError(Fb.REORDER,...e)}errorUnpin(...e){this.logError(Fb.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Xv.h)()}};var kb=Object(i.injectable)()(jb=function(e,t){return Object(i.inject)(Eb)(e,void 0,0)}(jb=function(e,t){return Object(i.inject)(Ab)(e,void 0,1)}(jb=Reflect.metadata("design:type",Function)(jb=Reflect.metadata("design:paramtypes",[Object,Object])(jb=class{constructor(e,t){this.storage=e,this.fetcher=t,this.cache=void 0,this.eventQueue=void 0,this.logger=void 0,this.pendingWhenLoadQueue=void 0,this.requestID=void 0,this.cache=wb(),this.eventQueue={},this.pendingWhenLoadQueue={},this.logger=new Pb,this.requestID=new xi.a}clear(){this.cache.clear();for(const e in this.pendingWhenLoadQueue)delete this.pendingWhenLoadQueue[e];for(const e in this.eventQueue)delete this.eventQueue[e]}clearPinTopicsForConversation(e,t=!1){this.cache.remove(e),delete this.pendingWhenLoadQueue[e],delete this.eventQueue[e],this.Storage.clearTopics(e,t)}createPinTopic(e,t,s={}){return new Promise(((i,n)=>{const a=this.getRequestID();this.Logger.infoCreate(a,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{checkEnableToCreate:o}=s||{};let l=null;if(o){const{enable:s,oldTopic:i}=o(e,t,r);if(!s)return this.Logger.infoCreate(a,`cId:${e} react limit`),n({code:Db.a.PINBOARD_OVER_MAXIMUM,message:"",data:{cache:r}});i&&(l=i)}const{version:c}=r;this.Logger.infoCreate(a,`cId:${e}`,c),this.Fetcher.createTopic(e,t,c).then((t=>{this.Logger.infoCreate(a,`cId:${e}, create topic success`);let s=t.response.data;s.oldVersion=c,l&&(s.oldTopic={topicId:l.id,topicType:l.type}),s=hb(s),this.enqueueEvent(e,this.addTopic.bind(this,e,s,(e=>i(e))))})).catch((t=>{const s=t.error;s.data=Object(f.a)(Object(f.a)({},null==s?void 0:s.data),{},{cache:r}),this.Logger.errorCreate(a,`cId:${e}, create topic fail`,pb(t,Object(Xv.b)())),n(s)}))}))}))}getEntryPointPromotionalTooltipShowedStatus(){return this.Storage.getEntryPointPromotionalTooltipShowedStatus()}handleReceivingEvent(e,t){return new Promise(((s,i)=>{if(this.Logger.infoControl(`call ${e}`,pb(t,Object(Xv.b)())),e===lb.c.FORCE_SYNC){const{conversationIds:e}=t;if(!Array.isArray(e))return i("Invalid conversationIds for force all");if(0===e.length)this.Storage.setForcedFetchMilestone(Date.now());else for(let t=0;t<e.length;t++){var n;const a=null===(n=e[t])||void 0===n?void 0:n.toString();a&&(this.clearPinTopicsForConversation(a),this.fetchTopics(a).then((e=>{s(e)})).catch(i))}}else{const{conversationId:n}=t;this.loadDataFromCacheOrDB(n).then((n=>{this.processEventControl(e,t,n,s,i)}))}}))}loadPinTopics(e,t){return new Promise(((s,i)=>{e||i({status:lb.h.ERROR,error:{code:Db.a.INVALID_PARAMETERS,message:"ConversationId not valid"}});const n=this.getRequestID();if(this.Logger.infoLoad(n,`call cId:${e}`),t&&t!==lb.d.NONE)return this.Logger.infoLoad(n,`force fetch cId:${e}`,t),this.fetchTopics(e).then((e=>{s(e)}));this.loadDataFromCacheOrDB(e).then((a=>{if(this.Logger.infoLoad(n,`cId:${e}`),t===lb.d.NONE)return s(a);this.doCheckAndFetchData(a).then((e=>{s(e)})).catch(i)}))}))}reorderPinTopics(e,t){return new Promise(((s,i)=>{const n=this.getRequestID();this.Logger.infoReorder(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((a=>{const{version:r}=a,o=ob(t);this.Logger.infoReorder(n,`cId:${e}`,r),this.Fetcher.reorderTopics(e,o,r).then((i=>{this.Logger.infoReorder(n,`cId:${e}, reorder topic success`);let a=i.response.data;a.oldVersion=r,a.topics=t,a=hb(a),this.enqueueEvent(e,this.setTopics.bind(this,e,a,(e=>s(e))))})).catch((t=>{this.Logger.errorReorder(n,`cId:${e}, reorder topic fail`,pb(t,Object(Xv.b)())),i(t.error)}))}))}))}setEntryPointPromotionalTooltipShowedStatus(e){this.Storage.setEntryPointPromotionalTooltipShowedStatus(e)}unpinTopics(e,t){return new Promise(((s,i)=>{const n=this.getRequestID();this.Logger.infoUnpin(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((a=>{const{version:r}=a,o=ob(t);this.Logger.infoUnpin(n,`cId:${e}`,r),this.Fetcher.unpinTopics(e,o,r).then((i=>{this.Logger.infoUnpin(n,`cId:${e} unpin topic success`);let a=i.response.data;a.oldVersion=r,a.topics=t,a=hb(a),this.enqueueEvent(e,this.removeTopics.bind(this,e,a,(e=>s(e))))})).catch((t=>{this.Logger.errorUnpin(n,`cId:${e}, unpin topic fail`,pb(t,Object(Xv.b)())),i(t.error)}))}))}))}setPendingQueue(e,t){t&&!this.pendingWhenLoadQueue[e]?this.pendingWhenLoadQueue[e]=Lb():delete this.pendingWhenLoadQueue[e]}isInPending(e){return!!this.pendingWhenLoadQueue[e]}openPendingQueue(e){this.setPendingQueue(e,!0)}closePendingQueue(e){this.setPendingQueue(e,!1)}enqueuePending(e,t){this.pendingWhenLoadQueue[e]&&this.pendingWhenLoadQueue[e].enqueue(t)}loadTopicsFromDB(e){this.openPendingQueue(e);return new Promise((t=>{const s=this.getRequestID();this.Logger.infoLoad(s,`DB call cId:${e}`),this.Storage.loadTopics(e).then((i=>{const n=this.handleLoadDBFinish(e,i);this.Logger.infoLoad(s,`DB cId:${e} success`),t({status:lb.h.SUCCESS,response:{data:n}})})).catch((i=>{const n=this.handleLoadDBFinish(e,null);this.Logger.errorLoad(s,`DB cId:${e} fail`,pb(null==i?void 0:i.error,Object(Xv.b)())),t({status:lb.h.ERROR,response:{data:n}})}))}))}getRequestID(){return this.requestID.next()}handleLoadDBFinish(e,t){var s;let i;var n;t&&(i={conversationId:(n=t).conversationId,topics:n.topics,version:n.boardVersion,lastFetch:n.lastFetch,lastModified:Date.now()}),t&&(null===(s=i)||void 0===s?void 0:s.conversationId)===e||(i=function(e){return{conversationId:e,topics:[],version:0,lastFetch:0,lastModified:0}}(e));let a=i;if(!rb(a).needFetch&&this.isInPending(e)){const t=e=>{e&&(a=e)};this.pendingWhenLoadQueue[e].dequeue(i,t)}return this.closePendingQueue(e),a}fetchTopics(e,t=0){this.openPendingQueue(e);return new Promise(((s,i)=>{const n=this.getRequestID();this.Logger.infoFetch(n,`call cId:${e}`,t),this.Fetcher.fetchTopics(e,t).then((t=>{this.Logger.infoFetch(n,`cId:${e} success`),this.closePendingQueue(e);const{response:i}=t,a=i.data.topics;for(let e=0;e<a.length;e++)a[e]=gb(a[e]);this.loadExtraDataForTopics(a).then((t=>{const n={conversationId:e,topics:t,version:i.data.version,lastFetch:Date.now(),lastModified:Date.now()};this.setToCache(e,n),this.setTopicsToDB(n),s(n)}))})).catch((t=>{this.Logger.errorFetch(n,`cId:${e} fail`,pb(t,Object(Xv.b)())),this.closePendingQueue(e)}))}))}doCheckAndFetchData(e){return new Promise(((t,s)=>{const i=rb(e);if(this.Logger.infoFetch(`cId:${e.conversationId} needFetch:${i.needFetch} reason:${i.reason}`),!i.needFetch)return t(e);this.fetchTopics(e.conversationId).then((s=>{t(s||e)})).catch(s)}))}getDataInPendingQueueAfterMutation(e,t){if(e.conversationId!==t.conversationId)return t;if(e.oldVersion!=t.version)return t;return{topics:ub(e.type,t.topics,{index:e.index,topics:e.topics}),version:e.version,conversationId:e.conversationId,lastModified:Date.now(),lastFetch:t.lastFetch}}setToCache(e,t){return null==t.lastModified&&(t.lastModified=Date.now()),this.cache.set(e,t),t}addToCache(e,t,s=0){const i=this.getCache(e),{topic:n,version:a}=t;let r=Date.now(),o=[];i?(o=ub(lb.a.ADD,i.topics,{topics:[n],index:s}),r=i.lastFetch):o.push(n),t.lastFetch&&(r=t.lastFetch);const l={conversationId:e,topics:o,version:a,lastModified:Date.now(),lastFetch:r};return this.setToCache(e,l)}removeInCache(e,t,s=0){if(!this.cache.has(e))return null;const i=this.getCache(e),{topics:n}=i;if(t.topic)for(let r=0;r<n.length;r++){const e=n[r];if(e.id===t.topic.id&&e.type===t.topic.type){n.splice(r,1);break}}else n.splice(s,1);const a={conversationId:e,topics:n,version:t.version,lastModified:Date.now(),lastFetch:i.lastFetch};return this.setToCache(e,a)}enqueueEvent(e,t){if(!this.eventQueue[e]){const t=()=>{delete this.eventQueue[e]};this.eventQueue[e]=Rb(t)}this.eventQueue[e].enqueue(t)}addTopic(e,t,s){return new Promise(((i,n)=>{if(this.isInPending(e)){const s={data:{type:lb.a.ADD,conversationId:e,oldTopic:t.oldTopic,topics:[t.topic],version:t.version,oldVersion:t.oldVersion,index:t.index},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const a=n=>{const{oldVersion:a,version:r}=t,o=ab(a,r,n.version);if(this.Logger.infoCreate(`add call cId:${e} actCode:${o}`,a,r,n.version),1===o){const{oldTopic:n,index:a,topic:o}=t;n&&n.topicId&&this.removeInCache(e,{topic:{id:n.topicId,type:n.topicType},version:r}),gb(o),this.loadExtraDataForTopics([o]).then((n=>{const r={topic:n[0],version:t.version},o=this.addToCache(e,r,a);this.setTopicsToDB(o),i(),s&&s(this.getCache(e))})).catch((()=>{i()}))}else 0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{a(e)}))}))}removeTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:lb.a.REMOVE,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const n=n=>{const{oldVersion:a,version:r}=t,o=ab(a,r,n.version);if(this.Logger.infoUnpin(`remove call cId:${e} actCode:${o}`,a,r,n.version),1===o){const{topics:a}=t;let o=n;for(let t=0;t<a.length;t++)o=this.removeInCache(e,{topic:a[t],version:r});return this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}setTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:lb.a.REORDER,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const n=n=>{const{oldVersion:a,version:r}=t,o=ab(a,r,n.version);if(this.Logger.infoReorder(`set call cId:${e} actCode:${o}`,a,r,n.version),1===o){const a=n.topics,r=[];for(let e=0;e<t.topics.length;e++){const s=t.topics[e],i=a.find((e=>e.id===s.id&&e.type===s.type));i&&r.push(i)}const o={conversationId:e,topics:r,version:t.version,lastModified:Date.now(),lastFetch:(null==n?void 0:n.lastFetch)||0};return this.setToCache(e,o),this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}loadDataFromCacheOrDB(e){return new Promise((t=>{const s=this.getCache(e);s?t(s):this.loadTopicsFromDB(e).then((s=>{const i=s.response.data;this.setToCache(e,i),t(i)}))}))}setTopicsToDB(e){return new Promise(((t,s)=>{const i={conversationId:e.conversationId,boardVersion:e.version,topics:e.topics,lastFetch:e.lastFetch};this.Storage.setTopics(i).then(t).catch(s)}))}processEventControl(e,t,s,i,n){const{conversationId:a}=t;let r={oldVersion:t.oldVersion,version:t.version};const o=hb(t);switch(e){case lb.c.CREATE:r=Object(f.a)(Object(f.a)({},r),{},{oldTopic:o.oldTopic,topic:o.topic,index:0}),this.enqueueEvent(a,this.addTopic.bind(this,a,r,(e=>i(e))));break;case lb.c.UNPIN:{const e=o.topic,t=[];e&&null!=e.topicId&&null!=e.topicType&&t.push({id:e.topicId,type:e.topicType}),r=Object(f.a)(Object(f.a)({},r),{},{topics:t}),this.enqueueEvent(a,this.removeTopics.bind(this,a,r,(e=>i(e))));break}case lb.c.REORDER:{var l;const e=[],t=(null===(l=o.topics)||void 0===l?void 0:l.length)||0;for(let i=0;i<t;i++){var c;const t=null===(c=o.topics)||void 0===c?void 0:c[i];if(t&&null!=t.topicId&&null!=t.topicType){const i=s.topics.find((e=>e.id===t.topicId&&e.type===t.topicType));i&&e.push(i)}}r=Object(f.a)(Object(f.a)({},r),{},{topics:e}),this.enqueueEvent(a,this.setTopics.bind(this,a,r,(e=>i(e))));break}}}loadStickerThumb(e){const t=e=>`${e.id}_${e.type}`;return new Promise((s=>{const i={};for(let o=0;o<e.length;o++){var n,a;const s=e[o];if((null===(n=s.params)||void 0===n?void 0:n.msg_type)===R.MSG_STICKER||(null===(a=s.params)||void 0===a?void 0:a.msg_type)===R.CLI_MSG_TYPE_STICKER){var r;const e=null===(r=s.params)||void 0===r?void 0:r.extra;e&&null!=e.catId&&null!=e.id&&(i[t(s)]=this.StickerManager.getStickerIfNotExist(e.catId,e.id))}}Object.keys(i).length>0?mb(i).then((i=>{for(let s=0;s<e.length;s++){const n=e[s],a=i[t(n)];a&&a.id===parseInt(n.params.extra.id)&&a.cateId===parseInt(n.params.extra.catId)&&(n.params.thumb=a.stickerUrl||"",e[s]=n)}s(e)})):s(e)}))}loadExtraDataForTopics(e){return new Promise((t=>{this.loadStickerThumb(e).then((e=>{t(e)}))}))}getCache(e){return this.cache.get(e)}get Fetcher(){return this.fetcher}get Logger(){return this.logger}get StickerManager(){return go.g}get Storage(){return this.storage}})||jb)||jb)||jb)||jb)||jb;i.ModuleContainer.register(eb,kb);var Nb=class{createOneOnOneTopic(e="",t,s=0,i="vi"){let n={conversationId:e,topic:t,version:s,lang:i};ho.default.logCoreInfo("[PinTopic] - createOneOnOneTopic params: ",n);const a=di.b.getFriendBoardDomain()+"/api/friendboard/create?"+this.getCommonParams()+"&params="+this.getEncodedParams(n);return this.getRequest(a,null,12067)}getListOneOnOnePinTopics(e="",t=0){let s={conversationId:e,version:t};ho.default.logCoreInfo("[PinTopic] - getListOneOnOnePinTopics params: ",s);const i=di.b.getFriendBoardDomain()+"/api/friendboard/list?"+pu.default._getCommonParams()+"&params="+this.getEncodedParams(s);return this.getRequest(i,null,12065)}reorderOneOnOnePinTopics(e="",t,s=0,i="vi"){let n={conversationId:e,topics:t,version:s,lang:i};ho.default.logCoreInfo("[PinTopic] - reorderOneOnOnePinTopics params: ",n);const a=di.b.getFriendBoardDomain()+"/api/friendboard/reorder?"+this.getCommonParams()+"&params="+this.getEncodedParams(n);return this.getRequest(a,null,12068)}unpinOneOnOneTopics(e="",t,s=0,i="vi"){let n={conversationId:e,topics:t,version:s,lang:i};ho.default.logCoreInfo("[PinTopic] - unpinOneOnOneTopics params: ",n);const a=di.b.getFriendBoardDomain()+"/api/friendboard/multi_unpin?"+this.getCommonParams()+"&params="+this.getEncodedParams(n);return this.getRequest(a,null,12069)}getCommonParams(){return pu.default._getCommonParams()}getEncodedParams(e){return pu.default.getEncodedParams(e)}getRequest(e,t,s,i,n,a,r,o,l){return pu.default._get(e,t,s,i,n,a,r,o,l)}};var Ub=function(){let e;function t(){return e||(e=new Nb),e}const s=e=>new Promise(((t,s)=>{e.then(gu.a).then(t).catch(s)}));return{createOneOnOneTopic:(e,i,n=0)=>{const a=Object(f.a)({},i),{params:r}=a;r&&r.extra&&r.extra.constructor===Object&&(r.extra=JSON.stringify(r.extra)),r&&(a.params=JSON.stringify(r)),null==a.src&&(a.src=-1),null==a.pinAct&&(a.pinAct=1);const o=os.a.getCurrentLanguageName();return s(t().createOneOnOneTopic(e,a,n,o))},getListOneOnOnePinTopics:(e,i=0)=>s(t().getListOneOnOnePinTopics(e,i)),reorderOneOnOnePinTopics:(e,i,n=0)=>{const a=os.a.getCurrentLanguageName();return s(t().reorderOneOnOnePinTopics(e,i,n,a))},unpinOneOnOneTopics:(e,i,n=0)=>{const a=os.a.getCurrentLanguageName();return s(t().unpinOneOnOneTopics(e,i,n,a))}}},Bb=function(e){return e.CREATE="create",e.FETCH="fetch",e.REORDER="reorder",e.UNPIN="unpin",e}(Bb||{});var xb=class extends vb{constructor(){super(lb.f.Network,[Bb.CREATE,Bb.FETCH,Bb.REORDER,Bb.UNPIN])}infoCreate(...e){this.logInfo(Bb.CREATE,...e)}infoFetch(...e){this.logInfo(Bb.FETCH,...e)}infoReorder(...e){this.logInfo(Bb.REORDER,...e)}infoUnpin(...e){this.logInfo(Bb.UNPIN,...e)}errorCreate(...e){this.logError(Bb.CREATE,...e)}errorFetch(...e){this.logError(Bb.FETCH,...e)}errorReorder(...e){this.logError(Bb.REORDER,...e)}errorUnpin(...e){this.logError(Bb.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Xv.i)()}};var Gb,zb=class{constructor(){this.apiClient=void 0,this.logger=void 0,this.requestID=void 0,this.apiClient=Ub(),this.logger=new xb,this.requestID=new xi.a}async fetchTopics(e,t=0){const s=this.getRequestId();this.Logger.infoFetch(s,`call cId:${e}`,t);try{const i=await this.apiClient.getListOneOnOnePinTopics(e,t);return this.Logger.infoFetch(s,`cId:${e} success`,i.version),{status:lb.h.SUCCESS,response:{data:{topics:i.data,version:i.version}}}}catch(i){return this.Logger.errorFetch(s,`cId:${e} fail`,pb(i,Object(Xv.d)())),Promise.reject({status:lb.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async createTopic(e,t,s=0){const i=this.getRequestId();this.Logger.infoCreate(i,`call cId:${e}`,s);try{const n=await this.apiClient.createOneOnOneTopic(e,t,s);return this.Logger.infoCreate(i,`cId:${e} success`,n.version),{status:lb.h.SUCCESS,response:{data:{topic:n.data,version:n.version}}}}catch(n){return this.Logger.errorCreate(i,`cId:${e} fail`,pb(n,Object(Xv.d)())),Promise.reject({status:lb.h.ERROR,error:{code:n.code||n.error_code,message:n.error_message}})}}async unpinTopics(e,t,s=0){const i=this.getRequestId();this.Logger.infoUnpin(i,`call cId:${e}`,s);try{const n=await this.apiClient.unpinOneOnOneTopics(e,t,s);return this.Logger.infoUnpin(i,`cId:${e} success`,n.version),{status:lb.h.SUCCESS,response:{data:n}}}catch(n){return this.Logger.errorUnpin(i,`cId:${e} fail`,pb(n,Object(Xv.d)())),Promise.reject({status:lb.h.ERROR,error:{code:n.code||n.error_code,message:n.error_message}})}}async reorderTopics(e,t,s=0){const i=this.getRequestId();this.Logger.infoReorder(i,`call cId:${e}`,s);try{const n=await this.apiClient.reorderOneOnOnePinTopics(e,t,s);return this.Logger.infoReorder(i,`cId:${e} success`,n.version),{status:lb.h.SUCCESS,response:{data:n}}}catch(n){return this.Logger.errorUnpin(i,`cId:${e} fail`,pb(n,Object(Xv.d)())),Promise.reject({status:lb.h.ERROR,error:{code:n.code||n.error_code,message:n.error_message}})}}getRequestId(){return this.requestID.next()}get Logger(){return this.logger}};i.ModuleContainer.register(Ab,zb);var Vb=Object(i.singleton)(Ob)(Gb=class{constructor(){this._storage=void 0}async clearTopics(e,t=!1){try{let s;if(t)s=this.storage.removeConversationTopics(e);else{const t={conversationId:e,topics:[]},i=["topics"];s=this.storage.updateGroupTopic(t,i)}return await s,e}catch(s){return Promise.reject(s)}}async loadTopics(e){try{return(await this.loadTopicsFromDB(e)).response.data}catch(t){return Promise.reject(t)}}async setTopics(e){try{return await this.setTopicsToDB(e)}catch(t){return Promise.reject(t)}}getEntryPointPromotionalTooltipShowedStatus(){const e=E.default.getInstance().getItemForCurrentUser(lb.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED);if(null===e)return null;try{return JSON.parse(e)}catch(t){return!1}}async getMessagesByIds(e,t){try{const s=await this.storage.getMessagesByIds(e,t);let i;t&&t.length>0&&(i=t[0]);let n=null;return i&&(n=s[i]),n||Promise.reject("Not found")}catch(s){return Promise.reject(s)}}async getMessageByCliMsgId(e,t,s={}){try{const{myUID:i,userId:n}=s;if(n){let s=n;i==n&&(s="0");const a=await this.storage.getMessageByCliMsgIdOwnerId(e,t,s);return a||Promise.reject("Not found")}const a=await this.storage.getMessageByCliMsgId(t,e);if(!a||!a.length)return Promise.reject("Not found");a.length;const r=a&&a[0];return r||Promise.reject("Not found")}catch(i){return Promise.reject(i)}}setEntryPointPromotionalTooltipShowedStatus(e){E.default.getInstance().setItemForCurrentUser(lb.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED,JSON.stringify(e))}setForcedFetchMilestone(e){E.default.getInstance().setItemForCurrentUser(lb.e.FORCE_FETCH_MILESTONE,e.toString())}async loadTopicsFromDB(e){try{const t=await this.storage.getGroupTopic(e);return{status:lb.h.SUCCESS,response:{data:t}}}catch(t){return Promise.reject({status:lb.h.ERROR,error:{code:null==t?void 0:t.code,message:(null==t?void 0:t.message)||(null==t?void 0:t.error_message),data:t}})}}async setTopicsToDB(e){return await this.storage.setGroupTopic(e)}get storage(){return this._storage||(this._storage=s("XS0u").default),this._storage}})||Gb;i.ModuleContainer.register(Eb,Vb);var Hb=s("RF0b"),Wb=s("z7jJ"),$b=s("3ZsK"),Kb=s("k5QF"),qb=s("oEIH");function Qb(e,t,s,i=Go.c){let n;switch(t){case"error":n=Ri.TOAST_TYPE.ERROR;break;case"info":default:n=Ri.TOAST_TYPE.INFO;break;case"success":n=Ri.TOAST_TYPE.SUCCESS;break;case"warning":n=Ri.TOAST_TYPE.WARNING}Ri.ZToastManagerHolder.getZToastManagerByWindowId(i).show({duration:s,noBackground:!0,textKey:e,type:n})}var Zb={error:function(e,t,s){Qb(e,"error",null!=s?s:3e3,t)},info:function(e,t,s){Qb(e,"info",null!=s?s:3e3,t)},success:function(e,t,s){Qb(e,"success",null!=s?s:3e3,t)},warning:function(e,t,s){Qb(e,"warning",null!=s?s:3e3,t)}},Jb=s("AyM1"),Yb=s("3Ewa");var Xb,eI=class{constructor(e,t){this.conversationId=e,this.windowId=t,this.dispatch=null,this.events={},this.topics=[],this.toDispatch=e=>{"function"==typeof this.dispatch&&this.dispatch(Object(f.a)({windowId:this.windowID},e))}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}cancelLimitationModal(e){Object(ib.d)(this.conversationID)||(e===Yv.f.CONFIRM?qb.a.logAction(qb.a.OneOnOne.LimitationModal.CLOSE_MODAL):e===Yv.f.MULTI_UNPIN&&qb.a.logAction(qb.a.OneOnOne.LimitationMultipleUnpinModal.CLOSE_MODAL))}cancelUnpinModal(){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLOSE_UNPIN_MODAL)}cleanUp(){this.events={},this.setDispatch(null)}clickCancelOnLimitationModal(e){Object(ib.d)(this.conversationID)||(e===Yv.f.CONFIRM?qb.a.logAction(qb.a.OneOnOne.LimitationModal.CLICK_CANCEL):e===Yv.f.MULTI_UNPIN&&qb.a.logAction(qb.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_CANCEL))}clickCancelUnpinTopic(){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLICK_NOT_UNPIN_FROM_MODAL)}clickConfirmOnLimitationModal(e,t,s){if(Object(ib.d)(this.conversationID)||(s===Yv.f.CONFIRM?qb.a.logAction(qb.a.OneOnOne.LimitationModal.CLICK_CONFIRM):s===Yv.f.MULTI_UNPIN&&qb.a.logAction(qb.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_CONFIRM)),Array.isArray(e)&&e.length>0)this.unpinTopics(e).then((()=>{if(Array.isArray(t)&&t.length>0){const e=t[0];this.createPinTopic(e).then((()=>{this.getMessageFromTopic(this.getConversationID(),e).then((e=>{if(e){const t=Object(sb.a)(e,Yv.b.UNPIN_MODAL);qb.a.locActionDetails(t)}}))}))}}));else if(Array.isArray(t)&&t.length>0){const e=t[0];this.createPinTopic(e).then((()=>{this.getMessageFromTopic(this.getConversationID(),e).then((e=>{if(e){const t=Object(sb.a)(e,Yv.b.UNPIN_MODAL);qb.a.locActionDetails(t)}}))}))}}clickConfirmUnpinTopic(e){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLICK_UNPIN_FROM_MODAL),this.unpinTopic(e)}clickCopyTopic(e){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLICK_COPY),this.copyTopic(e)}clickTopic(e){switch(Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.LEFT_CLICK),e.type){case R.TEXT_TOPIC:case R.LINK_TOPIC:break;case R.MSG_TOPIC:this.jumpToMessage(this.conversationID,e,this.toDispatch);case R.POLL_TOPIC:case R.REMINDER_TOPIC:}}clickRaiseTopic(e){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLICK_PUSH_TO_TOP),this.raiseTopic(e)}clickShowMoreIcon(){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLICK_THREE_DOT)}clickSwitchToMultipleUnpinTopicsMode(){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.LimitationModal.CLICK_CHANGE_OPTION)}clickTopicToSelectForUnpin(e){Object(ib.d)(this.conversationID)||e&&qb.a.logAction(qb.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_TOPIC_TO_SELECT_FOR_UNPIN)}clickUnpinTopic(e){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.CLICK_UNPIN),this.showUnpinTopicModal(e)}collapseBoard(e){const t=Object(ib.d)(this.conversationID);switch(e){case Yv.a.BUTTON_CLICKED:t||qb.a.logAction(qb.a.OneOnOne.Board.COLLAPSE_BY_CLICK_BUTTON);break;case Yv.a.BY_ESC:t||qb.a.logAction(qb.a.OneOnOne.Board.COLLAPSE_BY_ESC);break;case Yv.a.OUTSIDE_CLICKED:t||qb.a.logAction(qb.a.OneOnOne.Board.COLLAPSE_BY_CLICK_OUTSIDE)}}copyTopic(e){if(!e)return;let t="";const s=e.params;switch(e.type){case R.MSG_TOPIC:s&&(t=s.title);break;case R.LINK_TOPIC:case R.TEXT_TOPIC:s&&(s.linkCaption?t=s.linkCaption:s.title&&(t=s.title))}t.length>0?ho.default.copyTextToClipboard(t):Zb.error(os.a.str("STR_ERROR_UNKNOWN"),this.windowId)}createPinTopic(e){return Yv.j.GetManager().createPinTopic(this.conversationId,e).catch((e=>{if(e.code===Yv.c.FULL_THREAD_PIN_TOPIC&&!e.message){const t=ns.default.getDName(this.conversationID);if(t)return rs.default.createError(os.a.trans("STR_PIN_FRIEND_REACH_PIN_LIMIT",[t]),5e3),Promise.reject(e)}return e.message&&Zb.error(os.a.str(e.message),this.windowId),Promise.reject(e)}))}createPinTopicFromMessage(e,t=Yv.b.UNKNOWN){var s;let n=null===(s=mi.default.settings.group.topic_colors)||void 0===s?void 0:s[0],a=R.MSG_TOPIC;const r=Object(f.a)({},e);let o=r.fromUid;if(!o||"0"===o){const e=i.ModuleContainer.resolve(Je.a);var l;if(e)o=null===(l=e.getSession())||void 0===l?void 0:l.userId}const c=ho.default.getUnicodeCorrMSGType(r);let d={client_msg_id:r.cliMsgId,global_msg_id:r.msgId,senderUid:o,senderName:r.dName||""};switch(r.msgType){case R.MSG_CONTACT:switch(r.message.action){case"recommened.link":case"recommened.user":case"recommened.stickerset":case"recommened.vip":if(d.href=r.message.href,d.thumb=r.message.thumb,d.title=r.message.title,d.linkCaption=r.message.title,"recommened.link"===r.message.action&&r.message.params){let e=JSON.parse(r.message.params);!d.title&&e&&e.mediaTitle&&(d.title=e.mediaTitle),d.redirect_url=e.redirect_url?e.redirect_url:"",d.streamUrl=e.streamUrl?e.streamUrl:"",d.artist=e.artist?e.artist:"",d.stream_icon=e.stream_icon?e.stream_icon:"",d.type=e.type?e.type:""}}d.extra={action:r.message.action},"recommened.user"===r.message.action?d.extra.dpn=d.title:"recommened.link"===r.message.action&&r.message.params&&(d.extra.params=r.message.params),d.msg_type=R.CLI_MSG_TYPE_CONTACT;break;case R.MSG_TEXT:"string"==typeof r.message?d.title=r.message:r.message&&r.message.title&&(d.title=r.message.title),d.msg_type=R.CLI_MSG_TYPE_TEXT;break;case R.MSG_DOODLE:d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.title=r.message.title,d.msg_type=R.CLI_MSG_TYPE_DOODLE;break;case R.MSG_PHOTO:{let e=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl;const t=Object(Jm.d)(e),s=Object(Jm.g)(e);if(s&&(t||Am.a.jxl.enable_pin_jxl?e=Object(Jm.j)(e):(e=Object(Jm.n)(e),d.convertible="jxl")),d.thumb=e,d.title=r.message.title,d.msg_type=R.CLI_MSG_TYPE_PHOTO,r.properties&&r.properties.type===R.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER){const e={msgBubbleLayoutType:R.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,pStickerType:0},i=r.message.params;if(i){let n=null;if("string"==typeof i)try{n=JSON.parse(i)}catch(m){ho.default.logCoreError("Try to parse params has failed",m)}else i.webp&&(n=i);var u,h;if(n)s&&(t||Am.a.jxl.enable_pin_jxl?n=Object(Jm.k)(n):(n=Object(Jm.l)(n),d.convertible="jxl")),e.webpUrl=(null===(u=n.webp)||void 0===u?void 0:u.url)||"",e.subType=1,e.pStickerType=null!==(h=n.pStickerType)&&void 0!==h?h:0}d.extra=e}break}case R.MSG_FILE:d.title=r.message.title,d.extra=r.message.params,d.msg_type=R.CLI_MSG_TYPE_FILE;break;case R.MSG_GIF:d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.msg_type=R.CLI_MSG_TYPE_GIF;break;case R.MSG_STICKER:d.extra=r.message,d.msg_type=R.CLI_MSG_TYPE_STICKER;break;case R.MSG_VOICE:d.msg_type=R.CLI_MSG_TYPE_VOICE;break;case R.MSG_LOCATION:d.msg_type=R.CLI_MSG_TYPE_LOCATION,d.title=r.message.desc;break;case R.MSG_VIDEO:d.msg_type=R.CLI_MSG_TYPE_VIDEO,d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.title=r.message.title;break;case R.MSG_UNDO:return void rs.default.createWarning(os.a.str("STR_TOAST_UNDO_MESSAGE"));case R.MSG_POLL:{let e=null;if(e){let t=e.pollData;t&&(d.title=t.question)}a=R.POLL_TOPIC;break}case R.MSG_ZINSTANT_OLD:case R.MSG_ZINSTANT:{const e=Jb.default.getZInstantData(r);d.msg_type=R.MSG_ZINSTANT,e&&e.customMsg&&(d.extra=Object(f.a)({},e.customMsg));break}default:d.msg_type=r.msgType}const g={color:n,duration:-1,emoji:c,params:d,repeat:0,startTime:-1,type:a};this.createPinTopic(g).then((()=>{const s=Object(sb.a)(e,t);qb.a.locActionDetails(s)}))}editTopic(e,t){}expandBoard(){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Board.EXPAND_BOARD),this.fetchTopics()}fetchTopics(e){let t=e;null==t&&(t=this.conversationID),Yv.j.GetManager().loadPinTopics(t,!0).then((e=>{this.onUpdateTopics(t,e.topics)}))}getConversationID(){return this.conversationID}getTopics(){return this.topics}openBoard(e){}openPinLimitModal(e,t){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.LimitationModal.DISPLAY_MODAL),ss.ModalManagerV2.openModal({windowId:this.windowID,name:R.ModalIdentitiesDefine.PIN_LIMIT_MODAL,params:{conversationID:this.conversationID,limitNumber:3,currentTopics:e,pinTopic:t}})}raiseTopic(e){let t=this.topics.slice();const s=t.findIndex((t=>t.id===e.id&&t.type===e.type));s>-1&&(t.splice(s,1),t.unshift(e),Yv.j.GetManager().reorderPinTopics(this.conversationID,t).catch((e=>{e.message&&Zb.error(os.a.str(e.message),this.windowId)})))}removeEventListener(e,t){const s=this.events[e];if(!s)return;const i=(s||[]).length;for(let n=0;n<i;n++)if(s[n]===t){s.splice(n,1);break}0===s.length&&delete this.events[e]}rightClick(){Object(ib.d)(this.conversationID)||qb.a.logAction(qb.a.OneOnOne.Content.RIGHT_CLICK)}setDispatch(e){this.dispatch=e}showContextMenu(){}showUnpinTopicModal(e){ss.ModalManagerV2.openModal({windowId:this.windowID,name:R.ModalIdentitiesDefine.UNPIN_MODAL,params:{conversationID:this.conversationID,unpinTopic:e}})}unpinTopic(e){return this.unpinTopics([e])}unpinTopics(e){return Yv.j.GetManager().unpinPinTopics(this.conversationID,e).catch((e=>(e.message&&Zb.error(os.a.str(e.message),this.windowId),Promise.reject(e))))}updateConversation(e){this.conversationID!==e&&Yv.j.GetManager().loadPinTopics(e).then((t=>{this.onUpdateTopics(e,t.topics)}))}updateTopics(e){this.onUpdateTopics(this.conversationID,e)}async getMessageFromTopic(e,t){var s;const i=t.params.global_msg_id,n=t.params.client_msg_id,a=t.params.senderUid;return null===(s=Ld.b.messageCache)||void 0===s?void 0:s.getMessageAsync(i,e,n,a)}jumpToMessage(e,t,s){let n,a="0",r="0";t.params.global_msg_id&&(a=t.params.global_msg_id),t.params.client_msg_id&&(r=t.params.client_msg_id),null!=t.params.senderUid&&(n=t.params.senderUid),"0"===a&&(a=0);try{const e=Yb.a.Tracking.getInstance();e.reset().getBuilder().setEntryPoint(Yb.a.EntryPoint.PINNED_MESSAGE),e.track(a)}catch(o){}fl.default.jumpToMessage({msgId:a,cliMsgId:r,fromUid:n},e,s).catch((()=>{if(t&&t.params){var s;const n={allowDelete:!1,allowEdit:!1,allowPin:!1},a=null===(s=i.ModuleContainer.resolve(Kb.a))||void 0===s?void 0:s.getWindowIdFromConvId(e);if(!a)return;ss.ModalManagerV2.openModal({windowId:a,name:R.ModalIdentitiesDefine.VIEW_NOTICE,params:{viewNoticeMsgAction:R.VIEW_NOTICE_MSG_ACTION.PIN_MSG,payload:t.params,setting:n}})}else Zb.success(os.a.str("STR_MESSAGE_NOT_FOUND"),this.windowId);Object($b.e)($b.a.JT_PIN_MSG_NOT_AT_LOCAL)}))}notifyEvent(e,...t){const s=this.events[e],i=(this.events[e]||[]).length;for(let n=0;n<i;n++)"function"==typeof s[n]&&s[n](...t)}onUpdateTopics(e,t){this.conversationID===e&&(this.setTopics(t),this.notifyEvent("onchange",t))}setTopics(e){this.topics=e}get conversationID(){return this.conversationId}get windowID(){return this.windowId}},tI=s("JOr/");Object(i.singleton)(tI.a)(Xb=Uc()(Xb=Nc()(Xb=Reflect.metadata("design:type",Function)(Xb=Reflect.metadata("design:paramtypes",[])(Xb=class{constructor(){this._activeConversationInfoList=void 0,this._controllersMap=new Map,this.isDisplayedOneOnOneEPPromotionalTooltip=void 0,this.isRegisteredEvents=!1,this.modalControllers={},this._activeConversationInfoList=i.ModuleContainer.resolve(Qv),this.onChangeData=this.onChangeData.bind(this),this.onExceed=this.onExceed.bind(this)}activateConversation(e,t){const s=this.getToken(e,t);if(!this.isActivatedController(s)){const i=new eI(e,t);this.registerController(s,i),this._activeConversationInfoList.activateConversation(e,t)}}deactivateConversation(e,t){const s=this.getToken(e,t);if(this.isActivatedController(s)){const i=this.controllersMap.get(s);i&&i.cleanUp(),this.unregisterController(s),this._activeConversationInfoList.deactivateConversation(e,t)}}displayOneOnOneEntryPointPromotionalTooltip(){this.isDisplayedOneOnOneEPPromotionalTooltip||(this.isDisplayedOneOnOneEPPromotionalTooltip=!0,Yv.j.GetManager().displayOneOnOneEntryPointPromotionalTooltip())}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return void 0!==this.isDisplayedOneOnOneEPPromotionalTooltip?this.isDisplayedOneOnOneEPPromotionalTooltip:this.isDisplayedOneOnOneEPPromotionalTooltip=Yv.j.GetManager().isDisplayedOneOnOneEntryPointPromotionalTooltip()}loadAndRegisterToDisplayBanner(e){Yv.j.GetManager().loadPinTopics(e).then((t=>{t&&t.conversationId===e&&t.topics&&t.topics.length>0&&this.onChangeData(e,t.topics)})).catch((()=>{}))}onConversationDidClose(e){this.deactivateConversation(e.conversationID,e.windowID)}onConversationWillOpen(e){this.activateConversation(e.conversationID,e.windowID)}getController(e,t){const s=this.getToken(e,t);return this.controllersMap.get(s)}registerController(e,t){this.registerEventListeners(),this.controllersMap.set(e,t)}unregisterController(e){this.controllersMap.delete(e),this.unregisterEventListeners()}getModalController(e){return this.modalControllers[e]}registerModalController(e,t){this.modalControllers[e]=t}unregisterModalController(e){delete this.modalControllers[e]}registerEventListeners(){this.isRegisteredEvents||(this.isRegisteredEvents=!0,Yv.j.GetManager().addEventListener("onchange",this.onChangeData),Yv.j.GetManager().addEventListener("onexceed",this.onExceed))}unregisterEventListeners(){this.isRegisteredEvents&&0===this.controllersMap.size&&(this.isRegisteredEvents=!1,Yv.j.GetManager().removeEventListener("onchange",this.onChangeData),Yv.j.GetManager().removeEventListener("onexceed",this.onExceed))}getActiveControllers(){return Array.from(this.controllersMap.values())}getToken(e,t){return t+"_"+e}isActivatedController(e){return this.controllersMap.has(e)}onChangeData(e,t){var s;const i=this.getActiveControllers();i.length>0&&i.forEach((s=>{s&&s.getConversationID()===e&&s.updateTopics(t.slice())}));const n=null===(s=this.activeConversationInfoList.getActiveConversationInfo(e))||void 0===s?void 0:s.windowIds;Array.isArray(n)&&n.forEach((s=>{this.isActivatedController(this.getToken(e,s))&&(t&&t.length>0?this.requestShowBanner(e,s):this.requestHideBanner(e,s))}))}onExceed(e,t,s){const i=this.getActiveControllers();i.length>0&&i.forEach((i=>{i&&i.getConversationID()===e&&i.openPinLimitModal(t.slice(),Object(f.a)({},s))}))}requestShowBanner(e,t){if(!this.isActivatedController(this.getToken(e,t)))return;this.ChatBoxBannerModule.ChatBoxBannerManager().isBannerDisplaying(Hb.a.PIN_TOPIC_BANNER,e)||this.ChatBoxBannerModule.ChatBoxBannerManager().requestShowBanner(Hb.a.PIN_TOPIC_BANNER,{convId:e})}requestHideBanner(e,t){if(!this.isActivatedController(this.getToken(e,t)))return;this.ChatBoxBannerModule.ChatBoxBannerManager().isBannerDisplaying(Hb.a.PIN_TOPIC_BANNER,e)&&this.ChatBoxBannerModule.ChatBoxBannerManager().requestHideBanner(Hb.a.PIN_TOPIC_BANNER,{convId:e})}get activeConversationInfoList(){return this._activeConversationInfoList}get controllersMap(){return this._controllersMap}get ChatBoxBannerModule(){return{ChatBoxBannerManager:()=>i.ModuleContainer.resolve(Wb.a)}}})||Xb)||Xb)||Xb)||Xb);var sI=s("t5n0"),iI=s("aQZC");var nI,aI=new class{constructor(){this.focusManager=void 0,this.focusStatus=void 0,this.focusService=void 0}get FSV(){return this.focusService||(this.focusService=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.appStatus,[Ve.ZLoggerNametags.focusDetectorManager])),this.focusService}get FM(){return this.focusManager||(this.focusManager=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.appStatus,[Ve.ZLoggerNametags.focusDetectorManager])),this.focusManager}get FSTT(){return this.focusStatus||(this.focusStatus=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.appStatus,[Ve.ZLoggerNametags.focusStatus])),this.focusStatus}};let rI=Object(i.injectable)()(nI=Object(Je.e)()(nI=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(nI=Reflect.metadata("design:type",Function)(nI=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(nI=class extends Fe.b{constructor(e){super(),this.config=e,this.detectors=void 0,this.lostFocusHandler=void 0,this.reFocusHandler=void 0,this.lastFirer=void 0,this.enableLog=void 0,this.listenDetector=(e,t)=>{t&&(this.detectors.set(e,t),this.lostFocusHandler.set(e,(()=>{this.onLostFocus(e)})),this.reFocusHandler.set(e,(()=>{this.onRefocus(e)})),t.idle(this.lostFocusHandler.get(e)),t.wakeup(this.reFocusHandler.get(e)))},this.disposeDetector=e=>{const t=this.detectors.get(e);this.enableLog&&aI.FM.zsymb(0,"VzrU6q","disposeDetector",e,!!t),t&&(t.removeIdle(this.lostFocusHandler.get(e)),t.removeWakeup(this.reFocusHandler.get(e)),t.ifvisible=null,t._window=null,t.removeAllIpc(),this.lostFocusHandler.delete(e),this.reFocusHandler.delete(e),this.detectors.delete(e))},this.onLostFocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&aI.FM.zsymb(0,"n0WY6W","onlostFocus",e);let t=!0,s=Number.MAX_SAFE_INTEGER,i="unknown";this.detectors.forEach((e=>{if(e.isActive())t=!1;else{const t=e.getIdleInfo();t.idleFor<s&&(s=t.idleFor,i=t.idleByTimeout?"no-action-timeout":"unknown")}})),t&&this.dispatchEvent(new sI.a(sI.b.LostFocus,{scope:"app",reason:i})),this.lastFirer=null}),200)},this.onRefocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&aI.FM.zsymb(0,"Da0NPO","onRefocus",e),this.dispatchEvent(new sI.a(sI.b.Focus,e)),this.lastFirer=null}),200)},this.detectors=new Map,this.lostFocusHandler=new Map,this.reFocusHandler=new Map,this.enableLog=!0}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&aI.FM.zsymb(0,"K3rbAy","onAuthenticated",t),this.init()}acquire(e,t,s){if(!e||e==Go.c)return iI.b;if(this.detectors.has(e))return aI.FM.zsymb(0,"UcxLji","acquire exists",e),this.detectors.get(e);this.enableLog&&aI.FM.zsymb(0,"3ZRDDU","acquire new",e);const i=new iI.a(e,t,s);return this.listenDetector(e,i),i}release(e){this.disposeDetector(e)}getAppIdleTime(){let e=Number.MAX_SAFE_INTEGER;return this.detectors.forEach((t=>{const s=t.getIdleInfo();s.idleFor<e&&(e=s.idleFor)})),e}updateIdleTimeout(e){this.detectors.forEach((t=>{t.setIdleTimeout(e)}))}isAppFocus(){let e=!1;return this.detectors.forEach((t=>{t.isActive()&&(e=!0)})),e}init(){this.listenDetector(Go.c,iI.b)}})||nI)||nI)||nI)||nI)||nI;const oI=Object(i.define)("lost-focus-service"),lI=Object(i.define)("active-service");var cI,dI=s("cHDa"),uI=function(e){return e[e.Focus=0]="Focus",e[e.LostFocus=1]="LostFocus",e}(uI||{});let hI=Object(i.injectable)()(cI=Object(Je.e)()(cI=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(cI=function(e,t){return Object(i.inject)(oI)(e,void 0,1)}(cI=Reflect.metadata("design:type",Function)(cI=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===oI?Object:oI])(cI=class{constructor(e,t){this.config=e,this.service=t,this.enableLog=void 0,this.currentState=void 0,this.enableLog=!0,this.currentState=uI.LostFocus}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&aI.FSTT.zsymb(0,"Z97WE8","onAuthenticated",t),this.init()}init(){const e=i.ModuleContainer.resolve(sI.c);e.addEventListener(sI.b.LostFocus,(e=>{const{scope:t,reason:s}=e.payload;this.currentState==uI.Focus&&"app"===t&&(this.service.notiLostFocus(),this.config.get("online_configs.enable_focus_manager")&&dI.b.setAppStatus(dI.a.BACKGROUND),this.currentState=uI.LostFocus)})),e.addEventListener(sI.b.Focus,(e=>{this.currentState==uI.LostFocus&&this.config.get("online_configs.enable_focus_manager")&&dI.b.setAppStatus(dI.a.FOREGROUND),this.currentState=uI.Focus}))}})||cI)||cI)||cI)||cI)||cI)||cI;var gI;let mI=Object(i.injectable)()(gI=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(gI=Reflect.metadata("design:type",Function)(gI=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(gI=class{constructor(e){this.config=e}notiLostFocus(){this.config.get("online_configs.enable_lost_focus")?pu.default.lostFocus().then(gu.a).then((()=>{aI.FSV.zsymb(0,"Hyk92w","send noti lost success")})).catch((e=>{aI.FSV.zsymb(0,"cyLe2P","send noti lost fail",JSON.stringify(e))})):aI.FSV.zsymb(0,"ydbET1","call send noti lost but feat disable")}})||gI)||gI)||gI)||gI;var pI,fI=s("a8HX"),vI=s("BOd8"),bI=s("G15u");let II=Object(i.injectable)()(pI=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(pI=function(e,t){return Object(i.inject)(lI)(e,void 0,1)}(pI=Reflect.metadata("design:type",Function)(pI=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,void 0===lI?Object:lI])(pI=class extends vI.a{constructor(e,t){super(),this.loggerFactory=e,this.service=t}createMachine(){return e=this.loggerFactory.createZLogger(Ve.ZLoggerNametags.activeDeactive,[Ve.ZLoggerNametags.stateMachine]),t=this.service,Object(bI.a)({strict:!0,id:"active-deactive",context:{},initial:"unset",states:{unset:{entry:()=>e.zsymb(3,"MWgCXP",["unset","gCuiyv"]),on:{FOCUS:{actions:()=>{e.zsymb(3,"0rDWxc",["start life cycle normal case!","fxa5tl"])},target:"foreground_active"},APP_UNLOCK:{actions:()=>{e.zsymb(3,"3uX6kJ",["start life cycle app auto lock case!","PZOdcn"])},target:"foreground_active"},LOST_FOCUS:{actions:()=>{e.zsymb(3,"PepzlW",["start life cycle lost focus case!","sXlXnk"])},target:"background_active"}}},foreground_active:{entry:s=>{e.zsymb(3,"WDlizl",["state: foreground_active","ueXYJ5"]),t.startForegroundMode()},on:{IDLE:{actions:()=>{},target:"background_deactive"},LOST_FOCUS:{actions:()=>{},target:"background_active"},INAPP_INTERACT:{actions:()=>{t.keepForegroundMode()}},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},APP_LOCK:{target:"background_deactive"},APP_UNLOCK:{actions:()=>{t.startForegroundMode()}},LOG_OFF:{target:"background_deactive"},OUTAPP_IDLE:{target:"background_deactive"}}},background_active:{entry:s=>{e.zsymb(3,"XSCMBA",["state: background_active","cdfZmy"]),t.startBackgroundMode()},on:{FOCUS:{target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},OUTAPP_IDLE:{target:"background_deactive"},APP_LOCK:{target:"background_deactive"},LOG_OFF:{target:"background_deactive"}}},background_deactive:{entry:(s,i)=>{e.zsymb(3,"xycA7Y",["state: background_deactive","Ux1Yd-"],i.status),t.startDeactive(i.status)},on:{FOCUS:{actions:()=>{},target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)},target:"background_active"},APP_UNLOCK:{target:"foreground_active"}}}},on:{RESET:{target:"unset",actions:()=>{}}}});var e,t}isUnset(){var e;return"unset"===(null===(e=this.interpreter)||void 0===e?void 0:e.state.value)}onceDeactive(e){var t;if("background_deactive"===(null===(t=this.interpreter)||void 0===t?void 0:t.state.value))e();else{let t=()=>{var s,i;"background_deactive"===(null===(s=this.interpreter)||void 0===s?void 0:s.state.value)&&(null===(i=this.interpreter)||void 0===i||i.off(t),e())};this.onChange(t)}}})||pI)||pI)||pI)||pI)||pI;var yI,_I=s("4zJP");const CI=new Map([["0","LOCK_SCREEN"],["1","UNLOCK_SCREEN"],["2","LOG_ON"],["3","LOG_OFF"],["4","SLEEP"],["5","RESUME"]]);let OI=Object(i.injectable)()(yI=Object(Je.i)()(yI=Object(Je.g)()(yI=Object(i.singleton)(fI.a)(yI=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(yI=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(yI=function(e,t){return Object(i.inject)(lI)(e,void 0,2)}(yI=Reflect.metadata("design:type",Function)(yI=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,void 0===lI?Object:lI])(yI=class{constructor(e,t,s){this.config=e,this.service=s,this.logger=void 0,this.machine=void 0,this.authenticated=void 0,this.appLocked=void 0,this.isRunning=void 0,this.lastConfig=void 0,this.onAppLock=()=>{this.logger.zsymb(0,"ziyAjE","app locked",this.authenticated),this.appLocked=!0,this.authenticated&&(this.machine.send({type:"APP_LOCK",status:2}),$zInAppPayment.closeInAppPayment())},this.onAppUnLock=()=>{this.logger.zsymb(0,"Syrvvc","app unlocked",this.authenticated),this.appLocked=!1,this.authenticated&&this.machine.send({type:"APP_UNLOCK",status:0})},this.onConfigChanged=e=>{mi.default.stagingAccount&&(window._activeController=this),e&&this.config.set("online_configs",e);const t=this.isConfigsReallyChanged();if(this.logger.zsymb(0,"ylvV0R","onConfigChanged",t),!t)return;this.lastConfig=this.config.get("online_configs");const s=this.config.get("online_configs.idle_time");i.ModuleContainer.resolve(sI.c).updateIdleTimeout(s/1e3),this.service.onConfigUpdated(),this.isEnable()?this.setup():this.onDispose()},this.onLostFocus=async e=>{const{scope:t,reason:s}=e.payload;"app"===t&&(this.logger.zsymb(0,"RKY3iX","lost focus",s),"no-action-timeout"!=s||await this.service.isUserHasAction(this.idleTime)?this.machine.send({type:"LOST_FOCUS"}):this.machine.send({type:"IDLE",status:0}))},this.onFocus=e=>{this.isUsingApp()&&(this.logger.zsymb(0,"pVMGT3","active-deactive focus"),this.machine.send({type:"FOCUS"}))},this.onActiveFromBackground=(e,t)=>{this.logger.zsymb(0,"Jh8pxN","onActiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_INTERACT",isOsEvt:t})},this.onDeactiveFromBackground=(e,t)=>{this.logger.zsymb(0,"jcwwcD","onDeactiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_IDLE",status:t})},this.machine=i.ModuleContainer.resolveToken(II),this.logger=t.createZLogger(Ve.ZLoggerNametags.activeDeactive,[Ve.ZLoggerNametags.controller]),this.config=e,this.service=s,this.authenticated=!1,this.appLocked=!1,this.isRunning=!1,this.lastConfig={},rt.p.listenEvent(rt.m,this.onConfigChanged);try{this.machine.create()}catch(n){return void this.logger.zsymb(18,"h09OUR",(()=>["create error",{error:n}]))}}createMachine(){}onStart(){this.isEnable()||this.logger.zsymb(0,"fIQ8Nk","feature is not enable")}setup(){if(this.logger.zsymb(0,"g5BYsS","setup",this.isRunning),this.clearBackgroundTracking(),this.isEnableBackgroundTrack()&&this.setupBackgroundTracking(),this.isRunning)return;this.isRunning=!0,this.machine.start();const e=i.ModuleContainer.resolve(sI.c);this.machine.isUnset()&&(e.isAppFocus()?this.machine.send({type:"FOCUS"}):this.machine.send({type:"LOST_FOCUS"})),e.addEventListener(sI.b.LostFocus,this.onLostFocus),e.addEventListener(sI.b.Focus,this.onFocus),this.appLocked=rt.p.getAppLock(),_I.b.on(_I.a.APP_LOCKED,this.onAppLock),_I.b.on(_I.a.APP_UNLOCKED,this.onAppUnLock)}onAuthenticated(){this.authenticated=!0,this.isEnable()&&this.service.onLogin()}onDispose(){if(!this.isRunning)return;this.isRunning=!1,this.machine.stop();const e=i.ModuleContainer.resolve(sI.c);e.removeEventListener(sI.b.LostFocus,this.onLostFocus),e.removeEventListener(sI.b.Focus,this.onFocus),_I.b.off(_I.a.APP_LOCKED,this.onAppLock),_I.b.off(_I.a.APP_UNLOCKED,this.onAppUnLock),this.clearBackgroundTracking()}isConfigsReallyChanged(){for(const e in this.config.get("online_configs"))if(e&&this.lastConfig[e]!==this.config.get(`online_configs.${e}`))return!0;return!1}setupBackgroundTracking(){}clearBackgroundTracking(){}onUserSendMessage(){this.isEnable()&&this.machine.send("INAPP_INTERACT")}onUserLogOff(){return new Promise((e=>{if(!this.isEnable()||!this.isUsingApp())return e(!1);this.machine.onceDeactive((()=>{e(!0)})),this.machine.send({type:"LOG_OFF",status:3}),this.onDispose(),setTimeout((()=>{e(!0)}),1e3)}))}onOSEvent(e){if(!this.isEnable())return;const t=CI.get(e);Fi.default.send(Ai.GeneralActions.USER_ACTIVE_CHANGED,t),this.logger.zsymb(3,"tH042x",["handle event os ","NE-uSU"],t)}isUsingApp(){const e=this.appLocked||rt.p.getWaitRestart();return this.authenticated&&!e}isEnable(){return this.config.get("online_configs.enable_active_deactive_v2")}isEnableBackgroundTrack(){return!1}isEnableFullBackgroundTrack(){return!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get idleTime(){return this.config.get("online_configs.idle_time")}})||yI)||yI)||yI)||yI)||yI)||yI)||yI)||yI)||yI;var EI,MI=s("8RMw"),SI=s("oQzU"),TI=function(e){return e[e.ActiveBackground=0]="ActiveBackground",e[e.KeepActiveForeground=1]="KeepActiveForeground",e[e.FirstActiveForeground=2]="FirstActiveForeground",e[e.ToBackground=3]="ToBackground",e[e.KeepActiveBackground=4]="KeepActiveBackground",e}(TI||{}),wI=function(e){return e[e.Idle=0]="Idle",e[e.ComputerLock=1]="ComputerLock",e[e.AppLock=2]="AppLock",e[e.LogOff=3]="LogOff",e}(wI||{}),RI=function(e){return e[e.Foreground=0]="Foreground",e[e.BackgroundActive=1]="BackgroundActive",e[e.BackgroundDeactive=2]="BackgroundDeactive",e}(RI||{});const LI={[RI.Foreground]:TI.KeepActiveForeground,[RI.BackgroundActive]:TI.KeepActiveBackground};let DI=Object(i.injectable)()(EI=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(EI=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(EI=function(e,t){return Object(i.inject)(sI.c)(e,void 0,2)}(EI=Reflect.metadata("design:type",Function)(EI=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,void 0===sI.c?Object:sI.c])(EI=class{constructor(e,t,s){this.config=e,this.focusManager=s,this.logger=void 0,this.pingTimer=void 0,this.deactiveTimer=void 0,this.status=void 0,this.configChanged=void 0,this.countPingWssFail=0,this.logger=t.createZLogger(Ve.ZLoggerNametags.activeDeactive,[Ve.ZLoggerNametags.service]),this.status=RI.Foreground,this.configChanged=!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get deactiveTimeout(){return this.config.get("online_configs.idleTime")}get enableSendDeactiveOnBgIdle(){return this.config.get("online_configs.enable_deact_on_bg_idle")}get enableSendDeactiveOnFgIdle(){return this.config.get("online_configs.enable_deact_on_fg_idle")}get enSendActiveToKeepAlive(){return this.config.get("online_configs.send_active_to_keep_live")}get enActiveUsingSocket(){return this.config.get("online_configs.send_active_using_socket")}get enableBackgroundTracking(){return this.config.get("online_configs.enable_background_tracking")}get enableFeature(){return this.config.get("online_configs.enable_active_deactive_v2")}get enableFullBackgroundTrack(){return!1}onLogin(){this.sendActiveToServer(TI.ActiveBackground)}startTrackIdle(e=!0){this.enableBackgroundTracking?this.logger.zsymb(0,"8U-iF2","startTrackIdle"):this.logger.zsymb(0,"ygoDia","in startTrackIdle but flag off")}stopTrackIdle(){this.logger.zsymb(0,"KSp5By","stopTrackIdle")}startForegroundMode(){this.status=RI.Foreground,this.sendActiveToServer(TI.FirstActiveForeground),this.clearPingTimer(),this.createPingTimer(),this.enableFullBackgroundTrack||this.stopTrackIdle()}keepForegroundMode(){this.sendActiveToServer(TI.KeepActiveForeground,{additionText:"[Send Msg] "})}startBackgroundMode(){this.status=RI.BackgroundActive,this.clearPingTimer(),this.startTrackIdle()}activeInBackground(e){const t=e?TI.ActiveBackground:TI.KeepActiveBackground;this.pingTimer?this.logger.zsymb(0,"hVjhjh","user action bg but dont need ping because in ping interval"):this.sendActiveToServer(t)}startDeactive(e){let t=-1;switch(e){case 0:t=wI.Idle;break;case 1:t=wI.ComputerLock;break;case 2:t=wI.AppLock;break;case 3:t=wI.LogOff}this.clearPingTimer(),-1!==t&&this.canSendDeactive(t)&&this.sendDeactiveToServer(t),this.status===RI.Foreground&&t==wI.Idle&&this.startTrackIdle(!1),t!=wI.ComputerLock&&t!=wI.AppLock||this.stopTrackIdle(),this.status=RI.BackgroundDeactive}onConfigUpdated(){this.configChanged=!0,this.enableFeature||this.clearPingTimer()}getStatus(){return this.status}createPingTimer(){!this.pingTimer&&this.enableFeature&&(this.logger.zsymb(0,"X9kxeJ","createPingTimer"),this.configChanged=!1,this.pingTimer=setInterval((()=>{const e=LI[this.status];e?this.sendPingActive(e):this.logger.zsymb(0,"-NRUYf","call ping invalid state!"),this.configChanged&&(this.clearPingTimer(),this.createPingTimer())}),this.pingInterval))}clearPingTimer(){this.logger.zsymb(0,"dTQ6j9","clearPingTimer"),clearInterval(this.pingTimer),this.pingTimer=null}async isUserHasAction(e){return this.focusManager.getAppIdleTime()<e}canSendDeactive(e){return e!==wI.Idle||(this.status===RI.Foreground&&this.enableSendDeactiveOnFgIdle||this.status===RI.BackgroundActive&&this.enableSendDeactiveOnBgIdle)}async sendPingActive(e){await this.isUserHasAction(this.pingInterval)?this.sendActiveToServer(e):this.logger.zsymb(3,"-jl-Gd",["call ping but discard, because the user don't have action!","yiA7dl"])}sendActiveToServer(e,t={additionText:""}){const{additionText:s}=t;if(!this.enActiveUsingSocket||id.default.getMsgSrcType()!==R.MsgSources.SOCKET)return fi.default.increaseFailed(88888,0,0,e,Date.now()),this.sendActiveViaHttp(e,s).then((e=>(e&&(this.countPingWssFail=0),e)));let i=null;return i=this.enSendActiveToKeepAlive?MI.default.pingActiveViaKeepAlive(e):SI.a.instance().pingActive(e),i.then((()=>(this.countPingWssFail=0,this.logger.zsymb(3,"uKzd6M",["{}Call active app SUCCESS: socket - {}","-33RSN"],s,e),!0))).catch((t=>(this.logger.zsymb(21,"grwhWp",["{}Call active fail: socket - {} - {}","7G5BwQ"],s,e,JSON.stringify(t)),this.countPingWssFail++,fi.default.increaseFailed(88888,1,0,e,Date.now()),this.sendActiveViaHttp(e).then((t=>(t&&this.countPingWssFail>=3&&(this.countPingWssFail=0,fi.default.increaseFailed(88888,2,0,e,Date.now())),t))))))}sendActiveViaHttp(e,t=""){return new Promise((s=>{pu.default.active(e).then(gu.a).then((()=>{this.logger.zsymb(3,"chIOjs",["{}Call active app SUCCESS: http - {}","7kvaJm"],t,e),s(!0)})).catch((i=>{this.logger.zsymb(21,"LJrRdP",["{}Call active fail: http - {} - {}","JZvviw"],t,e,JSON.stringify(i)),s(!1)}))}))}sendDeactiveToServer(e){return pu.default.deactiveV2().then(gu.a).then((()=>(this.logger.zsymb(3,"a6QtZh",["Call deactive app SUCCESS {}","GZB00A"],e),!0))).catch((e=>(this.logger.zsymb(21,"8e6c6M",["Call deactive fail: ","FHUgrR"],JSON.stringify(e)),!1)))}})||EI)||EI)||EI)||EI)||EI)||EI;i.ModuleContainer.registerSingleton(oI,mI),i.ModuleContainer.registerSingleton(sI.c,rI),i.ModuleContainer.registerSingleton(lI,DI),i.ModuleContainer.resolve(sI.c),i.ModuleContainer.resolveToken(hI),i.ModuleContainer.resolveToken(OI);var AI,FI=s("CPou"),jI=s("MnxE"),PI=s("1rNO"),kI=s("NDwn");Object(ko.b)(Wc.b)(AI=Reflect.metadata("design:type",Function)(AI=Reflect.metadata("design:paramtypes",[])(AI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.onlyAdminChatSettings,[this.name])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.settings=new Map,this.me="",this._Logger=void 0,this.name=Wc.a,this.key=Wc.a,1===mi.default.only_admin_chat_setting.enable_only_admin_chat_setting&&this._addPublicGroupSettingEventListener(),this._addPublicFriendEventListener(),kI.a||jI.a.signalCallback(this.onSettingsUpdate.bind(this))}_filterSettingKeys(e,t,s){let i={lockSendMsg:!1};for(let n in e)Object.keys(FI.a).includes(n)&&n===FI.a.lockSendMsg&&(i[FI.a.lockSendMsg]=!t&&!s&&Boolean(e[FI.a.lockSendMsg]));return i}_onUpdateSettings(e,t,s,i){this.me||(this.me=ns.default.getUidMe());const n=this.me===t,a=this._filterSettingKeys(i,n,s);return this.settings.set(e,a),Object(hs.h)(this.name,e),a}showNoti(e){if("TOAST"===e.type)Ri.ZToastManagerHolder.getZToastManagerByWindowId(e.windowId||Go.c).show(Object(f.a)({},e.config))}verifySetting(e){const{convId:t,field:s,showNoti:i}=e,n=this.settings.get(t);return n?(i&&i.triggerValue===n[s]&&this.showNoti(i),n&&n[s]):null}onSettingsUpdate(e,t){let s=this.settings.get(e)||{lockSendMsg:!1};for(let i in t)Object.keys(FI.a).includes(i)&&(s[i]=t[i]);this.settings.set(e,s),Object(hs.h)(this.name,e)}_addPublicGroupSettingEventListener(){Zo.default.subscribeEventGroup(R.EventGroup.CHANGE_OWNER,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),Zo.default.subscribeEventGroup(R.EventGroup.ADD_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),Zo.default.subscribeEventGroup(R.EventGroup.REMOVE_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),Zo.default.subscribeEventGroup(R.EventGroup.GROUP_INFO_CHANGED,(e=>{if(null!=e&&e.length)for(let t=0;t<e.length;t++)this.onLoadGroupSetting(e[t])})),zl.default.subscribe(Go.a.CHILD_WINDOW_ALIVE,(e=>{null!=e&&e.windowId&&this.onLoadSetting(e.windowId)})),Fi.default.subscribe(((e,t)=>{switch(e){case Ai.FetchActions.UPDATE_GROUP_SETTING:{var s,i;const e=null!=t&&null!==(s=t.data)&&void 0!==s&&null!==(i=s.groupId)&&void 0!==i&&i.startsWith("g")?t.data.groupId:"g"+t.data.groupId;e&&this.onLoadGroupSetting(e);break}}}))}updateFriendBLockSetting(e,t){const s=t||ns.default.isBlocked(e),i=1===mi.default.block_msg_call_setting.enable_block_msg_call_setting;let n=Boolean(s)&&i;if(!n&&ns.default.isOA(e,!1)){const t=PI.a(ns.default.getOAStatus(e));t&&t.enable&&(n=!0)}this.onSettingsUpdate(e,{[FI.a.lockSendMsg]:n})}_addPublicFriendEventListener(){ns.default.subscribeEventFriend(R.EventFriend.BLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!0)})),ns.default.subscribeEventFriend(R.EventFriend.UNBLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!1)})),Fi.default.subscribe(((e,t)=>{if(e===Ai.FriendsAction.FRIENDS_CHANGE_INFO)t&&Array.isArray(t)&&t.forEach((({userId:e})=>{this.updateFriendBLockSetting(e)}))}))}_checkGroupAdmin(e){var t;return this.me||(this.me=ns.default.getUidMe()),(null==e||null===(t=e.topMember)||void 0===t?void 0:t.filter((e=>e.id===this.me&&e.isAdmin)).length)>0}onLoadGroupSetting(e){return new Promise(((t,s)=>{Zo.default.getFullInfoGroupById(e).then((s=>{if(!s)return this.Logger.zsymb(18,"TY6MH9","[GroupSetting]: Load GroupInfo from manager faily "+s+", GroupId: "+e),t(null);const i=s.setting,n=s.creatorId,a=this._checkGroupAdmin(s),r=this._onUpdateSettings(e,n,a,i);i&&!i.hasOwnProperty("lockSendMsg")&&this.Logger.zsymb(18,"KXhr-X","[GroupSetting]: Dont have field lockSendMsg in setting data"),t(r)})).catch((s=>{this.Logger.zsymb(18,"jHky49","[GroupSetting]: Have error in loadiing GroupInfo from manager: "+JSON.stringify(s)+", GroupId: "+e),t(null)}))}))}async onLoadSetting(e){return e.startsWith("g")?1!==mi.default.only_admin_chat_setting.enable_only_admin_chat_setting?null:await this.onLoadGroupSetting(e):(this.updateFriendBLockSetting(e),kI.a?null:void jI.a.signalIfUnlock(e))}init(e){throw new Error("Method not  .")}getCurrentItem(e){return this.settings.get(e)}getItem(e,t){return this.settings.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||AI)||AI);const NI=Object(i.define)("media-primary-key-convertor");var UI;let BI=Object(i.injectable)()(UI=class{async toMediaPKFromMessagePK(e,t){if(!t)return"";const s=await tt.default.getInstance().Core.Message.get(t,{partition:e});return s&&(s.cliMsgId||s.fromUid||s.toUid)?`${s.cliMsgId}_${s.fromUid}_${s.toUid}`:""}async toMessagePKFromMediaPK(e){const[t,s,i]=this._getThreePartsFromMediaPK(e);if(!t||!s||!i)return"";const n=await this._getMessagesByCliMsgIdRange(t,i);let a="";return n.forEach((e=>{e.fromUid===s&&e.toUid===i&&(a=e.msgId)})),a}_getMessagesByCliMsgIdRange(e,t){const s={from:e,to:e,excludeFrom:!1,excludeTo:!1},i={index:"cliMsgIdIndex",partition:t};return tt.default.getInstance().Core.Message.getAll(s,i)}_getThreePartsFromMediaPK(e){if("string"!=typeof e||!e)return[];const[t,s,i]=e.split("_");return[t,s,i]}})||UI;i.ModuleContainer.register(NI,BI);const xI=Object(i.define)("utils-media-mapper"),GI=Object(i.define)("file-media-mapper"),zI=Object(i.define)("image-media-mapper"),VI=Object(i.define)("link-media-mapper");var HI;let WI=Object(i.injectable)()(HI=class{toUtilsMediaDTOFromDomain(e){return{id:e.id,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds,fileTypes:e.fileTypes}}})||HI;i.ModuleContainer.register(xI,WI);var $I,KI=s("v6qY"),qI=s("IZCB");function QI(e){try{const t=JSON.parse(e),{fileExt:s,fType:i}=t;return"zip"===s&&2===i}catch(t){return!1}}function ZI(e){try{if(QI(e))return"folder";const t=JSON.parse(e);if(!t)return"";const{fileExt:s}=t;return s.toLowerCase()}catch(t){return""}}function JI(e){try{const t=JSON.parse(e);if(!t)return{width:null,height:null};const{width:s,height:i}=t;return{width:s,height:i}}catch(t){return{width:null,height:null}}}let YI=Object(i.injectable)()($I=class{toDomainFromOldDomain(e,t=`${KI.c.UNKNOWN}${KI.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldImageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This oldImageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,src:t,sendDttm:s,ttl:e.ttl,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:e.updateTime||s,metadata:Object(f.a)(Object(f.a)({},JI(e.message.params)),{},{vOrient:qI.a.None})}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This imageDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This imageDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,sendDttm:t,src:e.src,ttl:"number"==typeof e.ttl?e.ttl:0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:"number"==typeof e.updateTime?e.updateTime:t,metadata:Object(f.a)(Object(f.a)({},JI(e.message.params)),{},{vOrient:e.vOrient||qI.a.None})}}toDomainFromTMessage(e,t,s=`${KI.c.UNKNOWN}${KI.d.FROM_MSG}`){if(!e||!e.message)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},s=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,n="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${n}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:n,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},src:s,type:t,sendDttm:i,ttl:e.ttl||0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:i,metadata:Object(f.a)(Object(f.a)({},JI(e.message.params)),{},{vOrient:qI.a.None})}}async toDTO(e,t=!0){if(!e||!e.mediaId)throw Error("This imageEntity isn't valid!");const s=e.msgId?e.msgId:t?await i.ModuleContainer.resolve(NI).toMessagePKFromMediaPK(e.mediaId):"";return{mediaId:e.mediaId,msgId:s,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""},sendDttm:e.sendDttm,src:e.src,ttl:e.ttl,type:"image",subType:e.type,id:0,localPath:e.localPath,previewThumb:e.previewThumb,updateTime:e.modifiedTime,width:e.metadata.width,height:e.metadata.height,vOrient:e.metadata.vOrient}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"image",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts is undefined or not valid!");const t={};var s,i;(e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""}),e.hasOwnProperty("subType")&&(t.subType=e.type),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("metadata"))&&(t.width=null===(s=e.metadata)||void 0===s?void 0:s.width,t.height=null===(i=e.metadata)||void 0===i?void 0:i.height);return t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts is undefined or not valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null}),e.hasOwnProperty("subType")&&(t.type=e.subType),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("width")&&e.hasOwnProperty("height")&&e.hasOwnProperty("vOrient")&&(t.metadata={width:e.width,height:e.height,vOrient:e.vOrient||0}),t}})||$I;var XI;i.ModuleContainer.register(zI,YI);let ey=Object(i.injectable)()(XI=class{toDomainFromOldDomain(e,t=`${KI.c.UNKNOWN}${KI.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldFileEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This oldFileEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:QI(e.message.params)?KI.a.FOLDER:KI.a.FILE,src:t,extType:ZI(e.message.params),sendDttm:s,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||s,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(f.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This fileDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This fileDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:e.fileType||QI(e.message.params)?KI.a.FOLDER:KI.a.FILE,src:e.src,extType:e.extType||ZI(e.message.params),sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(f.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}async toDTO(e){if(!e||!e.mediaId||!e.content)throw Error("This fileEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(NI).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""},sendDttm:e.sendDttm,ttl:e.ttl,src:e.src,type:"file",fileType:e.type,extType:e.extType,id:0,updateTime:e.modifiedTime,localPath:e.localPath||"",folderPath:e.folderPath||"",downloadError:!1,dimension:"object"==typeof e.thumbMetadata?e.thumbMetadata:null,previewThumb:""}}toDomainFromMessage(e,t=`${KI.c.UNKNOWN}${KI.d.FROM_MSG}`){if(!e||!e.msgId||!e.message)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},s=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:QI(e.message.params)?KI.a.FOLDER:KI.a.FILE,src:t,extType:ZI(e.message.params),sendDttm:s,ttl:e.ttl||0,modifiedTime:s,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"file",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("dimension")&&(t.dimension=e.thumbMetadata?{width:e.thumbMetadata.width,height:e.thumbMetadata.height,type:e.thumbMetadata.type,orientation:e.thumbMetadata.orientation,bigRes:e.thumbMetadata.bigRes}:null),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""}),e.hasOwnProperty("fileType")&&(t.type=e.fileType),e.hasOwnProperty("extType")&&(t.extType=e.extType||""),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("dimension")&&(t.thumbMetadata=e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:e.dimension.orientation,bigRes:e.dimension.bigRes}:null),t}})||XI;var ty;i.ModuleContainer.register(GI,ey);let sy=Object(i.injectable)()(ty=class{toDomainFromOldDomain(e,t=`${KI.c.UNKNOWN}${KI.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldLinkEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This oldLinkEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:"object"==typeof e.message.title?e.message.title.title||"":e.message.title,params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""},type:-1,src:t,sendDttm:s,ttl:e.ttl,modifiedTime:e.updateTime||s,parsedInfo:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This linkDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This linkDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:"object"==typeof e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},src:e.src,type:"number"==typeof e.linkType?e.linkType:-1,sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,parsedInfo:null}}async toDTO(e){if(!e||!e.mediaId)throw Error("This linkEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(NI).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:parseInt(e.cliMsgId),fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""},sendDttm:e.sendDttm,type:"link",ttl:e.ttl,src:e.src,linkType:e.type,id:0,updateTime:e.modifiedTime,previewThumb:"",parsedInfo:"object"==typeof e.parsedInfo?Object(f.a)({},e.parsedInfo):null}}toDomainFromMessage(e,t=`${KI.c.UNKNOWN}${KI.d.FROM_MSG}`){if(!e)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},s=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:"object"===e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},type:-1,src:t,sendDttm:s,ttl:e.ttl||0,modifiedTime:s,parsedInfo:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"link",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("content")&&"object"==typeof e.content&&(t.message={title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};var s;e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:"object"==typeof e.message.title?(null===(s=e.message.title)||void 0===s?void 0:s.title)||"":e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""});return e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("linkType")&&(t.type=e.linkType),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("parsedInfo")&&(t.parsedInfo=e.parsedInfo?{protocol:e.parsedInfo.protocol||"",host:e.parsedInfo.domain||""}:null),t}})||ty;i.ModuleContainer.register(VI,sy);var iy=s("GbHB");let ny=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({}),ay=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({}),ry=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({});const oy="DONE",ly="NOT_DONE",cy="UNKNOWN",dy="GET_FROM_OLD_DB",uy="ADD_TO_NEW_DB",hy="DELETE_FROM_OLD_DB",gy="DONE",my="FAILED",py="NEW",fy="RUNNING",vy="FAILED",by="persisted_job_desc_summaries",Iy="migration_state";class yy{constructor(e,t,s,i,n,a){this._dbInstance=void 0,this._mediaMigrationManager=void 0,this._dalInstance=tt.default.getInstance(),this.dbTable=void 0,this.logger=void 0,this.mediaType=void 0,this.dbTable=this._dalInstance[e][t],this._dbInstance=this._dalInstance[e],this.mediaType=s,this._mediaMigrationManager=n,this.logger=a.createZLogger(`${e}-${t}-repository`,[i])}async insert(e,t){if(!e)throw Error("[insert]: item is undefined!");if(!e.cliMsgId||!e.fromUid||!e.convId)throw Error(`[insert]: item doesn't have valid key_from_to: ${e.cliMsgId}_${e.fromUid}_${e.convId}`);return e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,!!(await this.dbTable.insert(e,t))}insertMulti(e,t){if(!e||!e.length)throw Error("[insertMulti]: items is undefined or empty!");const s=[];return e.forEach((e=>{e.cliMsgId&&e.fromUid&&e.convId?(e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,s.push(e)):this.logger.zsymb(21,"ZquLfQ",["[insertMulti]: media doesn't have valid key_from_to: {}_{}_{}","LrHB7F"],e.cliMsgId,e.fromUid,e.convId)})),this.dbTable.insertMulti(s,t)}async update(e,t){if(!yy.isNewMediaIdFormat(e))throw Error("[update]: mediaId doesn't have new media id format!");return!!(await this.dbTable.update(e,t))}async updateMedia(e,t,s=ny.UNKNOWN){if(!e)throw Error("[updateMedia]: mediaIdObj is undefined!");const{newId:i,oldId:n}=e;if((s===ny.NEW||await this._isMigrationDone())&&i)return!!(await this.dbTable.update(i,t));if(s===ny.OLD&&n){let e;if(t){const s=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(f.a)(Object(f.a)({},t),{},{attributes:Object.keys(s),value:s}),!!(await this.getOldDBTable().update(n,e))}throw Error("options is undefined!")}try{if(i){if(await this.dbTable.get(i))return!!(await this.dbTable.update(i,t))}if(n){let e;if(t){const s=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(f.a)(Object(f.a)({},t),{},{attributes:Object.keys(s),value:s}),!!(await this.getOldDBTable().update(n,e))}throw Error("options is undefined!")}throw Error(`${i} or ${n} isn't valid!`)}catch(a){throw Error(`[updateMedia] - err: ${a.message}`)}}async updateMulti(e){return await this.dbTable.updateMulti(e)}async updateMultiMedias(e){throw Error("This updateMultiMedias isn't implemented!")}delete(e,t){if(!yy.isNewMediaIdFormat(e))throw Error("[delete]: mediaId doesn't have new media id format!");return this.dbTable.delete(e,t)}deleteMulti(e,t){if(!e||!e.length)throw Error("[deleteMulti]: mediaIds is undefined or empty!");if(e.some((e=>!yy.isNewMediaIdFormat(e))))throw Error("[deleteMulti]: mediaIds contains an id which doesn't have new media id format!");return this.dbTable.deleteMulti(e,t)}async deleteMedia(e,t,s=ry.UNKNOWN){if(!e)throw Error("[deleteMedia]: mediaObj is undefined!");const{newId:i,oldId:n}=e;if((s===ry.NEW||await this._isMigrationDone())&&i)return this.dbTable.delete(i);if(s===ry.OLD&&n)return this.getOldDBTable().delete(n,t);{const e=[];i&&e.push(this.dbTable.delete(i,t)),n&&e.push(this.getOldDBTable().delete(n,t));return(await Promise.allSettled(e)).every((e=>"fulfilled"===e.status&&e.value))}}async deleteMultiMedias(e,t){if(!e||!e.length)throw Error("[deleteMultiMedias]: mediaIdObjs is undefined or empty!");const s={success:[],fail:[]},i=[];for(const{newId:n,oldId:a,deleteTo:r}of e){const e=(r===ry.NEW?n:r===ry.OLD?a:n||a||"")||"",o=async()=>{try{await this.deleteMedia({newId:n,oldId:a},t,r)&&s.success.push(e)}catch(o){var i;const t=[null==o||null===(i=o.toString)||void 0===i?void 0:i.call(o),null==o?void 0:o.stack].join("\n");this.logger.zsymb(18,"yFMxag",t),s.fail.push(e)}};i.push(o)}return await Promise.allSettled(i.map((e=>e()))),s}async get(e,t){if(!yy.isNewMediaIdFormat(e))throw Error("[get]: mediaId doesn't have new media id format!");return this.dbTable.get(e,t)}async getMulti(e,t){const{newIdFormats:s,oldIdFormats:i}=e.reduce(((e,t)=>(yy.isNewMediaIdFormat(t)&&e.newIdFormats.push(t),e)),{newIdFormats:[],oldIdFormats:[]});let n=[];if(s.length){const e=await this.dbTable.getMulti(s,t);e.length&&n.push(...e)}return n}async getMedia(e,t,s=ay.UNKNOWN){if(!e)throw Error("[getMedia]: mediaIdObj params is undefined!");const{newId:i,oldId:n}=e;if((s===ay.NEW||await this._isMigrationDone())&&i)return this.dbTable.get(i,t);if(s===ay.OLD&&n){const e=await this.getOldDBTable().get(n,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}else{if(i){const e=await this.dbTable.get(i,t);if(e)return e}if(n){const e=await this.getOldDBTable().get(n,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}}}async getMultiMedias(e,t){if(!e||!e.length)throw Error("[getMultiMedias]: mediaIdObjs is undefined or empty!");let s=[];const i=[];for(const{newId:n,oldId:a,getFrom:r}of e)i.push(this.getMedia({newId:n,oldId:a},t,"number"==typeof r?r:ay.UNKNOWN));return s=(await Promise.allSettled(i)).map((e=>"fulfilled"===e.status?e.value:void 0)),s}getAll(e,t){if(!e)throw Error("[getAll]: keyRange is undefined!");return this.dbTable.getAll(e,t)}async getAllInOldDB(e,t){if(await this._isMigrationDone())return[];if(!e)throw Error("[getAllInOldDB]: keyRange is undefined!");const s=await this.getOldDBTable().getAll(e,t);return null!=s&&s.length?s.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}static isNewMediaIdFormat(e){if(!e)return!1;const t=e.split("_");return 3===t.length&&t.every(Boolean)}static filterMedia(e,t){if(!(t&&(t.member||t.date&&(t.date.start||t.date.end)||t.name||t.ext)))return!0;if(!t.member||e.fromUid&&e.fromUid===t.member){let i,n,a;if(t.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);i=t.mediaTitle?ho.default.simpleStripVietnamese(t.mediaTitle):ho.default.simpleStripVietnamese(e.message.title),n=t.src}catch(s){return ho.default.logCoreError(s),!1}a=ho.default.simpleStripVietnamese(t.name)}if(!t.name||a.length<=i.length&&ho.default.searchContent(i,a)||ho.default.searchContent(n,a)){let i=!1;if(t.ext&&(i=R.fileExt[t.ext].some((t=>{if(!e.message.title){const t=iy.a.decrypt(e.message,Rt.default.UIN,!1);try{e.message=JSON.parse(t)}catch(s){e.message={title:""}}}return e.message.title.endsWith(t)}))),!t.ext||i)return null==t.date.start&&null==t.date.end||(e.sendDttm>=t.date.start?e.sendDttm<=t.date.end:0)}}return!1}async isExistedMedia(e){let t=!1;if(e){const{newId:s,oldId:i}=e;s&&(t=!!(await this.dbTable.get(s))),i&&!t&&(t=!!(await this.getOldDBTable().get(i)))}return t}async getLastMediasOfConv(e,t,s=100){if(!e||!t)throw Error(`[getLastMediasOfConv]: convId: ${e}, lastItemOptions:${JSON.stringify(t)} isn't valid!`);const{sendDttm:i,cliMsgId:n,msgId:a}=t,r=await this.getLastMediasOfConvInNewDB(e,{sendDttm:i,cliMsgId:n},s);return r.length<s&&!(await this._isMigrationDone())&&r.push(...await this.getLastMediasOfConvInOldDB(e,{msgId:a},s-r.length)),r}async countMediaOfConv(e,t){let s=0;if(!(e&&t&&t.from&&t.to))throw Error(`[countMediaOfConv]: convId: ${e}, options: ${JSON.stringify(t)} isn't valid!`);const{from:i,to:n}=t;return s=await this.countMediaOfConvInNewDB(e,{from:{sendDttm:i.sendDttm,cliMsgId:i.cliMsgId},to:{sendDttm:n.sendDttm,cliMsgId:n.cliMsgId}}),await this._isMigrationDone()||(s+=await this.countMediaOfConvInOldDB(e,{from:{msgId:i.msgId},to:{msgId:n.msgId}})),s}countMediaOfConvInNewDB(e,t){const{from:s,to:i}=t,n={from:[e,s.sendDttm,s.cliMsgId],to:[e,i.sendDttm,i.cliMsgId],excludeFrom:!1,excludeTo:!1};return this.dbTable.count(n,{index:"convId_sendDttm_cliMsgId"})}async countMediaOfConvInOldDB(e,t){if(await this._isMigrationDone())return 0;const{from:s,to:i}=t,n={from:[e,s.msgId.length,s.msgId],to:[e,i.msgId.length,i.msgId],excludeFrom:!1,excludeTo:!1};return this.getOldDBTable().count(n,{index:"userId_sendDttm_msgId"})}async getMediasOfConv(e,t,s,i){if(!e||!t||!s)return Promise.resolve([]);let n=[];if(mi.default.load_media.optimize_mode&&(n=await this._isMigrationDone()?await this.getMediasOfConvOptimizeMode(e,t,s,i):await this.getMediasOfConvOptimizeModeInMixedDB(e,t,s,i)),null!=i&&i.deletePointOfConv){const{lastId:e,lastSendDttm:t,lastCliMsgId:s}=i.deletePointOfConv;return n.filter((i=>!(e&&i.msgId&&i.msgId<=e)&&(!(t&&i.sendDttm<=t)&&!(s&&i.cliMsgId<=s))))}return n}async getMediasOfConvOptimizeModeInMixedDB(e,t,s,i){let n=!1,a=!1;i&&i.date&&(null!==i.date.start||null!==i.date.end)&&(n=!0);const r=[],{sendDttm:o,cliMsgId:l}=await this.getSendDttmOfLatestMediaInOldDB(e),{sendDttm:c,cliMsgId:d,msgId:u}=t,h={from:[e,0,""],to:[e,c,d],excludeFrom:!0,excludeTo:!0},g={index:"convId_sendDttm_cliMsgId",limit:s,direction:Le.c.PREV,useLGKeyRange:!0,predicate:e=>{if(!e)return!1;if(!ho.default.mapHasItem(e.content))return!1;const t=Yd.a.instance.filterDBMessage(e),s=Object(nu.e)(e);if(!t||!s)return!1;let n=yy.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},i);return 0===n&&(a=!0),!!n&&(e.sendDttm>o&&e.cliMsgId>l||(r.push(e),!1))},aborted:n?()=>a:void 0};try{let t=await this.dbTable.getAll(h,g);if(t.length<s){const n=await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:u},s-t.length,i),a=[];n.length>0?r.length>0?(n.forEach((e=>{const t=r[0];t&&e.sendDttm<=t.sendDttm&&e.cliMsgId<=t.cliMsgId?(a.push(t),r.shift()):a.push(e)})),r.length>0&&a.push(...r),t.push(...a.slice(0,s-t.length))):t.push(...n):r.length>0&&t.push(...r)}return t}catch(m){const t=[e,this.mediaType,s,c,d,!!i].join("_");throw this.logger.zsymb(21,"jNJsCk",["[getMediasOfConvOptimizeModeInMixedDB] errInfo: {}","wiGF2f"],t),m}}async getSendDttmOfLatestMediaInOldDB(e){const t={from:[e,0,""],to:[e,R.MessageConstants.MAX_SENDDTTM,R.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},s={index:"userId_sendDttm_msgId",limit:1,direction:Le.c.PREV},i=await this.getOldDBTable().getAll(t,s);if(!i||!i[0])return{sendDttm:0,cliMsgId:"0"};return{sendDttm:"string"==typeof i[0].sendDttm?parseInt(i[0].sendDttm):i[0].sendDttm,cliMsgId:""+(i[0].cliMsgId||0)}}async getMediasOfConvOptimizeMode(e,t,s,i){if(!e||!t||!s)throw Error(`[getMediasOfConvOptimizeMode]: convId: ${e}, lastItemOptions: ${JSON.stringify(t)}, limit: ${s} isn't valid!`);const{sendDttm:n,cliMsgId:a,msgId:r}=t,o=await this.getMediasOfConvOptimizeModeInNewDB(e,{sendDttm:n,cliMsgId:a},s,i);return o.length<s&&!(await this._isMigrationDone())&&o.push(...await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:r},s-o.length,i)),o}getMediasOfConvOptimizeModeInNewDB(e,t,s,i){let n=!1,a=!1;i&&i.date&&(null!==i.date.start||null!==i.date.end)&&(n=!0);const{sendDttm:r,cliMsgId:o}=t,l={from:[e,0,""],to:[e,r,o],excludeFrom:!0,excludeTo:!0},c={index:"convId_sendDttm_cliMsgId",limit:s,direction:Le.c.PREV,predicate:e=>{if(!e)return!1;if(!ho.default.mapHasItem(e.content))return!1;const t=Yd.a.instance.filterDBMessage(e),s=Object(nu.e)(e);if(!t||!s)return!1;let n=yy.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},i);return 0===n&&(a=!0),!!n},aborted:n?()=>a:void 0};try{return this.dbTable.getAll(l,c)}catch(d){const t=[e,this.mediaType,s,r,o,!!i].join("_");throw this.logger.zsymb(21,"Odmu_w",["[getMediasOfConvOptimizeModeInNewDB] errInfo: {}","ncB7wi"],t),d}}async getMediasOfConvOptimizeModeInOldDB(e,t,s,i){if(await this._isMigrationDone())return[];let n=!1,a=!1;i&&i.date&&(null!=i.date.start||null!=i.date.end)&&(n=!0);const{msgId:r}=t,o={from:[e,0,""],to:[e,r.length,r],excludeFrom:!0,excludeTo:!0},l={index:"userId_sendDttm_msgId",limit:s,direction:Le.c.PREV,useLGKeyRange:!0,predicate:e=>{if(e){if(e.msgId&&e.msgId.includes("_"))return!1;if(!ho.default.mapHasItem(e.message))return!1}let t=Yd.a.instance.filterDBMessage(e),s=Object(nu.e)(e);if(!t||!s)return!1;let n=yy.filterMedia(e,i);return 0===n&&(a=!0),!!n},aborted:n?()=>a:void 0};try{const e=await this.getOldDBTable().getAll(o,l);return(await this.correctMediasInOldDB(e)).map((e=>this.getMediaMapper().toDomainFromOldDomain(e)))}catch(c){const t=[e,this.mediaType,s,r,!!i].join("_");throw this.logger.zsymb(21,"OXRkZA",["[getMediasOfConvOptimizeModeInOldDB] errInfo: {}","vlSmAy"],t),c}}getLastMediasOfConvInNewDB(e,t,s){const{sendDttm:i,cliMsgId:n}=t,a={from:[e,0,""],to:[e,i,n],excludeFrom:!1,excludeTo:!1},r={index:"convId_sendDttm_cliMsgId",limit:s,direction:Le.c.PREV};return this.dbTable.getAll(a,r)}async getLastMediasOfConvInOldDB(e,t,s){if(await this._isMigrationDone())return[];const{msgId:i}=t,n={from:[e,0,""],to:[e,i.length,i],excludeFrom:!1,excludeTo:!1},a={index:"userId_sendDttm_msgId",limit:s,direction:Le.c.PREV},r=await this.getOldDBTable().getAll(n,a);return r.length>0?r.map((e=>Object(f.a)(Object(f.a)({},this.getMediaMapper().toDomainFromOldDomain(e)),{},{msgId:e.msgId}))):[]}correctMediasInOldDB(e,t={saveBack:!0}){return e&&e.length?new Promise((s=>{let i=[],n={},a=[];if(e.forEach((e=>{if(e&&e.msgId&&e.sendDttm){const t=null==e.fromUid;e.type&&e.cliMsgId&&!t?a.push(e):(i.push(e.msgId),n[e.msgId]=e)}})),!i.length)return s(a);{let r="";const o=(e,t)=>{let s=!0;switch(t.msgType){case R.MSG_PHOTO:case R.MSG_PHOTO_2:r="image",e.subType=R.MSG_SUBTYPE_PHOTO;break;case R.MSG_VIDEO:r="image",e.subType=R.MSG_SUBTYPE_MEDIA_VIDEO;break;case R.MSG_FILE:r="file";break;case R.MSG_CONTACT:"object"==typeof t.message&&"recommened.link"===t.message.action&&(r="link")}e.cliMsgId=t.cliMsgId,e.type=r;return""!==t.fromUid&&null!=t.fromUid?(s=!0,e.fromUid=t.fromUid+""):s=!1,{isSuccess:s,data:s?e:null}},l=e[0].userId;Rt.default.getConvMessagesByIdsInQueue(i,l).then((e=>{const i=[],r=[];if(e){for(let s in e)if(e[s]){const t=n[s];delete n[s];const{isSuccess:a,data:l}=o(t,e[s]);a&&l?i.push(l):r.push(s)}const t=Object.getOwnPropertyNames(n);t.length&&t.forEach((e=>{r.push(e)}))}let l=a.concat(i);return l.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),i.length&&t.saveBack&&this.deleteAndInsertInOldDB(i),r.length&&this.getOldDBTable().deleteMulti(r),s(l)})).catch((e=>s(a)))}})):Promise.resolve([])}async deleteAndInsertInOldDB(e){if(!e||!e.length)throw Error(`[deleteAndInsertInOldDB]: oldItems: ${JSON.stringify(e)} isn't valid!`);return this.getOldDBTable().insertMulti(e,{replace:!0})}async _isMigrationDone(){return(await this._mediaMigrationManager.getMediaMigrationState()).stateName===oy}}class _y extends yy{constructor(e,t,s,i,n,a){super(e,t,s,i,n,a)}async getImageMessagesForPhotoViewer(e,t,s,i,n,a){const r=await this.getMsgIdsOfImageMediaForPhotoViewer(e,s,t,i,n,a);if(null==r||!r.length)return[];const o=await Promise.all(r.map((e=>this.getMediaMapper().toDTO(e))));return Rt.default._fillExifBeforeShow(o),o}async getMsgIdsOfImageMediaForPhotoViewer(e,t,s,i,n,a){const r=i&&n;let o=!1;const l=()=>o,c=e=>{if(!(a&&(a.member||a.date&&(a.date.start||a.date.end)||a.name||a.ext)))return!0;if(!a.member||e.fromUid&&e.fromUid===a.member){let s,i,n;if(a.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);s=t.mediaTitle?ho.default.simpleStripVietnamese(t.mediaTitle):ho.default.simpleStripVietnamese(e.message.title),i=t.src}catch(t){return this.logger.zsymb(18,"-sAOsX",t),!1}n=ho.default.simpleStripVietnamese(a.name)}if(!a.name||ho.default.searchContent(s,n)||ho.default.searchContent(i,n)){let t=!1;if(a.ext&&(t=R.fileExt[a.ext].some((t=>e.message.title.endsWith(t)))),!a.ext||t)return!a.date.start||!a.date.end||(a.date.end<e.sendDttm?e.sendDttm<a.date.start+864e5:(o=!0,!1))}}return!1};let d=[];i&&d.push(this.getImageMediasForward(e,t,s,r,c,l)),n&&d.push(this.getImageMediasBackward(e,t,s,r,c,l));try{const e=await Promise.all(d);if(2===e.length){let t=e[1].reverse();return t.pop(),t=t.concat(e[1]),t}return i?e[0]:e[0].reverse()}catch(u){return this.logger.zsymb(18,"eQuhrS",u),[]}}async getImageMediasForward(e,t,s,i,n,a){let r=[];const{cliMsgId:o,sendDttm:l,msgId:c}=t;if(!(await this._isMigrationDone())){const t={from:[e,c.length,c],to:[e,R.MessageConstants.MAX_MSG_ID.length,R.MessageConstants.MAX_MSG_ID],excludeFrom:!i,excludeTo:!i},o={limit:s,index:"userId_sendDttm_msgId",direction:Le.c.NEXT,predicate:e=>n({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:a,useLGKeyRange:!0};r=await this.getAllInOldDB(t,o)}if(r.length<s){const t={from:[e,l,o],to:[e,parseInt(R.MessageConstants.MAX_SENDDTTM),R.MessageConstants.MAX_MSG_ID],excludeFrom:!i,excludeTo:!i},c={limit:s-r.length,index:"convId_sendDttm_cliMsgId",direction:Le.c.NEXT,predicate:e=>n({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:a,useLGKeyRange:!0};r.push(...await this.getAll(t,c))}return r}async getImageMediasBackward(e,t,s,i,n,a){let r=[];const{cliMsgId:o,sendDttm:l,msgId:c}=t,d={from:[e,0,""],to:[e,l,o],excludeFrom:!i,excludeTo:!i},u={limit:s,index:"convId_sendDttm_cliMsgId",direction:Le.c.PREV,predicate:e=>n({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:a,useLGKeyRange:!0};if(r=await this.getAll(d,u),r.length<s&&!(await this._isMigrationDone())){const t={from:[e,0,""],to:[e,c.length,c],excludeFrom:!i,excludeTo:!i},o={limit:r?s-r.length:s,index:"userId_sendDttm_msgId",direction:Le.c.PREV,predicate:e=>n({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:a,useLGKeyRange:!0};r.push(...await this.getAllInOldDB(t,o))}return r}}const Cy=Object(i.define)("image-media-repository");var Oy,Ey=s("H8Z7");Object(i.injectable)()(Oy=Object(i.singleton)(Cy)(Oy=function(e,t){return Object(i.inject)(zI)(e,void 0,0)}(Oy=function(e,t){return Object(i.inject)(Ey.c)(e,void 0,1)}(Oy=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(Oy=Reflect.metadata("design:type",Function)(Oy=Reflect.metadata("design:paramtypes",[Object,void 0===Ey.IMediaMigrationManager?Object:Ey.IMediaMigrationManager,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Oy=class extends _y{constructor(e,t,s){super("Media","Image","image","crud-image-media",t,s),this.imageMediaMapper=void 0,this.oldDBTable=void 0,this.imageMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Image}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=tt.default.getInstance().Core.Image),this.oldDBTable}getMediaMapper(){return this.imageMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Oy)||Oy)||Oy)||Oy)||Oy)||Oy);class My extends yy{constructor(e,t,s,i,n,a){super(e,t,s,i,n,a)}async getLastestAddedFiles(e,t){if(!e||"number"!=typeof t)throw Error(`[getLastestAddedFiles]: ${JSON.stringify(e)} or ${t} isn't valid!`);const s=await this.getLastestAddedFilesInNewDB(e,t);return s.length<t&&!(await this._isMigrationDone())&&s.push(...await this.getLastestAddedFilesInOldDB({sendDttm:e.sendDttm},t-s.length)),s}async getLastestAddedFilesInNewDB(e,t){const{convId:s,sendDttm:i,cliMsgId:n}=e;return this.dbTable.getAll({from:["",0,0],to:[s,i,n],excludeFrom:!0,excludeTo:!0},{index:"convId_sendDttm_cliMsgId",limit:t,direction:Le.c.PREV})}async getLastestAddedFilesInOldDB(e,t){if(await this._isMigrationDone())return[];const s=await this.getOldDBTable().getAll({from:0,to:e.sendDttm,excludeFrom:!0,excludeTo:!0},{index:"sendDttm",limit:t,direction:Le.c.PREV});return s.length>0?s.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}}const Sy=Object(i.define)("file-media-repository");var Ty;Object(i.injectable)()(Ty=Object(i.singleton)(Sy)(Ty=function(e,t){return Object(i.inject)(GI)(e,void 0,0)}(Ty=function(e,t){return Object(i.inject)(Ey.c)(e,void 0,1)}(Ty=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(Ty=Reflect.metadata("design:type",Function)(Ty=Reflect.metadata("design:paramtypes",[Object,void 0===Ey.IMediaMigrationManager?Object:Ey.IMediaMigrationManager,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Ty=class extends My{constructor(e,t,s){super("Media","File","file","crud-file-media",t,s),this.fileMediaMapper=void 0,this.oldDBTable=void 0,this.fileMediaMapper=e,this.oldDBTable=this._dalInstance.Core.File}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=tt.default.getInstance().Core.File),this.oldDBTable}getMediaMapper(){return this.fileMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Ty)||Ty)||Ty)||Ty)||Ty)||Ty);class wy extends yy{constructor(e,t,s,i,n,a){super(e,t,s,i,n,a)}}const Ry=Object(i.define)("link-media-repository");var Ly;Object(i.injectable)()(Ly=Object(i.singleton)(Ry)(Ly=function(e,t){return Object(i.inject)(VI)(e,void 0,0)}(Ly=function(e,t){return Object(i.inject)(Ey.c)(e,void 0,1)}(Ly=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(Ly=Reflect.metadata("design:type",Function)(Ly=Reflect.metadata("design:paramtypes",[Object,void 0===Ey.IMediaMigrationManager?Object:Ey.IMediaMigrationManager,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Ly=class extends wy{constructor(e,t,s){super("Media","Link","link","crud-link-media",t,s),this.linkMediaMapper=void 0,this.oldDBTable=void 0,this.linkMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Link}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=tt.default.getInstance().Core.Link),this.oldDBTable}getMediaMapper(){return this.linkMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Ly)||Ly)||Ly)||Ly)||Ly)||Ly);const Dy=Object(i.define)("utils-media-repository");class Ay{constructor(e){this._lruCache=void 0,this._lruCache=new he.default(e)}get(e){return this._lruCache.get(e)}getAll(e="ASC"){const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.values(t)}getAllKey(e="ASC"){const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.keys(t)}set(e,t){this._lruCache.set(e,t)}delete(e){return this._lruCache.delete(e)}clear(){this._lruCache.clear()}}var Fy;Object(i.injectable)()(Fy=Object(i.singleton)(Dy)(Fy=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Fy=Reflect.metadata("design:type",Function)(Fy=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Fy=class extends Kh.b{constructor(e){super("Media","UtilsMedia","utils-media-repo",e,"id",KI.b),this._cache=new Ay({maxSize:KI.b})}async isExisted(e){if(!e)return!1;const t=this._cache.get(e);if(!t){const t=await this._dbCollection.get(e);return t&&this._cache.set(e,t),!!t}return!!t}async update(e,t){if(await this._dbCollection.update(e,t)){const t=await this._dbCollection.get(e);if(t)return this._cache.set(e,t),!0}return!1}async updateReturnEntity(e,t){if(await this._dbCollection.update(e,t)){const t=await this._dbCollection.get(e);if(t)return this._cache.set(e,t),t}throw Error(`[update]: cannot update record with id: ${e}`)}async updateMulti(e){const t=await this._dbCollection.updateMulti(e);return t.success.forEach((e=>this._cache.set(e.id,e))),t}getAllSenderIds(e,t=!0){if(!e)throw Error(`[getAllSenderIds]: id: ${e} isn't valid!`);return this._getItemListByField(e,"senderIds",t)}getAllFileTypes(e,t){if(!e)throw Error(`[getAllFileTypes]: id: ${e} isn't valid!`);return this._getItemListByField(e,"fileTypes",t)}saveSender(e,t){if(!e)throw Error(`[saveSender]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"senderIds",t)}saveFileType(e,t){if(!e)throw Error(`[saveFileType]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"fileTypes",t)}saveSenders(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"senderIds",t)}saveFileTypes(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"fileTypes",t)}deleteSender(e,t){if(!e)throw Error(`[deleteSender]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"senderIds",t)}deleteFileType(e,t){if(!e)throw Error(`[deleteFileType]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"fileTypes",t)}deleteSenders(e,t){if(!e)throw Error(`[deleteSenders]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"senderIds",t)}deleteFileTypes(e,t){if(!e)throw Error(`[deleteFileTypes]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"fileTypes",t)}async _saveValueOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){i[t].some((e=>e===s))||(i[t].push(s),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _saveValuesOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const n=s.filter((e=>!i[t].includes(e)));n.length&&(i[t].push(...n),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _deleteValueOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const n=i[t].indexOf(s);-1!==n&&(i[t].splice(n,1),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _deleteValuesByField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const n=i[t].filter((e=>!s.includes(e)));n.length<i[t].length&&(i[t]=n,await this.update(e,{value:{[t]:n},attributes:[t]}))}return!0}async _getItemListByField(e,t,s=!0){var i;const n=this._cache.get(e);var a;if(s)return n&&null!==(a=n[t])&&void 0!==a&&a.length?n[t].slice():[];const r=await this._dbCollection.get(e);return r&&!n&&this._cache.set(e,Object(f.a)({},r)),r&&null!==(i=r[t])&&void 0!==i&&i.length?r[t].slice():[]}})||Fy)||Fy)||Fy)||Fy);const jy=Object(i.define)("media-mapper-factory");var Py;Object(i.injectable)()(Py=Object(i.singleton)(jy)(Py=class{getMediaMapper(e){switch(e){case"image":return i.ModuleContainer.resolve(zI);case"file":return i.ModuleContainer.resolve(GI);case"link":return i.ModuleContainer.resolve(VI);default:return}}})||Py);const ky=Object(i.define)("media-repository-factory");var Ny;Object(i.injectable)()(Ny=Object(i.singleton)(ky)(Ny=class{getMediaRepository(e){switch(e){case"image":return i.ModuleContainer.resolve(Cy);case"link":return i.ModuleContainer.resolve(Ry);case"file":return i.ModuleContainer.resolve(Sy);default:return}}})||Ny);const Uy="utils-media-domain-service",By=Object(i.define)(Uy);var xy,Gy=s("5txd");Object(i.injectable)()(xy=Object(i.singleton)(By)(xy=function(e,t){return Object(i.inject)(Dy)(e,void 0,0)}(xy=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(xy=Reflect.metadata("design:type",Function)(xy=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(xy=class{constructor(e,t){this._log=void 0,this._logger=void 0,this._utilsMediaRepository=void 0,this._utilsMediaRepository=e,this._logger=t.createZLogger(`${Uy}`,["mn-utils-media-de"]),this._log=Object(Gy.b)(this._logger)}async create(e){if(!e)throw Error(`utilsMedia(${e}) isn't existed!`);if(!e.convId||!e.mediaType)throw Error(`cannot create utilsMedia with convId(${e.convId}) and mediaType(${e.mediaType})`);if(await this._utilsMediaRepository.isExisted(`${e.convId}_${e.mediaType}`))throw this._log("[create]",`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`,"info"),Error(`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`);return{id:`${e.convId}_${e.mediaType}`,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds||[],fileTypes:e.fileTypes||[]}}addSenders(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(f.a)({},e);return Object(f.a)(Object(f.a)({},e),{},{senderIds:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.senderIds]||!1)})}addFileTypes(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(f.a)({},e);const s=Object(f.a)(Object(f.a)({},e),{},{fileTypes:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.fileTypes]||!1)});return s}})||xy)||xy)||xy)||xy)||xy);const zy="utils-media-app-service",Vy=Object(i.define)(zy);var Hy;Object(i.injectable)()(Hy=Object(i.singleton)(Vy)(Hy=function(e,t){return Object(i.inject)(By)(e,void 0,0)}(Hy=function(e,t){return Object(i.inject)(Dy)(e,void 0,1)}(Hy=function(e,t){return Object(i.inject)(xI)(e,void 0,2)}(Hy=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,3)}(Hy=Reflect.metadata("design:type",Function)(Hy=Reflect.metadata("design:paramtypes",[Object,Object,Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Hy=class{constructor(e,t,s,i){this._utilsMediaDomainService=void 0,this._utilsMediaRepository=void 0,this._mapper=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaDomainService=e,this._utilsMediaRepository=t,this._mapper=s,this._logger=i.createZLogger(zy,["manage-utils-media-in-app"]),this._log=Object(Gy.b)(this._logger)}async create(e){try{const t=await this._utilsMediaDomainService.create(e);return this._mapper.toUtilsMediaDTOFromDomain(await this._utilsMediaRepository.insert(t))}catch(t){return void this._log("[create]",t.message)}}async createOrUpdate(e){try{const t=`${e.convId}_${e.mediaType}`;let s=await this._utilsMediaRepository.get(t);if(s){const{senderIds:i,fileTypes:n}=e;let a=s.senderIds,r=s.fileTypes;if(i&&i.length&&(a=this._utilsMediaDomainService.addSenders(s,i).senderIds),n&&n.length&&(r=this._utilsMediaDomainService.addFileTypes(s,n).fileTypes),a.length!==s.senderIds.length||r.length!==s.fileTypes.length){const e=await this._utilsMediaRepository.updateReturnEntity(t,{value:{senderIds:a,fileTypes:r},attributes:["senderIds","fileTypes"]});return this._mapper.toUtilsMediaDTOFromDomain(e)}return this._mapper.toUtilsMediaDTOFromDomain(s)}return this.create(e)}catch(t){return void this._log("[createOrUpdate]",t.message)}}async deleteUtilsMediasByConvId(e){try{if(!e)return[];const t=Object.values(KI.e).map((t=>`${e}_${t}`));return(await this._utilsMediaRepository.deleteMulti(t)).success}catch(t){return this._log("[deleteUtilsMediasByConvId]",t.message),[]}}async createOrUpdateFromMedias(e){try{if(!e||!e.length)return[];const t=new Map;e.forEach((e=>{let s=t.get(e.convId);if("image"===e.mediaType||"link"===e.mediaType)if(s){-1===s.senderIds.indexOf(e.fromUid)&&(s.senderIds.push(e.fromUid),t.set(e.convId,s))}else s={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[]},t.set(e.convId,s);else if("file"===e.mediaType){const i=this._getFileType(e.content.params);if(s){-1===s.fileTypes.indexOf(i)&&(s.fileTypes.push(i),t.set(e.convId,s))}else s={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[i]},t.set(e.convId,s)}}));const s=Array.from(t.values());return(await Promise.all(s.map((e=>this.createOrUpdate(e))))).filter(Boolean)}catch(t){return this._log("[createOrUpdateFromMedias]",t.message),[]}}_getFileType(e){try{const t=JSON.parse(e);if(!t)throw Error(`paramsObj is ${t}!`);const{fileExt:s,fType:i}=t;return"zip"===s&&2===i?"folder":s.toLowerCase()}catch(t){return this._log("[_getFileType]",t.message),""}}})||Hy)||Hy)||Hy)||Hy)||Hy)||Hy)||Hy);const Wy=Object(i.define)("media-migration-state-persist");var $y;Object(i.injectable)()($y=Object(i.singleton)(Wy)($y=class{constructor(){this._localStorage=E.default.getInstance()}async saveMigrationState(e){e&&await this._localStorage.setItemForCurrentUserAsync(Iy,JSON.stringify(e))}async getMigrationState(){try{const e=await this._localStorage.getItemForCurrentUserAsync(Iy);return e?JSON.parse(e):{stateName:cy,mediaTableNamesToMigrate:[]}}catch(e){return{stateName:cy,mediaTableNamesToMigrate:[]}}}async saveJobDescSummaries(e){Array.isArray(e)&&await this._localStorage.setItemForCurrentUserAsync(by,JSON.stringify(e))}async getSavedJobDescSummaries(){try{const e=await this._localStorage.getItemForCurrentUserAsync(by);if(!e)return[];return JSON.parse(e)}catch(e){return[]}}async clearPersistedJobDescSummaries(){await this._localStorage.removeItemForCurrentUserAsync(by)}})||$y);var Ky=s("mH7l"),qy=s.n(Ky);const Qy=e=>"GET_FROM_OLD_DB"===e.name,Zy=e=>"ADD_TO_NEW_DB"===e.name,Jy=e=>"DELETE_FROM_OLD_DB"===e.name;function Yy(){return mi.default.media_migration_db.should_stop_migration}function Xy(){return mi.default.media_migration_db.max_running_concurrency_job}function e_(){return mi.default.media_migration_db.delay_time_per_job}function t_(){return mi.default.media_migration_db.delay_time_each_k_jobs}function s_(){return mi.default.media_migration_db.media_limit_per_job}function i_(){return mi.default.media_migration_db.min_retry_after}function n_(){return mi.default.media_migration_db.max_retry_after}var a_=s("1erv");const r_={MAX_RETRY:0,INVALID_CONFIG_JITTER:1,INVALID_CONFIG_MIN:2,TIMEOUT:3,RETRY_ON_ERROR_CONDITION_FAIL:4};class o_ extends Error{constructor(e){super(`ExpBackoff error:${e}`),this.code=e}}function l_({step:e,nTry:t,jitter:s,min:i,max:n}){let a=i*Math.pow(e,t);if(s){const e=Math.random(),t=Math.floor(e*s*a);a=1&Math.floor(10*e)?a+t:a-t}return 0|Math.min(a,n)}function c_(e,t){return async function(...s){for await(const{sleep:n,duration:a,nTry:r}of function*(e){var t,s,i,n,a;const r=null!==(t=null==e?void 0:e.retries)&&void 0!==t?t:3,o=null!==(s=null==e?void 0:e.min)&&void 0!==s?s:100,l=null!==(i=null==e?void 0:e.max)&&void 0!==i?i:1e4,c=null!==(n=null==e?void 0:e.step)&&void 0!==n?n:2,d=null!==(a=null==e?void 0:e.jitter)&&void 0!==a?a:0;if(o<=0)throw new o_(r_.INVALID_CONFIG_MIN);if(d<0||d>1)throw new o_(r_.INVALID_CONFIG_JITTER);let u=0;for(;u<=r;){const e=l_({nTry:u,step:c,jitter:d,min:o,max:l});yield{nTry:u,duration:e,sleep:()=>new Promise((t=>{setTimeout(t,e)}))},u++}}(t))try{const i=await e(...s);return null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:r,duration:a,sleep:n,success:!0,shouldRetry:!1})),i}catch(i){const e=null!=t&&t.shouldRetryOnError?null==t?void 0:t.shouldRetryOnError:()=>Promise.resolve(!0),o=await e({error:i,currentState:{nTry:r,duration:a,sleep:n},input:s});if(null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:r,duration:a,sleep:n,shouldRetry:o,success:!1})),!o)throw new o_(r_.RETRY_ON_ERROR_CONDITION_FAIL);await n()}throw new o_(r_.MAX_RETRY)}}var d_;const u_=new xi.a,h_=999999,g_=1/0;Object(Je.d)()(d_=Object(i.injectable)()(d_=Object(i.singleton)(Ey.c)(d_=function(e,t){return Object(i.inject)(Wy)(e,void 0,0)}(d_=function(e,t){return Object(i.inject)(Je.a)(e,void 0,1)}(d_=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(d_=Reflect.metadata("design:type",Function)(d_=Reflect.metadata("design:paramtypes",[Object,void 0===Je.a?Object:Je.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(d_=class{constructor(e,t,s){this._isLoadData=!1,this._forceStop=!1,this._mediaMigrationStatePersist=void 0,this._maxWorkerPoolNum=Xy(),this._worker=new qy.a({concurrency:this._maxWorkerPoolNum,autoStart:!1}),this._delayTimePerJob=e_(),this._delayTimeEachKJobs=t_(),this._mediaNumLimitPerJob=s_(),this._minRetryAfter=i_(),this._maxRetryAfter=n_(),this._currentJobDescs=[],this._currentJobHolders=[],this._currentMsgIdCursor=R.MessageConstants.MAX_MSG_ID,this._mediaMigrationState=void 0,this._failedGetJob=!1,this._failedAddJob=!1,this._failedDeleteJob=!1,this._hasDBError=!1,this._logger=void 0,this._application=void 0,this._mediaMigrationStatePersist=e,this._onApplicationIdle=this._onApplicationIdle.bind(this),this._onApplicationActive=this._onApplicationActive.bind(this),this._onApplicationExit=this._onApplicationExit.bind(this),this._application=t,this._logger=s.createZLogger(Ey.b,["manage-media-migration"])}onApplicationReady(e){this._listenEvents(),this._isLoadData||this._loadData().then((()=>{this._runMigration()})),this.toggleDBError(this._getTestMediaMigrationFlag("[mm]:db_error")),this.toggleGetJobFailed(this._getTestMediaMigrationFlag("[mm]:get_failed")),this.toggleAddJobFailed(this._getTestMediaMigrationFlag("[mm]:add_failed")),this.toggleDeleteJobFailed(this._getTestMediaMigrationFlag("[mm]:delete_failed"))}async getMediaMigrationState(){if(!Object(a_.a)()||Yy())return{stateName:cy,mediaTableNamesToMigrate:[]};if(!this._mediaMigrationState){const{stateName:e,remainingTableNames:t}=await this._statsMediaMigration();this._mediaMigrationState={stateName:e,mediaTableNamesToMigrate:t}}return this._mediaMigrationState}pauseMigration(e){this._logger.zsymb(3,"pXtuaJ",["[mm] pause migration - reason: {}","RBJn-z"],e),this.flushHoldingJobs(),this._forceStop=!0,this._worker.pause()}async resumeMigration(e){this._logger.zsymb(3,"xnRVgU",["[mm] resume migration - reason: {}","6UspUC"],e),this._forceStop=!1,Object(a_.a)()&&!Yy()&&(this._isLoadData||await this._loadData(),this._currentJobDescs.forEach((e=>{if(e.state===vy){e.state=py;const t=this._createJob(e);if(t){const s=this._scheduleJob(e.id,t);this._worker.add(s,{priority:h_})}}})),this._worker.size>0?this._worker.isPaused&&this._worker.start():this._runMigration())}flushHoldingJobs(){this._currentJobHolders.forEach((e=>{clearTimeout(e.timeoutId),e.resolver()})),this._currentJobHolders=[]}toggleGetJobFailed(e){this._failedGetJob=e}toggleAddJobFailed(e){this._failedAddJob=e}toggleDeleteJobFailed(e){this._failedDeleteJob=e}toggleDBError(e){this._hasDBError=e}_createJob(e){const{id:t,currentStep:s}=e;return this._updateStateOfCurrentJobByJobId(t,fy),Qy(s)?this._createJobFromGetFromOldDBCurrentStep(t,s):Zy(s)?this._createJobFromAddToNewDBCurrentStep(t,s):Jy(s)?this._createJobFromDeleteFromOldDBCurrentStep(t,s):void 0}_createJobFromGetFromOldDBCurrentStep(e,t){const s=Object(f.a)({},t),{mediaTableName:i,amount:n,lastMsgId:a}=s.dataToRun;return async()=>{try{await this._withRetry((async()=>{const t=this._createStep(s);if(!t)return void this._logger.zsymb(21,"R_UjFg",["[mm] getFromOldDBStep is undefined!","PhZkyi"]);let r=await t();if(r.state===my)throw r.data.jobId=e,r.data.jobType="GET_FROM_OLD_DB",r.data;const{data:o}=r;if(this._logger.zsymb(3,"2PJZfJ",["[mm] getFromOldDBStep - DONE - jobId: {}, {}","YGKyY5"],e,o.length),o.length>=n?this._currentMsgIdCursor=o[o.length-1].msgId:this._mediaMigrationState&&this._mediaMigrationState.mediaTableNamesToMigrate.length&&(this._mediaMigrationState.mediaTableNamesToMigrate.shift(),this._currentMsgIdCursor=R.MessageConstants.MAX_MSG_ID),this._runMigration(),o.length){const t={name:uy,dataToRun:{mediaTableName:i,amount:n,lastMsgId:a,data:o}};this._updateCurrentStepByJobId(e,t);const s=this._createJobFromAddToNewDBCurrentStep(e,t);await s()}}))()}catch(t){this._logger.zsymb(3,"NqIL9s",["[mm] throw error from get from old DB step - jobId: {}, {}","pj7Pc5"],e,null==t?void 0:t.message)}}}_createJobFromAddToNewDBCurrentStep(e,t){const s=Object(f.a)({},t),{mediaTableName:i,amount:n,lastMsgId:a}=s.dataToRun;return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const s=this._createStep(t);if(!s)return void this._logger.zsymb(18,"D4RKoR","[mm] addToNewDBStep is undefined!");const r=await s();if(r.state===my)throw r.data.jobId=e,r.data.jobType="ADD_TO_NEW_DB",r.data;const{data:o}=r;if(this._logger.zsymb(3,"1GcCQH",["[mm] addToNewDBStep - jobId: {}, {}","MEDEdC"],e,o.length),o.length){const t={name:hy,dataToRun:{mediaTableName:i,amount:n,lastMsgId:a,data:o}};this._updateCurrentStepByJobId(e,t);const s=this._createJobFromDeleteFromOldDBCurrentStep(e,t);await s()}}))()}catch(s){this._logger.zsymb(3,"G86yEr",["[mm] throw error from add to new DB step - jobId: {}, {}","qOSDUl"],e,null==s?void 0:s.message)}}}_createJobFromDeleteFromOldDBCurrentStep(e,t){const s=Object(f.a)({},t);return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const t=this._createStep(s);if(!t)return void this._logger.zsymb(21,"4MJZh9",["[mm] deleteFromOldDBStep is undefined!","j_gQ1A"]);const i=await t();if(i.state===my)throw i.data.jobId=e,i.data.jobType="DELETE_FROM_OLD_DB",i.data;this._logger.zsymb(3,"JzBv3T",["[mm] deleteFromOldDBStep - DONE - jobId: {}","rblg7S"],e),this._currentJobDescs=this._currentJobDescs.filter((t=>t.id!==e)),this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),this._persistCurrentJobDescs()}))()}catch(t){this._logger.zsymb(3,"OTEB2O",["[mm] throw error from delete from old DB step - jobId: {} - err: {}","xvy0PN"],e,null==t?void 0:t.message)}}}_updateCurrentStepByJobId(e,t){const s=this._currentJobDescs.find((t=>t.id===e));s&&(s.currentStep=t)}_updateStateOfCurrentJobByJobId(e,t){const s=this._currentJobDescs.find((t=>t.id===e));s&&(s.state=t)}async _persistCurrentJobDescs(){await this._mediaMigrationStatePersist.saveJobDescSummaries(this._currentJobDescs.reduce(((e,t)=>(t.currentStep.name!==dy&&e.push(this._toJobDescSummary(t)),e)),[]))}_createStep(e){return Qy(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedGetJob)throw Error("[SIMULATE]: Failed to get job from old DB!");const{mediaTableName:t,amount:s,lastMsgId:n}=e.dataToRun,a=t,r=i.ModuleContainer.resolve(Ui.a),o=await r.getMediasFromOldDB(a,s,n);return{state:gy,data:o}}catch(t){return this._logger.zsymb(21,"20Hhmf",["[mm] get from old db step err: {}","KicFAi"],null==t?void 0:t.message),{state:my,data:t}}}:Zy(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedAddJob)throw Error("[SIMULATE]: Failed to add job to new DB!");let{mediaTableName:t,data:s,lastMsgId:n,amount:a}=e.dataToRun;const r=t,o=i.ModuleContainer.resolve(Ui.a);let l=s;l||(l=await o.getMediasFromOldDB(r,a,n));const c=await o.addMediasFromOldDB(r,l);return{state:gy,data:c}}catch(t){return this._logger.zsymb(21,"F5MblU",["[mm] add to new db step err: {}","ZLMLmk"],null==t?void 0:t.message),{state:my,data:t}}}:Jy(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedDeleteJob)throw Error("[SIMULATE]: Failed to delete job from old DB!");const{mediaTableName:t,data:s,lastMsgId:n,amount:a}=e.dataToRun,r=t,o=i.ModuleContainer.resolve(Ui.a);return s?{state:gy,data:await o.deleteMediasFromOldDB(r,s)}:{state:gy,data:await o.deleteMediasFromOldDBByRange(r,a,n)}}catch(t){return this._logger.zsymb(21,"Ja_m-M",["[mm] delete from old db step err: {}","2dGokO"],null==t?void 0:t.message),{state:my,data:t}}}:void 0}async _loadData(){if(Yy()||!Object(a_.a)())return;const e=await this.getMediaMigrationState();this._logger.zsymb(3,"Spg2dc",["[mm] MEDIA MIGRATION STATE after load data: {}","B27TQV"],e.stateName),this._mediaMigrationState=e;const t=await this._mediaMigrationStatePersist.getSavedJobDescSummaries();t.length>0&&t.forEach((e=>{const t=this._toJobDesc(e);this._currentJobDescs.push(t);const s=this._createJob(t);if(s){const e=this._scheduleJob(t.id,s);this._worker.add(e,{priority:h_})}})),this._isLoadData=!0}async _statsMediaMigration(){const e=i.ModuleContainer.resolve(Ui.a),t=await Promise.all([e.countTotalMediaInOldDB("image"),e.countTotalMediaInOldDB("file"),e.countTotalMediaInOldDB("link")]);let s=ly,n=[];return s=t.reduce(((e,t,s)=>(0===s&&t>0?n.push("image"):1===s&&t>0?n.push("file"):2===s&&t>0&&n.push("link"),e+t)),0)>0?ly:oy,{stateName:s,remainingTableNames:n}}async _runMigration(){if(this._logger.zsymb(0,"DAHanI","[mm] ====================RUN MIGRATION===================="),!Object(a_.a)())return void this._logger.zsymb(0,"_PMidV","[mm] ==========STOP MIGRATION: not use new media DB flow (cfsv)==========");if(Yy())return void this._logger.zsymb(0,"iuVaEm","[mm] ==========STOP MIGRATION: stop migration (cfsv)==========");if(this._forceStop)return void this._logger.zsymb(0,"7LIPAK","[mm] ==========STOP MIGRATION: force stop (in app)==========");if(!this._isLoadData&&(await this._loadData(),!this._isLoadData))return;if(this._mediaMigrationState.stateName===oy)return void this._logger.zsymb(0,"BuOWCq","[mm] ==========STOP MIGRATION: migration done==========");const e=this._mediaMigrationState.mediaTableNamesToMigrate.length>0?this._mediaMigrationState.mediaTableNamesToMigrate[0]:"";if(!e){if(!this._currentJobDescs.length)return this._logger.zsymb(0,"UtlEQO","[mm] ==========STOP MIGRATION: no media table to migrate=========="),this._stopListenEvents(),void(await this._mediaMigrationStatePersist.clearPersistedJobDescSummaries());this._logger.zsymb(0,"7TeQIH","[mm] ==========STOP MIGRATION: no media table to migrate, but still have running jobs==========")}if(this._logger.zsymb(3,"aqq2zW",["[mm] worker pending: ","I5dBUZ"],this._worker.pending),this._logger.zsymb(3,"ZpE8UG",["[mm] worker size: ","8nnjLt"],this._worker.size),e){if(u_.value%this._maxWorkerPoolNum==0&&(await this._waitIn(this._delayTimeEachKJobs),this._forceStop||!Object(a_.a)()||Yy()))return;const t={id:u_.next(),state:py,currentStep:{name:dy,dataToRun:{mediaTableName:e,amount:this._mediaNumLimitPerJob,lastMsgId:this._currentMsgIdCursor}}},s=this._createJob(t);if(s){this._currentJobDescs.push(t);const e=this._scheduleJob(t.id,s);this._worker.add(e)}}else if(!this._currentJobDescs.length)return;this._worker.isPaused&&this._worker.start()}_listenEvents(){this._application.addEventListener(Je.b.Idle,this._onApplicationIdle),this._application.addEventListener(Je.b.Active,this._onApplicationActive),this._application.addEventListener(Je.b.Exit,this._onApplicationExit)}_stopListenEvents(){this._application.removeEventListener(Je.b.Idle,this._onApplicationIdle),this._application.removeEventListener(Je.b.Active,this._onApplicationActive),this._application.removeEventListener(Je.b.Exit,this._onApplicationExit)}_onApplicationIdle(){this._setupMigrationConfig({maxWorkerPoolNum:Xy(),mediaNumLimitPerJob:s_(),delayTimePerJob:e_(),delayTimeEachKJobs:t_(),minRetryAfter:i_(),maxRetryAfter:n_()})}_onApplicationActive(){this._setupMigrationConfig({maxWorkerPoolNum:Xy(),mediaNumLimitPerJob:s_(),delayTimePerJob:e_(),delayTimeEachKJobs:t_(),minRetryAfter:i_(),maxRetryAfter:n_()})}_onApplicationExit(){this.pauseMigration("EXIT_APP")}_toJobDescSummary(e){const{currentStep:t}=e;return{currentStep:{name:t.name,summaryData:{mediaTableName:t.dataToRun.mediaTableName,amount:t.dataToRun.amount,lastMsgId:t.dataToRun.lastMsgId}}}}_toJobDesc(e){let{currentStep:t}=e;return{id:u_.next(),state:py,currentStep:{name:t.name,dataToRun:Object(f.a)(Object(f.a)({},t.summaryData),{},{data:void 0})}}}_setupMigrationConfig(e){"number"==typeof e.maxWorkerPoolNum&&(this._worker.concurrency=e.maxWorkerPoolNum),"number"==typeof e.mediaNumLimitPerJob&&(this._mediaNumLimitPerJob=e.mediaNumLimitPerJob),"number"==typeof e.delayTimePerJob&&(this._delayTimePerJob=e.delayTimePerJob),"number"==typeof e.delayTimeEachKJobs&&(this._delayTimeEachKJobs=e.delayTimeEachKJobs),"number"==typeof e.minRetryAfter&&(this._minRetryAfter=e.minRetryAfter),"number"==typeof e.maxRetryAfter&&(this._maxRetryAfter=e.maxRetryAfter)}_scheduleJob(e,t){return async()=>new Promise((t=>{const s=setTimeout((()=>{this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),t()}),1e3*this._delayTimePerJob);this._currentJobHolders.push({jobId:e,timeoutId:s,resolver:t})})).then((()=>t()))}_withRetry(e){return c_(e,{retries:g_,min:1e3*this._minRetryAfter,max:1e3*this._maxRetryAfter,shouldRetryOnError:async({error:e,currentState:t})=>this._forceStop||Yy()||!Object(a_.a)()?(this._updateStateOfCurrentJobByJobId(e.jobId,vy),!1):"UnknownError"===e.name||"QuotaExceededError"===e.name||22===e.code?(this._updateStateOfCurrentJobByJobId(e.jobId,vy),this.pauseMigration("DB_ERROR"),!1):(this._logger.zsymb(21,"bpnk41",["[mm]: Retry - jobId: {} - jobType: {} - error: {}","YPaLA6"],e.jobId,e.jobType,e.message),!0)})}async _waitIn(e){return this._logger.zsymb(3,"NpeRQv",["[mm]: waiting in {} seconds","5QwqbF"],e),new Promise((t=>{setTimeout(t,1e3*e)}))}_getTestMediaMigrationFlag(e){const t=E.default.getInstance().getItemForCurrentUser(e);try{return!!t&&JSON.parse(t)}catch(s){return!1}}_throwDBError(){const e=new Error("[SIMULATE]: DB is corrupted or quota is exceeded!");throw e.name="UnknownError",e.code=22,e}})||d_)||d_)||d_)||d_)||d_)||d_)||d_);var m_,p_=s("zLd2");Object(i.injectable)()(m_=Object(i.singleton)(p_.c)(m_=function(e,t){return Object(i.inject)(Vy)(e,void 0,0)}(m_=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(m_=Reflect.metadata("design:type",Function)(m_=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(m_=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,Co.a.ConvInfoDataManager.addEventListener(so.b.DeleteConv,this._onDeleteConversation.bind(this)),Co.a.ConvInfoDataManager.addEventListener(so.b.EmptyConv,this._onEmptyConversation.bind(this)),this._logger=t.createZLogger(p_.b,["manage-utils-media-in-ui"]),this._log=Object(Gy.b)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}_onDeleteConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}_onEmptyConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}})||m_)||m_)||m_)||m_)||m_);var f_,v_=s("Mlp7");Object(i.injectable)()(f_=Object(i.singleton)(Ui.a)(f_=function(e,t){return Object(i.inject)(p_.c)(e,void 0,0)}(f_=function(e,t){return Object(i.inject)(ky)(e,void 0,1)}(f_=function(e,t){return Object(i.inject)(jy)(e,void 0,2)}(f_=function(e,t){return Object(i.inject)(NI)(e,void 0,3)}(f_=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,4)}(f_=Reflect.metadata("design:type",Function)(f_=Reflect.metadata("design:paramtypes",[void 0===p_.IUtilsMediaManager?Object:p_.IUtilsMediaManager,Object,Object,Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(f_=class{constructor(e,t,s,i,n){this._utilsMediaManager=void 0,this._mediaMapperFactory=void 0,this._mediaRepositoryFactory=void 0,this._mediaPrimaryKeyConvertor=void 0,this._logger=void 0,this._utilsMediaManager=e,this._mediaRepositoryFactory=t,this._mediaMapperFactory=s,this._mediaPrimaryKeyConvertor=i,this._logger=n.createZLogger("media-manager",[""])}filter(e,t){return Object(a_.a)()?yy.filterMedia(e,t):v_.a.filter(e,t)}getMediaRepository(e,t=!0){const s=this._mediaRepositoryFactory.getMediaRepository(e);if(!s&&t)throw Error(`[getMediaRepository]: can't get mediaRepository has mediaType: ${e}!`);return s}getMediaMapper(e,t=!0){const s=this._mediaMapperFactory.getMediaMapper(e);if(!s&&t)throw Error(`[getMediaMapper]: can't get mediaMapper has mediaType: ${e}!`);return s}async _isMigrationDone(){return(await i.ModuleContainer.resolve(Ey.c).getMediaMigrationState()).stateName===oy}async isExistedMedia(e,t){try{if(!e)throw Error("mediaType is invalid!");if(!t)throw Error("mediaIdObj is invalid!");const s=this.getMediaRepository(e);return await s.isExistedMedia({newId:t.newId||"",oldId:t.oldId||""})}catch(i){var s;const e=[null==i||null===(s=i.toString)||void 0===s?void 0:s.call(i),null==i?void 0:i.stack].join("\n");return this._logger.zsymb(21,"cN8dD0",["[isExistedMedia] - error: {}","Zv9Lze"],e),!1}}async addMedias(e,t,s=`${KI.c.UNKNOWN}${KI.d.UNKNOWN}`){try{if(!e)throw Error("mediaType is undefined!");if(!t||!t.length)return;const i=this.getMediaRepository(e),n=this.getMediaMapper(e),a=t.map((t=>(t.src=s,"image"===e&&(t.subType=R.MSG_SUBTYPE_MEDIA_DOODLE),n.toDomainFromDTO(t)))),r=(await i.insertMulti(a)).success.map((t=>this.getMediaMapper(e).toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(t)));await this._utilsMediaManager.createOrUpdateFromMedias(r)}catch(n){var i;const e=[null==n||null===(i=n.toString)||void 0===i?void 0:i.call(n),null==n?void 0:n.stack].join("\n");this._logger.zsymb(21,"OQJCjB",["[addMedias] - error: {}","LI88X1"],e)}}addMediaToConvOnly(e,t=`${KI.c.UNKNOWN}${KI.d.UNKNOWN}`){var s,i,n;if(!Object(a_.a)())return v_.a.addMediaToConversationOnly(e);let a=[];if(null!=e&&null!==(s=e.image)&&void 0!==s&&s.length){const s=this.getMediaRepository("image"),i=this.getMediaMapper("image");a.push(null==s?void 0:s.insertMulti(e.image.map((e=>(e.src=t,i.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(i=e.link)&&void 0!==i&&i.length){const s=this.getMediaRepository("link"),i=this.getMediaMapper("link");a.push(null==s?void 0:s.insertMulti(e.link.map((e=>{e.src=t;return i.toDomainFromDTO(e)}))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(n=e.file)&&void 0!==n&&n.length){const s=this.getMediaRepository("file"),i=this.getMediaMapper("file");a.push(s.insertMulti(e.file.map((e=>(e.src=t,i.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}return Promise.all(a)}async deleteMediasById(e,t,s){try{if(!s)throw Error("mediaIdObjs is undefined!");const o=Array.isArray(s)?[...s]:[s];for(const e of o){const{newId:s,oldId:i}=e;if(!s&&i){const s=await this.getMediaFieldsByMsgId(t,i);e.newId=s?`${s.cliMsgId}_${s.fromUid}_${s.toUid}`:""}}const l=this.getMediaRepository(e,!1),c=[];for(const e of o)c.push(Object(f.a)(Object(f.a)({},e),{},{deleteTo:await this._isMigrationDone()?ry.NEW:ry.UNKNOWN}));if(l)await l.deleteMultiMedias(c);else{var n,a,r;const e=[];e.push(null===(n=i.ModuleContainer.resolve(Cy))||void 0===n?void 0:n.deleteMultiMedias(c),null===(a=i.ModuleContainer.resolve(Sy))||void 0===a?void 0:a.deleteMultiMedias(c),null===(r=i.ModuleContainer.resolve(Ry))||void 0===r?void 0:r.deleteMultiMedias(c)),await Promise.all(e)}}catch(l){var o;const e=[null==l||null===(o=l.toString)||void 0===o?void 0:o.call(l),null==l?void 0:l.stack].join("\n");this._logger.zsymb(21,"tWs127",["[deleteMediasById] - error: {}","57EUNG"],e)}}async getValidMediasOfConv(e,t,s,i,n,a){try{if(!t)return Promise.resolve([]);const r=Sr.a.now(),o={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM),msgId:i||R.MessageConstants.MAX_MSG_ID};if(null!=a&&a.lastItemOpts)o.cliMsgId=a.lastItemOpts.cliMsgId,o.sendDttm=a.lastItemOpts.sendDttm;else if(i){const e=await this.getMediaFieldsByMsgId(t,i);e&&(o.cliMsgId=e.cliMsgId,o.sendDttm=e.sendDttm)}const l=v_.a.getLastDeleteConv(t,e),c=this.getMediaRepository(e);let d="image"===e?50:s;const u=await c.getMediasOfConv(t,o,d,Object(f.a)(Object(f.a)({},n),{},{deletePointOfConv:l}));if(!u.length)return[];const h=this.getMediaMapper(e);let g=await Promise.all(u.map((e=>h.toDTO(e))));return this._trackDBPerformance({executionTime:Sr.a.now()-r,actionName:"getByConv",mediaType:e,resultSize:g.length}),"image"===e&&(g=Object(Gy.c)(g)),g}catch(o){var r;const e=[null==o||null===(r=o.toString)||void 0===r?void 0:r.call(o),null==o?void 0:o.stack].join("\n");return this._logger.zsymb(21,"yoyJny",["[getValidMediasOfConv] - error: {}","E0jI-h"],e),Promise.resolve([])}}async getLastMediasOfConvWithoutCorrectData(e,t,s,i=100,n){if(!Object(a_.a)())return v_.a.getLastMediaFromConversation(t,e,i,s);try{if(!t)return Promise.resolve([null,Error("convId is undefined!")]);const a={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM),msgId:s||mi.default.load_media.use_max_id||R.MessageConstants.MAX_MSG_ID};if(null!=n&&n.lastItemOpts)a.cliMsgId=n.lastItemOpts.cliMsgId,a.sendDttm=n.lastItemOpts.sendDttm;else if(s){const e=await this.getMediaFieldsByMsgId(t,s);e&&(a.cliMsgId=e.cliMsgId,a.sendDttm=e.sendDttm)}const r=this.getMediaRepository(e),o=await r.getLastMediasOfConv(t,a,i);return[await Promise.all(o.map((t=>this.getMediaMapper(e).toDTO(t)))),null]}catch(r){var a;const e=[null==r||null===(a=r.toString)||void 0===a?void 0:a.call(r),null==r?void 0:r.stack].join("\n");return this._logger.zsymb(21,"TZxauj",["[getLastMediasOfConvWithoutCorrectData] - error: {}","EhnfBz"],e),[null,r]}}async updateMedia(e,t,s,i,n){if(!Object(a_.a)()){const t=Object(f.a)(Object(f.a)({},i),{},{msgId:s});return v_.a.updateMedia(t,e,n)}return this._updateMedia(e,t,s,i,n)}async countMediaOfConv(e,t,s){try{t||Promise.resolve({ok:!0,result:0,error:null});const{from:i,to:n}=s;i.cliMsgId=i.cliMsgId?i.cliMsgId:"",i.sendDttm=i.sendDttm?i.sendDttm:0,i.msgId=i.msgId?i.msgId:"",n.cliMsgId=n.cliMsgId?n.cliMsgId:R.MessageConstants.MAX_MSG_ID,n.sendDttm=n.sendDttm?n.sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM),n.msgId=n.msgId?n.msgId:R.MessageConstants.MAX_MSG_ID;const a=this.getMediaRepository(e);return{ok:!0,result:await a.countMediaOfConv(t,{from:Object(f.a)({},i),to:Object(f.a)({},n)}),error:null}}catch(n){var i;const e=[null==n||null===(i=n.toString)||void 0===i?void 0:i.call(n),null==n?void 0:n.stack].join("\n");return this._logger.zsymb(21,"UzSyC3",["[countMediaOfConv] - error: {}","iSAvv4"],e),{ok:!1,result:0,error:n}}}async getMediaFieldsByMsgId(e,t){if(!t)return Promise.resolve(void 0);const s=await tt.default.getInstance().Core.Message.get(t,{partition:e});return s?{cliMsgId:"number"==typeof s.cliMsgId?s.cliMsgId.toString():s.cliMsgId,fromUid:s.fromUid,toUid:s.toUid,sendDttm:"string"==typeof s.sendDttm?parseInt(s.sendDttm):s.sendDttm}:Promise.resolve(void 0)}async getAllValidPhotoAndVideosOfConv(e){if(!Object(a_.a)())return v_.a.getAllMediaFromConv(e);let t=!0,s={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM)},i=R.MessageConstants.MAX_MSG_ID,n="",a=[],r=[];for(;t;){const o=await this.getValidMediasOfConv("image",e,50,i,{},{lastItemOpts:{cliMsgId:s.cliMsgId,sendDttm:s.sendDttm}});t=o.length>=50;let l=s,c=n,d=i;if(o.length){if(o.forEach((e=>{e&&e.subType==R.MSG_SUBTYPE_MEDIA_VIDEO?a.push(e):!e||e.subType!=R.MSG_SUBTYPE_PHOTO&&e.subType!==R.MSG_SUBTYPE_MEDIA_DOODLE||r.push(e)})),l={cliMsgId:o[o.length-1].cliMsgId,sendDttm:o[o.length-1].sendDttm},d=o[o.length-1].msgId,c=o[o.length-1].mediaId,d&&i&&d==i||c&&n&&c==n)break;s=l,n=c,i=d}}return{photos:r,videos:a}}async getAllValidPhotoAndVideosOfConvV2(e){if(!Object(a_.a)())return v_.a.getAllMediaFromConv(e);let t=[],s=[];const i=Sr.a.now();let n=!1,a={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM)};do{const i=await this.getMediaRepository("image").getLastMediasOfConvInNewDB(e,a,50),r=[],o=i.map((e=>e.cliMsgId)),l={index:"cliMsgIdIndex",partition:e},c=tt.default.getInstance(),d=(await c.Core.Message.getMultiIfExists(o,l)).reduce(((e,t)=>(t&&(e[`${t.cliMsgId}_${t.fromUid}_${t.toUid}`]=t),e)),{}),u=[];for(const e of i)u.push(new Promise((async t=>{try{var s,i;const t=Object(f.a)(Object(f.a)({},e),{},{msgId:null!==(s=null===(i=d[e.mediaId])||void 0===i?void 0:i.msgId)&&void 0!==s?s:""}),n=await this.getMediaMapper("image").toDTO(t,!1);r.push(n)}catch(n){}t()})));if(await Promise.all(u),r.length){r.forEach((e=>{e.subType==R.MSG_SUBTYPE_MEDIA_VIDEO?s.push(e):e.subType!=R.MSG_SUBTYPE_PHOTO&&e.subType!=R.MSG_SUBTYPE_MEDIA_DOODLE||t.push(e)}));let e={cliMsgId:r[r.length-1].cliMsgId,sendDttm:r[r.length-1].sendDttm};if(e.cliMsgId&&a.cliMsgId==e.cliMsgId||e.sendDttm&&a.sendDttm==e.sendDttm)break;a=e}n=r.length>=50}while(n);n=!1;let r=R.MessageConstants.MAX_MSG_ID;do{const i=await this.getMediaRepository("image").getLastMediasOfConvInOldDB(e,{msgId:r},50),a=await Promise.all(i.map((e=>this.getMediaMapper("image").toDTO(e,!1))));if(a.length){a.forEach((e=>{e.subType==R.MSG_SUBTYPE_MEDIA_VIDEO?s.push(e):e.subType!=R.MSG_SUBTYPE_PHOTO&&e.subType!=R.MSG_SUBTYPE_MEDIA_DOODLE||t.push(e)}));let e=a[a.length-1].msgId;if(e&&r==e)break;r=e}n=a.length>=50}while(n);return this._trackDBPerformance({executionTime:Sr.a.now()-i,actionName:"getAllByConv",mediaType:"all",resultSize:t.length+s.length}),{photos:t,videos:s}}async getImageMessagesForPhotoViewer(e,t,s,n,a,r){if(!Object(a_.a)())return Rt.default.getImagesForPhotoViewer({userId:e},t,s,n,a,r);try{var o;if(!e||!t)throw Error("convId or lastMsgId is undefined!");const l=await this.getMediaFieldsByMsgId(e,t);return await(null===(o=i.ModuleContainer.resolve(Cy))||void 0===o?void 0:o.getImageMessagesForPhotoViewer(e,s,{sendDttm:(null==l?void 0:l.sendDttm)||parseInt(R.MessageConstants.MAX_SENDDTTM),cliMsgId:(null==l?void 0:l.cliMsgId)||R.MessageConstants.MAX_MSG_ID,msgId:t},n,a,r))}catch(c){var l;const e=[null==c||null===(l=c.toString)||void 0===l?void 0:l.call(c),null==c?void 0:c.stack].join("\n");return this._logger.zsymb(21,"LU-w0C",["[getImageMessagesForPhotoViewer] - error: {}","Y4CyLw"],e),[]}}async getLastestAddedFiles(e,t=40){if(!Object(a_.a)())return Rt.default.getLatestFiles(e,t);try{if(!e){e=Date.now();let t=yn.default.getTimeNow();e=e>t?e:t}const s=R.MessageConstants.MAX_CONVERSATION_ID,n=parseInt(R.MessageConstants.MAX_MSG_ID),a=i.ModuleContainer.resolve(Sy);let r=await a.getLastestAddedFiles({convId:s,sendDttm:e,cliMsgId:n},t);if(r.length>0){r=r.filter((e=>!!e&&!Yu.d.isDeleteMessage(e.convId,e)));const e=this.getMediaMapper("file");return await Promise.all(r.map((t=>e.toDTO(t))))}return[]}catch(n){var s;const e=[null==n||null===(s=n.toString)||void 0===s?void 0:s.call(n),null==n?void 0:n.stack].join("\n");return this._logger.zsymb(21,"ZY_99I",["[getLastestAddedFiles] - error: {}","l_oGIM"],e),Promise.resolve([])}}async getMultiMedias(e,t,s){if(!Object(a_.a)())return Rt.default.getMediaByIds(e,s);try{if(!s||s.length<0)throw Error("msgIds is undefined or empty!");const i=Sr.a.now(),n=[],a=s.map((e=>this.getMediaFieldsByMsgId(t,e).then((async t=>{n.push({newId:t?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:"",oldId:e,getFrom:await this._isMigrationDone()?ay.NEW:ay.UNKNOWN})}))));if(await Promise.all(a),!n.length)return[];const r=(await this.getMediaRepository(e).getMultiMedias(n)).filter((e=>!!e&&!Yu.d.isDeleteMessage(t,e)));return r.length>0?(this._trackDBPerformance({executionTime:Sr.a.now()-i,actionName:"getByIds",mediaType:e,resultSize:r.length}),await Promise.all(r.map((t=>this.getMediaMapper(e).toDTO(t))))):[]}catch(n){var i;const e=[null==n||null===(i=n.toString)||void 0===i?void 0:i.call(n),null==n?void 0:n.stack].join("\n");return this._logger.zsymb(21,"9EOS74",["[getMultiMedias] - error: {}","IQNVjV"],e),[]}}async getMediaById(e,t,s){try{if(!s)throw Error("mediaId is undefined!");const i=await this.getMediaFieldsByMsgId(t,s),n=this.getMediaRepository(e),a=await n.getMedia({newId:i?`${i.cliMsgId}_${i.fromUid}_${i.toUid}`:"",oldId:s},void 0,await this._isMigrationDone()?ay.NEW:ay.UNKNOWN);return a?await this.getMediaMapper(e).toDTO(a):void 0}catch(n){var i;const e=[null==n||null===(i=n.toString)||void 0===i?void 0:i.call(n),null==n?void 0:n.stack].join("\n");return this._logger.zsymb(21,"6gXX-I",["[getMediaById] - error: {}","qqG1ng"],e),Promise.resolve(void 0)}}async _updateMedia(e,t,s,i,n){try{if(!t)throw Error("chatID isn't valid!");if(!s)throw Error("mediaId isn't valid!");if(!i)throw Error("mediaValue isn't valid!");const n=this.getMediaRepository(e),a=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t,s),r=this.getMediaMapper(e).toNewEAttsFromDTOAtts(i);return await n.updateMedia({newId:a,oldId:s},{attributes:Object.keys(r),value:r,ignoreNotFound:!0},await this._isMigrationDone()?ny.NEW:ny.UNKNOWN)}catch(r){var a;const e=[null==r||null===(a=r.toString)||void 0===a?void 0:a.call(r),null==r?void 0:r.stack].join("\n");return this._logger.zsymb(21,"cAzksX",["[_updateMedia] - error: {}","vEMORD"],e),!1}}async _addMediasWhenTransferMessageOldFlow(e){try{const t=[],s=[],i=[];for(let a=0;a<e.length;a++){const n=e[a],r=n.msgType,o=Number(n.sendDttm);switch(r){case R.MSG_PHOTO:case R.MSG_PHOTO_2:case R.MSG_DOODLE:if(!Object(zf.a)(n)&&!Object(zf.E)(n)&&!Object(zf.z)(n)){const e=n.message.thumb||n.message.oriUrl,t=r==R.MSG_DOODLE?Object(f.a)(Object(f.a)({},n.message),{},{thumbUrl:e}):n.message;s.push({sendDttm:o,msgId:n.msgId,userId:n.toUid,message:t,fromUid:n.fromUid,subType:R.MSG_SUBTYPE_PHOTO,type:"image",ttl:n.ttl,cliMsgId:n.cliMsgId})}break;case R.MSG_FILE:t.push({sendDttm:o,msgId:n.msgId,userId:n.toUid,message:n.message,fromUid:n.fromUid,type:"file",ttl:n.ttl,cliMsgId:n.cliMsgId});break;case R.MSG_CONTACT:"recommened.link"===n.message.action&&i.push({sendDttm:o,msgId:n.msgId,userId:n.toUid,message:n.message,fromUid:n.fromUid,type:"link",ttl:n.ttl,cliMsgId:n.cliMsgId});break;case R.MSG_VIDEO:s.push({sendDttm:o,msgId:n.msgId,userId:n.toUid,message:n.message,fromUid:n.fromUid,subType:R.MSG_SUBTYPE_MEDIA_VIDEO,type:"image",ttl:n.ttl,cliMsgId:n.cliMsgId})}}let n=[];return s.length>0&&n.push(tt.default.getInstance().Core.Image.insertMulti(s,{replace:!1})),i.length>0&&n.push(tt.default.getInstance().Core.Link.insertMulti(i,{replace:!1})),t.length>0&&n.push(tt.default.getInstance().Core.File.insertMulti(t,{replace:!1})),await Promise.all(n)}catch(s){var t;const e=[null==s||null===(t=s.toString)||void 0===t?void 0:t.call(s),null==s?void 0:s.stack].join("\n");this._logger.zsymb(21,"jBb6X-",["[_addMediasWhenTransferMessageOldFlow] - error: {}","Llj3zo"],e)}}async _addMediasFromMessages(e,t){try{if(!e||!e.length)return;t=t||`${KI.c.UNKNOWN}${KI.d.FROM_MSG}`;const s=[],i=[],n=[],a=this.getMediaMapper("image"),r=this.getMediaMapper("file"),o=this.getMediaMapper("link");e.forEach((e=>{const l=e.msgType;switch(l){case R.MSG_PHOTO:case R.MSG_PHOTO_2:case R.MSG_DOODLE:if(l===R.MSG_DOODLE){let i=e.message;if(e.message){const t=e.message.thumb||e.message.oriUrl;i=Object(f.a)(Object(f.a)({},e.message),{},{thumbUrl:t})}s.push(a.toDomainFromTMessage(Object(f.a)(Object(f.a)({},e),{},{message:i}),R.MSG_SUBTYPE_MEDIA_DOODLE,t))}else Object(zf.a)(e)||Object(zf.E)(e)||Object(zf.z)(e)||s.push(a.toDomainFromTMessage(e,R.MSG_SUBTYPE_PHOTO,t));break;case R.MSG_FILE:i.push(r.toDomainFromMessage(e,t));break;case R.MSG_CONTACT:"recommened.link"===e.message.action&&n.push(o.toDomainFromMessage(e,t));break;case R.MSG_VIDEO:s.push(a.toDomainFromTMessage(e,R.MSG_SUBTYPE_MEDIA_VIDEO,t))}}));let l=[];return s.length>0&&l.push(this.getMediaRepository("image").insertMulti(s).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),i.length>0&&l.push(this.getMediaRepository("file").insertMulti(i).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),n.length>0&&l.push(this.getMediaRepository("link").insertMulti(n).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),await Promise.all(l)}catch(i){var s;const e=[null==i||null===(s=i.toString)||void 0===s?void 0:s.call(i),null==i?void 0:i.stack].join("\n");this._logger.zsymb(21,"fykkhd",["[_addMediasFromMessages] - error: {}","Z-BcbI"],e)}}async _addMediasAtExportImportFlowOldFlow(e){if(!e||!e.length)return;const t=[],s=[],i=[];e.forEach((e=>{if(e.msgType===R.MSG_FILE)s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,type:"file",ttl:e.ttl});else if(e.msgType===R.MSG_CONTACT)"recommened.link"===e.message.action&&i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"link",ttl:e.ttl});else if(e.msgType!==R.MSG_PHOTO&&e.msgType!==R.MSG_PHOTO_2&&e.msgType!==R.MSG_DOODLE||Object(zf.a)(e)||Object(zf.E)(e)||Object(zf.z)(e))e.msgType===R.MSG_VIDEO&&t.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:R.MSG_SUBTYPE_MEDIA_VIDEO,ttl:e.ttl});else{const s={msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:R.MSG_SUBTYPE_PHOTO,ttl:e.ttl};if(e.msgType===R.MSG_DOODLE){const e=s.message.thumb||s.message.oriUrl;s.subType=R.MSG_SUBTYPE_MEDIA_DOODLE,s.message=Object(f.a)(Object(f.a)({},s.message),{},{thumbUrl:e})}t.push(s)}})),s.length&&Rt.default.addFilesToConversation(s),i.length&&Rt.default.addLinksToConversation(i),t.length&&Rt.default.addOrUpdateImagesToConversation(t)}async _addMediasFromMessagesWhenBackupOldFlow(e){if(!e||!e.length)return;const t=[],s=[],i=[];e.forEach((e=>{if(e.msgType===R.MSG_FILE)s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,ttl:e.ttl});else if(e.msgType===R.MSG_CONTACT&&"recommened.link"===e.message.action)i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl});else if(!(e.msgType!==R.MSG_PHOTO&&e.msgType!==R.MSG_PHOTO_2&&e.msgType!==R.MSG_DOODLE||Object(zf.a)(e)||Object(zf.E)(e)||Object(zf.z)(e))){let s=e.message;if(e.msgType===R.MSG_DOODLE){const t=e.message.thumb||e.message.oriUrl;s=Object(f.a)(Object(f.a)({},e.message),{},{thumbUrl:t})}t.push({msgId:e.msgId,userId:e.toUid,message:s,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl})}})),s.length&&Rt.default.addFilesToConversation(s),i.length&&Rt.default.addLinksToConversation(i),t.length&&Rt.default.addOrUpdateImagesToConversation(t)}async _emptyOldMediaStore(e,t){const s={from:[t,0,""],to:[t,R.MessageConstants.MAX_MSG_ID.length,R.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"userId_sendDttm_msgId",direction:Le.c.PREV},n=await e.getAllKey(s,i);null!=n&&n.length&&await e.deleteMulti(n)}async _emptyNewMediaStore(e,t){const s={from:[t,0,""],to:[t,parseInt(R.MessageConstants.MAX_SENDDTTM),R.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"convId_sendDttm_cliMsgId",direction:Le.c.PREV},n=await e.getAllKey(s,i);null!=n&&n.length&&await e.deleteMulti(n)}async updateFile(e,t,s,i){return Object(a_.a)()?this._updateMedia("file",e,t,s,i):!!(await Rt.default.updateFile(t,s,i))}getMediaFromConversation(e,t,s,i,n){if(!Object(a_.a)())return v_.a.getMediaFromConversation({userId:t},e,s,i,n);const a=e.substring(0,e.length-1);return this.getValidMediasOfConv(a,t,s,i,n)}async deleteMediaWhenDeleteMsg(e,t,s){if(!Object(a_.a)())return void Rt.default.deleteMediaItem(t);let i="";if(null!=s&&s.mediaIdKeys){const{cliMsgId:e,fromUid:t,convId:n}=s.mediaIdKeys;i=`${e}_${t}_${n}`}else i=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e,t);this.deleteMediasById("",e,{newId:i,oldId:t})}async deleteMediaItems(e,t,s,i){if(!s)return[];if(!Object(a_.a)())return v_.a.deleteMediaItem(s,e);let n=[];n=null!=i&&i.mediaIdKeysArr&&i.mediaIdKeysArr.length?i.mediaIdKeysArr.map((e=>`${e.cliMsgId}_${e.fromUid}_${e.convId}`)):await Promise.all(s.map((e=>this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t,e))));const a=s.map(((e,t)=>({oldId:e,newId:n[t]})));return this.deleteMediasById(e,t,a)}async addLinksToConversation(e){Object(a_.a)()?this.addMedias("link",e):Rt.default.addLinksToConversation(e)}async getFilesFromConversation(e,t,s){return Object(a_.a)()?this.getValidMediasOfConv("file",e,t,s,null):Rt.default.getFilesFromConversation({userId:e},t,s)}async addMediasWhenTransferMessage(e,t,s){return s?this._addMediasFromMessages(e,t):this._addMediasWhenTransferMessageOldFlow(e)}async addMediasAtExportImportFlow(e,t){return Object(a_.a)()?this._addMediasFromMessages(e,t):this._addMediasAtExportImportFlowOldFlow(e)}async addMediasFromMessagesWhenBackup(e,t){return Object(a_.a)()?this._addMediasFromMessages(e,t):this._addMediasFromMessagesWhenBackupOldFlow(e)}async deleteImageByMsgId(e,t,s){if(!Object(a_.a)())return Rt.default.deleteImageByMsgId(t);let i="";return i=null!=s&&s.mediaIdKeys?`${s.mediaIdKeys.cliMsgId}_${s.mediaIdKeys.fromUid}_${s.mediaIdKeys.convId}`:await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e,t),await this.deleteMediasById("image",e,{newId:i,oldId:t}),!0}async doAddMediaToConversation(e,t){return Object(a_.a)()?this.addMedias(e,t):v_.a.doAddMediaToConversation(t,e)}async updateMsgIdForRelativeMedia(e,t,s){if(Object(a_.a)()){const i=(t,s,i)=>{this.getMediaById(t,e,i).then((n=>{n&&(n.msgId=s,this.deleteMediasById(t,e,{newId:void 0,oldId:i}).then((()=>{this.addMedias(t,[n])})))}))};i("file",t,s),i("image",t,s),i("link",t,s)}else{const e=(e,t,s)=>{e.get(s).then((i=>{i&&(i.msgId=t,e.delete(s).then((()=>{e.insert(i)})))}))},i=tt.default.getInstance();e(i.Core.File,t,s),e(i.Core.Image,t,s),e(i.Core.Link,t,s)}}async emptyMediaStores(e,t){e&&t&&t.length&&(Object(a_.a)()?t.forEach((t=>{"file"===t?this._emptyNewMediaStore(tt.default.getInstance().Media.File,e):"image"===t?this._emptyNewMediaStore(tt.default.getInstance().Media.Image,e):"link"===t&&this._emptyNewMediaStore(tt.default.getInstance().Media.Link,e)})):t.forEach((t=>{"file"===t?this._emptyOldMediaStore(tt.default.getInstance().Core.File,e):"image"===t?this._emptyOldMediaStore(tt.default.getInstance().Core.Image,e):"link"===t&&this._emptyOldMediaStore(tt.default.getInstance().Core.Link,e)})))}async addMediasFromOldDB(e,t){if(!t||!t.length)return[];const s=this.getMediaRepository(e),i=v_.a.getAllDeleteConv();let n=t,a=t.map((e=>e.msgId));if(i){const s=t.reduce(((t,s)=>{var n;const{userId:a}=s;if(null!==(n=i[a])&&void 0!==n&&n[e]){const n=s.msgId,r=i[a][e].lastId;r&&n&&r<n&&t.oldMediaEntitiesShouldAddToNewDB.push(s)}else t.oldMediaEntitiesShouldAddToNewDB.push(s);return t.oldMediaIdsShouldDeleteFromOldDB.push(s.msgId),t}),{oldMediaEntitiesShouldAddToNewDB:[],oldMediaIdsShouldDeleteFromOldDB:[]});n=s.oldMediaEntitiesShouldAddToNewDB,a=s.oldMediaIdsShouldDeleteFromOldDB}const r=await s.correctMediasInOldDB(n,{saveBack:!1}),o=this.getMediaMapper(e),l=r.map((e=>o.toDomainFromOldDomain(e))),c=await s.insertMulti(l);if(c.success.length){const e=c.success.map((e=>o.toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));return this._utilsMediaManager.createOrUpdateFromMedias(e),a}return[]}async getMediasFromOldDB(e,t,s){if(await this._isMigrationDone())return[];const i={from:"",to:s,excludeFrom:!0,excludeTo:!0},n={index:"primary",direction:Le.c.PREV,limit:t};return this.getMediaRepository(e).getOldDBTable().getAll(i,n)}async deleteMediasFromOldDB(e,t){const s=this.getMediaRepository(e);return(await s.getOldDBTable().deleteMulti(t)).success}async deleteMediasFromOldDBByRange(e,t,s){const i={from:"",to:s,excludeFrom:!0,excludeTo:!0},n={index:"primary",direction:Le.c.PREV,limit:t},a=this.getMediaRepository(e),r=await a.getOldDBTable().getAllKey(i,n);return(await a.getOldDBTable().deleteMulti(r)).success}async countTotalMediaInOldDB(e){try{return this.getMediaRepository(e).getOldDBTable().count()}catch(s){var t;const e=[null==s||null===(t=s.toString)||void 0===t?void 0:t.call(s),null==s?void 0:s.stack].join("\n");return this._logger.zsymb(21,"QDXWza",["[countTotalMediaInOldDB] - error: {}","QKQL5L"],e),0}}async _testAddMedias(e,t=50){let s=[];const i=2*Date.now()+Math.round(1e5*Math.random())+1e3,n=5*Date.now()+Math.round(1e7*Math.random())+1e3,a=["0","123456123111111456","12345111111345","111111111111111","12345111111167890","2121212121112222121","1231231231232222123","22222222222222222","2111111111111222111","322222222222222222","12341234212341123","9753434346787646","1234123412341234","987651235545454545","123123455432123432","21212123443434545","5454544531321323","98909087567564545645"],r=["4037840159631073270",...JSON.parse('["101598415","124139871","147333052","169079931","194945127","200868372","225822710","276214855","355712826","361879215","910825795994501468","g100588026","g112969450","g1149397433596350988","g1352476194718464059","g147262698","g149205131","g158719108","g158754949","g160924468","g164283274","g175572981","g194334627","g230291933","g2426404535463764819","g245533229","g25193586","g257364624","g263690118","g285979907","g285992315","g28757702","g288999008","g289367881","g293290840","g301757910","g302249930","g302577276","g309222362","g312505929","g317894641","g318028102","g320951866","g321466298","g322706780","g325920125","g325933426","g328827910","g331912501","g34509241","g47431271","g5355130437069108654","g55402697","g6911969691454201107","g85951308"]')];switch(e){case"image":for(let e=0;e<t;e++){const t=a[Math.round(Math.random()*(a.length-1))],o=r[Math.round(Math.random()*(r.length-1))],l=i+e,c=n+e;s.push({userId:o,cliMsgId:l,fromUid:t,msgId:c.toString(),message:{hdUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",oriUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",params:'{"width":800,"height":800,"hd":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln","rawThumbUrl":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg"}',thumbUrl:"https://f62-zpg-r.zdn.vn/1518777612491889561/5571c987a1187b462209.jpg?e2esession=YBl+XgC1U90bnMk4yPcU519rhnRW4KoItoeNXLpRsl/secNpaT3Nxkal57Nj3UZhy2rUFgxhf8Pcjwah",title:void 0},type:"image",isExpired:!1,isExpiredAll:!1,subType:Math.round(Math.random())?R.MSG_SUBTYPE_PHOTO:R.MSG_SUBTYPE_MEDIA_VIDEO,sendDttm:Date.now()+e,ttl:0,localPath:null,previewThumb:void 0,updateTime:Date.now(),width:0,height:0})}break;case"file":for(let e=0;e<t;e++){const t=a[Math.round(Math.random()*(a.length-1))],o=r[Math.round(Math.random()*(r.length-1))],l=i+e,c=n+e;s.push({userId:o,cliMsgId:l,fromUid:t,msgId:c.toString(),message:{href:"https://f27-group-zfr.zdn.vn/7f8b522a54e0babee3f1/117090926800068678?e2esession=RSHmz0Kj28vN9gMz6oFilBjFxVFqisUPnj3XpjlolXXpTo3bwJ0hqlUl5uR6Sr/wtHrtcyXqXj/mLYl3",params:'{"fileSize":8178,"checksum":"78c2c03eeab27abbdf28b0fe25088e30","checksumSha":"","fileExt":"xlsx","fdata":"{}","fType":1}',title:"program_matrix_laP5chSikftFYc_LmERud.xlsx"},type:"file",fileType:-1,extType:"",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),localPath:null,folderPath:null,previewThumb:"",dimension:null,downloadError:!1,isExpired:!1,isExpiredAll:!1})}break;case"link":for(let e=0;e<t;e++){const t=a[Math.round(Math.random()*(a.length-1))],o=r[Math.round(Math.random()*(r.length-1))],l=i+e,c=n+e;s.push({userId:o,cliMsgId:l,fromUid:t,msgId:c.toString(),message:{action:"recommened.link",childnumber:0,description:"http://tinhte.vn",href:"http://tinhte.vn",oriUrl:"http://tinhte.vn",params:'{"mediaTitle":"http://tinhte.vn","artist":"","src":"tinhte.vn","stream_icon":"","streamUrl":"","type":0,"subType":3}',thumb:"",thumbUrl:"",title:"tinhte.vn",type:""},type:"link",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),previewThumb:""})}}const o=this._getMediaDB(e,!1);await(null==o?void 0:o.insertMulti(s))}_getMediaDB(e,t){const s=tt.default.getInstance();switch(e){case"image":return t?s.Media.Image:s.Core.Image;case"file":return t?s.Media.File:s.Core.File;case"link":return t?s.Media.Link:s.Core.Link}}_trackDBPerformance(e){Object(_l.b)().logInfo(_l.a.LoadMedia,{duration:e.executionTime,action_name:e.actionName,media_type:e.mediaType,result_size:e.resultSize})}})||f_)||f_)||f_)||f_)||f_)||f_)||f_)||f_);var b_,I_=s("lT2C"),y_=s("C8zZ"),__=s("wmCV");let C_=Object(ko.b)(y_.GroupPollManager)(b_=function(e,t){return i.ModuleContainer.inject(jo.ConvInfoDataManager)(e,void 0,0)}(b_=Reflect.metadata("design:type",Function)(b_=Reflect.metadata("design:paramtypes",[void 0===jo.ConvInfoDataManager?Object:jo.ConvInfoDataManager])(b_=class{constructor(e){this.convDataManager=e,this._Logger=void 0,this.pollCache=void 0,this.pollCache=new he.default({maxSize:1e4}),this.setUpEvent()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.pollV3,[Ve.ZLoggerNametags.groupPollManager])),this._Logger}updatePollCache(e,t){this.pollCache.set(e,t)}removePollCacheBelongsToConv(e){Array.from(this.pollCache.entriesAscending()).forEach((([t,s])=>{s.group_id===ho.default.getGroupIdFromConversationId(e)&&this.pollCache.delete(t)}))}setUpEvent(){this.convDataManager.addEventListener(so.b.DeleteConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(so.b.EmptyConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(so.b.LeaveGroup,(e=>{this.removePollCacheBelongsToConv(e.convId)}))}isAdmin(e,t){var s;const i=Zo.default.getGroupByIdSync(e);if(!i)return!1;if(t===i.creatorId)return!0;let n=!1;return null===(s=i.topMember)||void 0===s||s.forEach((e=>{e.id===t&&e.isAdmin&&(n=!0)})),n}isAllowSetTopic(e){var t;const s=Zo.default.getGroupByIdSync(e);return!!s&&!(!mi.default.group_topics.enable||null!==(t=s.setting)&&void 0!==t&&t.setTopicOnly)}isEnablePin(e){return this.isAdmin(e,ns.default.getUidMe())||this.isAllowSetTopic(e)}isEnableClose(e,t){const s=ns.default.getUidMe();return this.isAdmin(e,s)||s===t}createPollRequestData(e){const{pollData:t,groupId:s,src:i}=e,n={question:t.question,options:t.options,expired_time:t.expiredTime,pinAct:t.pinAct,allow_multi_choices:t.allowMultiChoices,allow_add_new_option:t.allowAddNewOption,is_hide_vote_preview:t.isHideVotePreview,is_anonymous:t.isAnonymous,poll_type:t.pollType};return{groupId:ho.default.getGroupIdFromConversationId(s),pollData:n,src:i}}async createPoll(e){const t=e.pollData.pinAct,{groupId:s,pollData:i,src:n}=this.createPollRequestData(e);try{const a=await uo.default.createPoll(s,i,n);t&&this.pinPoll(a.poll_id,e.groupId,a.question)}catch(a){throw this.Logger.zsymb(18,"y42Q9T",a),a}}getPollDetailSync(e){return this.pollCache.get(e)}async getPollDetail(e,t){let s=this.getPollDetailSync(e);if(s)return s;if(s=await Rt.default.getPollInfo(e),!s){if(t)return this.getPollDetailFromServer(e);throw Error("Poll isn't existed in DB")}return this.pollCache.set(e,s),s}async getPollDetailFromServer(e,t){const s=await uo.default.getPollDetail(t,e,!1);if(!s)throw Error("Poll isn't existed in Server");return this.pollCache.set(e,s),s}async pinPoll(e,t,s){let i=s;if(!i){let t=this.getPollDetailSync(e);if(t||(t=await this.getPollDetail(e)),!t)throw Error("Poll isn't existed");i=t.question}__.a.pinFromBoard({userId:t},{poll_id:e,isPoll:!0,question:i},null,null,$h.a.getWinIdByConvId(t))}unpinPoll(e,t){__.a.unpinFromBoard(t,{poll_id:e,isPoll:!0})}async lockPoll(e){const t=this.getPollDetailSync(e);if(!t||!t.closed)try{uo.default.lockPoll(e)}catch(s){this.Logger.zsymb(18,"xwoquA","[lockPoll] ",e,s)}}async sharePollInGroup(e){try{uo.default.sharePoll(e)}catch(t){this.Logger.zsymb(18,"la71ts","[sharePollInGroup] ",e,t)}}async votePoll(e){const{newOptions:t,pollId:s,votedOptionIds:i}=e,n=ho.default.getGroupIdFromConversationId(e.groupId);try{t.length>0?await uo.default.addNewOptionPoll(n,s,JSON.stringify(t),i):await uo.default.vote(n,s,i)}catch(a){throw this.Logger.zsymb(18,"Nl_9Pt","[votePoll] ",a,s),a}}})||b_)||b_)||b_)||b_;var O_,E_=s("ILDi");let M_=Object(ko.b)(y_.GroupPollInfoManager)(O_=Reflect.metadata("design:type",Function)(O_=Reflect.metadata("design:paramtypes",[])(O_=class{constructor(){this.updateEmitter=void 0,this.viewedMoreFromMsgIds=void 0,this.updateEmitter=new qg.a,this.viewedMoreFromMsgIds=new Set}getPollParams(e){let t=null;try{var s;t=JSON.parse(null==e||null===(s=e.message)||void 0===s?void 0:s.params)}catch(i){t={}}return t}getLastMessagePoll(e,t,s){let i=t;return s.forEach((s=>{s.msgType!==t.msgType||this.getPollParams(s).pollId!==e||(i=s)})),i}getContinuosPollInfoSection(e,t){const s=[];let i=0;return t.forEach((t=>{var n;t.msgType===R.MSG_POLL&&this.getPollParams(t).pollId===e?(s[i]||(s[i]=[]),s[i].push(t)):null!==(n=s[i])&&void 0!==n&&n[0]&&(i+=1)})),s.filter((e=>e.length>mi.default.groupPoll.max_info_msg_display))}isShowPollCard(e,t,s){const i=this.getLastMessagePoll(e,t,s);return Od.b.isSameMsg(t,i)}getPollInfoShowStatus(e,t,s){const i=this.getContinuosPollInfoSection(e,s);for(const n of i)for(let e=n.length-1;e>=0;e--)if(Od.b.isSameMsg(t,n[e]))return e!==n.length-1?"HIDE":n[e-1]&&this.viewedMoreFromMsgIds.has(n[e-1].msgId)?"SHOW":"SHOW_VIEW_MORE";return"SHOW"}viewMore(e,t,s){let i=[];const n=this.getContinuosPollInfoSection(e,s);for(const a of n)if(a[a.length-1].msgId===t){i=a.map((e=>e.msgId));break}this.updateEmitter.emit("EXPAND_MSG_INFO",{msgIds:i}),this.viewedMoreFromMsgIds.add(t)}clearViewedMoreHistory(e){this.viewedMoreFromMsgIds.delete(e)}})||O_)||O_)||O_;i.ModuleContainer.registerSingleton(I_.a,C_),i.ModuleContainer.registerSingleton(E_.a,M_);var S_=s("3+ZU"),T_=s("MEZx");i.ModuleContainer.registerSingleton(S_.a,class{getDebugMenu(){return mi.default.mediaStatus.debug.enable?{type:T_.MENU_ITEM_TYPE.SUBMENU,text:"Media Status",items:[{text:"Disable expired soon status",onclick:()=>{mi.default.mediaStatus.enable_expired_soon=!mi.default.mediaStatus.enable_expired_soon},checked:!mi.default.mediaStatus.enable_expired_soon},{text:"Revert media status",onclick:()=>{mi.default.mediaStatus.enable_media_status=!mi.default.mediaStatus.enable_media_status},checked:!mi.default.mediaStatus.enable_media_status},{text:"Disable view in folder for auto download",onclick:()=>{mi.default.mediaStatus.enable_view_folder_option_for_auto_download=!mi.default.mediaStatus.enable_view_folder_option_for_auto_download},checked:!mi.default.mediaStatus.enable_view_folder_option_for_auto_download},{text:"Disable inview file download",onclick:()=>{mi.default.mediaStatus.enable_file_inview_download=!mi.default.mediaStatus.enable_file_inview_download},checked:!mi.default.mediaStatus.enable_file_inview_download},{text:"Open Media Status Debugger Modal",onclick:()=>{const e=s("h0sc");e&&e.ModalManagerV2&&e.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.MEDIA_STATUS_DEBUGGER,params:{show:!0}})}}]}:null}});const w_=Object(i.define)("media-action-log-info-queue-tasks"),R_=Object(i.define)("media-action-log-info-producer"),L_=Object(i.define)("media-action-log-info-manager"),D_=Object(i.define)("media-action-log-info-consumer"),A_=Object(i.define)("media-action-log-info-cron-to-group-data");var F_;let j_=Object(i.injectable)()(F_=function(e,t){return Object(i.inject)(w_)(e,void 0,0)}(F_=Reflect.metadata("design:type",Function)(F_=Reflect.metadata("design:paramtypes",[Object])(F_=class{constructor(e){this.queue=e}push(e,t,s){const i={convId:e,msgId:t,action:s};this.queue.push(i)}})||F_)||F_)||F_)||F_;class P_ extends Error{constructor({message:e,name:t,options:s}){super(e),this.code=void 0,this.name=void 0,this.name=t,s&&s.code&&(this.code=s.code),s&&s.stack&&(this.stack=(new Error).stack),Object.setPrototypeOf(this,P_.prototype)}}var k_=(e,t)=>{const s={code:e.code,stack:t};return new P_({name:e.name,options:s,message:e.message})};const N_={name:"CANNOT_GET_MSG_FROM_DB",code:1,message:"Cannot get message from Message Core database"},U_={name:"QUEUE_TASK_EMPTY",code:2,message:"Action log info queue is empty"},B_={name:"TASK_IS_RUNNING",code:3,message:"Media action log info queue has task is running"},x_={name:"TEMP_DISABLE_LOG_PHOTO_SUBTYPE_2",code:4,message:"Temporary disable actionlog info for photo in subType 2"};var G_=s("JJxn"),z_=s("tmLI"),V_=s("jjJf"),H_=s("eZ5W");function W_(e){return e===R.MSG_E2EE?G_.c.YES:G_.c.NO}function $_(e){return"0"!=e?G_.d.RECEIVER:G_.d.SENDER}var K_=s("HPXo");class q_{build(e,t){var s,i;const n={msg_type:G_.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:W_(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:$_(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:G_.f[e.convType],sync_source:G_.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(n.group_size=e.groupSize),t){case G_.j.MediaExpiredWhenAction:n.original_status=K_.a.get(e.msg.msgId);break;case G_.j.MediaStatusInView:null!=e&&e.forceStatus?n.file_status=null==e?void 0:e.forceStatus:n.file_status=null==e?void 0:e.mediaStatus}return n}}class Q_{build(e,t){var s,i;const n={msg_type:G_.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:W_(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:$_(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:G_.f[e.convType],sync_source:G_.g[e.msg.src],is_zCloud:e.isZCloud};switch(null!=e&&e.groupSize&&(n.group_size=e.groupSize),t){case G_.j.MediaExpiredWhenAction:n.original_status=K_.a.get(e.msg.msgId);break;case G_.j.MediaStatusInView:n.file_status=null==e?void 0:e.forceStatus}return n}}class Z_{build(e,t){var s,i;const n={msg_type:G_.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:W_(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:$_(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:G_.f[e.convType],sync_source:G_.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(n.group_size=e.groupSize),t){case G_.j.MediaExpiredWhenAction:n.original_status=K_.a.get(e.msg.msgId);break;case G_.j.MediaStatusInView:n.file_status=e.mediaStatus}return n}}class J_{build(e,t){var s,i;const n={msg_type:G_.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:W_(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:$_(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:G_.f[e.convType],sync_source:G_.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(n.group_size=e.groupSize),t){case G_.j.MediaExpiredWhenAction:n.original_status=K_.a.get(e.msg.msgId);break;case G_.j.MediaStatusInView:n.file_status=e.mediaStatus}return n}}class Y_{constructor(){this.msg=void 0,this.subType=void 0,this.entryPoint=void 0,this.convType=void 0,this.mediaStatus=void 0,this.forceStatus=void 0,this.isZCloud=void 0}withMessage(e){return this.msg=e,this}withSubType(e){return this.subType=e,this}withEntryPoint(e){return this.entryPoint=e,this}withStatus(e){return this.mediaStatus=e&&function(e){var t,s,i,n,a,r,o;let l="";var c,d,u,h,g,m;return null!==(t=e)&&void 0!==t&&t.isExpired&&(l=ah.e.Expired),null!==(s=e)&&void 0!==s&&s.isExpiredSoon&&(l=ah.e.ExpiredSoon),Object(V_.b)().isEnableViewPCloudFileStatus()&&null!==(i=e)&&void 0!==i&&i.personalCloud&&null!==(c=e)&&void 0!==c&&null!==(d=c.personalCloud)&&void 0!==d&&null!==(u=d.status)&&void 0!==u&&u.isUncloud&&e===ah.e.ExpiredSoon&&(e=ah.e.ExpiredSoon),Object(V_.b)().isEnableViewPCloudFileStatus()&&null!==(n=e)&&void 0!==n&&n.personalCloud&&null!==(h=e)&&void 0!==h&&null!==(g=h.personalCloud)&&void 0!==g&&null!==(m=g.status)&&void 0!==m&&m.isClouded&&(l=ah.d.CloudSaved),null!==(a=e)&&void 0!==a&&a.autoDownloadPath&&(l=ah.e.DownloadedAuto),(null!==(r=e)&&void 0!==r&&r.localPath||null!==(o=e)&&void 0!==o&&o.folderPath)&&(l=ah.e.DownloadedManual),l}(e),this}withForceStatus(e=""){return this.forceStatus=e,this}withZCloud(e=0){return this.isZCloud=e?1:0,this}build(){var e,t;const s=function(e){const t=Object(z_.n)(null==e?void 0:e.params)||"";return t?(null==t?void 0:t.fileSize)&&+t.fileSize/1024:-1}(this.msg.message),i=(null===(e=this.msg)||void 0===e?void 0:e.toUid)&&(n=null===(t=this.msg)||void 0===t?void 0:t.toUid,ho.default.isOAType(ns.default.getProfileFriendSync(n))?G_.a.OA:ho.default.getConversationType(n));var n;const a=i===G_.a.GROUP&&function(e){let t;const s=Zo.default.getGroupByIdSync(e);return null!=s&&s.topMember&&(null==s?void 0:s.topMember.length)>0&&(t=null==s?void 0:s.topMember.length),t}(this.msg.toUid),r=i===G_.a.CLOUD?function(e,t){let s=e;return e!==ah.d.DownloadedAuto&&e!==ah.d.DownloadedManual&&t<=H_.b.getCloudLimitBigFileInBytes()&&(s=ah.d.CloudSaved),s}(this.mediaStatus,s):this.mediaStatus;let o={};const l={msg:this.msg,size:s,isZCloud:this.isZCloud,mediaStatus:r,convType:i,forceStatus:this.forceStatus,entryPoint:this.entryPoint,groupSize:a};switch(this.msg.msgType){case R.MSG_PHOTO:case R.MSG_PHOTO_2:o=(new Q_).build(l,this.subType);break;case R.MSG_FILE:o=(new q_).build(l,this.subType);break;case R.MSG_VIDEO:o=(new Z_).build(l,this.subType);break;case R.MSG_VOICE:o=(new J_).build(l,this.subType)}return o}}var X_=class{verify(e){return!!e.file_status&&(!!Object.values(G_.c).includes(e.is_e2ee)&&(!!Object.values(G_.d).includes(e.is_sender)&&(!!Object.values(G_.d).includes(e.is_sender)&&(!!Object.values(G_.f).includes(e.conv_type)&&(!!Object.values(G_.g).includes(e.sync_source)&&!!Object.values(G_.h).includes(e.msg_type))))))}},eC=s("a4lh");R.MSG_FILE,R.MSG_VIDEO,R.MSG_VOICE;const tC=[R.MSG_PHOTO,R.MSG_PHOTO_2];var sC;let iC=Object(i.injectable)()(sC=function(e,t){return Object(i.inject)(w_)(e,void 0,0)}(sC=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(sC=function(e,t){return Object(i.inject)(A_)(e,void 0,2)}(sC=Reflect.metadata("design:type",Function)(sC=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,Object])(sC=class{constructor(e,t,s){this.queue=e,this.mediaActionLogInfoCronToGroupData=s,this.logger=void 0,this.DB=void 0,this.isRunning=void 0,this.logger=t.createZLogger(Ve.ZLoggerNametags.mediaStatus,["action-log-consumer"]),this.DB=tt.default.getInstance(),this.isRunning=!1}async run(){if(!(this.queue.length<=0)){if(this.isRunning)return k_(B_);this.isRunning=!0,requestAnimationFrame((async()=>{try{const e=this.queue.pop();if(!e)return k_(U_);const t=e.msgId,s=e.action,i=e.convId,n=await this.DB.Core.Message.get(t,{partition:i});let a;if(!n)return k_(N_);if((n.msgType===R.MSG_PHOTO||n.msgType===R.MSG_PHOTO_2)&&!mi.default.mediaStatus.actionLogInfo.enable_sub_type_2_for_photo&&s.subType===G_.j.MediaStatusInView)return x_;const r=(new Y_).withEntryPoint(s.entryPoint).withSubType(s.subType).withMessage(n).withStatus(a).withForceStatus((null==s?void 0:s.forceStatus)||"").withZCloud((null==s?void 0:s.isZCloud)||0).build();if((new X_).verify(r))if(tC.includes(n.msgType)){const e=Object(f.a)({},r);delete e.sent_time,delete e.size;const t=JSON.stringify(e);this.mediaActionLogInfoCronToGroupData.runCron({key:t,data:Object(f.a)(Object(f.a)({},r),{},{subType:s.subType})})}else eC.a.LogActionInfo(s.subType,r)}catch(e){this.logger.zsymb(3,"VFxNZG",["error {}","2IPxCy"],JSON.stringify(e))}finally{this.isRunning=!1,this.run()}}))}}})||sC)||sC)||sC)||sC)||sC)||sC;var nC;let aC=Object(i.injectable)()(nC=function(e,t){return Object(i.inject)(R_)(e,void 0,0)}(nC=function(e,t){return Object(i.inject)(D_)(e,void 0,1)}(nC=Reflect.metadata("design:type",Function)(nC=Reflect.metadata("design:paramtypes",[Object,Object])(nC=class{constructor(e,t){this.producer=e,this.consumer=t}run(e,t,s){}})||nC)||nC)||nC)||nC)||nC;var rC=s("z97J");const oC=new class{constructor(e){this.lru=void 0,this.lru=new he.default({maxSize:e.maxSize()})}set(e,t){if(t)if(this.has(e)){const s=this.lru.get(e);s.sent_time=`${parseInt(s.sent_time)+parseInt(t.sent_time)}`,s.size&&t.size&&(s.size=`${parseInt(s.size)+parseInt(t.size)}`),++s.count,this.lru.set(e,s)}else this.lru.set(e,Object(f.a)(Object(f.a)({},t),{},{count:1}))}get(e){return this.lru.get(e)}has(e){return this.lru.has(e)}delete(e){return this.lru.delete(e)}getAll(){return[...this.lru.values()]}clear(){this.lru.clear()}}({maxSize:()=>mi.default.maxSizeMemCacheMediaStatusPhotoActionLogInfo});i.ModuleContainer.registerSingleton(w_,class{constructor(){this.queue=void 0,this.queue=[]}push(e){this.queue.push(e)}pop(){return this.queue.pop()}get length(){return this.queue.length}}),i.ModuleContainer.registerSingleton(R_,j_),i.ModuleContainer.registerSingleton(A_,class{constructor(){this.startCron=void 0,this.startCron=!1}setStart(){this.startCron||(this.startCron=!0)}isStartCron(){return this.startCron}runCron(e){const t=new rC.CronJob(mi.default.mediaStatus.actionLogInfo.time_to_log_photo,(()=>{const e=oC.getAll();if(e.length){for(const s of e){var t;const e=s.subType;delete s.subType,s.sent_time=Math.round(s.sent_time/s.count),s.size=(null!==(t=s.size)&&void 0!==t?t:0)/s.count,eC.a.LogActionInfo(e,s)}oC.clear()}}));this.isStartCron()?oC.set(e.key,e.data):(oC.set(e.key,e.data),t.start(),this.setStart())}}),i.ModuleContainer.registerSingleton(D_,iC),i.ModuleContainer.registerSingleton(L_,aC);var lC=s("imbw"),cC=s("1EWQ");const dC=1,uC=2,hC=3;let gC=function(e){return e[e.TEXT=0]="TEXT",e[e.STICKER=1]="STICKER",e[e.PHOTO=2]="PHOTO",e[e.LINK=3]="LINK",e[e.FILE=4]="FILE",e[e.GIF=5]="GIF",e[e.CONTACT=6]="CONTACT",e}({}),mC=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),pC=function(e){return e[e.SINGLE=0]="SINGLE",e[e.GROUP=1]="GROUP",e}({}),fC=function(e){return e[e.CONTEXT_MENU=0]="CONTEXT_MENU",e[e.BUBBLE=1]="BUBBLE",e}({}),vC=function(e){return e[e.RESEND=1]="RESEND",e[e.DELETE=2]="DELETE",e}({}),bC=function(e){return e[e.NO_RESEND=1]="NO_RESEND",e[e.RESEND_SINGLE=2]="RESEND_SINGLE",e[e.RESEND_ALL=3]="RESEND_ALL",e}({}),IC=function(e){return e[e.NO_DELETE=1]="NO_DELETE",e[e.DELETE_SINGLE=2]="DELETE_SINGLE",e[e.DELETE_ALL=3]="DELETE_ALL",e}({});var yC;let _C=Object(ko.b)(lC.a)(yC=Reflect.metadata("design:type",Function)(yC=Reflect.metadata("design:paramtypes",[])(yC=class{constructor(){this.lastNetworkBannerAppearTime=void 0,this.logger=void 0,this.lastNetworkBannerAppearTime=null}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("auto-retry",["action-log"])),this.logger}logAction999(e){const{type:t,payload:s}=e;let i;switch(t){case"ShowManualRetry":i=dC;break;case"InteractManualRetry":i=uC;break;case"ShowBannerNetwork":i=hC}as.default.logActionInfoV2(as.FeaturesInfo.AutoRetry,i,s)}getChatTypeFromConvId(e){return ho.default.isGroup(e)?mC.CHAT_GROUP:cC.a.isSendToMe(e)?mC.MY_CLOUD:mC.CHAT_11}getRetryMsgType(e){switch(e){case R.MSG_TEXT:return gC.TEXT;case R.MSG_GIF:return gC.GIF;case R.MSG_FILE:case R.MSG_VIDEO:return gC.FILE;case R.MSG_PHOTO:case R.MSG_PHOTO_GROUP:return gC.PHOTO;case R.MSG_CONTACT:return gC.CONTACT;case R.MSG_STICKER:case R.MSG_STICKER_GROUP:case R.MSG_STICKER_2:return gC.STICKER;case R.MSG_LINK_CLIENT:return gC.LINK;default:return}}getMsgCombineType(e){return[R.MSG_PHOTO_GROUP,R.MSG_STICKER_GROUP].includes(e)?pC.GROUP:pC.SINGLE}showManualRetryReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"ShowManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),error_id:e.errorCode,is_groupping:this.getMsgCombineType(e.msgType),is_manual_btn:e.errorMessageInfo?0:1}})}networkBannerAppearCapture(){this.lastNetworkBannerAppearTime=yn.default.getTimeNow()}networkBannerDisappearReport(){const e=yn.default.getTimeNow();if(null===this.lastNetworkBannerAppearTime)return;const t=e-this.lastNetworkBannerAppearTime;t<=0||(this.logAction999({type:"ShowBannerNetwork",payload:{showed_time:this.lastNetworkBannerAppearTime,off_time:e,duration:t}}),this.lastNetworkBannerAppearTime=null)}resendErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:fC[e.source],is_resend:this.getMsgCombineType(e.msgType)===pC.GROUP?bC.RESEND_ALL:bC.RESEND_SINGLE,is_deleted:IC.NO_DELETE,action_type:vC.RESEND}})}deleteErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:fC[e.source],is_resend:bC.NO_RESEND,is_deleted:this.getMsgCombineType(e.msgType)===pC.GROUP?IC.DELETE_ALL:IC.DELETE_SINGLE,action_type:vC.DELETE}})}})||yC)||yC)||yC;i.ModuleContainer.registerSingleton(lC.a,_C);var CC,OC=s("Z1oQ"),EC=s("QbTC"),MC=s("xtzN"),SC=s("n32m"),TC=s("hKna");let wC=Object(ko.b)(SC.RetryErrorController)(CC=Reflect.metadata("design:type",Function)(CC=Reflect.metadata("design:paramtypes",[])(CC=class{constructor(){this.logger=void 0,this.errNetworkCounterMap=void 0,this.errNetworkCounterMap=new Map}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.autoRetry,["retry-error-controller"])),this.logger}getErrNetworkRetryCount(e){if(!e)return 0;const t=this.errNetworkCounterMap.get(e);if(void 0!==t)return 0===t?(this.errNetworkCounterMap.delete(e),0):t;const s=mi.default.retryConfig.max_err_network_retry_count;return this.errNetworkCounterMap.set(e,s),s}decreaseErrNetworkRetryCount(e){if(!e)return;const t=this.getErrNetworkRetryCount(e);t>0?this.errNetworkCounterMap.set(e,t-1):this.errNetworkCounterMap.delete(e)}deleteErrNetworkRetryCountItem(e){e&&this.errNetworkCounterMap.delete(e)}logRetryError(e,t){this.Logger.zsymb(18,"v5YRbf",e,t)}shouldRetry(e,t,s){if(!e||TC.a.includes(e.code))return!1;if(!TC.c.includes(e.code))return!1;const i=TC.d.NO_NETWORK_ERROR_CODE.includes(e.code);if(i&&(!mi.default.retry_err_no_network||fu.b.getStateNetwork()!==fu.a.CHECKING&&fu.b.getStateNetwork()!==fu.a.DISCONNECT))return!1;const n=this.getRetryErrorCodeGroupName(e.code);if(n&&this.getRetryErrorCodeMapping()[n].off)return!1;const a=i&&this.getErrNetworkRetryCount(s)>0;if(0===t.count&&!a)return!1;const r=this.getRetryTimeout(t);return!!(r&&yn.default.getTimeNow()-t.timestamp<r)&&(t.count&&!i&&t.count--,i&&this.decreaseErrNetworkRetryCount(s),!0)}getRetryTimeout(e){let t=0;return mi.default.retryConfig&&mi.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===R.RETRY_MSG_TIMEOUT_DEFAULT?t=mi.default.retryConfig.time_retry_default:e.timeout===R.RETRY_MSG_TIMEOUT_LONG&&(t=mi.default.retryConfig.time_retry_long)),t}getRetryErrorCodeGroupName(e){return Object.keys(TC.d).find((t=>TC.d[t].includes(e)))}getNoRetryErrorCodeGroupName(e){return Object.keys(TC.b).find((t=>TC.b[t].includes(e)))}getRetryErrorCodeMapping(){return mi.default.retryConfig.retry_strategy&&"object"==typeof mi.default.retryConfig.retry_strategy?Object.keys(mi.default.retryConfig.retry_strategy).reduce(((e,t)=>(e[t.toUpperCase()]=mi.default.retryConfig.retry_strategy[t],e)),{}):TC.e}})||CC)||CC)||CC;var RC,LC=s("yoj5");let DC=Object(ko.b)(EC.a)(RC=Reflect.metadata("design:type",Function)(RC=Reflect.metadata("design:paramtypes",[])(RC=class{constructor(){this.logger=void 0,this.waitingSocketOpenQueue=void 0,this.retryCountMapping=void 0,this.isDoneOffline=void 0,this.handleWaitingConnectionRetry=()=>{const e=[...this.waitingSocketOpenQueue];this.waitingSocketOpenQueue=[];for(const t of e){const e=LC.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.unlockProcessOffline=()=>{this.isDoneOffline=!0,MI.default.getSocketState()===TC.g.OPEN&&this.handleWaitingConnectionRetry()},this.waitingSocketOpenQueue=[],this.retryCountMapping=new Map,this.isDoneOffline=!1,Fi.default.subscribe(((e,t)=>{if(e===Ai.WebsocketActions.CONNECTION_STATE_CHANGE){const{state:e,prevState:s}=t;void 0!==s&&e===TC.g.OPEN&&this.isDoneOffline&&this.handleWaitingConnectionRetry()}})),MI.default.getChatHandler().subcribe(nd.b.ON_DONE_OFFLINE,this.unlockProcessOffline)}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("auto-retry-socket",["retry-error-controller"])),this.logger}getRetryTimeout(e){let t=0;return mi.default.retryConfig&&mi.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===R.RETRY_MSG_TIMEOUT_DEFAULT?t=mi.default.retryConfig.time_retry_default:e.timeout===R.RETRY_MSG_TIMEOUT_LONG&&(t=mi.default.retryConfig.time_retry_long)),t}getErrorCode(e){let t=e.code;return e.code===TC.f.ERR_CONNECTION_TIMED_OUT&&fu.b.getStateNetwork()!==fu.a.CONNECTED&&(t=TC.f.ERR_NO_NETWORK),t}shouldRetry(e,t,s){if(!e||!t||!s||s.count<=0)return!1;let i=this.getErrorCode(e);if(i===TC.f.ERR_CONNECTION_TIMED_OUT||i===TC.f.ERR_SOCKET_CLOSED||i===TC.f.ERR_NO_NETWORK){var n;const e=null!==(n=this.retryCountMapping.get(t))&&void 0!==n?n:0;let a=mi.default.retryConfig.max_retry_count;if(i===TC.f.ERR_SOCKET_CLOSED&&(a=mi.default.retryConfig.max_err_network_retry_count),void 0!==e&&e<a){const e=this.getRetryTimeout(s);return!!(e&&yn.default.getTimeNow()-s.timestamp<e)&&(s.count&&s.count--,!0)}return!1}return!1}pushToRetryQueue(e,t,s){const n=i.ModuleContainer.resolve(OC.a).getRetryErrorCodeMapping();this.logRetryError(e.code,s);const a=this.getErrorCode(e);if(a!==TC.f.ERR_CONNECTION_TIMED_OUT){var r;if(a===TC.f.ERR_SOCKET_CLOSED||a===TC.f.ERR_NO_NETWORK)return this.retryCountMapping.set(s,null!==(r=this.retryCountMapping.get(s))&&void 0!==r?r:1),void this.waitingSocketOpenQueue.push(t)}else{var o,l;const e=(null!==(o=this.retryCountMapping.get(s))&&void 0!==o?o:0)+1,i=(null!==(l=n.CONNECTION_TIMED_OUT_ERROR_CODE.delay)&&void 0!==l?l:3e4)*e+LC.getGapTime();setTimeout((()=>{this.retryCountMapping.set(s,e),t()}),i)}}logRetryError(e,t){this.Logger.zsymb(18,"FJy24T",e,t)}cleanUpItemQueue(e){this.retryCountMapping.delete(e)}})||RC)||RC)||RC;i.ModuleContainer.registerSingleton(OC.a,wC),i.ModuleContainer.registerSingleton(EC.a,DC),i.ModuleContainer.registerSingleton(MC.a,class{constructor(){this.waitingNetworkQueue=void 0,this.waitingCheckStatusQueue=void 0,this.waitingTimeout=void 0,this.onConnectionBack=()=>{const e=[...this.waitingNetworkQueue];this.waitingNetworkQueue=[];for(const t of e){const e=LC.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.clearWaitingStatusTimeout=()=>{null!==this.waitingTimeout&&(window.clearTimeout(this.waitingTimeout),this.waitingTimeout=null)},this.moveWaitingCheckStatusToWaitingConnection=()=>{this.clearWaitingStatusTimeout(),this.waitingNetworkQueue.push(...this.waitingCheckStatusQueue),this.waitingCheckStatusQueue=[]},this.processWaitingCheckStatus=()=>{this.clearWaitingStatusTimeout();const e=[...this.waitingCheckStatusQueue];this.waitingCheckStatusQueue=[];for(const t of e){const e=LC.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.waitingNetworkQueue=[],this.waitingCheckStatusQueue=[],this.waitingTimeout=null,rt.p.listenEvent(rt.j,(e=>{e===fu.a.CONNECTED?(this.processWaitingCheckStatus(),this.onConnectionBack()):e===fu.a.DISCONNECT&&this.moveWaitingCheckStatusToWaitingConnection()}))}pushToRetryQueue(e){fu.b.getStateNetwork()===fu.a.CONNECTED?(this.waitingCheckStatusQueue.push(e),null===this.waitingTimeout&&(this.waitingTimeout=window.setTimeout((()=>{this.waitingTimeout=null,this.processWaitingCheckStatus()}),mi.default.retryConfig.max_waiting_check_status_time))):this.waitingNetworkQueue.push(e)}});var AC=s("dhS6"),FC=s("WzIS"),jC=s("sLvT");const PC=e=>new Promise(((t,s)=>{setTimeout((()=>{t(e||3e3)}),e||3e3)}));var kC;let NC=Object(ko.b)(AC.a)(kC=Reflect.metadata("design:type",Function)(kC=Reflect.metadata("design:paramtypes",[])(kC=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.uiBannerController,[Ve.ZLoggerNametags.uiBannerQueue])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.queue=void 0,this.uiState=new Map,this.isFirtTriggerShowOnQueueCycle=void 0,this.timeoutNextBanner=void 0,this._Logger=void 0,this.name=AC.b,this.key="convId",this.queue=[],this.isFirtTriggerShowOnQueueCycle=!0,this.timeoutNextBanner=null}enBannerQueue(e,t){const s=this.queryBannerQueueItem(e.key);switch(s&&this.doRemoveBannerQueueItem(s.key),t){case FC.a.NORMAL:this.queue.push(e);break;case FC.a.HIGH:this.queue.unshift(e)}}isEmptySyncSourceQueue(){return 0===this.queue.length}deBannerQueue(){return this.queue.shift()}removeBannerQueueItem(e){this.queue=[...this.queue].filter((t=>t.key!==e))}doRemoveBannerQueueItem(e){this.removeBannerQueueItem(e),0===this.queue.length&&(this.isFirtTriggerShowOnQueueCycle=!0)}queryBannerQueueItem(e){return this.queue.find((t=>t.key===e))}handleShowUIBanner(e,t){Object(jC.b)().isEnableSingleUIBanner()?this.showSingleUI(e,t):this.showMultiUI(e,t)}isExistingShow(){try{const e=Object.fromEntries(this.uiState);for(const t in e)if(e[t])return t;return null}catch(e){return null}}async showSingleUI(e,t){let s;this.enBannerQueue({key:e,priority:t},t);const i=this.isExistingShow();if(i&&(s=this.queryBannerQueueItem(i)),Object(jC.b)().isEnableForceCloseNormalBanner()&&i&&t===FC.a.HIGH&&s)return this.uiState.set(s.key,!1),Object(hs.h)(this.name,s.key),this.uiState.set(e,!0),void Object(hs.h)(this.name,e);i||(this.uiState.set(e,!0),Object(hs.h)(this.name,e),this.Logger.zsymb(0,"RP8BXU","[showSingleUI] Dont have displaying banner so show: "+e+", current queue = "+JSON.stringify(this.queue)))}showMultiUI(e,t){this.enBannerQueue({key:e,priority:t},t),this.uiState.set(e,!0),Object(hs.h)(this.name,e)}handleHideUIBanner(e){Object(jC.b)().isEnableSingleUIBanner()?this.hideSingleUI(e):this.hideMultiUI(e)}hideSingleUI(e){this.doRemoveBannerQueueItem(e),this.uiState.get(e)&&(this.uiState.set(e,!1),Object(hs.h)(this.name,e),this.timeoutNextBanner&&clearTimeout(this.timeoutNextBanner),this.timeoutNextBanner=setTimeout((()=>{const e=this.queue[0];e&&!this.isExistingShow()&&(this.uiState.set(e.key,!0),Object(hs.h)(this.name,e.key),this.Logger.zsymb(0,"xhG1ez","[hideSingleUI] Pop next banner to show: "+e.key+", current queue = "+JSON.stringify(this.queue)))}),Object(jC.b)().getTimeDelayOnNextBanner()))}hideMultiUI(e){this.doRemoveBannerQueueItem(e),this.uiState.set(e,!1),Object(hs.h)(this.name,e)}async onShowBanner(e,t,s){s&&await PC(s);const i=Object(jC.b)().getTimeDelayOnStartApp();this.isFirtTriggerShowOnQueueCycle&&i?(await PC(i),this.handleShowUIBanner(e,t)):this.handleShowUIBanner(e,t),this.isFirtTriggerShowOnQueueCycle=!1}async onHideBanner(e,t){t&&await PC(t),this.handleHideUIBanner(e)}getBannerList(){return this.queue}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.uiState.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||kC)||kC)||kC;i.ModuleContainer.registerSingleton(AC.a,NC);var UC=s("LvDl"),BC=s.n(UC);var xC=()=>({version:1,max_num:2,enabled_banners:[{name:Hb.a.PIN_TOPIC_BANNER,on:[Hb.b.ONE_TO_ONE,Hb.b.GROUP]},{name:Hb.a.MY_CLOUD_BANNER,on:[Hb.b.MY_CLOUD]},{name:Hb.a.COMMUNITY_ENCOURAGE_BANNER,on:[Hb.b.GROUP]},{name:Hb.a.MUTE_BANNER,on:[Hb.b.GROUP,Hb.b.ONE_TO_ONE]},{name:Hb.a.STRANGER_BANNER,on:[Hb.b.ONE_TO_ONE]},{name:Hb.a.BLOCKED_BANNER,on:[Hb.b.ONE_TO_ONE]}],order_by:"desc",priority_matrix:[["6_6","6_6","5_6","6_4","6_5","6_6"],["0_0","0_0","6_6","6_5","0_0","0_0"]]});const GC=Object(i.define)("cbb-configuration");var zC;Object(i.injectable)()(zC=Object(i.singleton)(GC)(zC=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(zC=Reflect.metadata("design:type",Function)(zC=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(zC=class extends yi.ZFeatureConfig{constructor(e){super({default:xC(),valiator:new yi.ObjectValidator({version:yi.Rule.field().number().min(1),max_num:yi.Rule.field().number().min(0),enabled_banners:yi.Rule.field().array("object"),order_by:yi.Rule.field().string().oneOf(["asc","desc"]),priority_matrix:yi.Rule.field().array("object")})}),this.chatBoxBannerConfigData_=void 0,this.logger_=void 0,this.logger_=e.createZLogger(Ve.ZLoggerNametags.cbbConfiguration,[Ve.ZLoggerNametags.manageCbbConfig])}getVersion(){return this.getChatBoxBannerConfigData_().version}getOrderingType(){return this.getChatBoxBannerConfigData_().orderBy}getMaxBannerCount(){return this.getChatBoxBannerConfigData_().maxBannerCount}getEnabledBannerConfigList(){return this.getChatBoxBannerConfigData_().enabledBannerConfigs}getEnabledBannerNameList(){return this.getChatBoxBannerConfigData_().enabledBannerConfigs.map((e=>e.name))}getDefaultBannerPriorities(){return this.getChatBoxBannerConfigData_().defaultBannerPriorities}getBannerPrioritiesMatrixByFullAppearences(){return this.getChatBoxBannerConfigData_().bannerPrioritiesMatrixByFullAppearences}getChatBoxBannerConfigData(){return this.getChatBoxBannerConfigData_()}getChatBoxBannerConfigData_(){return this.chatBoxBannerConfigData_||this.updateConfig_(),this.chatBoxBannerConfigData_}updateConfig_(){this.chatBoxBannerConfigData_||(this.chatBoxBannerConfigData_={});const{version:e,enabled_banners:t,priority_matrix:s,order_by:i,max_num:n}=this.config;this.chatBoxBannerConfigData_.version=e,this.chatBoxBannerConfigData_.orderBy=i,this.chatBoxBannerConfigData_.maxBannerCount=n,this.chatBoxBannerConfigData_.enabledBannerConfigs=t.map((e=>{var t,s;return{name:null!==(t=e.name)&&void 0!==t?t:"",enabledOn:null!==(s=e.on)&&void 0!==s?s:[]}}));const a=s.reduce(((e,s)=>{if(Array.isArray(s)&&s.length===t.length){const t=s.map((e=>this.parseCellStringToMatrixCellObject_(e)));e.push(t)}return e}),[]);this.chatBoxBannerConfigData_.defaultBannerPriorities=a[0],this.chatBoxBannerConfigData_.bannerPrioritiesMatrixByFullAppearences=a.slice(1)}parseCellStringToMatrixCellObject_(e){const t={priority:0,subPriority:0};if(!e||"string"!=typeof e)return t;const s=e.split("_"),i=(e,t)=>{try{const t=parseInt(e);if(!isNaN(t))return t}catch(s){this.logger_.zsymb(18,"SBo5Xa",`[parseIntSafely]: ${s.message}`)}return t};return t.priority=i(s[0],0),t.subPriority=i(s[1],0),t}generateDefaultMatrixCellObjectArray_(e){return Array.from({length:e},(()=>({priority:0,subPriority:0})))}selector(e){return e.chat_box_banner||{}}listener(e){const t=this.selector(e);if(!t)return;if(null==t.version)return;let s=null;if(t.version!==xC().version)s=xC();else{let e="Valid"===this.options.valiator.validate(t);if(e){const s=t.enabled_banners.length;for(let i=0;i<t.priority_matrix.length;i++){if(s!==t.priority_matrix[i].length){e=!1;break}}}s=e?t:null}if(!s)return;this.shouldConfigUpdate(this.config,s)&&(this.config=s,this.updateConfig_(),this.dispatchEvent(new yi.UpdateConfigEvent(s)))}shouldConfigUpdate(e,t){return!new Be.g.Comparer(e,t,!0).AND("version").AND("max_num").AND("order_by").AND("enabled_banners",BC.a.isEqual).AND("priority_matrix",BC.a.isEqual).exec()}})||zC)||zC)||zC)||zC);const VC=Object(i.define)("cbb-app-service");var HC;Object(i.injectable)()(HC=Object(i.singleton)(VC)(HC=function(e,t){return Object(i.inject)(GC)(e,void 0,0)}(HC=Reflect.metadata("design:type",Function)(HC=Reflect.metadata("design:paramtypes",["undefined"==typeof IChatBoxBannerConfiguration?Object:IChatBoxBannerConfiguration])(HC=class{constructor(e){this.chatBoxBannerConfiguration_=void 0,this.chatBoxBannerConfiguration_=e}isBannerEnabled(e,t){const{convType:s}=t;let i=this.chatBoxBannerConfiguration_.getEnabledBannerConfigList().find((t=>t.name===e));if(!i)return!1;const{enabledOn:n}=i;return n.includes(s)||n.includes(Hb.b.ALL)}addBannerNameToBannerNameList(e,t){if(!Array.isArray(t)||t.length<=0)return[e];return this.processRawBannerNameList_([...t,e],e)}removeBannerNameFromBannerNameList(e,t){if(!Array.isArray(t)||t.length<=0)return[];if((t=t.filter((t=>t!==e))).length<=1)return t;return this.processRawBannerNameList_(t)}getMaxBannerCount(){return this.chatBoxBannerConfiguration_.getMaxBannerCount()}getVersion(){return this.chatBoxBannerConfiguration_.getVersion()}getOrderingType(){return this.chatBoxBannerConfiguration_.getOrderingType()}getChatBoxBannerConfigData(){return this.chatBoxBannerConfiguration_.getChatBoxBannerConfigData()}processRawBannerNameList_(e,t){const s={};e.forEach((e=>{s[e]=!0}));const i=this.chatBoxBannerConfiguration_.getEnabledBannerNameList(),n=this.chatBoxBannerConfiguration_.getBannerPrioritiesMatrixByFullAppearences();let a=!1,r=Array.from({length:i.length},(()=>({priority:0,subPriority:0,bannerName:Hb.a.UNKNOWN})));if(n.length>0)for(let h=0;h<n.length&&!a;h++){const e=n[h];for(let t=0;t<e.length;t++){const n=e[t],o=i[t];if(!(s[o]&&n.priority>0&&n.subPriority>0||!s[o]&&0===n.priority&&0===n.subPriority)){a=!1;break}if(r[t]=Object(f.a)(Object(f.a)({},n),{},{bannerName:o}),t===e.length-1){a=!0;break}}}if(!a){this.chatBoxBannerConfiguration_.getDefaultBannerPriorities().forEach(((e,t)=>{const n=i[t];s[n]?r[t]=Object(f.a)(Object(f.a)({},e),{},{bannerName:n}):r[t]={priority:0,subPriority:0,bannerName:Hb.a.UNKNOWN}}))}r=r.filter((e=>e.bannerName!==Hb.a.UNKNOWN&&0!==e.priority&&0!==e.subPriority));const o={};r.forEach((e=>{const s=e.priority;(!o[s]||o[s].subPriority<e.subPriority||o[s].subPriority===e.subPriority&&o[s].bannerName!==t&&e.bannerName===t)&&(o[s]=e)}));const l=Object.values(o),c="asc"===this.chatBoxBannerConfiguration_.getOrderingType()?1:-1,d=l.sort(((e,t)=>(e.priority-t.priority)*c)),u=this.chatBoxBannerConfiguration_.getMaxBannerCount();return d.slice(0,u).map((e=>e.bannerName))}})||HC)||HC)||HC)||HC);var WC=s("ShRB"),$C=s("AZMc"),KC=s("XnQq"),qC=s("eHWI");const QC=e=>{const{toggleBlock:t,reportUser:s,topBannerRef:i,pendingFriendRequest:n}=e,a=Object(qC.a)(t,n?2390304:2390104),r=Object(qC.a)(s,n?2390305:2390105);return At.a.createElement(KC.a,{status:"info",iconOptions:{name:"Block_24_Line"},titleTextKey:"STR_YOU_BLOCK_TITLE",contentTextKey:"STR_YOU_BLOCK_DESC",htmlTitle:os.a.str("STR_YOU_BLOCK_DESC"),maxContentLines:1,closable:!1,alignment:"space-between",actions:[{type:"button",variant:"neutral",textKey:"STR_UNBLOCK",onClick:a},{type:"button",variant:"secondary-danger",textKey:"STR_REPORT_USER",onClick:r}],ref:i})};var ZC=At.a.forwardRef(((e,t)=>At.a.createElement(QC,Object(xt.a)({},e,{topBannerRef:t})))),JC=s("AHNY"),YC=s("o5gc"),XC=s("sB1e");const eO=(e,t,s)=>{const[i,n]=At.a.useState(ns.default.isBlocked(t));return Object(JC.a)(((e,s)=>{switch(e){case Ai.ConversationListActions.BLOCK_CONVERSATION:s&&s.userId===t&&n(s.blocked);break;case Ai.FetchActions.STATUS_BLOCKED_CHANGED:s&&s.includes(t)&&n(ns.default.isBlocked(t))}}),[t]),At.a.useEffect((()=>{n(ns.default.isBlocked(t))}),[t]),At.a.useEffect((()=>{s&&n(s.isBlocked)}),[s]),{isBlocked:i,toggleBlock:()=>{if(fu.b.getStateNetwork()==fu.a.DISCONNECT)rs.default.createWarning(os.a.str("STR_NET_SSL_DATE_ERROR_TITLE"));else{let s=i;n(!s),ns.default.blockFriend(t,s?R.UNSET_BLOCK:R.SET_BLOCK).then((()=>{s||rs.default.createSuccess(os.a.str("STR_YOU_BLOCK_SUCCESS")),e({type:Ai.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!s,userId:t}})})).catch((()=>{n(s)}))}}}},tO=(e,t)=>At.a.useCallback(((e,t,s)=>{i.ModuleContainer.resolve(YC.d).onOpenReport(e);const n={userId:e,report:{item:s,view:R.PROFILE_INIT_MODE.REPORT_USER}};ss.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:n})}),[e,t]);var sO=s("7okM"),iO=s("+JmS");const nO=At.a.forwardRef(((e,t)=>{const{convId:s,windowId:i}=e,{isPendingFriendRequest:n}=Object(sO.g)(s),{friendInfo:a}=Object(sO.d)(s),r=Object(iO.a)(),o=tO(i,s),{toggleBlock:l}=eO(r,s,a);return At.a.createElement(ZC,{ref:t,reportUser:()=>o(s,i,{}),toggleBlock:l,pendingFriendRequest:n})}));var aO=At.a.forwardRef((function(e,t){const{convId:s,myId:n,windowId:a,pendingFriendRequest:r,friendRequestSent:o=!1,dispatch:l,toggleBlock:c,reportUser:d}=e,u=At.a.useRef(null),h=At.a.useRef(i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("messageView",["stranger-banner"])),{userRank:g,fallback:m}=((e,t,s=!1,i)=>{const[n,a]=At.a.useState(XC.f),[r,o]=At.a.useState(!1),l=At.a.useCallback((()=>{a(XC.f),o(!0)}),[]);return At.a.useEffect((()=>{let n=!1;return gh.a.getStrangerBannerInfo(e,t).then((e=>{if(!n)if(e.data_render)a(e);else switch(e.rank_type||e.userRank){case XC.e.GRAY:a(s?XC.d:XC.c);break;case XC.e.BLACK:a(s?XC.b:XC.a);break;case XC.e.WHITE:default:a(XC.f)}})).catch((e=>{i(e)})),()=>{n=!0}}),[e,t,s]),{userRank:n,fallback:r,fallbackDefault:l}})(s,n,!!r,(e=>h.current.zsymb(20,"mQbUbT","[error get rank user] "+(null==e?void 0:e.err_msg)))),[,p]=At.a.useState(!1);At.a.useEffect((()=>{r&&i.ModuleContainer.resolve(yh.c).onSeenBannerFriendRequest(s)}),[r,s]);const f=Object(qC.a)((()=>{d()}),r?2390306:2390106,r?7:3,{rank:g.rank_type}),v=Object(qC.a)((e=>{const t=e[0];u&&u.current&&u.current.show(t,t.target),t.preventDefault(),t.stopPropagation()}),r?2390302:2390102),b=Object(qC.a)(At.a.useCallback((()=>{i.ModuleContainer.resolve(uh.b).acceptFriendRequest(s,a)}),[s]),2390301,5,{rank:g.rank_type}),I=At.a.useCallback(((e,t)=>{Li.a.setFriendRequestSource(e,R.FRIEND_REQUEST_SRC_CHAT,{uidTo:e}),gh.a.doAddFriend(e,R.FRIEND_REQUEST_SRC_CHAT,t,a)}),[]),y=Object(qC.a)((()=>{I(s,l)}),2390101,r?7:1,{rank:g.rank_type}),_=Object(qC.a)((()=>{c()}),r?2390303:2390103,r?6:2,{rank:g.rank_type}),C=At.a.useCallback((e=>{e.preventDefault(),e.stopPropagation(),Ko.ConfirmManagerV2.openConfirm({windowId:a,name:R.MODAL_CONFIRM.confirmIdentities,params:{title:os.a.str("STR_CONTACT_TAB_TITLE_RECALL_REQ"),message:os.a.str("STR_CONTACT_TAB_CONFIRM_RECALL_REQ"),okText:os.a.str("STR_CONTACT_TAB_OKE_TEXT_RECALL_REQ"),cancelText:os.a.str("STR_CONTACT_TAB_CANCEL_TEXT_RECALL_REQ"),okType:"danger",cancelType:"neutral",onOk:()=>{i.ModuleContainer.resolve(yh.o).onRemoveFriendSent({userId:s})}}})}),[s]),O=At.a.useCallback((()=>p((e=>!e))),[]);var E;E=O,At.a.useEffect((()=>(os.a.callUpdate(E),()=>{os.a.removeUpdate(E)})),[]);const M=At.a.useMemo((()=>({block:{textKey:"STR_BLOCK_USER",onclick:_},report:{textKey:"STR_REPORT_USER",onclick:f}})),[s,a,!!r]),S=[];g.data_render&&g.data_render.menu&&Array.from(Object.keys(g.data_render.menu)).forEach((e=>{var t,s;!g.data_render.menu[e].show||g.data_render.buttons&&null!==(t=g.data_render)&&void 0!==t&&null!==(s=t.buttons[e])&&void 0!==s&&s.show||S.push(M[e])}));let T="",w="";const L=os.a.getCurrentLanguageName();g.data_render&&(g.data_render.title&&g.data_render.title.vi&&(T=g.data_render.title[L]),g.data_render.desc&&g.data_render.desc.vi&&(w=g.data_render.desc[L]));const D=e=>At.a.createElement(T_.default,{popoverProps:{identity:{windowId:a,name:R.PopoverIdentitiesDefine.CHAT_BOX_LIST_1},placement:"bottom-right",deltaPosition:{top:"8px",left:"5px"}},ref:u,items:e});let A=null;if(g.rank_type===XC.e.WHITE||m)if(o)A=At.a.createElement(KC.a,{status:"info",iconOptions:{name:"FriendReq_24_Line"},closable:!1,contentTextKey:"STR_PROFILE_FRIEND_REQ_SENT",alignment:"start",maxContentLines:1,ref:t});else{let e="btn_Chat_AddFrd",s="AddUser_24_Line",i="STR_PROFILE_ADD_FRIEND_LONG";r&&(e="btn_Chat_AcceptFrdReq",s="FriendReq_24_Line",i="STR_FRIEND_REQ_ACCEPT_DESC"),A=At.a.createElement(At.a.Fragment,null,At.a.createElement(KC.a,{status:"info",iconOptions:{name:s},contentTextKey:i,"data-id":e,closable:!1,maxContentLines:1,alignment:"space-between",actions:[{type:"button",variant:r?"secondary":"neutral",textKey:r?"STR_ACCEPT":"STR_FRIEND_REQ_SEND",onClick:r?b:y},{type:"button",variant:"tertiary-neutral",icon:"More_24_Line",onClick:v}],ref:t}),D(Object.values(M)))}else{var F,j;let e="STR_FRIEND_REQ_SEND",s=y;o?(e="STR_UNDO_REQUEST",s=C):r&&(e="STR_ACCEPT",s=b);const i=[];i.push({textKey:e,onClick:s,type:"button",variant:(null===(F=g.data_render.buttons)||void 0===F||null===(j=F.add)||void 0===j?void 0:j.type)||"neutral"}),g.data_render.buttons.block&&g.data_render.buttons.block.show&&i.push({textKey:"STR_BLOCK_STRANGER_BANNER",onClick:_,type:"button",variant:g.data_render.buttons.block.type||"neutral"}),g.data_render.buttons.report&&g.data_render.buttons.report.show&&i.push({textKey:"STR_REPORT_USER",onClick:f,type:"button",variant:g.data_render.buttons.report.type||"secondary-danger"}),S.length&&i.push({type:"button",variant:"tertiary-neutral",icon:"More_24_Line",onClick:v}),A=At.a.createElement(At.a.Fragment,null,At.a.createElement(KC.a,{status:"info",iconOptions:{name:"Warning_Circle_24_Line"},titleTextKey:T,contentTextKey:w,maxContentLines:1,closable:!1,actions:i,alignment:"space-between",ref:t}),S.length?D(S):null)}return A}));const rO=e=>e.user.userId,oO=At.a.forwardRef(((e,t)=>{const{windowId:s,convId:i}=e,{friendInfo:n}=Object(sO.d)(i),{isPendingFriendRequest:a}=Object(sO.g)(i),{isFriendRequestSent:r}=Object(sO.f)(i),o=Object(iO.a)(),l=tO(s,i),{toggleBlock:c}=eO(o,i,n),d=Object(Gt.g)(rO);return At.a.createElement(aO,{ref:t,reportUser:()=>l(i,s,{}),convId:i,myId:d,windowId:s,toggleBlock:c,pendingFriendRequest:a,friendRequestSent:r,dispatch:o})}));var lO=s("lCMA");const cO=At.a.forwardRef(((e,t)=>{const{convId:s}=e,{startTime:i,duration:n}=Object(hs.m)(jo.MuteDataManager,s,(e=>e?{startTime:e.startTime,duration:e.duration}:{startTime:0,duration:-1})),a=At.a.useMemo((()=>ho.default.getHMTime(i,n)||""),[i,n]),r=a?`${os.a.str("STR_MUTE_TIME_LIMIT_V2")} ${a}`:`${os.a.str("STR_MUTE_TIME_LIMIT_FULL_V2")}`;return At.a.createElement(KC.a,{ref:t,className:"mute-banner",htmlTitle:r,maxContentLines:1,status:"info",iconOptions:{name:"Notif_Off_24_Line"},alignment:"space-between",content:a?At.a.createElement(At.a.Fragment,null,At.a.createElement(lO.a,{textKey:"STR_MUTE_TIME_LIMIT_V2"})," ",` ${a}`):At.a.createElement(lO.a,{textKey:"STR_MUTE_TIME_LIMIT_FULL_V2"}),actions:[{onClick:()=>(e=>{Co.a.MuteDataManager.onUnMute(e),as.default.logAction(1065101)})(s),textKey:"STR_REOPEN_0",type:"button",variant:"secondary"}],closable:!1})}));var dO=s("YCoq"),uO=s("17x9"),hO=s.n(uO),gO=s("iuhU"),mO=s("dRu9"),pO=s("2pdp"),fO=s("v/qp"),vO=s("yh7P"),bO=s("n39p");const IO=function(e){const{conversationId:t,textContent:s="",hasCollapseButton:i}=e;let n=null;return i&&(n=At.a.createElement(fO.a,{className:"collapse-button-container",onClick:e=>{e&&e.stopPropagation(),Object(ju.c)(bO.a.PinBoard.COLLAPSE_BY_CLICK_BUTTON),vO.a.getInstance(t).collapseBoard()},textKey:"STR_COLLAPSE",postIcon:"Chevron_Up_24_Line",size:"small",type:"tertiary-neutral"})),At.a.createElement("div",{className:"title-container"},At.a.createElement(lO.a,{className:"title-content",textKey:`${s}`}),n)};IO.propTypes={conversationId:hO.a.string,textContent:hO.a.string.isRequired,hasCollapseButton:hO.a.bool};var yO=IO;const _O=function(e){const{topic:t={},hasCollapseButton:s}=e;return At.a.createElement(At.a.Fragment,null,t?At.a.createElement("div",{className:"upcoming"},At.a.createElement(yO,{textContent:"Sắp diễn ra",hasCollapseButton:s}),At.a.createElement(pO.a,{windowId:e.windowId,topic:t,isShowFullTime:!0})):null)};_O.propTypes={topic:hO.a.object,hasCollapseButton:hO.a.bool};var CO=_O,OO=s("vA3+"),EO=s("c7k8"),MO=s("YbZ6"),SO=s("1CKO");const TO=function(e){const{conversationId:t,topics:s=[],hasUpcoming:i}=e,{selfWindow:n}=Object(SO.a)(),[a,r]=Object(Dt.useState)(n.innerHeight),o=Object(Dt.useRef)(),l=Object(Dt.useRef)(),c=Object(Dt.useRef)(),d=Object(Dt.useCallback)((()=>{var e;null===(e=o.current)||void 0===e||e._onResize()}),[o.current]),u=Object(Dt.useCallback)(Object(MO.a)((()=>{const e=n.innerHeight;e&&r(e)}),150),[n.innerHeight]),h=Object(Dt.useCallback)((()=>{vO.a.getInstance(t).closePopover()}),[]);Object(Dt.useEffect)((()=>(n.addEventListener("resize",d),n&&o&&(c.current=o.current._parentNode,l.current=new n.ResizeObserver(d),l.current.observe(c.current)),()=>{n.removeEventListener("resize",d),c.current&&l.current.unobserve(c.current)})),[n]);let g=[];for(let f=0;f<s.length;f++){const i=s[f];i&&g.push(At.a.createElement(pO.a,{windowId:e.windowId,conversationId:t,key:f,topic:i,index:f,isShowFullTime:i.startTime>0,size:bO.i.LARGE,mode:bO.h.EXPAND}))}const m=s.length*bO.b,p=Object(ju.f)(a,i);return At.a.createElement("div",{className:"board-list",style:{maxHeight:p,height:m}},At.a.createElement(EO.a,{onResize:u,ref:o},(({width:e,height:t})=>At.a.createElement(OO.c,{onScroll:h,noVScroll:!1,noHScroll:!0,autoHide:!0,style:{width:e+1,height:t+2}},At.a.createElement("div",{tabIndex:"100"},g)))))};TO.propTypes={conversationId:hO.a.string,topics:hO.a.array.isRequired,hasUpcoming:hO.a.bool};var wO=TO,RO=s("AbDx"),LO=s("zRkS");const DO=function(e){const{conversationId:t}=e,s=Object(RO.a)(Object(iO.b)(),t);return At.a.createElement("div",{className:"view-all-board-container",onClick:e=>{Object(ju.c)(bO.a.PinBoard.CLICK_VIEW_ALL_GROUP_BOARD),vO.a.getInstance(t).closePopover(),s.emit(Ai.GeneralActions.OPEN_MEDIA_BOARD,{type:Ai.GeneralActions.OPEN_GROUP_BOARD_ALL,uid:t}),vO.a.getInstance(t).collapseBoard(),e&&(e.preventDefault(),e.stopPropagation())}},At.a.createElement("div",{className:"view-all-board-content"},At.a.createElement(lO.a,{className:"view-all-board-text-content",textKey:xh.a.get("STR_VIEW_ALL_IN_BOARD",t)}),At.a.createElement(LO.a,{icon:"Chevron_Right_24_Line",className:"view-all-board-icon"})))};DO.propTypes={conversationId:hO.a.string};var AO=DO;function FO(e,t){const{conversationId:s,topics:i=[],upcomingEvent:n}=e,a=i;let r=null;return Object(dO.i)()&&n&&(r=At.a.createElement(CO,{windowId:e.windowId,topic:n,hasCollapseButton:!0})),At.a.createElement("div",{ref:t,className:"topic-board-details"},r,At.a.createElement(yO,{conversationId:s,textContent:os.a.trans("STR_PIN_BOARD",[a.length]),hasCollapseButton:!r}),At.a.createElement(wO,{windowId:e.windowId,conversationId:s,topics:a,hasUpcoming:!!r}),At.a.createElement(AO,{conversationId:s}))}const jO=At.a.forwardRef(FO);jO.propTypes={conversationId:hO.a.string,topics:hO.a.array.isRequired,upcomingEvent:hO.a.object};var PO=jO,kO=s("Cl2u");const NO="topic-board-details-wrapper",UO={Block:NO,Modifiers:{Transitioning:"--"},Elements:{Overlay:`${NO}__overlay`}},BO=e=>{var t;const{selfWindow:s}=Object(SO.a)(),i=null!==(t=s.document.getElementById("messageView"))&&void 0!==t?t:s.document.body,n=At.a.useRef(null);return At.a.createElement(mO.d,{nodeRef:n,in:e.show,appear:!0,unmountOnExit:!0,addEndListener:e=>{var t;null===(t=n.current)||void 0===t||t.addEventListener("transitionend",e,!1)}},(t=>jt.a.createPortal(At.a.createElement("div",{className:Object(gO.a)(UO.Block,e.className,`${UO.Modifiers.Transitioning}${t}`)},At.a.createElement(kO.a,{nodeRef:n,state:t},((t,s)=>At.a.createElement(PO,{ref:s,windowId:e.windowId,conversationId:e.convId,topics:e.topics,dispatch:e.dispatch,upcomingEvent:e.upcomingEvent}))),At.a.createElement("div",{className:UO.Elements.Overlay,onClick:e.onCollapse})),i)))};const xO=function(e){const{conversationId:t,topic:s,numberOfMoreTopics:i,hasUnread:n,isHighlighted:a}=e;return At.a.createElement("div",{className:"chat-group-topic__preview"},At.a.createElement("div",null,At.a.createElement(pO.a,{windowId:e.windowId,conversationId:t,topic:s,isInPreview:!0,numberOfMoreTopics:i,hasUnread:n,size:bO.i.LARGE,mode:bO.h.PREVIEW,isHighlighted:a,index:-1,isShowFullTime:!0,emitter:e.emitter})))};xO.propTypes={conversationId:hO.a.string,topic:hO.a.object.isRequired,numberOfMoreTopics:hO.a.number,hasUnread:hO.a.bool,isHighlighted:hO.a.bool};var GO=xO,zO=s("kQ1Y"),VO=s("Lqdh");const HO="Preview",WO="Details";function $O(e,t){const{conversationId:s,topics:i=[],upcomingEvent:n,dispatch:a=(()=>{}),confirm:r=(()=>{}),settings:o={}}=e;if(0===(null==i?void 0:i.length)&&!n)return null;const[l,c]=Object(Dt.useState)(HO),[d,u]=Object(Dt.useState)(!1),h=()=>{c(HO)},g=()=>{var e;const t=null===(e=Fu.a.getInstance(s).getConversation())||void 0===e?void 0:e.userId;Fu.a.getInstance(s).fetchTopicsOnOpenBoardDetails(t);c(WO)},m=e=>{u(e)},p=e=>{var t;if(l===HO)return;let s=!0;null!=e&&null!==(t=e.detail)&&void 0!==t&&t.from&&"PopoverButton"===e.detail.from&&(s=!1),s&&(Object(ju.c)(bO.a.PinBoard.COLLAPSE_BY_CLICK_OUTSIDE),h())};function f(){return e.selfWindow||window}Object(Dt.useEffect)((()=>{zO.a.setDispatch(s,a),zO.a.setConfirm(s,r),zO.a.setCollapse(s,h),zO.a.setExpandBoard(s,g),zO.a.setToggleHighlightPreview(s,m);const e=VO.default.registerFunc(R.K_ESC,(()=>{Object(ju.c)(bO.a.PinBoard.COLLAPSE_BY_ESC),h()}));return()=>{VO.default.unregister(R.K_ESC,e),zO.a.removeCallbacks(s)}}),[s]),Object(Dt.useEffect)((()=>(f().addEventListener("click",p),()=>{f().removeEventListener("click",p)})),[l]),Object(Dt.useEffect)((()=>{vO.a.getInstance(s).callUpdateComp()}),[o]);const v=Object(ju.g)(i)||n,b=null!=i&&i.length?i.length-1:0,I=Object(ju.l)(i);return At.a.createElement(_s.a,null,At.a.createElement("div",{className:"chat-group-topic",onClick:e=>{e&&e.stopPropagation()},ref:t},At.a.createElement(GO,{windowId:e.windowId,conversationId:s,topic:v,numberOfMoreTopics:b,dispatch:a,confirm:r,hasUnread:I,isHighlighted:d,emitter:e.emitter}),At.a.createElement(BO,{show:l===WO,windowId:e.windowId,convId:s,topics:i,dispatch:a,upcomingEvent:n,onCollapse:h})))}const KO=Object(Dt.forwardRef)($O);KO.propTypes={conversationId:hO.a.string,topics:hO.a.array.isRequired,upcomingEvent:hO.a.object,dispatch:hO.a.func,confirm:hO.a.func,settings:hO.a.object};var qO=KO,QO=s("medu"),ZO=s("Ssn2");const JO=At.a.forwardRef(((e,t)=>{const{convId:s,windowId:i,confirm:n}=e,{selfWindow:a}=Object(SO.a)(),r=Object(Dt.useMemo)((()=>Object(ZO.a)(s)),[s]),o=Au.a.getTopics(s),{groupInfo:l}=Object(sO.e)(s),c=Object(iO.a)(),d=Object(iO.b)();let u=null;if(r){let e=!1,r=null;var h;if(o.length>0)e=!0;else if(Object(dO.i)())r=Fu.a.getInstance(s).getUpcomingEvent(),null!==(h=r)&&void 0!==h&&h.id&&(e=!0);e&&(u=At.a.createElement(_s.a,null,At.a.createElement("div",{ref:t,className:"chat-group-topic-outer"},At.a.createElement(qO,{key:s,confirm:n,conversationId:s,dispatch:c,emitter:d,selfWindow:a,settings:null==l?void 0:l.setting,upcomingEvent:r,topics:o,windowId:i}))))}else u=At.a.createElement(QO.b,{key:s,ref:t,conversationId:s,dispatch:c});return u}));var YO=s("Sn9s");const XO=At.a.forwardRef(((e,t)=>{const s=Object(hs.m)(jl.e,e.convId);return At.a.createElement(YO.e,{ref:t,windowId:e.windowId,position:jl.f.CHAT_BOX,type:null==s?void 0:s.bannerStatus.type,groupId:e.convId})}));var eE=s("YbKq"),tE=s("85uQ"),sE=s("Ilka"),iE=s("FLoU"),nE=s("Ov6d"),aE=s("/1VS"),rE=s("93l+"),oE=s("KJYm"),lE=s("4ZGW");const cE=At.a.forwardRef(((e,t)=>{const{windowId:s,convId:i}=e,{status:n,showBanner:a,dismissBanner:r}=Object(rE.a)();let{usage:o=0,quota:l=0}=Object(lE.a)()||{usage:0,quota:0};const c=Math.round(o/l*100),d=ho.default.sizeToStringV2(l-o),u=At.a.useMemo((()=>Math.pow(Object(sE.d)(),2)),[]);At.a.useEffect((()=>{a&&(n===tE.a.NEARY_FULL?oE.a.logViewMyCloudBanner({quota_warning_name:"yellow"}):n===tE.a.FULL?oE.a.logViewMyCloudBanner({quota_warning_name:"full"}):n===tE.a.ALMOST_FULL&&oE.a.logViewMyCloudBanner({quota_warning_name:"red"}))}),[n,a]);const h={source:iE.b.CSC,mycloud_size:o/u};function g(){Object(nE.a)(s),aE.a.getInstance().loadMyCloudMessagesInBackground(),function(){let e;const t=E.default.getInstance(),s="1st_cl_tool";t.getItemForCurrentUser(s)||(e=(new Date).toLocaleDateString("fr-CA").replaceAll("-",""),t.setItemForCurrentUser(s,e))}(),oE.a.logClickBannerButtons()}function m(){r()}return(e=>{let s,i,n,a,r,o,l="info",u=!1;switch(e){case tE.a.NEARY_FULL:s=eE.a.NEARLY,i="STR_CLOUD_BANNER_NEARLY_FULL_TITLE",n="STR_CLOUD_BANNER_NEARLY_FULL_DESC",a="STR_CLOUD_MANAGE_DATA",u=!0,r=[c,ns.default.getDName(mi.default.sendToMeId)],o=[ns.default.getDName(mi.default.sendToMeId)],h.warning=iE.d.YELLOW,l="warning";break;case tE.a.ALMOST_FULL:s=eE.a.ALMOST,i="STR_CLOUD_BANNER_ALMOST_FULL_TITLE",n="STR_CLOUD_BANNER_ALMOST_FULL_DESC",a="STR_CLOUD_MANAGE_DATA",r=[d,ns.default.getDName(mi.default.sendToMeId)],h.warning=iE.d.RED,l="error";break;case tE.a.FULL:s=eE.a.FULL,i="STR_CLOUD_BANNER_FULL_TITLE",n="STR_CLOUD_BANNER_FULL_DESC",a="STR_CLOUD_MANAGE_DATA",r=[ns.default.getDName(mi.default.sendToMeId)],h.warning=iE.d.FULL,l="error";break;default:return null}return At.a.createElement(At.a.Fragment,null,At.a.createElement(KC.a,{ref:t,className:"cloud-banner",titleTextKey:i,titleArgs:r,contentTextKey:n,contentArgs:o,status:l,iconOptions:{name:"warning-24"},alignment:"space-between",actions:a?[{onClick:g,textKey:a,type:"button",variant:"outline-tertiary-neutral"}]:void 0,closable:u,onClose:m}))})(n)}));var dE=s("ZSw7");class uE{constructor(){this.version=void 0}render(e,t){return this.checkIfShouldShowBannersOrNot(e),this.createChatBoxBannerView(e,t)}checkIfShouldShowBannersOrNot(e){const{convId:t,windowId:s}=e;var n;Object(Dt.useEffect)((()=>{const e=i.ModuleContainer.resolve($C.a).getBannerManagers();if(e.length>0){const n=i.ModuleContainer.resolve(Wb.a);e.forEach((e=>{e.checkShowMyBanners(t,s).forEach((e=>{e.shouldShow?n.requestShowBanner(e.bannerName,{convId:t}):n.requestHideBanner(e.bannerName,{convId:t})}))}))}}),[t,s]),(e=>{const{friendInfo:t}=Object(sO.d)(e),{isBlocked:s}=eO((()=>{}),e,t),n=Object(Dt.useMemo)((()=>Object(ZO.a)(e)),[e]);Object(Dt.useEffect)((()=>{const a=i.ModuleContainer.resolve(Wb.a);0!==mi.default.block_msg_call_setting.enable_block_msg_call_setting||!s||n||ho.default.isOAType(t)?a.requestHideBanner(Hb.a.BLOCKED_BANNER,{convId:e}):a.requestShowBanner(Hb.a.BLOCKED_BANNER,{convId:e})}),[s,e,t])})(t),(e=>{const{friendInfo:t}=Object(sO.d)(e),{isBlocked:s}=eO((()=>{}),e,t);Object(Dt.useEffect)((()=>{if(t){const{isFr:n,type:a}=t,r=!n&&a===R.FRIEND_TYPE_NORMAL,o=i.ModuleContainer.resolve(Wb.a);r&&!s?o.requestShowBanner(Hb.a.STRANGER_BANNER,{convId:e}):o.requestHideBanner(Hb.a.STRANGER_BANNER,{convId:e})}}),[e,s,t])})(t),n=t,Object(Dt.useEffect)((()=>{const e=Object(ZO.a)(n);if(e){const e=ns.default.getUidMe();Fu.a.getInstance(n).changeConversation(n,e)}else Yv.j.GetUIManager().loadAndRegisterToDisplayBanner(n);return()=>{e&&Fu.a.freeInstance(n)}}),[n]),(e=>{const t=Object(hs.m)(jo.MuteDataManager,e);At.a.useEffect((()=>{let s=!1,n=!1,a=null,r=!1;if(t&&-1==t.duration&&Object(dE.a)().hide_endless_mute_banner_after_seconds>=0){const s=1e3*Object(dE.a)().hide_endless_mute_banner_after_seconds-(Date.now()-1e3*t.startTime);s>0?a=setTimeout((()=>{const t=i.ModuleContainer.resolve(Wb.a),s={convId:e};t.requestHideBanner(Hb.a.MUTE_BANNER,s)}),s):r=!0}n=r,s=!!t&&!n;const o=i.ModuleContainer.resolve(Wb.a),l={convId:e};return s?o.requestShowBanner(Hb.a.MUTE_BANNER,l):o.requestHideBanner(Hb.a.MUTE_BANNER,l),()=>{a&&clearTimeout(a)}}),[t,e])})(t),(e=>{const t=Object(hs.m)(jl.e,e);At.a.useEffect((()=>{var s;const n=Object(ZO.a)(e)&&mi.default.group_privacy.community.enable_upgrade&&(null==t?void 0:t.bannerStatus.show)&&(null===(s=t.bannerStatus.position)||void 0===s?void 0:s.has(jl.f.CHAT_BOX)),a=i.ModuleContainer.resolve(Wb.a),r={convId:e};n?a.requestShowBanner(Hb.a.COMMUNITY_ENCOURAGE_BANNER,r):a.requestHideBanner(Hb.a.COMMUNITY_ENCOURAGE_BANNER,r)}),[t,e])})(t),(e=>{const{showBanner:t}=Object(rE.a)();Object(Dt.useEffect)((()=>{const s=i.ModuleContainer.resolve(Wb.a);t?s.requestShowBanner(Hb.a.MY_CLOUD_BANNER,{convId:e}):s.requestHideBanner(Hb.a.MY_CLOUD_BANNER,{convId:e})}),[e,t])})(t)}}class hE extends uE{constructor(...e){super(...e),this.version=1}createChatBoxBannerView(e,t){return At.a.createElement(gE,Object(xt.a)({ref:t},e))}}const gE=At.a.memo(At.a.forwardRef(((e,t)=>{const{convId:s,windowId:i,chatBoxBannerState:n,confirm:a}=e,r=At.a.useRef(null),{chatBoxBannerObjectPool:o}=Object(sO.a)();At.a.useImperativeHandle(t,(()=>({getChatBoxBannerHeight:()=>{var e,t;return null!==(e=null===(t=r.current)||void 0===t?void 0:t.clientHeight)&&void 0!==e?e:0}})),[]);const l=null==n?void 0:n.bannerNameList;return null!=l&&l.length?At.a.createElement("div",{ref:r,className:"list-chat-box-banner"},At.a.createElement("div",{className:"list-chat-box-banner__content"},l.map((e=>o.getBannerComponent(e,{windowId:i,convId:s,confirm:a}))))):null})));var mE;Object(i.injectable)()(mE=Object(i.singleton)(WC.a)(mE=class{constructor(){this._bannerManagerContainer=new Map,this._isLoadedBannerManagers=!1}getBannerComponent(e,t,s){let i=null;switch(e){case Hb.a.PIN_TOPIC_BANNER:i=At.a.createElement(JO,{key:e,ref:s,windowId:t.windowId,convId:t.convId,confirm:t.confirm});break;case Hb.a.MUTE_BANNER:i=At.a.createElement(cO,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case Hb.a.BLOCKED_BANNER:i=At.a.createElement(nO,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case Hb.a.STRANGER_BANNER:i=At.a.createElement(oO,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case Hb.a.COMMUNITY_ENCOURAGE_BANNER:i=At.a.createElement(XO,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case Hb.a.MY_CLOUD_BANNER:i=At.a.createElement(cE,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;default:i=null}return null==i&&zconsole.zsymb(18,"57t-Cc",`[getBannerComponent] ${e} is null!`),i}getChatBoxBannerFactory(){return new hE}getBannerManagers(){const e=Array.from(this._bannerManagerContainer.values());return e.length||this._isLoadedBannerManagers?e:(this._loadBannerManagers(),this.getBannerManagers())}_loadBannerManagers(){this._isLoadedBannerManagers||(this._isLoadedBannerManagers=!0)}})||mE);var pE,fE=s("QCfS"),vE=s("l9M7");Object(i.singleton)(fE.b)(pE=Object(ko.b)(fE.b)(pE=function(e,t){return Object(i.inject)(VC)(e,void 0,0)}(pE=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(pE=Reflect.metadata("design:type",Function)(pE=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(pE=class{constructor(e,t){this.type=void 0,this.key=fE.a,this.name=fE.a,this.chatBoxBannerUIStateMap_=new Map,this.requestingBannerNameListMap_=new Map,this.chatBoxBannerAppService_=void 0,this.logger_=void 0,this.chatBoxBannerAppService_=e,this.logger_=t.createZLogger(Ve.ZLoggerNametags.cbbManager,[Ve.ZLoggerNametags.manageCbbUiState])}init(){}getItem(e,t){if(e.key&&Object(vE.b)(e.key)){return this.getChatBoxBannerUIState_(e.key)}}getList(e,t){return[]}onGetItemFailure(e,t){this.logger_.zsymb(21,"GST2zI",["[onGetItemFailure] key: {}, error: {}","-vkCD8"],e,t.message)}onGetListFailure(e,t){this.logger_.zsymb(21,"A-f6b_",["[onGetListFailure] key: {}, error: {}","8kfggI"],e,t.message)}isBannerDisplaying(e,t){if(!t){const e=`[isBannerDisplaying] Invalid required parameter convId: ${t}.`;return this.logger_.zsymb(0,"aAfdVx",e),!1}const s=Object(vE.a)(t);return this.getChatBoxBannerUIState_(s).bannerNameList.includes(e)}requestShowBanner(e,t){const s=t.convId;if(!s){const e=`[requestShowBanner] Invalid required parameter convId: ${s}.`;return this.logger_.zsymb(0,"_0kxQ1",e),!1}return this.processShowBanner_(e,s)}requestHideBanner(e,t){const s=t.convId;if(s)this.processHideBanner_(e,s);else{const e=`[requestHideBanner] Invalid required parameter convId: ${s}.`;this.logger_.zsymb(0,"Hy2RZZ",e)}}createDefaultChatBoxBannerUIState_(){return{lastModifiedTime:Date.now(),bannerNameList:[]}}getConvType_(e){return e?e===mi.default.sendToMeId?Hb.b.MY_CLOUD:e.startsWith("g")?Hb.b.GROUP:Hb.b.ONE_TO_ONE:Hb.b.UNKNOWN}processShowBanner_(e,t){const s={convType:this.getConvType_(t)};if(!this.chatBoxBannerAppService_.isBannerEnabled(e,s))return this.logger_.zsymb(3,"r_szXP",["[processShowBanner_] {} is not enabled.","M6XFO1"],e),!1;if(!this.isBannerDisplaying(e,t)){const s=Object(vE.a)(t),i=this.getChatBoxBannerUIState_(s),n=this.getRequestingBannerNameList_(s),a=Object(kg.a)(i,(t=>{const s=this.chatBoxBannerAppService_.addBannerNameToBannerNameList(e,[...n]);t.bannerNameList=s,t.lastModifiedTime=Date.now()}));this.chatBoxBannerUIStateMap_.set(s,a),Object(hs.h)(this.name,s)}return this.refreshRequestingBannerInList_(e,t,"add_new"),!0}refreshRequestingBannerInList_(e,t,s){const i=Object(vE.a)(t);const n=this.getRequestingBannerNameList_(i).filter((t=>t!==e));"add_new"===s&&n.push(e),this.requestingBannerNameListMap_.set(i,n)}processHideBanner_(e,t){const s={convType:this.getConvType_(t)};if(this.chatBoxBannerAppService_.isBannerEnabled(e,s)){if(this.isBannerDisplaying(e,t)){const s=Object(vE.a)(t),i=this.getRequestingBannerNameList_(s),n=this.getChatBoxBannerUIState_(s),a=Object(kg.a)(n,(t=>{const s=this.chatBoxBannerAppService_.removeBannerNameFromBannerNameList(e,[...i]);t.bannerNameList=s,t.lastModifiedTime=Date.now()}));this.chatBoxBannerUIStateMap_.set(s,a),Object(hs.h)(this.name,s)}this.refreshRequestingBannerInList_(e,t,"remove")}else this.logger_.zsymb(3,"WT9F-E",["[processHideBanner_] {} is not enabled.","_XfEHz"],e)}getChatBoxBannerUIState_(e){let t=this.chatBoxBannerUIStateMap_.get(e);return t||(t=this.createDefaultChatBoxBannerUIState_(),this.chatBoxBannerUIStateMap_.set(e,t)),t}getRequestingBannerNameList_(e){let t=this.requestingBannerNameListMap_.get(e);return t||(t=[],this.requestingBannerNameListMap_.set(e,t)),t}getChatBoxBannerUIState(e){const t=Object(vE.a)(e);return this.getChatBoxBannerUIState_(t)}getRequestingChatBoxBanners(e){const t=Object(vE.a)(e);return this.getRequestingBannerNameList_(t)}getShowingChatBoxBanners(e){const t=Object(vE.a)(e);return this.getChatBoxBannerUIState_(t).bannerNameList}getChatBoxBannerConfigData(){return this.chatBoxBannerAppService_.getChatBoxBannerConfigData()}})||pE)||pE)||pE)||pE)||pE);var bE,IE=s("ZEj3"),yE=s("pqQ2"),_E=s("1Pg6"),CE=s("0NOU");Object(ko.b)(_E.a)(bE=Reflect.metadata("design:type",Function)(bE=Reflect.metadata("design:paramtypes",[])(bE=class extends IE.a{constructor(){super(yE.a,yE.b),this.key=void 0,this.key=yE.a}startDownloadProgress(e,t){this.updateItem((e=>{e.isDownloading=!0,e.progress=0,e.entry=t}),e)}updateProgress(e,t){this.updateItem((e=>{e.isDownloading=!0,e.progress=Math.min(Math.max(t,0),100)}),e)}completeDownloadProgress(e){this.removeDownloadProgress(e)}handleAfterDownloadError(e){this.removeDownloadProgress(e)}removeDownloadProgress(e){this.removeItem(e)}getDownloadInfo(e){return this.getItem({key:e,version:0,extraData:{}},{})}getDownloadInfoByMessage(e){const t=Object(CE.a)(e);return this.getItem({key:t,version:0,extraData:{}},{})}isDownloading(e){var t;const s=this.getItem({key:e,version:0,extraData:{}},{});return null!==(t=null==s?void 0:s.isDownloading)&&void 0!==t&&t}})||bE)||bE);var OE=s("kZZr"),EE=s("VteK"),ME=s("zNPY"),SE=s("UwMY"),TE=s("bWos"),wE=s("/YHU");class RE{constructor(e){var t,s,i,n,a,r;this.noiseId=void 0,this.zCloudKey=void 0,this.size=void 0,this.ts=void 0,this.extraInfo=void 0,this.message=void 0,this.isDuplicated=void 0,this.noiseId=e.noiseId,this.zCloudKey=TE.a.getZCloudKeyFromCloudItem(e),this.size=e.mediaInfo.mediaSize,this.ts=e.msgInfo.ts,this.isDuplicated=e.isDuplicated||!1;const o=(null==e||null===(t=e.msgInfo)||void 0===t?void 0:t.destId)==mi.default.sendToMeId?null===(s=e.mediaInfo)||void 0===s||null===(i=s.mediaExtInfo)||void 0===i?void 0:i.data:null===(n=e.mediaInfo)||void 0===n||null===(a=n.mediaExtInfo)||void 0===a?void 0:a.decryptedData;if(o){const e=Object(wE.a)(o);e&&(this.extraInfo={title:e.title,thumbUrl:e.thumbUrl,params:o})}const l=ho.default.normalizeMessageType(e.msgInfo.msgType);var c;(this.message={cliMsgId:e.msgInfo.cliMsgId+"",fromUid:e.msgInfo.srcId+"",toUid:TE.a.getConversationIdFromCloudItem(e,Rt.default.getUserId()),msgType:l,msgId:e.msgInfo.glbMsgId+"",isE2EE:!!e.msgInfo.isE2EE},null!==(r=this.extraInfo)&&void 0!==r&&r.thumbUrl)&&(this.message.message={thumbUrl:null===(c=this.extraInfo)||void 0===c?void 0:c.thumbUrl})}static transfer(e){const t=new RE(e);return Object.assign({},t)}}var LE=s("JP/W"),DE=s("na98"),AE=s("Qf4l"),FE=s("lGS6"),jE=s("iA9X"),PE=s("4LiO"),kE=s("oG6Z"),NE=s("sNf9");const UE="enable_view_mode",BE="enable_view_mode_for_free_user",xE={[`${UE}`]:!1,[`${BE}`]:!1},GE=new yi.ObjectValidator({[`${UE}`]:yi.Rule.field().boolean(),[`${BE}`]:yi.Rule.field().boolean()}),zE=new yi.AdvancedRemoteConfigs("zcloud_management_tool",xE,{validator:GE});var VE,HE=s("t9fU");const WE="cloud",$E={verifyQueueDone:!1,cloudItems:null,displayData:null,selectedItems:{},lastClickSelectItem:null,currentFilter:eE.e.ALL,currentSort:eE.g.SIZE_DESCENDING,status:null,fetching:!1,fetchLimit:null,hasMore:!1,lastItemInfo:null,queryError:null,cloudThumbItemMode:NE.a.ViewMode};Object(i.injectable)()(VE=Object(i.singleton)(OE.b)(VE=Object(ko.b)(OE.b)(VE=function(e,t){return Object(i.inject)(ME.a)(e,void 0,0)}(VE=function(e,t){return Object(i.inject)(ME.b)(e,void 0,1)}(VE=Reflect.metadata("design:type",Function)(VE=Reflect.metadata("design:paramtypes",[void 0===ME.a?Object:ME.a,void 0===ME.b?Object:ME.b])(VE=class extends IE.a{constructor(e,t){super(),this.zCloudConversationController=e,this.zCloudSideBarController=t,this.config=void 0,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.cloudViewItems=void 0,this.getDefaultCloudState=()=>Object(f.a)(Object(f.a)({},$E),{},{cloudThumbItemMode:this.isViewModeEnabled()?NE.a.ViewMode:NE.a.SelectableMode}),this.toggleCloudThumbItemMode=e=>{this._toggleCloudThumbItemMode(e)},this._toggleCloudThumbItemMode=e=>{this.updateItem((t=>{t.cloudThumbItemMode=e}),WE),this.resetSelectedItem()},this.config=zE,this.name=OE.a,this.key=OE.a,this.data.set(WE,this.getDefaultCloudState()),this.cloudViewItems=null}_getState(e=WE){return this.data.get(e)}async _sort(e){this.updateItem((t=>{t.currentSort=e}),WE)}_filter(e){try{this.updateItem((t=>{t.currentFilter=e}),WE)}catch(t){}}_getCurrentSort(){const{currentSort:e}=this._getState();return e}isSortedBySize(e){return[eE.g.SIZE_ASCENDING,eE.g.SIZE_DESCENDING].includes(e)}getMappingTypeFromFilter(e){switch(e){case eE.e.ALL:return[R.MSG_PHOTO,R.MSG_PHOTO_2,R.MSG_DOODLE,R.MSG_VIDEO,R.MSG_FILE,R.MSG_VOICE];case eE.e.PHOTO:return[R.MSG_PHOTO,R.MSG_PHOTO_2,R.MSG_DOODLE];case eE.e.VIDEO:return[R.MSG_VIDEO];case eE.e.FILE:return[R.MSG_FILE];case eE.e.VOICE:return[R.MSG_VOICE]}}isSameFilterType(e){const{currentFilter:t}=this._getState(),s=this.getMappingTypeFromFilter(t),i=ho.default.normalizeMessageType(e.msgInfo.msgType);return s&&Array.isArray(s)&&s.includes(i)}getConsideredItems(e){if(!e||!Array.isArray(e))return null;let t=[...e];this.zCloudSideBarController.getCurrentView()!==AE.b.MY_CLOUD&&(t=t.filter((e=>e.zConv!==mi.default.sendToMeId)));const s=this.zCloudConversationController.getCurrentSelectedConvId();return s&&(t=t.filter((e=>e.zConv===s))),t=t.filter((e=>!xo.a.isThreadHidden(e.zConv))),t=t.filter((e=>this.isSameFilterType(e))),t}checkIsInRange(e,t,s){return e>=t&&e<=s}addCloudItemSizeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const n=s[0].size,a=s[s.length-1].size;i=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,a,n)||(s>n||!!(null!=t&&t.isStopIndex&&s<a))}))}if(!i||!Array.isArray(i)||0===i.length)return;const n=[...s,...i].sort(((e,t)=>{const s=e.size;return t.size-s}));this.updateItem((e=>{e.displayData=n}),WE)}addCloudItemSizeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const n=s[0].size,a=s[s.length-1].size;i=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,n,a)||(s<n||!!(null!=t&&t.isStopIndex&&s>a))}))}if(!i||!Array.isArray(i)||0===i.length)return;const n=[...s,...i].sort(((e,t)=>{const s=e.size;return-(t.size-s)}));this.updateItem((e=>{e.displayData=n}),WE)}addCloudItemTimeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const n=s[0].ts,a=s[s.length-1].ts;i=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,a,n)||(s>n||!!(null!=t&&t.isStopIndex&&s<a))}))}if(!i||!Array.isArray(i)||0===i.length)return;const n=[...s,...i].sort(((e,t)=>{const s=e.ts;return t.ts-s}));this.updateItem((e=>{e.displayData=n}),WE)}addCloudItemTimeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const n=s[0].ts,a=s[s.length-1].ts;i=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,n,a)||(s<n||!!(null!=t&&t.isStopIndex&&s>a))}))}if(!i||!Array.isArray(i)||0===i.length)return;const n=[...s,...i].sort(((e,t)=>{const s=e.ts;return-(t.ts-s)}));this.updateItem((e=>{e.displayData=n}),WE)}filter(e){this._filter(e),this.isViewModeEnabled()&&this.toggleCloudThumbItemMode(NE.a.ViewMode)}sort(e){this._sort(e)}getCurrentFilter(){const{currentFilter:e}=this._getState();return e}getCurrentSort(){const{currentSort:e}=this._getState();return e}setVerifyQueueDone(e){this.updateItem((t=>{t.verifyQueueDone=e}),WE)}setViewPortItemInfo(e){this.updateItem((t=>{t.viewPortItemInfo=e}),WE)}async addCloudItems(e){const{currentSort:t}=this._getState();let s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;Object(V_.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&EE.a.getInstance().updateExtMediaInfo(s),i.ModuleContainer.resolve(V_.c).calculateZCloudStatusByCloudItems(s);const n=s.map((e=>RE.transfer(e)));t===eE.g.SIZE_DESCENDING?this.addCloudItemSizeDescending(n):t===eE.g.SIZE_ASCENDING?this.addCloudItemSizeAscending(n):t===eE.g.TIME_DESCENDING?this.addCloudItemTimeDescending(n):t===eE.g.TIME_ASCENDING&&this.addCloudItemTimeAscending(n)}updateCloudItems(e){const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;const i=t.flatMap((t=>{const i=s.findIndex((e=>TE.a.getZCloudKeyFromCloudItem(e)===t.zCloudKey));return-1===i?t:RE.transfer(e[i])}));i&&Array.isArray(i)&&this.updateItem((e=>{e.displayData=i}),WE)}removeCloudItems(e){if(!e||!Array.isArray(e))return;const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=e;Object(LE.b)("removeCloudItems | displayData before remove: ",t);const i=t.filter((e=>!s.includes(e.zCloudKey)));this.updateItem((e=>{e.displayData=i}),WE),Object(LE.b)("removeCloudItems | displayData after remove: ",t)}getCurrentQueryIdentity(){const e=this.zCloudSideBarController.getCurrentView(),{currentFilter:t,currentSort:s}=this._getState();return`${e||e+""}_${t}_${s}`}async getAllByTypeSizeOrDate(e,t,s,i,n=!0){try{const{currentSort:a,currentFilter:r,lastItemInfo:o}=this._getState(),l=r===eE.e.ALL;let c=null;switch(a){case eE.g.SIZE_DESCENDING:c=l?await EE.a.getInstance().getAllByTypeSize("",n?DE.c:t,s,i,Le.c.PREV,o?o.offset:0):await EE.a.getInstance().getAllByTypesSize(e,n?DE.c:t,s,i,Le.c.PREV,o?o.offset:0);break;case eE.g.SIZE_ASCENDING:c=l?await EE.a.getInstance().getAllByTypeSize("",t,s,i,Le.c.NEXT,o?o.offset:0):await EE.a.getInstance().getAllByTypesSize(e,t,s,i,Le.c.NEXT,o?o.offset:0);break;case eE.g.TIME_DESCENDING:c=l?await EE.a.getInstance().getAllByTypeDate("",n?DE.b:t,s,i,Le.c.PREV,o?o.offset:0):await EE.a.getInstance().getAllByTypesDate(e,n?DE.b:t,s,i,Le.c.PREV,o?o.offset:0);break;case eE.g.TIME_ASCENDING:c=l?await EE.a.getInstance().getAllByTypeDate("",t,s,i,Le.c.NEXT,o?o.offset:0):await EE.a.getInstance().getAllByTypesDate(e,t,s,i,Le.c.NEXT,o?o.offset:0);break;default:c=null}return{result:c,identity:this.getCurrentQueryIdentity()}}catch(a){throw{error:a,identity:this.getCurrentQueryIdentity()}}}async getAllConvByTypeSizeOrDate(e,t,s,i,n,a=!0){try{const{currentFilter:r,currentSort:o,lastItemInfo:l}=this._getState(),c=r===eE.e.ALL;let d=null;switch(o){case eE.g.SIZE_DESCENDING:d=c?await EE.a.getInstance().getAllByConversationTypeSize(e,"",a?DE.c:s,i,n,Le.c.PREV,l?l.offset:0):await EE.a.getInstance().getAllByConversationTypesSize(e,t,a?DE.c:s,i,n,Le.c.PREV,l?l.offset:0);break;case eE.g.SIZE_ASCENDING:d=c?await EE.a.getInstance().getAllByConversationTypeSize(e,"",s,i,n,Le.c.NEXT,l?l.offset:0):await EE.a.getInstance().getAllByConversationTypesSize(e,t,s,i,n,Le.c.NEXT,l?l.offset:0);break;case eE.g.TIME_DESCENDING:d=c?await EE.a.getInstance().getAllByConversationTypeDate(e,"",a?DE.b:s,i,n,Le.c.PREV,l?l.offset:0):await EE.a.getInstance().getAllByConversationTypesDate(e,t,a?DE.b:s,i,n,Le.c.PREV,l?l.offset:0);break;case eE.g.TIME_ASCENDING:d=c?await EE.a.getInstance().getAllByConversationTypeDate(e,"",s,i,n,Le.c.NEXT,l?l.offset:0):await EE.a.getInstance().getAllByConversationTypesDate(e,t,s,i,n,Le.c.NEXT,l?l.offset:0);break;default:d=null}return{result:d,identity:this.getCurrentQueryIdentity()}}catch(r){throw{error:r,identity:this.getCurrentQueryIdentity()}}}updateLastItemInfo(e,t){if(!e)return;const s=this._getCurrentSort();this.updateItem((i=>{i.lastItemInfo={type:e.zType,sizeOrDate:this.isSortedBySize(s)?e.zSize:e.zDate,noiseId:e.noiseId,offset:t}}),WE)}setLastItemFromQueryData(e){if(!e||!Array.isArray(e))return;const t=e[e.length-1];Object(LE.b)("currLastItem: ",t);const{lastItemInfo:s}=this._getState();(null==t?void 0:t.noiseId)!==(null==s?void 0:s.noiseId)&&this.updateLastItemInfo(t,((null==s?void 0:s.offset)||0)+e.length)}checkHasMoreCloudMedia(e,t){return e&&Array.isArray(e)&&e.length>=t}setHasMoreFromQueryData(e,t){if(!e||!Array.isArray(e))return;const s=this.checkHasMoreCloudMedia(e,t);Object(LE.b)("hasMore: ",s),this.updateItem((e=>{e.hasMore=s}),WE)}filterNonMyCloudMediaItem(e){return e&&Array.isArray(e)?e.filter((e=>e.zConv!==mi.default.sendToMeId)):null}filterInvalidCloudItems(e){if(!e||!Array.isArray(e))return null;let t;t=e.filter((e=>!xo.a.isThreadHidden(e.zConv)));return this.zCloudSideBarController.getCurrentView()!==AE.b.MY_CLOUD&&(t=this.filterNonMyCloudMediaItem(t)),t}setDisplayDataFromQueryData(e,t,s){if(!e||!Array.isArray(e))return;const i=e,{displayData:n}=this._getState();!t&&n&&Array.isArray(n)?this.updateItem((e=>{e.displayData=[...n,...i]}),WE):this.updateItem((e=>{e.displayData=i}),WE)}filterDuplicatedItems(e){if(!e||e.length<=0)return e;let t={},s=[];for(let i=0;i<e.length;i++){let n=e[i];if(!n)continue;let{zKey:a}=n;if(a)if(t.hasOwnProperty(a)){let{index:e}=t[a],{actionType:i}=n;Object(jE.b)("found dup item",a,n,e),i===SE.b.add_new?s.splice(e,1,Object(f.a)(Object(f.a)({},n),{},{isDuplicated:!0})):s[e].isDuplicated=!0}else s.push(n),t[a]=Object(f.a)(Object(f.a)({},n),{},{index:s.length-1})}return s}async fetchAllCloudMedia(e,t,s,n,a,r=!1,o=-1){try{var l;const c=this.zCloudSideBarController.getCurrentView();this.updateItem((e=>{e.fetching=!0,e.fetchLimit=a,e.queryError=null,r&&(e.selectedItems={}),n||(e.lastItemInfo=null)}),WE);let d=null;if(c===AE.b.MEDIA_TYPE?d=await this.getAllByTypeSizeOrDate(t,s,n,a,r):c===AE.b.CONVERSATION?d=await this.getAllConvByTypeSizeOrDate(e+"",t,s,n,a,r):c===AE.b.MY_CLOUD&&(d=await this.getAllConvByTypeSizeOrDate(mi.default.sendToMeId+"",t,s,n,a,r)),Object(LE.b)("fetchAllCloudMedia | data from db: ",d),!d)return void this.updateItem((e=>{e.fetching=!1}),WE);let{result:u,identity:h}=d;if(!u||!Array.isArray(u))return void this.updateItem((e=>{e.fetching=!1}),WE);if(this.setHasMoreFromQueryData(u,a),this.setLastItemFromQueryData(u),u=this.filterInvalidCloudItems(u),c!==AE.b.CONVERSATION&&(u=this.filterDuplicatedItems(u)),!u||!Array.isArray(u))return void this.updateItem((e=>{e.fetching=!1}),WE);Object(V_.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&EE.a.getInstance().updateExtMediaInfo(u),i.ModuleContainer.resolve(V_.c).calculateZCloudStatusByCloudItems(u);const g=u.map((e=>RE.transfer(e)));this.setDisplayDataFromQueryData(g,r,h),-1==o?o=g.length:o+=g.length,null!==(l=this._getState())&&void 0!==l&&l.hasMore&&o<a?this.handleFetchMore(a,o):this.updateItem((e=>{e.fetching=!1}),WE)}catch(c){this.updateItem((e=>{e.fetching=!1,r&&(e.queryError=c)}),WE)}}forceGetCloudMedia(){const{currentFilter:e,fetchLimit:t}=this._getState(),s=this.zCloudConversationController.getCurrentSelectedConvId();if(!e||null===s||!t)return;const i=FE.a.getCurrentMappingQueryType(e);this.fetchAllCloudMedia(s,i,0,"",t,!0)}handleFetchMore(e,t=-1){const{currentFilter:s,lastItemInfo:i,hasMore:n,fetching:a}=this._getState(),r=FE.a.getCurrentMappingQueryType(s),o=this.zCloudConversationController.getCurrentSelectedConvId();Object(LE.b)("call fetch more... ",i),a&&-1===t||!i||!n||this.fetchAllCloudMedia(o,r,i.sizeOrDate,i.noiseId,e,!1,t)}isSelectedAll(){const{displayData:e,selectedItems:t}=this._getState();return Object.keys(t).length===(null==e?void 0:e.length)}handleSelectAll(){const{displayData:e,selectedItems:t}=this._getState();if(!e)return;const s=Object(f.a)({},t);e.forEach((e=>{const t=e.zCloudKey;s[t]||(s[t]=e)})),this.updateItem((e=>{e.selectedItems=s}),WE)}handleDeselectAll(){this.resetSelectedItem()}handleToggleSelectAll(){this.isSelectedAll()?this.handleDeselectAll():this.handleSelectAll()}handleSelectItem(e){const{selectedItems:t,currentFilter:s}=this._getState(),i=Object(f.a)({},t);let n;const a=e.zCloudKey;if(i[a])delete i[a],n=null,Object(V_.b)().isEnableUserPCloud()&&PE.a.logClickUncheckItem({unselect_type:"single_unselect"});else{var r;if((null===(r=Object.keys(i))||void 0===r?void 0:r.length)>mi.default.max_msg_per_del-1)return void rs.default.createSuccess(os.a.trans("STR_MY_CLOUD_MAX_SELECTED_ITEMS",[mi.default.max_msg_per_del.toString()]));if(i[a]=e,n=e,Object(V_.b)().isEnableUserPCloud()){var o;const{extension:t}=Object(kE.b)((null==e||null===(o=e.extraInfo)||void 0===o?void 0:o.title)||""),i=this.zCloudSideBarController.getCurrentView();PE.a.logClickCheckItem({tab_filter:s,file_extension:t,file_size:e.size,source_tab:i})}}this.updateItem((e=>{e.selectedItems=i,e.lastClickSelectItem=n}),WE)}resetSelectedItem(){this.updateItem((e=>{e.selectedItems={}}),WE)}resetAllStates(){this.data.set(WE,this.getDefaultCloudState()),Object(hs.h)(this.name,WE)}isViewModeEnabled(){try{return HE.a.getInstance().isPaidUser()||HE.a.getInstance().isInGracePeriod()?this.config.key(UE).boolean:!!HE.a.getInstance().isFreev2()&&this.config.key(BE).boolean}catch(e){return Object(LE.a)("daivd error when check view mode enabled: ",e),!1}}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||VE)||VE)||VE)||VE)||VE)||VE);var KE,qE=s("tP1L"),QE=s("9XoL"),ZE=s("bO3J"),JE=s("cCVI"),YE=s("k+eZ"),XE=s("CBkG");const eM="1",tM="zcloud-promo",sM={showPromoTooltip:!1,showPromoPopover:!1,showTip:!1,showEntry:!1};Object(i.injectable)()(KE=Object(i.singleton)(YE.b)(KE=Object(ko.b)(YE.b)(KE=function(e,t){return Object(i.inject)(QE.b)(e,void 0,0)}(KE=function(e,t){return Object(i.inject)(JE.a)(e,void 0,1)}(KE=function(e,t){return Object(i.inject)(No.SidebarController)(e,void 0,2)}(KE=Reflect.metadata("design:type",Function)(KE=Reflect.metadata("design:paramtypes",[void 0===QE.b?Object:QE.b,void 0===JE.a?Object:JE.a,void 0===No.SidebarController?Object:No.SidebarController])(KE=class extends IE.a{constructor(e,t,s){super(),this.eventsResolver=e,this.onboardEventsResolver=t,this.sidebarController=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=YE.a,this.key=YE.a,this.data.set(eM,sM),this.blockOnboardingHandler=this.blockOnboardingHandler.bind(this),this.triggerOnboardingHandler=this.triggerOnboardingHandler.bind(this),this.pcDoneOnboardingHandler=this.pcDoneOnboardingHandler.bind(this),this.offPlanHandler=this.offPlanHandler.bind(this),this.upgradePlanHandler=this.upgradePlanHandler.bind(this),this.receiveKeyHandler=this.receiveKeyHandler.bind(this)}save(){E.default.getInstance().setItemForCurrentUser(tM,JSON.stringify(this.getState()))}load(){let e=E.default.getInstance().getItemForCurrentUser(tM);e&&this.data.set(eM,JSON.parse(e))}getLocal(){let e=E.default.getInstance().getItemForCurrentUser(tM);return e?JSON.parse(e):void 0}getState(e=eM){return this.data.get(e)}blockOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!1,e.showTip=!1}),eM),this.save()}triggerOnboardingHandler(e){if(Object(LE.a)("trigger onboarding event: ",e),e.type===ZE.b.MOBILE_COMPLETED_BEFORE)this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),eM),this.save()}pcDoneOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!0,e.showTip=!1}),eM),this.save()}offPlanHandler(e){Object(LE.a)("off plan | current: FREE"),this.sidebarController.changeTab(No.SidebarTab.MESSAGE_TAB),this.sidebarController.updateSelectedId(null),this.removeSubmitOnboaringDoneKey(),this.updateItem((e=>{e.showEntry=!1,e.showTip=!1,e.showPromoTooltip=Object(V_.b)().isEnablePromoTooltip()&&HE.a.getInstance().isFreev2(),e.showPromoPopover=Object(V_.b)().isEnablePromoPopover()&&HE.a.getInstance().isFreev2()}),eM),this.save()}upgradePlanHandler(e){Object(LE.a)("upgrade plan | current: PAID"),this.updateItem((e=>{e.showPromoTooltip=!1,e.showPromoPopover=!1}),eM),this.save()}receiveKeyHandler(e){}doesSubmitOnboardingDoneBefore(){return!!E.default.getInstance().getItemForCurrentUser("zcl_sm_ob")}setSubmitOnboardingDone(){E.default.getInstance().setItemForCurrentUser("zcl_sm_ob","true")}removeSubmitOnboaringDoneKey(){E.default.getInstance().removeItemForCurrentUser("zcl_sm_ob")}setShowPromoTooltip(e){this.updateItem((t=>{t.showPromoTooltip=e}),eM),this.save()}setShowPromoPopover(e){this.updateItem((t=>{t.showPromoPopover=e}),eM),this.save()}initPromoStates({showPromoTooltip:e,showPromoPopover:t}){this.updateItem((s=>{s.showPromoTooltip=e,s.showPromoPopover=t}),eM),this.save()}initShouldShowEntry(e){Object(LE.a)("init check zcloud user: ",e),this.updateItem((t=>{t.showEntry=e}),eM),this.save()}addListener(){this.onboardEventsResolver.addEventListener(ZE.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.addEventListener(ZE.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.addEventListener(XE.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.addEventListener(XE.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(XE.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(XE.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}removeListener(){this.onboardEventsResolver.removeEventListener(ZE.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.removeEventListener(ZE.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.removeEventListener(XE.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.removeEventListener(XE.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(XE.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(XE.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}onDoneOnboarding(){this.submitDoneOnboarding(),this.updateItem((e=>{e.showTip=!1}),eM),this.save()}async submitDoneOnboarding(){Object(LE.a)("submit done onboarding");try{if(this.doesSubmitOnboardingDoneBefore())return;await qE.a.submitOnboardingInfo(),this.setSubmitOnboardingDone()}catch(e){}}})||KE)||KE)||KE)||KE)||KE)||KE)||KE);var iM=s("NoK8"),nM=s("u/Xa"),aM=s("3/Az");class rM{static closeZCloudPhotoViewer(){i.ModuleContainer.resolve(nM.b).emit("CLOSE_VIEWER",{conversationId:"",openSource:aM.l.ZCloudManagementTool})}}const oM=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloudManagementTool,["PreviewUtils","daivd"]);class lM{static closePhotoAndFilePreview(){try{rM.closeZCloudPhotoViewer()}catch(e){oM.zsymb(18,"3TFq0-","Error closing photo and file preview: ",e)}}}var cM;const dM="1",uM={currentView:null,pageStack:[]};Object(i.injectable)()(cM=Object(i.singleton)(iM.b)(cM=Object(ko.b)(iM.b)(cM=Reflect.metadata("design:type",Function)(cM=Reflect.metadata("design:paramtypes",[])(cM=class extends IE.a{constructor(){super(),this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.lastMediaView=void 0,this.name=iM.a,this.key=iM.a,this.data.set(dM,uM),this.lastMediaView=null}_getState(e=dM){return this.data.get(e)}setInitView(e){this.updateItem((t=>{t.currentView=e}),dM)}changeView(e){null===e&&lM.closePhotoAndFilePreview(),this.updateItem((t=>{t.currentView=e}),dM),e!==AE.b.SETTING&&(this.lastMediaView=e)}closeSetting(){this.changeView(this.lastMediaView||AE.b.MEDIA_TYPE)}getCurrentView(){const{currentView:e}=this._getState();return e}getPageStack(){const{pageStack:e}=this._getState();return e}pushPageStack(e){const{pageStack:t}=this._getState();this.updateItem((s=>{s.pageStack=[...t,e]}),dM)}setPageStack(e){e&&Array.isArray(e)&&this.updateItem((t=>{t.pageStack=e}),dM)}popPageStack(){const{pageStack:e}=this._getState(),t=[...e];t.pop(),this.updateItem((e=>{e.pageStack=t}),dM)}})||cM)||cM)||cM)||cM);s("umN7");var hM=s("5y3u");i.ModuleContainer.registerSingleton(hM.a,hM.b);var gM=s("iyDo"),mM=s("UDME"),pM=s("A9no"),fM=s("bKXo"),vM=s("tIXy");var bM=class{constructor(){this.data=void 0,this.data=new Map}startCapture(e,t={}){this.data.set(e,{start:yn.default.getTimeNow(),end:null,params:t})}finishCapture(e,t={}){const s=this.data.get(e);if(s){const i=Object(f.a)(Object(f.a)({},s),{},{end:yn.default.getTimeNow(),params:Object(of.a)(s.params,t)});return this.data.set(e,i),i}return s}getItem(e){return this.data.get(e)}clearItem(e){this.data.delete(e)}};let IM=function(e){return e[e.NORMAL=0]="NORMAL",e[e.SILENTLY=1]="SILENTLY",e[e.BLOCKING=2]="BLOCKING",e[e.SILENTLY_BLOCKING=3]="SILENTLY_BLOCKING",e}({}),yM=function(e){return e[e.OFF=0]="OFF",e[e.ON=1]="ON",e}({}),_M=function(e){return e[e.MEMBER=0]="MEMBER",e[e.OWNER=1]="OWNER",e[e.ADMIN=2]="ADMIN",e}({}),CM=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),OM=function(e){return e[e.MANUAL=0]="MANUAL",e[e.DEFAULT=1]="DEFAULT",e[e.NOT_SILENTLY=-1]="NOT_SILENTLY",e}({}),EM=function(e){return e[e.LEAVE_GROUP=1]="LEAVE_GROUP",e[e.CHANGE_HIDE_MEMBER_SETTING=1]="CHANGE_HIDE_MEMBER_SETTING",e[e.CLICK_GROUP_LINK=1]="CLICK_GROUP_LINK",e[e.UPGRADE_COMMUNITY=1]="UPGRADE_COMMUNITY",e[e.VERIFY_ACCOUNT=2]="VERIFY_ACCOUNT",e[e.CLICK_LEARN_MORE=3]="CLICK_LEARN_MORE",e[e.ENTER_UPGRADE_FLOW=4]="ENTER_UPGRADE_FLOW",e[e.ENTER_KYC_FLOW=5]="ENTER_KYC_FLOW",e[e.ACTION_KYC_FLOW=6]="ACTION_KYC_FLOW",e[e.AFTER_ACTION_KYC_FLOW=7]="AFTER_ACTION_KYC_FLOW",e[e.PREVENT_UPGRADE_FLOW=8]="PREVENT_UPGRADE_FLOW",e[e.ACTION_ZBIZ_REGISTER=9]="ACTION_ZBIZ_REGISTER",e}({});i.ModuleContainer.registerSingleton(gM.a,class{constructor(){this.upgradeCommunityCapture=void 0,this.verificationCapture=void 0,this.upgradeCommunityCapture=new bM,this.verificationCapture=new bM}logAction999(e){const{type:t,payload:s,noisedIds:i}=e;let n;switch(t){case"LEAVE_GROUP":n=EM.LEAVE_GROUP,as.default.logActionInfoV2(as.FeaturesInfo.LeaveGroupSilently,n,s,i);break;case"CHANGE_HIDE_MEMBER_SETTING":n=EM.CHANGE_HIDE_MEMBER_SETTING,as.default.logActionInfoV2(as.FeaturesInfo.HideMemberPresence,n,s,i);break;case"CLICK_GROUP_LINK":n=EM.CLICK_GROUP_LINK,as.default.logActionInfoV2(as.FeaturesInfo.ClickGroupLink,n,s,i);break;case"UPGRADE_COMMUNITY":n=EM.UPGRADE_COMMUNITY,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"VERIFY_ACCOUNT":n=EM.VERIFY_ACCOUNT,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"CLICK_LEARN_MORE":n=EM.CLICK_LEARN_MORE,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"ENTER_KYC_FLOW":n=EM.ENTER_KYC_FLOW,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"ENTER_UPGRADE_FLOW":n=EM.ENTER_UPGRADE_FLOW,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"ACTION_KYC_FLOW":n=EM.ACTION_KYC_FLOW,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"AFTER_ACTION_KYC_FLOW":n=EM.AFTER_ACTION_KYC_FLOW,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"PREVENT_UPGRADE_FLOW":n=EM.PREVENT_UPGRADE_FLOW,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i);break;case"ACTION_ZBIZ_REGISTER":n=EM.ACTION_ZBIZ_REGISTER,as.default.logActionInfoV2(as.FeaturesInfo.Community,n,s,i)}}getChatTypeFromConvId(e){return ho.default.isGroup(e)?CM.CHAT_GROUP:cC.a.isSendToMe(e)?CM.MY_CLOUD:CM.CHAT_11}getMemberRole(e,t){return mM.GroupSettingHelper.isOwner(e,t)?_M.OWNER:mM.GroupSettingHelper.isAdmin(e,t)?_M.ADMIN:_M.MEMBER}isDefaultLeaveSilently(e){return!(!mi.default.group_privacy.hide_member.enable||!mM.GroupSettingHelper.isLockViewMember(e))||!(!mi.default.group_privacy.leave_group_silently.enable||!pM.isCommunity(e))}getLeaveGroupSilentlyType(e,t){return this.isDefaultLeaveSilently(e)?OM.DEFAULT:"SILENTLY"===t?OM.MANUAL:OM.NOT_SILENTLY}changeHideMemberSettingReport(e){const t=ho.default.getGroupIdFromConversationId(e.groupId),s=ns.default.getUidMe();this.logAction999({type:"CHANGE_HIDE_MEMBER_SETTING",payload:{mode:e.value?yM.ON:yM.OFF,des_id:t,src_id:s},noisedIds:[t,s]})}clickGroupLinkReport(e){const t=ho.default.getGroupIdFromConversationId(e.groupId),s=ns.default.getUidMe();this.logAction999({type:"CLICK_GROUP_LINK",payload:{chat_type:e.conversationId?this.getChatTypeFromConvId(e.conversationId):null,src_id:s,des_id:t,lobby_version:mi.default.group_privacy.hide_member.enable?1:0},noisedIds:[s,t]})}leaveGroupReport(e){let t=e.groupId;t.startsWith(R.GROUPID_PREFIX)||(t=R.GROUPID_PREFIX+t);const s=ho.default.getGroupIdFromConversationId(e.groupId),n=ns.default.getUidMe(),a=this.getMemberRole(t,n);this.logAction999({type:"LEAVE_GROUP",payload:{des_id:s,src_id:n,user_role:a,status:this.isDefaultLeaveSilently(t)?IM.SILENTLY:IM[e.leaveType],silent_default:this.getLeaveGroupSilentlyType(t,e.leaveType)},noisedIds:[s,n]}),i.ModuleContainer.resolve(fM.b).onLeaveGroup({groupId:t,actorId:n,memberId:n,leaveType:e.leaveType,memberRole:a})}openPreventUpgradeCommunityReport(e){const{groupId:t,entryPoint:s,currentPkgId:i,errorCode:n}=e,a=ho.default.getGroupIdFromConversationId(t);this.logAction999({type:"PREVENT_UPGRADE_FLOW",payload:{des_id:a,entrypoint:s,error_code:n,user_type:i},noisedIds:[a]})}openPopupUpgradeCommunityReport(e){const{groupId:t,entryPoint:s}=e;this.upgradeCommunityCapture.startCapture(t,{entryPoint:s})}getVerificationStatusLogNumber(e){switch(e){case vM.b.NEED_VERIFY:return 0;case vM.b.VERIFIED:return 1;default:return 3}}actionBusinessRegistrationReport(e){const{groupId:t,pkgId:s,action:i}=e,n=this.upgradeCommunityCapture.finishCapture(t);if(!n)return;const a=ho.default.getGroupIdFromConversationId(t);this.logAction999({type:"ACTION_ZBIZ_REGISTER",payload:"close"===i?{des_id:a,action:i,entrypoint:n.params.entryPoint}:{des_id:a,action:i,register_package:s,entrypoint:n.params.entryPoint},noisedIds:[a]})}closePopupUpgradeCommunityReport(e){const{groupId:t,verificationStatus:s,upgradeStatus:i,errorCode:n,currentPkgId:a}=e,r=this.upgradeCommunityCapture.finishCapture(t);if(!r)return;const o=ho.default.getGroupIdFromConversationId(t);this.logAction999({type:"UPGRADE_COMMUNITY",payload:{des_id:o,upgrade_status:i,fail_error:n,duration:r.end-r.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:r.params.entryPoint,action:n?"confirm_upgrade":"close",user_type:a},noisedIds:[o]}),this.upgradeCommunityCapture.clearItem(t)}openPopupVerificationReport(e){const{groupId:t,entryPoint:s}=e;this.verificationCapture.startCapture(t,{entryPoint:s})}actionPopupVerificationReport(e){const{groupId:t,action:s,currentPkgId:i,totalMember:n,isAfterAction:a}=e,r=this.verificationCapture.getItem(t);if(!r)return;const o=ho.default.getGroupIdFromConversationId(t);this.logAction999({type:a?"AFTER_ACTION_KYC_FLOW":"ACTION_KYC_FLOW",payload:{des_id:o,action:s,entrypoint:r.params.entryPoint,member_size:n,user_type:i},noisedIds:[o]})}closePopupVerificationReport(e){const{groupId:t,verificationStatus:s,action:i,currentPkgId:n}=e,a=this.verificationCapture.finishCapture(t);if(!a)return;const r=ho.default.getGroupIdFromConversationId(t);this.logAction999({type:"VERIFY_ACCOUNT",payload:{des_id:r,duration:a.end-a.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:a.params.entryPoint,action:i||"close",user_type:n},noisedIds:[r]}),this.verificationCapture.clearItem(t)}clickCommunityLearnMoreReport(e){const{groupId:t,entryPoint:s,currentPkgId:i}=e,n=ho.default.getGroupIdFromConversationId(t);this.logAction999({type:"CLICK_LEARN_MORE",payload:{des_id:n,entrypoint:s,user_type:i},noisedIds:[n]})}mapGroupEntryToCommunity(e){switch(e){case"gr_add_member":return"comm_add_member";case"gr_member_approval":return"comm_member_approval";case"message_info":return"msg_info";default:return e}}openPreventAddMemberReport(e){const{entryPoint:t,groupId:s,type:i,currentPkgId:n,totalMember:a}=e,r=ho.default.getGroupIdFromConversationId(s);this.logAction999({type:"need_kyc"===i?"ENTER_KYC_FLOW":"ENTER_UPGRADE_FLOW",payload:{des_id:r,entrypoint:this.mapGroupEntryToCommunity(t),user_type:n,member_size:a},noisedIds:[r]})}});var MM=s("sEfC"),SM=s.n(MM);var TM,wM=class{constructor(e){this.key=void 0,this._data=void 0,this.key=e}get data(){if(!this._data){const e=E.default.getInstance().getItemForCurrentUser(this.key);let t=[];if(null!==e){try{t=JSON.parse(e)}catch{t=[]}Array.isArray(t)||(t=[])}this._data=new Set(t)}return this._data}addItem(e){this.data.has(e)||(this.data.add(e),E.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}removeItem(e){this.data.has(e)&&(this.data.delete(e),E.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}clear(){this.data.clear(),E.default.getInstance().removeItemForCurrentUser(this.key)}hasItem(e){return this.data.has(e)}},RM=s("+jN4"),LM=s("Ei7k");Object(i.injectable)()(TM=Object(Je.i)()(TM=Object(Je.g)()(TM=Object(ko.b)(jl.e)(TM=function(e,t){return Object(i.inject)(jl.h)(e,void 0,0)}(TM=Reflect.metadata("design:type",Function)(TM=Reflect.metadata("design:paramtypes",[void 0===jl.h?Object:jl.h])(TM=class{constructor(e){this.onboardController=e,this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.verification=void 0,this.hiddenChatBoxBannerGroups=void 0,this.handleUpdateDataItemImmediately=({groupId:e})=>{const t={groupId:e,bannerStatus:this.getBannerStatusForItem(e)};this.data.set(e,t),this.signalUpdateItem(e)},this.handleUpdateDataItem=SM()(this.handleUpdateDataItemImmediately,300,{leading:!1,trailing:!0}),this.handleUsagedGroupInfoChange=({groupId:e},t)=>{if(!t&&!mM.GroupSettingHelper.isOwner(e,ns.default.getUidMe()))return;const s=zl.default.isOpenChildWindowByConvId(e),n=e==i.ModuleContainer.resolve(No.SidebarController).getCurrMainConvId();(s||n)&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItem({groupId:e})})),this.verification.loaded=!0):this.handleUpdateDataItem({groupId:e}))},this.handleChangeOwnnerEvent=({groupId:e,ownerId:t})=>{(t==ns.default.getUidMe()||this.data.has(e))&&this.handleUsagedGroupInfoChange({groupId:e},!0)},this.handleMultiGroupInfoChange=e=>{for(const t of e)this.handleUsagedGroupInfoChange({groupId:t})},this.handleProfileVerificationChange=e=>{this.verification={loaded:!0,status:e};const t=[];this.data.forEach((e=>{t.push([e.groupId,Object(f.a)(Object(f.a)({},e),{},{bannerStatus:this.getBannerStatusForItem(e.groupId)})])})),this.data=new Map(t),this.signalUpdateAllItems()},this.handleLeaveGroupEvent=e=>{for(const t of e)this.data.delete(t),this.hiddenChatBoxBannerGroups.removeItem(t)},this.name=jl.a,this.key="groupId",this.data=new Map,this.verification={loaded:!1,status:null},this.hiddenChatBoxBannerGroups=new wM(jl.c)}init(){throw new Error("Method not implemented.")}onStart(){Zo.default.subscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Zo.default.subscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),Zo.default.subscribeEventGroup(R.EventGroup.CHANGE_OWNER,this.handleChangeOwnnerEvent),Zo.default.subscribeEventGroup(R.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),Zo.default.subscribeEventGroup(R.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),ns.default.subscribeEventFriend(R.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){Zo.default.unsubscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Zo.default.unsubscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),Zo.default.unsubscribeEventGroup(R.EventGroup.CHANGE_OWNER,this.handleUsagedGroupInfoChange),Zo.default.unsubscribeEventGroup(R.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),Zo.default.unsubscribeEventGroup(R.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),ns.default.unsubscribeEventFriend(R.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(hs.h)(this.name,e)}signalUpdateAllItems(){this.data.forEach((e=>{this.signalUpdateItem(e.groupId)}))}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.community,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"V18EC_","Get community data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"NkDnxf","Get community data list failed",e)}getOwnedCommunities(){const e=Zo.default.getGroupsListSync(),t=ns.default.getUidMe(),s=[];for(const i of e)i.creatorId===t&&jl.q.isCommunityFromInfo(i)&&s.push(i);return s}getJoinedCommunities(){const e=Zo.default.getGroupsListSync(),t=[];for(const s of e)jl.q.isCommunityFromInfo(s)&&t.push(s);return t}getProfileVerificationStatus(){return this.verification.status}getBannerStatusForItem(e){if(null===this.verification.status)return{show:!1};const t=Zo.default.getGroupByIdSync(e);if("number"!=typeof(null==t?void 0:t.totalMember)||t.creatorId!=ns.default.getUidMe())return{show:!1};const s=jl.q.isCommunityFromInfo(t);let i,n=!1;const a=new Set([jl.f.CHAT_BOX,jl.f.RIGHT_BAR]);return this.verification.status===vM.b.VERIFIED?(n=!s&&t.totalMember>=mi.default.group_privacy.community.grouptype_threshold,i=jl.g.REACHED_UPGRADE):(n=s||t.totalMember>=mi.default.group_privacy.community.minimum_warn_upgrade,i=s?jl.g.UPGRADED_VERIFY:t.totalMember>=mi.default.group_privacy.community.grouptype_threshold?jl.g.REACHED_VERIFY:jl.g.NEARLY_REACH_VERIFY),this.hiddenChatBoxBannerGroups.hasItem(e)&&a.delete(jl.f.CHAT_BOX),{show:n,type:i,position:a}}getAccountVerificationStatus(e){ns.default.getVerificationStatusMe().then((t=>{this.verification.status=t,null==e||e(t)})).catch((e=>{this.Logger.zsymb(18,"H3k5q_","Get account verification status failed",e)}))}upgradeToCommunity(e){return new Promise(((t,s)=>{uo.default.upgradeGroupToCommunity(e).then((()=>{this.Logger.zsymb(18,"vPdNuW","Upgrade community succeed",e),t()})).catch((t=>{this.Logger.zsymb(18,"ospEaw","Upgrade community failed",e,t),s(t)}))}))}shouldLoadVerificationStatus(e){if(this.verification.loaded&&this.verification.status===vM.b.VERIFIED)return!1;const t=Zo.default.getGroupByIdSync(e);return"number"==typeof(null==t?void 0:t.totalMember)&&(jl.q.isCommunityFromInfo(t)||t.totalMember>=mi.default.group_privacy.community.minimum_warn_upgrade)}onConversationDidOpen(e){this.onboardController.onConversationDidOpen(e),Sd.a.isGroup(e)&&mM.GroupSettingHelper.isOwner(e,ns.default.getUidMe())&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItemImmediately({groupId:e})})),this.verification.loaded=!0):this.data.has(e)||this.handleUpdateDataItemImmediately({groupId:e}))}onReceivedCommunityError({groupId:e,errorCode:t,windowId:s,src:n}){const a=mM.GroupSettingHelper.isOwner(e,ns.default.getUidMe());switch(t){case R.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:a?(RM.b(s,e,n),n&&i.ModuleContainer.resolve(jl.p).openPreventAddMemberReport({groupId:e,type:"need_kyc",entryPoint:n,currentPkgId:ns.default.getPkgIdCurrent(),totalMember:Zo.default.getTotalMember(e)})):ss.ModalManagerV2.openModal({windowId:s,name:R.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:n}});break;case R.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:ss.ModalManagerV2.openModal({windowId:s,name:R.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:n}}),n&&a&&i.ModuleContainer.resolve(jl.p).openPreventAddMemberReport({groupId:e,type:"need_upgrade",entryPoint:n,currentPkgId:ns.default.getPkgIdCurrent(),totalMember:Zo.default.getTotalMember(e)})}}closeChatBoxBanner(e){this.hiddenChatBoxBannerGroups.addItem(e),this.handleUpdateDataItemImmediately({groupId:e})}async checkCommunityQuota(e){const t=await uo.default.getQuotaCommunity(e);if(t&&t.canUpgr)return!0;throw{data:t}}async checkUpgradeCondition(e){const t=mi.default.group_privacy.community_zbiz.base_pkg;if(!ns.default.isMeBAAccount()){const s=this.getOwnedCommunities(),i=LM.a.getQuotaCommunity(t);return!(s.length>=i)||this.checkCommunityQuota(e)}return this.checkCommunityQuota(e)}async checkCommunityMemberQuota(e,t){try{const s=await uo.default.checkQuotaCommunityMember(e,t);this.Logger.zsymb(0,"XRrO_V","check member quota ok",e,t,s);const i={isQualified:s.canUpgr,content:s.content};if(s.canUpgr||s.othersCanUpgr)return i;throw{data:i}}catch(s){throw this.Logger.zsymb(18,"YLvHSH","check member quota fail",e,t,s),s}}async checkCreateCondition(e){const t=ns.default.getPkgIdCurrent();if(e===jl.n.COMMUNITY){const e=LM.a.getQuotaCommunity(t),s=this.getOwnedCommunities().length;if(s>=e)throw{error_code:R.GROUP_APPOINTMENT_ERROR.REACHED_LIMIT_OWNED_COMMUNITY,data:{error_message_localize:jl.q.getReachedQuotaErrorMessageLocalize(e,s)}};return!0}const s=LM.a.getQuotaGroup(t);if(Zo.default.getGroupsListSync().length>=s)throw{error_code:R.GROUP_MEMBER_ERROR.REACHED_LIMIT_GROUP,data:{error_message_localize:os.a.trans("STR_GROUP_PRIVACY_CANNOT_CREATE_GROUP_COMMUNITY_LIMIT",[String(s)])}};return!0}})||TM)||TM)||TM)||TM)||TM)||TM);var DM,AM=s("7Ull");Object(Je.i)()(DM=Object(Je.g)()(DM=Object(i.singleton)(jl.h)(DM=Reflect.metadata("design:type",Function)(DM=Reflect.metadata("design:paramtypes",[])(DM=class{constructor(){this.onboardedGroups=void 0,this.lastOnboardedGroupId=void 0,this.onboardingCounter=void 0,this.status=void 0,this.emitter=void 0,this.recentUpgradedGroups=void 0,this.closeOnboard=e=>{this.status[e]&&(this.status=Object(f.a)(Object(f.a)({},this.status),{},{[e]:!1}),this.emitter.emit("change",this.status))},this.isCanShowOnboard=e=>{const t=this.onboardingCounter.getItem(e);return"number"!=typeof t||t<mi.default.group_privacy.community.max_onboard_times},this.handleGroupUpgradeEvent=({groupId:e})=>{this.recentUpgradedGroups.add(e);const t=zl.default.isOpenChildWindowByConvId(e),s=e==i.ModuleContainer.resolve(No.SidebarController).getCurrMainConvId();mi.default.group_privacy.community.enable_ui&&(t||s)&&(mM.GroupSettingHelper.isOwner(e,ns.default.getUidMe())?(this.status=Object(f.a)(Object(f.a)({},this.status),{},{popup:!0,tip:!1}),this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,jl.i.POPUP)):this.isCanShowOnboard(jl.i.TIP)&&(this.status=Object(f.a)(Object(f.a)({},this.status),{},{tip:!0,popup:!1}),this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),mi.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,jl.i.TIP)))},this.handleLeaveGroupEvent=e=>{for(const t of e)this.recentUpgradedGroups.delete(t)},this.handleOpenChildWindow=({windowId:e})=>{const t=zl.default.getConvIdFromWindowId(e);this.onConversationDidOpen(t)},this.onboardedGroups=new Set,this.lastOnboardedGroupId=null,this.onboardingCounter=new AM.a(jl.d),this.status={tip:!1,popup:!1},this.recentUpgradedGroups=new Set,this.emitter=new qg.a}onStart(){Zo.default.subscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Zo.default.subscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),zl.default.subscribe(Go.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow)}onDispose(){Zo.default.unsubscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),Zo.default.unsubscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),zl.default.unsubscribe(Go.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow),this.recentUpgradedGroups.clear()}getStatus(){return this.status}hasOnboardedGroupId(e){return this.onboardedGroups.has(e)}getLastOnboardedGroupId(){return this.lastOnboardedGroupId}isDoneOnboard(){return!Object.values(jl.i).some(this.isCanShowOnboard)}getStatusForGroup(e){return this.recentUpgradedGroups.has(e)?{tip:!1,popup:this.isCanShowOnboard(jl.i.POPUP)}:{tip:this.isCanShowOnboard(jl.i.TIP),popup:!1}}onConversationDidOpen(e){mi.default.group_privacy.community.enable_ui&&Sd.a.isGroup(e)&&jl.q.isCommunity(e)&&!this.onboardedGroups.has(e)&&(this.status=this.getStatusForGroup(e),this.status.tip&&(this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),mi.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,jl.i.TIP)),this.status.popup&&(this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,jl.i.POPUP)))}onDoneNewOnboardingLevel(e,t){if(this.isDoneOnboard())return;this.lastOnboardedGroupId=e,e&&this.onboardedGroups.add(e);let s=this.onboardingCounter.getItem(t);"number"!=typeof s&&(s=0),this.onboardingCounter.setItem(t,s+1)}resetOnboardFlagFromLocal(){this.lastOnboardedGroupId=null,this.onboardedGroups.clear(),this.onboardingCounter.clear()}})||DM)||DM)||DM)||DM);var FM,jM=s("eCBG");Object(Je.g)()(FM=Object(Je.i)()(FM=Object(i.singleton)(jl.o)(FM=Reflect.metadata("design:type",Function)(FM=Reflect.metadata("design:paramtypes",[])(FM=class extends Fe.b{constructor(){super(),this.cachedGroupOwnerInfo=void 0,this.logger=void 0,this.onOpenConvChildWindow=e=>{const t=zl.default.getConvIdFromWindowId(e);this.onOpenConversation(t)},this.cachedGroupOwnerInfo=new Set}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.community,[jl.k])),this.logger}handlePreloadOwnerInfo(e){const t=Zo.default.getMiniInfoGroup(e);null!=t&&t.creatorId&&!this.cachedGroupOwnerInfo.has(e)&&i.ModuleContainer.resolve(jM.PersonalController).getUserInfo(t.creatorId).then((t=>{this.cachedGroupOwnerInfo.add(e),this.dispatchEvent(new jl.m("done-preload-owner-info",e,{info:t}))})).catch((e=>{this.Logger.zsymb(18,"4WyZ1Q","Load owner info fail",t,e)}))}onStart(){zl.default.subscribe(Go.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow)}onDispose(){zl.default.unsubscribe(Go.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow),this.cachedGroupOwnerInfo.clear()}onOpenConversation(e){ho.default.isGroup(e)&&mi.default.group_privacy.group_created_by_oa&&this.handlePreloadOwnerInfo(e)}getMiniGroupInfo(e){return Zo.default.getMiniInfoGroup(e)}})||FM)||FM)||FM)||FM);const PM=["groupId","memberId","actorId"],kM=["groupId","memberId","actorId"];var NM;Object(i.singleton)(jl.l)(NM=Reflect.metadata("design:type",Function)(NM=Reflect.metadata("design:paramtypes",[])(NM=class{constructor(){this.name=void 0,this.logger=void 0,this.name=jl.j}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.group,[this.name])),this.logger}onAppointAdmin(e){const{groupId:t,memberId:s,actorId:i}=e;this.Logger.zsymb(0,"l9Rgta",`add admin group=${t} mem=${s} actor=${i}`)}onRemoveAdmin(e){const{groupId:t,memberId:s,actorId:i}=e;this.Logger.zsymb(0,"mebEVv",`remove admin group=${t} mem=${s} actor=${i}`)}onLeaveGroup(e){const{groupId:t,memberId:s,actorId:i}=e,n=Object(Ip.a)(e,PM);this.Logger.zsymb(0,"ybthIw",`leave group=${t} mem=${s} actor=${i}`,n)}onRemoveMember(e){const{groupId:t,memberId:s,actorId:i}=e,n=Object(Ip.a)(e,kM);this.Logger.zsymb(0,"WHM3Vk",`kickout group=${t} mem=${s} actor=${i}`,n)}})||NM)||NM);var UM=s("P+Nn");let BM=function(e){return e[e.SEND_FSS=4]="SEND_FSS",e[e.SEND_CARD=5]="SEND_CARD",e}({}),xM=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({});var GM=s("nmtd");i.ModuleContainer.registerSingleton(UM.a,class{logAction999(e){const{type:t,payload:s,noisedIds:i}=e;switch(t){case GM.a.CARD:as.default.logActionInfoV2(as.FeaturesInfo.SendFSS,BM.SEND_CARD,s,i);break;case GM.a.STICKER:as.default.logActionInfoV2(as.FeaturesInfo.SendFSS,BM.SEND_FSS,s,i)}}getChatTypeFromConvId(e){return ho.default.isGroup(e)?xM.CHAT_GROUP:cC.a.isSendToMe(e)?xM.MY_CLOUD:xM.CHAT_11}getRawDestinationId(e,t){return t===xM.CHAT_GROUP?ho.default.getGroupIdFromConversationId(e):e}sendCardReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),i=ns.default.getUidMe();this.logAction999({type:GM.a.CARD,payload:{src_id:i,des_id:s,chat_type:t,group_id:t===xM.CHAT_GROUP?s:null,ecard:{background_id:e.backgroundId,char_count:e.charCount,list_title_id:e.listTitleId,tagline_id:e.taglineId}},noisedIds:[i,s]})}sendFSSReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),i=ns.default.getUidMe();this.logAction999({type:GM.a.STICKER,payload:{src_id:i,des_id:s,chat_type:t,cate_id:e.categoryId,sticker_id:e.stickerId,group_id:t===xM.CHAT_GROUP?s:null},noisedIds:[i,s]})}});var zM,VM=s("dgg9"),HM=s("MjbT"),WM=s("ABlC"),$M=s("xn9U");class KM{constructor(){this.didChangeBusinessInfo=e=>{if(e&&e.bizInfo){const t=e.bizInfo.pkgId,s=i.ModuleContainer.resolve(VM.f);s.getBannerPositions().forEach((e=>{var i;const n=s.getBannerAtPosition(e);n&&n.type===VM.a.BUSINESS&&null!==(i=n.targetPkgIds)&&void 0!==i&&i.includes(t)&&s.closeBannerAtPosition(e)}))}}}onStart(){ns.default.subscribeEventFriend(R.EventFriend.UPGRADE_BIZ_PROFILE,this.didChangeBusinessInfo),ns.default.subscribeEventFriend(R.EventFriend.DOWNGRADE_BIZ_PROFILE,this.didChangeBusinessInfo)}onDispose(){ns.default.unsubscribeEventFriend(R.EventFriend.UPGRADE_BIZ_PROFILE,this.didChangeBusinessInfo),ns.default.unsubscribeEventFriend(R.EventFriend.DOWNGRADE_BIZ_PROFILE,this.didChangeBusinessInfo)}allowAddBannerAtPosition(e,t){if(e.type===VM.a.BUSINESS){var s;const t=ns.default.getPkgInfo(ns.default.getUidMe());if(t&&null!==(s=e.targetPkgIds)&&void 0!==s&&s.includes(t.pkgId))return"number"==typeof e.targetPkgRenewThreshold&&e.targetPkgRenewThreshold>0&&"number"==typeof t.expired&&t.expired-yn.default.getTimeNow()<=e.targetPkgRenewThreshold}return!0}}class qM{constructor(){this.didChangeZCloudPlan=e=>{const t=i.ModuleContainer.resolve(VM.f);t.getBannerPositions().forEach((s=>{var i;const n=t.getBannerAtPosition(s);n&&n.type===VM.a.ZCLOUD&&null!==(i=n.targetPkgIds)&&void 0!==i&&i.includes(e)&&t.closeBannerAtPosition(s)}))}}onStart(){EE.a.getInstance().addListener(SE.c.CHANGE_PLAN,this.didChangeZCloudPlan)}onDispose(){EE.a.getInstance().removeListener(SE.c.CHANGE_PLAN,this.didChangeZCloudPlan)}allowAddBannerAtPosition(e,t){if(e.type===VM.a.ZCLOUD){var s;const t=HE.a.getInstance().plan;if(null!==(s=e.targetPkgIds)&&void 0!==s&&s.includes(t)){if("number"==typeof e.targetPkgRenewThreshold&&e.targetPkgRenewThreshold>0){var i,n;const t=null===(i=WM.a.getInstance().getCloudInfo())||void 0===i||null===(n=i.subscription_info)||void 0===n?void 0:n.expire_time;if("number"==typeof t&&t-yn.default.getTimeNow()<=e.targetPkgRenewThreshold)return!0}return!1}}return!0}}Object(Je.d)()(zM=Object(Je.i)()(zM=Object(Je.g)()(zM=Object(i.singleton)(VM.f)(zM=Reflect.metadata("design:type",Function)(zM=Reflect.metadata("design:paramtypes",[])(zM=class{constructor(){this.logger=void 0,this.cacheBanners=void 0,this.hiddenBanners=void 0,this.repushedTimeCache=void 0,this.repushTimeout=void 0,this.businessManager=void 0,this.zcloudManager=void 0,this.isAppReady=void 0,this.businessManager=new KM,this.zcloudManager=new qM,this.cacheBanners=new Map,this.hiddenBanners=new AM.a(VM.j),this.repushedTimeCache=new AM.a(VM.k),this.repushTimeout=new Map}onStart(){this.businessManager.onStart(),this.zcloudManager.onStart()}onApplicationReady(){this.isAppReady=!0}onDispose(){this.businessManager.onDispose(),this.zcloudManager.onDispose()}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Me.ZLoggerNametags.operationBanner)),this.logger}allowAddBannerAtPosition(e,t){switch(e.type){case VM.a.BUSINESS:return this.businessManager.allowAddBannerAtPosition(e,t);case VM.a.ZCLOUD:return this.zcloudManager.allowAddBannerAtPosition(e,t);default:return!0}}checkForRepushingBannerItem(e){const t=this.cacheBanners.get(e);if(t&&t.max_repush&&HM.default._isValidEventData(t)){this.Logger.zsymb(0,"WjY5Ae","check repush hidden",e);let s=this.repushedTimeCache.getItem(e)||0;const i=this.hiddenBanners.getItem(e),n=t.delay_time_repush||0;if(i&&n>0&&s<t.max_repush){const a=i+n-yn.default.getTimeNow();this.Logger.zsymb(0,"S1Lkx6",`do repush ${e} remaining_time=${a}`),a<=0?(s+=1,this.repushedTimeCache.setItem(e,s),this.hiddenBanners.removeItem(e),this.showBannerAtPosition(t,t.displayPosition)):this.repushTimeout.set(t.displayPosition,window.setTimeout((()=>this.checkForRepushingBannerItem(e)),a))}else this.Logger.zsymb(0,"vLy_xI",`not allow repush ${e}`,`delay=${n}`,`repushed=${s} max_repush=${t.max_repush}`)}}checkForRepushing(){this.hiddenBanners.keys().forEach((e=>{this.checkForRepushingBannerItem(e)}))}bannerWillProcess(){this.cacheBanners.clear(),this.repushTimeout.forEach((e=>{window.clearTimeout(e)})),this.repushTimeout.clear()}async bannerDidProcess(e){if(this.isAppReady){var t,s;if(null===(t=WM.a.getInstance().getCloudInfo())||void 0===t||null===(s=t.subscription_info)||void 0===s||!s.expire_time)try{await $M.a.getInstance().getExpireTime()}catch(n){this.Logger.zsymb(18,"LHAj00","get cloud expire time err",n)}setTimeout((()=>{e.forEach(this.showBannerAtPosition.bind(this)),this.checkForRepushing()}),200)}else i.ModuleContainer.resolve(Je.a).addEventListenerOnce(Je.b.ServicesReady,(()=>{this.isAppReady=!0,this.bannerDidProcess(e)}))}comparePriority(e,t){if(!t)return!0;const s=e.priority||0,i=t.priority||0;return s>i||!(s<i)&&e.startTimeInMillis>=t.startTimeInMillis}addPrioritizedBannerToMap(e,t,s){const i=this.getGlobalBannerId(t);return!(E.default.getInstance().getItemForCurrentUser(i)||this.hiddenBanners.hasItem(i))&&this.allowAddBannerAtPosition(t,e)&&this.comparePriority(t,s.get(e))?s.set(e,t):s}getGlobalBannerId(e){let t=e.displayPosition+"_"+e.id;return e.actionContent&&e.actionContent.version&&(t=t+"_"+e.actionContent.version),t}processBannerFromServerInfo(e){this.bannerWillProcess();const t=new Map;if(!e||"object"!=typeof e)return this.bannerDidProcess(t),this.Logger.zsymb(0,"ONk4a6","invalid data banner!",e),t;for(const s in e)if(Array.isArray(e[s]))for(let i=0;i<e[s].length;i++){const n=e[s][i];if(!n)continue;try{n.actionContent=JSON.parse(n.actionContent)}catch{}if(!HM.default._isValidEventData(n))continue;const a=this.getGlobalBannerId(n);if(n.displayPosition===R.BANNER_POS_CSC_HEADER||n.displayPosition===R.BANNER_POS_EMPTY_SCREEN){const e=n.displayPosition===R.BANNER_POS_CSC_HEADER?n.actionContent.topBanners:n.actionContent.emptyBanners;if(e){const s=[];for(let t=0;t<e.length;t++){const i=e[t];!i||i.condition&&!ho.default.userMeetConditions(HM.default._fnCallbackTmp?HM.default._fnCallbackTmp():HM.default._getUserData(),i.condition)||s.push(i)}if(s.length>0){const e=s[Math.floor(Math.random()*s.length)];this.addPrioritizedBannerToMap(n.displayPosition,e,t),this.cacheBanners.set(a,e)}}}else this.addPrioritizedBannerToMap(n.displayPosition,n,t),this.cacheBanners.set(a,n)}return this.bannerDidProcess(t),t}getBannerAtPosition(e){switch(e){case R.BANNER_POS_TAB_MSG_HEADER:return mi.default.messageBanner;case R.SIDEBAR_TOP_AVATAR:return mi.default.santa_hat;case R.SIDEBAR_LEFT_MENU:return mi.default.leftMenu;case R.BANNER_POS_CSC_HEADER:return mi.default.topBanner;case R.BANNER_POS_EMPTY_SCREEN:return mi.default.emptyBanner;default:return null}}getBannerPositions(){return[R.BANNER_POS_TAB_MSG_HEADER,R.SIDEBAR_TOP_AVATAR,R.SIDEBAR_LEFT_MENU,R.BANNER_POS_CSC_HEADER,R.BANNER_POS_EMPTY_SCREEN]}closeBannerAtPosition(e){const t=this.getBannerAtPosition(e);if(t){const s=this.getGlobalBannerId(t);this.hiddenBanners.setItem(s,yn.default.getTimeNow()),HM.default._setBannerAtPosition(null,e);const n=t.delay_time_repush||0;return e===R.BANNER_POS_TAB_MSG_HEADER&&i.ModuleContainer.resolve(No.ConvListController).rerenderList(),n>0&&this.repushTimeout.set(e,window.setTimeout((()=>this.checkForRepushingBannerItem(s)),n)),this.Logger.zsymb(0,"zrjXZ7","closed banner",s,e,`delay repush=${n}`),!0}return!1}showBannerAtPosition(e,t){if(this.Logger.zsymb(0,"bxKGR7","request show banner",e.id,t),this.allowAddBannerAtPosition(e,t)){const s=this.getBannerAtPosition(t);if(this.comparePriority(e,s))return HM.default._setBannerAtPosition(e,t),t===R.BANNER_POS_TAB_MSG_HEADER&&i.ModuleContainer.resolve(No.ConvListController).rerenderList(),this.Logger.zsymb(0,"Gc6OJu","done show banner",e.id),!0}return!1}})||zM)||zM)||zM)||zM)||zM);var QM=s("yQd5");const ZM=`${QM.b}-network-manager`;var JM=Object(i.define)(ZM),YM=s("DPHK");var XM=class{constructor(){}updateMyAvatar(e,t,s,i={},n=!1){return ns.default.updateMyAvatar(e,s,t,i)}updateGroupAvatar(e,t,s,i,n){let a=QM.a.w,r=QM.a.h;return n&&(n.originWidth&&(a=n.originWidth),n.originHeight&&(r=n.originHeight)),this.resolveRequest(pu.default.updateAvatar(e,t,i,s,a,r))}updateAvatar(e,t,s=120,i={},n=!1){const a=e+YM.a.getFullTimeFromMilisecond((new Date).getTime());return ho.default.isGroup(e)?this.updateGroupAvatar(e,s,t,a,i):this.updateMyAvatar(s,t,a,i,n)}async reuseAvatar(e,t){let s={photoId:e,isPostSocial:t?1:0};const i=di.b.getProfileDomain()+"/api/social/reuse-avatar?"+this._getCommonParams()+"&params="+this.getEncodedParams(s);return this.resolveRequest(this._get(i,null,12453))}async getAvatarHistory(e,t,s,i){let n={page:e,albumId:s,count:i};t&&(n.photoId=t);const a=di.b.getProfileDomain()+"/api/social/avatar-list?"+this._getCommonParams()+"&params="+this.getEncodedParams(n);return this.resolveRequest(this._get(a,null,12451))}deleteAvatarHistory(e){let t={delPhotos:JSON.stringify(e.map((e=>({photoId:e.toString()}))))};const s=di.b.getProfileDomain()+"/api/social/del-avatars?"+this._getCommonParams()+"&params="+this.getEncodedParams(t);return this.resolveRequest(this._get(s,null,12452))}_get(e,t,s){return pu.default._get(e,t,s)}_getCommonParams(){return pu.default._getCommonParams()}getEncodedParams(e){return pu.default.getEncodedParams(e)}resolveRequest(e){return new Promise(((t,s)=>{e.then(gu.a).then(t).catch(s)}))}};i.ModuleContainer.register(JM,class{get api(){return this._api||(this._api=new XM),this._api}constructor(){this._api=void 0,this._logger=void 0,this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(QM.b,["network-manager"])}async updateAvatar(e,t,s,i,n){this._logger.zsymb(0,"SzPrMq",`updateAvatar [convId: ${e}], [s: ${t.size}] [share: ${n}] [meta:`,i);try{return await this.api.updateAvatar(e,t,s,i,n),Promise.resolve(!0)}catch(a){return this._logger.zsymb(18,"mgichE",`updateAvatar [convId: ${e}], [err:`,a),Promise.reject(a)}}async getAvatarHistory(e,t,s,i){return this._logger.zsymb(0,"cFQSWP",`getAvatarHistory [p:${e}], [pId:${t}], [aId:${s}], [c:${i}]`),this.api.getAvatarHistory(e,t,s,i)}async reuseAvatar(e,t){return this._logger.zsymb(0,"Q7XDaZ",`reuseAvatar [photoId: ${e}], [isPostSocial:`,t,"]"),this.api.reuseAvatar(e,t)}async deleteAvatarHistory(e){this._logger.zsymb(0,"poMPxm","deleteAvatarHistory [photoIds: ",e);try{return await this.api.deleteAvatarHistory(e),Promise.resolve(!0)}catch(t){return Promise.reject(t)}}});const eS=`${QM.b}-repository`;var tS=Object(i.define)(eS);const sS=`${QM.b}-storage`;var iS,nS=Object(i.define)(sS),aS=s("nKYX"),rS=s("dVwc");let oS=Object(i.injectable)()(iS=function(e,t){return Object(i.inject)(nS)(e,void 0,0)}(iS=function(e,t){return Object(i.inject)(JM)(e,void 0,1)}(iS=Reflect.metadata("design:type",Function)(iS=Reflect.metadata("design:paramtypes",[Object,Object])(iS=class{constructor(e,t){this.storage=e,this.fetcher=t}reuseAvatar(e,t){return this.fetcher.reuseAvatar(e,t)}updateAvatar(e,t,s,i,n){return this.fetcher.updateAvatar(e,t,s,i,n)}async getAvatarHistory(e=0,t="",s="0",i=50){try{const n=await this.fetcher.getAvatarHistory(e,t,s,i);return this.mapApiDataToBackup(n),this.mapApiDataToModel(n)}catch(n){let e=aS.a.ERR_GET_AVA_HISTORY;return n&&n.code&&(e=n.code),Promise.reject({code:e,message:(null==n?void 0:n.message)||n})}}deleteAvatarHistory(e){return this.fetcher.deleteAvatarHistory(e)}mapApiDataToBackup(e){e.photos.length&&e.photos.forEach((({url:e,bkUrl:t})=>{rS.a.getInstance().setBackup(e,t)}))}mapApiDataToModel(e){return{albumId:e.albumId,hasMore:Boolean(e.hasMore),nextPhotoId:e.nextPhotoId,photos:e.photos.length?e.photos.map((e=>({photoId:e.photoId,thumb:e.thumbnail,url:e.url}))):[]}}})||iS)||iS)||iS)||iS)||iS;i.ModuleContainer.register(tS,oS);var lS;i.ModuleContainer.register(nS,class{constructor(){this._storage=void 0,this._logger=void 0}get storage(){return this._storage||(this._storage=tt.default.getInstance()),this._storage}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(QM.b,["storage"])),this._logger}async getAvatarHistory(){return new Promise((async(e,t)=>{try{e(await this.storage.Core.AvaHistory.getAll())}catch(s){return this.logger.zsymb(18,"tkT5xi","getAvatarHistory",s),t(s)}}))}addNewAvatarToHistory(e){const t=(new Date).getTime();return this.storage.Core.AvaHistory.insert(Object(f.a)(Object(f.a)({},e),{},{submit_dttm:t}),{replace:!0})}deleteAvatarHistory(e){return this.storage.Core.AvaHistory.delete(e)}});let cS=Object(i.injectable)()(lS=function(e,t){return Object(i.inject)(tS)(e,void 0,0)}(lS=Reflect.metadata("design:type",Function)(lS=Reflect.metadata("design:paramtypes",[Object])(lS=class{get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(QM.b,[Ve.ZLoggerNametags.controller])),this._logger}constructor(e){this.repository=e,this._logger=void 0,this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._historyAvatars=[],this._retryLoadMore=1}getFrameList(e){return e?mi.default.operation_frame_list.group:mi.default.operation_frame_list.personal}getDefaultAvatarList(){var e,t;return(null===mi.default||void 0===mi.default||null===(e=mi.default.settings)||void 0===e||null===(t=e.group)||void 0===t?void 0:t.avt_group_template)||null}async getInitialAvatarHistory(e=50){return this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._retryLoadMore=1,await this.getAvatarHistory(e)}async loadMoreAvatarHistory(){if(this._avatarHistoryMeta.hasMore&&this._retryLoadMore<3)try{return await this.getAvatarHistory()}catch(e){return this.logger.zsymb(0,"AqOvtn","loadMoreAvatarHistory error",e),this.logger.zsymb(0,"4GO6K1","retry loadmore",this._retryLoadMore),this._retryLoadMore++,this.loadMoreAvatarHistory()}return[]}async getAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:aS.a.ERR_NO_NETWORK,message:""});try{const t=await this.repository.getAvatarHistory(this._avatarHistoryMeta.page,this._avatarHistoryMeta.photoId,this._avatarHistoryMeta.albumId,e||50);return this._avatarHistoryMeta={albumId:t.albumId,page:this._avatarHistoryMeta.page+1,photoId:t.nextPhotoId,hasMore:t.hasMore},Array.prototype.push.apply(this._historyAvatars,t.photos),t.photos}catch(t){return this.logger.zsymb(18,"z-pOkJ","Error getting avatar history",t),Promise.reject({code:aS.a.ERR_GET_AVA_HISTORY,message:(null==t?void 0:t.msg)||(null==t?void 0:t.message)})}}async deleteAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:aS.a.ERR_NO_NETWORK,message:""});try{return await this.repository.deleteAvatarHistory([e]),this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),!0}catch(t){if(this.logger.zsymb(18,"qn4YDE","deleteAvatarHistory",t),t&&t.errMap){const s=t.errMap;return Promise.reject({code:s[e],message:""})}return Promise.reject({code:aS.a.DELETE_AVATAR_ERROR,message:""})}}updateAvatar(e,t,s,i,n){return this.isValidNetwork()?this.repository.updateAvatar(e,t,s,i,n):Promise.reject({code:aS.a.ERR_NO_NETWORK,message:""})}async reuseAvatar(e,t){try{await this.repository.reuseAvatar(e,t);const s=this._historyAvatars.find((t=>t.photoId===e));return s&&(this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),this._historyAvatars.unshift(s)),!0}catch(s){return Promise.reject(!1)}}isValidNetwork(){return fu.b.getStateNetwork()===fu.a.CONNECTED}})||lS)||lS)||lS)||lS;var dS=s("TGcW").a;i.ModuleContainer.registerSingleton(dS,cS);var uS=class{constructor(){this._eventEmitter=new Cp.EventEmitter}addListener(e,t){this.eventEmitter.addListener(e,t)}emit(e,...t){return this.eventEmitter.emit(e,...t)}on(e,t){this.eventEmitter.on(e,t)}once(e,t){this.eventEmitter.once(e,t)}off(e,t){this.eventEmitter.off(e,t)}removeAllListeners(e){this.eventEmitter.removeAllListeners(e)}removeListener(e,t){this.eventEmitter.removeListener(e,t)}get eventEmitter(){return this._eventEmitter}};var hS=class extends uS{constructor(){super()}};var gS,mS=Object(i.define)("chat-list-manager-event-emitter");Object(i.singleton)(mS)(gS=Reflect.metadata("design:type",Function)(gS=Reflect.metadata("design:paramtypes",[])(gS=class extends hS{constructor(){super()}})||gS)||gS);var pS,fS=Object(i.define)("chat-list-ui-event-emitter");Object(i.singleton)(fS)(pS=Reflect.metadata("design:type",Function)(pS=Reflect.metadata("design:paramtypes",[])(pS=class extends hS{constructor(){super(),this.broadcastEventChanged=e=>{this.emit(bi.ChatListRenderEvent.OnDataChange,e)},i.ModuleContainer.resolve(mS).on(bi.ChatListRenderEvent.OnDataChange,this.broadcastEventChanged)}})||pS)||pS);var vS=class{constructor(e){this._token=void 0,null!=e&&(this.token=e)}isValidated(){return Boolean(this._token)}setToken(e){this.token=e}toString(){return void 0===this.token||null===this.token?"":String(this.token)}get token(){return this._token}set token(e){this._token=e}},bS=s("dA2Z");var IS=class{constructor(e){this._chatID="",this._messages=[],this._name="",void 0!==e.chatID&&e.chatID,this.chatID=e.chatID,e.name&&(this.name=e.name)}cleanUp(){}getMessages(){return Object($o.a)(this.chatID).messages||[]}async requestMessages(e,t){const{amount:s=this.getDefaultLoadMoreMessagesAmount(),direction:i=bS.d.Backwards,fromMessageID:n}=e||{},{events:a,opts:r}=t||{};return n?i===bS.d.Backwards?fl.default.loadTopMessagesForConversation(this.chatID,a,r):i===bS.d.Forwards?fl.default.loadBottomMessagesForConversation(this.chatID,a,r):i===bS.d.Around?fl.default.jumpToMessage():[]:fl.default.getLastMessagesForConversation(this.chatID)}getDefaultLoadMoreMessagesAmount(){return mi.default.numberMessage}get chatID(){return this._chatID}set chatID(e){this._chatID=e}get messages(){return this._messages}set messages(e){this._messages=e}get name(){return this._name}set name(e){this._name=e}};var yS,_S=Object(i.define)("chat-list-controller-factory");Object(i.singleton)(_S)(yS=class{constructor(){this._instanceMap=new Map,this._localID=new xi.a}createController(e,t,s){if(t){if(this.isExistingController(t)){const e=this.instanceMap.get(t);if(e)return[t,e]}const s=new IS({chatID:e,name:t.toString()});return this.mapControllerToToken(t,s),[t,s]}const i=this.getUniqueToken(),n=new IS({chatID:e,name:i.toString()});return this.mapControllerToToken(i,n),[i,n]}deleteController(e){if(!this.isExistingController(e))return!1;return this.getExistingController(e).cleanUp(),this.instanceMap.delete(e.toString()),!0}getController(e){if(this.isExistingController(e))return this.getExistingController(e)}getExistingController(e){return this.instanceMap.get(e.toString())}getUniqueToken(){return new vS(this.localID.next().toString())}isExistingController(e){return this.instanceMap.has(e.toString())}mapControllerToToken(e,t){this.instanceMap.set(e.toString(),t)}get instanceMap(){return this._instanceMap}set instanceMap(e){this._instanceMap=e}get localID(){return this._localID}set localID(e){this._localID=e}});var CS=_S;var OS,ES=class{constructor(){this._map=new Map}deleteToken(e){this.map.delete(e)}hasToken(e){return this.map.has(e)}getToken(e){return this.map.get(e)}setToken(e,t){this.isValidatedToken(t)&&this.map.set(e,t)}isValidatedToken(e){return Boolean(e&&"function"==typeof e.isValidated&&e.isValidated())}get map(){return this._map}set map(e){this._map=e}},MS=s("wv5Y");Object(i.injectable)()(OS=Object(i.singleton)(MS.a)(OS=function(e,t){return Object(i.inject)(CS)(e,void 0,0)}(OS=function(e,t){return Object(i.inject)(mS)(e,void 0,1)}(OS=Reflect.metadata("design:type",Function)(OS=Reflect.metadata("design:paramtypes",[Object,Object])(OS=class{constructor(e,t){this.controllerFactory=e,this.eventEmitter=t,this._tokenManager=new ES}closeConversation(e,t){const s=this.createTokenForController(e,t);this.controllerFactory.deleteController(s),this.deleteTokenFromWindowID(t,s)}getMessages(e,t){const s=this.getController(e,t);return s?s.getMessages():[]}openConversation(e,t){const s=this.createTokenForController(e,t),[i,n]=this.controllerFactory.createController(e,s);this.mapTokenToWindowID(t,i),n.requestMessages().then((()=>{const e={messages:n.getMessages()};this.notifyEventRender(bS.b.OnDataChange,e)})).catch((e=>{}))}async requestMessages(e,t,s,i){const n=this.getController(e,t);return n?n.requestMessages(s,i):[]}transformMessages(e){return e}createTokenForController(e,t){return new vS(t+"_"+e)}deleteTokenFromWindowID(e,t){this.tokenManager.deleteToken(e)}getController(e,t){const s=this.createTokenForController(e,t);return this.controllerFactory.getController(s)}notifyEvent(e,t){this.eventEmitter.emit(e,t)}notifyEventRender(e,t){this.notifyEvent(e,t)}mapTokenToWindowID(e,t){this.tokenManager.setToken(e,t)}get tokenManager(){return this._tokenManager}set tokenManager(e){this._tokenManager=e}})||OS)||OS)||OS)||OS)||OS);var SS=s("7w+8");var TS,wS=class{constructor(e){this.key="",this.name="",this._state={messages:[]},void 0!==e.key&&e.key,this.key=e.key,void 0!==e.name&&e.name,this.name="ChatListUIController_"+e.name,this.handleEventDataChanged=this.handleEventDataChanged.bind(this),this.init(e)}cleanUp(){Object(hs.l)(this),this.unregisterEventListeners()}getItem(e,t){if(e.key===bS.c.Messages)return this.state.messages}getList(e,t){return[]}init(e){Object(hs.e)(this),this.registerEventListeners()}onGetItemFailure(e,t){}onGetListFailure(e,t){}handleEventDataChanged(e){e.messages&&this.setState((t=>{t.messages=e.messages}),[bS.c.Messages])}registerEventListeners(){i.ModuleContainer.resolve(fS).on(bS.b.OnDataChange,this.handleEventDataChanged)}setState(e,t){const s=Object(kg.a)(this.state,e);this.state!==s&&(this.updateState(s),Array.isArray(t)&&t.forEach((e=>{Object(hs.h)(this.name,e)})))}unregisterEventListeners(){i.ModuleContainer.resolve(fS).off(bS.b.OnDataChange,this.handleEventDataChanged)}updateState(e){this.state=e}get state(){return this._state}set state(e){this._state=e}};Object(i.singleton)(SS.a)(TS=class{constructor(){this._existingTokenMap=new Map,this._instanceMap=new Map,this._localID=new xi.a}createController(e,t){let s=this.getExistingToken(e,t);if(void 0!==s&&this.isExistingController(s)){const e=this.getController(s);if(e)return[s,e]}s=this.generateToken(e,t);const i=new wS({key:s.toString(),name:s.toString()});return this.createControllerWithNewToken(e,t,s,i),[s,i]}deleteController(e,t){const s=this.getExistingToken(e,t);if(void 0!==s&&this.isExistingController(s)){const e=this.getController(s);e&&e.cleanUp(),this.removeController(s)}this.removeExistingToken(e,t)}addExistingToken(e,t,s){const i=this.getKeyFrom(e,t);this.existingTokenMap.set(i,s)}createControllerWithNewToken(e,t,s,i){this.addExistingToken(e,t,s),this.mapController(s,i)}getController(e){return this.instanceMap.get(e.toString())}getExistingToken(e,t){const s=this.getKeyFrom(e,t);return this.existingTokenMap.get(s)}getKeyFrom(e,t){return t+"_"+e}generateToken(e,t){const s=t+"_"+e+"_"+this.localID.next();return new vS(s)}isExistingController(e){return this.instanceMap.has(e.toString())}mapController(e,t){this.instanceMap.set(e.toString(),t)}removeController(e){this.instanceMap.delete(e.toString())}removeExistingToken(e,t){const s=this.getKeyFrom(e,t);this.existingTokenMap.delete(s)}get existingTokenMap(){return this._existingTokenMap}get instanceMap(){return this._instanceMap}get localID(){return this._localID}});var RS=Object(i.define)("chat-list-render-service"),LS=s("1Kge"),DS=s("rJdt"),AS=s("vUxW"),FS=s("g7V2"),jS=s("dMXo");class PS{constructor(){this.isAvatarShown=!1,this.isDateChanged=!1,this.isFirstInBlock=!1,this.isFirstInList=!1,this.isLastInBlock=!1,this.isLastInList=!1,this.isTimeSeparatorShown=!1,this.timestamp=0,this.vanishMode=void 0}setAvatarShown(e){return this.isAvatarShown=Boolean(e),this}setDateChanged(e){return this.isDateChanged=Boolean(e),this}setFirstInBlock(e){return this.isFirstInBlock=Boolean(e),this}setFirstInList(e){return this.isFirstInList=Boolean(e),this}setLastInBlock(e){return this.isLastInBlock=Boolean(e),this}setLastInList(e){return this.isLastInList=Boolean(e),this}setTimeSeparatorShown(e){return this.isTimeSeparatorShown=Boolean(e),this}setTimestamp(e){const t="number"==typeof e||!isNaN(Number(e));return Object(Q.b)(t,"Timestamp should be a number"),t&&(this.timestamp=+e),this}setVanishModeEnded(){return this.vanishMode="end",this}setVanishModeStarted(){return this.vanishMode="start",this}build(){return{isAvatarShown:this.isAvatarShown,isDateChanged:this.isDateChanged,isFirstInBlock:this.isFirstInBlock,isFirstInList:this.isFirstInList,isLastInBlock:this.isLastInBlock,isLastInList:this.isLastInList,isTimeSeparatorShown:this.isTimeSeparatorShown,timestamp:this.timestamp,vanishMode:this.vanishMode}}}class kS{constructor(e,t){this.type=void 0,this.data=void 0,this.UIDataBuilder=new PS,jS.a.isChatItem(e)?this.type=e:this.type=jS.a.for(String(e)),this.data=t}getData(){return this.data}getType(){return this.type}getUIBuilder(){return this.UIDataBuilder}getUIData(){return this.UIDataBuilder.build()}}var NS=s("x/wQ");function US(e){return e.msgType}function BS(e){return e.message}function xS(e,t,s){if(!e)return[];let i=[];const n=US(e);if(n===R.MSG_INFO_CHAT)i.push(new kS(jS.a.MessageInfo,e));else if(n===R.MSG_INFO||n===R.MSG_GROUP_NOTI||n===R.MSG_FRIEND_SENT_REQUEST||n===R.MSG_SUGGEST_IN_CHAT){let n=!1;mi.default.e2ee.invisible&&"update_e2ee"===e.act&&(n=!0),n||(i.push(new kS(jS.a.MessageEvent,e)),mi.default.enable_hi_group_member&&e.msgType===R.MSG_INFO&&"join"===e.act&&e.updateMemberIds&&e.updateMemberIds.indexOf(rt.p.getSessionUserId())>=0&&s.length-t<=15&&i.push(new kS(jS.a.Guide,e)))}else if(n===R.MSG_ECARD){const t=function(e,t){let s=!0;if(BS(e).type===R.ECARD_TYPE.FRIEND_ACCEPT||BS(e).type===R.ECARD_TYPE.FRIEND_ACCEPT_PASSIVE){const i=t.findIndex((t=>t.msgId===e.msgId));for(let e=i+1;e<i+15;e++){const i=t[e];if(!i)break;if(US(i)===R.MSG_ECARD&&BS(i).type===R.ECARD_TYPE.BIRTHDAY){s=!1;break}}}return s?new kS(jS.a.Ecard,e):null}(e,s);t&&i.push(t)}else if(n===R.MSG_POLL)i.push(new kS(jS.a.Poll,e));else if(n===R.MSG_TODO)i.push(new kS(jS.a.Todo,e));else if(Object(zf.X)(e)){let t=!1;const n=s.findIndex((t=>t.msgId===e.msgId));let a,r=s[n+1];r&&Object(zf.X)(r)&&(a=r),FS.isZInstantTypeSupported(e)&&(FS.shouldCollapseZInstantMsg(e,a)||FS.shouldRenderDefaultLayout(e))&&(t=!0);let o=null;o=new kS(!0===t?jS.a.ZInstant:jS.a.MessageItem,e),o&&i.push(o)}else i.push(new kS(jS.a.MessageItem,e));return i.length>0&&i.forEach((t=>{var s;t.getUIBuilder().setTimestamp(null!==(s=e.sendDttm)&&void 0!==s?s:e.ts)})),i}var GS=function(e,t,s){return Array.isArray(e)?e.map(((e,t)=>xS(e,t,s))).flat().map(((e,s,i)=>{var n;return 0===s&&(e.getUIBuilder().setFirstInBlock(!0),t.forEach((s=>{s===NS.a.VanishModeStarted?e.getUIBuilder().setVanishModeStarted():s===NS.a.VanishModeEnded?e.getUIBuilder().setVanishModeEnded():s===NS.a.SentTimeTooLong?e.getUIBuilder().setTimeSeparatorShown(!0):s===NS.a.DateChanged?e.getUIBuilder().setTimeSeparatorShown(!0).setDateChanged(!0):s===NS.a.FirstBlock?e.getUIBuilder().setTimeSeparatorShown(!0):s===NS.a.DifferentSender||s===NS.a.StandaloneTypeChanged&&(e.getUIBuilder().setTimeSeparatorShown(!0),e.getType()!==jS.a.MessageInfo&&e.getType()!==jS.a.MessageEvent&&e.getType()!==jS.a.Poll||t.includes(NS.a.SentTimeTooLong)||t.includes(NS.a.DateChanged)||e.getUIBuilder().setTimeSeparatorShown(!1)),s&&e.getUIBuilder().setAvatarShown(!0)}))),s===i.length-1&&e.getUIBuilder().setLastInBlock(!0),e.getType()===jS.a.MessageItem&&(null===(n=i[s-1])||void 0===n?void 0:n.getType())===jS.a.ZInstant&&e.getUIBuilder().setAvatarShown(!0),e})):[]},zS=s("XkoV"),VS=s("Gy64"),HS=s("CFkE"),WS=s("4KMa");function $S(e){try{return parseInt(e.cliMsgId)}catch(t){return 0}}var KS=function(e,t,s){const i=new Map;if(e.length<=0)return e;const n={},a={},r={},o=[];for(let d=0;d<e.length;d++){if(n[d])continue;const u=e[d];let h=u;const g=null!=a[d]?a[d]:t.getGroupPhotoId(u);if(g){var l;let i=u;const o=[u];let c=t.getTotalGroupPhotoItem(u)-1;if(c<=0)continue;for(let s=d+1;s<e.length;s++){if(n[s])continue;let i,r=e[s];if(null!=a[s]?i=a[s]:(i=t.getGroupPhotoId(r),a[s]=i),!i||g!=i)break;if(o.push(r),n[s]=!0,c--,0==c)break}o.sort(((e,t)=>$S(e)-$S(t)));const m=o.reduce(((e,t)=>t.e2eeStatus===R.MSG_E2EE||e),!1);let p;i=o[o.length-1],o.some((e=>{const t=Object(WS.h)(e);return VS.a.getInstance().isExisted(s,t)&&(p=VS.a.getInstance().getGroupId(s,t)),!!p})),p||(p=Object(WS.h)(o[0]));let v=p;r[v]&&(v=p+"_"+VS.a.getInstance().getRandKey()),r[v]=!0,o.forEach((e=>{const t=Object(WS.h)(e);VS.a.getInstance().setGroupId(s,t,v)})),h=Object(f.a)({msgId:v,cliMsgId:v,msgType:R.MSG_PHOTO_GROUP,sendDttm:i.sendDttm,status:null!==(l=t.getGroupStickerPhotoStatus(o))&&void 0!==l?l:i.status,fromUid:i.fromUid,toUid:i.toUid,message:o},m&&{e2eeStatus:R.MSG_E2EE})}const m=t.isStickerButNotNewFSSMessage(u),p=t.isNewFSSMessage(u),v=!m&&!p&&t.isAIStickerMessage(u),b=!m&&!p&&!v&&t.isPhotoStickerMessage(u),I=!m&&!p&&!v&&!b&&t.isNoBorderPhotoStickerMessage(u);if(m||b||v||p||I){var c;let s=u,a=s.cliMsgId;const r=[s];let o=u.status===R.MSG_FAIL;const l=t.getGroupStickerId(u.msgId),g=l&&!i.has(l)?l:"grp"+h.msgId,m=b?HS.e.PhotoSticker:v?HS.e.AISticker:p?HS.e.NewFSSticker:I?HS.e.NoBorderPhotoSticker:HS.e.Sticker,f=zS.a.isAuditBubbleMessageEnabled()&&t.isDFEOrUndoNewFSSMessage(u),y=t.getMaxStickerItemInGroup(f?HS.e.Sticker:m);for(let i=d+1;i<e.length;i++){if(n[i])continue;if(r.length>=y)break;let a=e[i];const l=t.isStickerButNotNewFSSMessage(a)||zS.a.isAuditBubbleMessageEnabled()&&t.isDFEOrUndoNewFSSMessage(a);if(!(a.sendDttm-s.sendDttm<3e5&&l))break;s=a,r.push(s),n[i]=!0,o&&a.status!==R.MSG_FAIL&&(o=!1)}r.length>1&&r.sort(((e,t)=>$S(e)-$S(t))),i.set(g,!0),h={msgId:g,cliMsgId:a,msgType:R.MSG_STICKER_GROUP,sendDttm:s.sendDttm,status:o?R.MSG_FAIL:null!==(c=t.getGroupStickerPhotoStatus(r))&&void 0!==c?c:s.status,fromUid:s.fromUid,toUid:s.toUid,message:r,UIContent:r,UIStickerTypeInGroup:m}}o.push(h)}return o};var qS,QS=function(e,t){var s,i;const n=[];if(!Array.isArray(e)||0===e.length)return n;const a=e.reduce(((e,t)=>(Array.prototype.push.apply(e,t.messages),e)),[]),r=e.length;let o,l=[];for(let g=0;g<r;g++){var c,d,u,h;const{messages:s,reasons:i}=e[g],r=null!==(c=null===(d=t.rules)||void 0===d||null===(u=d[AS.a.GroupMessages])||void 0===u||null===(h=u[R.MSG_STICKER_GROUP])||void 0===h?void 0:h.max)&&void 0!==c?c:1,m="function"==typeof r?r:()=>r,p=KS(s,{getGroupPhotoId:Jo.default.isGroupPhoto,getTotalGroupPhotoItem:Jo.default.getTotalItem,getMaxStickerItemInGroup:m,isStickerButNotNewFSSMessage:zf.M,isDFEOrUndoNewFSSMessage:e=>Object(zf.h)(e)||Object(zf.R)(e),isAIStickerMessage:zf.a,isNewFSSMessage:zf.y,isPhotoStickerMessage:zf.E,isNoBorderPhotoStickerMessage:zf.z,getGroupStickerPhotoStatus:DS.d.getGroupStickerPhotoStatus,getGroupStickerId:LS.a.getGroupId.bind(LS.a),setGroupStickerId:LS.a.setGroupId.bind(LS.a)},t.windowId);l.push(...GS(p,i,a)),Array.prototype.push.apply(n,l),l=[],o=p[p.length-1]}return null===(s=n[0])||void 0===s||s.getUIBuilder().setFirstInList(!0),null===(i=n[n.length-1])||void 0===i||i.getUIBuilder().setLastInList(!0),n};function ZS(e){return e.sendDttm}function JS(e){return e.msgType}function YS(e){return zS.a.getStandaloneMessageTypes().includes(e.msgType)}function XS(e){var t;return void 0!==(null===(t=e.eventInfo)||void 0===t?void 0:t.ttl)}function eT(e,t){return{messages:e,reasons:t}}function tT(e,t,s){if(void 0===e)return{isInContinuousBlock:!0,reasons:[]};const i=null==s?void 0:s[AS.a.BreakItem];let n=!0;const a=new Set,r=function(e,t){const s=JS(e),i=JS(t),n=s===R.MSG_INFO_CHAT||s===R.MSG_INFO&&"update_ttl"===s.act,a=i===R.MSG_INFO_CHAT||i===R.MSG_INFO&&"update_ttl"===t.act;return n&&a}(e,t),o=null==i?void 0:i[NS.a.SentTimeTooLong.toString()];var l,c,d;!r&&Boolean(o)&&(l=e,c=t,d="app-config"!==(null==o?void 0:o.time_to_break)?+o.time_to_break:zS.a.getTimeToBreakBlockMessages(),Math.abs(ZS(c)-ZS(l))>d)&&(n=!1,a.add(NS.a.SentTimeTooLong));const u=null==i?void 0:i[NS.a.DifferentSender.toString()];r||!Boolean(u)||function(e,t){return e.fromUid===t.fromUid}(e,t)||(n=!1,a.add(NS.a.DifferentSender));const h=null==i?void 0:i[NS.a.VanishModeStarted.toString()];!r&&Boolean(h)&&XS(t)&&(n=!1,!function(e){return null!=e.eventInfo&&e.eventInfo.ttl>0}(t)?a.add(NS.a.VanishModeEnded):a.add(NS.a.VanishModeStarted));const g=null==i?void 0:i[NS.a.StandaloneTypeChanged.toString()];return!r&&Boolean(g)&&function(e,t){return YS(e)!==YS(t)}(e,t)&&(n=!1,a.add(NS.a.StandaloneTypeChanged)),r||function(e,t){const s=ZS(e),i=ZS(t);if(!s||!i)return!1;let n=new Date(parseInt(s.toString())),a=new Date(parseInt(i.toString()));return n.getFullYear()===a.getFullYear()&&n.getMonth()===a.getMonth()&&n.getDate()===a.getDate()}(e,t)||(n=!1,a.add(NS.a.DateChanged)),{isInContinuousBlock:n,reasons:Array.from(a)}}function sT(e){return Object(f.a)({},e)}Object(i.singleton)(RS)(qS=class{buildChatItems(e,t){const s=function(e,t){if(!Array.isArray(e))return[];const s=e.filter((e=>Boolean(e))),i=[];let n=[];for(let a=s.length-1;a>=0;a--){const e=s[a];if(0===n.length){n.unshift(sT(e));continue}const r=n[0],{isInContinuousBlock:o,reasons:l}=tT(e,r,t.rules);o?n.unshift(sT(e)):(i.unshift(eT(n,l)),n=[sT(e)])}return n.length>0&&i.unshift(eT(n,[NS.a.FirstBlock])),i}(e,t);return QS(s,t)}});var iT=s("5xVU");var nT=function(e){const{conversation:t,data:s}=e;return At.a.createElement(iT.a,{isGroup:Boolean(null==t?void 0:t.isGroup),fromUid:null==s?void 0:s.fromUid})},aT=s("VHye");var rT=function(e){return At.a.createElement(aT.a,null)},oT=s("j7nq");var lT=function(e,t){var s;if(!e)return;let i={message:""};if("string"==typeof e.msg)i.message=e.msg;else try{const t=e.msg;i=Object(f.a)(Object(f.a)({},t),{},{message:t.title||""})}catch(r){}const n=null!==(s=e.ownerId)&&void 0!==s?s:e.fromUid,a=function(e,t){let s="";const i=e.fromUid||e.ownerId;if(i===rt.p.getSessionUserId()){const e=ns.default.getMiniProfileMe();s=(null==e?void 0:e.dName)||""}else if(Object(Yc.a)(t)){const e=ns.default.getDName(i);if(e)s=e;else{var n;const e=(null===(n=Zo.default.getMiniInfoGroup(t))||void 0===n?void 0:n.topMember)||[];for(let t of e)if(t.id===i){s=t.dName;break}}}return s||(s=ns.default.getDName(i)||""),s}(e,t);return{attach:"string"==typeof e.attach?oT.a.noExceptions(e.attach):e.attach,cliMsgId:e.cliMsgId,cliMsgType:e.cliMsgType,rootContent:i,msg:e.msg,globalMsgId:e.globalMsgId,ts:+e.ts,fromD:a,ownerId:n,ttl:e.ttl}};var cT=function(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}};var dT=function(e){if(e)return Object(f.a)(Object(f.a)({},e),{},{eventInfo:cT(e.eventInfo),quote:lT(e.quote,e.toUid),type:-1})};var uT=s("Nve0");var hT=function(e){var t,s,i;if(!e)return;let n=e.params;if("string"==typeof n)try{n=JSON.parse(n)}catch(c){}n||(n={});const a=function(e){switch(e){case 1:return uT.a.CALLEE_BUSY;case 2:return uT.a.TIMEOUT_HAVE_RINGING;case 3:return uT.a.CALLEE_REJECT;case 4:return uT.a.CALLER_REJECT_HAVE_RINGING;case 5:return uT.a.CALLER_REJECT_NOT_RINGING;default:return uT.a.DEFAULT}}(n.reason),r=e.action===R.CallMessageAction.MissCall?uT.b.MISSCALL:uT.b.CALLTIME,o=null!=n.isCaller?!!n.isCaller?uT.c.CALLER:uT.c.CALLEE:function(e){return e===R.CallMessageAction.Calling?uT.c.CALLER:uT.c.CALLEE}(e.action),l=function(e){return 1===e?uT.d.VIDEO:uT.d.AUDIO}(n.calltype);return{duration:null!==(t=null!==(s=n.duration)&&void 0!==s?s:e.duration)&&void 0!==t?t:0,isEnabledCallback:null!==(i=Boolean(n.isEnableCallback))&&void 0!==i&&i,reason:a,status:r,subject:o,type:l}};var gT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:hT(e.message)})};var mT=function(e){if(!e)return;let t=e.description,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(n){s={}}else"object"==typeof t&&(s=t);let i=-1;return e.action===R.MessageContentAction.User?i=HS.b.User:e.action===R.MessageContentAction.OA&&(i=HS.b.OA),{name:e.title,phone:s.phone,QRCodeURL:s.qrCodeUrl,gUid:s.gUid,oaShortLink:s.oaShortLink,href:e.href,thumb:e.thumb,type:i,userId:e.params}};var pT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:mT(e.message)})};var fT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:e.message})};var vT=function(e){if(e)return{pArtist:e.artist,pCount:e.count,pMediaTitle:e.mediaTitle,pSource:e.src,pStreamUrl:e.streamUrl,pStreamIcon:e.stream_icon,pType:e.type}};var bT=function(e){if(!e)return;const t=e.params;let s;if("string"==typeof t)try{const e=JSON.parse(t);s=vT(e)}catch(i){}else"object"==typeof t&&(s=vT(t));return Object(f.a)({title:e.title,description:e.description,href:e.href,thumb:e.thumb},s)};var IT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:bT(e.message)})};var yT=function(e){if(!e)return;let t=e.params,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(i){s={}}else"object"==typeof t&&(s=t);return{title:e.title,description:e.desc,isUserLocation:e.isUserLocation||s.isUserLocation||0,latitude:e.lat||s.latitude,longitude:e.lo||s.longitude,sourceID:e.sourceID||s.srcId||""}};var _T=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:yT(e.message)})};var CT=function(e){if(e)return Object(f.a)(Object(f.a)({},e),{},{id:e.id,cateId:e.catId,type:e.type,extInfo:e.extInfo})};var OT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:CT(e.message),msgType:e.msgType,UIType:HS.e.Sticker,src:e.src})};var ET=function(e){return{thumb_height:e.thumb_height,thumb_width:e.thumb_width,width:e.width,height:e.height,contentId:e.contentId,webp:{hd:e.webp.hd,url:e.webp.url,width:e.webp.width,height:e.webp.height}}};var MT=function(e){const t=e.params;let s={};if("string"==typeof t)try{s=ET(JSON.parse(t))}catch(i){}else"object"==typeof t&&(s=ET(t));return Object(f.a)(Object(f.a)({},e),{},{thumbUrl:e.thumbUrl,oriUrl:e.oriUrl,hdUrl:e.hdUrl,normalUrl:e.normalUrl,params:e.params,parsedParams:s})};var ST=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:MT(e.message),msgType:e.msgType,UIType:HS.e.PhotoSticker,properties:{color:e.properties.color,size:e.properties.size,type:e.properties.type,subType:e.properties.subType,ext:e.properties.ext}})},TT=s("z80d");var wT=function(e){return{contentId:e.contentId,pStickerType:TT.c.AI_STICKER,height:e.height,width:e.width,thumb_height:e.thumb_height,thumb_width:e.thumb_width,webp:{url:e.webp.url,width:e.webp.width,height:e.webp.height}}};var RT=function(e){const t=e.params;let s={contentId:"",thumb_height:-1,thumb_width:-1,width:-1,height:-1,pStickerType:TT.c.AI_STICKER,webp:{url:"",width:-1,height:-1}};if("string"==typeof t)try{s=wT(JSON.parse(t))}catch(i){0}else"object"==typeof t&&(s=wT(t));return{title:e.title,description:e.description,thumbUrl:e.thumbUrl,oriUrl:e.oriUrl,hdUrl:e.hdUrl,normalUrl:e.normalUrl,params:e.params,UIParsedParams:s}};var LT=function(e){let t={sSrcStr:"",sSrcType:-1};const s=e.properties.ext;if("string"==typeof s)try{t=JSON.parse(s)}catch(i){0}else"object"==typeof s&&(t=s);return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:RT(e.message),msgType:e.msgType,src:e.src,UIType:HS.e.AISticker,properties:{color:e.properties.color,size:e.properties.size,type:e.properties.type,subType:e.properties.subType,ext:e.properties.ext,UIParsedExt:t}})};function DT(e){const t=e.params,s=function(e){let t={};try{"string"==typeof e?t=JSON.parse(e):"object"==typeof e&&(t=e)}catch(s){zconsole.zsymb(3,"t_cZoh",["[transformMessageContent::NBPSParsedParams] failed: {}","eOxvzS"],null==s?void 0:s.message)}return{width:t.width,height:t.height}}(t);return{oriUrl:e.oriUrl,normalUrl:e.normalUrl,thumbUrl:e.thumbUrl,params:t,parsedParams:s}}var AT=function(e){return Array.isArray(e)?e.map((e=>{return Object(zf.E)(e)?ST(e):Object(zf.N)(e)?OT(e):Object(zf.a)(e)?LT(e):Object(zf.z)(e)?(t=e,Object(f.a)(Object(f.a)({},dT(t)),{},{UIContent:DT(t.message),msgType:t.msgType,UIType:HS.e.NoBorderPhotoSticker,properties:{color:t.properties.color,size:t.properties.size,type:t.properties.type,subType:t.properties.subType,ext:t.properties.ext}})):e;var t})):[]};var FT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:AT(e.message),msgType:R.MSG_STICKER_GROUP,UIType:HS.e.StickerGroup})};var jT=function(e){return Object(f.a)(Object(f.a)({},e),{},{id:e.id,name:e.name,desc:e.desc,isFree:e.isFree,iconUrl:e.iconUrl,iconPreview:e.iconPreview,thumbUrl:e.thumbUrl,totalImage:e.totalImage,group:e.group,version:e.version,permission:e.permission,isHidden:e.is_hidden,thumbImg:e.thumbImg,expireTime:e.expireTime})};var PT=function(e){let t=e.params,s={};if("string"==typeof t)try{s=jT(JSON.parse(t))}catch(i){}else"object"==typeof t&&(s=jT(t));return{title:e.title||s.name,thumb:e.thumb,action:e.action,href:e.href,description:e.description||s.desc,parsedParams:s}};var kT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:PT(e.message),UIType:HS.e.StickerSet})};var NT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:e.message})};var UT=function(e){var t,s,i,n;if(!e)return;let a=e.params,r={};if("string"==typeof a)try{r=JSON.parse(a)}catch(o){r={}}else"object"==typeof a&&(r=a);return{caption:null!==(t=e.title)&&void 0!==t?t:"",duration:null!==(s=null!==(i=r.duration)&&void 0!==i?i:e.duration)&&void 0!==s?s:0,fileSize:r.fileSize,height:r.video_height,quality:1===r.isHD?"HD":void 0,rotation:r.video_rotation,width:r.video_width,thumbUrl:null!==(n=e.thumbUrl)&&void 0!==n?n:"",parsed:r.parsed}};var BT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:UT(e.message)})};var xT=function(e){if(!e)return;let t=e.params,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(i){s={}}else"object"==typeof t&&(s=t);return{source:e.href,duration:s.duration||0,formats:{m4a:s.m4a}}};var GT=function(e){return Object(f.a)(Object(f.a)({},dT(e)),{},{UIContent:xT(e.message)})};var zT=s("ZTgy"),VT=s("3nWQ");const HT="call-message",WT={Caller:HT+"--caller",Callee:HT+"--callee",Selected:HT+"--selected",HasFooter:HT+"--has-footer"},$T=HT+"__title-wrapper",KT={Red:$T+"--red"},qT=HT+"__content-container",QT=HT+"__icon-wrapper",ZT=HT+"__content-txt-wrapper",JT=HT+"__separator",YT=HT+"__callback-wrapper";var XT=s("z5gp"),ew=s("7veT");function tw(e){const{subject:t}=e;return t===uT.c.CALLER?function(e){const{reason:t,status:s,type:i}=e;return s===uT.b.CALLTIME?i===uT.d.AUDIO?os.a.str("STR_CALL_TITLE_OUTGOING_CALL_AUDIO"):os.a.str("STR_CALL_TITLE_OUTGOING_CALL_VIDEO"):s===uT.b.MISSCALL?t===uT.a.CALLER_REJECT_NOT_RINGING||t===uT.a.CALLER_REJECT_HAVE_RINGING?os.a.str("STR_CALL_TITLE_OUTGOING_CALL_CANCEL"):t===uT.a.CALLEE_REJECT?os.a.str("STR_CALL_TITLE_OUTGOING_CALL_REJECTED"):t===uT.a.CALLEE_BUSY?os.a.str("STR_CALL_TITLE_OUTGOING_CALL_BUSY"):i===uT.d.AUDIO?os.a.str("STR_CALL_TITLE_OUTGOING_CALL_AUDIO"):os.a.str("STR_CALL_TITLE_OUTGOING_CALL_VIDEO"):""}(e):t===uT.c.CALLEE?function(e){const{reason:t,status:s,type:i}=e;return s===uT.b.CALLTIME?i===uT.d.AUDIO?os.a.str("STR_CALL_TITLE_INCOMING_CALL_AUDIO"):os.a.str("STR_CALL_TITLE_INCOMING_CALL_VIDEO"):s===uT.b.MISSCALL?t===uT.a.CALLEE_REJECT?os.a.str("STR_CALL_TITLE_INCOMING_CALL_REJECTED"):os.a.str("STR_CALL_TITLE_INCOMING_CALL_MISSED"):""}(e):""}const sw={IncomingAudio:"call-incoming-audio",IncomingMissedAudio:"call-incoming-missed-audio",IncomingMissedAudioGrayscale:"call-incoming-missed-audio-grayscale",IncomingMissedVideo:"call-incoming-missed-video",IncomingMissedVideoGrayscale:"call-incoming-missed-video-grayscale",IncomingVideo:"call-incoming-video",OutgoingAudio:"call-outgoing-audio",OutgoingMissedAudio:"call-outgoing-missed-audio",OutgoingMissedVideo:"call-outgoing-missed-video",OutgoingVideo:"call-outgoing-video",RejectedAudio:"call-rejected-audio",RejectedVideo:"call-rejected-video"};function iw(e,t=!1){const{subject:s}=e;return s===uT.c.CALLER?function(e){const{reason:t,status:s,type:i}=e;if(s===uT.b.CALLTIME){if(i===uT.d.AUDIO)return sw.OutgoingAudio;if(i===uT.d.VIDEO)return sw.OutgoingVideo}else if(s===uT.b.MISSCALL){if(i===uT.d.AUDIO)return t===uT.a.CALLEE_REJECT?sw.RejectedAudio:sw.OutgoingMissedAudio;if(i===uT.d.VIDEO)return t===uT.a.CALLEE_REJECT?sw.RejectedVideo:sw.OutgoingMissedVideo}return""}(e):s===uT.c.CALLEE?function(e,t=!1){const{reason:s,status:i,type:n}=e;if(i===uT.b.CALLTIME){if(n===uT.d.AUDIO)return sw.IncomingAudio;if(n===uT.d.VIDEO)return sw.IncomingVideo}else if(i===uT.b.MISSCALL){if(n===uT.d.AUDIO)return s===uT.a.CALLEE_REJECT?sw.RejectedAudio:t?sw.IncomingMissedAudioGrayscale:sw.IncomingMissedAudio;if(n===uT.d.VIDEO)return s===uT.a.CALLEE_REJECT?sw.RejectedVideo:t?sw.IncomingMissedVideoGrayscale:sw.IncomingMissedVideo}return""}(e,t):""}function nw(e){const t=e||0,s=t%60,i=Math.floor(t/60)%60,n=Math.floor(t/3600);const a=`${s} ${os.a.str("STR_SEC")}`;let r=`${`${i} ${i>1?os.a.str("STR_MINS"):os.a.str("STR_MIN")}`} ${a}`;if(n>0){r=`${`${n} ${n>1?os.a.str("STR_HOURS"):os.a.str("STR_HOUR")}`} ${r}`}return r}var aw=function(e){const t=iw(e),s=function(e){const{duration:t,reason:s,status:i,subject:n,type:a}=e;if(i===uT.b.CALLTIME)return nw(t);if(i===uT.b.MISSCALL){if(n===uT.c.CALLER&&(s===uT.a.DEFAULT||s===uT.a.TIMEOUT_HAVE_RINGING))return nw(0);if(a==uT.d.AUDIO)return os.a.str("STR_CALL_CONTENT_AUDIO");if(a==uT.d.VIDEO)return os.a.str("STR_CALL_CONTENT_VIDEO")}return""}(e);return At.a.createElement("div",{className:qT},At.a.createElement("div",null,At.a.createElement("div",{className:QT},At.a.createElement(XT.a,{icon:t,size:"medium"})),At.a.createElement("div",{className:ZT},At.a.createElement("span",null,s))))};var rw=function(e){const t=e.subject===uT.c.CALLEE&&e.status===uT.b.MISSCALL;return At.a.createElement("div",{className:Object(gO.a)($T,t&&KT.Red)},tw(e))};const ow=()=>null;function lw(e){return e.visible?At.a.createElement("div",{className:JT}):At.a.createElement(ow,null)}function cw(e){return e.visible?At.a.createElement("div",{className:YT,onClick:e.onClick},os.a.str("STR_CALL_CALL_BACK")):At.a.createElement(ow,null)}var dw=function(e){const{data:t,isSelected:s,observeIntersectionForReading:i}=e,n=t.ttl,a=t.UIContent,{duration:r,isEnabledCallback:o,reason:l,status:c,subject:d,type:u}=a,h=At.a.useRef(null);Object(zT.a)(h,i);const g=o,m=Object(gO.a)(HT,s&&WT.Selected,d===uT.c.CALLER&&WT.Caller,d===uT.c.CALLEE&&WT.Callee,g&&WT.HasFooter);return At.a.createElement(VT.a,{border:6,className:Object(gO.a)(m,!Boolean(t.ttl)&&"shadow-bubble"),ttl:n,variant:"common"},At.a.createElement("div",{ref:h,"data-qId":Object(WS.g)(t)},At.a.createElement(rw,{reason:l,status:c,subject:d,type:u}),At.a.createElement(aw,{duration:r,reason:l,status:c,subject:d,type:u}),At.a.createElement(lw,{visible:g}),At.a.createElement(cw,{onClick:e=>{const{makeCall:s}=Object(gs.c)();"function"==typeof s&&function(e,t,s){const i=ew.a.ActionLog.getCallbackActionLog(t);as.default.logAction(i),"function"==typeof s&&s(e,t.type)}(e,a,s.bind(null,{chatID:t.toUid,callType:u}))},visible:g})))},uw=s("3jpH");const hw="contact-message",gw=hw+"__container",mw={HighlightFromPrivilegedUser:gw+"--highlight-from-privileged-user"},pw=hw+"__footer-container",fw={Blue:pw+"--blue",Selected:pw+"--selected"},vw=hw+"__footer-item-container",bw=hw+"__footer-item",Iw=hw+"__footer-item-separator";let yw="";function _w(e){e&&(e.stopPropagation(),e.preventDefault())}function Cw(e,t){var s;const n=e.data;if(!n)return[];const a=(null===(s=n.UIContent)||void 0===s?void 0:s.userId)||"",r=[];if(a===mi.default.sendToMeId){const e={id:"ShareToMyCloudButton",text:"STR_SEND2ME_SHARE",textArguments:[{textKey:"KEY_NAME_SEND2ME"}],handler:t.shareToMyCloud};return r.push(e),r}if(a===function(){if(!yw){const t=i.ModuleContainer.resolve(Je.a);var e;t&&(yw=(null===(e=t.getSession())||void 0===e?void 0:e.userId)||"")}return yw}())return r;const o=ns.default.isFriend(a);if(!(n.UIContent.type===HS.b.OA))if(o){if(Jl.c.isSupport()){const e={id:"CallButton",text:"STR_CONTACT_CARD_CALL_BTN",handler:t.makeCall};r.push(e)}}else{const e={id:"AddFriendButton",text:"STR_CONTACT_CARD_ADD_FRIEND_BTN",handler:t.addFriend};r.push(e)}const l={id:"ChatBtn",text:"STR_CONTACT_CARD_CHAT_BTN",handler:t.openChat,type:"secondary"};return r.push(l),r}function Ow({item:e}){return At.a.createElement("div",{className:vw,onClick:e.handler},At.a.createElement(lO.a,{className:Object(gO.a)(bw,e.type&&bw+`--${e.type}`),textKey:e.text,textArguments:e.textArguments,textTransform:"capital-case"}))}function Ew(e){const{items:t,isSelected:s,isSentFromMe:i,isShowShadow:n}=e;return At.a.createElement("div",{className:Object(gO.a)(pw,i&&fw.Blue,s&&fw.Selected,n&&"shadow-bubble")},t.map(((e,t)=>At.a.createElement(At.a.Fragment,null,0!==t&&At.a.createElement("div",{className:Iw}),At.a.createElement(Ow,{key:e.id,item:e})))))}var Mw=function(e){var t,s;const{data:i,isFocused:n,isHighlightedByPrivilegedUser:a,isMultiSel:r,MessageQuickActionRenderer:o,observeIntersectionForReading:l,selectedMsg:c={},windowId:d}=e,u=i.UIContent,h="0"===i.fromUid,g=Boolean(r&&c[i.msgId]),m=Boolean(r),p=null===(t=e.conversation)||void 0===t?void 0:t.userId,f=(null===(s=i.UIContent)||void 0===s?void 0:s.userId)||"",v=ns.default.getDName(f)||(null==u?void 0:u.name)||"",b=At.a.useRef(null);Object(zT.a)(b,l);const I=Cw(e,{addFriend:e=>{if(m)return;_w(e);const{addFriend:t}=Object(gs.c)();t&&t({userID:f,chatID:p,windowID:d})},makeCall:e=>{if(m)return;_w(e);const{makeVoiceCall:t}=Object(gs.c)();t&&t({chatID:f,windowID:d})},openChat:e=>{if(m)return;_w(e);const{openChat:t}=Object(gs.c)();t&&t({chatID:f,source:Ii.a.MessageOnMessaging})},shareToMyCloud:e=>{if(m)return;_w(e);const{makeVoiceCall:t}=Object(gs.c)();t&&t({chatID:f,windowID:d})}}),y=I.length>0;return At.a.createElement(VT.a,{border:6,className:Object(gO.a)(gw,a&&(null==i.ttl||0==i.ttl)&&mw.HighlightFromPrivilegedUser,"rounded-6","focused-item",n&&"focused-item--highlight-border"),isAdmin:a,variant:"common",ttl:i.ttl},At.a.createElement("div",{ref:b,"data-qId":Object(WS.g)(i),onContextMenu:function(t){if("function"!=typeof e.showContextMenu)return;e.showContextMenu({event:t,message:e.data})}},At.a.createElement(uw.ContactCard,{className:Object(gO.a)("rounded-t-6","cursor-pointer",!y&&"rounded-b-6"),avatarURL:u.thumb,name:v,description:u.phone||u.oaShortLink,isSelected:g,QRCodeURL:u.QRCodeURL,type:u.type,onClick:e=>{if(!m)if(_w(e),f===mi.default.sendToMeId){const{openChat:e}=Object(gs.c)();e&&e({chatID:f})}else{const{openProfileModal:e}=Object(gs.c)();e&&e({userId:f,selectConversationSource:178003,windowId:d})}},userId:u.userId}),y&&At.a.createElement(Ew,{items:I,isSelected:g,isSentFromMe:h,isShowShadow:!Boolean(i.ttl)}),o&&At.a.createElement(o,null)))};var Sw=function(e){const{className:t,data:s}=e;let i;return i=s.uidSenderDel?At.a.createElement("div",null,s.uidSenderDel==ns.default.getUidMe()||"0"==s.uidSenderDel?At.a.createElement(lO.a,{textKey:"STR_ME_DEL"}):At.a.createElement("span",null,ns.default.getDName(s.uidSenderDel)),At.a.createElement(lO.a,{textKey:"STR_DEL_EVERYONE_MSG"})):At.a.createElement(lO.a,{textKey:"STR_DEL_EVERYONE"}),At.a.createElement("div",{className:Object(gO.a)("dfe-message__container",t)},i)},Tw=s("F1UR"),ww=s("Wwxf"),Rw=s("hIA4"),Lw=s("t77n"),Dw=s("ggG7"),Aw=s("/Z5y"),Fw=s("EIuX"),jw=(s("QMJy"),s("SzKC")),Pw=s("yhYV");class kw extends jw.a{constructor(e){super(e),this.state=Object(f.a)({},this.state)}shouldComponentUpdate(e,t){return this.props.message.reacts!==e.message.reacts||this.props.shouldShowStatus!==e.shouldShowStatus||this.state.store.params!==t.store.params||this.props.message.status!==e.message.status||this.props.message.isLastMsg!==e.message.isLastMsg||this.props.message.isErrorInfo!==e.message.isErrorInfo||this.props.message.sendError!==e.message.sendError||this.props.onContextMenu!==e.onContextMenu||this.props.showInFolder!==e.showInFolder||this.props.className!==e.showInFolder}_loading(){return this._utils.loading({store:this.state.store,props:this.props})}render(){const{onContextMenu:e,onDoubleClick:t,onMouseOver:s,onMouseLeave:i,onTouchStart:n,onTouchEnd:a}=this.props,r={onMouseOver:s,onMouseLeave:i,onTouchStart:n,onTouchEnd:a},{fileIcon:o,fileThumb:l,fileTitle:c,fileTextInfo:d,fileActionDisplay:u,cloudDownloadingOrUploading:h,clickAction:g,isMe:m,notLoading:p}=this._loading();return p?At.a.createElement(Pw.a,Object(xt.a)({isMe:m},this.props)):At.a.createElement("div",Object(xt.a)({className:"file-message-v2 file-message__container"},r,{onClick:g,onContextMenu:e,onDoubleClick:t}),l,At.a.createElement("div-13",{className:"file-message__content-container",style:{minHeight:"49px"}},o,At.a.createElement("div",{className:"file-message__content"},c,At.a.createElement("div-13",{className:"file-message__content-info-container"},d,u),h)))}}var Nw=s("mE0M");function Uw(e){e&&(e.preventDefault(),e.stopPropagation())}function Bw(e,t){const s=At.a.useMemo((()=>function(e){var t,s;const i=e.message||e.file;let n=""+i.msgId,a="0"==i.fromUid?rt.p.getSessionUserId():i.fromUid;const r=Lw.a.utils.getPrimaryId(i),{FileChatModel:o}=Lw.a.models,l=Lw.a.getFileKey(r),c=Lw.a.get(l);let d=Object(Fw.o)(c);d||!i.isErrorInfo&&i.status!=R.MSG_FAIL||i.cancelled||(d=i.subType&&23==i.subType?{strKey:"STR_ERR_UPLOAD_FILE_FOLDER_ERROR",strKeyParams:[]}:{strKey:"STR_ERR_UPLOAD_FILE_ERROR",strKeyParams:[]});const u=Lw.a.utils.getMessageFileParams(i),h=Object(wE.a)(u),g=(null==h?void 0:h.fdata)&&Object(wE.a)(null==h?void 0:h.fdata),m=null!==(t=null==g?void 0:g.upSrc)&&void 0!==t?t:i.upSrc,p=null!==(s=null==g?void 0:g.reader)&&void 0!==s?s:i.reader,f=null==i?void 0:i.originMsgType,v={fromUid:a,localPath:Lw.a.utils.getLocalPath(e),folderPath:Lw.a.utils.getFolderPath(e),sendTime:i.sendDttm,cancelUpload:i.cancelled,sendFileError:d,upSrc:m,reader:p,originMsgType:f};Object.keys(v).forEach((e=>void 0===v[e]&&delete v[e]));const b=new o({params:u,conversationId:Lw.a.utils.getMessageConversationId(i),fileUrl:Lw.a.utils.getFileMessageUrl(i),status:Lw.a.utils.getFileMessageStatus(i),indicatorState:Lw.a.utils.getFileMessageIndicatorState(i),extraInfo:v});return Lw.a.dispatch(Pf.FileActionType.Init,{data:b,id:{p:r,s:n}}),r}(e)),[e.message.folderPath,e.message.localPath]),{windowId:i}=Object(SO.a)(),{setTrustedFileMsg:n}=e;e=Object(f.a)(Object(f.a)({},e),{},{pIdOrMsgId:s,windowKey:i});const{status:a,flag:r}=Object(Nw.a)(e.message),o=function(e){const{showActionInjectable:t,pIdOrMsgId:s}=e,i=Object(Dw.a)(e),n=Object(Aw.a)(s||"",Fw.j),a=Object(Aw.a)(s||"",Fw.i);return At.a.useCallback((e=>null==t?void 0:t(e,{contextMenu:!0,message:i,localPath:n,folderPath:a})),[i,t,n,a])}(Object(f.a)(Object(f.a)({},e),{},{status:a,flag:r})),l=Object(Dw.a)(e);At.a.useEffect((()=>{n&&n(l)}),[l,n]);const c=(Object(f.a)(Object(f.a)({},e),{},{status:a,flag:r}),null);return At.a.createElement(kw,Object(xt.a)({ref:t},e,{onContextMenu:o,onDoubleClick:Uw,showInFolder:c}))}var xw=At.a.memo(At.a.forwardRef(Bw));var Gw=At.a.forwardRef((function(e,t){return At.a.createElement(_s.a,null,At.a.createElement(xw,Object(xt.a)({},e,{ref:t})))}));const zw=ho.default.isWeb();let Vw,Hw;zw||(Vw=s("Dprd").default,Hw=$znode.path);var Ww=function(e){var t,s,n;const a=e.data,[r,o]=Object(Dt.useState)(a.localPath||""),[l,c]=Object(Dt.useState)(a.folderPath||""),[d,u]=Object(Dt.useState)(!(null==a||!a.msgId)&&void 0!==(null===(t=Vw)||void 0===t?void 0:t.getDownloadProgress(a.msgId))),[h,g]=Object(Dt.useState)(null!=a&&a.msgId&&(null===(s=Vw)||void 0===s?void 0:s.getDownloadProgress(a.msgId))||0),[m,p]=Object(Dt.useState)(0),[f,v]=Object(Dt.useState)(!1),[b,I]=Object(Dt.useState)(!1);return Object(Dt.useEffect)((()=>{(null==a?void 0:a.localPath)&&o(a.localPath),(null==a?void 0:a.folderPath)&&c(a.folderPath)}),[null==a?void 0:a.localPath,null==a?void 0:a.folderPath]),Object(Dt.useEffect)((()=>{Rw.a.getInstance().push(a,Rw.b.chatview)}),[]),Object(Dt.useEffect)((()=>{const e=(e,t)=>{if(e===Ai.ChatBoxActions.FILEPATH_UPDATED){if(t.msgId!==a.msgId)return;t.localPath!==r&&o(t.localPath)}};return Fi.default.subscribe(e),()=>{Fi.default.unsubscribe(e)}}),[r,a.msgId]),Object(Dt.useEffect)((()=>{var e;if(zw)return;const t=a.msgId;null===(e=i.ModuleContainer.resolve(Ui.a))||void 0===e||e.getMultiMedias("file",a.toUid,[t]).then((e=>{let s=e[0];s&&s.msgId===t&&(s.localPath&&o(s.localPath),s.folderPath&&c(s.folderPath),(s.localPath||s.folderPath)&&u(!1),s.downloadError&&v(!0))}))}),[a.msgId]),At.a.createElement(Gw,{windowId:e.windowId,conversation:e.conversation,isOnline:e.isOnline,dispatch:e.dispatch,emitter:e.emitter,uploadFiles:e.uploadFiles,uploadFilesNative:e.uploadFilesNative,scrollToBottom:e.scrollToBottom,message:a,userId:null===(n=e.user)||void 0===n?void 0:n.userId,senderName:function(){var t,s,i,n;if(null!==(t=e.conversation)&&void 0!==t&&null!==(s=t.userId)&&void 0!==s&&s.startsWith(R.GROUPID_PREFIX))return null==e?void 0:e.senderName;return"0"==(null==a?void 0:a.fromUid)?null===(n=e.user)||void 0===n?void 0:n.displayName:null==e||null===(i=e.friendInfo)||void 0===i?void 0:i.displayName}(),localPath:r||"",folderPath:l||"",isDownloading:d,downloadProgress:h,progressInBytes:m,downloadError:f,showShareError:b,showInFolder:function(e){e.preventDefault(),e.stopPropagation(),Object(Tw.a)(a),as.default.logAction(107190901)},manualDownload:function(e){e.preventDefault(),e.stopPropagation()},resendMessage:()=>{var t;null===(t=e.resendHandler)||void 0===t||t.call(e,a.resend,a)},showActionInjectable:(t,s)=>{!function(t,s){if("function"==typeof e.showContextMenu){const i=`openCtxMenu_File_${e.data.cliMsgId}`;ww.a.stopAll(),ww.a.for(i);const n={event:t,message:s.message,detail:{trackingCmdId:i,fileData:{localPath:s.localPath||r,folderPath:s.folderPath||l},fileHandler:{saveToDeviceHandler:(e,t)=>{"update"===e&&t.hasOwnProperty("isDownloading")&&u(t.isDownloading)}}}};e.showContextMenu(n)}}(t,s)}})},$w=s("ymth");var Kw=s("Hscn"),qw=s("QG4v"),Qw=s("xvBE");var Zw=function(e){const{children:t,className:s,isSelected:i}=e;return t?At.a.cloneElement(t,{style:t.props.style,className:Object(gO.a)(i&&"selected-message-overlay",s,t.props.className)}):At.a.createElement(At.a.Fragment,null)};const Jw="gif-message__container",Yw={HighlightFromPrivilegedUser:Jw+"--highlight-from-privileged-user"};var Xw=s("39bE"),eR=s("H/0Q");function tR(e){const t=e=>"string"==typeof e?e:"";return[t(null==e?void 0:e.oriUrl),t(null==e?void 0:e.normalUrl),t(null==e?void 0:e.thumbUrl)]}var sR=function(e){const{containerWidth:t,data:s,isFocused:i,isHighlightedByPrivilegedUser:n,isSelected:a=!1,observeIntersectionForReading:r}=e,[o,l]=At.a.useState(s.localPath),c=At.a.useRef(null),d=`${null==s?void 0:s.cliMsgId}.${null==s?void 0:s.fromUid}.${null==s?void 0:s.toUid}`;Object(zT.a)(c,r);const u=function(e,t=-1,s=0){const i=160+s,n=110,a=368;let r=Math.min(798,isNaN(t)?798:t);t<=-1&&(r=a);let o=!1;if(e.message&&e.message.params)try{let t=JSON.parse(e.message.params),s=-1,l=-1;if(s=e.width?e.width:t.width,l=e.height?e.height:t.height,void 0!==s&&null!=l||(s=a,l=a,o=!0),s>0&&l>0){let e=s,c=l;if(s<i&&l<n)c=n,e=i;else if(s>r&&l>a){let t=a/l;if(c=a,e=Math.round(s*t),e>r){t=r/e,e=r;let s=Math.round(c*t);c=Math.max(s,n)}e=Math.max(e,i)}else if(l>a){let t=a/l;c=a;let n=Math.round(s*t);e=Math.max(i,n)}else if(l>=n&&l<=a){if(s>r){let t=r/s;e=r;let i=Math.round(l*t);c=Math.max(n,i)}else if(s<i){e=i;let t=i/s,r=Math.round(l*t);c=Math.min(Math.max(n,r),a)}}else if(l<n){c=n;let t=n/l,a=Math.round(t*s);e=s>r?r:Math.min(Math.max(i,a),r)}return{height:c,width:e,defaultSize:o,rotation:t.rotation,flip:t.flip}}}catch(l){}return{width:a,height:a,defaultSize:!0}}(s,t-192),h=tR(s.message).map((e=>({src:e}))),g=At.a.useMemo((()=>({backgroundColor:"transparent",borderRadius:"4px",height:u.height+"px",width:u.width+"px"})),[u.height,u.width]);async function m(){return Object(eR.a)(s)}return At.a.createElement(Qw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryClick:t=>{var i;t.preventDefault(),t.stopPropagation(),null===(i=e.resendMessage)||void 0===i||i.call(e,t,s)}},At.a.createElement(Zw,{isSelected:a},At.a.createElement(VT.a,{border:6,className:Object(gO.a)(Jw,n&&(null==s.ttl||0==s.ttl)&&Yw.HighlightFromPrivilegedUser,"rounded-6","focused-item",i&&"focused-item--highlight-border"),isAdmin:n,variant:"common",ttl:s.ttl,style:{height:u.height+2+"px",width:u.width+2+"px"},onContextMenu:t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:e.data,detail:{handleManualDownloadSuccess:e=>{l(e)},handleUpdateFilePath:e=>{l(e)},localPath:o}};e.showContextMenu(s)}},At.a.createElement("div",{ref:c,"data-qId":Object(WS.g)(s)},At.a.createElement("div",{style:g},2===Zm.a.image_loader.version&&At.a.createElement(Xw.a.CenterBox,{className:"image-box",width:"100%",height:"100%"},At.a.createElement(Xw.a.Loader,{entry:Sm.k.MESSAGE_LIST,mediaId:d,srcs:h,retryWhenOnline:!0,useHttpsSource:!0},At.a.createElement(Xw.a.Image,null),At.a.createElement(Xw.a.LoaderErrorCatch,{expiryCheck:m,manualRetryOnClick:!0,render:e=>At.a.createElement(Xw.a.DefaultImageError,{mediaId:d,error:e,style:{width:"inherit",height:"inherit"}})}))),1===Zm.a.image_loader.version&&At.a.createElement(qw.a,{entry:Sm.k.MESSAGE_LIST,mediaId:d,urls:Object(Kw.a)(tR(s.message)),imageStyle:g,status:s.status,expiryCheck:m}))))))},iR=s("blq4"),nR=s("O7EA"),aR=s("0cNv"),rR=s("OONb"),oR=s("UZOM");const lR=["CHAT_BOX_LIST_LOAD_MORE_2"];class cR extends At.a.Component{constructor(e){super(e),this._timer=null,this.state={statusText:"CHAT_BOX_LIST_LOAD_MORE_1"}}componentDidMount(){const e=()=>{"function"==typeof this.props.onShow&&this.props.onShow()};this.props.delayedTime?(this.setConfigTimer(),this._timer=setTimeout((()=>{this.domRef&&(this.domRef.className=this.domRef.className.replace("hidden",""),this.props.updateShowSpinner&&this.props.updateShowSpinner(this.domRef.clientHeight),this._setStatusText(),e())}),this.props.delayedTime)):e()}shouldComponentUpdate(e,t){return this.state.statusText!==t.statusText}componentWillUnmount(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._clearTimerStatusText(),"function"==typeof this.props.onHide&&this.props.onHide()}setConfigTimer(){const e=mi.default.cloud.loading_text_timer;this.arStatusConfig=[],e.length&&e.forEach(((e,t)=>{const s=t>1?1:t;e&&this.arStatusConfig.push({timer:parseInt(e),text:lR[s]})}))}_clearTimerStatusText(){this.setTextTimer&&(clearTimeout(this.setTextTimer),this.setTextTimer=null)}_setStatusText(){this._clearTimerStatusText();const e=this.arStatusConfig.shift();e&&e.timer&&e.text&&(this.setTextTimer=setTimeout((()=>{this.setState({statusText:e.text}),this._setStatusText()}),e.timer))}render(){const{statusText:e}=this.state,{isPinedTop:t=!1,title:s="",delayedTime:i,hideTitle:n=!1}=this.props;return At.a.createElement("div",{ref:e=>this.domRef=e,className:`z-chat-loading ${i?"hidden":""} ${t?"z-chat-loading-pined":""}`,id:""+(t?"z-chat-loading-pined":""),style:{paddingBottom:n?0:void 0}},At.a.createElement(rR.a,{className:`chat-loading-icon ${this.props.outerClassname}`,size:this.props.size,style:this.props.style}),n?null:At.a.createElement(lO.a,{className:"z-chat-loading__text "+this.props.outerClassname,textKey:s||e}))}}cR.defaultProps={outerClassname:""};var dR=Object(oR.a)(cR,97128),uR=s("ncjs"),hR=s("qJfJ"),gR=s("dGAM"),mR=s("1PLK"),pR=s("30XY"),fR=s("/sDj"),vR=s("QQLV"),bR=s("UFGt"),IR=s("YbIt"),yR=s("J0AE");const _R={bigThumb:{width:375,height:212},smallThumb:{width:64,height:64}};function CR(){const e=mi.default.message_bubble.link.big_thumb_width_threshold;return isNaN(Number(e))?380:e}function OR(){ss.ModalManagerV2.openModal({windowId:Go.c,name:R.ModalIdentitiesDefine.SETTINGS,params:{data:{tab:nR.f.MESSAGES}},forceCloseAll:!0})}var ER=function(e){var t,s;null===(t=e.quickMessageActionFunc)||void 0===t||t.call(e,{localPath:"",folderPath:"",downloadFileFunc:()=>{}});const i=e.data,n=null==i?void 0:i.message,a=Object(Dt.useRef)(Go.c);a.current=e.windowId||a.current;const r=Object(Dt.useRef)(!(!n||!n.thumb)&&-1!==Object.values(ho.DEFAULT_THUMB_URLS).indexOf(n.thumb)),o=Object(Dt.useRef)(null),[l,c]=Object(Dt.useState)(function(){const e=T();if(void 0!==e)return e;return!(r.current||null==n||!n.thumb)||!(null!=n&&n.href&&(ho.default.checkGoogleDriveLinks(n.href)||ho.default.isThumbFail(n.thumb)))}()),[d,u]=Object(Dt.useState)(!1),[h,g]=Object(Dt.useState)(ki.g.getYoutubePreview(e.userId)),[m,p]=Object(Dt.useState)(!0),[v,b]=Object(Dt.useState)(_R.bigThumb),I=Object(iR.a)((()=>{var t;if(!l)return;let s;if(void 0===(s=null===(t=o.current)||void 0===t?void 0:t.clientWidth))return;let i;if(i=e.containerWidth&&e.containerWidth-200>_R.bigThumb.width?_R.bigThumb.width:s,void 0===i)return;const n=9*i/16;i===(null==v?void 0:v.width)&&n===(null==v?void 0:v.height)||b({width:i,height:n})}),200);Object(Dt.useEffect)((()=>{let e;return Fi.default.subscribe(w),I(),o.current&&(e=new ResizeObserver((()=>{I()})),e.observe(o.current)),()=>{var t;Fi.default.unsubscribe(w),null===(t=e)||void 0===t||t.disconnect()}}),[]),Object(Dt.useEffect)((()=>{I()}),[e.containerWidth]),Object(Dt.useEffect)((()=>{!function(){if(l&&null!=n&&n.thumb){let[,e]=Be.g.safeParseJson(n.params);e&&e.width?e.width<CR()&&c(!1):Co.a.MediaSizeParserManager.parseAsync(n.thumb).then((t=>{let s=t;if(s&&"number"==typeof s.width&&"number"==typeof s.height){s.width<CR()&&c(!1);const t=mi.default.file_photo_limit;if(s.width<=t.width&&s.height<=t.height){const t=Object(f.a)({},i);t.status!==R.MSG_LOCAL&&t.status!==R.MSG_FAIL&&(e.width=s.width,e.height=s.height,t.message.params=JSON.stringify(e),Rt.default.updateMessageParams(t.msgId,{width:e.width,height:e.height},t))}else u(!0)}else c(!1)})).catch((()=>{c(!1)}))}}()}),[null==n?void 0:n.thumb]);let y={};if(""!==(null==i||null===(s=i.message)||void 0===s?void 0:s.params))try{var _;y=JSON.parse(null==i||null===(_=i.message)||void 0===_?void 0:_.params)}catch(N){return ho.default.logCoreError(N),At.a.createElement("div",{className:e.className},e.displayName,At.a.createElement("div",null,"Tin nhắn không hiển thị được"),e.sendTime)}let C=e.className||"";C+=" card--link"+(l?" has-big-thumb":"");const O=function(){let e=null;if(h){var t;const s={width:"640",height:"360"},n=null==i||null===(t=i.message)||void 0===t?void 0:t.href;let a=null;switch(y.src){case gR.a.mp3Src:case gR.a.mp3SrcNewBeta:case gR.a.mp3SrcNew:a=gR.b.getMp3CodeFromUrl(n),s.height="180";break;case gR.a.youtubeShortlinkSrc:case gR.a.youtubeSrc:a=gR.b.getYoutubeCodeFromUrl(n);break;case gR.a.soundcloudSrc:a=gR.b.getSoundCloudUrl(n)}a&&(e=At.a.createElement(uR.a,{className:"video-youtube__frame",scrolling:"no",width:s.width,height:s.height,src:a,frameBorder:"0",allowFullScreen:!1,additionalSandboxPolicy:"allow-presentation"}))}return e}(),E=i.status===R.MSG_LOCAL,M=!Jo.default.isMultiURL(null==n?void 0:n.title,!0,null),S="0"===(null==i?void 0:i.fromUid)&&((null==i?void 0:i.isLastMsg)?"div_LastSentMsg_Link":"div_SentMsg_Link")||(null==i?void 0:i.isLastMsg)&&"div_LastReceivedMsg_Link"||"div_ReceivedMsg_Link";return At.a.createElement("div",{id:k(),className:"link-message-v2 "+C,"data-id":S,onContextMenu:j},e.displayName,At.a.createElement(hR.a,{urgency:null==i?void 0:i.urgency}),function(){var t,s,r,c,u;const h=null==i||null===(t=i.message)||void 0===t?void 0:t.href,g="string"==typeof h?ho.default.extractDomain(h):"",b=(null==i||null===(s=i.message)||void 0===s?void 0:s.description)||"",I=b.split("..."),_=!(null==i||!i.extra||!i.extra.todoInfo||ho.default.isEmptyObject(i.extra.todoInfo)||1!==(null===(r=Rt.default.getTaskSetting())||void 0===r?void 0:r.ui_v2)),C=(null==i||null===(c=i.message)||void 0===c?void 0:c.title)||"",S=Object(yR.a)(C,e);let w=At.a.createElement("div",null,S?At.a.createElement("div",{style:M?{marginBottom:"8px"}:{},className:"text",onDoubleClick:F},function(e){if(!e)return null;const t=e.props.children?e.props.children:[];return At.a.createElement(e.type,e.props,t&&t.length>0?t:null)}(S)):null,M?At.a.createElement("div",{id:P(),onContextMenu:j,onDoubleClick:F},null!=O&&!0!==_?At.a.createElement("div",{key:"player",className:"flx flx-al-s "+(null!=O?" video-youtube":"")+" clickable"},At.a.createElement("div",{className:"video-youtube__config"},At.a.createElement("i",{className:"video-youtube__config__btn fa fa-chat-video-icon-setting",onClick:OR}),a.current==Go.c&&At.a.createElement("i",{className:"video-youtube__config__close fa fa-chat-video-icon-float",onClick:D})),O):!0===_?null:At.a.createElement("div",{key:"player",className:"flx flx-al-s card--link-content text-is-card-link"+(null!=O?" video-youtube":"")+" clickable"+(l&&!d?" has-big-thumb":""),onClick:L},At.a.createElement("div",{ref:o,style:{width:l?"100%":void 0}},function(){if(M&&Boolean(""!==(null==n?void 0:n.thumb)&&!d)){if(void 0===T())return null;const e=l?v:_R.smallThumb;return m?At.a.createElement("div",{className:"card--link-loading card--link-img flx flx-center flx-al-c",style:Object(f.a)({},e)},At.a.createElement(dR,{hideTitle:!0,delayedTime:1e3})):null}return null}(),At.a.createElement("div",{className:Object(gO.a)("card--link-container",d&&"card--link-container--error"),style:{visibility:m?"hidden":"visible",overflow:"hidden",height:m?0:"auto"}},function(){let t=null;if(M&&Boolean(""!==(null==n?void 0:n.thumb)&&!d)){var s,r;const o=null!==(s=e.chatId)&&void 0!==s?s:null===(r=e.conversation)||void 0===r?void 0:r.userId,c=l?v:_R.smallThumb;t=At.a.createElement(IR.a,{key:"link-thumb",ctxWindow:window,enableCheckSize:!0,windowId:a.current,entry:"LINK_PREVIEW_THUMB",className:"card--link-img",thumbUrl:n.thumb,width:"number"==typeof(null==c?void 0:c.width)?c.width:0,height:"number"==typeof(null==c?void 0:c.height)?c.height:0,mediaId:`${i.cliMsgId}.${i.fromUid}.${i.toUid}`,localPathMapper:async(e,t)=>await Object(bR.b)(o,i.msgId,e,E&&n.href)||"",conversationId:o,msgId:i.msgId,containerWidth:e.containerWidth||0,onLoad:()=>{p(!1)},onError:A,renderError:()=>At.a.createElement("div",{className:"card--link-img link-placeholder flx flx-center flx-al-c",style:Object(f.a)({},c)})})}else t=At.a.createElement("div",{className:"card--link-img link-placeholder flx flx-center flx-al-c"});return t}())),At.a.createElement("div-15",{key:"link-content",className:Object(gO.a)("card-content",d&&"ml-0")},At.a.createElement("span-b14",{className:"card-title on-hover"},y.mediaTitle||h),b&&(null==i||null===(u=i.message)||void 0===u||!u.title||i.message.title&&"string"==typeof i.message.title&&i.message.title.indexOf(I[0])<0)?At.a.createElement("span-14",{className:"card--link__sub clp clp--two"},b):null,At.a.createElement("span-13",{className:"card--link__src clp clp--one"},y.src||g)))):null);!0===_&&(w=At.a.createElement(aR.a,{windowId:a.current,data:null==i?void 0:i.extra.todoInfo,htmlInner:w,user:{userId:e.userId},confirm:e.confirm,dispatch:e.dispatch,focusId:e.focusId}));return w}(),e.isLast||M?At.a.createElement("div",{className:"flx"},e.sendTime,e.thread):null,e.msgAction,e.reaction);function T(){let e;try{e=JSON.parse(n.params)}catch(N){}if(e&&"number"==typeof e.width)return e.width>=CR()}function w(e,t){e===Ai.GeneralActions.CHANGE_YOUTUBE_PREVIEW&&g(t)}function L(t){var s,r;t.preventDefault(),t.stopPropagation();const o=null!==(s=e.chatId)&&void 0!==s?s:null===(r=e.conversation)||void 0===r?void 0:r.userId;mi.default.cloud_send2me.enable&&o==mi.default.sendToMeId&&fR.b.log(fR.a.OPEN,1,i);const l=(null==n?void 0:n.href)||"",c=is.a.parseUriInApp(l);if(mi.default.groupLinkRegEx.test(l))ss.ModalManagerV2.openModal({windowId:a.current,name:R.ModalIdentitiesDefine.GROUP_PREVIEW,params:l});else if(vR.a.checkLinkZaloShop(l)){var d;vR.a.setLinkOpen(l),null===(d=e.dispatch)||void 0===d||d.call(e,{type:Ai.SideBarActions.SELECT_TAB_ZALO_SHOP})}else if(pR.b.isCatalogProductLink(l)){var u,h,g;const t=null==o?void 0:o.startsWith(R.GROUPID_PREFIX);null===(u=e.emitter)||void 0===u||u.emit(Ai.GeneralActions.OPEN_MEDIA_BOARD,{type:Ai.GeneralActions.OPEN_LINK_CATALOG,uid:null!==(h=e.chatId)&&void 0!==h?h:null===(g=e.conversation)||void 0===g?void 0:g.userId,url:l,src:e.isOA?33:t?31:30}),as.default.logActionInfoV2(as.FeaturesInfo.BusinessCatalog,1,{source:1})}else c?is.a.handleUriAction(c,e.dispatch,o||null,(()=>mR.b.open(l))):mR.b.open(l,!0,!1,null,a.current)}function D(t){var s,n,a,r;t.preventDefault(),t.stopPropagation();const o=JSON.parse(null==i||null===(s=i.message)||void 0===s?void 0:s.params),l={id:null==i?void 0:i.msgId,title:o.mediaTitle||(null==i||null===(n=i.message)||void 0===n?void 0:n.description),artist:o.artist,original:o.mediaTitle,url:null==i||null===(a=i.message)||void 0===a?void 0:a.href,src:o.src,originalMessage:i};null===(r=e.dispatch)||void 0===r||r.call(e,{type:Ai.PopupActions.MP3_PREVIEW,payload:l})}function A(){c(!1),u(!0),p(!1)}function F(e){e.preventDefault(),e.stopPropagation()}function j(t){if("function"!=typeof e.showContextMenu)return;const s=`openCtxMenu_Link_${e.data.cliMsgId}`;ww.a.stopAll(),ww.a.for(s);const i={event:t,message:e.data,detail:{trackingCmdId:s,linkMessageContainerId:k(),linkContentContainerId:P()}};e.showContextMenu(i)}function P(){return`link-content-container_${i.cliMsgId}_${i.fromUid}_${i.toUid}`}function k(){return R.UIMessagePrefixElementID.LinkMessage+Object(WS.i)(i)}},MR=s("dbb5"),SR=s("Qd2S");const TR="location-message",wR=TR+"__container",RR={Blue:wR+"--blue",Focusing:wR+"--focusing",Selected:wR+"--selected",HighlightFromPrivilegedUser:wR+"--highlight-from-privileged-user"},LR=TR+"__map-container",DR=TR+"__map",AR=TR+"__marker-icon-container",FR=TR+"__marker-icon",jR=TR+"__info-container",PR=TR+"__info-title-container",kR={Center:PR+"--center"},NR=TR+"__info-description-container";function UR(e){const{isUserLocation:t,senderAvatarURL:s}=e;return t?At.a.createElement("div",{className:AR},At.a.createElement("div",{className:FR,style:{backgroundImage:"url('"+s+"')"}})):null}var BR=function(e){const{latitude:t,longitude:s,onClick:i}=e;let n="";return 1===mi.default.map_embeded_mode?n="https://maps.google.com/maps?ll="+t+","+s+"&z=14&output=embed":2===mi.default.map_embeded_mode&&mi.default.map_api_key&&(n=`https://www.google.com/maps/embed/v1/view?key=${mi.default.map_api_key}&center=${t},${s}&zoom=14`),n?At.a.createElement("div",{className:LR,onClick:e=>{i&&i(e)}},At.a.createElement(UR,e),At.a.createElement(uR.a,{additionalSandboxPolicy:"allow-presentation",className:DR,src:n,frameBorder:0,marginHeight:0,marginWidth:0,scrolling:"no",style:{pointerEvents:"none"}})):null},xR=s("AM4K");function GR(e){return"https://maps.google.com/maps?q="+e.latitude+","+e.longitude+"&z=14&t=m&mapclient=embed"}var zR=function(e){const{latitude:t,longitude:s,onClick:i}=e,n=GR({latitude:t,longitude:s});return At.a.createElement("div",null,xR.a.getHtmlFromText(n,!0,i))};function VR(e){const{data:t,senderName:s}=e,i=t.UIContent,n="0"===t.fromUid,a=Boolean(i.isUserLocation);return Object(MR.b)(),At.a.createElement("div",{className:jR},At.a.createElement("div",{className:Object(gO.a)(PR,a&&kR.Center)},At.a.createElement("span",null,function(e,t,s,i){return t?s?os.a.str("STR_MY_LOCATION"):os.a.str("STR_LOCATION_OF")+` ${i}`:e}(i.title,a,n&&a,s))),!a&&At.a.createElement("div",{className:NR},At.a.createElement("span",null,i.description)))}function HR(e){const{data:t,senderAvatar:s,windowId:i}=e,n=t.UIContent,a=(e,t)=>{e.stopPropagation(),e.preventDefault(),null==t&&(t=GR({latitude:n.latitude,longitude:n.longitude})),mR.b.open(t,!1,!0,null,i)},r=Boolean(n.isUserLocation),o=BR({isUserLocation:r,latitude:n.latitude,longitude:n.longitude,onClick:a,senderAvatarURL:s||""});return null==o?At.a.createElement(zR,{latitude:n.latitude,longitude:n.longitude,onClick:a}):At.a.createElement(At.a.Fragment,null,o,At.a.createElement(VR,e))}var WR=function(e){const{data:t,isHighlightedByPrivilegedUser:s,isFocused:i,isMultiSel:n,selectedMsg:a={},observeIntersectionForReading:r}=e,o="0"===t.fromUid,l=n&&a[t.msgId],c=At.a.useRef(null);Object(zT.a)(c,r);const d=Object(SR.a)((()=>R.UIMessagePrefixElementID.LocationMessage+Object(WS.i)(t))),u=Object(SR.a)((t=>{"function"==typeof e.showContextMenu&&e.showContextMenu({event:t,message:e.data})}));return At.a.createElement(VT.a,{border:6,className:Object(gO.a)(wR,o&&RR.Blue,l&&RR.Selected,s&&(null==t.ttl||0==t.ttl)&&RR.HighlightFromPrivilegedUser,!Boolean(t.ttl)&&"shadow-bubble","rounded-6","focused-item",i&&"focused-item--highlight-border"),isAdmin:s,variant:"common",ttl:t.ttl},At.a.createElement("div",{ref:c,"data-qId":Object(WS.g)(t),id:d(),onContextMenu:u},At.a.createElement(HR,e)))};var $R=s("oxAw"),KR=s("anH1");var qR=function(e){var t,s,i;const n=e.data,a=null===(t=e.conversation)||void 0===t||null===(s=t.userId)||void 0===s?void 0:s.startsWith(R.GROUPID_PREFIX);let r="";var o;(null==n?void 0:n.msgType)===R.MSG_PHOTO&&null!=n&&null!==(i=n.message)&&void 0!==i&&i.title&&(r=$R.a.isCardTitle(null==n||null===(o=n.message)||void 0===o?void 0:o.title,a));const l=e.focusId&&(null==n?void 0:n.msgId)&&e.focusId.indexOf(n.msgId)>=0&&1===e.focusType;return At.a.createElement(KR.a,{windowId:e.windowId||"",ctxWindow:e.selfWindow||window,containerWidth:e.containerWidth||0,message:n,imageClickHandler:e.imageClickHandler||(()=>{}),renderHtmlMessage:()=>{var t;return Object(yR.a)((null==n||null===(t=n.message)||void 0===t?void 0:t.title)||"",e)},selectedType:e.selectedType,forceShowCardBtnTitle:r,selectedMsg:e.selectedMsg,isMultiSel:e.isMultiSel||!1,onChooseMsg:e.onChooseMsg,isSignAdminMsg:e.isHighlightedByPrivilegedUser||!1,highlight:l||!1,isFocused:e.isFocused,onFilePathUpdated:e.onFilePathUpdated||(()=>{}),showContextMenu:e.showContextMenu,resendMessage:e.resendMessage,sendTime:e.SentTimeCompRenderer,observeIntersectionForReading:e.observeIntersectionForReading})},QR=s("/PwA"),ZR=s("oRa2"),JR=s("5tQl"),YR=s("oNsl"),XR=s("uP4a"),eL=s("7fJY"),tL=s("Wb+/"),sL=s("9/5/"),iL=s.n(sL),nL=s("x0gP"),aL=s("yfqh"),rL=s("IMYd"),oL=s("GzlV"),lL=s("116d"),cL=s("ADT0"),dL=s("apzQ"),uL=s("yhZf"),hL=s("yyM+"),gL=s("z+wX"),mL=s("pWOx");const pL=ho.default.isWeb();let fL,vL;pL||(fL=s("Dprd").default,vL=$znode.path);class bL extends At.a.Component{constructor(e){super(e),this._handleUpdateLayoutConfig=e=>{dL.a.updateConfig(Object(f.a)({},e)),this.setState((t=>Object(f.a)(Object(f.a)({},t),{},{layoutConfig:Object(f.a)(Object(f.a)({},t.layoutConfig),e)})))},this.isCloud=e=>!(!e||"string"!=typeof e||e!==mi.default.sendToMeId),this.windowId=e.windowId||Go.c,this.imageLocalPath={},this.state={checkedLocalPath:!1,resetLayout:!1,forceRender:!1,layoutConfig:dL.a.config},this.limitShowDynamic=mi.default.dynamic_layout_photo.total_limit,this.border=4,mi.default.dynamic_layout_photo&&!0!==hL.a.media_group_layout.enable&&this.props.photos&&this._preGridPhoto(this.props.photos),this.maxWidth=this.computeMaxWidth(),this.focusedElement=[],this._groupPhotoRowRefs=new Map,this.selectedPhoto={},this._onFilePathUpdated=this._onFilePathUpdated.bind(this),this.findPhotoByIdInGroup=this.findPhotoByIdInGroup.bind(this),this.onResize=ho.default.throttle((()=>{var e;if(1==hL.a.media_group_layout.enable)return this.maxWidth=this.computeMaxWidth(),void this.setState({forceRender:!this.state.forceRender});(null===(e=this.props.photos)||void 0===e?void 0:e.length)<4&&(this._preGridPhoto(this.props.photos),this.maxWidth=this.computeMaxWidth(),this.setState({forceRender:!this.state.forceRender}))}),500),this.enableFileStoreComp=YR.a.isActivated("enable_file_store_comp"),this.localedPhotosRef=At.a.createRef(),this.localedPhotosRef.current=[]}_equalSendTime(e,t){return!e&&!t||!(!e&&t||!t&&e)&&(!(!e||!t)&&e.key==t.key)}shouldComponentUpdate(e,t){var s,i,n,a,r,o,l,c,d,u;return!this.props.photos.equals(e.photos)||!this._equalSendTime(this.props.sendTime,e.sendTime)||this.props.className!==e.className||!ho.default.arraysEqual(this.props.focusId,e.focusId)||this.state.resetLayout!==t.resetLayout||this.state.checkedLocalPath!==t.checkedLocalPath||this.props.isSelected!==e.isSelected||this.state.forceRender!==t.forceRender||this.props.isMultiSel!==e.isMultiSel||this.props.selectedMsg!==e.selectedMsg||this.props.isMouseMoveSelecting!==e.isMouseMoveSelecting||this.props.containerWidth!==e.containerWidth||this.props.focusedMessageId!==e.focusedMessageId||(null===(s=this.state.layoutConfig)||void 0===s?void 0:s.scaleFactor)!==(null===(i=t.layoutConfig)||void 0===i?void 0:i.scaleFactor)||(null===(n=this.state.layoutConfig)||void 0===n?void 0:n.containerWidth)!==(null===(a=t.layoutConfig)||void 0===a?void 0:a.containerWidth)||(null===(r=this.state.layoutConfig)||void 0===r?void 0:r.targetItemHeight)!==(null===(o=t.layoutConfig)||void 0===o?void 0:o.targetItemHeight)||(null===(l=this.state.layoutConfig)||void 0===l?void 0:l.borderRadius)!==(null===(c=t.layoutConfig)||void 0===c?void 0:c.borderRadius)||(null===(d=this.state.layoutConfig)||void 0===d?void 0:d.spacing)!==(null===(u=t.layoutConfig)||void 0===u?void 0:u.spacing)}componentWillMount(){var e;this.props.selfWindow.addEventListener("resize",this.onResize),this.emitter=null===(e=this.context.zemitter)||void 0===e?void 0:e.on(cL.a.UPDATE_LAYOUT_CONFIG,this._handleUpdateLayoutConfig),ho.default.log("image-group-message: Mount");const t=this.props.message;t&&t.msgId&&t.message&&t.message.length&&mL.a.startLoad(t.msgId,t.message)}componentWillUpdate(e){this.props.photos.equals(e.photos)||!0===hL.a.media_group_layout.enable||this.props.photos.length!==e.photos.length&&this.props.message&&(JR.default.disableGroupPhotoSkeleton(this.props.message),this._preGridPhoto(e.photos),this.maxWidth=this.computeMaxWidth(e)),e.containerWidth!==this.props.containerWidth&&(this.maxWidth=this.computeMaxWidth(e))}componentDidMount(){for(let[e,t]of this._groupPhotoRowRefs.entries()){const s=Om.a.getInViewController(this.windowId);null==s||s.observe(t,{identifier:e,onIntersect:this.props.onMsgIntersect.bind(null,e),threshold:.9})}this.mountCallback(this.props.focusHandler)}componentWillUnmount(){this.timeoutSkeleton&&(clearTimeout(this.timeoutSkeleton),this.cacheId&&JR.default.deleteCache(this.cacheId)),this.props.selfWindow.removeEventListener("resize",this.onResize),ho.default.log("image-group-message: componentWillUnmount");for(let[e,t]of this._groupPhotoRowRefs.entries()){const e=Om.a.getInViewController(this.windowId);null==e||e.unobserve(t)}this.emitter.remove(),mL.a.onUnmount(this.props.message.msgId)}componentWillReceiveProps(e){if(this.props.focusId!==e.focusId&&(this.focusedElement=[]),e.selectedMsg&&0!==Object.keys(e.selectedMsg).length){var t,s;const i={};null===(t=this.props.message)||void 0===t||null===(s=t.message)||void 0===s||s.forEach((t=>{e.selectedMsg[t.msgId]&&(i[t.msgId]=!0)}));let n=!1;const a=Object.keys(this.selectedPhoto),r=Object.keys(i);if(a.length!==r.length)n=!0;else for(const e of r)if(!this.selectedPhoto[e]){n=!0;break}n&&(this.selectedPhoto=i,this.setState({forceRender:!this.state.forceRender}))}else this.selectedPhoto={}}componentDidUpdate(e,t){var s;(this.mountCallback(this.props.focusHandler),e.photos.length!==this.props.photos.length)&&mL.a.onReLayout(null===(s=this.props.message)||void 0===s?void 0:s.msgId)}computeMaxWidth(e){var t,s,i,n,a,r;e=null!==(t=e)&&void 0!==t?t:this.props;let o=(null!==(s=null!==(i=null===(n=this.props)||void 0===n?void 0:n.containerWidth)&&void 0!==i?i:null===(a=this.props.selfWindow.document.getElementById("messageViewContainer"))||void 0===a?void 0:a.clientWidth)&&void 0!==s?s:400)-170;const l=this.gridPhotoMap?JR.default.getLengthSkeleton(this.gridPhotoMap):this.props.photos.length;return(l<4&&!(null!==(r=e.photos)&&void 0!==r&&r.length)<4||l<mi.default.dynamic_layout_photo.total_limit)&&(o=Math.min(o,450)),o=this.gridPhotoMap&&this.gridPhotoMap.length==JR.default.getLengthSkeleton(this.gridPhotoMap)?Math.min(o,335):Math.min(o,450),o}mountCallback(e){if(ho.default.log("image-group-focus: not mounted"),this.focusedElement&&this.focusedElement.length){let t=[],s=[];this.focusedElement.forEach((e=>{e.element&&(s.push(e.messageID),t.push({ele:e.element,ref:null}))})),e(s,t,null,!0)}}_onFilePathUpdated(e,t){var s;(null==e?void 0:e.status)<R.MSG_SENT||e&&e.msgId&&(this.imageLocalPath[e.msgId]=t,this.setState({checkedLocalPath:!this.state.checkedLocalPath}),(e.msgType===R.MSG_VIDEO||e.subType===R.MSG_SUBTYPE_MEDIA_VIDEO||e.msgType===R.MSG_PHOTO)&&(null===(s=i.ModuleContainer.resolve(Ui.a))||void 0===s||s.updateMedia("image",e.toUid,e.msgId,{localPath:t},["localPath"]),Rt.default.updateMessage(e.msgId,{msgId:e.msgId,localPath:t},["localPath"],this.props.conversation.userId),this.props.dispatch({type:Ai.ChatBoxActions.FILEPATH_UPDATED,payload:e})))}_resendMessage(e,t,s={}){this.props.resendMessage(e,t)}_showInFolder(e,t){t&&(t.preventDefault(),t.stopPropagation());let s=this.imageLocalPath[e.msgId];fL&&s&&fL.fileExists(s).then((t=>{t?fL.showInFolder(s):(rs.default.createError(os.a.str("STR_TOAST_FILE_NOT_FOUND")),this.imageLocalPath[e.msgId]="",this.setState({checkedLocalPath:!this.state.checkedLocalPath}))})),as.default.logAction(107190903)}_onDownloadFileDone(e,t,s,i=!0,n=""){if(!e&&ho.default.isWindows()&&(s||n)){const e=Date.now();mi.default.recent_photo.enableFeature&&ho.default.isWindows()&&Pi.a.setPhotoDownload({isLocalFile:!0,path:s,lastModified:e,name:vL.basename(s),shortenPath:ho.default.getShortenPath(s,40),fromSource:"DownloadedPhoto"})}}showAction(e,t){t&&(t=Object(eL.a)(t),this.props.showMessageAction(e,!0,t,this.imageLocalPath[t.msgId],this._resendMessage.bind(this),this._showInFolder.bind(this,t),(e=>{if(e&&(e.preventDefault(),e.stopPropagation()),!pL&&t&&(t.msgType===R.MSG_PHOTO||t.msgType===R.MSG_DOODLE||t.msgType===R.MSG_VIDEO)&&t.message.oriUrl){var s;const e=t.msgType===R.MSG_VIDEO?nh.default.constants.DownloadType.Video:nh.default.constants.DownloadType.Photo;let i=ho.default.getConversationType(null===(s=this.props.conversation)||void 0===s?void 0:s.userId),n=new XR.c(XR.a.ChatBoxView).getBuilder().withType(t.msgType===R.MSG_VIDEO?XR.f.Video:XR.f.Photo).withMode(XR.e.Manual).withCode(XR.d.CBVPhotoGr).withConvType(XR.b[i]).build();aE.a.downloadWithMultiSrc("runByMsg",t,{entry:n,type:e,options:{srcAction:nh.default.constants.srcAction.Manual,saveAs:!0,showProgress:{progressBar:!1,taskBar:!0},duplicate:!1}}).then((e=>{this.setState({isDownloading:!1});const{isFolder:s,savePath:i}=e||{};let n=s?"":i,a=s?a:"";this._onDownloadFileDone(!1,t&&t.msgId,n,!1,a)})).catch((e=>{this._onDownloadFileDone(e)}))}})))}_extractThumbUrl(e){return ho.default.removeProtocol(e&&e.message&&e.message.thumbUrl)}_renderDuration(e){if(!e||isNaN(e))return null;let t=Math.round(e/1e3),s=Math.floor(t/60);return t-=60*s,ho.default.strPadLeft(s+"","0",2)+":"+ho.default.strPadLeft(t+"","0",2)}_onClickNoPhoto(e){}_preGridPhoto(e){if(this.isDynamicLayout=this.props.photos.length<=this.limitShowDynamic,e&&e.length){const t=Lw.a.utils.safeParseJSON(e[0].message.params);let s=null;const i=e=>{this.gridPhotoMap=JR.default.genSkeleton(e,this.props.message.msgId)};if(null!=t&&t.group_layout_id&&(this.cacheId=t.group_layout_id+"_"+e[0].fromUid,s=JR.default.getGroupPhotoSkeleton(this.cacheId)),s){let n=JR.default.normalizeSkeleton(s),a=JR.default.getLengthSkeleton(n);this.hasSkeleton=!0,n&&a>=e.length?(a>e.length&&!this.timeoutSkeleton?this.timeoutSkeleton=setTimeout((()=>{JR.default.getLengthSkeleton(this.gridPhotoMap)!==this.props.photos.length&&(JR.default.deleteCache(t.group_layout_id+"_"+e[0].fromUid),i(this.props.photos),this.hasSkeleton=!1,this.setState({forceRender:!this.state.forceRender}))}),mi.default.time_clear_cache_skeleton_group_photo):a==e.length&&this.timeoutSkeleton&&(clearTimeout(this.timeoutSkeleton),this.timeoutSkeleton=null),this.gridPhotoMap=n,this.isDynamicLayout=a<=this.limitShowDynamic):i(e)}else this.hasSkeleton=!1,i(e)}}findPhotoByIdInGroup(e){if(this.hasSkeleton){for(let s of this.props.photos)try{let t=JSON.parse(s.message.params);if(t.id_in_group>=0&&t.id_in_group==e)return s}catch(t){ho.default.logCoreError("show dynamic layout",t)}return null}return this.props.photos[e]}extractDimensions(e){return e.map((e=>{var t;let s=90,i=90;const n=Lw.a.utils.safeParseJSON(null==e||null===(t=e.message)||void 0===t?void 0:t.params);s=+(null==n?void 0:n.width)||+(null==n?void 0:n.video_width),i=+(null==n?void 0:n.height)||+(null==n?void 0:n.video_height),(isNaN(s)||s<=0)&&(s=Sm.b),(isNaN(i)||i<=0)&&(i=Sm.b);const a=null!=n&&n.hasOwnProperty("video_width")||null!=n&&n.hasOwnProperty("video_height")?"video":"image";return{width:s,height:i,group_layout_id:null==n?void 0:n.group_layout_id,type:a}}))}getGroupImageMessageContainerID(){return R.UIMessagePrefixElementID.GroupImageMessage+Object(WS.i)(this.props.message)}render(){var e;ho.default.log("image-group-message: render "+this.props.photos.length),this.focusedElement=[];let t=Object(gO.a)(this.props.className,"card--group-photo","-bg-v-"+mi.default.image.bg_v),s=0,i=!1,n=0,a=[],r={};a=this.extractDimensions(this.props.photos),r=oL.a.layout(a,{aspectRatio:this.state.layoutConfig.aspectRatio,containerWidth:this.state.layoutConfig.containerWidth,borderRadius:this.state.layoutConfig.borderRadius,spacing:this.state.layoutConfig.spacing,targetItemHeight:this.state.layoutConfig.targetItemHeight,isCloud:this.isCloud(null===(e=this.props.conversation)||void 0===e?void 0:e.userId)});const o=Math.min(this.maxWidth,this.state.layoutConfig.containerWidth,r.width),l=Math.min(o/r.width,1)||1;r=oL.a.fullLayoutScale(r,l),s<Object.keys(this.selectedPhoto).length&&(this.reMapSelected=!0,s=0);let c=(e=>!e.message||!e.message.every((e=>e.msgType===R.MSG_UNDO||e.msgType===R.MSG_DEL_EVERYONE)))(this.props.message),d=null,u=this.props.sendTime?null:this.props.thread,h=this.props.message.fromUid===this.props.userId||"0"===this.props.message.fromUid,g="thread-photo-ico thr-photo"+(this.props.message.root>0&&!this.props.message.refMessageId?" rootmsg":"");c?(d=!this.props.isMultiSel&&u?At.a.createElement("div",{className:"rl-react-thread"},this.props.reaction,At.a.createElement("div",{className:g,style:h?null:{margin:0}},u)):u?At.a.createElement("div",{style:{height:16}},this.props.reaction,At.a.createElement("div",{className:g,style:h?null:{margin:0}},u)):At.a.createElement("div",{style:this.props.sendTime?{height:16}:void 0},this.props.reaction),Object(uL.a)().ENABLE_REACTION_V2&&(d=null)):d=null;const m="0"===this.props.photos[0].fromUid&&([...this.props.photos].pop().isLastMsg?"div_LastSentMsg_GrpPhoto":"div_SentMsg_GrpPhoto")||[...this.props.photos].pop().isLastMsg&&"div_LastReceivedMsg_GrpPhoto"||"div_ReceivedMsg_GrpPhoto";let p=null;if(Object(uL.a)().ENABLE_REACTION_V2&&1==hL.a.media_group_layout.enable&&r&&r.layout){var f,v,b,I;const e=180,t=r.layout[r.layout.length-2],s=r.layout[r.layout.length-1],n=(null==t?void 0:t.y)!==(null==s?void 0:s.y),a=(null==s?void 0:s.width)||0;i=0==this.props.message.fromUid||n&&a<e;const o={position:"absolute",left:s.x+s.width,bottom:0};null===(f=(v=this.props).changeReactionPosition)||void 0===f||f.call(v,{left:s.x+s.width,bottom:4}),null===(b=(I=this.props).toggleReactionSpace)||void 0===b||b.call(I,i),p=At.a.createElement("div",{style:o},this.props.reaction)}return At.a.createElement("div",{className:t,"data-id":m},this.props.displayName,At.a.createElement("div",{id:"album-container",style:{position:"relative"}},At.a.createElement(lL.a,{layout:r,renderItem:({rowId:e,position:t,style:i})=>{let a=this.props.photos[n],r=!1;this.isDynamicLayout&&(a=this.findPhotoByIdInGroup(n));let o=t.width,l=t.height,c=i.objectFit,d=(a&&ho.default.removeProtocol(a.message.oriUrl),a?ho.default.removeProtocol(a.message.thumbUrl):null),u=(a&&ho.default.removeProtocol(a.message.normalUrl),null),h=e=>{if(e.stopPropagation(),!this.props.isMultiSel||this.props.isMouseMoveSelecting){if(!this.props.isMultiSel){if(a.msgType===R.MSG_VIDEO){[].push(a);const e={user:this.props.user,selectedId:a.msgId,oriUrl:a.message.oriUrl,userId:this.props.userId,isVideo:a.msgType===R.MSG_VIDEO||2===a.subType,message:a,conversation:this.props.conversation,isMessageConv:!0,images:this.props.photos,iconMap:Ud.b.getIconMap(),appConfig:Object(mi.getPVConfigs)()};return void Co.a.OpenPhoto.openPhotoViewer(e)}this.props.onClickImage(a)}}else{if(this.props.selectedMsg.hasOwnProperty(this.props.message.msgId)){let t=!1,s=Object.assign({},this.props.selectedMsg[this.props.message.msgId]);for(let i=0;i<s.message.length;i++){let n=s.message[i];if(n.msgId==a.msgId){s.message.splice(i,1),delete this.selectedPhoto[n.msgId],s.message.length&&Object.keys(this.selectedPhoto).length?this.props.increaseCountMsg&&!ho.default.isPreventCountSelectMessage(n)&&this.props.increaseCountMsg(-1):(this.props.onChooseMsg(s,e),this.selectedPhoto={},t=!0),this.setState({forceRender:!this.state.forceRender});break}if(i==s.message.length-1){this.props.increaseCountMsg&&!ho.default.isPreventCountSelectMessage(a)&&this.props.increaseCountMsg(1)&&(s.message.push(a),this.selectedPhoto[a.msgId]=!0,this.setState({forceRender:!this.state.forceRender}));break}}t||this.props.onMultiSelGroupPhoto(this.props.message.msgId,s)}else{let t=Object.assign({},this.props.message);for(let e=0;e<t.message.length;e++){let s=t.message[e];if(s.msgId==a.msgId){t.message=[s],this.selectedPhoto[a.msgId]=!0,this.setState({forceRender:!this.state.forceRender});break}}this.props.onChooseMsg(t,e)}e.preventDefault()}},g=this.props.isMultiSel&&a&&this.selectedPhoto.hasOwnProperty(a.msgId);g&&s++;let m=!1;var p;void 0!==this.props.focusedMessageId&&(m=(null===(p=a)||void 0===p?void 0:p.msgId)===this.props.focusedMessageId);let f="row_"+n;if(a){if(a.msgType===R.MSG_UNDO||a.msgType===R.MSG_DEL_EVERYONE)u=At.a.createElement(VT.a,{border:8,isAdmin:this.props.isHighlightedByPrivilegedUser,variant:"photo",ttl:a.ttl},At.a.createElement("div",{key:"gimgu_"+a.cliMsgId,onClick:this.props.isMultiSel?h:this._onClickNoPhoto.bind(this),style:{width:o,height:l,borderRadius:"0px",textAlign:"center"},className:Object(gO.a)("card--group-photo__row__item__img chat-message-picture__photooverlay no-shadow-border undo flx flx-col flx-al-c flx-center","recalled-bg-color","0"==a.fromUid?" me":"",g?" selected-overlay":"")},At.a.createElement("i",{className:"fa fa-icon-outline-picture recalled-icon-color",style:{fontSize:"var(--f24)"}}),At.a.createElement(lO.a,{className:"recalled-text-color",style:{fontSize:"var(--f14)"},textKey:a.msgType===R.MSG_UNDO?"STR_RECALLED":"STR_DEL_EVERYONE_GROUP_PHOTO"})));else if(a.status===R.MSG_FAIL);else if(a.msgType===R.MSG_PHOTO){var v,b;nL.a.logActionMediaCaption(this.props.conversation,a,o),aL.a.logOldLayoutAction(this.props.conversation,a,n,{width:o,height:l,fit:"cover"});const e={overflow:"hidden",width:o,height:l,borderRadius:"0px",objectFit:c};u=At.a.createElement("div",{className:Object(gO.a)("chat-message-picture__photooverlay",g&&"selected-overlay","no-shadow-border",a.message.hdUrl&&!this.props.isMultiSel&&!this.enableFileStoreComp&&"card--picture__high-definition-group"),key:`msg_photo-${a.cliMsgId}`,style:e},At.a.createElement(rL.a,{windowId:this.windowId,ctxWindow:this.props.selfWindow,key:a.cliMsgId,groupPhotoId:(null===(v=this.props.message)||void 0===v?void 0:v.msgId)||"",onClick:h,onClickCapture:e=>{Object(gL.b)(a,gL.a.LEFT_CLICK_BUBBLE_MESSAGE)},onContextMenuCapture:e=>{Object(gL.b)(a,gL.a.RIGHT_CLICK_BUBBLE_MESSAGE)},message:a,isMultiSelect:this.props.isMultiSel,onFilePathUpdated:e=>this._onFilePathUpdated(a,e),containerWidth:o,containerHeight:l,width:e.width,height:e.height,objectFit:e.objectFit,total:null===(b=this.props.photos)||void 0===b?void 0:b.length}))}else if(a.msgType===R.MSG_VIDEO){if(nL.a.logActionMediaCaption(this.props.conversation,a,o),aL.a.logOldLayoutAction(this.props.conversation,a,n,{width:o,height:l,fit:"cover"}),mi.default.e2ee.debug.show_indicator_video_v2&&mi.default.stagingAccount&&Od.b.getMsgE2eeStatus(a)===R.MSG_E2EE){const e=a.message.oriUrl;r="2"===ho.default.getQueryParamFromUrl(e,"version")}u=At.a.createElement(ZR.a,{onClick:h.bind(this),onClickCapture:e=>{Object(gL.b)(a,gL.a.LEFT_CLICK_BUBBLE_MESSAGE)},onContextMenuCapture:e=>{Object(gL.b)(a,gL.a.RIGHT_CLICK_BUBBLE_MESSAGE)},selectedPhoto:g,key:a.cliMsgId,className:"card--group-photo__row__item__img card--group-photo__row__item__video clickable "+("0"==a.fromUid?" me":""),style:{width:o,height:l,borderRadius:"0px"},userId:this.props.userId,indexInGroup:n,cacheFolderName:"Cache",src:d,message:a,msgId:a.msgId,onFilePathUpdated:(e,t)=>this._onFilePathUpdated(a,t),conversation:this.props.conversation})}}else u=At.a.createElement("div",{key:"msg_skeleton",style:{width:o,height:l,borderRadius:"0px",textAlign:"center"},className:"card--group-photo__row__item__img chat-message-picture__photooverlay no-shadow-border undo flx flx-col flx-al-c flx-center"+(g?" selected-overlay":"")});let I=null;return mi.default.e2ee.debug.show_msg_src&&mi.default.stagingAccount&&(I=Od.b.getMsgE2eeStatus(a)===R.MSG_E2EE),n++,At.a.createElement(yL,{key:f,ancestorProps:this.props,content:u,focusedElement:this.focusedElement,groupPhotoRowRefs:this._groupPhotoRowRefs,height:l,isDynamicLayout:this.isDynamicLayout,isItemFocused:m,isOnFocusedMode:this.props.isMultiSel,mClickAction:h,msgSrcDev:I,photo:a,resendMessage:this._resendMessage.bind(this),selectedPhoto:g,showAction:this.showAction.bind(this),showVideov2Indicator:r,style:i,width:o})},scaleFactor:this.state.layoutConfig.scaleFactor}),p),d,i&&this.props.reactionV2Space,this.props.sendTime)}}bL.contextType=$t.a,bL.propTypes={userId:hO.a.string.isRequired};var IL=bL;function yL(e){const{ancestorProps:t,content:s,focusedElement:i,groupPhotoRowRefs:n,height:a,isDynamicLayout:r,isItemFocused:o,isOnFocusedMode:l,key:c,mClickAction:d,msgSrcDev:u,photo:h,resendMessage:g,selectedPhoto:m,showAction:p,showVideov2Indicator:v,style:b,width:I}=e,y=At.a.useRef(null);return Object(zT.a)(y,t.observeIntersectionForReading),At.a.createElement("div",{key:c,className:Object(gO.a)("album__item","card--group-photo","card--group-photo-v2","focused-background",o&&" focused-background--focused"),ttl:null==h?void 0:h.ttl,isAdmin:t.isSignAdminMsg,width:I,height:a,style:b},At.a.createElement("div",{key:c,ref:e=>{y.current=e,h&&n.set(h.msgId,e),h&&t.focusId.indexOf(h.msgId)>=0&&i.push({messageID:h.msgId,element:e})},className:Object(gO.a)("card--group-photo__row__item",!r&&"no-dynamic","focused-item",o&&"focused-item--highlight-border focused-item--animation focused-item--higher-index"),"data-component":R.DataAttributes.Component.PHOTO,"data-qId":Object(WS.g)(h),style:{width:I,height:a,borderRadius:b.borderRadius,zIndex:l?3:null},onContextMenu:e=>p(e,h)},u?At.a.createElement("i",{style:Object(f.a)(Object(f.a)({position:"absolute",fontSize:10,top:3,zIndex:1,color:"var(--text-information)"},"0"===h.fromUid&&{right:3}),"0"!==h.fromUid&&{left:3}),className:"fa fa-icon-solid-lock-2"}):null,v?At.a.createElement("i",{style:Object(f.a)(Object(f.a)({position:"absolute",fontSize:14,top:2,zIndex:1,color:"var(--text-information)"},"0"===h.fromUid&&{right:3}),"0"!==h.fromUid&&{left:3})},"v2"):null,At.a.createElement(Qw.a,{type:"overlay",msgStatus:h.status,sendDttm:h.sendDttm,onRetryClick:e=>g(e,h,{fromBubble:!0})},s),(h&&h.loadSrc,null),l?At.a.createElement("div",{className:"select-btn",style:{lefImgLoaderCtx:"5px",top:"6px"},onClick:d},At.a.createElement("i",{className:m?"fa fa-multiselect_checkbox_hover selected-msg ":" fa fa-multiselect-stroke-checkbox unselect-msg"}),m?null:At.a.createElement("i",{className:"fa fa-multiselect_checkbox_hover hover-unselected-msg"})):null))}const _L=new he.default({maxSize:20});const CL=Object(tL.a)(bL,((e,t,s)=>{var i;const n=null===(i=t.message)||void 0===i?void 0:i.cliMsgId;if(!n)return void e();const a=function(e){if(_L.has(e))return _L.get(e);let t=iL()((e=>e()),300,{maxWait:1e3}),s={batch:(e,s,i)=>{var n,a,r;(null===(n=s.photos)||void 0===n?void 0:n.length)>1&&(null===(a=s.photos)||void 0===a?void 0:a.length)!==(null==i||null===(r=i.photos)||void 0===r?void 0:r.length)?t(e):(t.cancel(),e())}};return _L.set(e,s),s}(n);a.batch(e,t,s)}));var OL=function(e){var t,s;const i=e.data,n=mi.default.image.enable_image_group_batch?CL:IL,a=Object(QR.b)(),r=At.a.useMemo((()=>{var e;if(void 0!==(null==a||null===(e=a.state)||void 0===e?void 0:e.focusedMessageId)&&Array.isArray(null==i?void 0:i.message)){const e=i.message.find((e=>e.msgId===a.state.focusedMessageId));if(e)return e.msgId}}),[null==a||null===(t=a.state)||void 0===t?void 0:t.focusedMessageId,null==i?void 0:i.message]);return At.a.createElement(n,{showMessageAction:(t,s,i,n,a,r,o,l,c,d)=>{if("function"==typeof e.showContextMenu){const s={event:t,message:i,detail:{localPath:n,resendFunc:a,showInFolder:r,downloadFunc:o,onExtension:l,indexOAChild:c,folderPath:d}};e.showContextMenu(s)}},userId:null===(s=e.user)||void 0===s?void 0:s.userId,user:e.user,conversation:e.conversation,photos:null==i?void 0:i.message,replyMessage:e.replyMessage,deleteMessage:e.deleteMessage,recallMessage:e.recallMessage,shareMessage:e.shareMessage,resendMessage:e.resendMessage,onClickImage:e.onClickImage,focusId:e.focusId,focusType:e.focusType,focusedMessageId:r,message:i,selectedMsg:e.selectedMsg,isMultiSel:e.isMultiSel,isSelected:e.isSelected,isMouseMoveSelecting:e.isMouseMoveSelecting,onMultiSelGroupPhoto:e.onMultiSelGroupPhoto,onChooseMsg:e.onChooseMsg,dispatch:e.dispatch,increaseCountMsg:e.increaseCountMsg,onMsgIntersect:()=>{},isSignAdminMsg:e.isAdmin,selfWindow:e.selfWindow||window,windowId:e.windowId,changeReactionPosition:e.changeReactionPosition,toggleReactionSpace:e.toggleReactionSpace,containerWidth:e.containerWidth,isHighlightedByPrivilegedUser:e.isHighlightedByPrivilegedUser,focusHandler:e.focusHandler,observeIntersectionForReading:e.observeIntersectionForReading})};var EL=function(e){const t=e.data,[s,n]=Object(Dt.useState)(null==t?void 0:t.localPath),a=Object(Dt.useRef)(null);At.a.useEffect((()=>{Rw.a.getInstance().push(t,Rw.b.chatview)}),[]);let r=R.MULTI_PHOTO_SELECTED_TYPE.TYPE_UNSELECTED;null!=t&&t.msgId&&e.isSelected&&e.selectedMsg&&e.selectedMsg[t.msgId]&&(r=e.selectedMsg[t.msgId].multipleSelectedType||R.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL);const o=Object(f.a)(Object(f.a)({},e),{},{imageClickHandler:function(s){if(!t||null!=t&&t.isErrorInfo)return;s&&s.stopPropagation();a.current&&(clearTimeout(a.current),a.current=null);a.current=setTimeout((()=>{var s,i;a.current&&clearTimeout(a.current),a.current=null,null===(s=e.onClickImage)||void 0===s||s.call(e,t),mi.default.cloud_send2me.enable&&(null===(i=e.conversation)||void 0===i?void 0:i.userId)==mi.default.sendToMeId&&fR.b.log(fR.a.OPEN,1,t)}),200)},onFilePathUpdated:function(s){n(s),function(e,t,s,n){if(!e)return;if(e.status<R.MSG_SENT)return;const a=i.ModuleContainer.resolve(Ui.a),r=e.toUid;e.msgType===R.MSG_FILE&&(e.localPath=t,e.folderPath=s,a.updateFile(r,e.msgId,{localPath:t,folderPath:s},["localPath","folderPath"])),e.msgType!==R.MSG_VIDEO&&e.msgType!==R.MSG_PHOTO||a.updateMedia("image",r,e.msgId,{localPath:t},["localPath"]),Rt.default.updateMessage(e.msgId,{msgId:e.msgId,localPath:t,folderPath:s},["localPath","folderPath"],r),null==n||n({type:Ai.ChatBoxActions.FILEPATH_UPDATED,payload:e})}(t,s,void 0,e.dispatch)},selectedType:r});return(null==t?void 0:t.msgType)===R.MSG_PHOTO||(null==t?void 0:t.msgType)===R.MSG_DOODLE?At.a.createElement(qR,o):(null==t?void 0:t.msgType)===R.MSG_PHOTO_GROUP?At.a.createElement(OL,o):null};var ML=s("NuRm"),SL=s("9hee");var TL=function(e){const{conversation:t,data:s,isFocused:i,observeIntersectionForReading:n}=e,a=Object(iO.a)(),r=Object(iO.b)(),o=Object(ML.a)(),l=At.a.useRef(null);Object(zT.a)(l,n);const c=Object(SR.a)(((t,s)=>{if("function"!=typeof e.showContextMenu)return;const i={event:t,message:e.data,detail:{indexOAChild:s}};e.showContextMenu(i)}));return At.a.createElement(SL.a,{containerRef:l,oaContextMenu:c,className:"card",content:s.message,dispatch:a,conversation:t,emitter:r,isFocused:i,message:s,windowId:o})};const wL=e=>{if(!e)return null;let t=null;try{var s;let i="string"==typeof e?JSON.parse(e):"object"==typeof e?e:null;null!=i&&i.params&&("string"==typeof i.params?t=JSON.parse(i.params):"object"==typeof i.params&&(t=i.params)),null!==(s=t)&&void 0!==s&&s.thumbUrl||(t=null)}catch(i){t=null}return t},RL=e=>e===R.MSG_UNDO,LL=e=>e===R.MSG_DEL_EVERYONE,DL=e=>(e=>e===R.MSG_FAIL)(e)||(e=>e===R.MSG_LOCAL)(e);let AL=function(e){return e.DEFAULT="default",e.STICKER="sticker",e.NEW_FSS_STICKER="new-fss-sticker",e.UNDO="undo",e.DEL_EVERYONE="del-everyone",e}({});const FL=(e,t)=>LL(e.msgType)?AL.DEL_EVERYONE:RL(e.msgType)?AL.UNDO:t?((e,t)=>{var s,i,n;if(!mi.default.enable_new_fss)return!1;if(null==e||null===(s=e.UIContent)||void 0===s||!s.extInfo)return!1;let a=wL(null!==(i=null!==(n=e.UIContent.extInfo)&&void 0!==n?n:null==t?void 0:t.fssInfo)&&void 0!==i?i:"");return Boolean(a)&&!((null==e?void 0:e.src)===R.MSG_SRC.SYNC_MOBILE_DB&&0==(null==a?void 0:a.subtype))})(e,t)?AL.NEW_FSS_STICKER:AL.STICKER:AL.DEFAULT,jL="sticker-message-selectable",PL={Selected:"--selected"},kL=e=>{const{isSelected:t=!1}=e;return At.a.createElement(Zw,{isSelected:t},At.a.createElement("div",{className:Object(gO.a)(jL,t&&PL.Selected,e.className),onClick:s=>{var i;null===(i=e.onSelectClick)||void 0===i||i.call(e,s,t)},onContextMenu:s=>{var i;null===(i=e.onSelectContextMenu)||void 0===i||i.call(e,s,t)}},e.children))},NL=()=>{const e=Object(Dt.useRef)(!1);return Object(Dt.useEffect)((()=>()=>{e.current=!0}),[]),{unmountedHolder:e}},UL=e=>{var t;const{identity:{id:s,cateId:i}}=e,{unmountedHolder:n}=NL(),[a,r]=Object(Dt.useState)((()=>go.g.getStickerFromCache(i,s)));return Object(Dt.useMemo)((()=>{if(!a||a.id!==s||a.cateId!==i){if(a&&(a.id!==s||a.cateId!==i)){const e=go.g.getStickerFromCache(i,s);if(e)return void r(e)}go.g.getStickerIfNotExist(i,s).then((e=>{n.current||r(e)}))}}),[s,i]),At.a.createElement(At.a.Fragment,null,null===(t=e.children)||void 0===t?void 0:t.call(e,a))};var BL=s("dI1f");const xL=e=>{const[t,s]=Object(Dt.useState)((()=>Object(BL.d)({msgId:e.msgId,toUid:e.toUid,sendDttm:e.sendDttm})));return Object(Dt.useEffect)((()=>{const t=i.ModuleContainer.resolve(BL.a);return t.addUpdateOperationCallback(e.msgId,(function(e){s(e)})),()=>{t.removeUpdateOperationCallback(e.msgId)}}),[e.msgId]),{showOperation:t}},GL=(e,t)=>"0"===e&&(t?"div_LastSentMsg_Sticker":"div_SentMsg_Sticker")||t&&"div_LastReceivedMsg_Sticker"||"div_ReceivedMsg_Sticker";var zL=s("IpzU");const VL=ho.default.isWeb(),HL=!VL&&s("Dprd").default,WL=e=>{const{fssUrl:t,msgId:s,convId:i}=e,[n,a]=Object(Dt.useState)(""),r=Object(Dt.useRef)("unknown"),{unmountedHolder:o}=NL();return Object(Dt.useEffect)((()=>{const e=async()=>{if(!VL&&mi.default.enable_cache_fss){r.current="downloading";const e=await Object(zL.getZaloDownloadsCacheDir)("g",rt.p.getSessionUserId()),n=HL.getCachedFileName(t);nh.default.run({type:nh.default.constants.DownloadType.Photo,data:{url:t,fileName:n,msgId:s,conversationId:i},options:{srcAction:nh.default.constants.srcAction.Dev,saveDir:e,caching:!0}}).then((e=>{o.current||(r.current="downloaded",a(e.savePath?"file://"+e.savePath:t))})).catch((e=>{o.current||(r.current="failed",a(t))}))}else r.current="not-supported",a(t)};"unknown"===r.current&&t&&e()}),[t,s,i]),{preview:n}},$L=e=>e.overlay?At.a.createElement("div",{className:"preload-spinner-overlay"},e.children,At.a.createElement("div",{className:"preload-spinner-wrapper"},At.a.createElement("div",{className:"preload-spinner"}))):At.a.createElement(At.a.Fragment,null,e.children),KL=e=>{const{showTitle:t=!0,disablePlay:s=!1,content:i,msgInfo:n}=e,a=i.thumb,{preview:r}=WL({msgId:n.msgId,convId:n.convId,fssUrl:i.fssUrl}),[o,l]=Object(Dt.useState)(!1);return At.a.createElement("div",{className:Object(gO.a)("fullscreen-sticker",e.className)},At.a.createElement($L,{overlay:e.showOverlay},At.a.createElement("div",{className:"fullscreen-sticker__content",onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},!r||s||o?At.a.createElement("img",{className:"fullscreen-sticker__preview",src:a,onLoad:t=>{"function"==typeof e.onLoadThumb&&e.onLoadThumb(a)},onError:t=>{"function"==typeof e.onLoadThumbError&&e.onLoadThumbError(a)}}):At.a.createElement("img",{className:"fullscreen-sticker__preview",src:r,onLoad:t=>{l(!1),"function"==typeof e.onLoadPreview&&e.onLoadPreview(r)},onError:t=>{l(!0),"function"==typeof e.onLoadPreviewError&&e.onLoadPreviewError(r)}}),t&&At.a.createElement("div",{className:"fullscreen-sticker__title"},At.a.createElement(LO.a,{className:"fullscreen-sticker__icon",icon:"Sticker_24_Line"}),At.a.createElement(lO.a,{textKey:"STR_CLICK_TO_VIEW_2"})))))},qL="fullscreen-sticker-message-content",QL={Block:qL,Modifiers:{NoBorderBottomRadius:"--no-border-bottom-radius"},Elements:{FullscreenSticker:`${qL}__fullscreen-sticker`}},ZL=e=>{var t,s,i;const{sticker:n,messageInfo:a}=e,r=null!==(t=a.UIContent.id)&&void 0!==t?t:n.id,o=null!==(s=a.UIContent.cateId)&&void 0!==s?s:n.cateId,{showOperation:l}=xL({msgId:a.msgId,toUid:a.toUid,sendDttm:a.sendDttm}),c=At.a.useMemo((()=>{var e,t;return wL(null!==(e=null!==(t=a.UIContent.extInfo)&&void 0!==t?t:n.fssInfo)&&void 0!==e?e:"")}),[a.UIContent.extInfo,n.fssInfo]);return At.a.createElement("div",{"data-id":GL(a.fromUid,null!==(i=a.isLastMsg)&&void 0!==i&&i),className:Object(gO.a)(QL.Block,l&&QL.Modifiers.NoBorderBottomRadius,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},At.a.createElement(KL,{className:QL.Elements.FullscreenSticker,showOverlay:!!e.isLoadingFSSToPlay,disablePlay:e.disablePlay,content:{id:r,cateId:o,thumb:c.thumbUrl,fssUrl:n.fss},msgInfo:{msgId:a.msgId,convId:a.toUid}}),l&&At.a.createElement(BL.c,{windowId:e.windowId||Go.c,convId:a.toUid,fromUid:a.fromUid}))};var JL=s("cuiR");const YL=130,XL=80,eD="default-sticker-message-content",tD={Block:eD,Modifiers:{},Elements:{ThumbIcon:`${eD}__thumb-icon`}},sD=e=>{const{size:t=YL,thumbSize:s,thumbPercentage:i=XL}=e,n=At.a.useMemo((()=>`${Math.round(null!=s?s:t*i/100)}px`),[t,s,i]);return At.a.createElement("div",{className:Object(gO.a)(tD.Block,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu,style:{width:`${t}px`,height:`${t}px`}},At.a.createElement(LO.a,{icon:"ThumbSticker_24_Filled",className:tD.Elements.ThumbIcon,style:{fontSize:n,width:n,height:n}}))};var iD=s("+ou9");const nD="normal-sticker-message-content",aD={Block:nD,Modifiers:{},Elements:{Sticker:`${nD}__sticker`}},rD=e=>{var t,s,i,n,a;const{sticker:r,messageInfo:o,disablePlay:l=!1}=e,c=(null!==(t=o.UIContent.id)&&void 0!==t||r.id,null!==(s=o.UIContent.cateId)&&void 0!==s||r.cateId,Object(QR.b)()),d=At.a.useMemo((()=>{var e;return void 0!==(null==c||null===(e=c.state)||void 0===e?void 0:e.focusedMessageId)&&c.state.focusedMessageId===o.msgId}),[null==c||null===(i=c.state)||void 0===i?void 0:i.focusedMessageId,o.msgId]),{showOperation:u}=xL({msgId:o.msgId,toUid:o.toUid,sendDttm:o.sendDttm});return At.a.createElement("div",{"data-id":GL(o.fromUid,null!==(n=o.isLastMsg)&&void 0!==n&&n),className:Object(gO.a)(aD.Block,e.className,d&&"focused-item focused-item--animation"),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},At.a.createElement(iD.a,{key:String(l),className:Object(gO.a)(aD.Elements.Sticker,"sticker-message "),autoStop:!0,sticker:r,thumbSize:YL,stickerView:!0,display:!0,interation:5,fullScreenEffectId:e.isLoadingFSSToPlay,highPriority:!0,autoPlay:!0,isFlip:null!==(a=e.isSentFromMe)&&void 0!==a&&a,disablePlay:l}),u&&At.a.createElement(BL.c,{windowId:e.windowId||Go.c,convId:o.toUid,fromUid:o.fromUid}))};var oD=s("1Luk"),lD=s("5A7B");const cD="sticker-message-content-wrapper",dD=At.a.forwardRef((function(e,t){const{sticker:s,data:i,observeIntersectionForReading:n}=e,a=At.a.useRef(null);if(Object(zT.a)(a,n),!i)return null;const r=At.a.useMemo((()=>FL(i,s)),[i,s]),o=r===AL.NEW_FSS_STICKER,l=DL(i.status),c=Boolean(e.isMultiSel),{handleClick:d,isLoadingFSSToPlay:u}=(e=>{const{unmountedHolder:t}=NL(),[s,i]=At.a.useState(!1);return{handleClick:(s,n)=>{if(!s.shiftKey&&!e.isMultiSel){const{message:a,contentType:r}=n,{id:o,cateId:l}=a.UIContent;switch(r){case AL.NEW_FSS_STICKER:case AL.STICKER:case AL.DEFAULT:{const n=(s,n)=>{let a=!1;const r=Rt.default.getStickerEffectCache(s,n);return r&&"function"==typeof e.dispatch&&(Object(oD.d)(oD.c.PLAY_SS),e.dispatch({type:Ai.PopupActions.TOGGLE_COCOS_SCREEN,payload:{effectId:r},windowId:e.windowId||Go.c}),lD.a.register("fullscreensticker"+r,(()=>{t.current||i(!1)}),5e3),a=!0,i(!0)),a};n(o,l)||"function"!=typeof e.showStickerSet||(e.showStickerSet({stickerId:o,id:l}),s&&(s.preventDefault(),s.stopPropagation()));break}case AL.DEL_EVERYONE:case AL.UNDO:s&&(s.preventDefault(),s.stopPropagation())}}},isLoadingFSSToPlay:s}})(e),{handleToggleSelection:h}=(e=>({handleToggleSelection:(t,s)=>{const{isMultiSel:i=!1}=e,{message:n}=s;t.shiftKey||i&&(e.isMouseMoveSelecting||(e.selectMessage(t,n),t.preventDefault(),t.stopPropagation()))}}))(e),g=t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:i};e.showContextMenu(s)},m={onClick:e=>{const t={message:i,contentType:r};c?h(e,t):d(e,t)},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:g};return At.a.createElement("div",{ref:e=>{a.current=e,null==t||t(e)},className:Object(gO.a)(cD,e.className),"data-component":R.DataAttributes.Component.STICKER,"data-qId":Object(WS.g)(i),onClickCapture:e.onClickCapture,onContextMenuCapture:e.onContextMenuCapture},At.a.createElement(Qw.a,{type:o?c?void 0:"side":"overlay",msgStatus:i.status,sendDttm:i.sendDttm,onRetryContextMenu:g,onSendingContextMenu:g,onRetryClick:t=>{var s;t.preventDefault(),t.stopPropagation(),null===(s=e.resendMessage)||void 0===s||s.call(e,t,i)}},At.a.createElement(kL,{isSelected:e.isSelected,onSelectClick:e=>{h(e,{message:i,contentType:r})},onSelectContextMenu:t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:i};e.showContextMenu(s)}},(()=>{switch(r){case AL.STICKER:return At.a.createElement(rD,Object(xt.a)({windowId:e.windowId,isLoadingFSSToPlay:u,disablePlay:l,sticker:s,messageInfo:{msgId:i.msgId,fromUid:i.fromUid,toUid:i.toUid,cliMsgId:i.cliMsgId,UIContent:i.UIContent,isLastMsg:i.isLastMsg}},m));case AL.NEW_FSS_STICKER:return At.a.createElement(ZL,Object(xt.a)({windowId:e.windowId,isLoadingFSSToPlay:u,disablePlay:l,sticker:s,messageInfo:{cliMsgId:i.cliMsgId,msgId:i.msgId,toUid:i.toUid,UIContent:i.UIContent,fromUid:i.fromUid,sendDttm:i.sendDttm,isLastMsg:i.isLastMsg}},m));case AL.UNDO:case AL.DEL_EVERYONE:return At.a.createElement(JL.a,Object(xt.a)({messageInfo:{msgId:i.msgId,msgType:i.msgType,cliMsgId:i.cliMsgId,fromUid:i.fromUid,toUid:i.toUid}},m));case AL.DEFAULT:default:return At.a.createElement(sD,Object(xt.a)({thumbPercentage:80,messageInfo:{msgId:i.msgId,fromUid:i.fromUid,toUid:i.toUid,cliMsgId:i.cliMsgId}},m))}})())))}));var uD=At.a.forwardRef(((e,t)=>{const s=e.data.UIContent.id,i=e.data.UIContent.cateId;return At.a.createElement(UL,{identity:{id:s,cateId:i}},(s=>At.a.createElement(dD,Object(xt.a)({ref:t},e,{sticker:s}))))}));const hD={Block:"core-image",Modifiers:{NonSelectable:"--non-selectable",NonDraggable:"--non-draggable"}},gD=e=>{const{width:t,height:s,draggable:i=!1,selectable:n=!1}=e,a=i?{draggable:!0}:{draggable:!1,onDragStart:e=>{i||(e.preventDefault(),e.stopPropagation())}};return At.a.createElement("img",Object(xt.a)({className:Object(gO.a)(e.className,hD.Block,!i&&hD.Modifiers.NonDraggable,!n&&hD.Modifiers.NonSelectable),alt:"",src:e.src,width:t,height:s,onLoad:e.onLoad,onError:e.onError},a))},mD="loading-image",pD={Block:mD,Modifiers:{Loading:"--loading"},Elements:{DefaultThumb:`${mD}__default-thumb`,EmbededImage:`${mD}__embeded-image`}},fD=80,vD=e=>{const{useDefaultThumb:t=!0,initialLoading:s=!0,draggable:i=!1,selectable:n=!1,width:a=0,height:r=0,MaxDefaultThumbSize:o,MaxDefaultThumbPercentage:l=fD}=e,[c,d]=At.a.useState(s),u=o,h=l;return At.a.createElement("div",{className:Object(gO.a)(pD.Block,c&&pD.Modifiers.Loading,e.className)},t&&c&&At.a.createElement(sD,{className:pD.Elements.DefaultThumb,messageInfo:e.messageInfo,thumbPercentage:h,thumbSize:u}),At.a.createElement(gD,{className:Object(gO.a)(pD.Elements.EmbededImage),src:e.src,height:r,width:a,draggable:i,selectable:n,onLoad:t=>{var s;c&&d(!1),null===(s=e.onLoad)||void 0===s||s.call(e,t)},onError:t=>{var s;null===(s=e.onError)||void 0===s||s.call(e,t)}}))};var bD=s("aKpv");const ID=Qf.a.Constant.DisplayModeProps,yD="Preview",_D="Play",CD=function(e,t){e===yD?t(_D):e===_D&&t(yD)},OD=function(e,t){e&&CD(yD,t)},ED=function(e,t,s,i,n){e&&Qf.a.Helper.parseInt(s)&&(n.current&&clearTimeout(n.current),n.current=setTimeout((()=>{i.current=!1,function(e,t){e&&CD(_D,t)}(e,t),n.current&&clearTimeout(n.current),n.current=null}),s))},MD="photo-sticker",SD={Block:MD,Elements:{PreviewImage:`${MD}__preview-image`,PlayImage:`${MD}__play-image`}};function TD(e){const{data:t,width:s=0,height:i=0,mode:n=ID.PLAY_FIRST,useDefaultThumb:a=!0,onlyLoadLocal:r=!1,animationDuration:o=5e3,draggable:l=!1,selectable:c=!1}=e,[d,u]=function(e){return e===ID.PREVIEW_ONLY?[yD,!1]:e===ID.PLAY_ONLY?[_D,!1]:e===ID.PREVIEW_FIRST?[yD,!0]:e===ID.PLAY_FIRST?[_D,!0]:[yD,!1]}(n),[h,g]=Object(Dt.useState)(d),m=Object(Dt.useRef)(!0),p=Object(Dt.useRef)(!1),f=Object(Dt.useRef)(null),v=Qf.a.Helper.getStickerThumbUrl(t,{onlyUseLocal:r,usingFileProtocol:!0}),b=Qf.a.Helper.getStickerUrl(t,{onlyUseLocal:r,usingFileProtocol:!0}),I=e=>{e&&(OD(u,g),!p.current&&ED(u,g,o,m,f))};return At.a.createElement("div",{id:"pSticker_"+t.id,key:"pSticker_"+t.id,className:Object(gO.a)(SD.Block,e.className),draggable:l,style:{width:s,height:i},onClick:t=>{var s;null===(s=e.onClick)||void 0===s||s.call(e,t)},onDoubleClick:t=>{var s;null===(s=e.onDoubleClick)||void 0===s||s.call(e,t)},onContextMenu:t=>{var s;null===(s=e.onContextMenu)||void 0===s||s.call(e,t)},onMouseEnter:()=>{m.current=!0,p.current=!0,OD(u,g)},onMouseOut:()=>{p.current=!1,ED(u,g,o,m,f)}},h===yD?At.a.createElement(vD,{className:SD.Elements.PreviewImage,messageInfo:e.messageInfo,useDefaultThumb:a,MaxDefaultThumbPercentage:e.MaxDefaultThumbPercentage,initialLoading:!t.localPreview,src:ho.default.transformLocalUrl(v),width:s,height:i,draggable:l,selectable:c,onLoad:()=>{I(n===ID.PLAY_FIRST&&m.current)}}):At.a.createElement(vD,{className:SD.Elements.PlayImage,messageInfo:e.messageInfo,useDefaultThumb:a,MaxDefaultThumbPercentage:e.MaxDefaultThumbPercentage,initialLoading:!t.localUrl,src:ho.default.transformLocalUrl(b),width:s,height:i,selectable:c,draggable:l,onLoad:()=>{I(n===ID.PLAY_FIRST&&m.current)}}),At.a.createElement(bD.b,{message:e.messageInfo,devSrc:"PhotoSticker",visible:!1}))}const wD=e=>{const[,t]=At.a.useState(0),{data:s}=e,i=Qf.a.Cache.FileToPath,n=i.getPathById(s.id,s.url),a=i.getPathById(s.id,s.pngUrl),r=i.getPathById(s.id,s.previewUrl);return n&&(s.localUrl=n),a&&(s.localPng=a),r&&(s.localPreview=r),At.a.useEffect((()=>{Qf.a.Helper.runDownload(s,(()=>t((e=>1^e))))}),[s.id,s.url,s.pngUrl,s.previewUrl]),At.a.createElement(TD,Object(xt.a)({},e,{data:s}))},RD="photo-sticker-message-content",LD={Block:RD,Elements:{PhotoSticker:`${RD}__photo-sticker`}},DD=(e,t)=>{const{data:s,observeIntersectionForReading:i}=e,n=At.a.useRef(null);Object(zT.a)(n,i);const a=At.a.useMemo((()=>Qf.a.Helper.convertMessageToPhotoStickerData(s)),[s]),r=At.a.useMemo((()=>{const[e,t]=Qf.a.Helper.getRenderedPhotoStickerSizeAtChatList(a.width,a.height),[s,i]=Qf.a.Config.getRenderedMessageSize();return{photoSticker:{width:e,height:t},message:{width:s,height:i}}}),[a.width,a.height]),o=t=>{"function"==typeof e.showContextMenu&&(t.stopPropagation(),t.preventDefault(),e.showContextMenu({event:t,message:s}))},l=Qf.a.Constant.DisplayModeProps.PLAY_FIRST,c=Qf.a.Config.getMessageAnimationDuration();return At.a.createElement(Qw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryContextMenu:o,onSendingContextMenu:o,onRetryClick:t=>{var i;t.preventDefault(),t.stopPropagation(),null===(i=e.resendMessage)||void 0===i||i.call(e,t,s)}},At.a.createElement(kL,{isSelected:e.isSelected},At.a.createElement("div",{id:R.UIMessagePrefixElementID.PhotoStickerMessage+Object(WS.i)(s),ref:e=>{n.current=e,null==t||t(e)},className:Object(gO.a)(LD.Block,e.className),"data-component":R.DataAttributes.Component.PHOTO_STICKER,"data-qId":Object(WS.g)(s),style:Object(f.a)({},r.message),onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onClickCapture:t=>{var i;null==e||null===(i=e.onClickCapture)||void 0===i||i.call(e,t,s)},onContextMenu:o,onContextMenuCapture:e.onContextMenuCapture},At.a.createElement(wD,{mode:l,messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,sendDttm:s.sendDttm},className:LD.Elements.PhotoSticker,width:r.photoSticker.width,height:r.photoSticker.height,data:a,MaxDefaultThumbPercentage:XL,animationDuration:c,onlyLoadLocal:!1}))))},AD=At.a.forwardRef(DD),FD="no-border-photo-sticker-message-content",jD={Block:FD,Modifiers:{},Elements:{ImageContainer:`${FD}__image-container`,Image:`${FD}__image`}},PD=e=>{var t,s;const{fromUid:i,toUid:n,cliMsgId:a,UIContent:r,msgId:o}=e.messageInfo,l=null!==(t=r.parsedParams.width)&&void 0!==t?t:0,c=null!==(s=r.parsedParams.height)&&void 0!==s?s:0,d=`${a}::${i}::${n}`,u=ho.default.removeProtocol(r.oriUrl),h=At.a.useMemo((()=>{const[e,t]=Qf.a.Helper.getRenderedPhotoStickerSizeAtChatList(l,c),[s,i]=Qf.a.Config.getRenderedMessageSize();return{photoSticker:{width:e,height:t},message:{width:s,height:i}}}),[l,c]);return At.a.createElement("div",{className:Object(gO.a)(jD.Block,e.className),style:h.message,onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},At.a.createElement("div",{className:jD.Elements.ImageContainer,style:h.photoSticker},At.a.createElement(qw.a,{className:jD.Elements.Image,mediaId:d,mediaSize:h.photoSticker,urls:Object(Kw.a)([u]),loadStrategy:{type:"Instant"},entry:"MESSAGE_LIST",preloadStrategy:"Async",renderPlaceholder:()=>At.a.createElement(sD,{thumbPercentage:80,messageInfo:{msgId:o,fromUid:i,toUid:n,cliMsgId:a}}),renderError:()=>At.a.createElement(sD,{thumbPercentage:80,messageInfo:{msgId:o,fromUid:i,toUid:n,cliMsgId:a}})}),At.a.createElement(bD.b,{message:e.messageInfo,visible:!1,devSrc:"NoBorderPhotoStickerMessageContent"})))};class kD{static getInstance(){return kD.instance_||(kD.instance_=new kD),kD.instance_}constructor(){if(this.trackingData_=new he.default({maxSize:1e3}),this._LogThreshold_=1,kD.instance_)return kD.instance_;kD.instance_=this}onNoBorderStickerDisplayedAtWhere(e){if(!e)return;const t=this.getTrackingId_(e);if(!t)return;const s=this.updateTrackingData_(t);this.submitLogIfNeeded_({id:t,count:s,where:e.where})}getTrackingId_(e){if(e.id&&e.where)return`[${e.where}]:${e.id}`}updateTrackingData_(e){let t=this.trackingData_.get(e);return t=null==t?1:t+1,this.trackingData_.set(e,t),t}submitLogIfNeeded_(e){this.shouldSubmitLog_(e)&&this.$ubmitLog_()}shouldSubmitLog_(e){return!!(e&&e.id&&e.where)&&e.count===this._LogThreshold_}$ubmitLog_(){as.default.logAction(107150334)}}kD.instance_=void 0;const ND="no-border-photo-sticker-message-content-wrapper",UD=At.a.forwardRef(((e,t)=>{const{data:s,observeIntersectionForReading:i}=e,n=At.a.useRef(null);Object(zT.a)(n,i);var a;return a={msgId:s.msgId},Object(Dt.useEffect)((()=>{kD.getInstance().onNoBorderStickerDisplayedAtWhere({id:a.msgId,where:"csc"})}),[]),At.a.createElement("div",{ref:e=>{n.current=e,null==t||t(e)},className:Object(gO.a)(ND),"data-component":R.DataAttributes.Component.PHOTO_STICKER,"data-qId":Object(WS.g)(s),onClickCapture:e.onClickCapture,onContextMenuCapture:e.onContextMenuCapture},At.a.createElement(Qw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryClick:t=>{var i;t.preventDefault(),t.stopPropagation(),null===(i=e.resendMessage)||void 0===i||i.call(e,t,s)}},At.a.createElement(kL,{isSelected:e.isSelected},At.a.createElement(PD,{onContextMenu:t=>{"function"==typeof e.showContextMenu&&(t.stopPropagation(),t.preventDefault(),e.showContextMenu({event:t,message:s}))},messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,ttl:s.ttl,localPath:s.localPath,UIContent:s.UIContent,isLastMsg:s.UIIsLastInList,sendDttm:s.sendDttm}}))))}));var BD=s("gXIT"),xD=s("05R2");const GD="ai-sticker-message-content",zD={Block:GD,Modifiers:{Audit:"--audit"},Elements:{Sticker:`${GD}__sticker`,Badge:`${GD}__badge`}},VD=e=>{const[t,s]=At.a.useState(!1),i=e.sticker.thumb||"",n=e.sticker.url;return At.a.createElement("div",{className:Object(gO.a)(zD.Block,zD.Modifiers.Audit,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},At.a.createElement(BD.a,{thumb:i,src:n,className:zD.Elements.Sticker,width:e.sticker.renderedWidth,height:e.sticker.renderedHeight,thumbPercentage:80,draggable:e.draggable,selectable:e.selectable,onLoad:(e,t,i)=>{s("src"===t)}}),Object(Vf.$AIStickerConfiguration)().isEnable("AIStickerMessage")&&t&&At.a.createElement(xD.a,{className:zD.Elements.Badge}),At.a.createElement(bD.b,{message:e.messageInfo,devSrc:"AIStickerMessageContent#2",visible:!1}))};let HD=function(e){return e.STICKER="sticker",e.UNDO="undo",e.DEL_EVERYONE="del-everyone",e}({});const WD="ai-sticker-message-content-wrapper",$D=(e,t)=>{const{data:s,observeIntersectionForReading:n}=e,a=(e=>e.msgType===R.MSG_UNDO?HD.UNDO:e.msgType===R.MSG_DEL_EVERYONE?HD.DEL_EVERYONE:HD.STICKER)(s),r=At.a.useRef(null);Object(zT.a)(r,n);const o=At.a.useMemo((()=>i.ModuleContainer.resolve(Vf.TAIStickerAppService).transformFromAIStickerMessage(s)),[s]),l=t=>{"function"==typeof e.showContextMenu&&(t.preventDefault(),t.stopPropagation(),e.showContextMenu({event:t,message:s}))};return At.a.createElement("div",{ref:e=>{r.current=e,null==t||t(e)},className:Object(gO.a)(WD,e.className),"data-component":R.DataAttributes.Component.STICKER,"data-qId":Object(WS.g)(s),onClick:e=>{},onClickCapture:e.onClickCapture,onContextMenu:l,onContextMenuCapture:e.onContextMenuCapture,onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()}},At.a.createElement(Qw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryContextMenu:l,onSendingContextMenu:l,onRetryClick:t=>{var i;t.preventDefault(),t.stopPropagation(),null===(i=e.resendMessage)||void 0===i||i.call(e,t,s)}},At.a.createElement(kL,{isSelected:e.isSelected},(()=>{switch(a){case HD.STICKER:return At.a.createElement(VD,{messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,UIContent:s.UIContent,isLastMsg:s.isLastMsg,ttl:s.ttl,sendDttm:s.sendDttm},sticker:o,draggable:!1,selectable:!1});case HD.UNDO:case HD.DEL_EVERYONE:return At.a.createElement(JL.a,{messageInfo:{msgId:s.msgId,msgType:s.msgType,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId}});default:return At.a.createElement(sD,{thumbPercentage:80,messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId}})}})())))},KD=At.a.forwardRef($D);var qD=s("NWd+"),QD=s("VeD8");const ZD=Object.values||(e=>Object.keys(e).map((t=>e[t])));function JD(e){return(Array.isArray||(e=>"[object Array]"===Object.prototype.toString.call(e)))(e)}class YD extends QD.a{constructor(e,t){super(e,t),this.isMounted_=!1}static getDerivedStateFromProps(e,t){return QD.a.getDerivedStateFromProps(e,t)}render(){return super.render()}componentDidMount(){super.componentDidMount(),this.isMounted_=!0}DEFAULT_checkShouldRunUpdateState(e,t,s){const{prevChildren:i,nextChildren:n}=s;return a=ZD(i).map((e=>e.key)),r=ZD(n).map((e=>e.key)),!(JD(a)&&JD(r)&&(a===r||a.length===r.length&&a.every(((e,t)=>e===r[t]))));var a,r}enableUpdateState_(e,t){const s={prevProps:e,nextProps:this.props},i={prevState:t,nextState:this.state},n={prevChildren:t.children,nextChildren:this.state.children};return(!0===this.props.update?this.DEFAULT_checkShouldRunUpdateState:"function"==typeof this.props.update?this.props.update:()=>!1)(s,i,n)}getSnapshotBeforeUpdate(e,t){if(this.enableUpdateState_(e,t)){return ZD(t.children).reduce(((e,t)=>{var s;const i=null===(s=t.props.nodeRef)||void 0===s?void 0:s.current;if(i){var n;const s=i.getBoundingClientRect(),a=t.key,r={reactKey:a,clientRect:s};e[a]=r,(null!==(n=t.props.onUpdateFlipMove)&&void 0!==n?n:function(){})(a,i,s)}return e}),{})}return null}componentDidUpdate(e,t,s){if(this.enableUpdateState_(e,t)){const e=ZD(this.state.children).reduce(((e,t)=>{var s;const i=null===(s=t.props.nodeRef)||void 0===s?void 0:s.current;if(i){const s=i.getBoundingClientRect(),n=t.key,a={reactKey:n,clientRect:s};e[n]=a}return e}),{}),t=ZD(s).reduce(((t,s)=>{const{reactKey:i}=s,n=e[i];return n&&(t[i]={prev:s,next:n}),t}),{});ZD(t).forEach((({prev:e,next:t})=>{let[s,i]=[t.clientRect.x-e.clientRect.x,t.clientRect.y-e.clientRect.y];if([s,i].some((e=>Math.abs(e)>0))){var n;const e=this.state.children[t.reactKey],r=null==e||null===(n=e.props.nodeRef)||void 0===n?void 0:n.current;if(r){var a;(null!==(a=e.props.onUpdatingFlipMove)&&void 0!==a?a:function(){})(e.key,r,t.clientRect);const n=r.animate([{transform:`translate(${-s}px, ${-i}px)`},{transform:"none"}],{duration:300,easing:"cubic-bezier(.29,.91,.52,1)"});n.onfinish=()=>{var e;if(!this.isMounted_)return;const s=this.state.children[t.reactKey],i=null==s||null===(e=s.props.nodeRef)||void 0===e?void 0:e.current;var a;i&&(null!==(a=s.props.onUpdatedFlipMove)&&void 0!==a?a:function(){})(s.key,i,t.clientRect);n.cancel()}}}}))}}componentWillUnmount(){this.isMounted_=!1}}mO.d;var XD=s("pQ8y");class eA extends XD.a{}const tA=["className","children","nodeRef"],sA="burrow-up-transition",iA=e=>{const{className:t,children:s,nodeRef:i=At.a.useRef(null)}=e,n=Object(Ip.a)(e,tA);return At.a.createElement(eA,Object(xt.a)({},n,{nodeRef:i,classNames:sA,unmountOnExit:!0,addEndListener:e=>{var t;null===(t=i.current)||void 0===t||t.addEventListener("transitionend",e,!1)}}),At.a.createElement("div",{ref:i,className:Object(gO.a)(sA,t)},s))};class nA extends YD{static getDerivedStateFromProps(e,t){const s=t.firstRender;let i=YD.getDerivedStateFromProps(e,t);if(s){const t=ZD(i.children).reduce(((e,t)=>(t.props.in&&(e[t.key]=t),e)),Object.create(null));if(Object.keys(t).length>=2){let s=null;At.a.Children.map(e.children,(e=>e)).forEach(((e,i)=>{t[e.key]&&(!s||s.index<i)&&(s={index:i,child:e})})),ZD(t).forEach((e=>{s&&e.key===s.child.key||(i.children[e.key]=At.a.cloneElement(e,{appear:!1,enter:!1}))}))}}return i}componentDidMount(){super.componentDidMount()}}const aA=["className","items","children","component"],rA="animated-sticker-group-message",oA=e=>{const{className:t,items:s,children:i,component:n="div"}=e,a=Object(Ip.a)(e,aA),r=At.a.useMemo((()=>s.map((e=>({nodeRef:At.a.createRef(),item:e})))),[s]);return At.a.createElement(nA,Object(xt.a)({className:Object(gO.a)(rA,t),component:n},a),r.map((({item:e,nodeRef:t})=>At.a.createElement(iA,{key:e.cliMsgId,nodeRef:t},i(e)))))};var lA=s("Hi8h");const cA=e=>{var t,s;const{data:i}=e,n=null!==(t=i.UIContent)&&void 0!==t?t:[],a=n.map((e=>({fromUid:e.fromUid,toUid:e.toUid,cliMsgId:e.cliMsgId}))),r=Boolean(i.UIIsLastInList),o=At.a.useMemo((()=>{const e=i.toUid,t=Object(qD.a)(),s=t.getASetOfJustAddedMessage(e);return void 0!==a.find((e=>{var i;const n=t.buildJustAddedMessageStateKey({fromUid:e.fromUid,toUid:e.toUid,cliMsgId:e.cliMsgId}),a=null===(i=s[n])||void 0===i?void 0:i.src,r=["just-sent","just-received"].includes(a);return r&&t.removeJustAddedMessage(n,!1),r}))}),[r,a.map((e=>e.cliMsgId)).join("_")]),l=Boolean(Object(lA.b)().enable),c=null!==(s=e.component)&&void 0!==s?s:"div";return At.a.createElement(At.a.StrictMode,null,r&&l?At.a.createElement(oA,{component:c,appear:o,enter:o,update:o,exit:!1,className:e.className,items:n,children:e.children}):At.a.createElement(c,{className:e.className},n.map((t=>e.children(t)))))};var dA=s("ptyt");function uA(e){const t=Object(Dt.useRef)(e||null),s=()=>(t.current||(t.current=new Map),t.current),i=(e,t)=>{s().has(e)||s().set(e,t)},n=e=>{s().delete(e)};return{getItemRefList:s,addItemRefToList:i,removeItemRefFromList:n,clearAllItemRefFromList:()=>{s().clear()},getItemRefFromList:e=>s().get(e),updateItemRefInList:(e,t)=>{t?i(e,t):n(e)}}}var hA=s("ynGT");const gA=e=>{const{noVisible:t=!1}=e;return At.a.createElement("div",{className:Object(gO.a)("download-entry-point",t&&"--no-visible",e.className),title:os.a.str("STR_DOWNLOAD_STICKER"),onClick:e.onDownloadClick,onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()}},At.a.createElement(LO.a,{icon:"Download-bold_24_Filled",className:"download-entry-point__download-icon"}))};function mA(e){if(!function(e){const t=Boolean(e&&e.msgType===R.MSG_STICKER_GROUP&&e.message&&1===e.message.length);if(!t)return t;const s=e.message[0];return Boolean(s&&(s.msgType===R.MSG_STICKER||s.msgType===R.MSG_STICKER_2))}(e))return null;const t=e.message[0];return{id:t.message.id,catId:t.message.catId}}function pA(e,t){return new Promise(((s,i)=>{var n;if(!e)return s(!1);if(null==t||null===(n=t.signal)||void 0===n?void 0:n.aborted)return i("Aborted");go.g.getDownloadedCateIds().then((n=>{var a;return(null==t||null===(a=t.signal)||void 0===a?void 0:a.aborted)?i("Aborted"):n&&n.length&&-1!==n.indexOf(e)?s(!1):void go.g.getStickerCategoriesV2().then((n=>{var a;if(null==t||null===(a=t.signal)||void 0===a?void 0:a.aborted)return i("Aborted");let r=!1;return n&&n.length&&(r=n.some((t=>t&&t.id===e&&![hA.g.OFF].includes(t.is_hidden)))),s(r)})).catch(i)})).catch(i)}))}const fA=e=>{const{stickerGroupMessage:t}=e,s=mA(t),[i,n]=At.a.useState(!1);At.a.useEffect((()=>{let e=null,t=null;const i=null==s?void 0:s.catId;return i?(e=new AbortController,pA(i,{signal:e.signal}).then((t=>{var s;null!==(s=e)&&void 0!==s&&s.signal.aborted||n(t)})).catch((e=>{zconsole.zsymb(21,"XOFi3T",["[checkCanDownloadStickerCateOrNot] error: {}","pt3I3S"],null==e?void 0:e.message)})),t=t=>{const s=-1===t.findIndex((e=>e===i));n(!!s&&(t=>{var s;t||(null===(s=e)||void 0===s||s.abort(),e=new AbortController,pA(i,{signal:e.signal}).then((t=>{var s;null!==(s=e)&&void 0!==s&&s.signal.aborted||n(t)})).catch((e=>{zconsole.zsymb(21,"K58OXt",["[checkCanDownloadStickerCateOrNot] error: {}","pt3I3S"],null==e?void 0:e.message)})));return t}))},go.g.addPersonalStickerListener(t)):n(!1),()=>{e&&e.abort(),t&&go.g.removePersonalStickerListener(t)}}),[null==s?void 0:s.catId]);const a=!s||!s.catId,r="0"==t.fromUid,o=Boolean(e.isMultiSel),l=r?"left":"right",c=!a&&i;return At.a.createElement("div",{className:Object(gO.a)("sticker-message-downloadable","left"===l?"--left-side":"--right-side")},c&&At.a.createElement(gA,{noVisible:o,onDownloadClick:t=>{s&&"function"==typeof e.showStickerSet&&(t.preventDefault(),t.stopPropagation(),e.showStickerSet({id:s.catId}))}}),e.children)},vA={Block:"sticker-group-message",Modifiers:{SentFromMe:"--from-me"},Elements:{}},bA=At.a.forwardRef(((e,t)=>{const{data:s,MessageQuickActionRenderer:i}=e,n="0"==s.fromUid,{isSelectedStickerMessage:a}=(e=>({isSelectedStickerMessage:t=>Boolean(e.isMultiSel&&e.selectedMsg&&e.selectedMsg[t])}))(e),{isFocusedStickerMessage:r}=(e=>({isFocusedStickerMessage:t=>{var s;return!(null===(s=e.focusId)||void 0===s||!s.length)&&e.focusId.includes(t)}}))(e),{bindStickerMessageItemRefs:o}=(e=>{const{getItemRefList:t,updateItemRefInList:s}=uA();return Object(Dt.useEffect)((()=>{var s;const i={ids:[],elements:[]};var n;null===(s=e.focusId)||void 0===s||s.forEach((e=>{const s=t().get(e);s&&(i.ids.push(e),i.elements.push({ele:s,ref:null}))})),i.ids.length>0&&(null===(n=e.focusHandler)||void 0===n||n.call(e,i.ids,i.elements,null,!0))}),[e.focusId]),{bindStickerMessageItemRefs:s}})(e),{bindStickerMessageItemRefs:l}=(e=>{const{windowId:t}=Object(SO.a)(),s=(t,s)=>{"function"==typeof e.onSeeMsg&&e.onSeeMsg(s),s&&e.newMsgIds&&e.newMsgIds.length>0&&e.newMsgIds.includes(s)&&"function"==typeof e.clearLatestMessageAction&&e.clearLatestMessageAction();const i=dA.a.getLastSavedPosition(t);if(i){const{msgId:e}=i;e===s&&dA.a.clearSavedPosition(t)}},{getItemRefList:i,updateItemRefInList:n}=uA();return At.a.useEffect((()=>{const e=i();for(let[i,n]of Array.from(e)){const e=Om.a.getInViewController(t);null==e||e.observe(n,{identifier:i,onIntersect:(...e)=>s("",i),threshold:.9})}return()=>{for(let[s,i]of Array.from(e)){const e=Om.a.getInViewController(t);null==e||e.unobserve(i)}}}),[e.data,t]),{bindStickerMessageItemRefs:n}})(e);(e=>{At.a.useEffect((()=>()=>{var t;const s=e.data;s&&(null===(t=s.UIContent)||void 0===t||t.forEach((e=>{LS.a.clearGroupId(e.msgId)})))}),[])})(e);const c=(e,t)=>{Object(gL.b)(t,gL.a.LEFT_CLICK_BUBBLE_MESSAGE)},d=(e,t)=>{Object(gL.b)(t,gL.a.RIGHT_CLICK_BUBBLE_MESSAGE)};return At.a.createElement("div",{ref:t,className:"sticker-group-message-wrapper"},At.a.createElement(cA,{component:"div",className:Object(gO.a)(vA.Block,n&&vA.Modifiers.SentFromMe,e.className),data:s},(t=>{const i=a(t.msgId),n=r(t.msgId);switch(t.UIType){case HS.e.PhotoSticker:return At.a.createElement(AD,Object(xt.a)({key:t.cliMsgId},e,{ref:e=>{o(t.msgId,e),l(t.msgId,e)},onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),isSelected:i,isFocused:n,data:t}));case HS.e.NoBorderPhotoSticker:return At.a.createElement(UD,Object(xt.a)({},e,{ref:e=>{o(t.msgId,e),l(t.msgId,e)},onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),isSelected:i,isFocused:n,data:t}));case HS.e.AISticker:return At.a.createElement(KD,Object(xt.a)({key:t.cliMsgId},e,{ref:e=>{o(t.msgId,e),l(t.msgId,e)},onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),isSelected:i,isFocused:n,data:t}));case HS.e.Sticker:return At.a.createElement(fA,{stickerGroupMessage:s,isMultiSel:e.isMultiSel,showStickerSet:e.showStickerSet},At.a.createElement(uD,Object(xt.a)({key:t.cliMsgId,ref:e=>{o(t.msgId,e),l(t.msgId,e)}},e,{onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),windowId:e.windowId||Go.c,isSelected:i,isFocused:n,data:t})))}})),i&&At.a.createElement(i,null))})),IA=e=>{const{data:t}=e,i="0"==t.fromUid;return At.a.createElement("div",{className:Object(gO.a)("sticker-set-message",e.className),onClick:()=>{var e;const i=null===(e=s("k+R1"))||void 0===e?void 0:e.default;if(i){var n;const e=t.toUid,s=i.getChatBoxControllerByConvId(e);null==s||null===(n=s._showStickerSet)||void 0===n||n.call(s,{id:t.UIContent.parsedParams.id})}},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:s=>{if("function"!=typeof e.showContextMenu)return;const i={event:s,message:t};e.showContextMenu(i)}},At.a.createElement("div",{className:"sticker-set-message__content"},At.a.createElement("div",{title:os.a.str("STR_STICKER_SET"),className:"sticker-set-message__thumb",style:{backgroundImage:`url(${ho.default.removeProtocol(t.UIContent.thumb)})`}}),At.a.createElement("div",{className:"sticker-set-message__info"},At.a.createElement(lO.a,{textKey:"STR_STICKER_SET",tagName:"span",className:"sticker-set-message__title"}),At.a.createElement("span",{className:"sticker-set-message__name"},t.UIContent.title))),!i&&At.a.createElement(At.a.Fragment,null,At.a.createElement("div",{className:"sticker-set-message__separator"}),At.a.createElement("div",{className:"sticker-set-message__downloadable"},At.a.createElement(LO.a,{icon:"Download_24_Line",className:"sticker-set-message__download-icon mr-4"}),At.a.createElement(lO.a,{textKey:"STR_FREE_DOWNLOAD_STICKER_SET",tagName:"span",className:"sticker-set-message__download-title"}))))};var yA=e=>{var t;const{data:s,isFocused:i,observeIntersectionForReading:n}=e,a="0"==s.fromUid,r=At.a.useRef(null);Object(zT.a)(r,n);const o=Object(hs.m)(Wc.b,null===(t=e.conversation)||void 0===t?void 0:t.userId,(e=>{var t;return null!==(t=null==e?void 0:e.lockSendMsg)&&void 0!==t&&t}));return At.a.createElement(VT.a,{border:6,isAdmin:e.isHighlightedByPrivilegedUser,variant:"common",ttl:s.ttl},At.a.createElement("div",{ref:r,className:Object(gO.a)("sticker-set-message-wrapper",a&&"--blue",e.isHighlightedByPrivilegedUser&&!s.ttl&&"--highlighted-from-admin",!1,o&&"--none-clickable","shadow-bubble","rounded-6","focused-item",i&&"focused-item--highlight-border"),"data-qId":Object(WS.g)(s)},At.a.createElement(IA,e)))},_A=s("mVVk"),CA=s("f08i");var OA=function(e){return e.INIT="init",e.PROCESSING="processing",e.SUCCESS="success",e.FAILED="failed",e}(OA||{});const EA=e=>{const[t,s]=At.a.useState(null),n=At.a.useRef(null);At.a.useEffect((()=>{if(!t)return;if(!e.conversation||!e.conversation.userId)return;let s=e.message;if(!s||!s.message)return;if([R.MSG_LOCAL,R.MSG_FAIL].includes(s.status))return;if(s.subType===R.MSG_SUBTYPE_LINK)return;const a=n.current;if(!a||OA.INIT===a.status||a.payload.cliMsgId!==s.cliMsgId||a.payload.fromUid!==s.fromUid||a.payload.toUid!==s.toUid){const a={status:OA.PROCESSING,payload:{link:t,msgId:s.msgId,cliMsgId:s.cliMsgId,fromUid:s.fromUid,toUid:s.toUid}};n.current=a,s=Object(f.a)(Object(f.a)({},s),{},{subType:R.MSG_SUBTYPE_LINK}),((e,t,s)=>new Promise(((n,a)=>{Rt.default.updateMessage(t.msgId,t,["subType"],e.userId).then((()=>{let e=Object(_A.a)(t,s);const r=i.ModuleContainer.resolve(Ui.a),o={newId:`${t.cliMsgId}_${t.fromUid}_${t.toUid}`,oldId:t.msgId};r.isExistedMedia("link",o).then((s=>{s?n({status:"existed",payload:null}):(CA.a.receiveMediaFromMessage(t.toUid,[],[],[{msgId:t.msgId,userId:t.toUid,message:e.message,sendDttm:t.sendDttm,cliMsgId:t.cliMsgId,fromUid:t.fromUid,type:"link",ttl:t.ttl}]),n({status:"success",payload:{updatedMessage:t,linkMediaMessage:e}}))})).catch((e=>{zconsole.zsymb(21,"hNAcG1",["Failed to check existed media: {}","_dp7tv"],null==e?void 0:e.message),a(e)}))})).catch((e=>{zconsole.zsymb(21,"mKAqyL",["Failed to update link media message: {}","DTS5tA"],null==e?void 0:e.message),a(e)}))})))(e.conversation,s,t).then((t=>{if("success"===t.status&&t.payload){const{updatedMessage:s,linkMediaMessage:i}=t.payload;e.dispatch&&e.dispatch({type:Ai.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:s}),Fi.default.send(Ai.ChatBoxActions.ADD_MESSAGE_LINK,{conversation:e.conversation,conversationId:e.conversation.userId,messages:[i]})}a.status=OA.SUCCESS})).catch((()=>{a.status=OA.FAILED}))}}),[e.message,e.conversation,t]);return{updateFirstLink:e=>{e&&e!==t&&s(e)}}};var MA=s("GGl6");const SA="text-message__container",TA={HasStatus:SA+"--has-status"};function wA(e){const{conversationID:t,isSelected:s,message:i,topMember:n}=e,a=i.quote;return null==a?null:(""===a.fromD&&(a.fromD=function(e,t){const s=e.quote||{fromUid:"",ownerId:"",fromD:""};let i=s.fromD;if(!i)return i;const n=s.fromUid||s.ownerId;if(n===rt.p.getSessionUserId()){const e=ns.default.getMiniProfileMe();i=(null==e?void 0:e.dName)||""}else if(Array.isArray(t)){const e=ns.default.getDName(n);if(e)i=e;else for(let s of t)if(s.id===n){i=s.dName;break}}else i=ns.default.getDName(n)||"";return i}(i,n)),At.a.createElement(uw.MessageQuoteFragment,{conversationID:t,deprecated:{message:i},quote:a,isSelected:s}))}function RA(e){return void 0===e.urgency||null===e.urgency?null:At.a.createElement(uw.MessageUrgencyIndicator,{urgency:e.urgency})}function LA(e){const{contentRenderer:t,message:s}=e,i=Object(iO.a)(),n=Object(ML.a)();return At.a.createElement(aR.a,{windowId:n,message:s,data:s.extra.todoInfo,htmlInner:t,user:{userId:rt.p.getSessionUserId()},dispatch:i})}var DA=function(e){const{conversation:t,data:s,isFocusing:i,isMultiSel:n,selectedMsg:a={},topMember:r}=e,o=Boolean(n&&a[s.msgId]),{updateFirstLink:l}=EA({conversation:e.conversation,message:s,dispatch:e.dispatch});if(Object(zf.H)(s))return At.a.createElement(MA.a,Object(xt.a)({},e,{data:s,isHighlighted:i,isSelected:o}));const c=R.UIMessagePrefixElementID.TextMessage+Object(WS.i)(s),d=(null==t?void 0:t.userId)||"",u=Object(yR.a)(s.UIContent,e,l),h=function(e){const t=[];return e.shouldShowStatus&&t.push(TA.HasStatus),Object(gO.a)(t)}(e),g=function(e,t){return e.extra&&e.extra.todoInfo?"0"===e.extra.fromUid?"div_TskASGD_Msg":"div_TskRECD_Msg":"0"===e.fromUid?t.isLastMsg?"div_LastSentMsg_Text":"div_SentMsg_Text":t.isLastMsg?"div_LastReceivedMsg_Text":"div_ReceivedMsg_Text"}(s,{isLastMsg:!1});let m=null;return s.extra&&s.extra.todoInfo&&(m=At.a.createElement(LA,{contentRenderer:u,message:s})),At.a.createElement("div",{id:c,className:Object(gO.a)(SA,h),"data-id":g},At.a.createElement(wA,{conversationID:d,isSelected:o,message:s,topMember:r}),At.a.createElement(RA,{urgency:s.urgency}),m||At.a.createElement("div",null,u))};var AA=function(e){e.data;const t=lO.a;return At.a.createElement(t,{className:"undo-message",textKey:"STR_UNDO_MSG"})};var FA=function(e){return e.data,At.a.createElement("div",null,"Tin nhắn không hiển thị được")};var jA=(e=!1)=>{const[t,s]=Object(Dt.useState)(e);return[t,Object(Dt.useCallback)((()=>{s(!0)}),[]),Object(Dt.useCallback)((()=>{s(!1)}),[])]},PA=s("POdc");const kA=368;var NA=s("sOq/"),UA=s("8sI6"),BA=s("h9Os");var xA=function(e){const{hasCaption:t=!1,convId:s}=e,i=At.a.useMemo((()=>t?{boxShadow:"initial",borderTopLeftRadius:"inherit",borderTopRightRadius:"inherit",borderBottomLeftRadius:0,borderBottomRightRadius:0}:{boxShadow:"initial"}),[t]);return At.a.createElement("div",{className:"lqip -error lqip-video-error lqip-video clickable",style:i},At.a.createElement(BA.b,{isVideo:!0}))},GA=s("IzMZ"),zA=s("s1dB");const VA="bubble-message-sending-indicator-button",HA={Block:VA,Modifiers:{black:"--black",grey:"--grey",sm:"--sm",md:"--md",lg:"--lg"}};var WA=function(e){const{bg:t="black",size:s="md",ringThick:i}=e,n=At.a.useMemo((()=>({size:"sm"===s?16:"md"===s?28:46,baseRingColor:"var(--WA100)",ringColor:"var(--NG70)",ringThick:isNaN(+i)?"sm"===s?2:3:+i})),[s]);return At.a.createElement("div",{className:Object(gO.a)(HA.Block,t&&HA.Modifiers[t],s&&HA.Modifiers[s])},At.a.createElement(zA.a,Object(xt.a)({},n,{className:`${VA}__loading`})))};var $A=function(e){const{variant:t}=e;let s=null;return"play"===t?s=At.a.createElement("div",{className:UA.j},At.a.createElement("i",{className:"fa fa-play"})):"loading"===t&&(s=At.a.createElement(WA,{size:"md",ringThick:2})),At.a.createElement("div",{className:UA.e},s)};var KA=function(e){const{children:t,className:s,isClickable:i,isHoverDeactivated:n,isNoBackgroundColor:a,isSelected:r}=e;return At.a.createElement("div",{className:Object(gO.a)(UA.a,r&&UA.b.Selected,i&&UA.b.Clickable,n&&UA.b.HoverDeactivated,s)},t)};function qA(e){return ji.l||e.localPath?"play":e.isDownloadError?"loading":"play"}var QA=s("eZmn");function ZA(e,t){const{className:s,conversation:i,handleDownloadResult:n,message:a,onLoad:r,style:o,thumbUrl:l,userId:c}=e;return At.a.createElement(QA.a,{ref:t,className:s,onLoad:r,style:o,src:l,cacheFolderName:"Cache",userId:c,message:a,downloadCallback:n,conversation:i,showPlayButton:!1})}var JA=At.a.forwardRef(ZA);const YA=At.a.forwardRef((function(e,t){var s,i;const{clickVideo:n,contentSize:a,conversation:r,data:o,handleDownloadResult:l,isDownloadError:c,isExpired:d,isMultiSel:u,isNonPersonalCloudKeyError:h,isSelected:g,localPath:m,onLoadVideo:p}=e,{UIContent:v}=o,b=v.thumbUrl,I=v.duration,y=At.a.useMemo((()=>({height:a.height-2+"px",maxHeight:kA+"px",width:a.width-2+"px"})),[a]);return h?At.a.createElement("div",{className:"relative flx",onClick:n},At.a.createElement(V_.e,{className:Object(gO.a)("outline-bubble","rounded-5",UA.h,g&&UA.i.Selected),disableEvents:u,msgIds:[null==o?void 0:o.msgId],style:y,type:"video",windowId:"1",entry:NA.a.CSC,message:o,devSrc:"VideoMessageNonCaption"})):d?At.a.createElement("div",{className:Object(gO.a)("relative",d?"":"clickable"),onClick:n,style:Object(f.a)(Object(f.a)({},y),{},{borderRadius:"inherit"})},At.a.createElement(xA,{convId:null==o?void 0:o.toUid})):At.a.createElement("div",{className:"relative flx",onClick:n},At.a.createElement(JA,{ref:t,className:Object(gO.a)(UA.k,"rounded-5"),conversation:r,handleDownloadResult:l,message:o,onLoad:p,style:y,thumbUrl:b,userId:null!==(s=null!==(i=null==r?void 0:r.userId)&&void 0!==i?i:o.toUid)&&void 0!==s?s:""}),At.a.createElement(KA,{className:Object(gO.a)("rounded-t-5","rounded-b-5"),isClickable:!0,isHoverDeactivated:Boolean(u),isSelected:g},At.a.createElement(GA.a,{duration:I}),At.a.createElement($A,{variant:qA({isDownloadError:c,localPath:m})})),At.a.createElement(bD.b,{entry:bD.a.csc,message:o,devSrc:"VideoMessageNonCaption"}))}));function XA(e,t){const{data:s,doubleClick:i,isHighlightedByPrivilegedUser:n,isFocused:a,observeIntersectionForReading:r,showMessageContextMenu:o}=e,{UIContent:l}=s,c=At.a.useRef(null);return Object(zT.a)(c,r),l?At.a.createElement(VT.a,{className:Object(gO.a)(UA.f,n&&(null==s.ttl||0==s.ttl)&&UA.g.HighlightFromPrivilegedUser,"focused-item",a&&"focused-item--highlight-border"),border:6,isAdmin:n,ttl:s.ttl,variant:"photo"},At.a.createElement("div",{ref:c,"data-qId":Object(WS.g)(s),onContextMenu:o,onDoubleClick:i},At.a.createElement(YA,Object(xt.a)({},e,{ref:t})))):null}var eF=At.a.forwardRef(XA);const tF=At.a.forwardRef((function(e,t){const{clickVideo:s,contentSize:i,conversation:n,data:a,doubleClick:r,handleDownloadResult:o,isDownloadError:l,isExpired:c,isMultiSel:d,isNonPersonalCloudKeyError:u,isSelected:h,localPath:g,onLoadVideo:m}=e,{UIContent:p}=a,v=p.thumbUrl,b=p.duration,I=At.a.useMemo((()=>({height:i.height-2+"px",maxHeight:kA+"px",width:i.width-2+"px"})),[i]),y=p.caption;let _=null;if(u||"non-personal-cloud"===y)_=At.a.createElement(V_.e,{className:Object(gO.a)("outline-bubble","rounded-t-5",UA.h,h&&UA.i.Selected),disableEvents:d,msgIds:[null==a?void 0:a.msgId],style:Object(f.a)(Object(f.a)({},I),{},{borderRadius:"inherit"}),type:"video",windowId:"1",entry:NA.a.CSC,message:a,devSrc:"VideoMessageWithCaption"});else if(c||"is-expired"===y)_=At.a.createElement(xA,{hasCaption:!0,convId:null==a?void 0:a.toUid});else{var C,O;_=At.a.createElement(At.a.Fragment,null,At.a.createElement(JA,{ref:t,className:Object(gO.a)(UA.k),conversation:n,handleDownloadResult:o,message:a,onLoad:m,style:I,thumbUrl:v,userId:null!==(C=null!==(O=null==n?void 0:n.userId)&&void 0!==O?O:a.toUid)&&void 0!==C?C:""}),At.a.createElement(KA,{className:Object(gO.a)("rounded-t-5"),isClickable:!0,isHoverDeactivated:Boolean(d),isSelected:h},At.a.createElement(GA.a,{duration:b}),At.a.createElement($A,{variant:qA({isDownloadError:l,localPath:g})})),At.a.createElement(bD.b,{entry:bD.a.csc,message:a,devSrc:"VideoMessageWithCaption"}))}return At.a.createElement("div",{className:UA.m,onClick:s,onDoubleClick:r,style:I},_)}));function sF(e,t){const{contentSize:s,data:i,isFocused:n,isHighlightedByPrivilegedUser:a,isMultiSel:r,isSelected:o,observeIntersectionForReading:l,SentTimeCompRenderer:c,showMessageContextMenu:d}=e,{UIContent:u}=i,h=At.a.useRef(null);if(Object(zT.a)(h,l),!u)return null;const g="0"===i.fromUid,m=At.a.useMemo((()=>({height:s.height-2+"px",maxHeight:kA+"px",width:s.width-2+"px"})),[s]),p=R.UIMessagePrefixElementID.VideoMessage+Object(WS.i)(i),f=At.a.useCallback((e=>{d(e,{captionContainerElementId:p})}),[]);return At.a.createElement(VT.a,{className:Object(gO.a)(UA.n,a&&(null==i.ttl||0==i.ttl)&&UA.o.HighlightFromPrivilegedUser,!Boolean(i.ttl)&&"shadow-bubble","rounded-6","focused-item",g&&UA.o.Blue,o&&UA.o.Selected,n&&"focused-item--highlight-border"),border:6,isAdmin:a,variant:"photo",ttl:i.ttl},At.a.createElement("div",{ref:h,"data-qId":Object(WS.g)(i),onContextMenu:d},At.a.createElement(tF,Object(xt.a)({},e,{ref:t})),At.a.createElement("div",{id:p,className:Object(gO.a)(UA.l,"rounded-bl-6","rounded-br-6",r&&"clickable"),onContextMenu:f,style:{width:m.width}},Object(yR.a)(u.caption,e),c?At.a.createElement(c,null):null)))}var iF=At.a.forwardRef(sF),nF=s("9+7Y");var aF=function(e){var t;const{chatId:s,containerWidth:n,conversation:a,data:r,isMultiSel:o,selectedMsg:l={},SentTimeCompRenderer:c,showContextMenu:d,turnOnMultipleSelectionMode:u,user:h}=e,g=Boolean(o&&l[r.msgId]),{status:m}=Object(Nw.a)(r,"VideoMessage"),p=Object(nF.a)(r),[v,b,I]=jA(!1),[y,_]=At.a.useState(null!==(t=r.localPath)&&void 0!==t?t:""),C=At.a.useRef(),O=At.a.useRef(!1),E=Object(iO.a)();At.a.useEffect((()=>{Rw.a.getInstance().push(r,Rw.b.chatview)}),[]);const M=Object(SR.a)(((e,t)=>{!0!==e&&(e?b():S(t))})),S=Object(SR.a)((e=>{var t;if(r.status<R.MSG_SENT)return;_(e),null===(t=i.ModuleContainer.resolve(Ui.a))||void 0===t||t.updateMedia("image",r.toUid,r.msgId,{localPath:e},["localPath"]);const s=r.toUid;Rt.default.updateMessage(r.msgId,{msgId:r.msgId,localPath:e},["localPath"],s),E({type:Ai.ChatBoxActions.FILEPATH_UPDATED,payload:Object(f.a)(Object(f.a)({},r),{},{localPath:e})})})),[T]=function(e,t=200){const s=Object(iR.a)(e,t);return[s,s.cancel]}((e=>{(()=>{const e=JSON.parse(JSON.stringify(r)),t={user:h,selectedId:e.msgId,oriUrl:e.message.oriUrl,userId:e.userId,isVideo:e.msgType===R.MSG_VIDEO||2===e.subType,message:e,conversation:a,isMessageConv:!0,images:[r],iconMap:Ud.b.getIconMap(),appConfig:Object(mi.getPVConfigs)()};Co.a.OpenPhoto.openPhotoViewer(t)})(),Object(PA.c)(r,PA.a.UserAction),mi.default.cloud_send2me.enable&&s==mi.default.sendToMeId&&fR.b.log(fR.a.OPEN,1,r),I()})),w=Object(SR.a)((e=>{e&&e.stopPropagation(),o?u(e,r):T(e)})),L=Object(SR.a)((()=>{if(!0===O.current)return;const e=JSON.parse(JSON.stringify(r));let t;if(e.UIContent&&e.status!=R.MSG_LOCAL&&e.status!=R.MSG_FAIL&&C.current&&"function"==typeof C.current.getThumbEle&&(t=C.current.getThumbEle()))try{const s=e.UIContent.width,i=e.UIContent.height;if(s!==t.naturalWidth||i!==t.naturalHeight){const s={video_width:t.naturalWidth,video_height:t.naturalHeight,parsed:1};O.current=!0,Rt.default.updateMessageParams(e.msgId,s,e)}}catch(s){}})),D=Object(SR.a)((e=>{e&&e.stopPropagation()})),A=R.UIMessagePrefixElementID.VideoMessage+Object(WS.i)(r);let F=R.MULTI_PHOTO_SELECTED_TYPE.TYPE_UNSELECTED;g&&l[r.msgId]&&(F=l[r.msgId].multipleSelectedType||R.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL);const j=Object(SR.a)(((e,t)=>{"function"==typeof d&&d({event:e,message:r,detail:Object(f.a)({},t)})})),P=function(e,t=-1){const s=160,i=110,n=368;let a=Math.min(798,isNaN(t)?798:t);t<=-1&&(a=n);let r=!1;const o={width:n+"px",height:n+"px",defaultSize:!0};if(!e)return o;let l=e.width,c=e.height;if(void 0!==l&&null!=c||(l=n,c=n,r=!0),!e.parsed&&Um.a(e.rotation)&&Boolean(+e.rotation/90%2)){const e=l;l=c,c=e}if(l>0&&c>0){let t=l,o=c;if(l<s&&c<i)o=i,t=s;else if(l>a&&c>n){let e=n/c;if(o=n,t=Math.round(l*e),t>a){e=a/t,t=a;let s=Math.round(o*e);o=Math.max(s,i)}t=Math.max(t,s)}else if(c>n){let e=n/c;o=n;let i=Math.round(l*e);t=Math.max(s,i)}else if(c>=i&&c<=n){if(l>a){let e=a/l;t=a;let s=Math.round(c*e);o=Math.max(i,s)}else if(l<s){t=s;let e=s/l,a=Math.round(c*e);o=Math.min(Math.max(i,a),n)}}else if(c<i){o=i;let e=i/c,n=Math.round(e*l);t=l>a?a:Math.min(Math.max(s,n),a)}return{height:o+"px",width:t+"px",defaultSize:r,rotation:e.rotation}}return o}(r.UIContent,n-201),k=At.a.useMemo((()=>{if(P.width){const e=parseInt(P.height),t=parseInt(P.width);return{height:isNaN(e)?kA:e,width:isNaN(e)?kA:t}}return{width:kA,height:kA}}),[P.width,P.height]),N=Object(SR.a)((()=>{nL.a.logActionMediaCaption(a,r,P.width)}));At.a.useEffect((()=>{N()}),[P.width]);const U=Boolean(r.message&&r.message.title);let B=r.UIContent&&r.status!=R.MSG_LOCAL&&r.status!=R.MSG_FAIL&&"none"===m;return U?At.a.createElement(iF,Object(xt.a)({},e,{ref:C,clickVideo:w,containerId:A,contentSize:k,doubleClick:D,isDownloadError:v,isExpired:B,isNonPersonalCloudKeyError:p,isSelected:g,handleDownloadResult:M,localPath:y,onLoadVideo:L,SentTimeCompRenderer:c,showMessageContextMenu:j})):At.a.createElement(eF,Object(xt.a)({},e,{ref:C,clickVideo:w,containerId:A,contentSize:k,doubleClick:D,isDownloadError:v,isExpired:B,isNonPersonalCloudKeyError:p,isSelected:g,handleDownloadResult:M,localPath:y,onLoadVideo:L,showMessageContextMenu:j}))};var rF=Qi;let oF;var lF={GetManager:()=>{var e;return null!==(e=oF)&&void 0!==e?e:oF=i.ModuleContainer.resolve(rF)}};const cF="voice-message-loading",dF=cF+"__indicator-wrapper",uF=cF+"__indicator",hF="voice-message-expired",gF=hF+"__icon-wrapper",mF=hF+"__content-wrapper",pF="voice-message-invalid",fF=pF+"__title-container",vF=pF+"__title-icon-wrapper",bF=pF+"__title-content-wrapper",IF=pF+"__description-container",yF=pF+"__description-icon-wrapper",_F=pF+"__description-content-wrapper",CF="voice-message-normal",OF=CF+"__content-container",EF=CF+"__player-control-wrapper",MF=CF+"__waveform-wrapper",SF=CF+"__waveform-col-one",TF={Playing:SF+"--playing"},wF=CF+"__waveform-col-two",RF={Playing:wF+"--playing"},LF=CF+"__waveform-col-three",DF={Playing:LF+"--playing"},AF=CF+"__duration-wrapper";var FF=function(e){let{toUid:t}=null==e?void 0:e.message,s=t===mi.default.sendToMeId;const i=HE.a.getInstance().isPaidUser()||s?"STR_ZCLOUD_VOICE_UNAVAILABLE":"STR_CLOUD_VOICE_EXPIRED_ALL",n=Object(MR.c)(i);return At.a.createElement("div",{className:hF},At.a.createElement("div",{className:gF},At.a.createElement("i",{className:"fa fa-Mic-off_24_Filled"})),At.a.createElement("div",{className:mF},n))};var jF=function(e){const t=Object(MR.c)("STR_VOICE_MESSAGE"),s=Object(MR.c)("STR_E2EE_VOICE_NOT_SUPPORT");return At.a.createElement("div",{className:pF},At.a.createElement("div",{className:fF},At.a.createElement("div",{className:vF},At.a.createElement("i",{className:"fa fa-Mic_24_Line"})),At.a.createElement("div",{className:bF},t)),At.a.createElement("div",{className:IF},At.a.createElement("div",{className:yF},At.a.createElement("i",{className:"fa fa-Warning_Circle_24_Line"})),At.a.createElement("div",{className:_F},s)))},PF=s("Nd7d");var kF=function(){return At.a.createElement("div",{className:CF},At.a.createElement("div",{className:OF},At.a.createElement("div",{className:dF},At.a.createElement(PF.a,{className:uF,color:"var(--B50)",size:20})),At.a.createElement("div",{className:MF},At.a.createElement("div",{className:SF}),At.a.createElement("div",{className:wF}),At.a.createElement("div",{className:LF})),At.a.createElement("div",{className:AF},"--:--")))};const NF=function(){let e=null;return{GetFactory:()=>(null===e&&(e=i.ModuleContainer.resolve(Bi)),e)}}();var UF={Audio:lF,MediaPlayer:NF};var BF=s("WKSW"),xF=s("LkXv");const GF="readyplay",zF="loading";var VF=function(e){const{duration:t,message:s,source:n,reloadResource:a}=e,[r,o]=At.a.useState(null),[l,c]=At.a.useState(t),[d,u]=At.a.useState(!1),[h,g]=At.a.useState(zF),[m,p]=At.a.useState(!1);At.a.useEffect((()=>{const e=UF.MediaPlayer.GetFactory().createAudioPlayer();return o(e),()=>{UF.MediaPlayer.GetFactory().deleteMediaPlayer(e.getToken())}}),[]),At.a.useEffect((()=>(r&&(n!==r.getSource()&&(r.release(),r.setSource(n)),r.prepare(),r.addEventListener("canplay",((e,t)=>{g(GF)})),r.addEventListener("durationchange",((e,t)=>{c(1e3*t)})),r.addEventListener("ended",(()=>{u(!1)})),r.addEventListener("timeupdate",((e,t)=>{c(1e3*t.remainingTime)})),r.addEventListener("onabort",((e,t)=>{Object(xF.c)("onabort",null==s?void 0:s.msgId)})),r.addEventListener("onerror",((e,t)=>{var i;Object(xF.c)("onerror",null==s?void 0:s.msgId),i=e,Object(xF.c)("onerror",null==s?void 0:s.msgId,i),null==r||r.stop(),u(!1)}))),()=>{})),[n,r]),At.a.useEffect((()=>{m?v():p(!1)}),[m]);const f=function(e){return e<0?"--:--":YM.a.getMinutesFromSeconds(Math.round(e))}(l/1e3),v=()=>{Object(BF.a)(s)?i.ModuleContainer.resolve(V_.c).getErrorPCloudHandler({msgIds:[null==s?void 0:s.msgId],windowId:Go.c,error:{hasNoKey:!0},showNoti:!0,type:"audio"})():h===GF?(u(!d),r&&(d?r.stop():r.play())):(a((e=>{g(GF),p(!0)}),(e=>{})),u(!1),null==r||r.stop())};return At.a.createElement("div",{className:CF,onClick:v,id:n},At.a.createElement("div",{className:OF},At.a.createElement("div",{className:EF},d?At.a.createElement("i",{className:"fa fa-StopCircle_24_Filled"}):At.a.createElement("i",{className:"fa fa-PlayCircle_24_Filled"})),At.a.createElement("div",{className:MF},At.a.createElement("div",{className:Object(gO.a)(SF,d&&TF.Playing)}),At.a.createElement("div",{className:Object(gO.a)(wF,d&&RF.Playing)}),At.a.createElement("div",{className:Object(gO.a)(LF,d&&DF.Playing)})),At.a.createElement("div",{className:AF},f)),At.a.createElement(bD.b,{entry:bD.a.csc,message:s,devSrc:"VoiceMessageNormal"}))},HF=s("YHwM");function WF(e){var t,s;if(!e)return 0;let i=null==e||null===(t=e.message)||void 0===t?void 0:t.params;if("string"==typeof i)try{i=JSON.parse(i)}catch(n){}return null!==(s=i)&&void 0!==s&&s.duration?Math.round(+i.duration/1e3):0}var $F=function(e){const{data:t}=e,[s,i]=At.a.useState(null),n=Object(ML.a)(),{flag:a,status:r}=Object(Nw.a)(t,"VoiceMessage"),o=At.a.useCallback(((e,s)=>{try{lF.GetManager().reloadResourceFromMessage(t).then((n=>{i({localURL:n.localURL,URL:n.URL,status:n.status}),"playable"===(null==n?void 0:n.status)?null==e||e(n.localURL||n.URL):(null==s||s(),Object(HF.a)(t))})).catch((e=>{null==s||s(e)}))}catch(n){null==s||s(n)}}),[t]);At.a.useEffect((()=>{lF.GetManager().loadResourceFromMessage(Object(f.a)(Object(f.a)({},t),{},{content:t.UIContent}),{windowId:n}).then((e=>{i({localURL:e.localURL,URL:e.URL,status:e.status})}))}),[t.msgId]),At.a.useEffect((()=>{Rw.a.getInstance().push(t,Rw.b.chatview)}),[]);let l=null;if("none"===r)l=At.a.createElement(FF,{message:t});else if(null==s)l=At.a.createElement(kF,null);else if("playable"===s.status||"clouded"===r||a&vn.d.server_temp){var c;l=At.a.createElement(VF,{duration:null!==(c=t.UIContent.duration)&&void 0!==c?c:WF(t),message:t,source:s.localURL||s.URL,reloadResource:o})}else l="expired"===s.status?At.a.createElement(FF,{message:t}):"not-supported"===s.status?At.a.createElement(jF,null):At.a.createElement(FF,{message:t});return At.a.createElement("div",{id:R.UIMessagePrefixElementID.VoiceMessage+Object(WS.i)(t),className:"voice-message"},l)};var KF=s("PWbL");var qF=function(e){const{conversation:t,data:s,isFocused:i,sendTimeComp:n,user:a}=e,r=Object(ML.a)();return At.a.createElement(KF.b,{key:s.msgId,message:s,user:a,conversation:t,windowId:r,isFocused:i,sourceRender:KF.a.MESSAGE_WIDGET,sendTime:n})};var QF,ZF={[HS.e.Call]:{configs:{layoutType:HS.d.NoFrame,canReact:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:dw,transformData:gT},[HS.e.Contact]:{configs:{layoutType:HS.d.NoFrame,layout:{maxWidth:306,width:"100%"}},component:Mw,transformData:pT},[HS.e.DFE]:{configs:{canReact:!1,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:Sw},[HS.e.E2eeDecryptFailed]:{configs:{hasDynamicBorder:!0,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:nT},[HS.e.E2eePendingData]:{configs:{hasDynamicBorder:!0,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:rT},[HS.e.File]:{configs:{layout:{maxWidth:400,width:"100%"},hasDynamicBorder:!0,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object($w.a)(e))}}},component:Ww,transformData:fT},[HS.e.GIF]:{configs:{layoutType:HS.d.NoFrame,shouldShowMessageStatusSideIndicator:!1},component:sR},[HS.e.Link]:{"recommened.link":{configs:{layout:{maxWidth:400,minWidth:220}},component:ER,transformData:IT}},[HS.e.Location]:{configs:{layoutType:HS.d.NoFrame},component:WR,transformData:_T},[HS.e.OA]:{configs:{layoutType:HS.d.NoFrame,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:TL},[HS.e.Photo]:{configs:{disablePointerEvent:!1,layoutType:HS.d.NoFrame,reaction:{},messageQuickActionConfig:{canReply:function(e){return!!e&&e.msgType!==R.MSG_PHOTO_GROUP},canForward:function(e){if(!e)return!1;if(e.msgType===R.MSG_PHOTO_GROUP){const t=e.message;for(let e=0;e<t.length;e++)if(Object($w.a)(t[e]))return!0;return!1}return!!Object($w.a)(e)}},shouldShowMessageStatusSideIndicator:e=>{if(!Object(zf.x)(e))return!1;if(!Object(zf.o)(e))return!1;const t=e.message;if(!t||t.length<=1)return!1;return t.every(zf.l)}},component:EL},[HS.e.StickerGroup]:{configs:{canReact:!1,canDoubleClick:!1,disablePointerEvent:!1,messageQuickActionConfig:{canReply:e=>{const t=e.message;if(null==t||!t.length)return!1;if(t.length>1)return!1;const s=t[0];return!!s&&(s.status!==R.MSG_FAIL&&s.status!==R.MSG_LOCAL&&(s.msgType!==R.MSG_UNDO&&s.msgType!==R.MSG_DEL_EVERYONE))},canForward:e=>{const t=e.message;if(null==t||!t.length)return!1;if(t.length>1)return!1;const s=t[0];return!!s&&(s.status!==R.MSG_FAIL&&s.status!==R.MSG_LOCAL&&(s.msgType!==R.MSG_UNDO&&s.msgType!==R.MSG_DEL_EVERYONE))}},layoutType:HS.d.NoFrame,shouldShowMessageStatusSideIndicator:e=>{if(!Object(zf.x)(e))return!1;if(!Object(zf.p)(e))return!1;const t=e.message;if(!t||t.length<=1||Object(zf.y)(t[0]))return!1;return t.every(zf.l)}},component:bA,transformData:FT},[HS.e.StickerSet]:{configs:{canReact:!1,messageQuickActionConfig:{canForward:!1},layoutType:HS.d.NoFrame},component:yA,transformData:kT},[HS.e.Text]:{configs:{hasDynamicBorder:!0},component:DA,transformData:NT},[HS.e.Undo]:{configs:{canReact:!1,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1},isEditable:e=>{var t;if("string"!=typeof e.message)return!1;return Date.now()-e.sendDttm<(null===(t=s("NDmK"))||void 0===t?void 0:t.default).time_enable_edit_undo_msg}},component:AA},[HS.e.Unknown]:{configs:{canReact:!1,canClick:!1,canDoubleClick:!1,canContextMenu:!1},component:FA},[HS.e.Video]:{configs:{layoutType:HS.d.NoFrame,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object($w.a)(e))}}},component:aF,transformData:BT},[HS.e.Voice]:{configs:{alwaysShowTimeOutSide:!0,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object($w.a)(e))}}},component:$F,transformData:GT},[HS.e.ZInstant]:{configs:{layoutType:HS.d.NoFrame,canReact:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:qF}},JF=s("uave");Object(ko.b)(JF.b)(QF=Object(i.injectable)()(QF=Reflect.metadata("design:type",Function)(QF=Reflect.metadata("design:paramtypes",[])(QF=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.messageContents=void 0,this.name=JF.a,this.key=JF.a,this.data=new Map,this.messageContents=new Map,this.setupMessageContents()}async onChangeMessages(e){const t=(new Date).getTime().toString();Object(hs.k)(t),e.forEach((e=>{e.msgId&&(this.data.set(e.msgId,e),Object(hs.g)(t,this.name,e.msgId))})),Object(hs.c)(t)}onRemoveMessages(e){e.forEach((e=>{this.data.delete(e)}))}getMessageAction(e,t){const s=this.messageContents.get(e);return s?s.configs?s:t?s[t]:null:null}getItem(e,t){return this.data.get(e.key)}setupMessageContents(){for(const[e,t]of Object.entries(ZF))this.messageContents.set(e,t)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||QF)||QF)||QF);var YF,XF=s("Vh8h"),ej=s("kEG/");function tj(){return"number"==typeof mi.default.async_forward.checked_url_cache_expiration_time?mi.default.async_forward.checked_url_cache_expiration_time:36e5}function sj(){return!mi.default.async_forward.disable_cache_check_exist}function ij(){return Sr.a.now()}var nj=Object(i.injectable)()(YF=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(YF=Reflect.metadata("design:type",Function)(YF=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(YF=class{constructor(e){this._checkedMap=new Map,this._currentCheckingRequestAmount=0,this._urlChangedMap=new Map,this._logger=void 0,this._isQueueExecuting=!1,this._queue=[],rt.p.listenEvent(rt.j,this.onNetworkChange.bind(this)),this.Logger=e.createZLogger("utils",["share-file-handler"])}check(e){return new Promise(((t,s)=>{sj()&&this.checkedMap.has(e)&&ij()-this.checkedMap.get(e)<tj()?(t(!0),this.executeQueue()):this.enqueueExecution(e,t,s)}))}getNewUrl(e){return this.urlChangedMap.get(e)||e}updateFileUrl(e,t){this.urlChangedMap.set(e,t),this.checkedMap.set(t,ij())}decreaseRequestAmount(){this._currentCheckingRequestAmount--}enqueueExecution(e,t,s,i=!0){this.executionQueue.push({url:e,resolve:t,reject:s,shouldRetry:i}),this.executeQueue()}executeQueue(){if(!this.isQueueExecuting()){for(this.setExecutionQueueWorking();this.getCurrentNetworkStatus()!==fu.a.DISCONNECT&&this.getCurrentRequestAmount()<=("number"==typeof mi.default.async_forward.maximum_requests_in_a_while?mi.default.async_forward.maximum_requests_in_a_while:5)&&this.executionQueue.length>0;){let e=this.executionQueue.shift();this.increaseRequestAmount(),this.processCheckingRequest(e).then((()=>{this.handleResponse(e,!0,null)})).catch((t=>{var s;this.handleResponse(e,!1,null===(s=t.data)||void 0===s?void 0:s.status)}))}this.setExecutionQueueFree()}}getCurrentNetworkStatus(){return fu.b.getStateNetwork()}getCurrentRequestAmount(){return this._currentCheckingRequestAmount}increaseRequestAmount(){this._currentCheckingRequestAmount++}isQueueExecuting(){return this._isQueueExecuting}onNetworkChange(){this.getCurrentNetworkStatus()===fu.a.CONNECTED&&(this.Logger.zsymb(21,"3klYDs",["network was connected, start executing check-exist queue","bTOCjA"]),this.executeQueue())}setExecutionQueueFree(){this._isQueueExecuting=!1}setExecutionQueueWorking(){this._isQueueExecuting=!0}handleResponse(e,t,s){this.decreaseRequestAmount(),t?(this.checkedMap.set(e.url,ij()),this.executeQueue()):s===ej.b.ClientError.RequestTimeout&&e.shouldRetry?this.enqueueExecution(e.url,e.resolve,e.reject,!1):(this.checkedMap.set(e.url,0),this.executeQueue()),e.resolve(t)}tryToLoadUrl(e){return new Promise(((t,s)=>{const i=91047;!function(e,t={}){const s=Date.now(),i=ij();let n=e.replace("http://","https://");n=ho.default.removeE2eeProtocol(n);const{onabort:a=null,onerror:r=null,onload:o=null,ontimeout:l=null,timeout:c=1e4}=t,d=new XMLHttpRequest;d.open("HEAD",n),d.responseType="arraybuffer",d.timeout=c,ji.l||d.setRequestHeader("Cache-Control","no-cache");const u=()=>({duration:ij()-i,startTime:s});d.onload=e=>{o&&o(e,u())},d.onerror=e=>{r&&r(e,u())},d.ontimeout=e=>{l&&l(e,u())},d.onabort&&(d.onabort=e=>{a&&a(e,u())}),d.send()}(e,{onabort:(e,t)=>{fi.default.increaseFailed(i,0,t.duration,4,t.startTime),s(e.target.status)},onerror:(e,t)=>{this.Logger.zsymb(21,"TuBa9C",["check-exist error: {}","IaSAlw"],e),fi.default.increaseFailed(i,0,t.duration,2,t.startTime),s(e.target.status)},onload:(e,n)=>{e.target.status>=400?(fi.default.increaseFailed(i,0,n.duration,3,n.startTime),s(e.target.status)):e.target.responseURL&&e.target.responseURL.indexOf("default")>=0?(fi.default.increaseFailed(i,0,n.duration,5,n.startTime),s(e.target.status)):(fi.default.increaseSuccess(i,0,n.duration),t(!0))},ontimeout:(e,t)=>{fi.default.increaseFailed(i,0,t.duration,1,t.startTime),s(e.target.status)}})}))}async processCheckingRequest(e){if(!e)return Promise.reject({message:"Invalid request item",data:null});const{url:t}=e;if(sj()&&this.checkedMap.has(t)){let e=this.checkedMap.get(t);if(ij()-e<tj())return Promise.resolve()}if(ji.l&&!ho.default.isConnectSrc(t))try{return await Object(XF.b)(t,"number"==typeof mi.default.async_forward.checking_url_timeout?mi.default.async_forward.checking_url_timeout:1e4),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:0}})}try{return await this.tryToLoadUrl(t),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:s}})}}get checkedMap(){return this._checkedMap}get executionQueue(){return this._queue}get urlChangedMap(){return this._urlChangedMap}get Logger(){return this._logger}set Logger(e){this._logger=e}})||YF)||YF)||YF)||YF,aj=s("vyPS");i.ModuleContainer.register(aj.a,nj);var rj=s("X2RP"),oj=s("rvru"),lj=s("Mk04"),cj=s("Yggq"),dj=s("HWGt");class uj extends dj.a{constructor(...e){super(...e),this.dbQos=null,this.signalOutOfMem=Object(lj.a)((()=>{rt.p.triggerEvent(rt.b,[!0,"zkey-out-mem"])})),this.signalInvalidVersion=Object(lj.a)((()=>{rt.p.triggerEvent(rt.b,[!0])})),this.signalMissingStores=Object(lj.a)((()=>{rt.p.triggerEvent(rt.b,[!0,"zkey-miss-object-store"])})),this.signalExceedingLimitInReopeningDBConnection=Object(lj.a)((()=>{rt.p.triggerEvent(rt.b,[!1])}))}getDBQos(){return null===this.dbQos&&(this.dbQos=i.ModuleContainer.resolve(oj.a)),this.dbQos}handleQueryError(e){this.getDBQos().sendDBErrorQos(e)}handleOutOfMemError(){this.signalOutOfMem()}handleInvalidVersionError(){this.signalInvalidVersion()}handleMissingStoreError(e){this.signalMissingStores();const t=this.getDBQos(),{database:s,missingTables:i}=e;t.sendMissingTableQos(s,i)}handleExceedingLimitInReopeningDBConnection(){this.signalExceedingLimitInReopeningDBConnection()}handleQueryExec(e){const{database:t,table:s,method:i,transaction:n,startTime:a,getEndTime:r}=e;cj.a.has(t)||r().then((e=>{const r={method:i,database:t,table:s,transaction:n};jr.default.recordInfo(jr.MetricName.query_resolution_time,{startAt:a,endAt:e,info:r})})).catch((e=>{}))}handleLongOpenDB(e){const{startTime:t,endTime:s,fullname:i}=e;this.getDBQos().sendLongOpenRequestQos(i,t,s-t)}handleTimeConsumingQuery(e,t){this.getDBQos().sendTimeConsumingQueryQos(e,t)}handleSuccessOpenDB(e){const{startTime:t,endTime:s,fullname:i}=e;this.getDBQos().sendSuccessOpenDBDurationQos(i,t,s-t),jr.default.recordInfo(jr.MetricName.db_ready,{startAt:t,endAt:s,info:{dbName:i}})}handleWarning(e){const t=this.getDBQos();if(e.type===rj.b.FAILED_MULTI)t.sendFailedMultiErrorQos(e)}handleSchemaMigratedAbnormally(e){const{fullname:t,actualVersion:s}=e.data;if(0===s&&t===Wa.a.baseConfig.name){i.ModuleContainer.resolve(ar.a).reset()}}}(new uj).start();var hj=s("GaKD"),gj=s("Y65e");const mj=i.ModuleContainer.resolve(at.b),pj=(e,t)=>(s,i,n)=>{const a=n.value;n.value=function(...s){const i=performance.now(),n=a.apply(this,s);if(n instanceof Promise)return Be.c.catchAsyncFn((()=>n)).then((([n,a])=>{const r=performance.now()-i,o=Object(f.a)({commandId:e,success:!n,errorCode:null==n?void 0:n.code,duration:r},null==t?void 0:t(s,[n,a],r));if(mj.log(o),n)throw n;return a}));{const a=performance.now()-i,r=Object(f.a)({commandId:e,success:!0,duration:a},null==t?void 0:t(s,[null,n],a));return mj.log(r),n}}};let fj=function(e){return e[e.CLIENT_PARSER=111026]="CLIENT_PARSER",e[e.SERVER_PARSER=111027]="SERVER_PARSER",e[e.NOOP_PARSER=111028]="NOOP_PARSER",e[e.DOWNLOAD_THUMB=111029]="DOWNLOAD_THUMB",e[e.UPLOAD_THUMB=111030]="UPLOAD_THUMB",e[e.PREVIEW_INTEGRITY=111031]="PREVIEW_INTEGRITY",e}({});var vj,bj,Ij,yj,_j;let Cj=(vj=pj(fj.NOOP_PARSER,(([e])=>({params:[e]}))),bj=Reflect.metadata("design:type",Function),Ij=Reflect.metadata("design:paramtypes",[String]),_j=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e){return!0}async parse(e){return null}},_j.instance=null,yj=_j,Object(gj.a)(yj.prototype,"parse",[vj,bj,Ij],Object.getOwnPropertyDescriptor(yj.prototype,"parse"),yj.prototype),yj);var Oj=s("G95d"),Ej=s("dXzg");let Mj=function(e){return e[e.UNKNOWN_ERROR=100]="UNKNOWN_ERROR",e[e.URL_ERROR=101]="URL_ERROR",e[e.HTTP_STATUS_ERROR=102]="HTTP_STATUS_ERROR",e[e.REDIRECT_ERROR=103]="REDIRECT_ERROR",e[e.PARSE_XML_HEAD_ERROR=104]="PARSE_XML_HEAD_ERROR",e[e.HTTP_REQUEST_ERROR=105]="HTTP_REQUEST_ERROR",e[e.EMPTY_METADATA=106]="EMPTY_METADATA",e[e.HTTP_TIMEOUT_REQUEST_ERROR=107]="HTTP_TIMEOUT_REQUEST_ERROR",e[e.HTTP_NOTFOUND_ERROR=108]="HTTP_NOTFOUND_ERROR",e[e.HTTP_CONNREFUSED_ERROR=109]="HTTP_CONNREFUSED_ERROR",e[e.HTTP_CONNRESET_ERROR=110]="HTTP_CONNRESET_ERROR",e[e.CLOUDFLARE_MITIGATED_ERROR=111]="CLOUDFLARE_MITIGATED_ERROR",e[e.PARSE_LINK_SERVER_ERROR=200]="PARSE_LINK_SERVER_ERROR",e[e.DOWNLOAD_THUMB_ERROR=300]="DOWNLOAD_THUMB_ERROR",e[e.THUMB_SIZE_ERROR=301]="THUMB_SIZE_ERROR",e[e.THUMB_TYPE_ERROR=302]="THUMB_TYPE_ERROR",e[e.WEBP_THUMB_TYPE_ERROR=303]="WEBP_THUMB_TYPE_ERROR",e[e.UPLOAD_THUMB_ERROR=400]="UPLOAD_THUMB_ERROR",e[e.COMPRESS_THUMB_ERROR=401]="COMPRESS_THUMB_ERROR",e[e.GET_PARSER_ERROR=500]="GET_PARSER_ERROR",e}({});const Sj=(e,t)=>{if(e)throw t};class Tj extends Error{constructor(e,t,s,i=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[...i,s],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="UnknownError",code:s=Mj.UNKNOWN_ERROR,message:i,stack:n,qosParams:a=[]}=e,r=new Tj(t,s,i);return r.qosParams=a,r.setStack(n),r}}class wj extends Tj{constructor(e,t,s){super("ParseLinkServerError",Mj.PARSE_LINK_SERVER_ERROR,`Parse link server failed. Url: ${e}. Message: ${t}`,s)}}const Rj=1048576,Lj={GB:1073741824,MB:Rj,KB:1024,byte:1};let Dj;var Aj;(Aj=Dj||(Dj={})).sizeInByte=e=>{const t=/(\d+)(byte|KB|MB|GB)/g;let s,i=0;for(;s=t.exec(e);)i+=parseInt(s[1])*Lj[s[2]];return i},Aj.getFileSizeByHead=async(e,t)=>{const s=await fetch(e,{method:"HEAD"}),i=s.headers.get("content-length"),n=s.headers.get("content-type");if(t&&t!=n)throw new Error(`An error occurred when trying to get file size. Error: unexpected content-type.Content-type expectation is "${t}" but received Content-type is "${n}".`);return Number(null!=i?i:0)};var Fj=function(e){return e[e.META_TITLE=0]="META_TITLE",e[e.META_DESCRIPTION=1]="META_DESCRIPTION",e[e.META_THUMB=2]="META_THUMB",e[e.DOCUMENT=3]="DOCUMENT",e}(Fj||{}),jj=function(e){return e[e.NOT_FOUND=0]="NOT_FOUND",e[e.INVALID_FORMAT=1]="INVALID_FORMAT",e[e.DOWNLOAD_ERROR=2]="DOWNLOAD_ERROR",e}(jj||{});class Pj{constructor(){}async fetch(e){const[t,s]=await Be.c.catchAsyncFn((()=>this.fetchLinkInfoFromServer(e)));Sj(!!t,t&&new wj(e,null==t?void 0:t.message));const[i,n]=await this.transformResponse(e,s);return Sj(!!i,i),n}fetchLinkInfoFromServer(e){return pu.default.getLinkInformation(e).then(gu.a)}async transformResponse(e,t){var s,n,a;if(i.ModuleContainer.resolve(Ej.a).get("enable_verify_parse_link_server")&&Be.g.isNotEmptyObject(t.error_maps))return[new wj(e,JSON.stringify(t.error_maps)),null];if((null===(s=t.error_maps)||void 0===s?void 0:s[Fj.DOCUMENT])===jj.DOWNLOAD_ERROR)return[new wj(e,JSON.stringify(t.error_maps)),null];if(e.endsWith(".pdf")){var r;const s=await Dj.getFileSizeByHead(e);return t.data=null!==(r=t.data)&&void 0!==r?r:{},t.data.title=jp.a.getFileNameFromUrl(e),t.data.desc=ho.default.sizeToString(s),t.data.thumb=ho.DEFAULT_THUMB_URLS.ICON_PDF,[null,t.data]}return t.data.thumb&&!((null===(n=t.error_maps)||void 0===n?void 0:n[Fj.META_THUMB])in jj)||t.data.thumb||t.data.title&&t.data.desc?((null===(a=t.error_maps)||void 0===a?void 0:a[Fj.META_THUMB])in jj&&(t.data.thumb=""),[null,t.data]):[new wj(e,JSON.stringify(t)),null]}}var kj,Nj,Uj,Bj,xj,Gj=s("o2mE"),zj=s("/vDv");let Vj=(kj=pj(fj.SERVER_PARSER,(([e],t,s)=>(i.ModuleContainer.resolve(Gj.b).linkParser.zsymb(12,"zkMsmV","ParseLinkMetric",fj[fj.SERVER_PARSER],e,s),{params:[e]}))),Nj=Reflect.metadata("design:type",Function),Uj=Reflect.metadata("design:paramtypes",[String]),(xj=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){const s=i.ModuleContainer.resolve(Ej.a);if(s.get("enable_force_parse_link_server"))return!0;if(!s.get("enable_parse_link_server"))return!1;const n=s.get("white_list_domain");for(const i of n)if(jp.a.isHrefMatchDomain(e,i))return!0;if((null==t?void 0:t.entry)===Oj.a.MESSAGE_WIDGET)return!0;if(!s.get("enable_parse_link_client")){if(null!=t&&t.convId){if(!zj.a.isE2eeConv(t.convId))return!0}if((null==t?void 0:t.entry)===Oj.a.SHARE_MESSAGE)return!0}return!1}async parse(e){const[t,s]=await Be.c.catchAsyncFn((()=>(new Pj).fetch(e)));return Sj(!!t,t),{typeParse:Oj.b.SERVER,href:e,desc:null==s?void 0:s.desc,media:null==s?void 0:s.media,src:null==s?void 0:s.src,stream_icon:null==s?void 0:s.stream_icon,thumb:null==s?void 0:s.thumb,title:null==s?void 0:s.title}}}).instance=null,Bj=xj,Object(gj.a)(Bj.prototype,"parse",[kj,Nj,Uj],Object.getOwnPropertyDescriptor(Bj.prototype,"parse"),Bj.prototype),Bj);var Hj;Object(i.injectable)()(Hj=Object(i.singleton)(hj.a)(Hj=Reflect.metadata("design:type",Function)(Hj=Reflect.metadata("design:paramtypes",[])(Hj=class{constructor(){}getLinkParser(e,t){return Vj.getInstance().isMatchParser(e,t)?Vj.getInstance():Cj.getInstance()}})||Hj)||Hj)||Hj);var Wj,$j=s("TQME");class Kj{constructor(){}static getInstance(){return Kj.instance||(Kj.instance=new Kj),Kj.instance}async process(e){return e}}Kj.instance=null;class qj{constructor(){}static getInstance(){return qj.instance||(qj.instance=new qj),qj.instance}async process(e){return e}}qj.instance=null;Object(i.injectable)()(Wj=Object(i.singleton)($j.a)(Wj=Reflect.metadata("design:type",Function)(Wj=Reflect.metadata("design:paramtypes",[])(Wj=class{constructor(){}getDownloadProcessor(e){switch(e){case Oj.b.CLIENT:case Oj.b.SERVER:}return qj.getInstance()}getUploadProcessor(e){switch(e){case Oj.b.CLIENT:case Oj.b.SERVER:}return Kj.getInstance()}})||Wj)||Wj)||Wj);const Qj=Object(i.define)("parser-config-event-emitter");var Zj;i.ModuleContainer.registerFactory(Qj,td.f((()=>new qg.a)));Object(i.injectable)()(Zj=Object(i.singleton)(Ej.b)(Zj=function(e,t){return Object(i.inject)(Qj)(e,void 0,0)}(Zj=Reflect.metadata("design:type",Function)(Zj=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigEventEmitter?Object:IParserConfigEventEmitter])(Zj=class{constructor(e){this.eventEmitter=e,this.config={}}setConfig(e){this.isConfigChange(e)&&(this.config=this.mergeConfig(e),this.eventEmitter.emit("on-config-change",this.config))}mergeConfig(e){return Object(f.a)(Object(f.a)({},this.config),e)}isConfigChange(e){return!new Be.g.Comparer(this.config,e,!0).AND("enable_force_parse_link_server").AND("enable_parse_link_server").AND("enable_parse_link_client").AND("enable_auto_download_thumb").AND("enable_parse_link_receiver").AND("enable_parse_link_sender").AND("enable_upload_thumb_for_delay_send").AND("enable_download_partial_media_e2ee").AND("enable_verify_parse_link_server").AND("enable_show_loading_thumb").AND("white_list_domain",BC.a.isEqual).AND("white_list_domain_mode").AND("max_time_reparse").AND("max_thumb_size").AND("max_age_cache_preview").AND("max_item_cache").AND("max_url_character").AND("max_title_character").AND("max_desc_character").AND("max_delay_send_message").AND("max_redirect").AND("debug",BC.a.isEqual).exec()}})||Zj)||Zj)||Zj)||Zj);var Jj,Yj=s("1e0e");const Xj={enable_force_parse_link_server:!0,enable_parse_link_server:!0,enable_parse_link_client:!1,enable_auto_download_thumb:!0,enable_parse_link_receiver:!0,enable_parse_link_sender:!1,enable_upload_thumb_for_delay_send:!1,enable_download_partial_media_e2ee:!0,enable_verify_parse_link_server:!1,enable_show_loading_thumb:!0,white_list_domain:[".zalo.me",".zaloapp.com","s120.avatar.talk.zdn.vn","cover.talk.zdn.vn","qr.talk.zdn.vn","f22.w640.photo.talk.zdn.vn","res-zalo.zadn.vn","vng.com.vn","stg-shop.zalo.me",".zingplay.me","zalopay.vn","kaka.me","api-internal.mp3.zalo","zstudio.io","123c.vn","adtimaserver.vn","adtima.vn","ad.zing.vn","baomoi.com","baomoi.vn","brand.zing.vn","chat-talk.zing.vn","click.123.vn","epi.com.vn","epi.vn","kakaapp.me","laban.vn","lab.zing.vn","mp3.zing.vn","m.zing.vn","news.zing.vn","nhatkyzalo.vn","playzing.vn","plo.com.vn","plo.vn","stc-tv.zing.vn","sukien.net.vn","tachthongtin.com","talk.zing.vn","trithuctructuyen.com.vn","trithuctructuyen.vn","tv.zing.vn","xdn.vn","xone.fm","zagoo.vn","zalo.ai","zalo.careers","zalochat.com","zalo.cx","zalo.gg","zalo.me","zalomusic.com","zalonews.net","zaloplus.vn","zalo-shop.vn","zalo.vn","zamoji.vn","zapps.vn","zavatar.vn","zavi.me","za.zdvn.vn","zdn.vn","zingmp3.com","zingmp3.vn","zingnews.com.vn","zingnews.vn","zingtv.vn","zstudio.io","zaloshop.me","dr.zapps.vn","hc.zalo.me"],white_list_domain_mode:"append",max_time_reparse:Yj.a.timeInMs("24h"),max_thumb_size:Dj.sizeInByte("2MB"),max_age_cache_preview:Yj.a.timeInMs("24h"),max_item_cache:300,max_url_character:500,max_title_character:80,max_desc_character:200,max_delay_send_message:Yj.a.timeInMs("2s"),max_redirect:2,debug:{enable_log_metric:!1,delay_parse_client:Yj.a.timeInMs("0s")}};Object(i.injectable)()(Jj=Object(i.singleton)(Ej.a)(Jj=Reflect.metadata("design:type",Function)(Jj=Reflect.metadata("design:paramtypes",[])(Jj=class{constructor(){this.config=void 0,this.configValidator=void 0,this.config=Xj,this.configValidator=new _i.a({enable_force_parse_link_server:_i.b.field().boolean(),enable_parse_link_server:_i.b.field().boolean(),enable_parse_link_client:_i.b.field().boolean(),enable_auto_download_thumb:_i.b.field().boolean(),enable_parse_link_receiver:_i.b.field().boolean(),enable_parse_link_sender:_i.b.field().boolean(),enable_download_partial_media_e2ee:_i.b.field().boolean(),enable_verify_parse_link_server:_i.b.field().boolean(),enable_show_loading_thumb:_i.b.field().boolean(),white_list_domain:_i.b.field().array("string"),white_list_domain_mode:_i.b.field().string().oneOf(["append","override"]),max_time_reparse:_i.b.field().number().min(0),max_thumb_size:_i.b.field().number().min(0),max_age_cache_preview:_i.b.field().number().min(0),max_item_cache:_i.b.field().number().min(0),max_url_character:_i.b.field().number().min(0),max_title_character:_i.b.field().number().min(0),max_desc_character:_i.b.field().number().min(0),max_delay_send_message:_i.b.field().number().min(0),max_redirect:_i.b.field().number().min(0),debug:_i.b.field().object({enable_log_metric:_i.b.field().boolean(),delay_parse_client:_i.b.field().number()})})}get(e,t){var s;return null!==(s=this.config[e])&&void 0!==s?s:t}setConfig(e){const t=this.configValidator.validateWithFallback(e,Xj);this.config=Object(f.a)(Object(f.a)(Object(f.a)({},this.config),t),this.mergeWhiteListDomainConfig(t))}mergeWhiteListDomainConfig(e){const t=e.white_list_domain_mode,s=e.white_list_domain,i=this.config.white_list_domain;switch(t){case"append":default:return{white_list_domain:i.concat(s)};case"override":return{white_list_domain:s}}}})||Jj)||Jj)||Jj);i.ModuleContainer.resolve(Qj).on("on-config-change",(e=>{i.ModuleContainer.resolve(Ej.a).setConfig(e)}));class eP{constructor(e){this.maxAge=e,this.mapTsItemIsSet=void 0,this.mapTsItemIsSet=new Map}hookBeforeGet(e,t){const s=this.mapTsItemIsSet.get(e);if(!s)return;Date.now()-s>=this.maxAge&&t(e)}hookAfterSet(e){this.mapTsItemIsSet.set(e,Date.now())}hookAfterDelete(e){this.mapTsItemIsSet.delete(e)}hookAfterClear(){this.mapTsItemIsSet.clear()}}class tP{constructor(e){this.maxItem=e,this.mapTsItemIsVisited=void 0,this.mapTsItemIsVisited=new Map}hookBeforeGet(e){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()})}hookAfterSet(e,t){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()});let s=Math.max(this.mapTsItemIsVisited.size-this.maxItem,0);if(s>0){Array.from(this.mapTsItemIsVisited.values()).sort(((e,t)=>t.ts>e.ts?-1:0)).slice(0,s).forEach((e=>t(e.key)))}}hookAfterDelete(e){this.mapTsItemIsVisited.delete(e)}hookAfterClear(){this.mapTsItemIsVisited.clear()}}class sP{constructor(...e){this.strategies=void 0,this.repository=void 0,this.repositoryDeadItem=void 0,this.markDeadItem=e=>{const t=this.repository.get(e);t&&(t.isAlive=!1,this.repositoryDeadItem.push(e))},this.strategies=e,this.repository=new Map,this.repositoryDeadItem=[]}get(e){this.beforeGet(e);const t=this.repository.get(e);return t&&t.isAlive?t.value:null}set(e,t){const s={isAlive:!0,key:e,value:t};this.repository.set(e,s),this.afterSet(e)}delete(e){this.repository.delete(e),this.afterDelete(e)}reset(){this.repository.clear(),this.afterClear()}beforeGet(e){this.strategies.forEach((t=>t.hookBeforeGet(e,this.markDeadItem))),this.doGC()}afterSet(e){this.strategies.forEach((t=>t.hookAfterSet(e,this.markDeadItem))),this.doGC()}afterDelete(e){this.strategies.forEach((t=>t.hookAfterDelete(e)))}afterClear(){this.strategies.forEach((e=>e.hookAfterClear()))}doGC(){this.repositoryDeadItem.length&&(this.repositoryDeadItem.forEach((e=>this.delete(e))),this.repositoryDeadItem=[])}}var iP;Object(i.injectable)()(iP=Object(i.singleton)(hj.c)(iP=function(e,t){return Object(i.inject)(Ej.a)(e,void 0,0)}(iP=Reflect.metadata("design:type",Function)(iP=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigConsumer?Object:IParserConfigConsumer])(iP=class{constructor(e){this.metaData=void 0,this.thumbLocal=void 0,this.thumbLive=void 0;const t=e.get("max_item_cache"),s=e.get("max_age_cache_preview");this.metaData=new sP(new tP(t),new eP(s)),this.thumbLocal=new sP(new tP(t),new eP(s)),this.thumbLive=new sP(new tP(t),new eP(s))}getKey(e,t){switch(e){case"meta-data":case"thumb-local":{const[e]=t;return jp.a.removeProtocol(e)}case"thumb-live":{const[e,s=""]=t;return[zj.a.getPrefixConv(s),zj.a.isE2eeConv(s)?"e2ee":"none-e2ee",jp.a.removeProtocol(e)].join("_")}default:return t.join(".")}}})||iP)||iP)||iP)||iP);var nP,aP=s("WOja");Object(i.injectable)()(nP=Object(i.singleton)(hj.b)(nP=function(e,t){return Object(i.inject)(Gj.b)(e,void 0,0)}(nP=function(e,t){return Object(i.inject)(hj.c)(e,void 0,1)}(nP=function(e,t){return Object(i.inject)(hj.a)(e,void 0,2)}(nP=function(e,t){return Object(i.inject)(Ej.a)(e,void 0,3)}(nP=Reflect.metadata("design:type",Function)(nP=Reflect.metadata("design:paramtypes",[void 0===Gj.IParserLogger?Object:Gj.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof ILinkParserFactory?Object:ILinkParserFactory,void 0===aP.IParserConfigConsumer?Object:aP.IParserConfigConsumer])(nP=class{constructor(e,t,s,i){this.repository=t,this.linkParserFactory=s,this.config=i,this.logger=void 0,this.logger=e.linkParser}parse(e){var t;const s=this.repository.getKey("meta-data",[e]);return(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.value)||null}async preparseAsync(e,t){await this.parseAsync(e,t)}async parseAsync(e,t){if(!this.config.get("enable_parse_link_client")){const e=(null==t?void 0:t.entry)!==Oj.a.SHARE_MESSAGE,s=zj.a.isE2eeConv((null==t?void 0:t.convId)||"");if(e&&s)return null}const s=this.repository.getKey("meta-data",[e]),i=this.repository.metaData.get(s);if(i&&null!==i.value)return i.promise;const n=new Be.c.Container;this.repository.metaData.set(s,n);const[a,r]=await Be.c.catchAsyncFn((()=>this.linkParserFactory.getLinkParser(e,t).parse(e)));return a&&this.logger.zsymb(18,"OEPWh6",`parse link failed ${a}`),n.resolve(r),n.promise}})||nP)||nP)||nP)||nP)||nP)||nP)||nP);var rP;Object(i.injectable)()(rP=Object(i.singleton)($j.b)(rP=function(e,t){return Object(i.inject)(Gj.b)(e,void 0,0)}(rP=function(e,t){return Object(i.inject)(hj.c)(e,void 0,1)}(rP=function(e,t){return Object(i.inject)($j.a)(e,void 0,2)}(rP=Reflect.metadata("design:type",Function)(rP=Reflect.metadata("design:paramtypes",[void 0===Gj.IParserLogger?Object:Gj.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof IPreviewLinkProcessorFactory?Object:IPreviewLinkProcessorFactory])(rP=class{constructor(e,t,s){this.repository=t,this.linkProcessorFactory=s,this.logger=void 0,this.logger=e.linkParser}async processDownload(e){var t;const s=this.repository.getKey("meta-data",[e]),i=this.repository.getKey("thumb-local",[e]),n=this.repository.thumbLocal.get(i);if(n&&null!==n.value){if(!n.value)return n.promise;{const e=n.value.thumbLocal;if(e){const[t,s]=await Be.c.catchAsyncFn((()=>{var t,s;return null===(t=$znode)||void 0===t||null===(s=t.fsPromise)||void 0===s?void 0:s.stat(e)}));if(!t&&s)return n.promise}}}const a=new Be.c.Container;this.repository.thumbLocal.set(i,a);const r=await(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.promise)||null,o=await this.linkProcessorFactory.getDownloadProcessor(null==r?void 0:r.typeParse).process(r);return a.resolve(o),a.promise}async processUpload(e,t){var s;const i=this.repository.getKey("thumb-local",[e]),n=this.repository.getKey("thumb-live",[e,t]),a=this.repository.thumbLive.get(n);if(a&&null!==a.value)return a.promise;const r=new Be.c.Container;this.repository.thumbLive.set(n,r);const o=await(null===(s=this.repository.thumbLocal.get(i))||void 0===s?void 0:s.promise)||null,l=await this.linkProcessorFactory.getUploadProcessor(null==o?void 0:o.typeParse).process(o,t);return r.resolve(l),r.promise}})||rP)||rP)||rP)||rP)||rP)||rP);class oP{constructor(){}async getDimension(e){const t={key:Date.now(),file:e,srcAction:3},[s,i]=await Be.c.catchAsyncFn((()=>sp.default.getDimension(t)));return Sj(s,s&&this.transformError(s)),this.transformResponse(i)}transformError(e){return e}transformResponse(e){return{width:e.width,height:e.height,rotation:e.orientation}}}var lP=s("8I6r"),cP=s("oSk7"),dP=s("taJj");class uP{constructor(){}async download(e){const[t,s]=ho.default.parseE2eeProtocol(e),n=new Headers;if(t){let e="unsafe-flush";i.ModuleContainer.resolve(Ej.a).get("enable_download_partial_media_e2ee")&&(n.set("Range",`bytes=0-${Dj.sizeInByte("64KB")}`),e="safe-flush");const[a,r]=await Be.c.catchAsyncFn((()=>fetch(s,{headers:n})));Sj(a,a);const o=new cP.a(r.body).pipe(new dP.a(Dj.sizeInByte("1MB"))).pipe(new hP(new lP.b(t,"decrypt"),e)).getStream();return await new Response(o,{headers:r.headers}).blob()}n.set("Range",`bytes=0-${Dj.sizeInByte("64KB")}`);const[a,r]=await Be.c.catchAsyncFn((()=>fetch(e,{headers:n})));return Sj(a,a),await r.blob()}}class hP{constructor(e,t){this.zaes=e,this.modeFlush=t,this.transform=(e,t)=>{const s=this.zaes.update(e);t.enqueue(s)},this.flush=e=>{if("safe-flush"!==this.modeFlush)try{this.zaes.end()}catch(t){e.error(t)}}}}const gP={"image/gif":R.IMAGE_TYPE_GIF,"image/jpg":R.IMAGE_TYPE_JPEG,"image/jpeg":R.IMAGE_TYPE_JPEG,"image/png":R.IMAGE_TYPE_PNG};class mP{constructor(){}static getInstance(){return mP.instance||(mP.instance=new mP),mP.instance}isMatchParser(e){return Object.keys(gP).includes(e)}async parse(e){const[t,s]=await Be.c.catchAsyncFn((()=>(new uP).download(e)));Sj(t,t);const[i,n]=await Be.c.catchAsyncFn((()=>(new oP).getDimension(s)));return Sj(i,i),Object(f.a)(Object(f.a)({},n),{},{type:this.transformType(s)})}transformType(e){return gP[e.type]}}mP.instance=null;class pP{constructor(){}static getInstance(){return pP.instance||(pP.instance=new pP),pP.instance}isMatchParser(e){return!0}async parse(e){return null}}pP.instance=null;const fP={"application/pdf":R.LINK_TYPE_PDF};class vP{constructor(){}static getInstance(){return vP.instance||(vP.instance=new vP),vP.instance}isMatchParser(e){return Object.keys(fP).includes(e)}async parse(e){try{const t=ho.default.removeE2eeProtocol(e),s=(await fetch(t,{method:"HEAD"})).headers.get("content-length");return null===s?null:{size:Number(s),name:jp.a.getFileNameFromUrl(e),type:fP["application/pdf"]}}catch(t){throw t}}}var bP;vP.instance=null;Object(i.singleton)(hj.d)(bP=class{async getSizeParser(e){const[t,s]=await Be.c.catchAsyncFn((()=>this.tryGetContentType(e)));return t||!s?pP.getInstance():mP.getInstance().isMatchParser(s)?mP.getInstance():vP.getInstance().isMatchParser(s)?vP.getInstance():pP.getInstance()}async tryGetContentType(e){if(!jp.a.isBlobUrl(e)){const[t,s]=await Be.c.catchAsyncFn((()=>this.tryGetContentTypeByHead(e)));if(!t)return s}return this.tryGetContentTypeByGet(e)}async tryGetContentTypeByHead(e){const t=ho.default.removeE2eeProtocol(e);return(await fetch(t,{method:"HEAD"})).headers.get("content-type")}async tryGetContentTypeByGet(e){const t=ho.default.removeE2eeProtocol(e),s=new AbortController,i=await fetch(t,{signal:s.signal});s.abort();return i.headers.get("content-type")}});var IP;Object(i.injectable)()(IP=Object(i.singleton)(hj.e)(IP=function(e,t){return Object(i.inject)(Gj.b)(e,void 0,0)}(IP=function(e,t){return Object(i.inject)(hj.d)(e,void 0,1)}(IP=Reflect.metadata("design:type",Function)(IP=Reflect.metadata("design:paramtypes",[void 0===Gj.IParserLogger?Object:Gj.IParserLogger,"undefined"==typeof ISizeParserFactory?Object:ISizeParserFactory])(IP=class{constructor(e,t){this.sizeParserFactory=t,this.cache=void 0,this.cacheDedupe=void 0,this.logger=void 0,this.cache=new sP(new tP(300)),this.logger=e.mediaSizeLogger,this.cacheDedupe=new Map}parse(e){const t=this.getCacheKey(e);return this.cache.get(t)}async preparseAsync(e){await Be.c.catchAsyncFn((()=>this.parseAsync(e)))}async parseAsync(e){const t=this.getCacheKey(e),s=this.cache.get(t);if(s)return s;const i=this.cacheDedupe.get(t);if(i)return i;const n=(await this.sizeParserFactory.getSizeParser(e)).parse(e);this.cacheDedupe.set(t,n);const[a,r]=await Be.c.catchAsyncFn((()=>n));return this.cacheDedupe.delete(t),Sj(null!==a,a),null===r?null:(this.cache.set(t,r),r)}getCacheKey(e){return e}})||IP)||IP)||IP)||IP)||IP);var yP,_P=s("2fgy"),CP=s("dG4g"),OP=s("DBGg"),EP=s("bGlS");Object(ko.b)(_P.b)(yP=Object(i.injectable)()(yP=Reflect.metadata("design:type",Function)(yP=Reflect.metadata("design:paramtypes",[])(yP=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.currentConvId=void 0,this.name=_P.a,this.key=_P.a,this.data={list:new Vc.a(Object(uL.a)().MAX_CONVERSATION_QUEUE_SIZE),photoViewData:void 0}}initialize(){}destroy(){}async onChangeMessages(e,t,s,i){this.currentConvId=e;const n={};t.forEach((e=>{let t=Jo.default.isGroupPhoto(e);Object(CP.b)(e)&&(n[e.msgId]=t&&VS.a.getInstance().getGroupId(null!=i?i:"1",Object(WS.h)(e))||"")})),await this.getDataFromCache(n,s)}onChangeReactionDataList(e,t,s){const i=(new Date).getTime(),n=i.toString();Object(hs.k)(n),e.forEach(((e,a)=>{var r,o,l;const c=null===(r=this.getCurrentDataOfConversation())||void 0===r?void 0:r.get(a);if((null===(o=this.data.photoViewData)||void 0===o?void 0:o.rMsgId)===a&&(this.data.photoViewData=Object(f.a)(Object(f.a)({},this.data.photoViewData),e),Object(hs.g)(n,this.name,EP.a)),!s&&!c)return;const d=Object.keys((null==c?void 0:c.reactions)||{}).length>Object.keys((null==e?void 0:e.reactions)||{}).length,u=!t||Object(OP.a)(e.reactions)||d?0:i,h=Object(f.a)(Object(f.a)(Object(f.a)({},c),e),{},{lastUpdateEffects:u});null===(l=this.getCurrentDataOfConversation())||void 0===l||l.set(a,h);const g=null==h?void 0:h.groupPhotoMsgId;var m;g?(null===(m=this.getCurrentDataOfConversation())||void 0===m||m.set(g,{isGroupPhotoMsg:!0,groupPhotoMsgId:g,lastUpdate:i,lastUpdateEffects:u}),Object(hs.g)(n,this.name,g),Object(hs.g)(n,this.name,a)):Object(hs.g)(n,this.name,a)})),Object(hs.c)(n)}getReactedListFromMessage(e,t){if(t){if(!e.msgId||!this.data.photoViewData)return{};const t=new Map;return t.set(e.msgId,this.data.photoViewData),Object(CP.d)(e,t)}return Object(CP.d)(e,this.getCurrentDataOfConversation())}removeReactionDataFromList(e){var t,s;if(!e.msgId)return;const i=null===(t=this.getCurrentDataOfConversation())||void 0===t?void 0:t.get(e.msgId);var n;null!=i&&i.isGroupPhotoMsg&&(null===(n=this.getCurrentDataOfConversation())||void 0===n||n.forEach(((t,s)=>{var i;t.groupPhotoMsgId===e.msgId&&(null===(i=this.getCurrentDataOfConversation())||void 0===i||i.delete(s))})));null===(s=this.getCurrentDataOfConversation())||void 0===s||s.delete(e.msgId)}async onChangePhotoViewData(e){if(!e.msgId)return;const t=[e.msgId],s=await Ud.b.get(t);s&&(this.data.photoViewData=s[e.msgId],Object(hs.h)(this.name,EP.a))}removePhotoViewData(){this.data.photoViewData=void 0}async resyncReactionData(){}async getDataFromCache(e,t){const s=Object.keys(e),i=await Ud.b.get(s);if(!i)return;const n=new Map;for(const a in i)n.set(a,Object(f.a)(Object(f.a)({},i[a]),{},{groupPhotoMsgId:e[a]}));this.onChangeReactionDataList(n,!1,!0),null==t||t(Object.keys(i))}getCurrentDataOfConversation(){if(this.currentConvId)return this.data.list.get(this.currentConvId)||this.data.list.push(this.currentConvId,new Map),this.data.list.get(this.currentConvId)}clearData(e){this.data.list.delete(e)}clearAllData(){this.data.list.clearAll(),this.data.photoViewData=void 0}getData(e){var t;return null===(t=this.getCurrentDataOfConversation())||void 0===t?void 0:t.get(e)}getLastUpdateEffects(e,t){var s;return null===(s=this.getData(t||e))||void 0===s?void 0:s.lastUpdateEffects}setLastUpdateEffects(e,t){const s=this.getData(t||e);var i;s&&(null===(i=this.getCurrentDataOfConversation())||void 0===i||i.set(t||e,Object(f.a)(Object(f.a)({},s),{},{lastUpdateEffects:0})))}getItem(e,t){var s;return e.key===EP.a?this.data.photoViewData:null===(s=this.getCurrentDataOfConversation())||void 0===s?void 0:s.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||yP)||yP)||yP);var MP,SP=s("VhZi");function TP(e){return e||EP.b.windowId}Object(ko.b)(SP.b)(MP=Object(i.injectable)()(MP=Object(i.singleton)()(MP=Reflect.metadata("design:type",Function)(MP=Reflect.metadata("design:paramtypes",[])(MP=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=SP.a,this.key=SP.a}initialize(e){const t=TP(e);ss.ModalManagerV2.addModal({windowId:t,name:EP.b.name,altWindowId:void 0}),ss.ModalManagerV2.subscribeTriggers({windowId:t,name:EP.b.name,trigger:e=>{}}),this.data.set(t,{message:void 0})}destroy(e){const t=TP(e);this.data.delete(t),ss.ModalManagerV2.delModal({windowId:t,name:EP.b.name})}toggleReactionPopup(e,t){const s=TP(e);this.data.set(s,{message:t}),t?ss.ModalManagerV2.openModal(Object(f.a)(Object(f.a)({},EP.b),{},{windowId:s,params:null})):ss.ModalManagerV2.closeModal(Object(f.a)(Object(f.a)({},EP.b),{},{windowId:s})),Object(hs.h)(this.name,s)}getItem(e,t){return this.data.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||MP)||MP)||MP)||MP);var wP=s("NmZm"),RP=s("66W5"),LP=s("xU41");var DP;Object(i.injectable)()(DP=Object(i.singleton)()(DP=Object(ko.b)(wP.b)(DP=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(DP=Reflect.metadata("design:type",Function)(DP=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(DP=class{constructor(e){this.type=void 0,this.key=RP.c,this.name=wP.a,this._chatBoxInputDOMMap=new Map,this._chatBoxInputStateMap=new Map,this._logger=void 0,this._logger=e.createZLogger(Ve.ZLoggerNametags.cbiController,[Ve.ZLoggerNametags.controllCbi])}init(){}getItem(e,t){if((s=e.key)&&s.startsWith(RP.c))return this._getChatBoxInputState(e.key);var s}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"zFku-G",["[onGetItemFailure] key: {}, error: {}","-vkCD8"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"Rql3qs",["[onGetListFailure] key: {}, error: {}","8kfggI"],e,t.message)}setChatInputType(e,t,s,i=!0){if(!e||!t)return this._logger.zsymb(21,"15Tgzg",["[setChatInputType] {} or {} isn't valid!","qeQ6eT"],e,t);if(!s)return this._logger.zsymb(21,"fCLP2o",["[setChatInputType] chatInputType isn't existed!","nobFOw"]);let n=this._getChatBoxInputState(Object(LP.a)(e,t));const a=Object(kg.a)(n,(e=>{e.chatInputType=Object(f.a)({},s)}));this._chatBoxInputStateMap.set(Object(LP.a)(e,t),a),i&&a!==n&&Object(hs.h)(this.name,Object(LP.a)(e,t))}getChatInputType(e,t){return this._getChatBoxInputState(Object(LP.a)(e,t)).chatInputType}getDefaultChatInputType(){return{name:RP.g.NORMAL,info:{}}}getChatInputTypeInfo(e,t){return this._getChatBoxInputState(Object(LP.a)(e,t)).chatInputType.info}getChatInputTypeName(e,t){return this._getChatBoxInputState(Object(LP.a)(e,t)).chatInputType.name}bindChatInputScroller(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputScroller=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatInputContent(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputContent=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatBoxInputContainer(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatBoxInputContainer=t,this._chatBoxInputDOMMap.set(e,s)}}getChatInputScroller(e,t){if(e){var s;return null!==(s=this._getChatBoxInputDOM(e).chatInputScroller)&&void 0!==s?s:null==t?void 0:t.document.getElementById(RP.f)}return null}getChatInputContent(e){if(e){return this._getChatBoxInputDOM(e).chatInputContent}return null}getChatBoxInputContainer(e){if(e){return this._getChatBoxInputDOM(e).chatBoxInputContainer}return null}_getChatBoxInputState(e){let t=this._chatBoxInputStateMap.get(e);return t||(t=this._getDefaultChatBoxInputState(),this._chatBoxInputStateMap.set(e,t)),t}_getDefaultChatBoxInputState(){return{chatInputType:this.getDefaultChatInputType()}}_getChatBoxInputDOM(e){let t=this._chatBoxInputDOMMap.get(e);return t||(t=this._getDefaultChatBoxInputDOM(),this._chatBoxInputDOMMap.set(e,t)),t}_getDefaultChatBoxInputDOM(){return{chatBoxInputContainer:null,chatInputScroller:null,chatInputContent:null}}})||DP)||DP)||DP)||DP)||DP);var AP=s("/ApO"),FP=s("DIKB"),jP=s("/wiu"),PP=s("WJhq");function kP(e,t){var s,i;const n=null!==(s=t.duration)&&void 0!==s?s:0,a=null!==(i=t.easing)&&void 0!==i?i:"ease",r=t.animId;return e.animate([{height:t.fromHeight},{height:t.toHeight}],{id:r,duration:n,fill:t.fill,easing:a})}var NP=s("gn4y");let UP=function(e){return e.NORMAL_TO_RTF="normal-to-rtf",e.RTF_TO_NORMAL="rtf-to-normal",e.MINI_TO_EXPAND="mini-to-expand",e.EXPAND_TO_MINI="expand-to-mini",e.RESIZE_WHEN_WINDOW_RESIZE="resize-when-window-resize",e.FADE_IN_RTF_TOOLBAR="fade-in-rtf-toolbar",e.FADE_OUT_RTF_TOOLBAR="fade-out-rtf-toolbar",e}({});var BP,xP=s("dZd7");const GP=new xi.a(0);Object(i.injectable)()(BP=Object(i.singleton)(AP.a)(BP=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(BP=Reflect.metadata("design:type",Function)(BP=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(BP=class{constructor(e){this._chatBoxInputAnimsMap=new Map,this._logger=void 0,this._isDevelopment=void 0,this._logger=e.createZLogger(Ve.ZLoggerNametags.cbiAnimationController,[Ve.ZLoggerNametags.manageCBIAnimation]),this._isDevelopment=!1}applyChatInputType(e,t,s){this._isDevelopment&&this._logger.zsymb(0,"bkwAgZ","(@=@)! >>>applyChatInputType<<<");const{windowId:i,convId:n,selfWindow:a,hasAnim:r}=s;if(this._isDevelopment&&this._logger.zsymb(3,"2_2_0u",["from: {} to: {}","PkZTih"],JSON.stringify(e),JSON.stringify(t)),jP.e(e,t)){if(jP.d(t))return this.switchNormalModeToRTFMode(i,n,a,r);if(jP.c(t))return this.switchRTFModeToNormalMode(i,n,a,r)}else if(jP.c(e)&&jP.d(t)){if(t.info.mode===RP.h.MINI)return this.switchNormalModeToRTFMode(i,n,a,r);t.info.mode,RP.h.EXPAND}else{if(jP.d(e)&&jP.c(t))return this.switchRTFModeToNormalMode(i,n,a,r);if(jP.d(e)&&jP.d(t)){if(e.info.mode===RP.h.EXPAND&&t.info.mode===RP.h.MINI)return this.switchExpandModeToMiniModeInRTFMode(i,n,a,r);if(e.info.mode===RP.h.MINI&&t.info.mode===RP.h.EXPAND)return this.switchMiniModeToExpandModeInRTFMode(i,n,a,r)}}this._isDevelopment&&this._logger.zsymb(3,"fcpFk6",["Do not support this case!","DYYMcF"])}switchNormalModeToRTFMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"wVj4UV","(@=@)! >>>switchNormalModeToRTFMode<<<"),!e||!t)return;const n=null!=s?s:zl.default.getWindow(e);if(!Object(NP.a)(!!n,"window isn't existed."))return;const a=this._getChatInputContainerEl(n);if(!Object(NP.a)(!!a,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(n);if(!Object(NP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=()=>{a.classList.add("--rtf-mode","--rtf-mini-mode"),r.classList.add("--visible"),this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.RTF,info:{mode:RP.h.MINI}})};if(this._cancelAllAnimation(e,!0),!i)return o();const l=a.clientHeight,c=Math.round(2*PP.c.PADDING_TOP_BOTTOM+5.5*PP.e+PP.g+PP.b);this._isDevelopment&&this._logger.zsymb(3,"nBQjZ9",["heights: {} {}","I-ZFcK"],l,c);let d=this._getTransitionDuration(c,l);if(this._isDevelopment&&this._logger.zsymb(3,"G2aMd2",["duration: {}","8t2FXa"],d),d>0){const s=this._getChatInputContentEl(n);if(!Object(NP.a)(!!s,"chatInputContentEl isn't existed."))return;const i=s.clientHeight/PP.e>=2;i||a.classList.add("--animate-from-smallest-height"),a.classList.add("--rtf-mode");const o=kP(a,{animId:`${UP.NORMAL_TO_RTF}::${GP.next()}`,duration:d,easing:"ease",fromHeight:`${l}px`,toHeight:`${c}px`});this._setAnimationById(e,o.id,o),o.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"6n_8IY",["finished: {}","wpHqrk"],o.id),i||a.classList.remove("--animate-from-smallest-height"),a.classList.add("--rtf-mini-mode"),o.cancel()},o.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"GZ7hv4",["canceled: {}","a1Erpd"],o.id),i||a.classList.remove("--animate-from-smallest-height"),a.classList.add("--rtf-mini-mode"),this._deleteAnimationById(e,o.id),this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.RTF,info:{mode:RP.h.MINI}})};const u=function(e,t){var s,i,n;const a=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(i=t.delay)&&void 0!==i?i:0;return e.animate([{opacity:0},{opacity:1}],{id:a,duration:r,fill:t.fill,delay:o,easing:null!==(n=t.easing)&&void 0!==n?n:"ease"})}(r,{animId:`${UP.FADE_IN_RTF_TOOLBAR}::${GP.next()}`,duration:d,easing:"ease"});this._setAnimationById(e,u.id,u),u.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"99M8zn",["finished: {}","wpHqrk"],u.id),r.classList.add("--visible"),u.cancel()},u.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"uJnlGB",["canceled: {}","a1Erpd"],u.id),r.classList.add("--visible"),this._deleteAnimationById(e,u.id)},this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.SWITCHING,info:{inputType:RP.g.RTF,from:RP.g.NORMAL,to:RP.g.RTF}})}else o()}switchRTFModeToNormalMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"qCizGl","(@=@)! >>>switchRTFModeToNormalMode<<<"),!e||!t)return;const n=null!=s?s:zl.default.getWindow(e);if(!Object(NP.a)(!!n,"window isn't existed."))return;const a=this._getChatInputContainerEl(n);if(!Object(NP.a)(!!a,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(n);if(!Object(NP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(n);if(!Object(NP.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const l=()=>{a.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.NORMAL,info:{}})};if(this._cancelAllAnimation(e,!0),!i)return l();const c=this._getChatInputContentEl(n);if(!Object(NP.a)(!!c,"chatInputContentEl isn't existed."))return;const d=c.clientHeight,u=a.clientHeight,h=d/PP.e>=2;let g=PP.c.SMALLEST_HEIGHT_IN_NORMAL,m=!1;h||(a.classList.add("--simple-normal-mode"),m=c.clientHeight/PP.e>=2,a.classList.remove("--simple-normal-mode")),g=h||m?Math.round((d>PP.d.NORMAL.MAX?PP.d.NORMAL.MAX:d)+PP.g+2*PP.c.PADDING_TOP_BOTTOM+PP.b):PP.c.SMALLEST_HEIGHT_IN_NORMAL,this._isDevelopment&&this._logger.zsymb(3,"aWi_XL",["heights: {} {}","I-ZFcK"],u,g);let p=this._getTransitionDuration(g,u);if(this._isDevelopment&&this._logger.zsymb(3,"wBdjfH",["duration: {}","8t2FXa"],p),p>0){h||m||a.classList.add("--animate-to-smallest-height"),a.classList.add("--switching-rtf-to-normal-mode"),a.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="";const s=kP(a,{animId:`${UP.RTF_TO_NORMAL}::${GP.next()}`,duration:p,easing:"ease",fromHeight:`${u}px`,toHeight:`${g}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"fFeiJX",["finished: {}","wpHqrk"],s.id),a.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"2yrMHx",["canceled: {}","a1Erpd"],s.id),a.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.NORMAL,info:{}}),this._deleteAnimationById(e,s.id)};const i=function(e,t){var s,i,n;const a=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(i=t.delay)&&void 0!==i?i:0;return e.animate([{opacity:1},{opacity:0}],{id:a,duration:r,fill:t.fill,delay:o,easing:null!==(n=t.easing)&&void 0!==n?n:"ease"})}(r,{animId:`${UP.FADE_OUT_RTF_TOOLBAR}::${GP.next()}`,duration:Math.max(p-50,0),easing:"ease-in"});this._setAnimationById(e,i.id,i),i.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"Dn-ONt",["finished: {}","wpHqrk"],i.id),i.cancel()},i.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"OXKGN5",["canceled: {}","a1Erpd"],i.id),this._deleteAnimationById(e,i.id)},this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.SWITCHING,info:{inputType:RP.g.NORMAL,from:RP.g.RTF,to:RP.g.NORMAL}})}else l()}switchMiniModeToExpandModeInRTFMode(e,t,s,i=!0){var n,a;if(this._isDevelopment&&this._logger.zsymb(0,"MvSkwE","(@=@)! >>>switchMiniModeToExpandModeInRTFMode<<<"),!e||!t)return;const r=null!=s?s:zl.default.getWindow(e);if(!Object(NP.a)(!!r,"window isn't existed."))return;const o=this._getChatInputContainerEl(r);if(!Object(NP.a)(!!o,"chatInputContainerEl isn't existed."))return;const l=this._getRTFToolbarEl(r);if(!Object(NP.a)(!!l,"rtfToolbarEl isn't existed."))return;const c=this._getChatBoxInputContainerEl(r);if(!Object(NP.a)(!!c,"chatBoxInputContainerEl isn't existed."))return;let d=c.clientHeight,u=Math.round((null!==(n=null===(a=this._getChatViewEl(r))||void 0===a?void 0:a.clientHeight)&&void 0!==n?n:0)*PP.a);const h=()=>{o.classList.replace("--rtf-mini-mode","--rtf-expand-mode"),c.style.height=`${u}px`,this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.RTF,info:{mode:RP.h.EXPAND}})};if(this._cancelAllAnimation(e,!0),!i)return h();d>=u&&(u=d),this._isDevelopment&&this._logger.zsymb(3,"vgYLIs",["heights: {} {}","I-ZFcK"],d,u);let g=this._getTransitionDuration(u,d);if(this._isDevelopment&&this._logger.zsymb(3,"TFZqmy",["duration: {}","8t2FXa"],g),g>0){this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.SWITCHING,info:{inputType:RP.g.RTF,from:RP.h.MINI,to:RP.h.EXPAND}}),o.classList.replace("--rtf-mini-mode","--rtf-expand-mode");const s=kP(c,{animId:`${UP.MINI_TO_EXPAND}::${GP.next()}`,duration:g,fromHeight:`${d}px`,toHeight:`${u}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"zrnOM1",["finished: {}","wpHqrk"],s.id),c.style.height=`${u}px`,s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"DYm5RW",["canceled: {}","a1Erpd"],s.id),c.style.height=`${u}px`,this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.RTF,info:{mode:RP.h.EXPAND}})}}else h()}switchExpandModeToMiniModeInRTFMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"gmrrPV","(@=@)! >>>switchExpandModeToMiniModeInRTFMode<<<"),!e||!t)return;const n=null!=s?s:zl.default.getWindow(e);if(!Object(NP.a)(!!n,"window isn't existed."))return;const a=this._getChatInputContainerEl(n);if(!Object(NP.a)(!!a,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(n);if(!Object(NP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(n);if(!Object(NP.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const l=()=>{a.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.RTF,info:{mode:RP.h.MINI}})};if(this._cancelAllAnimation(e,!0),!i)return l();const c=o.clientHeight,d=a.clientHeight,u=Math.round(c-d+PP.d.RTF.MIN+PP.g+2*PP.c.PADDING_TOP_BOTTOM+PP.b);this._isDevelopment&&this._logger.zsymb(3,"biim5d",["heights: {} {}","I-ZFcK"],c,u);let h=this._getTransitionDuration(u,c);if(this._isDevelopment&&this._logger.zsymb(3,"NJBG9h",["duration: {}","8t2FXa"],h),h>0){this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.SWITCHING,info:{inputType:RP.g.RTF,from:RP.h.EXPAND,to:RP.h.MINI}});const s=kP(o,{animId:`${UP.EXPAND_TO_MINI}::${GP.next()}`,duration:h,fromHeight:`${c}px`,toHeight:`${u}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"YtAAjl",["finished: {}","wpHqrk"],s.id),a.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"Zg7uEC",["canceled: {}","a1Erpd"],s.id),a.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:RP.g.RTF,info:{mode:RP.h.MINI}})}}else l()}resizeChatBoxInputWhenWindowResize(e,t,s=!0){var i,n;if(this._isDevelopment&&this._logger.zsymb(0,"wf9Jnm","(@=@)! >>>resizeChatBoxInputWhenWindowResize<<<"),!e)return;const a=null!=t?t:zl.default.getWindow(e);if(!Object(NP.a)(!!a,"window isn't existed."))return;const r=this._getChatBoxInputContainerEl(a);if(!Object(NP.a)(!!r,"chatBoxInputContainerEl isn't existed."))return;const o=r.clientHeight,l=Math.round((null!==(i=null===(n=this._getChatViewEl(a))||void 0===n?void 0:n.clientHeight)&&void 0!==i?i:0)*PP.a),c=()=>{r.style.height=`${l}px`};if(this._cancelAllAnimation(e,!0),!s)return c();this._isDevelopment&&this._logger.zsymb(3,"Fr4cV9",["heights: {} {}","I-ZFcK"],o,l);let d=this._getTransitionDuration(l,o);if(this._isDevelopment&&this._logger.zsymb(3,"fP5Jca",["duration: {}","8t2FXa"],d),d>0){const t=kP(r,{animId:`${UP.RESIZE_WHEN_WINDOW_RESIZE}::${GP.next()}`,duration:d,fromHeight:`${o}px`,toHeight:`${l}px`});this._setAnimationById(e,t.id,t),t.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"sVkVEv",["finished: {}","wpHqrk"],t.id),r.style.height=`${l}px`,t.cancel()},t.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"fJoiCP",["canceled: {}","a1Erpd"],t.id),r.style.height=`${l}px`,this._deleteAnimationById(e,t.id)}}else c()}get _chatBoxInputController(){return i.ModuleContainer.resolve(FP.a)}_getChatInputContainerEl(e){return e.document.getElementById(RP.d)}_getRTFToolbarEl(e){return e.document.getElementById(RP.i)}_getChatBoxInputContainerEl(e){return e.document.getElementById(RP.b)}_getChatInputContentEl(e){return e.document.getElementById(RP.f)}_getChatViewEl(e){return e.document.getElementById(PP.f)}_getTransitionDuration(e=0,t=0){if(!e||e<=0||!t||t<=0)return 0;const s=Object(xP.a)(),i=Math.abs(e-t);return i<=1?0:Math.round(s*Math.log(i))}_getAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);if(s)return s[t]}_setAnimationById(e,t,s){if(!e||!t||!s)return;let i=this._chatBoxInputAnimsMap.get(e);i||(i={}),i[t]=s,this._chatBoxInputAnimsMap.set(e,i)}_deleteAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);s&&(delete s[t],this._chatBoxInputAnimsMap.set(e,s))}_cancelAnimation(e,t,s=!1){let i=this._chatBoxInputAnimsMap.get(e);if(!i)return;i=Object(f.a)({},i);const n=i[t];n&&(n.cancel(),s&&(delete i[t],this._chatBoxInputAnimsMap.set(e,i)))}_cancelAllAnimation(e,t=!1){const s=this._chatBoxInputAnimsMap.get(e);if(s&&0!==Object.keys(s).length){for(const e in s){var i;if(s[e])null===(i=s[e])||void 0===i||i.cancel(),t&&delete s[e]}this._chatBoxInputAnimsMap.set(e,s)}}})||BP)||BP)||BP)||BP);var zP=s("CkSj"),VP=s("uUhV"),HP=s("I9t9");const WP="qrw",$P=`${WP}__extension`,KP=`${WP}__main`,qP=`${KP}--bd`,QP=`${KP}--content`,ZP=`${QP}--c`,JP=`${QP}__title`,YP=`${QP}__desc`,XP=`${QP}__act`,ek=`${WP}__step`,tk=`${ek}--slider`,sk=`${ek}--indicator-c`,ik=`${ek}--indicator`,nk=`${ek}--content`,ak=`${nk}--c`,rk=`${nk}__title`,ok=`${nk}__desc`,lk=`${nk}__act`;var ck=s("aUrs"),dk=s("/3IL");const uk=["className","style","children","noWrap"];function hk(e){const{className:t,style:s,children:i,noWrap:n=!1}=e,a=Object(Ip.a)(e,uk),r=Object(gO.a)(t,"flx",n?"flex-nowrap":"flex-wrap");return At.a.createElement("div",Object(xt.a)({},a,{className:r,style:s}),i)}hk.propTypes={className:hO.a.string,style:hO.a.object,noWrap:hO.a.bool};var gk=hk,mk=s("h/gz"),pk=s("UUop");function fk(e){const{onClick:t}=e;return At.a.createElement(dk.a,{className:KP},At.a.createElement(dk.a,{className:qP},At.a.createElement("img",{src:"assets/quick-reply-welcome-backdrop.6662d0752f1924cff174a9a07123f9e3.svg",alt:"welcome"})),At.a.createElement(dk.a,{className:QP},At.a.createElement(dk.a,{className:ZP},At.a.createElement(dk.a,{className:JP},At.a.createElement(lO.a,{textKey:"STR_TITLE_QUICK_MESSAGES"})),At.a.createElement(dk.a,{className:YP},At.a.createElement(lO.a,{textKey:"STR_QR_WELCOME_MAIN"})),At.a.createElement(dk.a,{className:XP},At.a.createElement(gk,null,At.a.createElement(fO.a,{className:"w-100",type:"primary",size:"medium",onClick:()=>{Object(pk.b)(pk.a.Welcome.CLICK_LEARN_MORE),Object(mk.n)(t)()}},At.a.createElement(lO.a,{textKey:"STR_LEARN_MORE"})))))))}fk.propTypes={onClick:hO.a.func};var vk=fk;const bk="One",Ik="Two";function yk(e){const{onComplete:t}=e,[s,i]=Object(Dt.useState)(bk),n=Object(MR.b)();let a=null;return"vi"===n?a=s===bk?"assets/QM_Guide_Vi_1.85c6702df7df6f98bdfc2f7a2933c807.gif":"assets/QM_Guide_Vi_2.ef56a79e86131f474069999be3d6c90e.gif":"en"===n&&(a=s===bk?"assets/QM_Guide_En_1.f24dd518213dc12288c678ce20fb006f.gif":"assets/QM_Guide_En_2.4b0370616555dffd006442bb44328358.gif"),At.a.createElement(dk.a,{className:ek},At.a.createElement(dk.a,{className:tk},At.a.createElement("img",{src:a,alt:"Tip"})),At.a.createElement(dk.a,{className:nk},At.a.createElement(dk.a,{className:sk},At.a.createElement(gk,{className:ik},At.a.createElement(LO.a,{className:"red_dot "+(s===bk?"active":"")}),At.a.createElement(LO.a,{className:"red_dot "+(s===Ik?"active":"")}))),At.a.createElement(dk.a,{className:ak},At.a.createElement(dk.a,{className:rk},At.a.createElement(lO.a,{textKey:os.a.trans("STR_STEP",[""+(s===bk?"1":"2"),"2"])})),At.a.createElement(dk.a,{className:ok},At.a.createElement(lO.a,{textKey:""+(s===bk?"STR_CLICK":"STR_TYPE_TO")}),At.a.createElement(lO.a,{className:`${ok}--bold`,textKey:""+(s===bk?"STR_MANAGE":"/")}),At.a.createElement(lO.a,{textKey:""+(s===bk?"STR_QR_WELCOME_STEP_1":"STR_QR_WELCOME_STEP_2")}),"."),At.a.createElement(dk.a,{className:lk},At.a.createElement(gk,{className:`${lk}${s===bk?"--end":"--bw"}`},s===Ik?At.a.createElement(fO.a,{type:"neutral",size:"medium",onClick:()=>{s===Ik&&i(bk)}},At.a.createElement(lO.a,{textKey:""+(s===bk?"STR_SKIP":"STR_BACK")})):null,At.a.createElement(fO.a,{className:"ml-8",type:"primary",size:"medium",onClick:()=>{s===bk?i(Ik):s===Ik&&(Object(pk.b)(pk.a.Welcome.CLICK_COMPLETE),Object(mk.n)(t)())}},At.a.createElement(lO.a,{textKey:""+(s===bk?"STR_CONTINUE":"STR_DONE_2")})))))))}yk.propTypes={onComplete:hO.a.func};var _k=yk;function Ck(e,t){const{windowContainer:s,onReject:i,onSkip:n,windowId:a}=e,r=[{textKey:"STR_QM_SKIP",onclick:n},{type:T_.MENU_ITEM_TYPE.SEPARATE},{textKey:"STR_QM_OFF_FEATURE",onclick:i}];return At.a.createElement(T_.default,{ref:t,items:r,popoverProps:{identity:{windowId:a,name:R.PopoverIdentitiesDefine.QM_WELCOME_EXT_MENU},placement:"bottom-right",windowContainer:s}})}const Ok=Object(Dt.forwardRef)(Ck);Ok.propTypes={windowContainer:hO.a.node,onReject:hO.a.func,onSkip:hO.a.func,windowId:hO.a.string};var Ek=Ok,Mk=s("oBev"),Sk=s("WvqV"),Tk=s("Jmku");const wk={MAIN:"Main",STEP:"Step"},Rk=R.PopoverIdentitiesDefine.QM_WELCOME;function Lk(e){const{anchor:t,eventHandler:s,isOpen:i,initMode:n,onCompleteWelcome:a,onClosePopover:r,windowId:o}=e,l=Object.values(wk).indexOf(n)>-1,[c,d]=Object(Dt.useState)(l&&n||wk.MAIN),u=Object(Dt.useRef)(null),h=()=>{d(wk.STEP)},g=()=>{Object(mk.e)(),Object(mk.n)(a)()},m=()=>{g()};if(Object(Dt.useEffect)((()=>{const e={windowId:o,name:Rk},t=()=>{Object(mk.n)(r)()};return Tk.a.on("beforeClose",e,t),()=>{Tk.a.removeListener("beforeClose",e,t)}}),[]),Object(Dt.useEffect)((()=>{i&&(Object(pk.b)(pk.a.Welcome.SHOW),Object(Sk.b)(o,Rk))}),[i]),!i)return null;let p;p=c===wk.MAIN?At.a.createElement(vk,{onClick:h}):c===wk.STEP?At.a.createElement(_k,{onComplete:m}):null;const f=At.a.createElement(At.a.Fragment,null,At.a.createElement("div",null,At.a.createElement("div",{className:$P,onClick:e=>{var t;Object(pk.b)(pk.a.Welcome.CLICK_EXT),null===(t=u.current)||void 0===t||t.show(e)}},At.a.createElement("i",{className:"fa fa-solid-more"})),p),At.a.createElement(Ek,{ref:u,onReject:e=>{Object(pk.b)(pk.a.Welcome.CLICK_NO_NEED),Object(mk.n)(r)();Mk.a.onUpdateFeatureStatus(!1,(()=>{Mk.a.showSettings(o,{show:!0,data:{tab:nR.f.MESSAGES,showQRToolTipTime:Date.now()}})}))},onSkip:()=>{Object(pk.b)(pk.a.Welcome.CLICK_SKIP_EXT),g()},windowId:o}));return At.a.createElement(Tk.b,{anchorEl:t,identity:{windowId:o,name:Rk},className:WP,content:f,deltaPosition:{top:-8},placement:"top-right",style:{borderRadius:"4px",padding:0}})}Lk.propTypes={refCB:hO.a.object,onCompleteWelcome:hO.a.func,onClosePopover:hO.a.func};var Dk=Object(ck.b)(Lk),Ak=s("4mSp"),Fk=s("bB2L"),jk=s("JKN4");const Pk="qrcb-popover-container",kk=`${Pk}__header`,Nk=`${kk}__title`,Uk=kk+"__manage-btn",Bk=`${Pk}__body`,xk=`${Bk}__hint-c`,Gk=`${xk}__tip`,zk=`${xk}__desc`;var Vk=s("tjM/");function Hk(){return At.a.createElement("div",{className:xk},At.a.createElement("div",{className:Gk},At.a.createElement(jk.a,{textKey:"STR_TIP"}),":"),At.a.createElement("div",{className:zk},At.a.createElement(jk.a,{textKey:"STR_INPUT"}),At.a.createElement(Vk.a,{className:"ml-4 mr-4",size:"small"}),At.a.createElement(jk.a,{textKey:"STR_INPUT_QR_LIST"}),"."))}Hk.propTypes={};var Wk=Hk,$k=s("QJeg"),Kk=s("egaF"),qk=s("huGB");const Qk={top:0,left:0,right:window.innerWidth-10,bottom:window.innerHeight},Zk=R.PopoverIdentitiesDefine.QM_DASHBOARD;const Jk=Object(ck.b)((function(e){var t,s;const{anchor:i,conversationId:n,data:a={},isOpen:r,onClosePopover:o,windowId:l,popupDocument:c}=e,{selfWindow:d}=Object(SO.a)(),u=Object(iO.b)();let h=Object(mk.p)();const[g,m]=Object(Dt.useState)(h),p=e=>{const t={item:e,conversationId:n,sendSrc:"dashboard"};u.emit(Ai.GeneralActions.REPLACE_QR_KEYWORD_TO_CHAT_INPUT,t),Object(mk.n)(o)()},f=null!==(t=null==a||null===(s=a.list)||void 0===s?void 0:s.length)&&void 0!==t?t:0;if(Object(Dt.useEffect)((()=>{const e={windowId:l,name:Zk},t=()=>{m(!1),Object(mk.n)(o)()};return Tk.a.on("beforeClose",e,t),()=>{Tk.a.removeListener("beforeClose",e,t)}}),[]),Object(Dt.useEffect)((()=>{r&&Object(Sk.b)(l,Zk)}),[r]),!r)return null;const v=At.a.createElement("div",{className:qk.q},At.a.createElement(lO.a,{textKey:"STR_QR_DASHBOARD_TOOLTIPS_1"})," ",At.a.createElement(lO.a,{textKey:"STR_MANAGE"})," ",At.a.createElement(lO.a,{textKey:"STR_QR_DASHBOARD_TOOLTIPS_2"}),"."),b=At.a.createElement("div",{className:Pk},At.a.createElement("div",{className:kk},At.a.createElement("div",{className:Nk,"data-id":"div_QuickMsg_QMTitle"},os.a.trans("STR_TITLE_QUICK_MESSAGES_WITH_COUNTING",[f])),At.a.createElement(Ak.a,{title:v,boundary:Qk,open:g,delay:100,placement:"top-center",popupDocument:d},At.a.createElement("div",{className:"rel"},At.a.createElement(fO.a,{className:Uk,"data-id":"btn_QuickMsg_Manage",type:"tertiary-primary",size:"medium",onClick:()=>{h&&Object(mk.b)(),Object(Sk.a)(l,Zk),Object(pk.b)(pk.a.Management.ON_OPEN_IN_DASHBOARD),Mk.a.showManagerModal(l,{from:"dashboard"})}},At.a.createElement(lO.a,{textKey:"STR_MANAGE"}))))),At.a.createElement("div",{className:Bk,style:{height:Object(mk.g)(f)}},At.a.createElement(Kk.b,{autoHide:!0,noHScroll:!0,noVScroll:!1},At.a.createElement("div",{"data-id":"div_QuickMsg_QMList",style:{flex:1,height:"100%"}},(e=>{let t=null==e?void 0:e.list;if(!t||!Array.isArray(t)||!t.length)return At.a.createElement($k.a,{mode:"dashboard"});const s=t.map((e=>At.a.createElement(Fk.a,{borders:{bottom:!0},canActions:!1,className:"clickable",data:e,dataId:"div_QuickMsg_QMItem",onClick:p})));return t.length<=3&&s.push(At.a.createElement(Wk,null)),s})(a)))));return At.a.createElement(Tk.b,{anchorEl:i,identity:{windowId:l,name:Zk},className:"qrcb-popover",content:b,deltaPosition:{top:-4},placement:"top-left",zIndex:9999})}));Jk.propTypes={anchor:hO.a.element,conversationId:hO.a.string,data:hO.a.object,isOpen:hO.a.bool,onClosePopover:hO.a.func,windowId:hO.a.string};var Yk=Jk;var Xk=function(e){const{showWelcome:t}=e;return t?At.a.createElement(Dk,e):At.a.createElement(Yk,e)},eN=s("aloy");function tN(e,t){const{onClick:s,isOpen:i}=e,[n,a]=Object(Dt.useState)(Object(mk.q)());return At.a.createElement("div",{className:qk.n},At.a.createElement("div",null,At.a.createElement(eN.b,{ref:t,key:"quick-msg",id:"QR_ChatBar-Btn",isActive:i,onClick:e=>{n&&(a(!1),Object(mk.c)()),Object(mk.n)(s)(e)},icon:"Quick-msg",title:"STR_QR_INSERT","data-id":"btn_QuickMsg_Entry"}),n?At.a.createElement("div",{className:Object(gO.a)(qk.m)},At.a.createElement("i",{className:`fa fa-red_dot ${qk.l}`})):null))}tN.propTypes={onClick:hO.a.func};var sN=Object(Dt.forwardRef)(tN),iN=s("RwJP"),nN=s("Bdpz");function aN(e){const{conversationId:t}=e,{windowId:s,selfDocument:i}=Object(SO.a)(),[n,a]=Object(Dt.useState)(!1),[,r]=Object(Dt.useState)({}),o=Object(Dt.useRef)(),l=Object(Dt.useRef)(),c=Object(iO.b)(),[,d]=Object(iN.a)(),u=()=>{a(!1)};Object(Dt.useEffect)((()=>{const e=()=>{r({})};return os.a.callUpdate(e),()=>{os.a.removeUpdate(e)}}),[]),Object(Dt.useEffect)((()=>{const e=()=>{u()};return i.addEventListener("resize",e),()=>{i.removeEventListener("resize",e)}}),[]),Object(Dt.useEffect)((()=>{const e=c.on(Ai.GeneralActions.OPEN_QM_DASHBOARD,((e,t)=>{o.current&&"function"==typeof o.current.click&&e===s&&o.current.click()}));return()=>{e.remove()}}),[]),Object(Dt.useEffect)((()=>{const e=c.on(Ai.GeneralActions.UPDATE_QUICK_MESSAGE_STATUS,(()=>{r({})}));return()=>{e.remove()}}),[]);const h=Object(mk.s)(d);return nN.a.Config.isEnableQuickReply()&&nN.a.FeatureSettings.getFeatureStatus()?At.a.createElement(At.a.Fragment,null,At.a.createElement(Xk,{anchor:o.current,conversationId:t,data:d,eventHandler:l.current,isOpen:n,onCompleteWelcome:()=>{a(!1),setTimeout((()=>{a(!0)}),100)},onClosePopover:u,showWelcome:h,windowId:s,popupDocument:i}),At.a.createElement(sN,{ref:e=>o.current=e,onClick:e=>{l.current=Object(f.a)({},e),a(!n),Object(pk.b)(pk.a.Feature.CLICK_ENTRYPOINT)},isOpen:n})):null}aN.propTypes={conversationId:hO.a.string,onClickEP:hO.a.func,onClosePopover:hO.a.func,refCB:hO.a.any,refEP:hO.a.any,windowId:hO.a.string};var rN,oN=aN;Object(i.singleton)(VP.a)(rN=Reflect.metadata("design:type",Function)(rN=Reflect.metadata("design:paramtypes",[])(rN=class{constructor(){this._chatBoxToolbarButtonsMap=new Map,this._registerChatBoxToolbarButtons()}_registerChatBoxToolbarButtons(){this._chatBoxToolbarButtonsMap.set(zP.b.SEND_STICKER_ITEM,(e=>At.a.createElement(HP.r,e))),this._chatBoxToolbarButtonsMap.set(zP.b.PICK_PHOTO_ITEM,(e=>At.a.createElement(HP.l,e))),this._chatBoxToolbarButtonsMap.set(zP.b.PICK_FILE_ITEM,(e=>At.a.createElement(HP.j,e))),this._chatBoxToolbarButtonsMap.set(zP.b.SCREEN_CAPTURE_ITEM,(e=>At.a.createElement(HP.n,e))),this._chatBoxToolbarButtonsMap.set(zP.b.SCREEN_CAPTURE_OPTIONS_ITEM,(e=>At.a.createElement(HP.p,e))),this._chatBoxToolbarButtonsMap.set(zP.b.SHARE_CONTACT_ITEM,(e=>At.a.createElement(HP.s,e))),this._chatBoxToolbarButtonsMap.set(zP.b.CREATE_REMINDER_ITEM,(e=>At.a.createElement(HP.d,e))),this._chatBoxToolbarButtonsMap.set(zP.b.CREATE_TODO_ITEM,(e=>At.a.createElement(HP.e,e))),this._chatBoxToolbarButtonsMap.set(zP.b.TOGGLE_RTF_MODE_ITEM,(e=>At.a.createElement(HP.u,e))),this._chatBoxToolbarButtonsMap.set(zP.b.MARK_IMPORTANT_MESSAGE_ITEM,(e=>At.a.createElement(HP.g,e))),this._chatBoxToolbarButtonsMap.set(zP.b.QUICK_MESSAGE_ITEM,(e=>At.a.createElement(oN,{conversationId:e.convId}))),this._chatBoxToolbarButtonsMap.set(zP.b.MORE_ITEM,(e=>At.a.createElement(HP.h,e)))}getChatBoxToolbarButton(e){return this._chatBoxToolbarButtonsMap.get(e)}})||rN)||rN);var lN,cN=s("RPT1"),dN=s("TsEa"),uN=s("Y25x"),hN=s("7fvu");Object(ko.b)(cN.b)(lN=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(lN=Reflect.metadata("design:type",Function)(lN=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(lN=class{constructor(e){this.type=void 0,this.key=hN.a,this.name=cN.a,this._chatBoxCommandUIStateMap=new Map,this._isSupportCommandModeMap=new Map,this._logger=void 0,this._logger=e.createZLogger(Ve.ZLoggerNametags.cbiCommandController,[Ve.ZLoggerNametags.cbiCommandMode])}init(){}getItem(e,t){if(!e.key)return;const s=this._chatBoxCommandUIStateMap.get(e.key);if(s)return s;if(Object(uN.b)(e.key)){const t=this._initDefaultState();return this._chatBoxCommandUIStateMap.set(e.key,t),t}}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"Xj65fp",["[onGetItemFailure] key: {}, error: {}","-vkCD8"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"ilwwfG",["[onGetListFailure] key: {}, error: {}","8kfggI"],e,t.message)}getChatBoxCommandModeOfConv(e){if(!e){const t=`[getChatBoxCommandModeOfConv] ${e} is invalid!`;return this._logger.zsymb(18,"jn32X-",t),-1}let t=this._chatBoxCommandUIStateMap.get(Object(uN.a)(e));return t||(t=this._initDefaultState(),this._chatBoxCommandUIStateMap.set(Object(uN.a)(e),t)),t.currentMode}setNewChatBoxCommandModeOfConv(e,t){if(!t){const e=`[setNewChatBoxCommandModeOfConv] ${t} is invalid!`;return void this._logger.zsymb(18,"nov3Co",e)}let s=this._chatBoxCommandUIStateMap.get(Object(uN.a)(t));s||(s=this._initDefaultState());let i=Object(kg.a)(s,(t=>{t.currentMode=e}));i!==s&&(this._chatBoxCommandUIStateMap.set(Object(uN.a)(t),i),Object(hs.h)(this.name,Object(uN.a)(t)))}resetChatBoxCommandModeToNormalModeOfConv(e){this.setNewChatBoxCommandModeOfConv(dN.b.NORMAL,e)}getPlaceholderOfMode(e){if(!e||-1===e)return"";const t=dN.c[e];return t.hasOwnProperty("placeholder")&&t.placeholder?t.placeholder:""}_initDefaultState(){return{currentMode:dN.b.NORMAL}}})||lN)||lN)||lN);var gN,mN,pN,fN,vN,bN,IN,yN,_N,CN,ON,EN,MN=s("0EGn"),SN=s("ETgL"),TN=s("xHgQ"),wN=s("PflS"),RN=s("pr8J");const LN={conversationId:"",showSlider:!1,items:[],selectedId:null,hasOlder:!0,hasNewer:!0,entry:aM.l.Unknown,showCaption:!0};gN=Object(i.injectable)(),mN=Object(ko.b)(nM.b),pN=Reflect.metadata("design:type",Function),fN=Reflect.metadata("design:paramtypes",[]),vN=function(e,t,s){const i=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await i.apply(this,e);return t(),s}catch(s){throw t(),s}},s},bN=Reflect.metadata("design:type",Function),IN=Reflect.metadata("design:paramtypes",[void 0===RN.LoadConfig?Object:RN.LoadConfig,String,Boolean]),yN=function(e,t,s){const i=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await i.apply(this,e);return t(),s}catch(s){throw t(),s}},s},_N=Reflect.metadata("design:type",Function),CN=Reflect.metadata("design:paramtypes",[void 0===RN.LoadConfig?Object:RN.LoadConfig]),gN(ON=mN(ON=pN(ON=fN((EN=class{constructor(){this._runningTasks=new Map,this._eventEmitter=new Op.a,this._abortedTask=new Set,this.dispose=()=>{this._runningTasks.forEach((e=>e.abort())),this._runningTasks.clear(),this._abortedTask.clear(),this._eventEmitter.removeAllListeners(),i.ModuleContainer.resolve(_p.b).removeActiveWindowContext()},this.toggleSlider=e=>{this.ensureInitState(e);let t=this.data.get(e);t=Object(f.a)(Object(f.a)({},t),{},{showSlider:!t.showSlider}),this.data.set(e,t),this._signalRenderItem(this.name,e)},this.ensureInitState=(e,t=!0)=>{this.data.get(e)||(this.data.set(e,Object(f.a)(Object(f.a)({},LN),{},{conversationId:e})),t||this._signalRenderItem(this.name,e))},this.getSelectedItem=e=>{const t=this.data.get(e);if(!t)return null;const s=t.selectedId;if(!s)return null;return t.items.find((e=>e.msgId===s||(null==e?void 0:e.fakeMsgId)===s))},this.manualDownload=async(e,t,s,i)=>{Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,Eo.d.mediaDownload);const n=this.getSelectedItem(s);let a;var r;(Object(Q.a)(!!n,`imageViewer: download item not found for ${s} ${i}`),as.default.logActionPhotoViewer(1830904),(null==n?void 0:n.msgType)===R.MSG_VIDEO&&as.default.logActionPhotoViewer(1831306),(null==n?void 0:n.msgType)===R.MSG_FILE)&&(a=null==n||null===(r=n.message)||void 0===r?void 0:r.title);{var o,l;const s="string"==typeof n?n:null!=n&&null!==(o=n.message)&&void 0!==o&&o.href?n.message.href:null==n||null===(l=n.message)||void 0===l?void 0:l.oriUrl,i=null!=n&&n.message?n.message:{};Object(TN.downloadWebV2)(e,t.document,a,void 0,s,!1,Object(f.a)(Object(f.a)({},i),{},{msgType:null==n?void 0:n.msgType,type:null==n?void 0:n.type,subType:null==n?void 0:n.subType}))}},this.resetShowSlider=e=>{const t=this.data.get(e);t&&(this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{showSlider:!0})),this._signalRenderItem(this.name,e))},this._signalRenderItem=(...e)=>{Object(hs.i)(...e)},this._abortRunningTasks=(e,t=(()=>!1))=>{Array.from(this._runningTasks.keys()).filter((s=>s.startsWith(e)&&!t(s))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e),this._abortedTask.add(e)}))},this._isValidMessage=e=>(null==e?void 0:e.msgType)!==R.MSG_UNDO&&(null==e?void 0:e.msgType)!==R.MSG_DEL_EVERYONE,this._filterDuplicatedImages=e=>{let t=new Map;return e.reduce(((e,s)=>{if(!s)return e;if(null==s.cliMsgId||null==s.fromUid){if(s.msgType&&!isNaN(s.msgType)){let t=+s.msgType;if(t<=0||[R.MSG_TODO,R.MSG_TODO_DONE,R.MSG_FRIEND_SENT_REQUEST,R.MSG_SUGGEST_IN_CHAT].includes(t))return e.push(s),e}return e.push(s),e}const i=`${s.cliMsgId}_${s.fromUid}`,n=`[${i}]|[${s.msgId}][${s.sendDttm}|${s.src}]`;if(t.has(i)){const{msg:n}=t.get(i);return n.src===R.MSG_SRC.SYNC_MOBILE_DB&&(s.fakeMsgId=n.msgId,Object.assign(n,s)),e}return t.set(i,{data:n,msg:s}),e.push(s),e}),[])},this._eventBusHandler=(e,t)=>{},this.name=nM.a,this.data=new Map,this.key="conversationId",this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){switch(e){case wN.a.ROTATE_LEFT:{const e=null==t?void 0:t.mediaId;Object(Q.a)("string"==typeof e,"payload must be an object with mediaId property"),i.ModuleContainer.resolve(_p.b).rotateMedia(e,-90);break}case wN.a.ROTATE_RIGHT:{const e=null==t?void 0:t.mediaId;Object(Q.a)("string"==typeof e,"payload must be an object with mediaId property"),i.ModuleContainer.resolve(_p.b).rotateMedia(e,90);break}default:this._eventEmitter.emit(e,t)}}undoDeleteMulti(e,t){const s=this.data.get(e);if(!s||!t.length)return;const i=[...s.items,...t];let n=this._filterDuplicatedImages(i.sort(((e,t)=>+e.sendDttm-+t.sendDttm)));n=this._filterDeletingMessages(e,n),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:n})),this._signalRenderItem(this.name,e)}removeItem(e,t){var s;const i=this.data.get(e);if(!i||!t)return;let n=i.items.findIndex((e=>e.msgId===i.selectedId));const a=i.items.filter((e=>e.msgId!==t.msgId));n=Math.min(n,a.length-1);const r=null===(s=a[n])||void 0===s?void 0:s.msgId;this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{items:a,selectedId:r})),0===a.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}removeMulti(e,t){var s;const i=this.data.get(e);if(!i||!t.length)return;const n=i.items.filter((e=>!t.includes(e.msgId)));if(0===n.length)return void this.emit("CLOSE_VIEWER",{conversationId:e});let a=i.items.findIndex((e=>e.msgId===i.selectedId));a=-1===a?n.length-1:a,a=Math.min(a,n.length-1);const r=null===(s=n[a])||void 0===s?void 0:s.msgId;this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{items:n,selectedId:r})),this._signalRenderItem(this.name,e)}async loadSlider(e){const{conversationId:t}=e;Object(Q.a)("string"==typeof t,"conversationId must be provided");try{await this._refreshSliderData(e)}catch(s){}}async loadMore(e,t,s){const{conversationId:i,entry:n,isMessageConv:a}=e;Object(Q.a)("string"==typeof i&&i.length>0,`conversationId must be provided. Got ${i}`),Object(Q.a)("backward"===t||"forward"===t,`direction must be backward or forward. Got ${t}`);const r=this.data.get(i);if(Object(Q.a)(!!r,"imageViewer: load more failed. SliderState must be initialized"),"backward"===t){var o,l;let t=r.hasOlder||s;if(!t)return;const d=`${i}-${n}-backward`;var c;if(this._abortRunningTasks(i,(e=>e!==d)),this._runningTasks.has(d))return void(await(null===(c=this._runningTasks.get(d))||void 0===c?void 0:c.promise));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const u=cp(this._loadMore,{conversationId:i,limit:20,message:r.items[0],options:{backward:!0,forward:!1,isMessageConv:a}});this._runningTasks.set(d,u);let h=await u.promise;if(this._abortedTask.has(d))return void this._abortedTask.delete(d);e.isMessageConv&&(h=h.result||h);const g=h;let m=this._filterDuplicatedImages([...g,...r.items]);m=this._filterDeletingMessages(i,m),t=g.length>0,this.data.set(i,Object(f.a)(Object(f.a)({},r),{},{items:m,hasOlder:t,selectedId:null!==(o=null===(l=this.data.get(i))||void 0===l?void 0:l.selectedId)&&void 0!==o?o:null})),this._signalRenderItem(this.name,i)}else{var d,u;let t=r.hasNewer||s;if(!t)return;const o=`${i}-${n}-forward`;var h;if(this._abortRunningTasks(i,(e=>e!==o)),this._runningTasks.has(o))return void(await(null===(h=this._runningTasks.get(o))||void 0===h?void 0:h.promise));this.onFunctionDone=()=>{this._runningTasks.delete(o)};const l=cp(this._loadMore,{conversationId:i,limit:20,message:r.items[r.items.length-1],options:{backward:!1,forward:!0,isMessageConv:a}});this._runningTasks.set(o,l);let c=await l.promise;if(this._abortedTask.has(o))return void this._abortedTask.delete(o);e.isMessageConv&&(c=c.result||c);const g=c;let m=this._filterDuplicatedImages([...r.items,...g]);m=this._filterDeletingMessages(i,m),t=g.length>0,this.data.set(i,Object(f.a)(Object(f.a)({},r),{},{items:m,hasNewer:t,selectedId:null!==(d=null===(u=this.data.get(i))||void 0===u?void 0:u.selectedId)&&void 0!==d?d:null})),this._signalRenderItem(this.name,i)}}selectPreviousItem(e){const t=this.data.get(e);Object(Q.a)(!!t,"imageViewer: select previous item failed. SliderState must be initialized");const s=Object(Gy.d)(t.items),i=s.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(0===i||!s.length)return;const n=s[i-1],a=n.msgId;n.cliMsgId,n.fromUid;this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedId:a})),this._signalRenderItem(this.name,e)}selectNextItem(e){const t=this.data.get(e);Object(Q.a)(!!t,"imageViewer: select next item failed. SliderState must be initialized");const s=Object(Gy.d)(t.items),i=s.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(i===s.length-1||!s.length)return;const n=s[i+1],a=n.msgId;n.cliMsgId,n.fromUid;this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedId:a})),this._signalRenderItem(this.name,e)}selectItem(e,t){const s=this.data.get(e);Object(Q.a)(!!s,"imageViewer: select item failed. SliderState must be initialized"),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedId:t})),this._signalRenderItem(this.name,e)}reset(e){Array.from(this._runningTasks.keys()).filter((t=>t.startsWith(e))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e)})),this._abortedTask.clear(),this.data.has(e)&&this.data.delete(e)}toggleCaption(e,t){if(!this.data.has(e))return;const s=this.data.get(e),i=Object(f.a)({},s);i.showCaption=void 0!==t?t:!s.showCaption,this.data.set(e,i),this._signalRenderItem(this.name,e)}_secureSliderState(e){var t;let{conversationId:s,selectedId:i,defaultItems:n,entry:a,disableSlider:r}=e,o=this.data.get(e.conversationId);const l=null===(t=o)||void 0===t?void 0:t.items.some((e=>e.msgId===i||e.fakeMsgId===i));let c=!0;if(e.disableLoadMore)return a===aM.l.Profile&&(n=n.slice().reverse()),o=Object(f.a)(Object(f.a)({},LN),{},{conversationId:s,items:n,selectedId:i,showSlider:!r,hasOlder:!1,hasNewer:!1,entry:e.entry}),this.data.set(e.conversationId,o),this._signalRenderItem(this.name,s),c;const d=this._filterDeletingMessages(s,n);return o&&l?i!==o.selectedId&&(o=Object(f.a)(Object(f.a)({},o),{},{selectedId:i,entry:e.entry}),c=!1):(o=Object(f.a)(Object(f.a)({},LN),{},{conversationId:s,items:d,selectedId:i,showSlider:!r,hasOlder:!0,hasNewer:!0,entry:e.entry}),c=!1),c||(this.data.set(e.conversationId,o),this._signalRenderItem(this.name,s)),c}async _refreshSliderData(e){const{conversationId:t,isMessageConv:s,entry:i,defaultItems:n}=e;let a=e.selectedId;let r=this._secureSliderState(e);if(e.disableLoadMore)return;let o=this.data.get(e.conversationId),l=o.items.findIndex((e=>e.msgId===a||e.fakeMsgId===a));if(-1===l){const e=o.items.map((e=>e.msgId||e.fakeMsgId));if(zconsole.zsymb(18,"M4KASF",`MVR:refreshSlider: something wrong: selectedId ${a} not found in ${e}`),!o.items.length)return zconsole.zsymb(0,"PmF5Wo","MVR:refreshSlider: we don't have any items to view so close MVR early."),void this.emit("CLOSE_VIEWER",{conversationId:t});l=o.items.length-1}const c=o.items[l];a=null==c?void 0:c.msgId;const d=`${t}-${i}-${a}`;this._abortRunningTasks(t);let u=o.hasOlder,h=o.hasNewer;const g=l<10&&u,m=l>=o.items.length-10&&h;if(!g&&!m)return void(r||this._signalRenderItem(this.name,t));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const p=async t=>{const s=cp(this._loadMore,t);this._runningTasks.set(d,s);let i=await s.promise;if(e.isMessageConv&&(i=i.result||i),!this._abortedTask.has(d))return i;this._abortedTask.delete(d)};if(g){const e={conversationId:t,limit:10,message:c,options:{backward:!0,forward:!1,isMessageConv:s}},i=await p(e),n=this.data.get(t),o=n.items;let l=this._filterDuplicatedImages([...i,...o]);l=this._filterDeletingMessages(t,l),0==i.length&&(u=!1),this.data.set(t,Object(f.a)(Object(f.a)({},n),{},{selectedId:a,items:l,hasOlder:u,hasNewer:h})),r=!1}if(m){const e={conversationId:t,limit:10,message:c,options:{backward:!1,forward:!0,isMessageConv:s}},i=await p(e),n=this.data.get(t),o=n.items;let l=this._filterDuplicatedImages([...o,...i]);l=this._filterDeletingMessages(t,l),0==i.length&&(h=!1),this.data.set(t,Object(f.a)(Object(f.a)({},n),{},{selectedId:a,items:l,hasOlder:u,hasNewer:h})),r=!1}r||this._signalRenderItem(this.name,t);const v=this.data.get(t);null!=v&&v.items.length||this.emit("CLOSE_VIEWER",{conversationId:t})}async _loadMore(e){var t;const{conversationId:s,message:n,limit:a,options:{forward:r=!0,backward:o=!1,filter:l=null,isMessageConv:c=!1}={}}=e,d=n.msgId,u=(null===(t=Object(Gy.a)(n))||void 0===t?void 0:t.total_item_in_group)||0;if(!1===c){let e;try{e=await i.ModuleContainer.resolve(MN.a).getImageMessagesForPhotoViewer(s,d,Math.max(a,u),r,o,l)}catch(h){}const t=SN.b.getOneBannedGroup(s);return t&&(e=SN.b.filterBannedMediaGroup(t.groupId,e)),e}return await Rt.default.getImagesForPhotoViewerFromMessage(n.toUid||s,n.sendDttm,d,Math.max(a,u),r,o)}_filterDeletingMessages(e,t){return t.filter((t=>!Yu.d.isDeleteMessage(e,t)&&this._isValidMessage(t)&&!ho.default.ZSafeFunction((()=>Object(zf.E)(t)),!1)&&!ho.default.ZSafeFunction((()=>Object(zf.z)(t)),!1)))}listenEvents(){Fi.default.subscribe(this._eventBusHandler)}init(){this.listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}},Object(gj.a)(EN.prototype,"loadMore",[vN,bN,IN],Object.getOwnPropertyDescriptor(EN.prototype,"loadMore"),EN.prototype),Object(gj.a)(EN.prototype,"_refreshSliderData",[yN,_N,CN],Object.getOwnPropertyDescriptor(EN.prototype,"_refreshSliderData"),EN.prototype),ON=EN))||ON)||ON)||ON);var DN=s("DRxf"),AN=s("ftrm"),FN=s("pDj3");const jN="zcloud-status-service",PN=Object(i.define)(jN),kN="zcloud-key-service",NN=Object(i.define)(kN),UN="zcloud-plan-service-key",BN=Object(i.define)(UN);var xN=s("2T8k"),GN=s("nTk7");const zN=Object(i.define)("zcloud-status-manager");let VN=function(e){return e[e.ADD_CLOUDS=0]="ADD_CLOUDS",e[e.REMOVE_CLOUDS=1]="REMOVE_CLOUDS",e[e.ADD_TEMP_CLOUDS=2]="ADD_TEMP_CLOUDS",e[e.REMOVE_THREAD=3]="REMOVE_THREAD",e}({});class HN extends GN.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}get cloudDataManager(){return aE.a.getInstance()}get controller(){return i.ModuleContainer.resolve(V_.c)}get openedConvs(){const e=zl.default.getAllCurrentOpens();if(!e||0===e.length)return[];let t=e.map((e=>e===Go.c?i.ModuleContainer.resolve(No.SidebarController).getCurrMainConvId():zl.default.getConvIdFromWindowId(e)));return t=t.filter((e=>!!e)),t}get inInCloudOrZCloudView(){return[AE.b.MEDIA_TYPE,AE.b.CONVERSATION,AE.b.MY_CLOUD].includes(i.ModuleContainer.resolve(ME.b).getCurrentView())}calculateFromAddClouds(e){if(this.inInCloudOrZCloudView||(e=V_.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e)if(i){const e=s,n=V_.d.transferCloudItemRes(!0,i,e),a=Object(V_.p)(i);a&&n&&(t[a]={personalCloud:n})}return t}calculateFromRemoveZCloudKeys(e){const t={};for(const s of e)if(s){s&&(t[s]={personalCloud:void 0})}return t}calculateFromTempClouds(e){if(this.inInCloudOrZCloudView||(e=V_.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e)if(i){const e=i.msgInfo.isE2EE?null:s,n=V_.d.transferCloudItemRes(!1,i,e),a=Object(V_.p)(i);a&&n&&(t[a]={personalCloud:n})}return t}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const e=this.queue.shift();if(!e)break;this.numberOfRunningTasks++;const{data:t,resolve:s,reject:i}=e,{clouds:n=[],removeZCloudKeys:a=[],pCloudUpdate:r,updateSource:o}=t;let l=null;switch(o){case VN.ADD_CLOUDS:l=this.calculateFromAddClouds(n);break;case VN.ADD_TEMP_CLOUDS:l=this.calculateFromTempClouds(n);break;case VN.REMOVE_CLOUDS:l=this.calculateFromRemoveZCloudKeys(a)}l&&this.controller.onZCloudStatus(l),r&&this.controller.onZCloudStatus(r),s(),await new Promise((e=>setTimeout(e,100))),this.numberOfRunningTasks--,this.run()}}}const WN=[],$N=new GN.b(WN),KN=new HN(WN),qN=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}splitIntoBatches(e,t){const s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}async calculateStatus(e){const{clouds:t=[],removeZCloudKeys:s=[],pCloudUpdate:i,updateSource:n}=e,a=new Promise(((e,a)=>{const r={data:{clouds:t,removeZCloudKeys:s,pCloudUpdate:i,updateSource:n},resolve:e,reject:a};this.provider.send(r),this.consumer.run()}));return a.catch((()=>{})).finally((()=>{})),a}async syncStatus(e,t=!1){if(t)this.calculateStatus({pCloudUpdate:e});else for(const s in e){const t={};t[s]=e[s],this.calculateStatus({pCloudUpdate:t})}}}($N,KN);i.ModuleContainer.registerValue(zN,qN);var QN,ZN=qN;let JN=Object(Je.d)()(QN=Object(i.injectable)()(QN=function(e,t){return Object(i.inject)(FN.a)(e,void 0,0)}(QN=function(e,t){return Object(i.inject)(PN)(e,void 0,1)}(QN=function(e,t){return Object(i.inject)(NN)(e,void 0,2)}(QN=function(e,t){return Object(i.inject)(BN)(e,void 0,3)}(QN=Reflect.metadata("design:type",Function)(QN=Reflect.metadata("design:paramtypes",[void 0===FN.a?Object:FN.a,void 0===PN?Object:PN,void 0===NN?Object:NN,void 0===BN?Object:BN])(QN=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e,t,s,i){this.metrics=e,this.statusService=t,this.keyService=s,this.planService=i,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=DN.a,this.key=DN.a}onApplicationReady(){}onBizConfigReady(){if(!Object(AN.a)().isEnableUserPCloud())return this.Logger.zsymb(3,"Luub74",["requestRSAKey but no permission!","9EooN0"]),void this.keyService.removeRSAKey();this.metrics.setGetKeyAfterLoginTime(),this.keyService.requestRSAKey(XE.c.LOGIN)}async calculateZCloudStatusByMessages(e,t){if(!AN.b.shouldLoadInitStatus(t))return;let s=AN.b.filterValidMsgs(e);if(s=AN.b.normalizedMsgs(s),!s||!s.length)return;const i=await this.statusService.getStatusByMessages(s,t);ZN.syncStatus(i,!0)}async calculateZCloudStatusByCloudItems(e){const t=await this.statusService.getStatusByCloudItems(e);ZN.syncStatus(t,!0)}getErrorPCloudHandler(e,t){const{error:s,msgIds:i,windowId:n,showNoti:a,type:r}=e;return s&&null!=s&&s.hasNoKey?()=>this.onInteractMediaWithoutKey({msgIds:i,windowId:n,showNoti:a,type:r},t):()=>{}}checkPCloudWithoutKey(e){return this.keyService.checkPCloudWithoutKey(e)}onZCloudStatus(e){if(Object(xN.d)(e))return;Object.keys(e);this.statusService.syncCachePCloudInfo(e),this.statusService.signalUIPCloudInfo(e),this.statusService.shareUpdatePCloudAction(e)}onHandleHaveKey(){const e=this.keyService.createPCloudUpdateWithValidRSAKey();this.keyService.shareHaveKeyPCloudAction(e)}async onInteractMediaWithoutKey(e,t){if(this.keyService.showToastWarningNoKey(e),!Object(AN.a)().isEnableUserPCloud())return void this.Logger.zsymb(3,"KObQMG",["requestRSAKey but no permission!","9EooN0"]);const s=t||XE.c.RETRY;s===XE.c.INVIEW?this.metrics.setGetKeyAfterInviewTime():s===XE.c.RETRY&&this.metrics.setGetKeyAfterRetryTime(),this.keyService.requestRSAKey(s)}onZCloudFreePlan(){const e=this.statusService.createEmptyPCloudUpdate();this.keyService.removeRSAKey(),ZN.syncStatus(e,!0),this.planService.shareOffPlanEvent()}onUpgradeZCloudPlan(){this.metrics.setGetKeyAfterChangePlanTime(),this.keyService.requestRSAKey(XE.c.CHANGE_PLAN),this.planService.shareUpgradePlanEvent()}onGracePeriodPlan(){this.planService.shareGracePeriodPlanEvent()}onRemoveThreads(e){for(const t of e){const e=this.statusService.createEmptyGroupPCloudUpdate(t);ZN.syncStatus(e)}}})||QN)||QN)||QN)||QN)||QN)||QN)||QN)||QN;var YN,XN=s("0VmO");const eU={valid:!1,status:{isClouded:!0,isUncloud:!1},error:{hasNoKey:!0}},tU={valid:!1,status:{isClouded:!1,isUncloud:!0},error:null},sU={valid:!0,status:{isClouded:!0,isUncloud:!1},error:null};let iU=Object(Je.d)()(YN=Object(i.injectable)()(YN=function(e,t){return Object(i.inject)(XN.a)(e,void 0,0)}(YN=Reflect.metadata("design:type",Function)(YN=Reflect.metadata("design:paramtypes",[void 0===XN.a?Object:XN.a])(YN=class extends Fe.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudStatusEventsResolver])),this._Logger}get controller(){return i.ModuleContainer.resolve(DN.b)}get cloudDataManager(){return aE.a.getInstance()}constructor(e){super(),this.zaloCloudConfig=e,this.name=void 0,this.key=void 0,this.msgs=void 0,this.convId=void 0,this._Logger=void 0,this.name=QE.a,this.key=QE.a,this.msgs=[],this.convId=null}onApplicationReady(){(Object(sE.g)()||Object(AN.a)().isEnableBizPCloud())&&(this.addDataCloudListeners(),this.addTestListeners())}addTestListeners(){this.addEventListener(XE.g.INIT_DATA,this.handleTestCloudEvents.bind(this)),this.addEventListener(XE.g.NO_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(XE.g.HAVE_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(XE.g.NOT_YET_CLOUDED,this.handleTestCloudEvents.bind(this))}addDataCloudListeners(){this.cloudDataManager.addListener(SE.c.ADD_CLOUD_ITEMS,this.handleAddedCloudItems.bind(this)),this.cloudDataManager.addListener(SE.c.UPDATE_CLOUD_ITEMS,this.handleUpdatedCloudItems.bind(this)),this.cloudDataManager.addListener(SE.c.TEMP_CLOUD_ITEMS,this.handleTempCloudItems.bind(this)),this.cloudDataManager.addListener(SE.c.REMOVE_CLOUD_ITEMS,this.handleCloudRemoveItems.bind(this)),this.cloudDataManager.addListener(SE.c.UPDATE_CLOUD_KEY_STATUS,this.handleHaveCloudKey.bind(this)),this.cloudDataManager.addListener(SE.c.REMOVE_THREAD_CLOUD,this.handleCloudRemoveThread.bind(this))}async handleTestCloudEvents(e){const t={};switch(e.type){case XE.g.INIT_DATA:for(const s of e.payload){t[Object(xN.f)(s)]={personalCloud:Object(f.a)({},sU)}}this.controller.onZCloudStatus(t);break;case XE.g.NO_KEY:for(const s of e.payload){t[Object(xN.f)(s)]={personalCloud:Object(f.a)({},eU)}}this.controller.onZCloudStatus(t);break;case XE.g.HAVE_KEY:this.controller.onHandleHaveKey();break;case XE.g.NOT_YET_CLOUDED:for(const s of e.payload){t[Object(xN.f)(s)]={personalCloud:Object(f.a)({},tU)}}this.controller.onZCloudStatus(t)}}handleAddedCloudItems(e){const t=ZN.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)ZN.calculateStatus({clouds:t[s],updateSource:VN.ADD_CLOUDS})}handleUpdatedCloudItems(e){}handleTempCloudItems(e){const t=ZN.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)ZN.calculateStatus({clouds:t[s],updateSource:VN.ADD_TEMP_CLOUDS})}handleCloudRemoveItems(e){const t=ZN.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)ZN.calculateStatus({removeZCloudKeys:t[s],updateSource:VN.REMOVE_CLOUDS})}handleCloudRemoveThread(e){this.controller.onRemoveThreads(e)}handleHaveCloudKey(e){e&&(this.Logger.zsymb(3,"E6AtDS",["handleHaveCloudKey","u8soDc"]),this.controller.onHandleHaveKey())}bindMsg(e,t){this.msgs=e,this.convId=t}})||YN)||YN)||YN)||YN)||YN;var nU,aU=s("3+fW");let rU=Object(ko.b)(aU.a)(nU=Object(i.injectable)()(nU=function(e,t){return Object(i.inject)(FN.a)(e,void 0,0)}(nU=Reflect.metadata("design:type",Function)(nU=Reflect.metadata("design:paramtypes",[void 0===FN.a?Object:FN.a])(nU=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e){this.name=void 0,this.type=void 0,this.key=void 0,this.data=new Map,this.metrics=void 0,this._Logger=void 0,this.name=aU.b,this.key=aU.b,this.metrics=e}_getState(e){return this.data.get(e)}setPCloudInfo(e,t){e?this.data.set(t,e):this.data.delete(t)}signalUIPCloudInfo(e){Object(hs.h)(this.name,e)}getListPCloudInfo(){return this.data.entries()}getPCloudBizState(e){var t,s,i;let n;n="string"==typeof e?e:Object(xN.f)(e);const a=this.data.get(n);return a&&a.status?{valid:a.valid,hasNoKey:(null===(t=a.error)||void 0===t?void 0:t.hasNoKey)||!1,isClouded:null===(s=a.status)||void 0===s?void 0:s.isClouded,isUncloud:null===(i=a.status)||void 0===i?void 0:i.isUncloud,error:a.error,isFreeCloudItem:a.isFreeCloudItem}:null}getPCloudInfo(e){let t;return t="string"==typeof e?e:Object(xN.f)(e),this._getState(t)}getItem(e){return this._getState(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||nU)||nU)||nU)||nU)||nU;const oU="zcloud-repository",lU=Object(i.define)(oU);var cU;let dU=Object(i.injectable)()(cU=Reflect.metadata("design:type",Function)(cU=Reflect.metadata("design:paramtypes",[])(cU=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudStatusRepository])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=oU,this.key=oU}get cloudDataManager(){return aE.a.getInstance()}getZCloudList(e,t){return 0===t.length?Promise.resolve({cloudedItems:[],tempCloudItems:[]}):new Promise((e=>{this.cloudDataManager.getCloudItems(t).then((s=>{let i=[];for(const e of s)e&&i.push(e);const n=i,a=n.map((e=>Object(xN.g)(e))),r=t.filter((e=>!a.includes(Object(xN.f)(e))));e({cloudedItems:n,tempCloudItems:r})})).catch((t=>{this.Logger.zsymb(3,"u83gRv",["getZCloudList, err:","VNsdEz"],t),e({cloudedItems:[],tempCloudItems:[]})}))}))}})||cU)||cU)||cU;var uU;let hU=Object(i.injectable)()(uU=function(e,t){return Object(i.inject)(FN.a)(e,void 0,0)}(uU=function(e,t){return Object(i.inject)(aU.a)(e,void 0,1)}(uU=function(e,t){return Object(i.inject)(QE.b)(e,void 0,2)}(uU=function(e,t){return Object(i.inject)(lU)(e,void 0,3)}(uU=Reflect.metadata("design:type",Function)(uU=Reflect.metadata("design:paramtypes",[void 0===FN.a?Object:FN.a,void 0===aU.a?Object:aU.a,void 0===QE.b?Object:QE.b,void 0===lU?Object:lU])(uU=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudStatusServices])),this._Logger}get cloudDataManager(){return aE.a.getInstance()}constructor(e,t,s,i){this.name=void 0,this.key=void 0,this.metrics=void 0,this.zCloudInfo=void 0,this.eventsResolver=void 0,this.zCloudStatusRepository=void 0,this._Logger=void 0,this.name=jN,this.key=jN,this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.zCloudStatusRepository=i}async getStatusByMessages(e,t){const s={},{cloudedItems:i,tempCloudItems:n}=await this.zCloudStatusRepository.getZCloudList(t,e),a=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const r of i){const e=r.msgInfo.isE2EE?null:a,t=Object(xN.g)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const i=AN.b.transferCloudItemRes(!0,r,e);i&&(s[t]={personalCloud:i})}}for(const r of n){const e=Od.b.isMsgE2ee(r)?null:a,t=Object(xN.f)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const i=AN.b.transferCloudItemRes(!1,r,e);i&&(s[t]={personalCloud:i})}}return Promise.resolve(s)}getStatusByCloudItems(e){const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e){const e=i.msgInfo.isE2EE?null:s,n=Object(xN.g)(i);if(!this.zCloudInfo.getPCloudInfo(n)&&n){const s=AN.b.transferCloudItemRes(!0,i,e);s&&(t[n]={personalCloud:s})}}return Promise.resolve(t)}syncCachePCloudInfo(e){for(const t in e){const s=e[t].personalCloud;this.zCloudInfo.setPCloudInfo(s,t)}}signalUIPCloudInfo(e){for(const t in e)this.zCloudInfo.signalUIPCloudInfo(t)}shareUpdatePCloudAction(e){this.eventsResolver.dispatchEvent(new XE.b(XE.a.UPDATE_STATUS,e))}createEmptyPCloudUpdate(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t)s&&i&&(i.isFreeCloudItem||(e[s]={personalCloud:void 0}));return e}createEmptyGroupPCloudUpdate(e){const t={},s=this.zCloudInfo.getListPCloudInfo();for(let[i,n]of s)i&&n&&i.includes(e)&&(t[i]={personalCloud:void 0});return t}})||uU)||uU)||uU)||uU)||uU)||uU)||uU;var gU;let mU=Object(i.injectable)()(gU=function(e,t){return Object(i.inject)(FN.a)(e,void 0,0)}(gU=function(e,t){return Object(i.inject)(aU.a)(e,void 0,1)}(gU=function(e,t){return Object(i.inject)(QE.b)(e,void 0,2)}(gU=Reflect.metadata("design:type",Function)(gU=Reflect.metadata("design:paramtypes",[void 0===FN.a?Object:FN.a,void 0===aU.a?Object:aU.a,void 0===QE.b?Object:QE.b])(gU=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudKeyServices])),this._Logger}get cloudDataManager(){return aE.a.getInstance()}constructor(e,t,s){this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=kN,this.key=kN}removeRSAKey(){this.cloudDataManager.checkUpgraded()&&this.cloudDataManager.removeKey()}requestRSAKey(e){this.cloudDataManager.checkUpgraded()&&e!==XE.c.CHANGE_PLAN||(e===XE.c.LOGIN||e===XE.c.CHANGE_PLAN?(this.cloudDataManager.updateZCloudKey(!1,e),this.metrics.onAutoRequestKey()):e===XE.c.RETRY&&(this.cloudDataManager.updateZCloudKey(!0,e),this.metrics.onManualRequestKey()))}checkPCloudWithoutKey(e){var t;const s=this.zCloudInfo.getPCloudInfo(e);return Boolean(null==s||null===(t=s.error)||void 0===t?void 0:t.hasNoKey)}createPCloudUpdateWithValidRSAKey(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t){if(!s||!i)continue;if(i.isFreeCloudItem)continue;const t=Object(f.a)(Object(f.a)({},i.error),{},{hasNoKey:!1}),n=i.status,a={valid:AN.b.checkValidFromBizState(t,n),status:n,error:t};e[s]={personalCloud:a}}return e}shareHaveKeyPCloudAction(e){this.eventsResolver.dispatchEvent(new XE.b(XE.a.HAVE_KEY,e))}showToastWarningNoKey(e){const{showNoti:t=!0,windowId:s=Go.c}=e,i=Ri.ZToastManagerHolder.getZToastManagerByWindowId(s);t&&i.show({noBackground:!0,textKey:"STR_PERSONAL_CLOUD_NO_KEY_TOAST",type:Ri.TOAST_TYPE.INFO,duration:3e3,styles:{width:"400px"},styleText:{whiteSpace:"pre-line"}})}})||gU)||gU)||gU)||gU)||gU)||gU;var pU;let fU=Object(i.injectable)()(pU=function(e,t){return Object(i.inject)(QE.b)(e,void 0,0)}(pU=Reflect.metadata("design:type",Function)(pU=Reflect.metadata("design:paramtypes",[void 0===QE.b?Object:QE.b])(pU=class{constructor(e){this.eventsResolver=e,this.name=void 0,this.key=void 0,this.name=UN,this.key=UN}shareUpgradePlanEvent(e){this.eventsResolver.dispatchEvent(new XE.b(XE.a.UPGRADE_ZCLOUD_PLAN,e||{}))}shareOffPlanEvent(e){this.eventsResolver.dispatchEvent(new XE.b(XE.a.OFF_PERSONAL_CLOUD_PLAN,e||{}))}shareGracePeriodPlanEvent(e){this.eventsResolver.dispatchEvent(new XE.b(XE.a.GRACE_PERIOD_ZCLOUD_PLAN,e||{}))}})||pU)||pU)||pU)||pU;var vU=s("MNOV");i.ModuleContainer.registerSingleton(DN.b,JN),i.ModuleContainer.registerSingleton(QE.b,iU),i.ModuleContainer.registerSingleton(aU.a,rU),i.ModuleContainer.registerSingleton(lU,dU),i.ModuleContainer.registerSingleton(PN,hU),i.ModuleContainer.registerSingleton(NN,mU),i.ModuleContainer.registerSingleton(BN,fU),i.ModuleContainer.registerSingleton(FN.a,FN.b),i.ModuleContainer.registerSingleton(vU.a,vU.b),i.ModuleContainer.registerSingleton(XN.a,XN.b);var bU,IU=s("WDlm"),yU=s("Ivja"),_U=s("3rJp"),CU=s("j+NN");let OU=Object(i.injectable)()(bU=Reflect.metadata("design:type",Function)(bU=Reflect.metadata("design:paramtypes",[])(bU=class{constructor(){this.name=void 0,this.key=void 0,this.name=IU.b,this.key=IU.b}async doVerify(e){Object(jE.i)("call doVerify",null==e?void 0:e.length);const t=(null==e?void 0:e.length)&&!!yU.a.instance().isKeyAvailable(),{myCloudItems:s,decryptItems:i,submitItems:n,updateThumbUrlItems:a}=await this.analyse(e);Object(jE.i)("analysed...",null==s?void 0:s.length,null==i?void 0:i.length,null==n?void 0:n.length,null==a?void 0:a.length);let r=[];if(Object(V_.b)().isEnableSubmitExtraInfoConv("mycloud")&&s.length>0){const e=await this.updateMyCloudItems(s);r=[...r,...e]}if(Object(V_.b)().isEnableSubmitExtraInfoConv("other")&&t&&i.length>0){const e=await this.updatePCloudItems(i);r=[...r,...e]}if(Object(V_.b)().isEnableSubmitExtraInfoConv("e2ee")&&t&&n.length>0){const e=await this.submitAndUpdatePCloudItems(n);r=[...r,...e]}if(a.length>0){const e=await this.updateThumbUrl(a);r=[...r,...e]}return r}async analyse(e){const t=e,s=mi.default.sendToMeId;if(0===t.length||!s)return{myCloudItems:[],decryptItems:[],submitItems:[],updateThumbUrlItems:[]};const i=[],n=[],a=[],r=[];for(let g=0;g<t.length;g++){var o,l,c,d,u,h;const e=t[g];if(!e)continue;const m=(null==e||null===(o=e.msgInfo)||void 0===o?void 0:o.destId)==s,p=null==e||null===(l=e.msgInfo)||void 0===l?void 0:l.isE2EE,f=null===(c=e.mediaInfo)||void 0===c||null===(d=c.mediaExtInfo)||void 0===d?void 0:d.data,v=null===(u=e.mediaInfo)||void 0===u||null===(h=u.mediaExtInfo)||void 0===h?void 0:h.decryptedData;if(v){this.shouldUpdateThumbUrl(t[g],v)&&r.push(e)}else m?f||i.push(e):p?v||(f?n.push(e):a.push(e)):v||f&&n.push(e)}return{myCloudItems:i,decryptItems:n,submitItems:a,updateThumbUrlItems:r}}shouldUpdateThumbUrl(e,t){const s=ho.default.normalizeMessageType(e.msgInfo.msgType);if(CU.a.includes(s))try{return!Object(wE.a)(t).thumbUrl}catch(i){return!1}return!1}async updateThumbUrl(e){const t=Object(_U.b)(e),s=await aE.a.getInstance().getMultiMessages(t);if(!s)return[];const i=[];if((t=>{for(let s=0;s<t.length;s++){const n=t[s],a=e.find((e=>TE.a.getZCloudKeyFromCloudItem(e)===TE.a.getZCloudKeyFromQueryItem(n)));if(!n||!a)continue;const r=Object(_U.g)(a,n);r&&i.push(r)}})(s),0===i.length)return[];try{return await aE.a.getInstance().updateCloudQueue(i,["mediaInfo"]),Object(jE.s)("[updateThumbUrl] has success","updateClouds",i.length),i}catch(n){throw Object(jE.r)("[updateThumbUrl] has error",n),n}}async updateMyCloudItems(e){const t=Object(_U.b)(e),s=await aE.a.getInstance().getMultiMessages(t);if(!s)return[];const i=[];if((t=>{for(let s=0;s<t.length;s++){const n=t[s],a=e.find((e=>TE.a.getZCloudKeyFromCloudItem(e)===TE.a.getZCloudKeyFromQueryItem(n)));if(!n||!a)continue;const r=Object(_U.d)(a,n);r&&i.push(r)}})(s),0===i.length)return[];try{return await aE.a.getInstance().updateCloudQueue(i,["mediaInfo"]),Object(jE.s)("[updateMyCloudItems] has success","updateClouds",i.length),i}catch(n){throw Object(jE.r)("[updateMyCloudItems] has error",n),n}}decryptAndUpdateParams(e){return new Promise((async t=>{try{var s,i,n,a;const r=(null===(s=e.mediaInfo.mediaExtInfo)||void 0===s?void 0:s.data)||"",o=(null===(i=e.mediaInfo)||void 0===i||null===(n=i.mediaExtInfo)||void 0===n||null===(a=n.encryptInfo)||void 0===a?void 0:a.encryptKey)||"";Object(jE.i)("decryptAndUpdateParams...",r,o);let l=await yU.a.instance().decryptCloudInfo(r,o);if(l){const s=TE.a.getZCloudKeyFromCloudItem(e),i={};l=await this.updateDecryptedData(e,l),i[s]=l,Object(jE.s)("decrypt succcess",null==e?void 0:e.noiseId),t(i)}}catch(r){Object(jE.r)("[updatePCloudItems] => [decryptAndUpdateParams], has error",r),Object(jE.h)("decrypt info failed",null==e?void 0:e.noiseId,r),t("")}}))}async updateDecryptedData(e,t){const s=ho.default.normalizeMessageType(e.msgInfo.msgType);if(CU.a.includes(s)){let s=Object(wE.a)(t);if(s.thumbUrl)return JSON.stringify(s);const n=Object(_U.b)([e]),a=await aE.a.getInstance().getMultiMessages(n);if(a){const e=a;var i;if(e&&e[0])return s=Object(f.a)(Object(f.a)({},s),{},{thumbUrl:null===(i=e[0].message)||void 0===i?void 0:i.thumbUrl}),JSON.stringify(s)}}return t}async updatePCloudItems(e){const t=[],s=[];let i={};e.forEach((e=>{s.push(this.decryptAndUpdateParams(e))}));try{return(await Promise.allSettled(s)).forEach((e=>{e.value&&(i=Object(f.a)(Object(f.a)({},i),e.value))})),e.forEach((e=>{const s=TE.a.getZCloudKeyFromCloudItem(e);let n=i[s];if(n){const s=Object(_U.e)(e,n);t.push(s)}})),0===t.length?[]:(await aE.a.getInstance().updateCloudQueue(t,["mediaInfo"]),Object(jE.s)("[updatePCloudItems] has success","updateClouds",t.length),t)}catch(n){throw Object(jE.r)("[updatePCloudItems] has error",n),n}}encryptParams(e,t){return new Promise((async s=>{try{const i=await Object(_U.c)(e,t);s(i||"")}catch(i){Object(jE.r)("[submitAndUpdatePCloudItem] =>[encryptParams], has error",i),s("")}}))}async submitAndUpdatePCloudItems(e){const t=Object(_U.b)(e),s=await aE.a.getInstance().getMultiMessages(t);if(!s)return[];const i=[],n=[];(t=>{for(let s=0;s<t.length;s++){const n=t[s],a=e.find((e=>TE.a.getZCloudKeyFromCloudItem(e)===TE.a.getZCloudKeyFromQueryItem(n)));n&&a&&i.push(this.encryptParams(a,n))}})(s);try{const t=(await Promise.allSettled(i)).map((e=>e.value)).filter((e=>!!e)),s=t.map((e=>e.submit));if(0===s.length)return[];0;const a=await qE.a.submitMediaExtInfo({info:s});return Object(jE.s)("submit ext info success",a),t.forEach((t=>{const s=e.find((e=>e.noiseId===t.submit.noiseId));a&&s&&!a.noiseIdsErr.includes(s.noiseId)&&n.push(Object(_U.f)(s,t))})),0===n.length?[]:(await aE.a.getInstance().updateCloudQueue(n,["mediaInfo","encryptInfo"]),Object(jE.s)("[submitAndUpdatePCloudItems] has success","updateClouds",n.length),Object(jE.i)("update cloud success",n),n)}catch(a){throw Object(jE.r)("[submitAndUpdatePCloudItems] has error",a),a}}})||bU)||bU)||bU;var EU=s("LA5e");const MU="zcloud-queue-fetcher",SU=Object(i.define)(MU),TU="zcloud-base-sync-queue";Object(i.define)(TU);var wU;let RU=Object(i.injectable)()(wU=Reflect.metadata("design:type",Function)(wU=Reflect.metadata("design:paramtypes",[])(wU=class{constructor(){this.name=void 0,this.key=void 0,this.name=TU,this.key=TU}groupFetchedCloudsByAction(e){const t=[],s=[],i=[];for(let n=e.length-1;n>=0;n--){let a=e[n];if(a){let{action:e}=a;switch(e){case SE.a.add:i.push(a);break;case SE.a.remove:s.push(a);break;case SE.a.del_thread:t.push(a)}}}return{delThreads:t,delClouds:s,addClouds:i}}})||wU)||wU)||wU;var LU=s("vNFC"),DU=s("FvOk");const AU="zcloud-update-queue-after-fetch-queue",FU=Object(i.define)(AU);var jU=s("ZL0F");const PU=["lastNoiseId"];var kU;let NU=Object(i.injectable)()(kU=function(e,t){return Object(i.inject)(SU)(e,void 0,0)}(kU=function(e,t){return Object(i.inject)(FU)(e,void 0,1)}(kU=function(e,t){return Object(i.inject)(jU.a)(e,void 0,2)}(kU=Reflect.metadata("design:type",Function)(kU=Reflect.metadata("design:paramtypes",[void 0===SU?Object:SU,void 0===FU?Object:FU,void 0===jU.a?Object:jU.a])(kU=class extends RU{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.zCloud,[Ve.ZLoggerNametags.zCloudVerifyQueueServices])),this._Logger}constructor(e,t,s){super(),this.queueFetcher=e,this.updateQueueService=t,this.syncZCloudQueueUIState=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=EU.a,this.key=EU.a}get PCloudMetrics(){return i.ModuleContainer.resolve(V_.g)}async checkVerify(e){const{lastNoiseId:t,forceVerify:s,forceReset:i}=e.mycloudMedia;let n=await aE.a.getInstance().getLastNoiseId();return i?{sourceForceVerify:LU.a.CMD_621_FORCE_RESET}:s?{sourceForceVerify:LU.a.CMD_621_FORCE_VERIFY}:n?t!==n?{sourceVerify:LU.b.CMD_621_VERIFY}:{}:{sourceForceVerify:LU.a.CMD_621_EMPTY_LAST_NOISEID}}async buildVerifyFetchReq(e){try{return{lastNoiseId:await aE.a.getInstance().getLastNoiseId(),lastNoiseIds:[],loadType:SE.d.oldest_to_newest,trackingSource:e.trackingSource}}catch(t){throw t}}buildForceVerifyFetchReq(e){return{lastNoiseId:"",lastNoiseIds:[],loadType:SE.d.oldest_to_newest,trackingSource:e.trackingSource}}shouldCheckResetItem(e){return(null==e?void 0:e.sourceForceVerify)!==LU.a.CMD_620_RESET_CLOUD}async doFetch(e,t,s,i=!1){const n={lastNoiseId:"",cloudItems:[],hasMore:!1};let a=!0,r=!i&&this.shouldCheckResetItem(s);for(t===DU.a.VERIFY_PAGE&&(n.preventCheckResetItem=i);a;){var o;const{cloudItems:s,lastNoiseId:i,hasMore:l}=await this.queueFetcher.fetchQueueByPage(e),c=null!=i?i:null===(o=s[0])||void 0===o?void 0:o.noiseId;if(s.find((e=>e.action===SE.a.reset_cloud))&&this.Logger.zsymb(0,"P0zW-_","doFetch ###### [DEV-DEBUG] ##### FOUND RESET ITEM ######"),r){s.find((e=>e.action===SE.a.reset_cloud))?(this.Logger.zsymb(0,"HNOqNh","doFetch, force verify from [found reset_item], sourceForceVerify",LU.a.VERIFY_FOUND_RESET_CLOUD),await aE.a.getInstance().removeAll(),n.cloudItems=[],n.lastNoiseId="",e.lastNoiseId="",a=!0,r=!1,t===DU.a.VERIFY_PAGE&&(n.preventCheckResetItem=!0)):(n.cloudItems.unshift(...s),n.lastNoiseId=c,n.hasMore=!!l,e.lastNoiseId=c,a=!!l)}else n.cloudItems.unshift(...s),n.lastNoiseId=c,n.hasMore=!!l,e.lastNoiseId=c,a=!!l;if(t===DU.a.VERIFY_PAGE&&n.cloudItems.length>0)break}return n}async verify(e){const{data:t,syncStrategy:s,sourceSync:i,req:n,preventCheckResetItem:a}=e;try{const e=n||await this.buildVerifyFetchReq(t),{cloudItems:r,lastNoiseId:o,hasMore:l,preventCheckResetItem:c}=await this.doFetch(e,s,i,a),{delThreads:d,delClouds:u,addClouds:h}=this.groupFetchedCloudsByAction(r);return{delThreads:d,delClouds:u,addClouds:h,lastNoiseId:o,hasMore:l,preventCheckResetItem:c}}catch(r){throw r}}forceVerify(e){const{data:t,syncStrategy:s,sourceSync:i,req:n,preventCheckResetItem:a}=e,r=n||this.buildForceVerifyFetchReq(t);return this.verify({data:t,syncStrategy:s,sourceSync:i,req:r,preventCheckResetItem:a})}async doVerifyWithSourceVerify(e,t,s){let i=null;return i=await this.verify({data:{trackingSource:SE.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceVerify:t},preventCheckResetItem:s}),i}async doForceVerifyWithOtherForceVerify(e,t,s){let i=null;return this.syncZCloudQueueUIState.setForceSyncSource(t),this.Logger.zsymb(0,"2CW1MY","syncQueueByVerify, otherForceVerify",t),await aE.a.getInstance().removeAll(),i=await this.forceVerify({data:{trackingSource:SE.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceForceVerify:t},preventCheckResetItem:s}),i}async doVerifyWithServerCmd(e,t,s){let i=null;Object(jE.s)("doVerifyWithServerCmd",e,t,s);const{sourceForceVerify:n,sourceVerify:a}=await this.checkVerify(e);return n===LU.a.CMD_621_FORCE_RESET||n===LU.a.CMD_621_FORCE_VERIFY||n===LU.a.CMD_621_EMPTY_LAST_NOISEID?(this.Logger.zsymb(0,"ouI5Xc","syncQueueByVerify, sourceForceVerify",n),this.syncZCloudQueueUIState.setForceSyncSource(n),await aE.a.getInstance().removeAll(),i=await this.forceVerify({data:{trackingSource:SE.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceForceVerify:n},preventCheckResetItem:s})):a===LU.b.CMD_621_VERIFY&&(Object(jE.s)("doVerifyWithServerCmd, sourceVerify",a),i=await this.verify({data:{trackingSource:SE.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceVerify:a}})),i}async doVerify(e){const{data:t,syncStrategy:s,sourceVerify:i,otherForceVerify:n,preventCheckResetItem:a=!1}=e;let r=null;if(i?r=await this.doVerifyWithSourceVerify(s,i,a):n===LU.a.TOOL_CLIENT||n===LU.a.CMD_620_RESET_CLOUD||n==LU.a.SELF_VERIFY?r=await this.doForceVerifyWithOtherForceVerify(s,n,a):t&&(r=await this.doVerifyWithServerCmd(t,s,a)),r){var o,l,c;const{lastNoiseId:e}=r,t=Object(Ip.a)(r,PU);this.Logger.zsymb(0,"uYcXCW","syncQueueByVerify, after fetched & filtered actions, ","added clouds",null===(o=t.addClouds)||void 0===o?void 0:o.length,"deleted clouds",null===(l=t.delClouds)||void 0===l?void 0:l.length,"deleted thread",null===(c=t.delThreads)||void 0===c?void 0:c.length),await this.updateQueueService.updateQueue(Object(f.a)(Object(f.a)({},t),{},{lastNoiseId:e})),this.Logger.zsymb(0,"3RKbnw","syncQueueByVerify, done update db, lastNoiseId",e)}return r}async submitVerifyAction(e){try{await qE.a.submitVerifyAction({type:e})}catch(t){this.Logger.zsymb(18,"FXgN6M","submitVerifyAction",t)}}})||kU)||kU)||kU)||kU)||kU)||kU;var UU,BU=s("zCNv");async function xU(e){for(let t=0;t<e.length;t++){const s=e[t];BU.a.getInstance().log("queue",...BU.a.getLogArgFromCloudItem(s))}}let GU=Object(i.injectable)()(UU=Reflect.metadata("design:type",Function)(UU=Reflect.metadata("design:paramtypes",[])(UU=class extends RU{constructor(){super(),this.name=void 0,this.key=void 0,this.name=AU,this.key=AU}async updateQueue(e){const{delThreads:t,delClouds:s,addClouds:i,lastNoiseId:n}=e;return(null==i?void 0:i.length)>0&&(Object(jE.k)("add -------",i),await EE.a.getInstance().setCloudItems(i,!0),await xU(i)),(null==s?void 0:s.length)>0&&(Object(jE.k)("del -------",s),await EE.a.getInstance().removeCloudItems(s,!0),await xU(s)),(null==t?void 0:t.length)>0&&(Object(jE.k)("delThread -------",t),await EE.a.getInstance().delThreads(t,!0),await xU(t)),n&&await EE.a.getInstance().setLastNoiseId(n,Date.now(),{}),[]}})||UU)||UU)||UU;var zU;let VU=Object(i.injectable)()(zU=Reflect.metadata("design:type",Function)(zU=Reflect.metadata("design:paramtypes",[])(zU=class{constructor(){this.name=void 0,this.key=void 0,this.name=MU,this.key=MU}async fetchQueue(e){const{loadType:t,lastNoiseIds:s,trackingSource:i}=e;let{lastNoiseId:n}=e;const a={lastNoiseId:"",cloudItems:[]};let r=!0;for(;r;){var o;const{mediaItems:e,hasMore:l,lastNoiseId:c}=await qE.a.verifyCloudMedia(n,t,s,i);Object(jE.s)("fetchQueue",c,null==e?void 0:e.length,l);const d=null!=c?c:null===(o=e[0])||void 0===o?void 0:o.noiseId,u=e.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));a.cloudItems.unshift(...u),a.lastNoiseId=d,n=d,r=l}return a}async fetchQueueByPage(e){var t;const{lastNoiseId:s,lastNoiseIds:i,loadType:n,trackingSource:a}=e,r={lastNoiseId:"",cloudItems:[],hasMore:0},{mediaItems:o,lastNoiseId:l,hasMore:c}=await qE.a.verifyCloudMedia(s,n,i,a);Object(jE.s)("fetchQueueByPage",null==o?void 0:o.length,l,c);const d=null!=l?l:null===(t=o[0])||void 0===t?void 0:t.noiseId,u=o.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));return r.cloudItems=u,r.lastNoiseId=d,r.hasMore=c,r}})||zU)||zU)||zU;var HU=s("jqP8"),WU=s("Hvyc"),$U=s("Dr9L");const KU="zcloud-media-pc-fetcher",qU=Object(i.define)(KU),QU="zcloud-media-web-fetcher",ZU=Object(i.define)(QU);var JU;let YU=Object(Je.d)()(JU=Object(Je.g)()(JU=Object(Je.h)()(JU=Object(i.injectable)()(JU=function(e,t){return Object(i.inject)(qU)(e,void 0,0)}(JU=function(e,t){return Object(i.inject)(ZU)(e,void 0,1)}(JU=Reflect.metadata("design:type",Function)(JU=Reflect.metadata("design:paramtypes",[void 0===qU?Object:qU,void 0===ZU?Object:ZU])(JU=class extends HU.a{constructor(e,t){super(),this.pcFetcher=e,this.webFetcher=t,this.name=void 0,this.key=void 0,this.cleanupTimeoutId=void 0,this.name=WU.b,this.key=WU.b,this.cleanupTimeoutId=null}onSessionExpired(){this.cleanup()}onDispose(){this.cleanup()}onApplicationReady(){this.cleanup()}doCleanupAfterTimeout(e){e&&(this.cleanupTimeoutId=setTimeout((()=>{this.cleanup()}),e))}clearCleanupTimeoutId(){this.cleanupTimeoutId&&clearTimeout(this.cleanupTimeoutId)}async getCloudItem(e){const t=this.getCloudQueryByMessage(e);return t?this.getCloudItemByCloudQuery(t):null}async getDownloadUrl(e,t,s){return this.getUrl(e,t,s)}async getDownloadHeaders(){return this.getHeaders()}async fetch(e){const{cloud:t,message:s,options:i}=e,{type:n}=i,a=await this.getDownloadUrl(t.cloud,s,n),r=await this.getHeaders();if(!a||!r)throw $U.b.getError(Object(f.a)(Object(f.a)({},$U.a.INVALID_PARAMS),{},{message:"No cloud "+(a?"headers":"url")}));return this.webFetcher.fetch({url:a,headers:r,cloud:t.cloud,options:i})}async cleanup(){}})||JU)||JU)||JU)||JU)||JU)||JU)||JU)||JU;var XU=s("vBob");let eB;(eB||(eB={})).buildData=function(e){return ho.default.normalizeMessageType(e.msgInfo.msgType),R.MSG_FILE,function(e){var t,s;const{zKey:i,msgInfo:n,mediaInfo:a}=e,{msgType:r,destId:o}=n,l=ho.default.normalizeMessageType(r),c=Object(Nm.d)(null!=i?i:TE.a.getZCloudKeyFromCloudItem(e),l),d=TE.a.getConversationIdFromCloudItem(e,Rt.default.getUserId()),u=Object(wE.a)(o===mi.default.sendToMeId?null==a||null===(t=a.mediaExtInfo)||void 0===t?void 0:t.data:null==a||null===(s=a.mediaExtInfo)||void 0===s?void 0:s.decryptedData),{fileSize:h,checksum:g,fType:m,title:p,fileExt:f}=u,v=p||XU.a.NoNameFile,b=f||v.split(".").pop();return{fileName:v,localPath:c,conversationId:d,msgType:l,fileSize:h,checksum:g,fType:m,ext:b}}(e)};var tB=eB;const sB=["options"];var iB;let nB=Object(i.injectable)()(iB=Reflect.metadata("design:type",Function)(iB=Reflect.metadata("design:paramtypes",[])(iB=class{constructor(){this.name=void 0,this.key=void 0,this.name=KU,this.key=KU}async fetch(e){const{url:t,headers:s,cloud:i,options:n}=e,{options:a}=n,r=Object(Ip.a)(n,sB),o=Object.assign(a,{headers:s}),l=Object.assign(tB.buildData(i),{url:t});return nh.default.run(Object(f.a)(Object(f.a)({},r),{},{options:o,data:l}))}})||iB)||iB)||iB;var aB;let rB=Object(i.injectable)()(aB=Reflect.metadata("design:type",Function)(aB=Reflect.metadata("design:paramtypes",[])(aB=class{constructor(){this.name=void 0,this.key=void 0,this.name=QU,this.key=QU}async fetch(e){const{url:t,options:s}=e,i=null!=s&&s.options?Object(f.a)(Object(f.a)({},null==s?void 0:s.options),{},{headers:e.headers}):{headers:e.headers},n=null==s?void 0:s.queueType,a=null==s?void 0:s.onProgress;return Object(ln.h)(Object(ln.j)().toString(),t,n,a,i)}})||aB)||aB)||aB;const oB="zcloud-photo-fetcher",lB=Object(i.define)(oB);var cB=s("BDVO"),dB=s("LeFD"),uB=s("HOwT");const hB=null,gB=e=>nh.default.run(e),mB=e=>new Promise((async(t,s)=>{try{var i;const{url:a,localPath:r,timeout:o=6e4,maxTTFB:l=2e4,signal:c,noCacheRespFail:d,disableCache:u,msgId:h,entrySerial:g,mediaId:m,options:p,sendDttm:v}=e,b=hB.basename(r),I=hB.dirname(r),y=Object(f.a)({srcAction:u?nh.default.constants.srcAction.Manual:nh.default.constants.srcAction.Dev,saveDir:I,caching:!0,cacheResp:{noCacheRespFail:d},error:{handleError:!0},maxTTFB:l,mediaId:m},p),_={entrySerial:g,type:nh.default.constants.DownloadType.Photo,data:{url:a,fileName:b,msgId:h,sendDttm:v},options:y},C=()=>{s(new dB.a)};if(null!=c&&c.aborted)return C();null==c||c.addEventListener("abort",C);const O=setTimeout((()=>{s(new dB.d)}),o),E=await Object(im.a)(gB,_);if(null==c||c.removeEventListener("abort",C),clearTimeout(O),E.ok)return t(null);const M=E.error;if(!M)return s(new dB.f);const S="string"==typeof(null==M?void 0:M.code)||"number"==typeof(null==M?void 0:M.code)?null==M?void 0:M.code:null==M||null===(i=M.downloadError)||void 0===i?void 0:i.code;if(isNaN(S))return s(new dB.f(M.name));if(S>=75e3&&S<76e3){const e=S-75e3;if(Zm.a.image_loader.enable){var n;const t=null===(n=Zm.a.image_loader.retryErrorCodes)||void 0===n?void 0:n.some((t=>t===e));if(!!v&&t&&Object(cB.a)(v))return s(new uB.NotReadyError)}return s(new dB.c(e))}return s(1010==S?new dB.d:new dB.f(S))}catch(a){const e=new dB.f("[LoadPhotoPC]"+(null==a?void 0:a.message));return null!=a&&a.stack&&(e.stack=a.stack),s(e)}}));var pB;let fB=Object(i.injectable)()(pB=function(e,t){return Object(i.inject)(WU.a)(e,void 0,0)}(pB=Reflect.metadata("design:type",Function)(pB=Reflect.metadata("design:paramtypes",[void 0===WU.a?Object:WU.a])(pB=class extends HU.a{constructor(e){super(),this.mediaZCloudFetcher=e,this._responsesCache=new Map,this._blobURLReserveMap=new Map,this.name=void 0,this.key=void 0,this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(im.a)(mB,e),i=s.ok?t:"";if(s.ok)return{mediaURL:i,error:void 0};throw s.error},this._downloadWithRetry=se(this._downloadHandler,{min:Zm.a.image_loader.retryMin,max:Zm.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Zm.a.image_loader.lastTryDelayTime.min,max:Zm.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>e instanceof XF.a.NotReadyError||e instanceof XF.a.TimeoutTTFB||e instanceof XF.a.TimeoutError}),this.name=oB,this.key=oB}async fetchOnWeb(e,t){Object(Km.a)("string"==typeof t&&qm(t),`Media source must be a (http|https) URL. Got ${t}`);const s=this._responsesCache.get(t);if(s&&!s.isRevoked)return Sm.l.Success({mediaURL:this._responsesCache.get(t).blobURL});try{const s=Object(ln.j)().toString(),i=se(ln.h,{min:Zm.a.image_loader.retryMin,max:Zm.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Zm.a.image_loader.lastTryDelayTime.min,max:Zm.a.image_loader.lastTryDelayTime.max}}),n=await this.mediaZCloudFetcher.getDownloadHeaders(),a=await i(s,t,ln.a.dev,void 0,{useDiskCache:!1,headers:n});if(a.error)return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:a.error}});const r=this._responsesCache.get(t)||{};return this._cacheResponse(t,Object(f.a)(Object(f.a)({},r),{},{remoteURL:t,blobURL:a.data,mediaId:e,isRevoked:!1})),Sm.l.Success({mediaURL:a.data})}catch(i){return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:i}})}}_cacheResponse(e,t){this._responsesCache.set(e,t),this._blobURLReserveMap.set(t.blobURL,e)}async fetchOnPC(e,t,s){const{entrySerial:i,savePath:n}=s;if(n&&Object(Bm.a)(n))return Sm.l.Success({mediaURL:n});try{let a={url:t,mediaId:e,localPath:n,entrySerial:i,sendDttm:null==s?void 0:s.sendDttm,noCacheRespFail:(null==s?void 0:s.sendDttm)&&Object(cB.a)(null==s?void 0:s.sendDttm)};const r=await this.mediaZCloudFetcher.getDownloadHeaders(),o=s.autoDownload?{srcAction:nh.default.constants.srcAction.Auto,headers:r}:{headers:r};a.options=o;const l=await this._downloadWithRetry(a);return l.error?Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:l.error}}):Sm.l.Success({mediaURL:n})}catch(a){return Sm.l.Failure({code:Sm.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:a}})}}async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:i}=e;let n;Object(Km.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Km.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),n=Sm.j.MemoryCache;const a=qm(s),r=Qm(s);if(!a&&r)return Sm.l.Success({mediaURL:s});if(n===Sm.j.MemoryCache)try{return await this.fetchOnWeb(t,s)}catch(c){return Promise.reject(c)}Object(Km.a)("object"==typeof i&&"string"==typeof i.savePath&&!!i.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${i}`);const{savePath:o,downloadEntrySerial:l}=i;return this.fetchOnPC(t,s,{entrySerial:l,savePath:o})}})||pB)||pB)||pB)||pB;i.ModuleContainer.registerSingleton(IU.a,OU),i.ModuleContainer.registerSingleton(EU.b,NU),i.ModuleContainer.registerSingleton(FU,GU),i.ModuleContainer.registerSingleton(SU,VU),i.ModuleContainer.registerSingleton(WU.a,YU),i.ModuleContainer.registerSingleton(qU,nB),i.ModuleContainer.registerSingleton(ZU,rB),i.ModuleContainer.registerSingleton(lB,fB);var vB=s("hmll"),bB=s("NL/6");const IB=[{chord:`${R.CmdOrCtrl}${R.K_I}`,commandId:bB.a.FOCUS_MAIN_CHAT_INPUT_AT_ACTIVE_WINDOW,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.K_I}`,commandId:bB.a.APPLY_ITALIC_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.K_B}`,commandId:bB.a.APPLY_BOLD_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.K_U}`,commandId:bB.a.APPLY_UNDERLINE_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.Shift}${R.K_X}`,commandId:bB.a.TOGGLE_RTF_MODE,commandTitle:"",isMatchedContext:(e,t)=>!0}];i.ModuleContainer.register(vB.a,class{constructor(){this._keybindings=[],IB.forEach((e=>{this._keybindings.push({chord:e.chord,commandId:e.commandId,commandTitle:e.commandTitle,isMatchedContext:e.isMatchedContext,eventHandlers:[]})}))}registerEventHandlerByCommandId(e,t){return e&&t?(this._keybindings.forEach((s=>{s.commandId!==e||s.eventHandlers.includes(t)||s.eventHandlers.push(t)})),()=>{this._keybindings.forEach((s=>{s.commandId===e&&s.eventHandlers.includes(t)&&(s.eventHandlers=s.eventHandlers.filter((e=>e!==t)))}))}):()=>{}}loopkupKeybindingByCommandId(e){return e?this._keybindings.reduce(((t,s)=>(e===s.commandId&&t.push(s),t)),[]):[]}loopkupKeybindingByChord(e){return e?this._keybindings.reduce(((t,s)=>(e===s.chord&&t.push(s),t)),[]):[]}});var yB=s("XRso");i.ModuleContainer.register(yB.a,class{buildChord(e){let t="";return e&&this._isChord(e)&&((e.ctrlKey||e.metaKey)&&(t+=R.CmdOrCtrl),e.shiftKey&&(t+=R.Shift),e.altKey&&(t+=R.Alt),t+=e.keyCode||e.which),t}buildKeybindingContext(e,t){return e&&t?`${e}#${t}`:""}getChordByCommandId(e){return e===bB.a.TOGGLE_RTF_MODE?(Object(ji.d)()?"Cmd":"Ctrl")+" + Shift + X":""}_isOnlyModifier(e){return["Shift","Control","Alt","Meta"].includes(e.key)}_isOnlyNonModifier(e){return!(e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)}_isChord(e){return!(this._isOnlyModifier(e)||this._isOnlyNonModifier(e))}});var _B=s("GNMY"),CB=s("sGG0");var OB,EB=s("72EQ"),MB=s("v+vz"),SB=s("F1+M"),TB=s("XbxG"),wB=s("U/XY");function RB(){if(!mi.default.profile.cover.randomUrls.length)return"";const{randomUrls:e}=mi.default.profile.cover;return e[Math.floor(Math.random()*e.length)]}Object(Je.g)()(OB=Object(ko.b)(_B.a)(OB=Reflect.metadata("design:type",Function)(OB=Reflect.metadata("design:paramtypes",[])(OB=class{constructor(){this.name=_B.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._randomCoverSrc=RB(),this._logger=void 0,this.type=void 0,this.data=new Map}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(this.name,["personal-controller"])),this._logger}init(e){this.didInit||(this._fetchReceiveFriendList(),i.ModuleContainer.resolve(yh.o).addEventListener(yh.n.ReceiveAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(yh.o).addEventListener(yh.n.UndoAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(yh.o).addEventListener(yh.n.AcceptAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(yh.o).addEventListener(yh.n.RejectAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(yh.o).addEventListener(yh.n.UndoSentRequestFriendEvent,this.invitationEventHandler.bind(this)),this.didInit=!0)}onDispose(){rS.a.getInstance().removeAll()}bindDispatch(e){this._dispatch=e,Fi.default.subscribe(this.eventHandler.bind(this)),this._randomCoverSrc=RB()}unbind(){this._dispatch=null,this._genMessageServer=null,this.data.clear(),Fi.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"7TVuV0","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}clearState(e){this.data.has(e)&&this.data.delete(e)}_signalUpdate(e){Object(hs.h)(_B.b,e)}_updateData(e,t,s){const i=this.data.get(e);i?this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{[t]:i&&i[t]?ho.default.deepMerge(i[t],s):s})):this.data.set(e,{[t]:s,version:0}),this._signalUpdate(e)}_udapteInfoData(e,t,s=!0){var i;const n=this.data.get(e);return s&&null!=n&&null!==(i=n.info)&&void 0!==i&&i.avatar&&(t.avatar=n.info.avatar),this._updateData(e,"info",t)}_updateVersion(e){const t=this.data.get(e);t?this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{version:t.version+1})):this.data.set(e,{version:0}),this._signalUpdate(e)}getCover(e){var t;const s=null===(t=this.data.get(e))||void 0===t?void 0:t.info;if(s){const e=s.cover;return e&&e==mi.default.profile.cover.defaultUrl?this._randomCoverSrc||mi.default.profile.cover.defaultUrl:e}return this._randomCoverSrc||mi.default.profile.cover.defaultUrl}async getUserInfo(e,t=!1){const s=Object(f.a)({},ns.default.getProfileFriendByIdSync(e));this._udapteInfoData(e,s);const i=async()=>{try{const t=await ns.default.getProfileFriendById(e,R.SRC_GET_PROFILE.FORCE_GET);return ns.default.isFriend(e)||this.getStatusFriendRequest(e),t&&(MB.y(e)&&Fi.default.send(Ai.FetchActions.UDPATE_BUSINESS_INFO,{user:t}),this._udapteInfoData(e,t,!1)),this.getFullAvatar(e),t}catch(t){return this.Logger.zsymb(0,"bU1vbv","[getUserInfo]",t),ns.default.getProfileFriendByIdSync(e)}};return t||!this.data.has(e)||!s||Object.keys(s).length<=4?i():s}async getExtraInfo(e){try{const t=await gh.a.getProfileExtra(e,ns.default.getUidMe());if(t){(e=>{if(e.bkPhotos&&e.photos&&e.photos.length)for(let t=0;t<e.photos.length;t++){const s=e.photos[t],i=e.bkPhotos[t];rS.a.getInstance().setBackup(s,i)}})(t);const s=(e=>{const t=e.photos?e.photos.map(((t,s)=>({url:t,meta:e.photoMetas&&e.photoMetas[s]}))):[];let s=[];return e.groupIds&&e.groupIds.length>0&&e.groupIds.forEach((e=>{xo.a.checkHiddenChatByPureGroupId(e)||s.push(e)})),{mutualGroups:s,photos:t}})(t);return this._updateData(e,"extra",s),!0===t.fetched&&this.dispatch({type:Ai.ConversationListActions.FORCE_UPDATE_MUTUAL_GROUP_ITEM,payload:e}),s}}catch(s){var t;this.Logger.zsymb(0,"sf-pyL","[getExtraInfo]",s),this._updateData(e,"extra",(null===(t=this.data.get(e))||void 0===t?void 0:t.extra)||{})}return null}async getFullAvatar(e,t=!1){const s=(t,s)=>{rS.a.getInstance().setBackup(t,s),this._updateData(e,"info",{fullAvatar:t})},i=async()=>{try{const t=await MB.k(e);t&&s(t.full_avatar,t.bk_full_avatar)}catch(t){if(this.Logger.zsymb(18,"OqgUjX","fetch full avatar error:",t),n){if(ho.default.isWeb()){let e=n.url;return e&&s(e),e}{let e=n.path;if(await Object(EB.a)(e))return s("file://"+e),"file://"+e}}}};let n=Rt.default.getProfileAvatar(e);if(t||!n)return i();{let e=n.ts;if(Date.now()-3e5>e)return i();if(ho.default.isWeb()){let e=n.url;return s(e),e}{let e=n.path;Object(EB.a)(e).then((t=>t?(s("file://"+e),"file://"+e):i()))}}}async getProfileRank(e){try{const t=await gh.a.getProfileRank(e,ns.default.getUidMe());return this._updateData(e,"rank",t),t}catch(s){var t;this.Logger.zsymb(0,"INpR8-","[getProfileRank]",s),this._updateData(e,"rank",(null===(t=this.data.get(e))||void 0===t?void 0:t.rank)||{})}return null}async getStatusFriendRequest(e){const t=async()=>{try{await Li.a.getStatusFriendRequest(e,!1)}catch(t){}};let s=rt.p.getFriendRequestStatus(e);if(s){let e=s.ts;e&&e>-1&&e<Date.now()-2e3&&t()}else t()}async _fetchReceiveFriendList(e=!1){let t=mh.a.getRecommendedFriendsSync();if(!Object.keys(t).length||e)try{t=await mh.a.getRecommendedFriendsV2(!0,!0)}catch(i){this.Logger.zsymb(0,"d5DqOV","_fetchReceiveFriendList [ERROR]",t)}const s=Object.keys(t);s.length&&s.forEach((e=>{var s,i,n;(null===(s=t[e])||void 0===s||null===(i=s.dataInfo)||void 0===i?void 0:i.recommType)===Lh.RECEIVE&&(this._cachedFriendRequest[e]=null===(n=t[e])||void 0===n?void 0:n.dataInfo)}))}getRequestInfo(e){return this._cachedFriendRequest[e]}async toggleBlock(e,t){var s;const i=this.data.get(e),n=(null==i||null===(s=i.info)||void 0===s?void 0:s.isBlocked)||ns.default.isBlocked(e);as.default.logAction(1460207);try{const s=await ns.default.blockFriend(e,n?R.UNSET_BLOCK:R.SET_BLOCK);return wB.c(t,n?"STR_UNBLOCK_USER_TOAST_SUCCESS":"STR_BLOCK_USER_TOAST_SUCCESS"),i&&this._updateData(e,"info",{isBlocked:!n}),n||as.default.logAction(146020701),this.dispatch({type:Ai.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!n,userId:e}}),s}catch(a){this.Logger.zsymb(18,"Uk7SkJ","toggleBlock",a),wB.c(t,n?"STR_UNBLOCK_USER_TOAST_FAIL":"STR_BLOCK_USER_TOAST_FAIL")}}async toggleRemoveFriend(e,t){as.default.logAction(1460206);try{const s=await MB.C(e);return Rt.default.removeNewFriend(e),Rt.default.removeFriend(e).then((t=>{Fi.default.send(Ai.PopupActions.TOGGLE_REMOVE_FRIEND,e)})),this.dispatch({type:Ai.FetchActions.FRIENDS_REMOVED,payload:e}),wB.c(t,"STR_DELETE_SUCCESS"),s}catch(s){this.Logger.zsymb(18,"gSSrL9","toggleRemoveFriend",s)}}async toggleShareContact(e,t){const s=this.data.get(e),i=await Object(SB.c)([e]);as.default.logAction(1460205);let n="",a="";s&&s.info&&(n=s.info.avatar,a=s.info.displayName);let r={message:{action:"recommened.user",description:JSON.stringify({qrCodeUrl:i[e]}),params:e,thumb:n,title:a},msgType:R.MSG_CONTACT,windowId:t};Fi.default.send(Ai.PopupActions.SHARE_MSG,r)}showImage(e,t,s=aM.l.ProfileAvatar){var i;let n=null===(i=this.data.get(e))||void 0===i?void 0:i.info;if(!n)return;const a={user:ns.default.getProfileMeSync(),userId:e,conversation:Object(f.a)({},n),isVideo:!1,selectedId:null,isProfileImg:!0,href:t,appConfig:Object(mi.getPVConfigs)(),source:s};ho.default.isWeb()||(a.appConfig={enable_feature_alias:mi.default.enable_feature_alias,enable_stranger_alias:mi.default.enable_stranger_alias}),Co.a.OpenPhoto.openPhotoViewer(a)}voiceCall(e,t){const s=this.data.get(e);if(as.default.logAction(10643),as.default.logActionInfo(as.FeaturesInfo.BusinessAccount,1460203,[e,ns.default.isFriend(e)?0:1]),!Jl.c.isSupport()||null==s||!s.info)return;if(Jl.c.isCalling())return void wB.b(t,void 0,os.a.trans(Jl.b.IN_CALL));const i=s.info;var n;ho.default.isWeb()||(n=e,Rt.default.getConversation(n)).then((t=>{let s={lastSmsLocalId:t?t.lastSmsLocalId:null,displayName:i.displayName,userId:e},n=[s.userId];Jl.c.makeCall(n,!1,!1,(e=>{this._genMessageServer&&this._genMessageServer(s,e),e.caller&&e.duration>0&&TB.b.updateLastActionTime(s.userId,this.dispatch,-1,TB.a.CALL)}))}))}jumpToConversation(e){let t=this.data.get(e);if(!t||!t.info)return;i.ModuleContainer.resolve(Ii.b).openConversation(e,Ii.c.fromProfileInfo(t.info));const s=ns.default.isFriend(e);as.default.logActionInfo(as.FeaturesInfo.BusinessAccount,1460204,[e,s?1:0]),ss.ModalManagerV2.closeAllModal()}async undoFriendRequest(e){as.default.logAction(146020802);try{return await Li.a.undoRequestAddFriend(e),i.ModuleContainer.resolve(yh.o).dispatchEvent(new yh.p(yh.n.UndoSentRequestFriendEvent,null,e)),this.getUserInfo(e),!0}catch(t){t&&t.error_message&&wB.a(t.error_message)}return!1}async addFriend(e,t){const s=this.data.get(e);return!(!s||!s.info||s.info.isBlocked)&&(Li.a.isYouRequestMe(e)?(as.default.logAction(146020801),i.ModuleContainer.resolve(uh.b).acceptFriendRequest(e,t),Rt.default.getAcceptNewFriend(s)):as.default.logAction(1460208),!0)}async sendFriendRequest(e,t,s,i){const n=Li.a.getFriendRequestSource(e);try{await Li.a.requestAddFriend(e,s,n,t),this.dispatch({type:Ai.ChatBoxActions.SEND_FRIEND_REQUEST,payload:e}),Fi.default.send(Ai.SideBarActions.SENT_FRIEND_REQUEST,e),wB.c(t,"STR_REQ_FR_SUCCESS"),Rt.default.setStrangerCache(e,1),CB.a.callUpdate(e,i)}catch(a){this.Logger.zsymb(18,"YZJkDm","sendFriendRequest",a),a&&a.error_message&&wB.a(t,a.error_message),Rt.default.setStrangerCache(e,0)}}openLink(e){mR.b.open(e)}eventHandler(e,t){switch(e){case Ai.FetchActions.STATUS_BLOCKED_CHANGED:if(t){this.data.has(t)&&this._updateData(t,"info",{isBlocked:ns.default.isBlocked(t)})}break;case Ai.FetchActions.UPDATE_NAME:if(t)if(t.constructor===Object){this.data.has(t.userId)&&this.getUserInfo(t.userId)}else if(t.constructor===Array)for(const[e,s]of Object.entries(this.data)){t.includes(e)&&this.getUserInfo(e)}break;case Ai.FetchActions.USERID_FETCHED:case Ai.FetchActions.PROFILE_ME_FETCHED:{const e=ns.default.getUidMe();t&&this._udapteInfoData(e,Object(f.a)(Object(f.a)({},t),{},{isBlocked:!1,isFr:!0}),!this.data.has(t.userId)),this.data.has(t.userId)&&this.getFullAvatar(t.userId,!0);break}case Ai.FetchActions.FRIEND_REQUEST_UPDATE:t&&this.data.has(t.userId)&&this._updateVersion(t.userId);break;case Ai.ConversationListActions.BLOCK_CONVERSATION:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{isBlocked:t.blocked});break;case Ai.FriendListActions.UPDATE_EXTRA_PROFILE_CACHE:t&&t.userId&&this.data.has(t.userId)&&this.getExtraInfo(t.userId);break;case Ai.GeneralActions.NETWORK_STATUS_CHANGED:break;case Ai.FriendsAction.FRIENDS_CHANGE_INFO:if(t)for(const e of t)this.data.has(e.userId)&&this.getUserInfo(e.userId)}}invitationEventHandler(e){switch(e.type){case yh.n.ReceiveAddFriendEvent:Array.isArray(e.payload)&&e.payload.forEach((e=>{const t=e.dataInfo.userId;e&&e.dataInfo&&(this._cachedFriendRequest[t]=e.dataInfo,this.data.has(t)&&this._updateVersion(t))}));break;case yh.n.UndoAddFriendEvent:case yh.n.AcceptAddFriendEvent:case yh.n.RejectAddFriendEvent:case yh.n.UndoSentRequestFriendEvent:this._cachedFriendRequest[e.payload]&&(delete this._cachedFriendRequest[e.payload],this.data.has(e.payload)&&this._updateVersion(e.payload))}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||OB)||OB)||OB);var LB,DB=s("786D");Object(ko.b)(DB.a)(LB=Reflect.metadata("design:type",Function)(LB=Reflect.metadata("design:paramtypes",[])(LB=class{constructor(){this.name=DB.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._connectClose=[],this._logger=void 0,this.type=void 0,this.data=new Map,this.eventHandler=this.eventHandler.bind(this)}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(this.name,["group-controller"])),this._logger}init(e){this.didInit||(this.didInit=!0)}clearState(e){this.data.has(e)&&this.data.delete(e)}bindDispatch(e){this._dispatch=e,Fi.default.subscribe(this.eventHandler)}unbind(){this._dispatch=null,this._genMessageServer=null,this._connectClose=[],this.data.clear(),Fi.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"l_j7Dt","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}connectCloseModalCallback(e){this._connectClose.push(e)}_updateData(e,t,s){const i=this.data.get(e);i?this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{[t]:i&&i[t]?ho.default.deepMerge(i[t],s):s})):this.data.set(e,{[t]:s}),Object(hs.h)(DB.b,e)}_udapteInfoData(e,t){var s;const i=this.data.get(e);return null!=i&&null!==(s=i.info)&&void 0!==s&&s.avatar&&(t.avatar=i.info.avatar),this._updateData(e,"info",t)}async getGroupInfo(e){const t=async()=>{try{const t=await Zo.default.getFullInfoGroupById(e,R.SRC_GET_PROFILE.FORCE_GET);return t&&this._udapteInfoData(e,t),t}catch(t){return this.Logger.zsymb(0,"naTIig","[getGroupInfo]",t),Zo.default.getGroupByIdSync(e,void 0)}},s=Zo.default.getGroupByIdSync(e,void 0);return this.data.has(e)?(this._udapteInfoData(e,s),s):(this._udapteInfoData(e,s),await t())}selectConversation(e){const t=this.data.get(e);if(t){as.default.logAction(1460204),this.dispatch({type:Ai.ConversationListActions.SELECT_CONVERSATION,payload:t}),gh.a.openConversation(e);const s=rt.p.getSelectConversationSource();s&&as.default.logAction(s)}ss.ModalManagerV2.closeAllModal()}async addGroupAdmin(e,t,s){try{return await Zo.default.addGroupAdmin(t,s),!0}catch(i){if(this.Logger.zsymb(18,"5bkm3U","[addGroupAdmin] error",i),!i)return;if(i.error_code){let s="";switch(i.error_code){case 161:s=os.a.str(xh.a.get("STR_GROUP_NO_EXIST",t));break;case 166:s=os.a.str(xh.a.get("STR_GROUP_NO_PERMISION",t));break;default:s=os.a.str(xh.a.get("STR_ADD_ADMIN_TOAST_UNSUCCESS",t))+" ("+i.error_code+")"}wB.a(e,void 0,s)}else i.code&&"ERR_NO_NETWORK"===i.code&&wB.a(e,"STR_CONNECTION_ERROR")}return!1}async changeGroupOwner(e,t,s,i=!1){var n;let a=!1;const r=(null===(n=Zo.default.getGroupByIdSync(t))||void 0===n?void 0:n.topMember)||[];for(const c of r)if(c.id===s){a=!0;break}if(!a)return void wB.b(os.a.trans(xh.a.get("STR_NO_LONGER_MEMBER_IN_GROUP",t),MB.h(s)));let o=t;o&&o.startsWith(R.GROUPID_PREFIX)&&(o=o.slice(1));try{return await uo.default.changeGroupOwner(o,s),this._updateData(t,"info",{creatorId:s}),this.dispatch({type:Ai.ConversationListActions.UPDATE_GROUP_OWNER,payload:{userId:t,creatorId:s}}),i&&await this.leaveGroup(e,o),!0}catch(l){return wB.a(e,xh.a.get("STR_CHANGE_GROUP_OWNER_FAIL",t)),!1}}async leaveGroup(e,t){try{await uo.default.leaveGroup(t)}catch(s){s&&"ERR_NO_NETWORK"==s.code&&wB.a(e,"STR_CHECK_NET")}}eventHandler(e,t){switch(e){case Ai.FetchActions.UPDATE_NAME:t.constructor===Object&&this.data.has(t.userId)?this.getGroupInfo(t.userId):t.constructor===Array&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case Ai.FetchActions.GROUP_UPDATED:if(t){let{topMember:e=[],userId:i,isGroup:n}=t;const a=this.data.get(i);if(a&&n){var s;let t=null===(s=a.info)||void 0===s?void 0:s.topMember;(null==e?void 0:e.length)>0&&(t=e),this._updateData(i,"info",{topMember:t}),this.getGroupInfo(i)}}break;case Ai.FetchActions.UPDATE_GROUP_SETTING:if(t&&t.data){let e=t.data.groupId;if(e&&(e=R.GROUPID_PREFIX+e,this.data.has(e))){var i,n;const s=t.data.groupSetting||(null===(i=this.data.get(e))||void 0===i||null===(n=i.info)||void 0===n?void 0:n.setting);this._updateData(e,"info",{newSetting:s})}}break;case Ai.GroupsAction.GROUPS_CHANGE_INFO:t&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case Ai.FetchActions.DELETE_CONVERSATION:case Ai.FetchActions.GROUP_LEAVE:this.data.has(t)&&this._connectClose.forEach((e=>e()));break;case Ai.ConversationListActions.UPDATE_GROUP_OWNER:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{creatorId:t.creatorId})}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||LB)||LB);var AB;Object(Je.i)()(AB=Object(Je.g)()(AB=Object(ko.b)(jM.ProfileVerificationController)(AB=Reflect.metadata("design:type",Function)(AB=Reflect.metadata("design:paramtypes",[])(AB=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.handleProfileVerificationChange=e=>{e===vM.b.VERIFIED&&this.onFinishVerification()},this.name=jM.PROFILE_VERIFICATION_CONTROLLER,this.key=jM.PROFILE_VERIFICATION_CONTROLLER,this.data=new Map}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.profile,[this.name])),this.logger}get userId(){return rt.p.getSessionUserId()}init(){}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"X5i8sX","Get data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"B2n1I9","Get data list failed",e)}onStart(){ns.default.subscribeEventFriend(R.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){ns.default.unsubscribeEventFriend(R.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}signalUpdateItem(e){Object(hs.h)(this.name,e)}requestUnblockStage(e,t){t>0&&e.step.isBlocking&&setTimeout((()=>{const t=Object(f.a)({},e);t.step.isBlocking=!1,this.data.set(t.key,t),this.signalUpdateItem(t.key)}),t)}createVerificationStage(e,t){return{key:this.userId,step:{stage:t,blockingTs:yn.default.getTimeNow()+e,isBlocking:e>0}}}async sendOAVerificationMessage(e,t){let s=this.data.get(this.userId);try{await ns.default.pushVerificationMessage(t,e),s=this.createVerificationStage(0,"sent")}catch(n){var i;this.Logger.zsymb(18,"Se6QE7","send oa verify fail",n);const e=null==n?void 0:n.error_code,t=(null==n||null===(i=n.data)||void 0===i?void 0:i.next_action_allowed_at)||0;let a,r=0;switch(e){case vM.c.UNAVAILABLE:r=Math.max(t-yn.default.getTimeNow(),0),a="unavailable";break;case vM.c.FAILED:r=Math.max(t-yn.default.getTimeNow(),0),a="failure";break;default:r=mi.default.profile.verification.send_oa_delay,a="failure"}s=this.createVerificationStage(r,a),this.requestUnblockStage(s,r)}this.data.set(this.userId,s),this.signalUpdateItem(this.userId)}onFinishVerification(){this.data.delete(this.userId)}})||AB)||AB)||AB)||AB);var FB;Object(ko.b)(YC.d)(FB=Reflect.metadata("design:type",Function)(FB=Reflect.metadata("design:paramtypes",[])(FB=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.genId=void 0,this.name=YC.a,this.key="userId",this.data=new Map,this.genId=new xi.a}init(){throw new Error("Method not implemented.")}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.reportV2,[this.name])),this.logger}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"4y2gF1","Get report abuse data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"nmqHdo","Get report abuse data list failed",e)}signalUpdateItem(e){Object(hs.h)(this.name,e)}getOrCreateItem(e){let t=this.data.get(e);return t||(t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]}),t}onOpenReport(e){mi.default.report_v2.enable&&this.Logger.zsymb(0,"SIb3fR","open report",e)}onReportDidOpen(e){if(mi.default.report_v2.enable&&!this.data.has(e)){const t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]};this.data.set(e,t),this.signalUpdateItem(e)}}onCloseReport(e){this.data.has(e)&&(this.cleanUpItem(e),Object(hs.f)(this.name,e),this.Logger.zsymb(0,"RFRhhf","close report",e))}cleanUpItem(e){const t=this.data.get(e);t&&(t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.delete(e))}toggleAttachment(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{expandAttachment:!t.expandAttachment})),this.signalUpdateItem(e)}selectReason(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{reasonId:t})),this.signalUpdateItem(e)}onSelectedPhotos(e,t){const s=this.getOrCreateItem(e),i=t.map((({blob:e,filename:t,type:s})=>({blob:e,id:this.genId.next(),url:URL.createObjectURL(e),filename:t,type:s})));this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedPhotos:s.selectedPhotos.concat(i)})),this.signalUpdateItem(e)}onDeselectPhoto(e,t){const s=this.getOrCreateItem(e),i=[...s.selectedPhotos],n=i.findIndex((e=>e.id===t));if(n>=0){i.splice(n,1).forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedPhotos:i})),this.signalUpdateItem(e)}}clearAllAttachedPhotos(e){const t=this.getOrCreateItem(e);t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedPhotos:[]})),this.signalUpdateItem(e)}onSelectedMessages(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedMessages:t})),this.signalUpdateItem(e)}clearAllAttachedMessages(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedMessages:[]})),this.signalUpdateItem(e)}changeDescription(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{description:t})),this.signalUpdateItem(e)}})||FB)||FB);var jB,PB=s("7upJ");Object(i.singleton)(YC.e)(jB=Reflect.metadata("design:type",Function)(jB=Reflect.metadata("design:paramtypes",[])(jB=class{constructor(){this.logger=void 0,this.name=void 0,this.name=YC.b}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.reportV2,[this.name])),this.logger}getRelatedStatus(e){return{blocked:ns.default.isBlocked(e),unfriended:!ns.default.isFriend(e)}}async blockAfterReport(e){try{await ns.default.blockFriend(e,R.SET_BLOCK)}catch(t){throw this.Logger.zsymb(18,"HwuEOh","block after report failed",e,t),t}}async unfriendAfterReport(e){try{await ns.default.removeFriend(e)}catch(t){throw this.Logger.zsymb(18,"0umC-d","unfriend after report failed",e,t),t}}getReportReasonFromId(e,t){const s=PB.a.getSortedAbuseList(e);if(!Array.isArray(s))return null;const i=s.find((e=>e.id===t));return i?i[os.a.getCurrentLanguageName()]:null}getContentMessageToReport(e){const{message:t,msgType:s}=e;if("object"==typeof t)switch(s){case R.MSG_LINK_CLIENT:case R.MSG_CONTACT:return t.title||t.href;case R.MSG_PHOTO:case R.MSG_PHOTO_2:case R.MSG_PHOTO_GROUP:case R.MSG_VIDEO:return t.oriUrl||t.title;case R.MSG_VOICE:return t.href;default:return t.title}return t}async submitReport(e){const t=new FormData,s={idTo:e.userId,objId:"person.profile",reason:String(e.reasonId),content:e.description};if(e.selectedPhotos.length){const i=e.selectedPhotos.map((e=>({filename:e.filename,type:e.type})));s.imgList=JSON.stringify(i),e.selectedPhotos.forEach((({blob:e},s)=>{t.append(`img${s}`,e)}))}if(e.selectedMessages.length){const t=e.selectedMessages.map((e=>({gmi:e.msgId,msg:this.getContentMessageToReport(e)}))).filter((({msg:e})=>!!e));s.msgList=JSON.stringify(t)}t.append("params",encodeURIComponent(ho.default.encodeAES(JSON.stringify(s))));try{const s=await uo.default.reportUserV2(t);this.Logger.zsymb(0,"z2hdDk","submit success",e.userId,s)}catch(i){throw this.Logger.zsymb(18,"m28BdN","submit failed",e.userId,i),i}}})||jB)||jB);var kB=s("BpN3"),NB=s("UJhs");function UB(e){return"object"==typeof e&&!!e&&e.hasOwnProperty("loading")&&"boolean"==typeof e.loading&&e.type in NB.c&&e.hasOwnProperty("data")&&"object"==typeof e.data&&!!e.data}const BB="SEND_INPUT_PREVIEW",xB={[BB]:{feature:as.FeaturesInfo.InputBoxPreview,subType:1}};var GB=function(e){return e[e.Chat=1]="Chat",e[e.Group=2]="Group",e[e.MyCloud=3]="MyCloud",e[e.OA=4]="OA",e}(GB||{});class zB{}zB.actionlogSendPreview=e=>{requestIdleCallback((()=>{try{var t;if(!e.length)return;const n=e.filter((e=>e.type===NB.c.PHOTO));if(!n.length)return;let a;const r=null==n||null===(t=n[0])||void 0===t?void 0:t.toUid;a=Object(MB.z)(r)?GB.OA:ho.default.isGroup(r)?GB.Group:Object(MB.f)()===r?GB.MyCloud:GB.Chat;const o=e.length,l=[];for(let e=0;e<n.length;e++){var s,i;const t=n[e],a={photo_position:e+1,caption_length:(null==t||null===(s=t.caption)||void 0===s?void 0:s.length)||0,is_caption_form:null!=t&&null!==(i=t.caption)&&void 0!==i&&i.length?1:0};l.push(a)}const c={total_item_in_group:o,caption_info:l,chat_type:a};zB._actionlogSendInputPreview(BB,c)}catch(n){Me.dangerouslyLogConsole.error("InputPreviewActionLog.logSendPreview",n)}}),{timeout:5e3})},zB._actionlogSendInputPreview=async(e,t)=>{const s=xB[e].feature,i=xB[e].subType;as.default.logActionInfoV2(s,i,t)};var VB,HB=zB;Object(i.injectable)()(VB=Object(ko.b)(kB.b)(VB=class{constructor(){this._eventEmitter=new Op.a,this.totalPhotoSize=0,this.addPreviewItem=e=>{var t;Object(Q.a)(function(e){return UB(e)&&e.type!==NB.c.PLACEHOLDER}(e),"invalid item for input preview, must be InputPreviewData");const s=e,n=s.data,a=n.toUid,r=this.mayInitState(a),o=null!==(t=s.previewId)&&void 0!==t?t:n.clientId,l=r.oriItems.length>0?[...r.oriItems]:[...r.items],c=l.findIndex((e=>e.previewId===o)),d=s.data.clientId;(this.removedItems.get(a)||new Set).has(d)||(e.type===NB.c.PHOTO&&(i.ModuleContainer.resolve(_p.b).trackTempBlob(e.data.clientId,e.data.img),this.trackPhotoSize(e)),-1!==c?l[c]=Object(f.a)(Object(f.a)(Object(f.a)({},r.items[c]),s),{},{previewId:o}):l.push(s),this.data.set(a,Object(f.a)(Object(f.a)({},r),{},{items:l,oriItems:l})),Object(hs.h)(this.name,a),this.emit("ON_ADD_INPUT_PREVIEW",{conversationId:a}))},this.getOrderedItemsForSending=e=>{const t=this.getOrderedItems(e).map((e=>e&&e.type===NB.c.GIF?Object(f.a)(Object(f.a)({},e),{},{type:NB.c.PHOTO}):e));return HB.actionlogSendPreview(t.map((e=>Object(f.a)({},e)))),t},this.removePreviewItemById=(e,t)=>{const s=this.data.get(e);if(!s)return;const i=s.items.filter((e=>e.data.clientId!==t)),n=s.oriItems.filter((e=>e.data.clientId!==t)),a=s.items.filter((e=>e.data.clientId===t));for(let r of a)this.untrackPhotoSize(r);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:i,oriItems:n})),Object(hs.h)(this.name,e)},this.trackPhotoSize=e=>{var t;e.type===NB.c.PHOTO&&(this.totalPhotoSize+=(null===(t=e.data.file)||void 0===t?void 0:t.size)||0)},this.untrackPhotoSize=e=>{var t;e.type===NB.c.PHOTO&&(this.totalPhotoSize=Math.max(0,this.totalPhotoSize-((null===(t=e.data.file)||void 0===t?void 0:t.size)||0)))},this.name=kB.a,this.data=new Map,this.removedItems=new Map,this.key="conversationId"}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter.emit(e,t)}get isOverInputPreviewMemoryLimit(){return this.totalPhotoSize>=mi.default.file_photo_limit.maxInputPreviewMemory}canAddPreviewItem(e){if(this.isOverInputPreviewMemoryLimit)return!1;return this.totalPhotoSize+e<mi.default.file_photo_limit.maxInputPreviewMemory}hasPreviewItems(e){const t=this.data.get(e);return!!t&&t.items.length>0}selectItem(e,t){if(!e||!t)return;const s=this.mayInitState(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedItem:t})),Object(hs.h)(this.name,e)}selectPreviousItem(e){const t=this.mayInitState(e),s=t.items,i=t.selectedItem;if(!i)return;const n=s.findIndex((e=>e.data.clientId===i.cliMsgId));if(-1===n)return;const a=Math.max(n-1,0);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedItem:s[a]})),Object(hs.h)(this.name,e)}selectNextItem(e){const t=this.mayInitState(e),s=t.items,i=t.selectedItem;if(!i)return;const n=s.findIndex((e=>e.data.clientId===i.cliMsgId));if(-1===n)return;const a=Math.min(n+1,s.length-1);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedItem:s[a]})),Object(hs.h)(this.name,e)}addPlaceholder(e,t){Object(Q.a)("string"==typeof e&&!!e,"conversationId must be string"),Object(Q.a)("object"==typeof t&&!(null==t||!t.clientId),"invalid item for input preview placeholder");const s=this.mayInitState(e),i={loading:!0,type:NB.c.PLACEHOLDER,previewId:t.clientId,data:{clientId:t.clientId}};this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:[...s.items,i],oriItems:[...s.oriItems,i]})),Object(hs.h)(this.name,e)}getPreviewItemsCount(e){var t,s;return null!==(t=null===(s=this.data.get(e))||void 0===s?void 0:s.items.length)&&void 0!==t?t:0}getOrderedItems(e){const t=this.data.get(e);if(!t)return[];let s=[];const i=t.oriItems.filter((e=>{const t=e.type!==NB.c.PLACEHOLDER;return t&&s.push(e.data.clientId),t})).map((e=>{var s;const i=(null===(s=t.caption[e.data.clientId])||void 0===s?void 0:s.saved)||"",n=Object(f.a)(Object(f.a)({},e.data),{},{caption:i});return Object(f.a)(Object(f.a)({},e),{},{data:n})}));s=s.sort(((e,t)=>e-t));return i.map(((e,t)=>Object(f.a)(Object(f.a)({},e.data),{},{clientId:s[t]})))}getRawOrderedItems(e){const t=this.data.get(e);return t?t.oriItems:[]}updateOrder(e,t){const s=this.mayInitState(e);Object(Q.a)(Array.isArray(t),`invalid items for input preview at ${e}`),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{oriItems:t})),Object(hs.h)(this.name,e)}removePreviewItem(e,t){const s=this.data.get(e);if(!s)return;const n=[...s.items],a=[...s.oriItems],r=n[t];if(!r)return;const o=a.indexOf(r);n.splice(t,1),-1!==o&&a.splice(o,1),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:n,oriItems:a})),r.type===NB.c.PHOTO&&(URL.revokeObjectURL(r.data.img),i.ModuleContainer.resolve(_p.b).removeTrackTempBlob(r.data.clientId),this.untrackPhotoSize(r)),Object(hs.h)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}removeAllItems(e,t=!1){const s=this.data.get(e);if(!s)return;const n=this.removedItems.get(e)||new Set;if(!t)for(let a of s.items)n.add(a.data.clientId),a.type===NB.c.PHOTO&&(URL.revokeObjectURL(a.data.img),i.ModuleContainer.resolve(_p.b).removeTrackTempBlob(a.data.clientId),this.untrackPhotoSize(a));this.removedItems.set(e,n),this.data.delete(e),Object(hs.h)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}saveDraft(e,t,s){const i="string"==typeof s?s.trimStart().trimEnd():"",n=this.mayInitState(e);Object(Q.a)(!!n,`invalid state when saveDraft for conversationId ${e}`),Object(Q.a)("string"==typeof i,`invalid draft for conversationId ${e}`);let a=n.caption[t]||{saved:"",draft:""};if(a.saved===i&&a.draft===i)return;a=Object(f.a)(Object(f.a)({},a),{},{draft:i});const r=Object(f.a)(Object(f.a)({},n.caption),{},{[t]:a}),o=new Set(n.unsavedChanges);a.saved!==a.draft?o.add(t):o.delete(t),this.data.set(e,Object(f.a)(Object(f.a)({},n),{},{caption:r,unsavedChanges:Array.from(o)})),Object(hs.h)(this.name,e)}applyDraft(e,t){return Object(Q.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.applyDraftSingle(e,t):this.applyDraftMulti(e)}resetSelectedItem(e){if(!e)return;const t=this.mayInitState(e);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedItem:null})),Object(hs.h)(this.name,e)}applyDraftSingle(e,t){const s=this.mayInitState(e);Object(Q.a)(!!s,`invalid state when addCaption for conversationId ${e}`);let i=s.caption[t];if(!i||i.saved===i.draft)return;const n=i.draft||"";i=Object(f.a)(Object(f.a)({},i),{},{saved:n});const a=Object(f.a)(Object(f.a)({},s.caption),{},{[t]:i}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{caption:a,unsavedChanges:Array.from(r)})),Object(hs.h)(this.name,e)}applyDraftMulti(e){const t=this.mayInitState(e);Object(Q.a)(!!t,`invalid state when addCaption for conversationId ${e}`);const s=Object(f.a)({},t.caption);Object.keys(s).forEach((e=>{const t=s[e];if(!t||t.saved===t.draft)return;const i=t.draft||"";s[e]=Object(f.a)(Object(f.a)({},t),{},{saved:i})}));const i=Object(f.a)(Object(f.a)({},t),{},{caption:s,unsavedChanges:[]});this.data.set(e,i),Object(hs.h)(this.name,e)}discardDraftedCaption(e,t){return Object(Q.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.discardDraftedCaptionSingle(e,t):this.discardDraftedCaptionMulti(e)}discardDraftedCaptionSingle(e,t){const s=this.mayInitState(e);if(!s)return;const i=s.caption[t];if(!i||!i.draft)return;const n=s.caption[t],a=Object(f.a)(Object(f.a)({},s.caption),{},{[t]:Object(f.a)(Object(f.a)({},n),{},{draft:null==n?void 0:n.saved})}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{caption:a,unsavedChanges:Array.from(r)})),Object(hs.h)(this.name,e)}discardDraftedCaptionMulti(e){let t=this.data.get(e);if(!t)return;const s=Object(f.a)({},t.caption);if(s)for(const i in s)s[i].draft=s[i].saved;t=Object(f.a)(Object(f.a)({},t),{},{caption:s,unsavedChanges:[]}),this.data.set(e,t),Object(hs.h)(this.name,e)}getCaption(e,t){return this.mayInitState(e).caption[t]}_listenEvents(){}mayInitState(e){let t=this.data.get(e);return t||(t={conversationId:e,items:[],oriItems:[],selectedItem:null,caption:{},unsavedChanges:[]},this.data.set(e,t)),t}init(){this._listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||VB);var WB=s("ONNR"),$B=s("1Q0E");const KB={network:{avgRequest:40,default:{hit:50},items:{file:{hit:80},"/keepalive":{hit:5}}},database:{avgRequest:300,default:{hit:100},items:{"Core.Message":{hit:500}}}};var qB=1e3;function QB(e,t){switch(t){case"byte-to-mb":return e/1024/1024;case"kb-to-mb":return e/1024;default:return}}var ZB=s("fOVY"),JB=s("XnIt"),YB=s("CaBZ"),XB=s("mHfx");let ex,tx;try{ex=$znode.fs,tx=$znode.path}catch(m$){}async function sx(e){return new Promise((t=>{try{ex.readdir(e,(async(s,i)=>{if(s)return t(0);let n=0;for(let t=0;t<i.length;t++){const s=i[t],a=tx.join(e,s),r=ex.statSync(a);if(Object(XB.a)(r)){n+=await sx(a)}n+=r.size}t(n)}))}catch(s){t(0)}}))}var ix,nx=new class{constructor(){this.lastFrameTime=0,this.fps=0,this.pause=!0}loop(e){if(this.pause)return;const t=e;if(0===this.lastFrameTime)return this.lastFrameTime=t,void requestAnimationFrame(this.loop.bind(this));const s=t-this.lastFrameTime;s>0&&(this.fps=Math.round(1e3/s),this.lastFrameTime=t),requestAnimationFrame(this.loop.bind(this))}start(){this.pause=!1,requestAnimationFrame(this.loop.bind(this))}stop(){this.lastFrameTime=0,this.fps=0,this.pause=!0}get value(){return this.fps}};const ax="z_m_h_",rx="z_m_h_i___",ox={CPU:!0,GPU:!0,RAM:!0,FPS:!0,"JS Heap":!0,"Root Render":!0,LCP:!0};Object(ko.b)($B.b)(ix=Object(i.injectable)()(ix=Object(i.singleton)()(ix=Reflect.metadata("design:type",Function)(ix=Reflect.metadata("design:paramtypes",[])(ix=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.isStarted=!1,this.userId=void 0,this.monitorItems=[],this.showMonitorItems=new Map,this.rootRenderInitTime=Sr.a.now(),this.rootRenderNumber=1,this.lcpMetric=void 0,this.intervalCheck=void 0,this.intervalCheckSteps=0,this.data={isShowZPCHealth:!1,monitorItemForUIs:[]},this.usageMonitor=void 0,this.name=$B.a,this.key=$B.a}initialize(e){this.isStarted||(this.isStarted=!0,function(){const e=i.ModuleContainer.resolve(YB.b);e.registerMonitorItem({expectedOrderPosition:1,title:"Database",description:"Cache & IndexedDB",getValue:async()=>{var e,t,s;let i=(null===(e=await(null===(t=navigator.storage)||void 0===t||null===(s=t.estimate)||void 0===s?void 0:s.call(t)))||void 0===e?void 0:e.usage)||0;return i=Math.round(QB(i,"byte-to-mb")||0),i},getType:e=>e>=200&&e<=500?"medium":e>500?"high":"low",getContent:e=>Object(ZB.a)(e," MB"),checkSteps:10}),e.registerMonitorItem({expectedOrderPosition:2,title:"DOM",description:"DOM nodes",getValue:()=>document.getElementsByTagName("*").length||0,getType:e=>e>=3e3&&e<=6e3?"medium":e>6e3?"high":"low",getContent:e=>Object(ZB.a)(e," nodes"),checkSteps:2}),!ji.l&&e.registerMonitorItem({expectedOrderPosition:3,title:"Temp Files",description:"ZaloTemp & zTemp",getValue:async()=>{try{const e=await Object(zL.getZaloTempDir)(),t=await sx(e),s=await Object(zL.getzTempDir)(),i=await sx(s);return Math.round(QB(t+i,"byte-to-mb")||0)}catch(e){return 0}},getType:e=>e>=50&&e<=100?"medium":e>100?"high":"low",getContent:e=>Object(ZB.a)(e," MB"),checkSteps:100}),e.registerMonitorItem({expectedOrderPosition:6,title:"Custom Domains",description:"Count custom domains usage",getValue:async()=>{const e=i.ModuleContainer.resolve(JB.a).getDomainConfig();let t=0;if(!e)return t;for(const s in e)e.hasOwnProperty(s)&&e[s].useDevDomain&&t++;return t},getType:e=>"low",getContent:e=>Object(ZB.a)(e,""),checkSteps:2})}());const t=this.getStorage().getItem(ax);this.data.isShowZPCHealth="1"===t;const s=this.getStorage().getItem(rx);if(s){s.split(",").forEach((e=>{e&&this.showMonitorItems.set(e,1)}))}this.data.isShowZPCHealth&&Object(Vc.d)()&&(Object(WB.a)((e=>{this.lcpMetric=e}),{reportAllChanges:!0}),this.userId=e,this.startHealthCheck())}destroy(){this.stopHealthCheck()}registerMonitorItem(e){const t=`${e.expectedOrderPosition||""}_${e.title.replace(" ","")}`,s=Object(f.a)(Object(f.a)({},e),{},{id:t});this.monitorItems.push(s),this.monitorItems=this.monitorItems.sort(((e,t)=>e.expectedOrderPosition&&t.expectedOrderPosition?e.expectedOrderPosition-t.expectedOrderPosition:0))}addRootRender(){this.data.isShowZPCHealth&&Object(Vc.d)()&&this.rootRenderNumber++}resetRootRender(){this.rootRenderNumber=1}startHealthCheck(){this.intervalCheck||(nx.start(),this.getMonitorItems(this.userId),this.intervalCheck=setInterval((()=>{this.getMonitorItems(this.userId),this.intervalCheckSteps++}),qB))}stopHealthCheck(){nx.stop(),this.rootRenderNumber=1,this.intervalCheck&&(clearInterval(this.intervalCheck),this.intervalCheck=void 0,this.intervalCheckSteps=0)}toggleZPCHealth(){this.data.isShowZPCHealth=!this.data.isShowZPCHealth,this.getStorage().setItem(ax,this.data.isShowZPCHealth?"1":"0"),this.data.isShowZPCHealth||this.stopHealthCheck(),Object(hs.h)(this.name,"")}getMonitorList(){return this.monitorItems.map((e=>({id:e.id,title:e.title,isShow:!(!this.showMonitorItems.get(e.id)&&!ox[e.title])})))}showZPCHealthItem(e,t){if(!e)return;t?this.showMonitorItems.set(e,1):this.showMonitorItems.delete(e);let s="";this.showMonitorItems.forEach(((e,t)=>{s+=t+","})),this.getStorage().setItem(rx,s),this.stopHealthCheck(),this.startHealthCheck()}async getMonitorItems(e){var t,s,i,n;const a=ji.l?[]:await $zperf.getCpuInfos();let r=0,o=0,l=0;null==a||a.forEach((e=>{var t,s;const i=(null==e||null===(t=e.cpu)||void 0===t?void 0:t.percentCPUUsage)||0,n=(null==e||null===(s=e.memory)||void 0===s?void 0:s.workingSetSize)||0;"GPU"!==e.type?(r+=i,l+=n):o+=i})),r=Math.round(r),o=Math.round(o),l=Math.round(QB(l,"kb-to-mb")||0);let c=(null===(t=performance.memory)||void 0===t?void 0:t.usedJSHeapSize)||0;c=Math.round(QB(c,"byte-to-mb")||0);const d=nx.value;let u=(null===(s=await(null===(i=navigator.storage)||void 0===i||null===(n=i.estimate)||void 0===n?void 0:n.call(i)))||void 0===s?void 0:s.usage)||0;u=Math.round(QB(u,"byte-to-mb")||0);const h=Math.round((Sr.a.now()-this.rootRenderInitTime)/1e3/60)||1,g=Math.round(this.rootRenderNumber/h),m=[...[{id:"0_CPU",title:"CPU",description:"CPU usage",getValue:()=>r,getType:e=>e>=20&&e<=40?"medium":e>40?"high":"low",getContent:e=>Object(ZB.a)(e," %"),checkSteps:2},{id:"0_GPU",title:"GPU",description:"GPU usage",getValue:()=>o,getType:e=>e>=10&&e<=30?"medium":e>30?"high":"low",getContent:e=>Object(ZB.a)(e," %"),checkSteps:2},{id:"0_FPS",title:"FPS",description:"Frame Per Second",getValue:()=>d,getType:e=>e>=20&&e<=30?"medium":e<20?"high":"low",getContent:e=>Object(ZB.a)(e),checkSteps:1},{id:"0_RAM",title:"RAM",description:"RAM usage",getValue:()=>l,getType:e=>e>=500&&e<=1e3?"medium":e>1e3?"high":"low",getContent:e=>Object(ZB.a)(e," MB"),checkSteps:2},{id:"0_JSHeap",title:"JS Heap",description:"JS Heap usage",getValue:()=>c,getType:e=>e>=200&&e<=300?"medium":e>300?"high":"low",getContent:e=>Object(ZB.a)(e," MB"),checkSteps:2},{id:"0_RootRender",title:"Root Render",description:"Root Render in minutes",getValue:()=>g,getType:e=>e>=10&&e<=20?"medium":e>20?"high":"low",getContent:e=>Object(ZB.a)(e," times / minute"),checkSteps:2},{id:"0_LCP",title:"LCP",description:"Largest Contentful Paint",getValue:()=>{var e;return Math.round(((null===(e=this.lcpMetric)||void 0===e?void 0:e.value)||0)/1e3)},getType:e=>{var t;switch(null===(t=this.lcpMetric)||void 0===t?void 0:t.rating){case"poor":return"high";case"needs-improvement":return"medium";default:return"low"}},getContent:e=>Object(ZB.a)(e," s"),checkSteps:2}],...this.monitorItems],p=[];for(let I=0;I<m.length;I++){const t=m[I];let s=!1;s=!(!this.showMonitorItems.get(t.id)&&!ox[t.title]);let i,n,a=0;var f,v,b;if(s)if(this.data.monitorItemForUIs[I]&&this.intervalCheckSteps%(t.checkSteps||1)!=0)i=this.data.monitorItemForUIs[I].type,n=this.data.monitorItemForUIs[I].content;else a=await(null===(f=t.getValue)||void 0===f?void 0:f.call(t,e))||0,i=null===(v=t.getType)||void 0===v?void 0:v.call(t,a),n=null===(b=t.getContent)||void 0===b?void 0:b.call(t,a);const r={id:t.id,title:t.title,description:t.description,type:i,content:n,isShow:s,checkTime:(t.checkSteps||1)*qB};p.push(r)}this.data.monitorItemForUIs=p,Object(hs.h)(this.name,"")}getStorage(){return E.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||ix)||ix)||ix)||ix);var lx=s("zdwi");const cx="1",dx={windowId:cx,name:"ZPC_HEALTH"},ux={windowId:cx,name:"METRICS"};var hx,gx=s("Igfx"),mx=s("noAy");const px="z_m_h_f_",fx="z_m_h_r_",vx="z_m_h_r_w_";Object(ko.b)(lx.a)(hx=Object(i.injectable)()(hx=Object(i.singleton)()(hx=function(e,t){return Object(i.inject)(mx.b)(e,void 0,0)}(hx=Reflect.metadata("design:type",Function)(hx=Reflect.metadata("design:paramtypes",[void 0===mx.b?Object:mx.b])(hx=class{constructor(e){this.resourceWarning=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1,isShowRenderingDebugger:!1,isShowReactiveLogger:!1,isShowResourceWarning:!1},this.observeRendering=void 0,this.name=lx.b,this.key=lx.b}initialize(){if(!Object(Vc.d)())return;this.observeRendering=this.observeRendering?this.observeRendering:Object(Vc.f)(),ss.ModalManagerV2.addModal(Object(f.a)(Object(f.a)({},dx),{},{altWindowId:void 0})),ss.ModalManagerV2.subscribeTriggers({windowId:cx,name:dx.name,trigger:e=>{}});const e=this.getStorage().getItem(px);var t;(this.data.isShowRenderingDebugger="1"===e,"1"===e)&&(null===(t=this.observeRendering)||void 0===t||t.observe());const s=this.getStorage().getItem(fx);this.data.isShowReactiveLogger="1"===s,this.data.isShowReactiveLogger?gx.a.enable():gx.a.disable();const i=this.getStorage().getItem(vx);this.data.isShowResourceWarning=null!==i?"1"===i:this.data.isShowResourceWarning,this.data.isShowResourceWarning?this.resourceWarning.enable():this.resourceWarning.disable(),Object(hs.h)(this.name,"all")}destroy(){0}showZPCHealthPopup(e){Object(Vc.d)()&&(e?ss.ModalManagerV2.openModal(Object(f.a)(Object(f.a)({},dx),{},{windowId:cx,params:null})):ss.ModalManagerV2.closeModal(Object(f.a)(Object(f.a)({},dx),{},{windowId:cx})),this.data.isShow=e,Object(hs.h)(this.name,"all"))}setIsShowRenderingDebugger(e){var t,s;(this.data.isShowRenderingDebugger=e,this.getStorage().setItem(px,e?"1":"0"),e)?null===(t=this.observeRendering)||void 0===t||t.observe():null===(s=this.observeRendering)||void 0===s||s.disconnect();Object(hs.h)(this.name,"all")}setIsShowReactiveLogger(e){this.data.isShowReactiveLogger=e,this.getStorage().setItem(fx,e?"1":"0"),e?gx.a.enable():gx.a.disable(),Object(hs.h)(this.name,"all")}setIsShowResourceWarning(e){this.data.isShowResourceWarning=e,this.getStorage().setItem(vx,e?"1":"0"),e?this.resourceWarning.enable():this.resourceWarning.disable(),Object(hs.h)(this.name,"all")}getStorage(){return E.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||hx)||hx)||hx)||hx)||hx);var bx,Ix=s("Bwur");Object(ko.b)(Ix.b)(bx=Object(i.injectable)()(bx=Object(i.singleton)()(bx=Reflect.metadata("design:type",Function)(bx=Reflect.metadata("design:paramtypes",[])(bx=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1},this.name=Ix.a,this.key=Ix.a}initialize(){Object(Vc.d)()&&(ss.ModalManagerV2.addModal(Object(f.a)(Object(f.a)({},ux),{},{altWindowId:void 0})),ss.ModalManagerV2.subscribeTriggers({windowId:cx,name:ux.name,trigger:e=>{}}))}destroy(){0}showMetricsPopup(e){Object(Vc.d)()&&(e?ss.ModalManagerV2.openModal(Object(f.a)(Object(f.a)({},ux),{},{windowId:cx,params:null})):ss.ModalManagerV2.closeModal(Object(f.a)(Object(f.a)({},ux),{},{windowId:cx})),this.data.isShow=e,Object(hs.h)(this.name,"all"))}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||bx)||bx)||bx)||bx);var yx=s("1UUk");class _x{constructor(e){this._queue=void 0,this._maxSize=void 0,this._queue=[],this._maxSize=null==e?void 0:e.maxSize}enqueue(e){this._maxSize&&this._queue.length>=this._maxSize&&this._queue.shift(),this._queue.push(e)}dequeue(){return this._queue.shift()}peek(){return this._queue[0]}isEmpty(){return 0===this._queue.length}get length(){return this._queue.length}clear(){this._queue=[]}toArray(){return this._queue}}var Cx,Ox=s("WZ0o");const Ex="requests / second",Mx=1e3;Object(ko.b)(mx.b)(Cx=Object(i.injectable)()(Cx=Object(i.singleton)()(Cx=function(e,t){return Object(i.inject)(yx.b)(e,void 0,0)}(Cx=Reflect.metadata("design:type",Function)(Cx=Reflect.metadata("design:paramtypes",[void 0===yx.a?Object:yx.a])(Cx=class{constructor(e){this.databaseManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={network:{totalRequestInLiveTime:0,queue:new _x,hitCount:0,error:void 0},database:{totalRequestInLiveTime:0,queue:new _x,hitCount:0,error:void 0}},this.warningConfigs=KB,this.isEnable=void 0,this.initTime=void 0,this.timeoutSignals={},this.enableLogEachRequest=void 0,this.hitQueue=new _x({maxSize:20}),this.observePerformance=void 0,this.name=mx.a,this.key=mx.a,this.dbQueryExecListener=this.dbQueryExecListener.bind(this)}enable(){Object(Vc.d)()&&(this.isEnable||(this.isEnable=!0,this.setup()))}disable(){var e;this.isEnable=!1,null===(e=this.observePerformance)||void 0===e||e.disconnect(),this.databaseManager.removeEventListener(Ye.b.QueryExec,this.dbQueryExecListener),this.resetData()}getData(){return this.data}resetNetworkError(){this.data.network.totalRequestInLiveTime=0,this.data.network.error=void 0,Object(hs.h)(this.name,"all")}resetDatabaseError(){this.data.database.totalRequestInLiveTime=0,this.data.database.error=void 0,Object(hs.h)(this.name,"all")}setWarningConfigs(e){this.warningConfigs=e}setEnableLogEachRequest(e){this.enableLogEachRequest=e}getHitQueue(){return this.hitQueue}setup(){this.initTime=Object(Vc.h)(),this.observePerformance=this.observePerformance?this.observePerformance:Object(Ox.b)(["resource"],this.listenObservePerformance.bind(this)),this.observePerformance.observe(),this.databaseManager.addEventListener(Ye.b.QueryExec,this.dbQueryExecListener)}listenObservePerformance(e){let t=e.filter((e=>"resource"===e.entryType)).filter((e=>"xmlhttprequest"===e.initiatorType));if(0!==t.length){this.dequeueQueue(this.data.network.queue);for(let e=0;e<t.length;e++){const s=t[e],i={url:s.name,path:Object(ZB.b)(s.name),ts:Object(Vc.h)()};this.data.network.queue.enqueue(i),this.data.network.totalRequestInLiveTime++,this.enableLogEachRequest}this.slowHandleWarning("network",this.data.network,(()=>this.getWarningDetail("network",this.data.network.queue,(e=>{var t;return(null===(t=e.url)||void 0===t?void 0:t.startsWith("file://"))?"file":`${e.path}`}))))}}dbQueryExecListener(e){const t=e.data;if(!t)return;this.dequeueQueue(this.data.database.queue);const s={database:t.database,method:t.method,table:t.table,ts:Object(Vc.h)()};this.data.database.queue.enqueue(s),this.data.database.totalRequestInLiveTime++,this.enableLogEachRequest,this.slowHandleWarning("database",this.data.database,(()=>this.getWarningDetail("database",this.data.database.queue,(e=>`${e.database}.${e.table}`))))}dequeueQueue(e){const t=e.peek();if(t&&t.ts){if(!(Object(Vc.h)()-t.ts>Mx))return;e.dequeue(),this.dequeueQueue(e)}}slowHandleWarning(e,t,s){this.timeoutSignals[e]||(this.timeoutSignals[e]=setTimeout((()=>{const i=s();this.handleWarning(e,t,i),this.timeoutSignals[e]=void 0}),500))}handleWarning(e,t,s){const i=this.warningConfigs[e].default,n=this.warningConfigs[e].items,a=this.warningConfigs[e].avgRequest,r=i.hit;let o,l,c;const d=s.sorted;for(let u=0;u<d.length;u++){const[e,t]=d[u],i=n[e];if(i){if(t>=i.hit){o=`HIT. ${t} ${Ex} (${e})`,l=JSON.stringify(d),c=JSON.stringify(s.meta);break}}else if(t>=r){o=`HIT. ${t} ${Ex} (${e})`,l=JSON.stringify(d),c=JSON.stringify(s.meta);break}}if(!o&&this.initTime){let e=t.totalRequestInLiveTime/((Object(Vc.h)()-this.initTime)/Mx);e=Math.round(e),e>=a&&(o=`AVG. ${e} ${Ex}`)}o&&(t.hitCount++,t.error={code:400,message:o,description:l,meta:c,ts:Date.now()},this.hitQueue.enqueue(Object(f.a)(Object(f.a)({},t.error),{},{type:e})),Object(hs.h)(this.name,"all"))}getWarningDetail(e,t,s){const i={};let n="database"===e?{}:void 0;t.toArray().forEach((e=>{const t=s(e);n&&e.method&&(n[e.method]?n[e.method]++:n[e.method]=1),i[t]?i[t]++:i[t]=1}));return{sorted:Object.entries(i).sort((([,e],[,t])=>t-e)),meta:n}}resetData(){this.initTime=void 0,this.data.network.totalRequestInLiveTime=0,this.data.network.queue.clear(),this.data.network.hitCount=0,this.data.network.error=void 0,this.data.database.totalRequestInLiveTime=0,this.data.database.queue.clear(),this.data.database.hitCount=0,this.data.database.error=void 0;for(let e in this.timeoutSignals)this.timeoutSignals[e]&&clearTimeout(this.timeoutSignals[e]);Object(hs.h)(this.name,"all")}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Cx)||Cx)||Cx)||Cx)||Cx);Object(Vc.d)()&&(window.$zpcHealth||(window.$zpcHealth={}),window.$zpcHealth.resourceWarningController=i.ModuleContainer.resolve(mx.b));const Sx={maxRetry:3};var Tx,wx,Rx,Lx,Dx,Ax,Fx,jx=s("Hk5Z"),Px=s("Y3Ul"),kx=s("kuNG"),Nx=s("5miw");Tx=Object(i.injectable)(),wx=Object(i.singleton)(jx.a),Ux=([e])=>e,Rx=(e,t,s)=>{const i=s.value,n=new Map;s.value=async function(...e){const t=Ux(e);let s=n.get(t);return s||(s=i.apply(this,e),s.finally((()=>n.delete(t))),n.set(t,s)),s}},Lx=Reflect.metadata("design:type",Function),Dx=Reflect.metadata("design:paramtypes",[void 0===Nx.RemoteURL?Object:Nx.RemoteURL]),Tx(Ax=wx((Fx=class{constructor(){this.responseCache_=void 0}async convert(e){if(!e||"string"!=typeof e)return Px.a.Error({error:new Error("Invalid Remote URL!")});if("blob:"===e.slice(0,5))return Px.a.Success({blobURL:e});this.responseCache_||(this.responseCache_=this.getCacheLazily_());if(this.responseCache_.has(e)){const t=this.responseCache_.get(e);return Px.a.Success({blobURL:t.blobURL})}try{const t=se(fetch,{min:1e3,max:5e3,retries:3,afterRetry:async({success:e})=>{}}),s=await t(e),i=await s.blob(),n=URL.createObjectURL(i);return this.responseCache_.set(e,{remoteURL:e,blobURL:n}),Px.a.Success({blobURL:n})}catch(t){return Px.a.Error({error:t})}}revokeBlobUrl_(e){URL.revokeObjectURL(e)}getCacheLazily_(){return new he.default({maxSize:Object(kx.a)().config.max_bu_cache_size,onEviction:(e,t)=>{this.revokeBlobUrl_(t.blobURL)}})}},Object(gj.a)(Fx.prototype,"convert",[Rx,Lx,Dx],Object.getOwnPropertyDescriptor(Fx.prototype,"convert"),Fx.prototype),Ax=Fx))||Ax);var Ux;const Bx=Object(i.define)("InternalEventBus");var xx;Object(i.injectable)()(xx=Object(i.singleton)(Bx)(xx=class extends Fe.b{})||xx);const Gx=Object(i.define)("AIStickerMapper");function zx(e,t="token"){if("number"!=typeof e||Number.isNaN(e))throw Error(`${t}=${e} is invalid!`);return e}class Vx{constructor(e,t,s,i,n){this.id=void 0,this.rootStickerCateId=void 0,this.url=void 0,this.width=void 0,this.height=void 0,this.id=zx(e,"id"),this.rootStickerCateId=zx(t,"rootStickerCateId"),this.url=function(e,t="token"){if(!e)throw Error(`${t}=${e} is invalid!`);return e}(s,"url"),this.width=zx(i,"width"),this.height=zx(n,"height")}equals(e){return this.id===e.id}}var Hx;s("SF1S");Object(i.injectable)()(Hx=Object(i.singleton)(Gx)(Hx=class{toAIStickerDTOFromDomain(e){return{id:e.id,url:e.url,thumb:"",type:TT.f.AI_GENERATED,intrinsicWidth:e.width,intrinsicHeight:e.height,renderedWidth:e.width,renderedHeight:e.height,animatable:!1}}toEntityFromSchema(e){return new Vx(e.id,e.rootStickerCateId,e.url,e.width,e.height)}toSchemaFromEntity(e){return{id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height}}})||Hx);const Wx=Object(i.define)("AIStickerAPIClient");var $x;let Kx=Object(i.injectable)()($x=class{forwardAIStickerMessage(e,t,s,i,n,a){return uo.default.apiForwardMessage(e,R.MSG_PHOTO,t,s,i,n,a)}fetchAIStickerList(){const e={imei:Xl.a.getZaloClientID()},t=`${di.b.getStickerDomain()}/api/message/sticker/ai/list?${this.getCommonParams_()}&params=${this.encodeParams_(e)}`;return new Promise(((e,s)=>{this.makeGETRequest_(t,null,12190).then(gu.a).then(e).catch(s)}))}makeGETRequest_(e,t,s,i,n,a,r,o,l){return pu.default._get(e,t,s,i,n,a,r,o,l)}getCommonParams_(){return pu.default._getCommonParams()}encodeParams_(e){return pu.default.getEncodedParams(e)}})||$x;i.ModuleContainer.register(Wx,Kx);const qx=Object(i.define)("AIStickerLocalStorageDB");var Qx;Object(Je.e)()(Qx=Object(i.injectable)()(Qx=Object(i.singleton)(qx)(Qx=Reflect.metadata("design:type",Function)(Qx=Reflect.metadata("design:paramtypes",[])(Qx=class{constructor(){this.tableName_="ai_sticker_tbl_1706849065515"}onAuthenticated(e){}async countAsync(){const e=await this.getRecords_();return e?e.length:0}async getAsync(e){var t;const s=await this.getRecords_();return s&&null!==(t=s.find((t=>t.id===e)))&&void 0!==t?t:null}async getAllAsync(){return await this.getRecords_()}async insertMultiAsync(e){var t;const s=null!==(t=await this.getRecords_())&&void 0!==t?t:[],i=[];e.forEach((e=>{const t=s.findIndex((t=>t.id===e.id));-1===t?i.push(e):s[t]=e}));const n=[...s,...i];return await this.writeRecords_(n),e}async delete(e){let t=await this.getRecords_();return!t||(t=t.filter((t=>t.id!==e)),await this.writeRecords_(t),!0)}async deleteAll(){return await this.writeRecords_([]),!0}async destroyAsync(){const e=this.getLocalStorageDB_();await e.removeItemForCurrentUserAsync(this.tableName_)}async getMultiAsync(e){throw new Error("Method not implemented yet!")}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async deleteMulti(e){throw new Error("Method not implemented yet!")}getLocalStorageDB_(){return E.default.getInstance()}async getRecords_(){const e=this.getLocalStorageDB_(),t=await e.getItemForCurrentUserAsync(this.tableName_);return t?JSON.parse(t):null}async writeRecords_(e){const t=this.getLocalStorageDB_(),s=JSON.stringify(e);await t.setItemForCurrentUserAsync(this.tableName_,s)}})||Qx)||Qx)||Qx)||Qx);const Zx=Object(i.define)("AIStickerRepository");var Jx;Object(i.injectable)()(Jx=Object(i.singleton)(Zx)(Jx=function(e,t){return Object(i.inject)(qx)(e,void 0,0)}(Jx=Reflect.metadata("design:type",Function)(Jx=Reflect.metadata("design:paramtypes",[Object])(Jx=class{constructor(e){this.aiStickerDB_=void 0,this.aiStickerDB_=e}getFakeAIStickers_(){const e=[];return e.push(new Vx(1,123,"https://media-ten.z-cdn.me/oXS0nzgaaTQAAAAl/pyonium-cute.webp",498,498)),e.push(new Vx(2,123,"https://media-ten.z-cdn.me/krDtrF9w1wYAAAAl/chinese-dragon-dragon.webp",498,498)),e.push(new Vx(3,123,"https://media-ten.z-cdn.me/XwHQ_iIQT6MAAAAl/dragon-ball.webp",360,360)),e}async getAllAsync(){return this.getFakeAIStickers_()}async countAsync(){return this.aiStickerDB_.countAsync()}async deleteAll(){return this.aiStickerDB_.deleteAll()}async delete(e){return this.aiStickerDB_.delete(e)}async insertMultiAsync(e){const t=e.map((e=>({id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height})));return await this.aiStickerDB_.insertMultiAsync(t),e}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async getAsync(e){throw new Error("Method not implemented yet!")}async find(e){throw new Error("Method not implemented yet!")}})||Jx)||Jx)||Jx)||Jx);var Yx=s("xvqP");var Xx=s("VLUZ");let eG=function(e){return e.SETUP_AI_STICKER_LIST_UPDATER="SETUP_AI_STICKER_LIST_UPDATER",e.FETCH_AI_STICKER_LIST="FETCH_AI_STICKER_LIST",e.FORWARD_AI_STICKER_MESSAGE="FORWARD_AI_STICKER_MESSAGE",e}({});class tG extends Fe.a{constructor(e,t){super(eG.SETUP_AI_STICKER_LIST_UPDATER),this.expiredTime=void 0,this.version=void 0,this.expiredTime=e,this.version=t}}class sG extends Fe.a{constructor(e,t){super(eG.FETCH_AI_STICKER_LIST),this.onCompleted=void 0,this.onFailed=void 0,this.onCompleted=null!=e?e:()=>{},this.onFailed=null!=t?t:()=>{}}}class iG extends Fe.a{constructor(e,t,s){super(eG.FORWARD_AI_STICKER_MESSAGE),this.payload=void 0,this.onCompleted=void 0,this.onFailed=void 0,this.payload=null!=e?e:{},this.onCompleted=null!=t?t:()=>{},this.onFailed=null!=s?s:()=>{}}}var nG;Object(i.injectable)()(nG=Object(Je.e)()(nG=Object(i.singleton)(Yx.c)(nG=function(e,t){return Object(i.inject)(Wx)(e,void 0,0)}(nG=function(e,t){return Object(i.inject)(Bx)(e,void 0,1)}(nG=Reflect.metadata("design:type",Function)(nG=Reflect.metadata("design:paramtypes",[Object,Object])(nG=class{constructor(e,t){this.apiClient_=void 0,this.internalEventBus_=void 0,this.apiClient_=e,this.internalEventBus_=t}onAuthenticated(e){this.internalEventBus_.addEventListener(eG.FETCH_AI_STICKER_LIST,this.handleFetchAPIStickerListEvent_.bind(this)),this.internalEventBus_.addEventListener(eG.FORWARD_AI_STICKER_MESSAGE,this.handleForwardAPIStickerMessageEvent_.bind(this))}getAIStickerList(){return new Promise(((e,t)=>{const s=t=>{e({errorCode:Xx.a.SUCCESS,data:{expiredTime:t.expired_time,version:t.version,stickers:t.stickers.map((e=>({id:e.id,url:e.url,width:e.width,height:e.height,rootStickerCateId:e.cateid_root})))}})},i=t=>{e({errorCode:Xx.a.FAIL,data:void 0})};this.apiClient_.fetchAIStickerList().then(s).catch((e=>{this.requestErrorHandler_(e,this.getAIStickerList).then(s).catch(i)}))}))}handleForwardAPIStickerMessageEvent_(e){const{payload:t,onCompleted:s,onFailed:i}=e,n=t.retryTimeout?{count:mi.default.retryConfig.max_retry_count,timeout:t.retryTimeout,timestamp:Date.now(),lowPriority:t.lowPriority}:null,a=Rd.a.newReq();this.apiClient_.forwardAIStickerMessage(t.toUid,t.messageContent,t.clientMsgId,n,a,t.additional).then(s).catch(i)}handleFetchAPIStickerListEvent_(e){this.getAIStickerList().then(e.onCompleted).catch(e.onFailed)}requestErrorHandler_(e,t,s=0){return new Promise(((i,n)=>{if(s>=1)return n(e);let a=-1;switch(e?e.error_code||e.code:"UNKNOWN"){case 112:a=5e3;break;case"ERR_NO_NETWORK":case"ERR_CONNECTION_TIMED_OUT":a=1e4;break;default:a=-1}if(a<0)return n(e);setTimeout((()=>{t().then(i).catch((e=>{this.requestErrorHandler_(e,t,s+1).then(i).catch(n)}))}),a)}))}})||nG)||nG)||nG)||nG)||nG)||nG);const aG="ai_sticker_list_ver_1706778251026",rG="ai_sticker_list_expt_1707057455164";class oG{constructor(){this.aiStickerListVersion_=null,this.versionExpiredTime_=null}getAIStickerListVersion(){if(null==this.aiStickerListVersion_){const t=E.default.getInstance().getItemForCurrentUser(aG);let s=TT.b;if(t)try{s=JSON.parse(t)}catch(e){}this.aiStickerListVersion_=s}return this.aiStickerListVersion_}setAIStickerListVersion(e){this.aiStickerListVersion_=e;E.default.getInstance().setItemForCurrentUser(aG,JSON.stringify(e))}getVersionExpiredTime(){if(null==this.versionExpiredTime_){const t=E.default.getInstance().getItemForCurrentUser(rG);let s=-1;if(t)try{s=JSON.parse(t)}catch(e){}this.versionExpiredTime_=s}return this.versionExpiredTime_}setVersionExpiredTime(e){this.versionExpiredTime_=e;E.default.getInstance().setItemForCurrentUser(rG,JSON.stringify(e))}}oG.NOT_AI_STICKER_LIST_VERSION=TT.b,oG.NOT_VERSION_EXPIRED_TIME=-1;var lG,cG=new oG;let dG=Object(i.injectable)()(lG=function(e,t){return Object(i.inject)(Gx)(e,void 0,0)}(lG=function(e,t){return Object(i.inject)(Zx)(e,void 0,1)}(lG=function(e,t){return Object(i.inject)(Bx)(e,void 0,2)}(lG=Reflect.metadata("design:type",Function)(lG=Reflect.metadata("design:paramtypes",[Object,Object,Object])(lG=class{constructor(e,t,s){this.aiStickerListVersion_=void 0,this.aiStickerMapper_=void 0,this.aiStickerRepository_=void 0,this.internalEventBus_=void 0,this.aiStickerMapper_=e,this.aiStickerRepository_=t,this.internalEventBus_=s,this.aiStickerListVersion_=cG}transformFromAIStickerMessage(e){var t,s,i,n,a;const r=e.content,o=e.content.parsedParams,l=o.contentId,c=null!==(t=null!==(s=null!==(i=r.oriUrl)&&void 0!==i?i:r.hdUrl)&&void 0!==s?s:null===(n=o.webp)||void 0===n?void 0:n.url)&&void 0!==t?t:"";return{id:l,url:c,thumb:null!==(a=r.thumbUrl)&&void 0!==a?a:c,intrinsicWidth:o.width,intrinsicHeight:o.height,renderedWidth:Object(kx.a)().config.ai_sticker_message.w,renderedHeight:Object(kx.a)().config.ai_sticker_message.h,animatable:undefined,type:TT.f.AI_GENERATED,extra:{fromSrc:TT.a.MESSAGE}}}transformRecentAIStickerFromAISticker(e){return Object(f.a)(Object(f.a)({},e),{},{extra:{fromSrc:TT.a.RECENT}})}transformFromAIStickerMessageContent(e){throw new Error("Method does not be implemented yet!")}isValidAISticker(e){const t=!!e.id,s=!!e.url,i=e.type===TT.f.AI_GENERATED;return t&&s&&i}isValidAIStickerFromRecentStickerPanel(e){var t;return(null==e||null===(t=e.extra)||void 0===t?void 0:t.fromSrc)===TT.a.RECENT}async getAIStickerList(){let e=await this.aiStickerRepository_.getAllAsync();if((!e||0===e.length)&&this.aiStickerListVersion_.getAIStickerListVersion()===oG.NOT_AI_STICKER_LIST_VERSION){e=await this.syncAIStickerList_()?await this.aiStickerRepository_.getAllAsync():[]}return e.map((e=>this.aiStickerMapper_.toAIStickerDTOFromDomain(e)))}getAIStickerListVersion(){return this.aiStickerListVersion_.getAIStickerListVersion()}async syncAIStickerList_(){return new Promise(((e,t)=>{const s=()=>{e(!1)},i=new sG((async t=>{try{if(t.errorCode===Xx.a.SUCCESS){const s=t.data;if(s.version>this.aiStickerListVersion_.getAIStickerListVersion()){const t=s.stickers.map((e=>new Vx(e.id,e.rootStickerCateId,e.url,e.width,e.height)));await this.aiStickerRepository_.insertMultiAsync(t),this.aiStickerListVersion_.setAIStickerListVersion(s.version),s.expiredTime&&(this.aiStickerListVersion_.setVersionExpiredTime(s.expiredTime),this.internalEventBus_.dispatchEvent(new tG(s.expiredTime,s.version))),e(!0)}}e(!1)}catch(i){s()}}),s);this.internalEventBus_.dispatchEvent(i)}))}})||lG)||lG)||lG)||lG)||lG)||lG;function uG(e){var t;if(!e)return;let s={message:""};if("string"==typeof e.msg)s.message=e.msg;else try{const t=e.msg;s=Object(f.a)(Object(f.a)({},t),{},{message:t.title||""})}catch(n){}const i=null!==(t=e.ownerId)&&void 0!==t?t:e.fromUid;return Object(f.a)(Object(f.a)({},e),{},{attachment:oT.a.deep(e.attach),rootClientMessageID:e.cliMsgId,rootClientMessageType:e.cliMsgType,rootContent:s,rootGlobalMessageID:e.globalMsgId,rootSentTime:+e.ts,rootSenderName:ns.default.getDName(i),rootSenderID:i,ttl:e.ttl})}function hG(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}}i.ModuleContainer.register(Yx.a,dG);const gG=()=>({contentId:"",width:-1,height:-1,thumbWidth:-1,thumbHeight:-1,pStickerType:TT.c.AI_STICKER,webp:{width:-1,height:-1,url:""}});function mG(e){return e?Object(f.a)(Object(f.a)({},e),{},{contentId:e.contentId,pStickerType:e.pStickerType,webp:{width:e.webp.width,height:e.webp.height,url:e.webp.url},height:e.height,width:e.width,thumbHeight:e.thumb_height,thumbWidth:e.thumb_width}):gG()}const pG=()=>({title:"",description:"",oriUrl:"",thumbUrl:"",hdUrl:"",parsedParams:mG(null)});function fG(e){if(!e)return pG();const t=e.params;let s=mG(null);if("string"==typeof t)try{s=mG(JSON.parse(t))}catch(m$){0}else"object"==typeof t&&(s=mG(t));return Object(f.a)(Object(f.a)({},e),{},{title:e.title,description:e.description,hdUrl:e.hdUrl,oriUrl:e.oriUrl,thumbUrl:e.thumbUrl,parsedParams:s})}const vG=()=>({color:-1,size:-1,subType:-1,type:-1,parsedExt:{sSrcStr:"",sSrcType:-1}});function bG(e){if(!e)return vG();const t=e.ext;let s={sSrcStr:"",sSrcType:-1};if("string"==typeof t)try{s=JSON.parse(t)}catch(m$){0}else"object"==typeof t&&(s=t);return Object(f.a)(Object(f.a)({},e),{},{color:e.color,size:e.size,subType:e.subType,type:e.type,parsedExt:s})}function IG(e){return Object(f.a)(Object(f.a)({},function(e){if(e)return Object(f.a)(Object(f.a)({},e),{},{actionID:e.actionId,clientMessageID:e.cliMsgId,e2eeStatus:e.e2eeStatus,eventInfo:hG(e.eventInfo),extra:e.extra,fromUID:String(e.fromUid),messageID:e.msgId,platformType:e.platformType,quote:uG(e.quote),sentSource:e.src,sentTime:+e.sendDttm,serverTime:+e.serverTime,status:e.status,syncFromMobile:e.syncFromMobile,toUID:String(e.toUid),ttl:e.ttl,type:-1})}(e)),{},{content:fG(e.message),type:9999,src:e.src,msgType:e.msgType,originMsgType:"chat.photo",properties:bG(e.properties)})}var yG,_G=s("bKjh");let CG=Object(i.injectable)()(yG=function(e,t){return Object(i.inject)(Bx)(e,void 0,0)}(yG=Reflect.metadata("design:type",Function)(yG=Reflect.metadata("design:paramtypes",[Object])(yG=class{constructor(e){this.internalEventBus_=void 0,this.internalEventBus_=e}isAIStickerMessageObject(e){return Object(_G.b)(e)}isAIStickerMessage(e){return Object(_G.a)(e)}isOldAIStickerMessage(e){return Object(_G.e)(e)}isNewAIStickerMessage(e){return Object(_G.d)(e)}transformFromRawMessage(e){return IG(e)}transformAIStickerMessageObjectFromAISticker(e,t){return{toId:e,sendByUrl:!0,title:"",description:"",file:{},img:t.url,oriUrl:t.url,thumbUrl:t.thumb||t.url,hdUrl:t.url,width:t.intrinsicWidth,height:t.intrinsicHeight,params:{contentId:t.id,pStickerType:TT.c.AI_STICKER,height:t.intrinsicHeight,width:t.intrinsicWidth,thumb_width:t.intrinsicWidth,thumb_height:t.intrinsicHeight,webp:{width:t.intrinsicWidth,height:t.intrinsicHeight,url:t.url}},properties:{subType:0,color:-1,size:-1,type:R.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,ext:{sSrcStr:TT.d.AI,sSrcType:TT.e.AI}}}}forwardAIStickerMessage(e,t,s,i={retryTimeout:0,lowPriority:!1,fwAdditional:{}}){return new Promise(((n,a)=>{const r=s.content.parsedParams.webp.url||s.content.oriUrl;if(!r)return a();this.checkAlive_(r,{count:mi.default.retryConfig.max_normal_request_retry_count}).then((()=>{var r,o,l,c,d,u;const h={description:"",title:"",oriUrl:s.content.oriUrl,thumbUrl:s.content.thumbUrl,normalUrl:s.content.normalUrl,hdUrl:s.content.hdUrl||s.content.normalUrl,contentId:s.content.parsedParams.contentId,thumb_width:null!==(r=s.content.parsedParams.thumbWidth)&&void 0!==r?r:s.content.parsedParams.width,thumb_height:null!==(o=s.content.parsedParams.thumbHeight)&&void 0!==o?o:s.content.parsedParams.height,webp:JSON.stringify(s.content.parsedParams.webp),width:s.content.parsedParams.width,height:s.content.parsedParams.height,properties:JSON.stringify({color:s.properties.color,size:s.properties.size,subType:s.properties.subType,type:s.properties.type,ext:JSON.stringify(s.properties.parsedExt)}),pStickerType:s.content.parsedParams.pStickerType,photoId:null!==(l=s.content.photoId)&&void 0!==l?l:1},g=s.e2eeStatus===R.MSG_E2EE;g&&(h.isAISticker=!0);const m=new iG({toUid:e,clientMsgId:t,lowPriority:null!==(c=i.lowPriority)&&void 0!==c&&c,retryTimeout:null!==(d=i.retryTimeout)&&void 0!==d?d:0,messageContent:h,additional:null!==(u=i.fwAdditional)&&void 0!==u?u:{}},(async e=>{if(g)n(e);else{const t={msgId:e.msgId+"",thumbUrl:s.content.thumbUrl,hdUrl:s.content.hdUrl,oriUrl:s.content.oriUrl,width:s.content.parsedParams.width,height:s.content.parsedParams.height};n(t)}}),(async e=>{a(e)}));this.internalEventBus_.dispatchEvent(m)})).catch(a)}))}checkAlive_(e,t){return new Promise(((s,n)=>{ho.default.checkAlive(e).then(s).catch((a=>{if(mi.default.retryConfig.enable_add_missing_retry&&a===SC.XMLHttpRequestErrorCode.NO_RESPONSE&&t.count){t.count=t.count-1;const a=()=>this.checkAlive_(e,t).then(s).catch(n);i.ModuleContainer.resolve(SC.ConnectionPendingController).pushToRetryQueue(a)}else n(a)}))}))}})||yG)||yG)||yG)||yG;i.ModuleContainer.register(Yx.b,CG);var OG,EG=s("56jR"),MG=s("397E"),SG=s("RJlJ");Object(i.injectable)()(OG=Object(Je.e)()(OG=Object(ko.b)(MG.b)(OG=Object(i.singleton)(MG.b)(OG=function(e,t){return Object(i.inject)(Yx.a)(e,void 0,0)}(OG=Reflect.metadata("design:type",Function)(OG=Reflect.metadata("design:paramtypes",[void 0===EG.IAIStickerAppService?Object:EG.IAIStickerAppService])(OG=class{constructor(e){this.aiStickerService_=void 0,this.state_={version:TT.b,aiStickers:[]},this.name=MG.a,this.key=SG.a,this.aiStickerService_=e}onAuthenticated(e){Object(kx.a)().isEnable("AIStickerTab")&&this.aiStickerService_.getAIStickerList().then((e=>{this.state_.version=this.aiStickerService_.getAIStickerListVersion(),this.state_.aiStickers=e,Object(hs.h)(this.name,this.key)}))}getAIStickerList(){return this.state_.aiStickers}init(){}getItem(e){if(e.key===this.key)return this.state_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||OG)||OG)||OG)||OG)||OG)||OG);var TG=s("T6Qc"),wG=s("RYTL");const RG=Object(wG.b)("socket-polling"),LG=Object(wG.b)("event-bus"),DG=Object(wG.b)("z-storage"),AG=Object(wG.b)("z-search-v3"),FG=Object(wG.b)("actionlog-service"),jG=Object(wG.b)("important-message-manager"),PG=Object(wG.b)("sync-message-controller");var kG,NG=s("KBxP");const UG=new _i.a({enable:_i.b.field().boolean(),batch_size:_i.b.field().number().min(0),enable_fetch_foreground:_i.b.field().boolean(),enable_segment_updater:_i.b.field().boolean(),enable_tracking_overflow:_i.b.field().boolean(),enable_local_msgId_attach:_i.b.field().boolean(),min_throttle:_i.b.field().number().min(100),throttle:_i.b.field().number().min(0),throttle_idle:_i.b.field().number(),group_queue_config:_i.b.field().array("string"),one_one_queue_config:_i.b.field().array("string"),interval_check_insufficient_data:_i.b.field().number().min(0),max_time_check_insufficient_data:_i.b.field().number().min(0),max_retry_batch:_i.b.field().number().min(0),retry_strategy:_i.b.field().string().oneOf(["fibo","linear"]),time_exclude:_i.b.field().array("number"),debugger:_i.b.field().schema({show_msg_src:_i.b.field().boolean(),logger:_i.b.field().schema({machine_transition:_i.b.field().boolean(),save_message:_i.b.field().boolean(),batch_request_info:_i.b.field().boolean(),interval_update_sufficient_ts:_i.b.field().boolean()}),simulator:_i.b.field().schema({overflow_db_group_offline:_i.b.field().boolean(),slow_load_message:_i.b.field().boolean()})})});let BG=Object(wG.d)()(kG=Object(wG.e)(TG.b)(kG=Reflect.metadata("design:type",Function)(kG=Reflect.metadata("design:paramtypes",[])(kG=class extends yi.ZFeatureConfig{constructor(){super({default:NG.b,valiator:UG})}selector(e){return e.auto_fetch_msg_mini_cloud||{}}shouldConfigUpdate(e,t){return!new Be.g.Comparer(e,t,!0).AND("enable").AND("batch_size").AND("min_throttle").AND("enable_fetch_foreground").AND("enable_segment_updater").AND("enable_tracking_overflow").AND("enable_local_msgId_attach").AND("throttle").AND("throttle_idle").AND("group_queue_config",BC.a.isEqual).AND("one_one_queue_config",BC.a.isEqual).AND("interval_check_insufficient_data").AND("max_time_check_insufficient_data").AND("max_retry_batch").AND("retry_strategy").AND("time_exclude",BC.a.isEqual).AND("debugger",BC.a.isEqual).exec()}})||kG)||kG)||kG)||kG;var xG=s("LLK0"),GG=s("7Yx4");let zG=function(e){return e.OVERFLOW_DB_GROUP_OFFLINE="OVERFLOW_DB_GROUP_OFFLINE",e.NEXT_CURSOR="NEXT_CURSOR",e}({});var VG=s("j8Zv");let HG=function(e){return e[e.ONLY_1_1=0]="ONLY_1_1",e[e.ONLY_GROUP=1]="ONLY_GROUP",e[e.BOTH_1_1_AND_GROUP=2]="BOTH_1_1_AND_GROUP",e[e.NONE=3]="NONE",e}({});var WG,$G=s("svq+");class KG extends Fe.a{constructor(e){super($G.a.SHOW_SYNC_MESSAGE_SUGGESTION),this.queueId=e}}class qG extends Fe.a{constructor(){super($G.a.AFMC_START)}}class QG extends Fe.a{constructor(){super($G.a.AFMC_FINISHED)}}class ZG extends Fe.a{constructor(e){super($G.a.AFMC_START_FETCH_CONV),this.convId=e}}class JG extends Fe.a{constructor(e,t){super($G.a.AFMC_STOP_FETCH_CONV),this.convId=e,this.success=t}}let YG=Object(wG.d)()(WG=Object(td.e)()(WG=Object(wG.e)(TG.c)(WG=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,0)}(WG=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,1)}(WG=function(e,t){return Object(td.d)(TG.b)(e,void 0,2)}(WG=function(e,t){return Object(td.d)(TG.n)(e,void 0,3)}(WG=function(e,t){return Object(td.d)(TG.h)(e,void 0,4)}(WG=function(e,t){return Object(td.d)(TG.k)(e,void 0,5)}(WG=function(e,t){return Object(td.d)(TG.o)(e,void 0,6)}(WG=function(e,t){return Object(td.d)(TG.i)(e,void 0,7)}(WG=function(e,t){return Object(td.d)(TG.r)(e,void 0,8)}(WG=function(e,t){return Object(td.d)(TG.e)(e,void 0,9)}(WG=Reflect.metadata("design:type",Function)(WG=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMachine?Object:AFMC_IMachine,"undefined"==typeof AFMC_ITrackingOverflowMessage?Object:AFMC_ITrackingOverflowMessage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(WG=class extends Fe.b{constructor(e,t,s,i,n,a,r,o,l,c){super(),this.logger=void 0,this.service=void 0,this.ledger=void 0,this.metrics=void 0,this.storage=void 0,this.systemTime=void 0,this.fetcherMachine=void 0,this.eventCollector=void 0,this.trackingOverflow=void 0,this.config=void 0,this.isInsufficientMessage=void 0,this.onOverflowDBGroupOffline=e=>{this.logger.zsymb(0,"Zjv25_","DB Group offline overflow, should suggest sync message"),this.dispatchEvent(new KG(e.queueId))},this.onNextCursor=async e=>{const{currCheckpoint:t,nextCheckpoint:s}=e;t&&this.dispatchEvent(new JG(t.convId,await t.isDone())),s&&this.dispatchEvent(new ZG(s.convId))},this.onConfigUpdate=e=>{!0===e.config.enable?this.fetcherMachine.status!==xG.b.Running?(this.logger.zsymb(0,"P4Nh5y","Receive config enabled, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"S6pkBQ","Receive config enable but machine is already started"):(this.logger.zsymb(0,"EZrXba","Receive config disabled, let stop machine"),this.fetcherMachine.stop(),this.unregisterMachineListener())},this.onMachineTransition=e=>{switch(e.event.type){case"START":this.onMachineStartFetch();break;case"STOP":this.onMachineStopFetch()}this.config.get("debugger.logger.machine_transition")&&this.logger.zsymb(12,"YhPRtk","machine transition",JSON.stringify(e.value))},this.onMachineStop=()=>{this.logger.zsymb(0,"LJhpla","Machine is stopped")},this.onMachineStartFetch=async()=>{this.dispatchEvent(new qG);const e=this.isInsufficientMessage=await this.service.isInsufficientMessage(),t=this.trackingOverflow.getOverflowStatus(),s=this.fetcherMachine.hasRemainConvInPrevSession();if(e){const e=await this.storage.getLastQueueIdOverflowMessage();this.dispatchEvent(new KG(null!=e?e:VG.a.SOCKET_MESSAGE_GROUP_OLD)),this.logger.zsymb(0,"Qft-uP","User messages may not be enough, should suggest sync message"),this.metrics.logAutoShowBannerSuggestion(s)}else if(this.logger.zsymb(0,"stLo-M","Can cover overflow by fetch message from mini-cloud"),t===HG.ONLY_GROUP)this.metrics.logAutoHideBannerSuggestion();this.metrics.logStartFetch(e,t)},this.onMachineStopFetch=async()=>{const e=0===await this.ledger.size();e?(this.logger.zsymb(0,"xze7cc","fetch done"),this.storage.saveLastFetchSuccess(this.systemTime.getTimeNow())):this.logger.zsymb(18,"LGOUoI","fetch stop"),null!==this.isInsufficientMessage&&this.metrics.logStopFetch(this.isInsufficientMessage,this.trackingOverflow.getOverflowStatus(),e),this.isInsufficientMessage=null,this.dispatchEvent(new QG)},this.onOverflowMessageQueue=async e=>!1===this.config.get("enable")?(this.logger.zsymb(0,"cTQyor","Module is disabled, should suggest sync message"),void this.dispatchEvent(new KG(e.queueId))):!1===this.service.isQueueMessageGroup(e.queueId)?(this.logger.zsymb(0,"r4yiLJ","Detected overflow other queue, forward event to suggest sync message"),void this.dispatchEvent(new KG(e.queueId))):void this.logger.zsymb(0,"NBNfkB","Detected overflow queue message group, let wait done offline"),this.logger=e.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[Ve.ZLoggerNametags.controller]),this.config=s,this.ledger=n,this.service=i,this.metrics=a,this.storage=r,this.systemTime=t,this.fetcherMachine=o,this.eventCollector=c,this.trackingOverflow=l,this.isInsufficientMessage=null}start(){this.fetcherMachine.create(),this.registerListener(),this.config.get("enable")?(this.logger.zsymb(0,"wGbXPe","Module is enabled on startup, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"Zbf2x4","Module is disabled on startup, let listen config from server")}getRemainConvIds(){return this.fetcherMachine.getRemainConvIds()}registerListener(){this.config.addEventListener("update",this.onConfigUpdate),this.ledger.addEventListener(zG.OVERFLOW_DB_GROUP_OFFLINE,this.onOverflowDBGroupOffline),this.ledger.addEventListener(zG.NEXT_CURSOR,this.onNextCursor),this.eventCollector.addEventListener(GG.a.OVERFLOW_MESSAGE_QUEUE,this.onOverflowMessageQueue)}registerMachineListener(){this.logger.zsymb(0,"6vNwH-","register machine listener"),this.fetcherMachine.onStop(this.onMachineStop),this.fetcherMachine.onTransition(this.onMachineTransition)}unregisterMachineListener(){this.logger.zsymb(0,"flPo_E","unregister machine listener"),this.fetcherMachine.off(this.onMachineStop),this.fetcherMachine.off(this.onMachineTransition)}})||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG)||WG,XG=function(e){return e.AUTO_FETCH_MSG_CLOUD_SETTING="auto_fetch_msg_cloud",e.SYNC_MESSAGE_SETTING="sync_cross_settings",e.IMPORT_MESSAGE_SETTING="export_import_data",e.OVERFLOW_MSG_TS="overflow_msg_ts",e.SUFFICIENT_MSG_TS="sufficient_msg_ts",e.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS="last-time-close-first-login-transfer-modal",e}({});class ez{constructor(e,t,s){this.key=void 0,this.version=void 0,this.storageAdapter=void 0,this.data=null,this.key=e,this.version=t,this.storageAdapter=s}async get(){return this.data?this.data:this.data=await this.storageAdapter.readAsync(this.key,this.version)}async save(e){this.data=e,await this.storageAdapter.writeAsync(this.key,this.version,e)}async clear(){this.data=null,await this.storageAdapter.removeAsync(this.key)}}class tz extends ez{constructor(e,t){super([e,"conv_ids"].join("_"),1,t)}async remove(e){var t;const s=(null!==(t=await this.get())&&void 0!==t?t:[]).filter((t=>t!==e));await this.save(s)}async getRemainConv(){const e=await this.get();return(null==e?void 0:e.length)||0}}class sz extends ez{constructor(e,t){super([e,"overflow"].join("_"),1,t)}}class iz extends ez{constructor(e,t){super([e,"last_fetch"].join("_"),2,t)}async getLastTsSuccess(){var e,t;return null!==(t=(null!==(e=await this.get())&&void 0!==e?e:{}).lastTsSuccess)&&void 0!==t?t:-1}async getFetchInfo(){var e;return null!==(e=await this.get())&&void 0!==e?e:{}}async saveLastTsSuccess(e){var t;const s=null!==(t=await this.get())&&void 0!==t?t:{};return this.save(Object(f.a)(Object(f.a)({},s),{},{lastTsSuccess:e}))}async saveStartFetchInfo(e){var t,s,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},a=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};a.evict||(a.evict=e.evict),a.listTsStart=(null!==(i=a.listTsStart)&&void 0!==i?i:[]).concat(e.tsStart),a.tsSufficient=e.tsSufficient,await this.save(Object(f.a)(Object(f.a)({},n),{},{onProgressInfo:a}))}async saveConvIds(e){var t,s,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},a=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};a.convIds=Be.b.merge(null!==(i=null==a?void 0:a.convIds)&&void 0!==i?i:[],e);const r=Object(f.a)(Object(f.a)({},n),{},{onProgressInfo:a});await this.save(r)}async saveConvErrorIds(e){var t,s,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},a=null!==(s=n.onProgressInfo)&&void 0!==s?s:{},r=null!==(i=null==a?void 0:a.convErrorIds)&&void 0!==i?i:[],o=Be.b.merge(r,e);a.convErrorIds=o,await this.save(Object(f.a)(Object(f.a)({},n),{},{onProgressInfo:a}))}async saveTotalMessageFetched(e){var t,s,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},a=null!==(s=n.onProgressInfo)&&void 0!==s?s:{},r=(null!==(i=a.totalMsgFetched)&&void 0!==i?i:0)+e;a.totalMsgFetched=r,await this.save(Object(f.a)(Object(f.a)({},n),{},{onProgressInfo:a}))}async removeLastStartFetchInfo(){var e;const t=null!==(e=await this.get())&&void 0!==e?e:{};return delete t.onProgressInfo,this.save(t)}async removeConvId(e){var t,s,i,n;const a=null!==(t=await this.get())&&void 0!==t?t:{},r=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};r.convIds=(null!==(i=r.convIds)&&void 0!==i?i:[]).filter((t=>t!==e)),r.convErrorIds=(null!==(n=r.convErrorIds)&&void 0!==n?n:[]).filter((t=>t!==e));const o=Object(f.a)(Object(f.a)({},a),{},{onProgressInfo:r});await this.save(o)}async removeConvIdFetchFailed(e){var t,s,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},a=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};a.convErrorIds=(null!==(i=a.convErrorIds)&&void 0!==i?i:[]).filter((t=>t!==e));const r=Object(f.a)(Object(f.a)({},n),{},{onProgressInfo:a});await this.save(r)}}var nz;let az=Object(wG.d)()(nz=Object(td.e)()(nz=Object(wG.e)(TG.o)(nz=function(e,t){return Object(td.d)(TG.a)(e,void 0,0)}(nz=Reflect.metadata("design:type",Function)(nz=Reflect.metadata("design:paramtypes",["undefined"==typeof IAsyncStorageAdapter?Object:IAsyncStorageAdapter])(nz=class{constructor(e){this.localStorage=void 0,this.storageConvIds=void 0,this.storageOverflow=void 0,this.storageLastFetch=void 0,this.localStorage=E.default.getInstance(),this.storageConvIds=new tz(XG.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageOverflow=new sz(XG.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageLastFetch=new iz(XG.AUTO_FETCH_MSG_CLOUD_SETTING,e)}async getAllConvIds(){var e;return null!==(e=await this.storageConvIds.get())&&void 0!==e?e:[]}async getLastTsSyncMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(XG.SYNC_MESSAGE_SETTING),[,s]=Be.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastSync)&&void 0!==e?e:-1}async getLastTsCloseTransferSuggestion(){var e;const t=this.localStorage.getItemForCurrentUser(XG.SYNC_MESSAGE_SETTING),[,s]=Be.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastCloseSuggest)&&void 0!==e?e:-1}async getLastTsCloseFirstLoginTransferSuggestion(){const e=await this.localStorage.getItemForCurrentUserAsync(XG.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsImportMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(XG.IMPORT_MESSAGE_SETTING),[,s]=Be.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastTimeImportSuccess)&&void 0!==e?e:-1}async getLastTsAutoFetchMessageSuccess(){return await this.storageLastFetch.getLastTsSuccess()}async getFetchInfo(){return await this.storageLastFetch.getFetchInfo()}async getLastTsOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(XG.OVERFLOW_MSG_TS);if(e){const[t]=e.split("::");if(!isNaN(Number(t)))return Number(t)}return-1}async getLastQueueIdOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(XG.OVERFLOW_MSG_TS);if(e){const[t,s]=e.split("::");return s||null}return null}async getLastTsSufficientMessage(){const e=this.localStorage.getItemForCurrentUser(XG.SUFFICIENT_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getOverflowInfo(){return await this.storageOverflow.get()}async getRemainConv(){return await this.storageConvIds.getRemainConv()}async saveConvIds(e){await this.storageConvIds.save(e),await this.storageLastFetch.saveConvIds(e)}async saveLastFetchSuccess(e){await this.storageLastFetch.saveLastTsSuccess(e)}async saveLastOverflow(e,t){this.localStorage.setItemForCurrentUser(XG.OVERFLOW_MSG_TS,[t,e].join("::"))}async saveLastSufficientMessage(e){this.localStorage.setItemForCurrentUser(XG.SUFFICIENT_MSG_TS,String(e))}async saveOverflowInfo(e,t,s){await this.storageOverflow.save({queueId:e,lastMsgId:t,lastActionId:s})}async saveStartFetchInfo(e){await this.storageLastFetch.saveStartFetchInfo(e)}async saveConvErrorId(e){await this.storageLastFetch.saveConvErrorIds([e])}async saveTotalMessageFetched(e){await this.storageLastFetch.saveTotalMessageFetched(e)}async removeOverflowInfo(){await this.storageOverflow.clear()}async removeConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvIdFetchFailed(e)}async forceRemoveConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvId(e)}async removeStartFetchInfo(){await this.storageLastFetch.removeLastStartFetchInfo()}})||nz)||nz)||nz)||nz)||nz)||nz;var rz;let oz=Object(wG.d)()(rz=Object(wG.e)(TG.a)(rz=Reflect.metadata("design:type",Function)(rz=Reflect.metadata("design:paramtypes",[])(rz=class{constructor(){this.storage=void 0,this.storage=E.default.getInstance()}async readAsync(e,t){const s=await this.storage.getItemForCurrentUserAsync(e),[i,n]=Be.g.safeParseJson(s);return i||null===n?null:n.version===t?n.value:(await this.storage.removeItemForCurrentUserAsync(e),null)}async writeAsync(e,t,s){const i=JSON.stringify({version:t,value:s});await this.storage.setItemForCurrentUserAsync(e,i)}async removeAsync(e){await this.storage.removeItemForCurrentUserAsync(e)}})||rz)||rz)||rz)||rz;var lz=s("9Gk3"),cz=s("WnuJ"),dz=s("wd/R"),uz=s.n(dz);const hz=(e,t={})=>(s,i,n)=>{const a=n.value,r=new Map,o=new he.default({maxSize:10});n.value=async function(...s){const i=e(s);let n=null;return t.cache&&(n=o.get(i)||null),n=n||r.get(i)||null,n||(n=a.apply(this,s),t.cache&&n.then((()=>{o.set(i,n)})),n.finally((()=>r.delete(i))),r.set(i,n)),n}};let gz=function(e){return e[e.SAVE_MESSAE_ERROR=0]="SAVE_MESSAE_ERROR",e[e.GET_GROUP_INFO_ERROR=1]="GET_GROUP_INFO_ERROR",e}({});class mz extends Jh.a{constructor(e){super("SaveMessageError",gz.SAVE_MESSAE_ERROR,e)}}class pz extends Jh.a{constructor(e,t){super("GetGroupInfoError",gz.GET_GROUP_INFO_ERROR,"An error occured during get list groups info. Error: "+JSON.stringify(t)+". GroupIds: "+e)}}var fz,vz,bz,Iz,yz,_z,Cz,Oz,Ez,Mz,Sz,Tz,wz,Rz,Lz,Dz,Az,Fz,jz,Pz,kz,Nz;let Uz=(fz=Object(wG.d)(),vz=Object(td.e)(),bz=Object(wG.e)(TG.n),Iz=function(e,t){return Object(td.d)(TG.b)(e,void 0,0)},yz=function(e,t){return Object(td.d)(TG.o)(e,void 0,1)},_z=function(e,t){return Object(td.d)(TG.j)(e,void 0,2)},Cz=function(e,t){return Object(td.d)(TG.q)(e,void 0,3)},Oz=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,4)},Ez=function(e,t){return i.ModuleContainer.inject(uc)(e,void 0,5)},Mz=function(e,t){return i.ModuleContainer.inject(ac.b)(e,void 0,6)},Sz=function(e,t){return i.ModuleContainer.inject(jo.ConversationManager)(e,void 0,7)},Tz=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,8)},wz=Reflect.metadata("design:type",Function),Rz=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMessageProcessor?Object:AFMC_IMessageProcessor,"undefined"==typeof AFMC_ISufficientMessageController?Object:AFMC_ISufficientMessageController,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof IMessageController?Object:IMessageController,void 0===ac.b?Object:ac.b,void 0===jo.ConversationManager?Object:jo.ConversationManager,"undefined"==typeof ISystemTime?Object:ISystemTime]),Lz=hz((([e])=>`${e.convId}::${e.requestMsgId}`),{cache:!0}),Dz=Reflect.metadata("design:type",Function),Az=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo]),Fz=hz((([e])=>`${e.convId}::${e.requestMsgId}`),{cache:!0}),jz=Reflect.metadata("design:type",Function),Pz=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo,Array]),fz(kz=vz(kz=bz(kz=Iz(kz=yz(kz=_z(kz=Cz(kz=Oz(kz=Ez(kz=Mz(kz=Sz(kz=Tz(kz=wz(kz=Rz((Nz=class{constructor(e,t,s,i,n,a,r,o,l){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.groupManager=void 0,this.convManager=void 0,this.messageProcessor=void 0,this.messageController=void 0,this.sufficientMessageController=void 0,this.logger=n.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[Ve.ZLoggerNametags.service]),this.config=e,this.storage=t,this.systemTime=l,this.convManager=o,this.groupManager=r,this.messageProcessor=s,this.messageController=a,this.sufficientMessageController=i}getThrottle(e){return e?Math.max(this.config.get("min_throttle"),this.config.get("throttle")+this.config.get("throttle_idle")):Math.max(this.config.get("min_throttle"),this.config.get("throttle"))}allowFetchForeground(){return this.config.get("enable_fetch_foreground")}async getLocalMsgIdsFrom(e,t,s){let i=[];try{const n=tt.default.getInstance();let a=null;if(t===R.MessageConstants.MAX_MSG_ID)a=R.MessageConstants.MAX_SENDDTTM;else{const s=await n.Core.Message.get(t,{partition:e});s&&(a=s.sendDttm)}a&&(i=await n.Core.Message.getAllKey({from:[e,"",""],to:[e,a,t],excludeTo:!0},{partition:e,index:"userId_sendDttm_msgId",direction:Le.c.PREV,limit:s}),i=i.filter((e=>!cz.a.isFakeId(e))),i.sort())}catch{}return i}async fetchMessages(e){const{convId:t,requestMsgId:s}=e,i=this.config.get("batch_size");let n=[];this.config.get("enable_local_msgId_attach")&&(n=await this.getLocalMsgIdsFrom(t,s,i));const a=await this.messageController.fetchMessagesCloud(t,s,i,{isOA:0,src:lz.c.AUTO_FETCH_MINI_CLOUD,localMsgIds:n});return a.groupMsgs.forEach((e=>e.setSrc(R.MSG_SRC.AUTO_LOADER))),a}async processMessages(e,t){const[s,i]=await Be.c.catchPromise(this.messageProcessor.process(e,t));return Sj(s,new mz("Save messages error "+(null==s?void 0:s.toString()))),i}checkBusyHour(){const e=this.systemTime.getTimeNow(),t=uz()(e).get("h");if(!1===this.config.get("time_exclude").includes(t))return[!1,0];const s=Math.random()*Math.max(this.config.get("throttle"),this.config.get("min_throttle")),i=uz()(e).add(1,"h").set("m",0).set("s",0).toDate().getTime();return[!0,Math.abs(i-e)+s]}checkMaxRetryBatch(e,t){if(e>=this.config.get("max_retry_batch"))return[!0,0];let s=this.getThrottle(t)+1e3*Math.random();if("fibo"===this.config.get("retry_strategy"))s+=1e3*Be.f.get(e+1);return[!1,s]}async isInsufficientMessage(){const e=await this.sufficientMessageController.getLastTsSufficientMessage();return this.systemTime.getTimeNow()-e>this.config.get("max_time_check_insufficient_data")}isQueueMessageGroup(e){return this.config.get("group_queue_config").includes(e.toString())}async getGroupsHaveMessageOffline(){let e=!1,t=[];const s=await this.storage.getOverflowInfo();if(s){const i=await this.messageController.getGroupHasMessageOffline(s.queueId,s.lastMsgId,s.lastActionId);e=i.evict,t=i.listConvIds,NG.a&&this.config.get("debugger.simulator.overflow_db_group_offline")&&(e=!0)}const i=await this.storage.getAllConvIds(),n=Be.b.merge(t,i),[a,r]=await Be.c.catchPromise(this.groupManager.getMulti(n));Sj(a,new pz(n,a));const o=await Be.b.asyncMapParallel(r,(async e=>{const s=await this.convManager.get(e.id),i=e.isAdmin()||e.isOwner(),n=!(null==s||!s.isPinned),a=!(null==s||!s.isMuted),r=e.totalMembers;let o=-1,l=-1;const c=await(null==s?void 0:s.getLastMessage());return null!=c&&c.sendDttm&&(o=Number(c.sendDttm),l=Be.d.getNumberOfDays(o,this.systemTime.getTimeNow())),{convId:e.id,groupInfo:e,isNewGroupOffline:t.includes(e.id),isPinned:n,isOwnerOrAdmin:i,isMuted:a,lastActiveTime:o,totalMembers:r,lastActiveTimeInDays:l}}));return e?{listGroups:o,evict:e,queueId:s.queueId}:{listGroups:o,evict:e,queueId:null}}reloadMessageOfConv(e){this.messageController.reloadMessage(e)}},Object(gj.a)(Nz.prototype,"fetchMessages",[Lz,Dz,Az],Object.getOwnPropertyDescriptor(Nz.prototype,"fetchMessages"),Nz.prototype),Object(gj.a)(Nz.prototype,"processMessages",[Fz,jz,Pz],Object.getOwnPropertyDescriptor(Nz.prototype,"processMessages"),Nz.prototype),kz=Nz))||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz)||kz);var Bz,xz=s("+Mel"),Gz=s("C3LF");let zz=Object(wG.d)()(Bz=Object(td.e)()(Bz=Object(wG.e)(TG.e)(Bz=function(e,t){return Object(td.d)(LG)(e,void 0,0)}(Bz=function(e,t){return Object(td.d)(RG)(e,void 0,1)}(Bz=function(e,t){return Object(td.d)(PG)(e,void 0,2)}(Bz=function(e,t){return i.ModuleContainer.inject(Je.a)(e,void 0,3)}(Bz=Reflect.metadata("design:type",Function)(Bz=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof SyncMessageController?Object:SyncMessageController,"undefined"==typeof BaseApplication?Object:BaseApplication])(Bz=class extends Fe.b{constructor(e,t,s,i){super(),this.onStartPullOffline=()=>{this.dispatchEvent(new Gz.l)},this.onDonePullOffline=()=>{this.dispatchEvent(new Gz.n)},this.onOverflowQueue=e=>{this.dispatchEvent(new Gz.j(e.queueId))},this.onStartSyncMessage=()=>{this.dispatchEvent(new Gz.m("start"))},this.onResumeSyncMessage=()=>{this.dispatchEvent(new Gz.m("resume"))},this.onSyncMessageSuccess=()=>{this.dispatchEvent(new Gz.o("",!0))},this.onSyncMessageFailed=()=>{this.dispatchEvent(new Gz.o("",!1))},this.onApplicationBackground=()=>{this.dispatchEvent(new Gz.a)},this.onApplicationForeground=()=>{this.dispatchEvent(new Gz.c)},this.onApplicationExit=()=>{this.dispatchEvent(new Gz.b)},this.onNetworkStatusChanged=e=>{this.dispatchEvent(new Gz.i(e))},this.onLogout=()=>{this.dispatchEvent(new Gz.h)},this.onServiceReady=()=>{this.dispatchEvent(new Gz.k)},this.onBeforeUnload=()=>{this.dispatchEvent(new Gz.d)},this.registerListener(e,t,i,s)}registerListener(e,t,s,i){var n,a,r,o,l;e.subscribe(((e,t)=>{switch(e){case Ai.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG:return this.onOverflowQueue(t);case Ai.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t)}})),t.addEventListener(id.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(nd.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(nd.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(nd.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(nd.b.ON_DONE_OFFLINE,this.onDonePullOffline)})),null==i||null===(n=i.addEventListener)||void 0===n||n.call(i,xz.a.ON_START,this.onStartSyncMessage),null==i||null===(a=i.addEventListener)||void 0===a||a.call(i,xz.a.ON_RETRY,this.onStartSyncMessage),null==i||null===(r=i.addEventListener)||void 0===r||r.call(i,xz.a.ON_RESUME,this.onResumeSyncMessage),null==i||null===(o=i.addEventListener)||void 0===o||o.call(i,xz.a.ON_SUCCESS,this.onSyncMessageSuccess),null==i||null===(l=i.addEventListener)||void 0===l||l.call(i,xz.a.ON_FAILED,this.onSyncMessageFailed),s.addEventListener(Je.b.Idle,this.onApplicationBackground),s.addEventListener(Je.b.Active,this.onApplicationForeground),s.addEventListener(Je.b.Exit,this.onApplicationExit),s.addEventListener(Je.b.ServicesReady,this.onServiceReady),s.addEventListener(Je.b.BeforeUnload,this.onBeforeUnload),s.addEventListener(Je.b.LogOut,this.onLogout)}onLeaveGroup(e){this.dispatchEvent(new Gz.f(e))}onDeleteConv(e){this.dispatchEvent(new Gz.e(e))}})||Bz)||Bz)||Bz)||Bz)||Bz)||Bz)||Bz)||Bz)||Bz;class Vz{constructor(e){this.label=e,this.data=new Map,this.id=0,this.locked=!1}get nextId(){return++this.id}get info(){return`${this.label}: ${this.time}`}get time(){let e=0;return this.data.forEach((t=>e+=t.time)),e}lock(){this.locked=!0}unlock(){this.locked=!1}getTracker(){const e=this.nextId;return{start:()=>this.start(e),end:()=>this.end(e),do:(t,...s)=>{this.start(e);const i=t(...s);return this.end(e),i},doAsync:(t,...s)=>(this.start(e),t(...s).then((t=>(this.end(e),t)))),reset:()=>{this.data.delete(e)}}}start(e){if(this.locked)return;const t=this.data.get(e);if(t){let s=t.start;t.counting<=0&&(s=Date.now()),this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{counting:t.counting+1,start:s}))}else this.data.set(e,{counting:1,time:0,start:Date.now()})}end(e){if(this.locked)return;const t=this.data.get(e);if(t){let s=t.start,i=t.time+Date.now()-t.start;t.counting&&t.counting>1&&(s=Date.now()),this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{time:i,start:s,counting:t.counting-1}))}}}class Hz{constructor(e,t,s,n,a,r,o,l,c){var d;this.isNew=s,this.isPinned=n,this.isOwnerOrAdmin=a,this.isMuted=r,this.lastActiveTime=o,this.totalMembers=l,this.lastActiveTimeInDays=c,this.segmentController=void 0,this.hasMore=void 0,this.tsCheck=void 0,this.lastMsgId=void 0,this.id=void 0,this.convId=void 0,this.metrics=void 0,this.disabled=!1,this.convId=this.id=t,this.metrics=new Wz(t),this.segmentController=e,this.hasMore=!0,this.tsCheck=i.ModuleContainer.resolve(In.b).getTimeNow(),this.lastMsgId=(null===(d=i.ModuleContainer.resolve(jo.ConvInfoDataManager).getConvByIdSync(this.convId))||void 0===d?void 0:d.lastSmsLocalId)||"0"}getCursor(){return{value:()=>this.getCurrentCursorValue(),next:e=>this.update(e)}}async update(e){const t=await this.segmentController.get(this.convId),s=await this.segmentController.updateSegment(t,e);this.hasMore=this.isHasMoreMessage(e,s)}disable(){this.disabled=!0}async isDone(){return null===await this.getCurrentCursorValue()}async getCurrentCursorValue(){var e;if(!this.hasMore)return null;if(this.disabled)return null;const t=await this.segmentController.get(this.convId),s=this.getRequestMsgId(t);return null===s?null:{convId:this.convId,requestMsgId:s,lastMsgId:this.lastMsgId,lastDeleteMsgId:(null===(e=t.lastDeletedMsgID)||void 0===e?void 0:e.toString())||"0"}}getRequestMsgId(e){var t,s,i;const n=null!==(t=e.lastDeletedMsgID)&&void 0!==t?t:0,a=null!==(s=e.lastCloudVerifiedDttm)&&void 0!==s?s:0,r=null!==(i=e.cloudSegmentCheckAutoFetch)&&void 0!==i?i:[];if(parseInt(this.lastMsgId.replace(".",""))<=n)return null;if(this.tsCheck>a)return R.MessageConstants.MAX_MSG_ID;for(let o=r.length-1;o>=0;o--){const[e,t]=r[o];if(n>=t)return null;if(n<e)return String(e)}return null}isHasMoreMessage(e,t){return!!e.hasMore&&this.getRequestMsgId(t)!==e.requestMsgId}}class Wz{constructor(e){this.convId=e,this.timeTracker=new $z,this.tsStart=0,this.tsStop=0,this.isDone=!1,this.totalBatch=0,this.totalRetry=0}get metrics(){return i.ModuleContainer.resolve(TG.l).get(TG.k)}start(){this.tsStart=performance.now()}stop(e){this.tsStop=performance.now(),this.isDone=e}exportReport(){const e=this.tsStop||performance.now(),t=this.timeTracker.prepare.time,s=this.timeTracker.fetch.time,i=this.timeTracker.sync.time,n=e-this.tsStart,a=n-(t+s+i);return{convId:this.convId,meta:{isDone:this.isDone,total:this.totalBatch,retry:this.totalRetry},duration:{total:n,prepare:t,fetch:s,save:i,idle:a}}}increaseBatch(){this.totalBatch++}increaseRetry(){this.totalRetry++}submit(){const e=this.exportReport();this.metrics.submitConvReport(e)}}class $z{constructor(){this.prepare=new Vz("AFMC_prepare"),this.fetch=new Vz("AFMC_fetch"),this.sync=new Vz("AFMC_sync")}}class Kz extends Fe.a{constructor(e){super(zG.OVERFLOW_DB_GROUP_OFFLINE),this.queueId=e}}class qz extends Fe.a{constructor(e,t){super(zG.NEXT_CURSOR),this.currCheckpoint=e,this.nextCheckpoint=t}}var Qz,Zz,Jz,Yz,Xz,eV,tV,sV,iV,nV,aV,rV,oV,lV;let cV=(Qz=Object(td.e)(),Zz=Object(wG.d)(),Jz=Object(wG.e)(TG.h),Yz=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,0)},Xz=function(e,t){return Object(td.d)(TG.n)(e,void 0,1)},eV=function(e,t){return Object(td.d)(TG.o)(e,void 0,2)},tV=function(e,t){return Object(td.d)(TG.k)(e,void 0,3)},sV=Reflect.metadata("design:type",Function),iV=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics]),nV=((e=Sx)=>(t,s,i)=>{const n=i.value,a="AsyncFunction"===n.constructor.name;i.value=a?async function(...t){let s=0;for(;;){var i;const[a,r]=await Be.c.catchAsyncFn((()=>n.apply(this,t)));if(!a)return r;if(null==e||null===(i=e.onRetry)||void 0===i||i.call(e,a),++s>=e.maxRetry)throw a;e.delay&&await Be.c.delay(e.delay+1e3*Math.random())}}:function(...t){let s=0;for(;;){var i;const[a,r]=Be.c.catchFn((()=>n.apply(this,t)));if(!a)return r;if(null==e||null===(i=e.onRetry)||void 0===i||i.call(e,a),++s>=e.maxRetry)throw a}}})({maxRetry:3,delay:3e3}),aV=Reflect.metadata("design:type",Function),rV=Reflect.metadata("design:paramtypes",[]),Qz(oV=Zz(oV=Jz(oV=Yz(oV=Xz(oV=eV(oV=tV(oV=sV(oV=iV((lV=class extends Fe.b{constructor(e,t,s,i){super(),this.logger=void 0,this.service=void 0,this.storage=void 0,this.metrics=void 0,this.listCheckpoints=void 0,this.currentCursorIndex=void 0,this.logger=e.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[Ve.ZLoggerNametags.stateMachine]),this.service=t,this.storage=s,this.metrics=i,this.listCheckpoints=[],this.currentCursorIndex=-1}async init(){var e;const{listGroups:t,evict:s,queueId:n}=await this.service.getGroupsHaveMessageOffline();s&&this.dispatchEvent(new Kz(n));const a=t.map((e=>e.convId)),r=i.ModuleContainer.resolve(cg);this.listCheckpoints=t.map((e=>new Hz(r,e.convId,e.isNewGroupOffline,e.isPinned,e.isOwnerOrAdmin,e.isMuted,e.lastActiveTime,e.totalMembers,e.lastActiveTimeInDays))),this.listCheckpoints.sort(Be.b.Sorter.create([{key:"lastActiveTime",comparer:Be.b.Sorter.Comparer.number,order:Be.b.Sorter.Order.DES},{key:"isPinned",comparer:Be.b.Sorter.Comparer.bool},{key:"isOwnerOrAdmin",comparer:Be.b.Sorter.Comparer.bool},{key:"isMuted",comparer:Be.b.Sorter.Comparer.bool,order:Be.b.Sorter.Order.DES},{key:"lastActiveTimeInDays",comparer:Be.b.Sorter.Comparer.number},{key:"totalMembers",comparer:Be.b.Sorter.Comparer.number}])),this.currentCursorIndex=0-Number(this.listCheckpoints.length<=0),null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start(),await this.storage.saveConvIds(a),await this.storage.removeOverflowInfo(),this.logger.zsymb(0,"U3o59s","init ledger success",a),-1!==this.currentCursorIndex&&(this.metrics.submitLedgerReport(this.listCheckpoints),Be.c.Macrotask.push((()=>{this.dispatchEvent(new qz(null,this.getCurrentCursorValue()))})));return{isEvict:s,isHasNewConv:this.listCheckpoints.some((e=>e.isNew))}}async getRemainCheckpoints(){return-1===this.currentCursorIndex?[]:this.listCheckpoints.slice(this.currentCursorIndex)}async size(){return await this.storage.getRemainConv()}async clear(){await Promise.all([this.storage.saveConvIds([]),this.storage.removeOverflowInfo()]),this.listCheckpoints=[]}getCursor(){return{value:async()=>this.getCurrentCursorValue(),next:async()=>this.handleNextCursor()}}async remove(e){await this.storage.forceRemoveConvId(e);const t=this.listCheckpoints.find((t=>t.id===e));return!!t&&(t.disable(),!0)}getCurrentCursorValue(){var e;return null!==(e=this.listCheckpoints[this.currentCursorIndex])&&void 0!==e?e:null}async handleNextCursor(){const e=this.getCurrentCursorValue();if(e){const t=await e.isDone();t&&await this.storage.removeConvId(e.convId),e.metrics.stop(t),e.metrics.submit()}this.currentCursorIndex++,Be.c.Macrotask.push((()=>{var t;null===(t=this.getCurrentCursorValue())||void 0===t||t.metrics.start(),this.dispatchEvent(new qz(e,this.getCurrentCursorValue()))}))}},Object(gj.a)(lV.prototype,"init",[nV,aV,rV],Object.getOwnPropertyDescriptor(lV.prototype,"init"),lV.prototype),oV=lV))||oV)||oV)||oV)||oV)||oV)||oV)||oV)||oV)||oV),dV=function(e){return e.SUCCESS="success",e.FAILED="failed",e.FILLED_BY_SYNC="filled_by_sync",e}({}),uV=function(e){return e.NONE="none",e.CLOSE_APP="close_app",e}({}),hV=function(e){return e.NEW="new",e.RESUME="resume",e.RESUME_AND_NEW="resume_and_new",e}({}),gV=function(e){return e[e.AVG_EXECUTION_TIME_EACH_CONV=151050]="AVG_EXECUTION_TIME_EACH_CONV",e[e.AVG_BATCH=151051]="AVG_BATCH",e[e.AVG_BATCH_RETRY=151052]="AVG_BATCH_RETRY",e[e.AVG_CONV=151053]="AVG_CONV",e[e.AVG_NEW_CONV=151054]="AVG_NEW_CONV",e[e.ERROR_RUNNING=151055]="ERROR_RUNNING",e}({}),mV=function(e){return e.SYNC_MESSAGE="SYNC_MESSAGE",e}({});var pV=s("Fbac");let fV=function(e){return e.PREPARE_BATCH="PREPARE_BATCH",e.FETCH_MESSAGE="FETCH_MESSAGE",e.PROCESS_MESSAGE="PROCESS_MESSAGE",e}({}),vV=function(e){return e[e.PREPARE_BATCH=0]="PREPARE_BATCH",e[e.FETCH_MESSAGE=1]="FETCH_MESSAGE",e[e.PROCESS_MESSAGE=2]="PROCESS_MESSAGE",e}({});class bV extends Jh.a{constructor(e,t){super("ErrorTaskAborted",-1,`Task [type,id]=[${e},${t}] is aborted`)}}let IV=function(e){return e.ABORT="ABORT",e.PAUSE="PAUSE",e.RESUME="RESUME",e.FULFILLED="FULFILLED",e}({});class yV extends Fe.b{constructor(){super(),this.id=void 0,this.type=void 0,this.promiseContainer=void 0,this.abortee=void 0,this.status=void 0,this.isPaused=void 0,this.result=void 0,this.error=void 0,this.onAbort=()=>{this.error=new bV(this.type,this.id),this.resolvePromise(),this.dispatchEvent(new Fe.a(IV.ABORT))},this.status="idle",this.isPaused=!1,this.abortee=new AbortController,this.promiseContainer=new Be.c.Container}exec(e){return this.status="pending",this.abortee.signal.addEventListener("abort",this.onAbort,{once:!0}),Be.c.catchPromise(e()).then((([e,t])=>{this.error=e,this.result=t,this.status="fulfilled",this.isPaused||this.resolvePromise()})),this}toPromise(){return this.promiseContainer.promise}pause(){this.isPaused=!0,this.dispatchEvent(new Fe.a(IV.PAUSE))}resume(){this.isPaused=!1,this.dispatchEvent(new Fe.a(IV.RESUME)),this.abortee.signal.aborted||"fulfilled"===this.status&&this.resolvePromise()}abort(){this.abortee.abort()}resolvePromise(){this.error?this.promiseContainer.reject(this.error):this.promiseContainer.resolve(this.result),this.dispatchEvent(new Fe.a(IV.FULFILLED)),this.abortee.signal.removeEventListener("abort",this.onAbort),this.removeAllEventListener()}}class _V extends yV{constructor(){super(),this.id=void 0,this.type="prepare",this.id=++_V.counter}}_V.counter=0;class CV extends yV{constructor(){super(),this.id=void 0,this.type="fetch",this.id=++CV.counter}}CV.counter=0;class OV extends yV{constructor(){super(),this.id=void 0,this.type="process",this.id=++OV.counter}}OV.counter=0;class EV extends yV{constructor(){super(),this.id=void 0,this.type="sleep",this.id=++EV.counter}}EV.counter=0;const MV={isBackground:!1,pausedCounter:0,error:null,totalMessageFetched:0,totalMessageSaved:0,task:null,currentStep:fV.PREPARE_BATCH,convCheckpoint:null,batchRequestInfo:null,batchResponseInfo:null,retryCounter:0};var SV;let TV=Object(wG.d)()(SV=Object(td.e)()(SV=Object(wG.e)(TG.i)(SV=function(e,t){return Object(td.d)(TG.h)(e,void 0,0)}(SV=function(e,t){return Object(td.d)(TG.b)(e,void 0,1)}(SV=function(e,t){return Object(td.d)(TG.n)(e,void 0,2)}(SV=function(e,t){return Object(td.d)(TG.o)(e,void 0,3)}(SV=function(e,t){return Object(td.d)(TG.k)(e,void 0,4)}(SV=function(e,t){return i.ModuleContainer.inject(TG.d)(e,void 0,5)}(SV=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,6)}(SV=function(e,t){return Object(td.d)(RG)(e,void 0,7)}(SV=function(e,t){return Object(td.d)(TG.e)(e,void 0,8)}(SV=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,9)}(SV=Reflect.metadata("design:type",Function)(SV=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IDevtoolMonitor?Object:AFMC_IDevtoolMonitor,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(SV=class extends vI.a{constructor(e,t,s,i,n,a,r,o,l,c){super(),this.logger=void 0,this.config=void 0,this.ledger=void 0,this.service=void 0,this.storage=void 0,this.monitor=void 0,this.metrics=void 0,this.systemTime=void 0,this.socketPolling=void 0,this.eventCollector=void 0,this.currentSessionFetchInfo=void 0,this.pendingGetRemainConvIds=void 0,this.registerSessionFetchListener=()=>{this.logger.zsymb(0,"7D35o1","register session fetch listener"),this.eventCollector.addEventListener(GG.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.addEventListener(GG.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.addEventListener(GG.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.unregisterSessionFetchListener=()=>{this.logger.zsymb(0,"9NInzg","unregister session fetch listener"),this.eventCollector.removeEventListener(GG.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.removeEventListener(GG.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.removeEventListener(GG.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.onEventChange=e=>{switch(e.type){case"START":this.onMachineStartFetch(),this.registerSessionFetchListener();break;case"STOP":this.unregisterSessionFetchListener(),this.onMachineStopFetch();break;case"NEXT_TO_SLEEP_TO_NEXT_HOUR":this.logger.zsymb(0,"dI2Aw9","Busy hour, let sleep to next hour");break;case"TRY_MOVE_TO_NEXT_CONV":this.onFetchConvError(e.data.currConvId);break;case"PROCESS_MESSAGE_SUCCESS":this.storage.saveTotalMessageFetched(e.data.totalMessageFetched);break;case"FAILED":const t=this.interpreter.state.context,{batchRequestInfo:s,currentStep:i}=t,n=`${i}-${null==s?void 0:s.convId}-${null==s?void 0:s.requestMsgId}`;this.logger.zsymb(18,"gztZoz",`An error ocurred during fetch message ${n}`),this.logger.zsymb(18,"0_1m7B",e.error),this.metrics.submitErrorRunning(i,e.error)}},this.onEventChangeForDevtool=async e=>{switch(e.type){case"PREPARE_BATCH_SUCCESS":this.monitor.updateBatchRequestInfo(e.data.batchRequestInfo),this.monitor.updateRemainConv(await this.ledger.size()),this.config.get("debugger.logger.batch_request_info")&&this.logger.zsymb(12,"0MAgWs","batch request info",e.data.batchRequestInfo);break;case"PROCESS_MESSAGE_SUCCESS":var t,s;if(this.monitor.updateTotalMessageFetched(e.data.totalMessageFetched),this.config.get("debugger.logger.save_message"))this.logger.zsymb(12,"JmBkwD","save message result",null===(t=e.data.result)||void 0===t?void 0:t.batchInfo,null===(s=e.data.result)||void 0===s?void 0:s.messages.map((e=>e.msgId)));break;case"STOP":this.monitor.updateBatchRequestInfo(null),this.monitor.updateRemainConv(await this.ledger.size())}},this.onTransitionChangeForDevtool=e=>{const t=["idle","running","paused","locked"];for(const s of t)if(e.matches(s))return this.monitor.updateStatus(s)},this.onFetchConvError=async e=>{this.logger.zsymb(18,"ue16kc","Save conv fetch failed",e),await this.storage.saveConvErrorId(e)},this.onMachineStartFetch=()=>{var e,t;this.metrics.submitStartFetchReport(null!==(e=null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.startType)&&void 0!==e?e:null)},this.onMachineStopFetch=async()=>{var e,t;await this.metrics.submitStopFetchReport((null===(e=this.currentSessionFetchInfo)||void 0===e?void 0:e.startType)||null,(null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.interuptType)||null,await this.ledger.size()),this.currentSessionFetchInfo=null},this.onStartPullDataOffline=()=>{this.pauseMachine(),this.enablePendingGetRemainConv()},this.onStopPullDataOffline=async()=>{var e,t,s,i;let[n,a]=await Be.c.catchPromise(this.ledger.size());null!==(e=a)&&void 0!==e||(a=0),a>0&&this.metrics.logResumeFetchAfterInterupt();const[r,o]=await Be.c.catchPromise(this.ledger.init());if(null===(t=this.pendingGetRemainConvIds)||void 0===t||t.resolve(),this.pendingGetRemainConvIds=null,r)return this.logger.zsymb(18,"ulQ3TL","An error occured during init ledger",r),this.stopMachine(),this.disablePendingGetRemainConv(),void(this.currentSessionFetchInfo=null);const{isHasNewConv:l,isEvict:c}=o;if(0===await this.ledger.size())return this.logger.zsymb(0,"76VuTQ","stop machine"),this.stopMachine(),this.disablePendingGetRemainConv(),void(this.currentSessionFetchInfo=null);l&&this.resetMachine(),this.currentSessionFetchInfo={startType:l&&a>0?hV.RESUME_AND_NEW:l&&0===a?hV.NEW:hV.RESUME},null!==(s=this.interpreter)&&void 0!==s&&null!==(i=s.state.history)&&void 0!==i&&i.matches("running")?(this.logger.zsymb(0,"VEyTI-","resume machine"),this.resumeMachine()):(this.logger.zsymb(0,"LIrPJc","start machine"),this.startMachine()),this.disablePendingGetRemainConv(),await this.storage.saveStartFetchInfo({evict:c,tsStart:this.systemTime.getTimeNow(),tsSufficient:await this.storage.getLastTsSufficientMessage()})},this.onStartTransferMessage=()=>{this.pauseMachine()},this.onStopTransferMessage=async e=>{const t=await this.ledger.size();t>0&&this.currentSessionFetchInfo&&e.isSuccess&&(this.currentSessionFetchInfo.interuptType=mV.SYNC_MESSAGE),e.isSuccess?(await this.ledger.clear(),this.stopMachine()):this.resumeMachine();t>0&&this.metrics.logStopInteruptFetch(mV.SYNC_MESSAGE,e.isSuccess)},this.onDeleteConv=async e=>{this.logger.zsymb(0,"-MH3br",`Receive delete conversation ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLeaveGroup=async e=>{this.logger.zsymb(0,"e9aUsD",`Receive leave group ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLoadMessage=e=>{if(!this.config.get("enable_fetch_foreground"))return;this.pauseMachine();const t=this.config.get("debugger.simulator.slow_load_message");e.promiseContainer.promise.then((()=>t?Be.c.delay(5e3):void 0)).finally((()=>this.resumeMachine()))},this.onApplicationBackground=()=>{this.backgroundMachine()},this.onApplicationForeground=()=>{this.foregroundMachine()},this.autoStartMachine=()=>{var e,t;null!==(e=this.socketPolling.chatHandler)&&void 0!==e&&e.isDoneOffline&&null!==(t=this.interpreter)&&void 0!==t&&t.state.matches("idle")&&(this.logger.zsymb(0,"_hjjza","Done offline detected, auto dispatch stop pull offline"),this.onStopPullDataOffline())},this.startMachine=()=>this.send({type:"START"}),this.resetMachine=()=>this.send({type:"RESET"}),this.stopMachine=()=>this.send({type:"STOP"}),this.pauseMachine=()=>this.send({type:"PAUSED"}),this.resumeMachine=()=>this.send({type:"RESUME"}),this.foregroundMachine=()=>this.send({type:"FOREGROUND"}),this.backgroundMachine=()=>this.send({type:"BACKGROUND"}),this.enablePendingGetRemainConv=()=>{var e;null!==(e=this.pendingGetRemainConvIds)&&void 0!==e||(this.pendingGetRemainConvIds=new Be.c.Container)},this.disablePendingGetRemainConv=()=>{var e;null===(e=this.pendingGetRemainConvIds)||void 0===e||e.resolve(),this.pendingGetRemainConvIds=null},this.logger=c.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[Ve.ZLoggerNametags.stateMachine]),this.ledger=e,this.config=t,this.service=s,this.storage=i,this.metrics=n,this.monitor=a,this.systemTime=r,this.socketPolling=o,this.eventCollector=l,this.pendingGetRemainConvIds=null,this.currentSessionFetchInfo=null}createMachine(){return e=this.ledger,t=this.service,Object(bI.a)({id:"afmc-machine-v2",initial:"idle",context:MV,states:{idle:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},running:{id:"running",type:"compound",initial:"checking",states:{checking:{invoke:{src:s=>async i=>{var n;if(null===await e.getCursor().value())return void i({type:"STOP"});const[a,r]=t.checkBusyHour();if(a)i({type:"NEXT_TO_SLEEP_TO_NEXT_HOUR",data:{time:r}});else if("sleep"!==(null===(n=s.task)||void 0===n?void 0:n.type))if(s.isBackground||t.allowFetchForeground())switch(s.currentStep){case fV.PREPARE_BATCH:return void i({type:"NEXT_TO_PREPARE_BATCH"});case fV.FETCH_MESSAGE:return void i({type:"NEXT_TO_FETCH_MESSAGE"});case fV.PROCESS_MESSAGE:return void i({type:"NEXT_TO_PROCESS_MESSAGE"});default:return void i({type:"NEXT_TO_SLEEP"})}else i({type:"NEXT_TO_SLEEP"});else i({type:"NEXT_TO_SLEEP"})}},on:{NEXT_TO_PREPARE_BATCH:{target:"#running.prepareBatch"},NEXT_TO_FETCH_MESSAGE:{target:"#running.fetchMessage"},NEXT_TO_PROCESS_MESSAGE:{target:"#running.processMessage"},NEXT_TO_SLEEP:{target:"#running.sleep"},NEXT_TO_SLEEP_TO_NEXT_HOUR:{target:"#running.sleep"},STOP:{target:"#afmc-machine-v2.idle"}}},prepareBatch:{invoke:{src:s=>async i=>{var n;if("prepare"===(null===(n=s.task)||void 0===n?void 0:n.type))s.task.resume();else{const n=s.task=new _V,r=e.getCursor(),o=await r.value(),l=o.metrics.timeTracker.prepare.getTracker();try{l.start();const e=await n.exec((async()=>{const e=await o.getCursor().value();return null===e?(t.reloadMessageOfConv(o.convId),await r.next(),null):(o.metrics.increaseBatch(),{convCheckpoint:o,batchRequestInfo:e})})).toPromise(),{convCheckpoint:a=null,batchRequestInfo:c=null}=e||{};s.convCheckpoint=o,s.batchRequestInfo=c,a&&c?(s.currentStep=fV.FETCH_MESSAGE,i({type:"PREPARE_BATCH_SUCCESS",data:{batchRequestInfo:c,convCheckpoint:a}})):i({type:"MOVE_TO_NEXT_CONV"})}catch(a){if(a instanceof bV)return;i({type:"FAILED",error:a})}finally{l.end()}}}},on:{PREPARE_BATCH_SUCCESS:{target:"#running.checking",actions:"clearTask"},MOVE_TO_NEXT_CONV:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},fetchMessage:{invoke:{src:e=>async s=>{var i;if("fetch"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new CV,{batchRequestInfo:a,convCheckpoint:r}=e,o=r.metrics.timeTracker.fetch.getTracker();try{o.start();const n=await i.exec((()=>t.fetchMessages(a))).toPromise();e.batchResponseInfo=n,e.currentStep=fV.PROCESS_MESSAGE,s({type:"FETCH_MESSAGE_SUCCESS",data:{batchResponseInfo:n}})}catch(n){if(n instanceof bV)return;s({type:"FAILED",error:n})}finally{o.end()}}}},on:{FETCH_MESSAGE_SUCCESS:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},processMessage:{invoke:{src:e=>async s=>{var i;if("process"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new OV,{batchRequestInfo:r,batchResponseInfo:o,convCheckpoint:l}=e,c=l.metrics.timeTracker.sync.getTracker();try{var n;c.start();const a=o.groupMsgs,d=await i.exec((async()=>{const e=await t.processMessages(r,a);return await l.getCursor().next({messages:a,requestMsgId:r.requestMsgId,lastMsgId:r.lastMsgId,checkLoadTop:!0,hasMore:o.hasMore,minMsgIdFromServer:o.minMsgId,maxMsgIdFromServer:o.maxMsgId}),e})).toPromise();e.totalMessageFetched+=a.length,e.totalMessageSaved+=(null==d||null===(n=d.messages)||void 0===n?void 0:n.length)||0,e.error=null,e.retryCounter=0,e.currentStep=fV.PREPARE_BATCH,s({type:"PROCESS_MESSAGE_SUCCESS",data:{result:d,totalMessageFetched:a.length}})}catch(a){if(a instanceof bV)return;s({type:"FAILED",error:a})}finally{c.end()}}}},on:{PROCESS_MESSAGE_SUCCESS:{target:"#running.sleep",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},sleep:{invoke:{src:(e,s)=>async i=>{var n;if("sleep"===(null===(n=e.task)||void 0===n?void 0:n.type))e.task.resume();else{const n=e.task=new EV;try{let a=0;switch(s.type){case"NEXT_TO_SLEEP_TO_NEXT_HOUR":case"RETRY":a=s.data.time;break;default:a=t.getThrottle(e.isBackground)}await n.exec((()=>Be.c.delay(a))).toPromise(),i({type:"WAKE_UP"})}catch(a){}}}},on:{WAKE_UP:{target:"#running.checking",actions:"clearTask"}}},checkRetry:{invoke:{src:s=>async i=>{var n;const[a,r]=t.checkMaxRetryBatch(s.retryCounter,s.isBackground);if(a){var o;await e.getCursor().next();const t=(null===(o=s.batchRequestInfo)||void 0===o?void 0:o.convId)||"";return s.error=null,s.retryCounter=0,s.currentStep=fV.PREPARE_BATCH,i({type:"TRY_MOVE_TO_NEXT_CONV",data:{currConvId:t}})}return null===(n=s.convCheckpoint)||void 0===n||n.metrics.increaseRetry(),s.retryCounter++,i({type:"RETRY",data:{time:r}})}},on:{RETRY:{target:"#running.sleep"},TRY_MOVE_TO_NEXT_CONV:{target:"#running.sleep"}}}}},paused:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},resume:{invoke:{src:e=>async t=>{e.pausedCounter?t({type:"RESUME_PAUSED"}):t({type:"RESUME_RUNNING"})}},on:{RESUME_PAUSED:{target:"#afmc-machine-v2.paused"},RESUME_RUNNING:{target:"#afmc-machine-v2.running"}}}},on:{PAUSED:{target:"#afmc-machine-v2.paused",actions:["increasePausedCounter","pauseTask","logPausedCounter"]},STOP:{target:"#afmc-machine-v2.idle",actions:["abortTask","resetAll"]},RESET:{actions:"reset"},START:{target:"#afmc-machine-v2.resume",actions:"decreasePausedCounter"},FOREGROUND:{actions:"foreground"},BACKGROUND:{actions:"background"}}},{actions:{attachError:pV.a.assign(((e,t)=>Object(f.a)(Object(f.a)({},e),{},{error:t.error}))),abortTask:e=>{var t;return null!==(t=e.task)&&void 0!==t&&t.abort(),e.task=null},pauseTask:e=>{var t;return null===(t=e.task)||void 0===t?void 0:t.pause()},clearTask:pV.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{task:null}))),increasePausedCounter:pV.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{pausedCounter:e.pausedCounter+1}))),decreasePausedCounter:pV.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{pausedCounter:Math.max(e.pausedCounter-1,0)}))),logPausedCounter:e=>{NG.a},foreground:pV.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{isBackground:!1}))),background:pV.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{isBackground:!0}))),reset:pV.a.assign((({isBackground:e,pausedCounter:t})=>Object(f.a)(Object(f.a)({},MV),{},{isBackground:e,pausedCounter:t}))),resetAll:pV.a.assign((()=>Object(f.a)({},MV)))}});var e,t}start(){super.start(),this.registerListener(),this.autoStartMachine()}stop(){this.unregisterListener(),this.unregisterSessionFetchListener(),super.stop(),this.monitor.updateStatus("disabled")}hasRemainConvInPrevSession(){return null!==this.currentSessionFetchInfo&&this.currentSessionFetchInfo.startType!==hV.NEW}async getRemainConvIds(){var e,t;const s=null===(e=this.interpreter)||void 0===e?void 0:e.state;if(!s)return[];var i;!1===("idle"===s.value&&"STOP"===s.event.type)&&(null!==(i=this.pendingGetRemainConvIds)&&void 0!==i||(this.pendingGetRemainConvIds=new Be.c.Container));await(null===(t=this.pendingGetRemainConvIds)||void 0===t?void 0:t.promise);return(await this.ledger.getRemainCheckpoints()).map((e=>e.convId))}registerListener(){var e,t,s;(this.logger.zsymb(0,"hLop_6","register persit listener"),this.eventCollector.addEventListener(GG.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.addEventListener(GG.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.addEventListener(GG.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.addEventListener(GG.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.addEventListener(GG.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.addEventListener(GG.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.onEvent(this.onEventChange),NG.a)&&(null===(t=this.interpreter)||void 0===t||t.onEvent(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.onTransition(this.onTransitionChangeForDevtool))}unregisterListener(){var e,t,s;(this.logger.zsymb(0,"fiTsUx","unregister persit listener"),this.eventCollector.removeEventListener(GG.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.removeEventListener(GG.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.removeEventListener(GG.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.removeEventListener(GG.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.removeEventListener(GG.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.removeEventListener(GG.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.off(this.onEventChange),NG.a)&&(null===(t=this.interpreter)||void 0===t||t.off(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.off(this.onTransitionChangeForDevtool))}async handleRemoveConv(e){this.pauseMachine(),await this.ledger.remove(e)?(this.logger.zsymb(0,"ke2Mxz",`Disabled checkpoint ${e} success`),this.resetMachine()):this.logger.zsymb(0,"HzWVw8",`Checkpoint ${e} does not exist`),this.resumeMachine()}})||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV)||SV;var wV,RV=s("BYQe");let LV=Object(td.e)()(wV=Object(wG.d)()(wV=Object(wG.e)(TG.j)(wV=function(e,t){return Object(td.d)(TG.f)(e,void 0,0)}(wV=function(e,t){return Object(td.d)(TG.p)(e,void 0,1)}(wV=function(e,t){return Object(td.d)(TG.g)(e,void 0,2)}(wV=Reflect.metadata("design:type",Function)(wV=Reflect.metadata("design:paramtypes",["undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler])(wV=class{constructor(e,t,s){this.processor=void 0,this.processor=(new RV.Chain).pipe(e).pipe(t).pipe(s)}async process(e,t){return await this.processor.process({batchInfo:e,messages:t})}})||wV)||wV)||wV)||wV)||wV)||wV)||wV)||wV;var DV;let AV=Object(wG.d)()(DV=Object(td.e)()(DV=Object(wG.e)(TG.k)(DV=function(e,t){return i.ModuleContainer.inject(at.b)(e,void 0,0)}(DV=function(e,t){return Object(td.d)(FG)(e,void 0,1)}(DV=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,2)}(DV=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,3)}(DV=function(e,t){return Object(td.d)(TG.o)(e,void 0,4)}(DV=function(e,t){return Object(td.d)(TG.b)(e,void 0,5)}(DV=Reflect.metadata("design:type",Function)(DV=Reflect.metadata("design:paramtypes",["undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof IActionlogService?Object:IActionlogService,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(DV=class{constructor(e,t,s,i,n,a){this.logger=void 0,this.qos=void 0,this.config=void 0,this.storage=void 0,this.actionlog=void 0,this.systemTime=void 0,this.qos=e,this.config=a,this.storage=n,this.actionlog=t,this.systemTime=i,this.logger=s.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[Ve.ZLoggerNametags.metricz])}logAutoHideBannerSuggestion(){this.actionlog.logAction(2460001)}logAutoShowBannerSuggestion(e){this.actionlog.logAction(e?2460003:2460002)}logStartFetch(e,t){switch(this.actionlog.logAction(2460101),t){case HG.ONLY_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460102);break;case HG.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460103)}}logStopFetch(e,t,s){if(!s)return this.actionlog.logAction(2460401);switch(this.actionlog.logAction(2460201),t){case HG.ONLY_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460202);break;case HG.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460203)}}logStopInteruptFetch(e,t){if(e===mV.SYNC_MESSAGE)this.actionlog.logAction(t?2460302:2460303)}logResumeFetchAfterInterupt(){this.actionlog.logAction(2460304)}async submitStartFetchReport(e){if(null===e)return;const t={type:e,total_days_to_fetch:Be.j.countDays(await this.storage.getLastTsSufficientMessage(),this.systemTime.getTimeNow()),days_to_fetch_from_new_evict:-1};this.logger.zsymb(12,"DLFJ6k","submit start fetch report",JSON.stringify(t)),this.actionlog.logActionInfoV2(as.FeaturesInfo.AutoFetchMessageCloud,2,t)}async submitStopFetchReport(e,t,s){var i,n,a,r;if(null===e)return;const o=await this.storage.getFetchInfo();if(null==o||!o.onProgressInfo)return;const l=this.systemTime.getTimeNow(),c=o.onProgressInfo.totalMsgFetched||0,d={result:t===mV.SYNC_MESSAGE?dV.FILLED_BY_SYNC:s>0?dV.FAILED:dV.SUCCESS,interupted:(()=>{switch(e){case hV.RESUME:case hV.RESUME_AND_NEW:return uV.CLOSE_APP;case hV.NEW:default:return uV.NONE}})(),filled_queue_evict:(()=>{var e;return Be.j.countDays(o.onProgressInfo.tsSufficient,l)>this.config.get("max_time_check_insufficient_data")||null!==(e=o.onProgressInfo)&&void 0!==e&&e.evict?0:1})(),estimated_fetching_time:(()=>Math.ceil(c/this.config.get("batch_size"))*this.config.get("throttle")/1e3)(),total_day_with_session_fetch:Be.j.countUniqDays(...null!==(i=null==o||null===(n=o.onProgressInfo)||void 0===n?void 0:n.listTsStart)&&void 0!==i?i:[]),days_from_start_to_complete:(()=>{var e,t;const s=Math.min(...null!==(e=null===(t=o.onProgressInfo)||void 0===t?void 0:t.listTsStart)&&void 0!==e?e:[-1]);return s<0?-1:Be.j.countDays(s,l)})(),total_conv_fetched:(null===(a=o.onProgressInfo.convIds)||void 0===a?void 0:a.length)||0,conv_fetch_failed:(null===(r=o.onProgressInfo.convErrorIds)||void 0===r?void 0:r.length)||0,total_msg_fetched:c};this.logger.zsymb(12,"mtI9rq","submit stop fetch report",JSON.stringify(d)),this.actionlog.logActionInfoV2(as.FeaturesInfo.AutoFetchMessageCloud,1,d),await this.storage.removeStartFetchInfo()}submitConvReport(e){NG.a&&this.logger.zsymb(12,"QJsD6_","submit metrics for conv",e.convId,JSON.stringify(e)),this.qos.log({commandId:gV.AVG_EXECUTION_TIME_EACH_CONV,success:!0,startTime:0,duration:e.duration.total,params:[JSON.stringify(e)]}),this.qos.log({commandId:gV.AVG_BATCH,success:!0,startTime:0,duration:e.meta.total}),this.qos.log({commandId:gV.AVG_BATCH_RETRY,success:!0,startTime:0,duration:e.meta.retry})}submitLedgerReport(e){const t=e.length,s=e.filter((e=>e.isNew)).length;NG.a&&this.logger.zsymb(12,"jwmeGN","submit ledger report",JSON.stringify({totalConv:t,totalNewConv:s})),this.qos.log({commandId:gV.AVG_CONV,success:!0,startTime:0,duration:t}),this.qos.log({commandId:gV.AVG_NEW_CONV,success:!0,startTime:0,duration:s})}submitErrorRunning(e,t){this.qos.log({commandId:gV.ERROR_RUNNING,success:!1,startTime:0,errorCode:vV[e],params:[e,t.name,...t.qosParams]})}})||DV)||DV)||DV)||DV)||DV)||DV)||DV)||DV)||DV)||DV)||DV;var FV;let jV=Object(wG.d)()(FV=Object(wG.e)(TG.f)(FV=class{async process(e){const{batchInfo:t,messages:s}=e,i=s.filter((e=>parseInt(e.msgId)>parseInt(t.lastDeleteMsgId)));return{batchInfo:t,messages:i}}})||FV)||FV;var PV;let kV=Object(td.e)()(PV=Object(wG.d)()(PV=Object(wG.e)(TG.g)(PV=function(e,t){return Object(td.d)(AG)(e,void 0,0)}(PV=Reflect.metadata("design:type",Function)(PV=Reflect.metadata("design:paramtypes",["undefined"==typeof IZSearchV3?Object:IZSearchV3])(PV=class{constructor(e){this.zsearchV3=e}async process(e){return this.zsearchV3.executeData(this.filterMessageSearchable(e.messages)),e}filterMessageSearchable(e){return e.filter((e=>{var t;return"chat.delete"!==e.msgType&&"chat.undo"!==e.msgType&&"chat.list.action"!==e.msgType&&"msginfo.actionlist"!==(null===(t=e.content)||void 0===t?void 0:t.action)}))}})||PV)||PV)||PV)||PV)||PV)||PV;var NV;let UV=Object(td.e)()(NV=Object(wG.d)()(NV=Object(wG.e)(TG.p)(NV=function(e,t){return Object(td.d)(DG)(e,void 0,0)}(NV=function(e,t){return Object(td.d)(jG)(e,void 0,1)}(NV=Reflect.metadata("design:type",Function)(NV=Reflect.metadata("design:paramtypes",["undefined"==typeof IZStorage?Object:IZStorage,"undefined"==typeof IImportantMsgManager?Object:IImportantMsgManager])(NV=class{constructor(e,t){this.zstorage=e,this.importantMsgManager=t}async process(e){var t;const{batchInfo:s,messages:i}=e,[n,a]=await Be.c.catchPromise(this.zstorage.addMessages(s.convId,i,void 0));Zh(n,new mz("Save messages error "+JSON.stringify(n))),this.importantMsgManager.receiveImportantMessage((null==a?void 0:a.messages)||[]);const r=(null!==(t=null==a?void 0:a.messages)&&void 0!==t?t:[]).map((e=>e.msgId));return{batchInfo:s,messages:i.filter((e=>r.includes(e.msgId)))}}})||NV)||NV)||NV)||NV)||NV)||NV)||NV;var BV;let xV=Object(td.e)()(BV=Object(wG.d)()(BV=Object(wG.e)(TG.m)(BV=function(e,t){return i.ModuleContainer.inject(cg)(e,void 0,0)}(BV=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,1)}(BV=function(e,t){return Object(td.d)(TG.b)(e,void 0,2)}(BV=Reflect.metadata("design:type",Function)(BV=Reflect.metadata("design:paramtypes",["undefined"==typeof ICloudSegmentController?Object:ICloudSegmentController,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(BV=class{constructor(e,t,s){this.segmentController=e,this.systemTime=t,this.config=s,this.mapTsSplitSegmentRange={},this.tsEvictQueue=void 0,this.tsEvictQueue=this.systemTime.getTimeNow()}process(e){const[t,s]=e;return!s&&this.config.get("enable_segment_updater")&&Be.c.Macrotask.push((()=>this.updateSegment(t))),e}getGroupMessages(e){return e.deliverProcessData.groupMsgs}hasEvict(e){var t,s;const i=null!==(t=null==e||null===(s=e.deliverProcessData)||void 0===s?void 0:s.queueStatus)&&void 0!==t?t:{};for(const a of this.config.get("group_queue_config")){var n;if(null!==(n=i[a])&&void 0!==n&&n.evict)return!0}return!1}classifyMessagesByConv(e){const t={};for(const i of e){var s;const e=i.isGroup?i.msgKey:i.idTo;(t[e]=null!==(s=t[e])&&void 0!==s?s:[]).push(i)}return t}async updateSegment(e){const t=this.getGroupMessages(e);if(0===t.length)return;this.hasEvict(e)&&(this.tsEvictQueue=this.systemTime.getTimeNow());const s=this.classifyMessagesByConv(t),i=[];for(const n in s){const e=s[n],t=this.getRange(e);i.push(this.update(n,t,this.getModeMerged(n)))}await Promise.all(i)}getModeMerged(e){var t;let s="merge";return(null!==(t=this.mapTsSplitSegmentRange[e])&&void 0!==t?t:0)<this.tsEvictQueue&&(s="split",this.mapTsSplitSegmentRange[e]=this.systemTime.getTimeNow()),s}getRange(e){e.sort(Be.b.Sorter.create([{key:"msgId",comparer:Be.b.Sorter.Comparer.number,order:Be.b.Sorter.Order.ASC},{key:"ts",comparer:Be.b.Sorter.Comparer.number,order:Be.b.Sorter.Order.ASC}]));const t=e.filter((e=>!isNaN(Number(e.msgId)))),s=t[0],i=t[t.length-1];return[Number(s.msgId),Number(i.msgId)]}async update(e,t,s){const i=await this.segmentController.get(e),n=0===(null!==(a=i.cloudSegmentCheckAutoFetch)&&void 0!==a?a:[]).length?(s="split",null!==(o=i.cloudSegmentCheck)&&void 0!==o?o:[]):null!==(r=i.cloudSegmentCheckAutoFetch)&&void 0!==r?r:[];var a,r,o;const l=this.mergeSegment(t,n);switch(s){case"split":i.cloudSegmentCheckAutoFetch=l;break;case"merge":i.cloudSegmentCheckAutoFetch=this.connectRange(t,l)}await this.segmentController.update(i)}connectRange(e,t){const s=[];for(let i=0;i<t.length;i++){const n=t[i],a=t[i-1];if(BC.a.isEqual(e,n)&&a){const e=a[0],t=n[1];s.pop(),s.push([e,t])}else s.push(n)}return s}mergeSegment(e,t){if(!e||2!==e.length||e[0]>e[1])return t;if(0==t.length)return[e];const s=[],[i,n]=e;let a=0,r=0;for(let o=0;o<t.length;o++){const e=t[o],l=e[0],c=e[1]===parseInt(R.MessageConstants.MAX_MSG_ID)?e[0]+1:e[1];if(r){s.push(...t.slice(o));break}i>c?(s.push([l,c]),o===t.length-1&&s.push([i,n])):(0===a&&(a=i<l?i:l),n<l?(r=n,s.push([a,r]),s.push([l,c])):n<=c&&n>=l?(r=c,s.push([a,c])):n>c&&o===t.length-1&&s.push([a,n]))}return s}})||BV)||BV)||BV)||BV)||BV)||BV)||BV)||BV;var GV;let zV=Object(wG.d)()(GV=Object(td.e)()(GV=Object(wG.e)(TG.q)(GV=function(e,t){return Object(td.d)(TG.b)(e,void 0,0)}(GV=function(e,t){return Object(td.d)(TG.o)(e,void 0,1)}(GV=function(e,t){return Object(td.d)(TG.e)(e,void 0,2)}(GV=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,3)}(GV=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,4)}(GV=Reflect.metadata("design:type",Function)(GV=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(GV=class{constructor(e,t,s,i,n){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.prevNetworkState=void 0,this.intervalUpdate=void 0,this.onApplicationExit=()=>{this.updateLastSufficientTs(),this.clearIntervalUpdate()},this.onStartPullOffline=()=>{this.clearIntervalUpdate()},this.onStopPullOffline=()=>{this.updateLastSufficientTs(),this.startIntervalUpdate()},this.logger=n.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=i,this.prevNetworkState=null,this.intervalUpdate=null,this.registerListener(s)}registerListener(e){e.addEventListener(GG.a.START_PULL_OFFLINE_DATA,this.onStartPullOffline),e.addEventListener(GG.a.STOP_PULL_OFFLINE_DATA,this.onStopPullOffline),e.addEventListener(GG.a.APPLICATION_EXIT,this.onApplicationExit)}async updateLastSufficientTs(){const e=await this.getLastTsSufficientMessage(),t=this.systemTime.getTimeNow(),s=await this.storage.getLastTsOverflowMessage()>e?e:t;await this.storage.saveLastSufficientMessage(s),this.config.get("debugger.logger.interval_update_sufficient_ts")&&this.logger.zsymb(12,"NyJIuB","Update last sufficient ts",s)}async getLastTsSufficientMessage(){const e=await Promise.all([this.storage.getLastTsSyncMessageSuccess(),this.storage.getLastTsImportMessageSuccess(),this.storage.getLastTsAutoFetchMessageSuccess(),this.storage.getLastTsCloseTransferSuggestion(),this.storage.getLastTsCloseFirstLoginTransferSuggestion(),this.storage.getLastTsSufficientMessage()]);return Math.max(...e)}startIntervalUpdate(){this.clearIntervalUpdate(),this.intervalUpdate=setInterval((()=>{this.updateLastSufficientTs()}),this.config.get("interval_check_insufficient_data"))}clearIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||GV)||GV)||GV)||GV)||GV)||GV)||GV)||GV)||GV)||GV;var VV;let HV=Object(wG.d)()(VV=Object(td.e)()(VV=Object(wG.e)(TG.r)(VV=function(e,t){return Object(td.d)(TG.b)(e,void 0,0)}(VV=function(e,t){return Object(td.d)(TG.o)(e,void 0,1)}(VV=function(e,t){return i.ModuleContainer.inject(In.b)(e,void 0,2)}(VV=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,3)}(VV=function(e,t){return Object(td.d)(TG.e)(e,void 0,4)}(VV=Reflect.metadata("design:type",Function)(VV=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(VV=class{constructor(e,t,s,i,n){this.overflowQueueIds=void 0,this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.logger=i.createZLogger(Ve.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=s,this.overflowQueueIds=[],n.addEventListener(GG.a.OVERFLOW_MESSAGE_QUEUE,(e=>{const t=e.queueId.toString();this.overflowQueueIds.push(t),this.storage.saveLastOverflow(t,this.systemTime.getTimeNow())}))}process(e,t){if(e&&this.config.get("enable_tracking_overflow"))for(const i in e)if(this.config.get("group_queue_config").includes(i)){if(e[i].evict){var s;const e="-1",n=String((null===(s=t[i])||void 0===s?void 0:s.lastId)||1);this.saveOverflowInfo(i,e,n)}}}getOverflowStatus(){const e=!!this.overflowQueueIds.find((e=>this.config.get("group_queue_config").includes(e))),t=!!this.overflowQueueIds.find((e=>this.config.get("one_one_queue_config").includes(e)));return t||e?t&&e?HG.BOTH_1_1_AND_GROUP:t?HG.ONLY_1_1:HG.ONLY_GROUP:HG.NONE}async saveOverflowInfo(e,t,s){const i=await this.storage.getOverflowInfo();(null==i?void 0:i.queueId)!==e&&(await this.storage.saveOverflowInfo(e,t,s),this.logger.zsymb(0,"GL7w9p","Overflow detected, let save info",{queueId:e,lastMsgId:t,lastActionId:s}))}})||VV)||VV)||VV)||VV)||VV)||VV)||VV)||VV)||VV)||VV;var WV,$V=s("h5Sw");Object(i.singleton)(TG.l)(WV=Object(Je.i)()(WV=Object(Je.f)()(WV=Object(wG.c)([BG,AV,Uz,az,cV,YG,zz,xV,UV,LV,TV,kV,oz,jV,HV,zV,{token:DG,useFactory:()=>Rt.default},{token:LG,useFactory:()=>Fi.default},{token:AG,useFactory:()=>ul.a.getInstance()},{token:RG,useFactory:()=>id.default},{token:FG,useFactory:()=>as.default},{token:jG,useFactory:()=>$V.a},{token:PG,useFactory:()=>i.ModuleContainer.resolveIfExist(zg.a)}])(WV=class{onAuthenticating(){this.get(TG.b)}onStart(){this.get(TG.c).start()}get(e){return wG.a.resolve(e)}})||WV)||WV)||WV);var KV;const qV="z_afmc_devtool_";Object(ko.b)(TG.d)(KV=function(e,t){return Object(i.inject)(uc)(e,void 0,0)}(KV=Reflect.metadata("design:type",Function)(KV=Reflect.metadata("design:paramtypes",["undefined"==typeof IMessageController?Object:IMessageController])(KV=class{constructor(e){var t;this.messageController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!0,status:"disabled",totalMessage:0,totalMessageFetched:0,remainConv:0,currentConv:"",currentRequestMsgId:"",totalMessageCurrentConv:0},this.promiseCountTotalMessage=null,this.promiseCountTotalMessageCurrConv=null,this.name="auto-fetch-message-cloud-devtool-monitor",this.key="auto-fetch-message-cloud-devtool-monitor",this.data.isShow=NG.a&&Boolean(Number(null!==(t=E.default.getInstance().getItem(qV))&&void 0!==t?t:"0")),this.toggleUpdateTotalMessage()}toggleDevtool(){!1!==NG.a&&(this.data.isShow=!this.data.isShow,this.data.isShow?E.default.getInstance().setItem(qV,Number(this.data.isShow).toString()):E.default.getInstance().removeItem(qV),Object(hs.h)(this.name,"all"))}updateStatus(e){!1!==NG.a&&(this.data.status=e,Object(hs.h)(this.name,"all"))}async toggleUpdateTotalMessage(){NG.a}async toggleUpdateTotalMessageCurrentConv(){if(!1===NG.a)return;this.promiseCountTotalMessageCurrConv||(this.promiseCountTotalMessageCurrConv=this.messageController.countMessages(this.data.currentConv));const e=await this.promiseCountTotalMessageCurrConv;this.promiseCountTotalMessageCurrConv=null,this.data.totalMessageCurrentConv=e,Object(hs.h)(this.name,"all")}updateTotalMessageFetched(e){!1!==NG.a&&(this.data.totalMessageFetched+=e,Object(hs.h)(this.name,"all"),this.toggleUpdateTotalMessage(),this.toggleUpdateTotalMessageCurrentConv())}updateRemainConv(e){!1!==NG.a&&(this.data.remainConv=e,Object(hs.h)(this.name,"all"))}updateBatchRequestInfo(e){!1!==NG.a&&(this.data.currentConv=(null==e?void 0:e.convId)||"",this.data.currentRequestMsgId=(null==e?void 0:e.requestMsgId)||"",e||(this.data.totalMessageCurrentConv=0),Object(hs.h)(this.name,"all"))}getItem(e,t){return Object(f.a)({},this.data)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||KV)||KV)||KV);var QV,ZV=s("dBRD");Object(i.injectable)()(QV=Object(ko.b)(ZV.b)(QV=Reflect.metadata("design:type",Function)(QV=Reflect.metadata("design:paramtypes",[])(QV=class{constructor(){this.justAddedMessagesOfConvStateMap_=new Map,this.isDevEnv_=void 0,this.separator_="<|>",this.name=ZV.a,this.type=void 0,this.key="",this.isDevEnv_=!1}addJustAddedMessage(e,t,s=!0){if(!e)return;if(!t)return;const i=Array.isArray(t)?t:[t],n={};for(let a=i.length-1;a>=0;a--){const e=i[a],t=rt.p.getSessionUserId()===e.fromUid?"0":e.fromUid,s=this.buildJustAddedMessageStateKey({fromUid:t,toUid:e.toUid,cliMsgId:e.cliMsgId});s&&(n[s]={fromUid:t,toUid:e.toUid,cliMsgId:e.cliMsgId,src:e.src})}this.justAddedMessagesOfConvStateMap_.set(e,{convId:e,aSet:n}),s&&Object(hs.h)(this.name,this.key)}isJustAddedMessage(e){if(!e)return!1;const t=this.getConvIdFromThreeKeyMsgId(e);if(!t)return!1;const s=this.justAddedMessagesOfConvStateMap_.get(t);return!(!s||!s.aSet)&&null!=s.aSet[e]}removeJustAddedMessage(e,t=!0){if(!e)return;const s=this.getConvIdFromThreeKeyMsgId(e),i=this.justAddedMessagesOfConvStateMap_.get(s);if(!i||!i.aSet[e])return;const n=Object(f.a)({},i.aSet);delete n[e],this.justAddedMessagesOfConvStateMap_.set(s,{convId:s,aSet:n}),t&&Object(hs.h)(this.name,e)}getJustAddedMessageList(e){const t=this.getASetOfJustAddedMessage(e);return Object.values(t)}getASetOfJustAddedMessage(e){if(!e)return{};const t=this.justAddedMessagesOfConvStateMap_.get(e);return t&&t.aSet?t.aSet:{}}buildJustAddedMessageStateKey(e){return e&&null!=e.fromUid&&null!=e.toUid&&null!=e.cliMsgId?[e.fromUid,e.toUid,e.cliMsgId].join(this.separator_):""}getConvIdFromThreeKeyMsgId(e){if(!e)return"";return e.split(this.separator_)[1]}init(){}getItem(e){const t=e.key;if(t)return this.justAddedMessagesOfConvStateMap_.get(t)}getList(e){return[]}onGetItemFailure(e,t){this.isDevEnv_}onGetListFailure(e,t){this.isDevEnv_}})||QV)||QV)||QV);var JV;const YV={syncSource:null,forceSyncSource:null,isSyncing:!1};Object(ko.b)(jU.a)(JV=Reflect.metadata("design:type",Function)(JV=Reflect.metadata("design:paramtypes",[])(JV=class{constructor(){this.state=Object(f.a)({},YV),this.name="syc-zcloud-queue-ui",this.key="syc-zcloud-queue-ui"}getSyncSource(){return this.state.syncSource}getForceSyncSource(){return this.state.forceSyncSource}setSyncSource(e){this.setState((t=>{t.syncSource=e}))}setForceSyncSource(e){this.setState((t=>{t.forceSyncSource=e}))}reset(){this.setState((e=>{e.syncSource=null,e.forceSyncSource=null,e.isSyncing=!1}))}isSyncing(){return this.state.isSyncing}setSyncing(e){this.setState((t=>{t.isSyncing=e}))}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(kg.a)(this.state,e);this.state!==t&&(this.state=t,Object(hs.h)(this.name,"current"))}})||JV)||JV);let XV=function(e){return e[e.Integrity=0]="Integrity",e[e.Strict=1]="Strict",e[e.BestEffort=2]="BestEffort",e}({});const eH={enable_feature:!0,roll_on_exceed_quota:!0,max_alive_account:5,roll_mode:XV.Integrity,roll_buffer_count:0,count_user_in_ls:!1},tH=new _i.a({enable_feature:_i.b.field().boolean(),roll_on_exceed_quota:_i.b.field().boolean(),max_alive_account:_i.b.field().number().min(1),roll_mode:_i.b.field().number().max(XV.BestEffort).min(XV.Integrity),roll_buffer_count:_i.b.field().number().min(0),count_user_in_ls:_i.b.field().boolean()});class sH extends yi.ZFeatureConfig{constructor(){super({default:eH,valiator:tH})}selector(e){return e.auto_roll_ls||{}}shouldConfigUpdate(e,t){return!0}}class iH{constructor(e,t,s){this.uid=e,this.keyPath=t,this.lastAccess=s,this.setup=void 0,this.dispose=void 0,this.runner=void 0,this.setup=null,this.runner=null,this.dispose=null}get rawKeyPath(){return this.keyPath.slice(1)}get userIndex(){return this.keyPath.slice(0,1)}installSetup(e){this.setup=e}installRunner(e){this.runner=e}installDispose(e){this.dispose=e}async roll(){this.setup&&await this.setup(),this.runner&&await this.runner(),this.dispose&&await this.dispose()}}class nH extends iH{constructor(e,t,s){super(e,t,s),this.uid=e,this.keyPath=t,this.lastAccess=s,this.runner=async()=>{localStorage.removeItem(this.keyPath)}}}var aH,rH=s("Kfp5");const oH="last_check_exceed_quota",lH=["_z_sc","_cdk","_react","_cl-uc","_rs","_tracking-old-cbb","_pcl-k","_preload_cache","_list_recent_g_search_v2"],cH=152101,dH=152102;Object(Je.i)()(aH=Reflect.metadata("design:type",Function)(aH=Reflect.metadata("design:paramtypes",[])(aH=class{constructor(){this.logger=void 0,this.config=void 0,this._quotaExceed=void 0,this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.localstorage,[Ve.ZLoggerNametags.lsRoller]),this.config=new sH,this._quotaExceed=null}onAuthenticated(){}onStart(){requestIdleCallback((()=>{this.qosCountAccountInLS(),this.roll()}))}async roll(){if(!this.config.get("enable_feature"))return void this.logger.zsymb(0,"EDyXYn","skip roll, feat disable!");if(!this.isExceededQuota()&&this.config.get("roll_on_exceed_quota"))return void this.logger.zsymb(0,"_WVckY","skip roll, quota ok!");const e=this.config.get("max_alive_account"),t=this.config.get("roll_mode"),s=this.getUserAccessTimes(),i=s.slice(e);switch(this.logger.zsymb(0,"OOpWm-","start roll: ",t,s.length,i.length),t){case XV.Integrity:this.doRollMatchingKey(i),this.qosRoll(t,i.length);break;case XV.Strict:this.doRollMatchingId(i),this.qosRoll(t,i.length);break;case XV.BestEffort:{const n=this.config.get("roll_buffer_count"),a=e-n;if(this.doRollMatchingId(i),n&&s.length>=a){const t=s.slice(a,e);this.doRollMatchingKey(t)}this.qosRoll(t,s.length-a);break}default:this.logger.zsymb(0,"DtMOoR","Skip roll, unknow mode!")}}buildRollItems(e){return e.reduce(((e,t)=>(lH.forEach((s=>{const i=`${t.index}${s}`;e.push(new nH(t.uid,i,t.accessTime))})),e)),[])}setupExecutor(e){e.forEach((e=>{"_react"==e.rawKeyPath&&e.installSetup((async()=>{Object(rH.c)(e.uid)}))}))}doRollMatchingKey(e){const t=this.buildRollItems(e);this.setupExecutor(t),this.logger.zsymb(0,"Xv1KJq","roll matching key: ",t.length),t.length&&Promise.all(t.map((e=>e.roll().catch((t=>{this.logger.zsymb(0,"Bj2_a8","roll item got error: ",e.keyPath,t)})))))}doRollMatchingId(e){if(this.logger.zsymb(0,"Rx19Z8","roll matching id: ",e.length),e.length){lu.a.getInstance().cleanupLocalStorageMatchConditions((t=>e.some((e=>t.startsWith(e.index)))))}}isExceededQuota(){if(null!==this._quotaExceed)return this._quotaExceed;this._quotaExceed=!1;try{E.default.getInstance().setItemForCurrentUser(oH,Date.now().toString())}catch(e){this._quotaExceed=22==(null==e?void 0:e.code)}if(!this._quotaExceed){const e=new Blob(Object.values(localStorage)).size;this._quotaExceed=e>=5e6}return this._quotaExceed}getUserAccessTimes(){const e=Object(Ce.f)(),t=[];return e&&e.length&&e.forEach(((e,s)=>{t.push(this.getAccesstimeFor(e,s))})),t.sort(((e,t)=>t.accessTime-e.accessTime)),t}getAccesstimeFor(e,t){const s=localStorage.getItem(`${t}_${R.LAST_TIME_FETCH_ME_PREFIX}`)||0,i=localStorage.getItem(`${t}_${oH}`)||0;return{uid:e,index:t.toString(),accessTime:Math.max(+s,+i)}}qosRoll(e,t){t>0?fi.default.increaseSuccess(cH,e,0,[t]):fi.default.increaseFailed(cH,e,0,-t,Date.now())}qosCountAccountInLS(){if(!this.config.get("count_user_in_ls"))return;const e=this.isExceededQuota(),t=Object(Ce.f)().length;this.logger.zsymb(0,"e1N8Ag","total users in ls: ",e,t),e?fi.default.increaseFailed(dH,0,0,t,Date.now()):fi.default.increaseSuccess(dH,0,0,[t])}})||aH)||aH);var uH,hH=s("HMHh"),gH=s("4Rl+");Object(i.singleton)(hH.e)(uH=Reflect.metadata("design:type",Function)(uH=Reflect.metadata("design:paramtypes",[])(uH=class{constructor(){this.logger=void 0,this.pTracker=void 0,this.lastQueryId=void 0,this.lastQueryId=-1,this.pTracker=new gH.c}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.search,["search-message"])),this.logger}encodeKW(e){return ho.default.md5(e)}async handleResultSearchInChat(e,t,s){const{data:n,hasMore:a,result:r}=s,{id:o,keyword:l,filter:c}=t,d=(null==c?void 0:c.msgType)===R.MSG_FILE,u=n[n.length-1];let h;d?(h={id:o,keyword:l,convId:e,filter:c,messages:[],files:r,hasMoreFiles:a},u&&u.ts&&(h.lastFileTs=+u.ts)):(h={id:o,keyword:l,convId:e,filter:c,files:[],messages:r,hasMoreMessages:a},u&&u.ts&&(h.lastMessageTs=+u.ts)),i.ModuleContainer.resolve(hH.d).onSearchResult(e,h)}isAllowQueryNoKeyword(e){const{filter:t,config:s}=e;return!!(t&&t.convId&&t.searchForEmpty&&(t.fromUid||t.timeRange&&(t.timeRange[0]||t.timeRange[1]))&&null!=s&&s.limit)}checkAbortQuery(e){if(e<this.lastQueryId)throw new Error(`Query ${e} was aborted`)}async querySearchDB(e){const{keyword:t,filter:s,config:i={},id:n}=e;let a=Object(f.a)(Object(f.a)({},i),{},{enableReject:!0}),r=!1;i.limit&&(a=Object(f.a)(Object(f.a)({},a),{},{limit:i.limit+1}));const o=await ul.a.getInstance().search(t,!0,s,null,a);return this.checkAbortQuery(n),o&&i.limit&&o.length>i.limit&&(r=!0,o.pop()),{data:o,hasMore:r}}async getMessagesAfterQuery(e,t){const{id:s,options:n}=t;let a=await i.ModuleContainer.resolve(hH.f).getMessages(e);this.checkAbortQuery(s);const r=a.length;return a=a.filter((e=>!n||!n.predicate||n.predicate(e))),this.Logger.zsymb(0,"ZOMMbj",`get messages id: ${s} total: ${r} after predicate: ${a.length}`),a}async onQueryResponse(e,t){const{filter:s,id:i}=e;return this.checkAbortQuery(i),s&&s.convId&&await this.handleResultSearchInChat(s.convId,e,t),t}async processQuery(e){const{filter:t,id:s,config:i}=e;this.pTracker.start(gH.b.QUERY,s);let{data:n=[],hasMore:a}=await this.querySearchDB(e);this.pTracker.end(gH.b.QUERY),this.pTracker.start(gH.b.GET_MESSAGES,s);let r=await this.getMessagesAfterQuery(n,e);if(this.pTracker.end(gH.b.GET_MESSAGES),a&&i&&r.length<n.length){this.Logger.zsymb(0,"qV5_Tx","continue query due to mismatch",s);const o=n[n.length-1].ts,l=[t&&t.timeRange?t.timeRange[0]:0,o],c=Object(f.a)(Object(f.a)({},e),{},{filter:Object(f.a)(Object(f.a)({},t||{}),{},{timeRange:l}),config:Object(f.a)(Object(f.a)({},i),{},{limit:n.length-r.length})}),d=await this.processQuery(c);n=n.concat(d.data),a=d.hasMore,r=r.concat(d.result)}return{data:n,hasMore:a,result:r}}async query(e){const{keyword:t,id:s}=e;if(this.lastQueryId=s,!vl.a.formatTextSearch(t)&&!this.isAllowQueryNoKeyword(e))return this.onQueryResponse(e,{data:[],hasMore:!1,result:[]});this.Logger.zsymb(0,"iJR_aX","start query with params:",Object(f.a)(Object(f.a)({},e),{},{keyword:this.encodeKW(t)}));const i=await this.processQuery(e);return this.onQueryResponse(e,i)}async queryNoKeyword(e){const{filter:t,config:s,id:n}=e;let a=!1,r=[];if(this.Logger.zsymb(0,"98TphO","start query no kw",e),!(t&&t.convId&&(t.fromUid||t.timeRange&&(t.timeRange[0]||t.timeRange[1]))&&null!=s&&s.limit))return this.onQueryResponse(e,{data:r,hasMore:a,result:[]});const o=t.convId;let l=s;if(s&&s.limit&&(l=Object(f.a)(Object(f.a)({},s),{},{limit:s.limit+1})),t.msgType===R.MSG_FILE){const c=i.ModuleContainer.resolve(hH.d).getLastResultFile(o);this.pTracker.start(gH.b.GET_MESSAGES,n);const d=await i.ModuleContainer.resolve(hH.f).getFilesForConversation({convId:o,config:l,filter:t,fromMsgId:null==c?void 0:c.msgId});return this.pTracker.end(gH.b.GET_MESSAGES),d.length>s.limit&&(a=!0,d.pop()),r=d.map((e=>({convId:o,msgId:e.msgId,ts:e.sendDttm}))),this.onQueryResponse(e,{data:r,hasMore:a,result:d})}const c=i.ModuleContainer.resolve(hH.d).getLastResultMessage(o);this.pTracker.start(gH.b.GET_MESSAGES,n);const d=await i.ModuleContainer.resolve(hH.f).getMessagesForConversation({convId:o,config:l,filter:t,fromMsgId:null==c?void 0:c.msgId});return this.pTracker.end(gH.b.GET_MESSAGES),d.length>s.limit&&(a=!0,d.pop()),r=d.map((e=>({convId:o,msgId:e.msgId,ts:e.sendDttm}))),this.onQueryResponse(e,{data:r,hasMore:a,result:d})}abortAllQueries(){ul.a.getInstance().abortSearch()}async jumpToResult(e){const{msgId:t,convId:s,dispatch:i,keyword:n}=e;let a=null;n&&(a={searchKeyWord:n}),this.Logger.zsymb(0,"w6enlb",`jump to msgId: ${t} convId: ${s} kw: ${n?this.encodeKW(n):""}`),this.pTracker.start(gH.b.JUMP_MESSAGE,t),await gh.a.gotoMessage(t,s,i,a),this.pTracker.end(gH.b.JUMP_MESSAGE)}})||uH)||uH);var mH;Object(i.singleton)(hH.f)(mH=class{async getMessagesForConversation(e){var t,s;const{convId:i,config:n,filter:a,fromMsgId:r}=e,o=tt.default.getInstance();return await o.Core.Message.index("userId_sendDttm_msgId").getAll({from:[i,null!==(t=a.timeRange)&&void 0!==t&&t[0]?String(a.timeRange[0]):"0","0"],to:[i,null!==(s=a.timeRange)&&void 0!==s&&s[1]?String(a.timeRange[1]):qh.b,r||qh.a],excludeFrom:!1,excludeTo:!1},{partition:i,limit:n.limit,predicate:e=>(!a.fromUid||e.fromUid===a.fromUid)&&(!!vl.a.isMsgSearchable(e)&&!Yu.d.isDeletingInConversation(e)),direction:Le.c.PREV})}async getFilesForConversation(e){const{convId:t,config:s,filter:n,fromMsgId:a}=e;if(!s.limit)return[];return(await i.ModuleContainer.resolve(MN.a).getFilesFromConversation(t,s.limit,a||qh.a)).filter((e=>{if(n.fromUid&&n.fromUid!==e.fromUid)return!1;if(n.timeRange){const t=+e.sendDttm;if(n.timeRange[0]&&t<n.timeRange[0])return!1;if(n.timeRange[1]&&t>n.timeRange[1])return!1}return!0}))}deduplicateMessages(e){const t=new Set,s=[];for(const i of e){const e=i.msgId,n=`${i.cliMsgId}_${i.fromUid}_${i.toUid}`;t.has(e)||t.has(n)||(t.add(e),t.add(n),s.push(i))}return s}async getMessagesInConversation(e,t){const s=tt.default.getInstance();let i=await s.Core.Message.getMulti(t,{partition:e});return i=i.filter((e=>!(!e||!vl.a.isMsgSearchable(e))&&!Yu.d.isDeletingInConversation(e))),i=this.deduplicateMessages(i),i}async getMessages(e){if(!e||!e.length)return[];const t=e.map((({msgId:e})=>e)),s=new Map;e.forEach((({convId:e,msgId:t})=>{const i=s.get(e)||[];i.push(t),s.set(e,i)}));const i=[];s.forEach(((e,t)=>{i.push(this.getMessagesInConversation(t,e))}));const n=(await Promise.all(i)).reduce(((e,t)=>e.concat(t)),[]),a=new Map(n.map((e=>[e.msgId,e]))),r=[];return t.forEach((e=>{const t=a.get(e);t&&r.push(t)})),r}});var pH;Object(ko.b)(hH.d)(pH=Reflect.metadata("design:type",Function)(pH=Reflect.metadata("design:paramtypes",[])(pH=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.queryPatch=void 0,this.openingSearch=void 0,this.keepCacheItems=void 0,this.name=hH.a,this.key=hH.a,this.data=new Map,this.openingSearch=new Set,this.keepCacheItems=new Set,this.queryPatch=new Map}init(){}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(hs.h)(this.name,e)}signalRemoveItem(e){Object(hs.f)(this.name,e)}signalUpdateList(){Object(hs.j)(this.name,this.key)}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.search,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"n83OY0","Get search in chat data item failed",e)}onGetListFailure(e){this.Logger.zsymb(20,"X_FxJ2","Get search in chat data list failed",e)}isOpeningSearch(e){return this.openingSearch.has(e)}setOpeningSearch(e,t){t?this.openingSearch.add(e):this.openingSearch.delete(e)}clearData(){this.data.size>0&&(this.data.clear(),this.signalUpdateList()),this.queryPatch.size>0&&this.queryPatch.clear()}clearDataItem(e){this.data.has(e)&&(this.data.delete(e),this.signalRemoveItem(e)),this.queryPatch.delete(e)}concatResultList(e,t){const s=new Set,i=[];for(const n of e){const e=`${n.cliMsgId}_${n.fromUid}_${n.toUid}`;s.add(n.msgId),s.add(e),i.push(n)}for(const n of t){const e=`${n.cliMsgId}_${n.fromUid}_${n.toUid}`;s.has(n.msgId)||s.has(e)||(s.add(n.msgId),s.add(e),i.push(n))}return i}isValidPatch(e){const t=this.queryPatch.get(e.convId);return!(!t||t!==e.id)}onSearchResult(e,t){if(!this.isValidPatch(t))return;let s=this.data.get(e);s&&s.id===t.id?(s=Object(f.a)(Object(f.a)({},s),{},{files:this.concatResultList(s.files,t.files),messages:this.concatResultList(s.messages,t.messages)}),void 0!==t.hasMoreFiles&&(s.hasMoreFiles=t.hasMoreFiles),void 0!==t.hasMoreMessages&&(s.hasMoreMessages=t.hasMoreMessages),void 0!==t.lastFileTs&&(s.lastFileTs=t.lastFileTs),void 0!==t.lastMessageTs&&(s.lastMessageTs=t.lastMessageTs)):s=t,this.data.set(e,s),this.signalUpdateItem(e)}getSearchResult(e){return this.data.get(e)}getLastResultMessage(e){const t=this.data.get(e);return null==t?void 0:t.messages[t.messages.length-1]}getLastResultFile(e){const t=this.data.get(e);return null==t?void 0:t.files[t.files.length-1]}getLastResultFileTs(e){const t=this.data.get(e);return null==t?void 0:t.lastFileTs}getLastResultMessageTs(e){const t=this.data.get(e);return null==t?void 0:t.lastMessageTs}onStartSearch(e,t){this.queryPatch.set(e,t)}onSelectResultItem(e,t){const s=this.data.get(e);s&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedResultItem:t})),this.signalUpdateItem(e))}})||pH)||pH);var fH;Object(ko.b)(hH.g)(fH=Reflect.metadata("design:type",Function)(fH=Reflect.metadata("design:paramtypes",[])(fH=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.promoteCache=void 0,this.name=hH.c,this.key=hH.c,this.data=new Map,this.promoteCache=new AM.a(hH.b)}init(){}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(hs.h)(this.name,e)}signalRemoveItem(e){Object(hs.f)(this.name,e)}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.search,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"h5p8nY","Get search promote data item failed",e)}onGetListFailure(e){this.Logger.zsymb(20,"iByNdk","Get search promote data list failed",e)}isPromoteAt(e){const{position:t,version:s}=e,i=this.promoteCache.getItem(t);return!i||s>i}promoteAt(e){const{position:t,version:s,autoClose:i}=e;this.promoteCache.setItem(t,s),this.data.set(t,{version:s,promote:!0}),this.signalUpdateItem(t),i&&i>0&&setTimeout((()=>{this.closePromoteAt({position:t,version:s})}),i)}closePromoteAt(e){const{position:t,version:s}=e;this.isPromoteAt(e)&&this.promoteCache.setItem(t,s);const i=this.data.get(t);i&&i.promote&&(this.data.delete(t),this.signalRemoveItem(t))}})||fH)||fH);s("+bFI");Mi.a.register(HS.e.Call,((e,t)=>{const{isMultiSelectOn:s}=e;return[]}));var vH=s("rI+G");Mi.a.register(HS.e.Contact,((e,t)=>{const{isMultiSelectOn:s,message:i}=e;if(s)return[];let n=null;if(i.message.action===R.MessageContentAction.User){let e=Object(WS.b)(i);e&&e.phone&&(n=new vH.CopyNumberMenuItem(e.phone))}return[n].filter(Boolean)}));var bH=s("0bqf"),IH=s("aODc"),yH=s("XOIG"),_H=s("vRKI");function CH(e){if(ji.l)return!1;if(!e)return!1;let{flag:t}=Object(rn.b)(e);return!!(t&vn.d.local)}var OH=s("HyDr"),EH=s("Vi1T");function MH(e,t){var s;e&&(null===(s=ww.a.for(e))||void 0===s||s.collect(t))}function SH(e,t,s){const{message:i,source:n,windowId:a}=e||{},r=i.toUid;bH.b.downloadMessage(i||{},{src:bH.a.CHAT,targetId:r}),Object(PA.c)(i,PA.a.UserAction),n===OH.a.ContextMenu?(as.default.logAction(1063914),Object(IH.a)(10,i)):as.default.logAction(106380410),Il.a.addUserAction(a,"Download"),Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,Eo.d.mediaDownload),ji.l?function(e){const{event:t,message:s}=e||{};Object(TN.downloadWebV2ByMsg)(t,window.document,s,!0),bH.c.log(bH.c.ACT.VIEW,{src:bH.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}(e):function(e,t,s){const{message:i}=e||{},{manualDownloadMediaDoneHandler:n}=Object(gs.c)();Object(EH.a)(i,Go.c,{actions:n,entryType:XR.f.File})}(e)}Mi.a.register(HS.e.File,(function(e,t){const{detail:s,isMultiSelectOn:i,message:n}=e||{};if(i||!n)return[];let a,r;return MH(null==s?void 0:s.trackingCmdId,"FileMessage: start build ctx menu"),function(e){const{message:t}=e||{};return!!t&&!Object(zf.r)(t)&&!Object(zf.K)(t)&&Object(_H.a)(t)}({message:n})&&(a=new yH.s,a.setHandler((t=>{try{var i;null==t||t.stopPropagation(),null===(i=a.getMenu())||void 0===i||i.close();const n=a.getWindowId();SH(Object(f.a)(Object(f.a)({},e),{},{windowId:n}),null==s||s.fileData,null==s||s.fileHandler)}catch(m$){}}))),MH(null==s?void 0:s.trackingCmdId,"FileMessage: check SaveFileToDevice done"),CH(n)&&(r=new yH.x,r.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=r.getMenu())||void 0===s||s.close(),function(e){const{message:t,source:s}=e||{};bH.b.showMessageInFolder(t,{targetId:t.toUid,src:bH.a.CHAT}),s===OH.a.ContextMenu?(as.default.logAction(1063913),Object(IH.a)(11,t)):as.default.logAction(106380409),as.default.logAction(107190901),Object(Tw.a)(e.message)}(e)}catch(m$){}}))),MH(null==s?void 0:s.trackingCmdId,"FileMessage: build ctx menu done"),[a,r].filter(Boolean)}));s("jSEC");Mi.a.register(HS.e.GIF,((e,t)=>{const{event:s,detail:i,isMultiSelectOn:n,message:a}=e||{};if(!s||!a||n)return[];let r,o;return[r,o].filter(Boolean)}));var TH=s("IBuc"),wH=s("P7Ey");function RH(e){for(;null!=e&&e.firstChild;)e.removeChild(e.firstChild)}var LH=function(e,t){const s=t||window,i=s.getSelection();if("string"==typeof e&&i&&"Range"===i.type&&i.rangeCount>0){const t=s.document.getElementById(e);if(t){const n=i.getRangeAt(0),a=n.commonAncestorContainer;if(t.contains(a)){if(a.nodeType===Node.ELEMENT_NODE&&"rtf-container"===(null==a?void 0:a.getAttribute("data-component")))return()=>"";const{content:e}=Object(wH.a)(s);return e||i.toString()}{const t=n.cloneContents();if(null!=t&&t.getElementById(e))return RH(t),t=>{try{const s=t||window,i=s.getSelection();if(null===i)return"";const n=i.getRangeAt(0).cloneContents();let a=n.getElementById(e);if(RH(n),null==a)return"";s.document.body.appendChild(a);const r=new Range;r.selectNodeContents(a),i.removeAllRanges(),i.addRange(r);const o=i.toString();return r.deleteContents(),i.removeAllRanges(),s.document.body.removeChild(a),a=null,o}catch(m$){return""}};RH(t)}}}};function DH(e){return Boolean(e&&"function"==typeof e.getAttribute&&e.getAttribute("data-z-element-type")===R.DataAttributes.Element.EMAIL)}function AH(e){if(!e||"function"!=typeof e.getAttribute)return!1;const t=e.getAttribute("data-z-element-type");return t===R.DataAttributes.Element.RTF_TEXT?e.classList.contains("text-is-link"):Boolean(t===R.DataAttributes.Element.LINK)}function FH(e){return Boolean(e&&"function"==typeof e.getAttribute&&e.getAttribute("data-z-element-type")===R.DataAttributes.Element.PHONE_NUMBER)}function jH(e,t){var s;e&&(null===(s=ww.a.for(e))||void 0===s||s.collect(t))}Mi.a.register(HS.e.Link,((e,t)=>{const{detail:s,event:i,isMultiSelectOn:n,message:a,source:r}=e||{};if(!i||!a||n)return[];jH(null==s?void 0:s.trackingCmdId,"LinkMessage: start build ctx menu");const o=Object(zf.Z)(a);let l=null;if(!o)if(r===OH.a.MessageFloatingMenu)l=new vH.CopyLinkMenuItem(a.message.href);else{const e=i.view,t=LH(null==s?void 0:s.linkMessageContainerId,e);if(jH(null==s?void 0:s.trackingCmdId,"LinkMessage: check selectedContent"),t)"string"==typeof t?l=new vH.CopySelectedContentMenuItem(t):"function"==typeof t&&(l=new vH.CopySelectedContentMenuItem(""),l.setHandler((()=>{const s=t(e);s?Object(TH.a)(s):e.document.execCommand("copy"),l.getMenu().close()})));else{var c;const e=i.target,t=null!==(c=i.currentTarget)&&void 0!==c?c:i._currentTarget;if(null!=t&&t.id&&(null==t?void 0:t.id)===(null==s?void 0:s.linkContentContainerId))l=new vH.CopyLinkMenuItem(a.message.href);else if(AH(e)&&e.textContent)l=new vH.CopyLinkMenuItem(a.message.href);else if(DH(e)&&e.textContent)l=new vH.CopyEmailMenuItem(e.textContent);else if(FH(e)&&e.textContent)l=new vH.CopyNumberMenuItem(e.textContent);else if(""===a.message.title||a.message.title===a.message.href)l=new vH.CopyLinkMenuItem(a.message.href);else{const e=a.message.title||a.message.href;l=new vH.CopyMessageContentMenuItem(e)}}}return jH(null==s?void 0:s.trackingCmdId,"LinkMessage: build ctx menu done"),[l].filter(Boolean)})),Mi.a.register(HS.e.Location,((e,t)=>{const{isMultiSelectOn:s}=e;return[]})),Mi.a.register(HS.e.OA,((e,t)=>{const{detail:s,isMultiSelectOn:i}=e;if(i)return[];const{indexOAChild:n=0}=s||{},{message:a}=e;let r={href:"",title:""};Array.isArray(a.message)&&(r=a.message[n]);let o=null;return r.href?o=new vH.CopyLinkMenuItem(r.href):r.title&&(o=new vH.CopyMessageContentMenuItem(r.title)),[o].filter(Boolean)}));var PH=s("4X16"),kH=s("RUNN");var NH=s("knYB"),UH=s("kWKb");function BH(e){const{message:t}=e,s=t.message,i={},n=s.length,a=JSON.parse(s[0].message.params);if(a.total_item_in_group===n){const e=s.filter((e=>![R.MSG_UNDO,R.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(zf.i)(e)));e.forEach((t=>{Object(PA.c)(t,PA.a.UserAction);const s=ho.default.getConversationType(t.toUid||t.userId),n=new XR.c(XR.a.ChatBoxView).getBuilder().withType(XR.f.Photo).withConvType(XR.b[s]).withMode(XR.e.Manual).withCode(XR.d.CBVMessageAction);e.msgType==R.MSG_VIDEO&&n.withType(XR.f.Video),i[t.msgId]=n.build()})),aE.a.getInstance().downloadWithMultiSrc("runByMultiMsg",e,{entriesCode:i,saveAs:!0}).then((t=>{e.forEach((e=>{if(e.msgId&&t[e.msgId]){const{downloadError:s,localPath:i}=t[e.msgId]||{};((e,t,s)=>{const i=Date.now();!e&&mi.default.recent_photo.enableFeature&&ho.default.isWindows()&&Pi.a.setPhotoDownload({isLocalFile:!0,path:s,lastModified:i,name:$znode.path.basename(s),shortenPath:ho.default.getShortenPath(s,40),fromSource:"DownloadedPhoto"})})(s,e.msgId,i)}}))})).catch((e=>{}))}else{const e=s[n-1];Rt.default.getGroupPhoto(e.msgId,a.total_item_in_group-n,e.toUid).then((e=>{Array.prototype.push.apply(s,e);const t=s.filter((e=>![R.MSG_UNDO,R.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(zf.i)(e)));t.forEach((e=>{Object(PA.c)(e,PA.a.UserAction);const s=ho.default.getConversationType(e.toUid||e.userId),n=new XR.c(XR.a.ChatBoxView).getBuilder().withType(XR.f.Photo).withConvType(XR.b[s]).withMode(XR.e.Manual).withCode(XR.d.CBVMessageAction);t.msgType==R.MSG_VIDEO&&n.withType(XR.f.Video),i[e.msgId]=n.build()})),aE.a.getInstance().downloadWithMultiSrc("runByMultiMsg",t,{entriesCode:i,saveAs:!0})}))}}function xH(e){const{message:t}=e;!1!==Array.isArray(t.message)&&(fu.b.getStateNetwork()===fu.a.CONNECTED?(Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,Eo.d.mediaDownload),ji.l?function(e){const{message:t}=e;let s="";const i=t.toUid,n=t.message;s=Object(Yc.a)(i)?Zo.default.getDName(i):ns.default.getDName(i),s||(s="");const a=n.filter((e=>![R.MSG_UNDO,R.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(zf.i)(e)));a.forEach((e=>{Object(PA.c)(e,PA.a.UserAction)})),UH.a.downloadMultiFiles(a,s).catch((e=>{let t=os.a.str("STR_DOWNLOAD_FAILED_DETAILS");t=e&&"string"==typeof e&&e.startsWith("ERR_")?`${t}: ${e}`:`${t}: ERR_UNKNOWN`,rs.default.createError(t)}))}(e):BH(e)):rs.default.createError(os.a.str("STR_TOAST_CONNECTION_FAILED")))}function GH(e){const{message:t,source:s,windowId:i}=e||{},n=t.toUid;bH.b.downloadMessage(t||{},{src:bH.a.CHAT,targetId:n}),Object(PA.c)(t,PA.a.UserAction),s===OH.a.ContextMenu?(as.default.logAction(1063914),Object(IH.a)(10,t)):as.default.logAction(106380410),mi.default.cloud_send2me.enable&&n==mi.default.sendToMeId&&fR.b.log(fR.a.DOWNLOAD,1,t),Il.a.addUserAction(i,"Download"),Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,Eo.d.mediaDownload),ji.l?function(e){const{event:t,message:s}=e||{};Object(TN.downloadWebV2ByMsg)(t,window.document,s,!0),bH.c.log(bH.c.ACT.VIEW,{src:bH.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}(e):function(e){const{message:t}=e||{};if(as.default.logAction(1071908),!t.message.oriUrl)return void rs.default.createError(os.a.str("STR_TOAST_DOWNLOAD_FAILED"));const{manualDownloadMediaDoneHandler:s}=Object(gs.c)();Object(EH.a)(t,Go.c,{actions:s,entryType:XR.f.Video,additional:{type:nh.default.constants.DownloadType.Video}})}(e)}function zH(e){const{event:t,message:s}=e||{};Object(TN.downloadWebV2ByMsg)(t,window.document,s,!0),bH.c.log(bH.c.ACT.VIEW,{src:bH.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}function VH(e){const{message:t,source:s,windowId:i}=e||{};if(t.msgType===R.MSG_VIDEO)return void GH(e);const n=t.toUid;bH.b.downloadMessage(t||{},{src:bH.a.CHAT,targetId:n}),Object(PA.c)(t,PA.a.UserAction),s===OH.a.ContextMenu?(as.default.logAction(1063914),Object(IH.a)(10,t)):as.default.logAction(106380410),mi.default.cloud_send2me.enable&&n==mi.default.sendToMeId&&fR.b.log(fR.a.DOWNLOAD,1,t),Il.a.addUserAction(i,"Download");const a=[R.MSG_PHOTO,R.MSG_PHOTO_2].some((e=>e===t.msgType));Oo.a.emitWithKey(Eo.d.userOnNewDeviceTracking,Eo.d.mediaDownload),ji.l||a&&!Object(Rm.a)()?zH(e):function(e){const{message:t}=e||{};if(as.default.logAction(1071908),!t.message.oriUrl)return void rs.default.createError(os.a.str("STR_TOAST_DOWNLOAD_FAILED"));const{manualDownloadMediaDoneHandler:s}=Object(gs.c)();Object(EH.a)(t,Go.c,{actions:s,entryType:XR.f.Photo,additional:{type:nh.default.constants.DownloadType.Photo}})}(e)}const HH={ok:!1,messages:[]};function WH(e,t){var s;const{detail:i,event:n,isMultiSelectOn:a,message:r}=e||{};if(!n||a||!r)return[];const{captionContainerElementId:o=""}=i||{};let l;const c=null!==(s=n.currentTarget)&&void 0!==s?s:n._currentTarget;(function(e){const{message:t}=e||{};return!(!t||ji.l)&&!Object(zf.t)(t)&&!Object(zf.l)(t)&&!Object(zf.v)(t)&&!Object(zf.n)(t)&&!Object(zf.W)(t)&&Object(kH.a)(t)})({message:r})&&(null!=c&&c.id&&(null==c?void 0:c.id)===o||(l=new vH.CopyPhotoMenuItem));let d,u,h=null;if(r.message.title){const e=n.view,t=LH(o,e);if(t)"string"==typeof t?h=new vH.CopySelectedContentMenuItem(t):"function"==typeof t&&(h=new vH.CopySelectedContentMenuItem(""),h.setHandler((()=>{const s=t(e);s?Object(TH.a)(s):e.document.execCommand("copy"),h.getMenu().close()})));else{const e=n.target;let t;AH(e)?(t=Object(NH.a)(e),h=new vH.CopyLinkMenuItem(t)):h=DH(e)&&(t=e.textContent)?new vH.CopyEmailMenuItem(t):FH(e)&&(t=e.textContent)?new vH.CopyNumberMenuItem(t):new vH.CopyMessageContentMenuItem(r.message.title)}}return function(e){const{message:t}=e||{};return!!t&&!Object(zf.r)(t)&&!Object(zf.n)(t)&&!Object(zf.K)(t)&&Object(_H.a)(t)}({message:r})&&(d=new vH.SavePhotoToDeviceMenuItem,d.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=d.getMenu())||void 0===s||s.close();const i=d.getWindowId();VH(Object(f.a)(Object(f.a)({},e),{},{windowId:i}))}catch(m$){}}))),[l,h,d,u].filter(Boolean)}function $H(e,t){const{event:s,isMultiSelectOn:i,message:n}=e||{};if(!s||i||!n)return[];let a;const r=function(e){if(!e)return HH;if(e.message.length<=0)return HH;if(!0===Boolean(Object(PH.e)(e.message)))return HH;if(!1===Object(PH.b)(e.message))return HH;const t=Object(PH.g)(e.message);return 0===t.length?HH:{ok:!0,messages:t}}(n);return!0===r.ok&&(a=new vH.SaveGroupPhotoToDeviceMenuItem(r.messages.length),a.setHandler((()=>{var t;null===(t=a.getMenu())||void 0===t||t.close();try{xH(e)}catch(m$){}}))),[a].filter(Boolean)}Mi.a.register(HS.e.Photo,((e,t,...s)=>{const{event:i,message:n}=e||{};return i?n.msgType===R.MSG_PHOTO_GROUP&&Array.isArray(n.message)?$H(e):WH(e):[]})),Mi.a.register(HS.e.AISticker,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};return[]})),Mi.a.register(HS.e.NewFSSticker,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};return[]})),Mi.a.register(HS.e.PhotoSticker,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};return[]})),Mi.a.register(HS.e.NoBorderPhotoSticker,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};return[]})),Mi.a.register(HS.e.Sticker,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};if(!i||n||null==a||!a.message)return[];const r=[];return[R.MSG_STICKER,R.MSG_STICKER_2].includes(a.msgType)&&null!=a.message.catId&&r.push(new vH.ViewStickerSetMenuItem),r})),Mi.a.register(HS.e.StickerGroup,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};if(!i||n||null==a||!a.message)return[];const r=[],o=1===a.message.length?a.message[0]:null;if(o&&[R.MSG_STICKER,R.MSG_STICKER_2].includes(o.msgType)&&null!=o.message.catId){const e=new vH.ViewStickerSetMenuItem;e.getBuilder().fromMessage(o),r.push(e)}return r})),Mi.a.register(HS.e.StickerSet,((e,t,...s)=>{const{event:i,isMultiSelectOn:n,message:a}=e||{};return[]})),Mi.a.register(HS.e.Text,((e,t)=>{const{event:s,isMultiSelectOn:i,message:n}=e||{};if(!s||i||!n)return[];const a=(null==t?void 0:t.getAttribute("id"))||"";let r=null;const o=s.view,l=LH(a,o);if(l)"string"==typeof l?r=new vH.CopySelectedContentMenuItem(l):"function"==typeof l&&(r=new vH.CopySelectedContentMenuItem(""),r.setHandler((()=>{const e=l(o);e?Object(TH.a)(e):o.document.execCommand("copy"),r.getMenu().close()})));else{const e=s.target;let t;AH(e)?(t=Object(NH.a)(e),r=new vH.CopyLinkMenuItem(t)):DH(e)&&(t=e.textContent)?r=new vH.CopyEmailMenuItem(t):FH(e)&&(t=e.textContent)?r=new vH.CopyNumberMenuItem(e.textContent):Object(zf.F)(n)?(r=new vH.CopyMessageContentMenuItem(""),r.setHandler((()=>{var e;let t="",s=document.getElementById(R.MSG_TEXT_CONTENT_ID_PREFIX+n.msgId);s&&(t=s.outerHTML),Object(TH.a)(null===(e=n.message)||void 0===e?void 0:e.title,t)}))):(t=n.message,r=new vH.CopyMessageContentMenuItem(t))}return[r].filter(Boolean)}));var KH=s("+ed7");class qH extends KH.a{constructor(e){super(e)}}var QH=qH;Mi.a.register(HS.e.Video,((e,t)=>{const{detail:s,event:i,isMultiSelectOn:n,message:a}=e||{};if(!i||n||!a)return[];let r;r=null!=a.UIContent?a.UIContent.caption:a.message.title;let o=null;if(r){const{captionContainerElementId:e=""}=null!=s?s:{},t=i.view,n=LH(e,t);if(n)"string"==typeof n?o=new vH.CopySelectedContentMenuItem(n):"function"==typeof n&&(o=new vH.CopySelectedContentMenuItem(""),o.setHandler((()=>{const e=n(t);e?Object(TH.a)(e):t.document.execCommand("copy"),o.getMenu().close()})));else{const e=i.target;let t;AH(e)?(t=Object(NH.a)(e),o=new vH.CopyLinkMenuItem(t)):o=DH(e)&&(t=e.textContent)?new vH.CopyEmailMenuItem(t):FH(e)&&(t=e.textContent)?new vH.CopyNumberMenuItem(t):new vH.CopyMessageContentMenuItem(a.message.title)}}let l=null;return function(e){const{message:t}=e||{};return!!t&&!Object(zf.r)(t)&&!Object(zf.K)(t)&&Object(_H.a)(t)}({message:a})&&(l=new QH,l.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=l.getMenu())||void 0===s||s.close();const i=l.getWindowId();GH(Object(f.a)(Object(f.a)({},e),{},{windowId:i}))}catch(m$){}}))),[o,l].filter(Boolean)})),Mi.a.register(HS.e.Voice,((e,t)=>{const{isMultiSelectOn:s}=e;return[]}));var ZH=s("bUFI");const JH="z_chatbg_reset";var YH;Object(i.singleton)(ZH.a)(YH=Object(Je.i)()(YH=class{onStart(){this.switchDefaultOffBgChat()}switchDefaultOffBgChat(){const e=E.default.getInstance();if(!e.getItemForCurrentUser(JH)){this.isUseChatBackground()&&(ki.g.setUseChatBg(rt.p.getSessionUserId(),!1),Fi.default.send(Ai.GeneralActions.CHANGE_BG_CHAT,!1)),e.setItemForCurrentUser(JH,"1")}}isUseChatBackground(){const e=rt.p.getSessionUserId();return Boolean(ki.g.useChatBg(e))}})||YH);var XH=s("uPsl");class eW{constructor(){this.onDeleteMessage=this.onDeleteMessage.bind(this),this.registerEvents()}dispose(){}static create(){return new eW}static getInstance(){return eW.instance||(eW.instance=eW.create()),eW.instance}registerEvents(){ri.a.instance.on("delete-message-only-me",this.onDeleteMessage)}cancelUpload(e){XH.a.emit("cancel-upload",e)}onDeleteMessage(e){if(e.type===Ai.ChatBoxActions.DELETE_MESSAGE){const{payload:t}=e;if(Array.isArray(t.messages)){const e=new Set;t.messages.forEach((t=>{t&&t.cliMsgId&&("file"===t.mediaType||"image"===t.mediaType)&&e.add(t.cliMsgId)})),e.size>0&&Array.from(e).forEach((e=>{this.cancelUpload(e)}))}}}}eW.instance=void 0,eW.create();var tW,sW=s("W92G"),iW=s("cjS3");Object(i.singleton)(sW.a)(tW=Object(Je.e)()(tW=Object(Je.h)()(tW=Reflect.metadata("design:type",Function)(tW=Reflect.metadata("design:paramtypes",[])(tW=class extends Fe.b{constructor(){super(),this.logger=void 0,this.bannerState=void 0,this.stateListeners=void 0,this.autoCloseTimer=void 0,this.handleE2eeSessionChange=()=>{this.isEnabled()?(this.bannerState=iW.d.DISPLAY,this.updateBannerStateToDB(),this.signalStateChange(),this.logger.zsymb(0,"e0lI8m",`e2eeSessionChange: detect change session. new banner state ${this.bannerState}`),this.startCheckAutoClose(),requestIdleCallback((()=>{this.getBannerCounter().then((e=>{let t=((null==e?void 0:e.count)||0)+1,s=null==e?void 0:e.firstTs;if(s){(Date.now()-s)/864e5>30&&(this.logger.zsymb(0,"fDp-Zu",`e2eeSessionChange: more than 30 days from the date of 1st display, reset. prev counter: ${t}-${s}`),t=1,s=void 0)}s||(s=Date.now());let i=0;1===t?i=25310103:2===t?i=25310104:3===t?i=25310105:t>=4&&t<=5?i=25310106:t>=6&&t<=10?i=25310107:t>=10&&t<=20?i=25310108:t>20&&(i=25310109),i&&as.default.logAction(i),this.saveBannerCounter(t,s),this.logger.zsymb(0,"xs6aY5",`e2eeSessionChange: update banner counter ${t}; firstDisplay ${s}`)}))}),{timeout:5e3})):this.logger.zsymb(0,"wopO1P","e2eeSessionChange: detect change session, but skipped banner status update due to being disabled")},this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.web,["change-device-notice"]),this.bannerState=iW.d.NONE,this.stateListeners=new Map}onAuthenticated(){(async()=>{if(!this.isEnabled())return void this.logger.zsymb(0,"mmSxus","authenticated: web change device banner is disabled");const e=await this.getBannerStateFromDB();!e||isNaN(Number(e))||this.bannerState||(this.bannerState=Number(e),this.logger.zsymb(0,"t9e_pF",`authenticated: load prev banner state ${e}`),this.signalStateChange(),this.startCheckAutoClose())})(),this.addEventListener("on-e2ee-session-change",this.handleE2eeSessionChange)}onSessionExpired(){this.bannerState&&(this.logger.zsymb(0,"_K8W_T",`logout: reset banner state. current state ${this.bannerState}`),this.setBannerState(iW.d.NONE)),this.removeEventListener("on-e2ee-session-change",this.handleE2eeSessionChange)}isEnabled(){var e,t,s;return null===(e=null===(t=mi.default.tab_banner.features)||void 0===t||null===(s=t.web_change_device)||void 0===s?void 0:s.enable)||void 0===e||e}getBannerState(){return this.bannerState}setBannerState(e){e!==this.bannerState&&e!==iW.d.DISPLAY&&(this.bannerState=e,this.updateBannerStateToDB(e===iW.d.NONE),this.signalStateChange())}onStateChange(e,t){this.stateListeners.set(e,t)}revoke(e){this.stateListeners.delete(e)}startCheckAutoClose(){var e,t;if(this.bannerState!==iW.d.DISPLAY)return;const s=null===(e=mi.default.tab_banner.features)||void 0===e||null===(t=e.web_change_device)||void 0===t?void 0:t.auto_close;s&&Number.isInteger(s)&&(this.logger.zsymb(0,"278HcC",`e2eeSessionChange: start auto close timer. ${s}`),this.autoCloseTimer&&clearTimeout(this.autoCloseTimer),this.autoCloseTimer=setTimeout((()=>{this.setBannerState(iW.d.DISMISSED),this.autoCloseTimer=void 0}),s))}signalStateChange(){this.stateListeners.forEach((e=>{e(this.bannerState)}))}async updateBannerStateToDB(e){e?await E.default.getInstance().removeItemForCurrentUserAsync(iW.c):await E.default.getInstance().setItemForCurrentUserAsync(iW.c,this.bannerState.toString()),this.logger.zsymb(0,"VFK8mc","flushBannerStateToDb: "+(e?"delete state.":`saved new state: ${this.bannerState};`))}async getBannerStateFromDB(){return E.default.getInstance().getItemForCurrentUserAsync(iW.c)}async saveBannerCounter(e,t){e||t?await E.default.getInstance().setItemForCurrentUserAsync(iW.a,JSON.stringify({count:e,firstTs:t})):await E.default.getInstance().removeItemForCurrentUserAsync(iW.a)}async getBannerCounter(){const e=await E.default.getInstance().getItemForCurrentUserAsync(iW.a);if(e)try{const t=JSON.parse(e);return{count:Number.isInteger(Number(t.count))?Number(t.count):0,firstTs:Number.isInteger(Number(t.firstTs))?Number(t.firstTs):0}}catch(t){return void(await this.saveBannerCounter())}}})||tW)||tW)||tW)||tW);var nW=s("+pEX"),aW=s("AWVP"),rW=s("Iq7B");class oW{constructor(e,t,s,i,n){this.name=void 0,this.code=void 0,this.data=void 0,this.message=void 0,this.details=void 0,this.name=e,this.code=t,this.message=s,this.details=i,this.data=n,Object(nW.a)().error(`${this.name}[${this.code}]:${this.message}`,this.details)}}class lW extends oW{constructor(e,t,s){super("HttpApiError",aW.e.HTTP_API,e,s),this.data=void 0,this.data=t}}class cW{async sendSeenSubChatTab(e){try{const t=di.b.getChatDomain(),s=rW.b,i=`${t}${s}${`?${this.getCommonParams_()}`}`,n=Rd.a.newReq(),a={msgInfos:JSON.stringify({seens:e}),imei:Xl.a.getZaloClientID()},r=`params=$${this.encodeParams_(a)}`,o=await pu.default._post(i,r,{retry:0},rW.a,void 0,!1,n),l=await Object(gu.a)(o),{status:c}=null!=l?l:{};return aW.b.Success(0==c)}catch(n){var t,s,i;const e={status:null==n?void 0:n.status,errorCode:null!==(t=null==n?void 0:n.error_code)&&void 0!==t?t:null==n?void 0:n.code,message:null!==(s=null!==(i=null==n?void 0:n.error_message)&&void 0!==i?i:null==n?void 0:n.message)&&void 0!==s?s:""};return aW.b.Failure(new lW("Cannot send seen sub chat tab.",e,e))}}getCommonParams_(){return pu.default._getCommonParams()}encodeParams_(e){return pu.default._encodeParams(e)}}class dW extends oW{constructor(e,t,s){super("WSSApiError",aW.e.WSS_API,e,s),this.data=void 0,this.data=t}}class uW{async getLastSeenSubChatTab(e){const t={subtabs:e};try{const e=await SI.a.instance().requestAsyncV2({cmd:nd.j.GET_LAST_SEEN_SUB_CHAT_TAB,subCmd:0,data:{data:t}});if(0!=e.error_code){const s={errorCode:e.error_code,message:e.error_message},i=Object(f.a)(Object(f.a)({},s),{},{params:JSON.stringify(t)}),n="Cannot get last seen sub chat tab.";return aW.b.Failure(new dW(n,s,i))}return aW.b.Success({clearUnreadInfo:e.data.clearUnreadInfo})}catch(a){var s,i,n;const e={errorCode:null!==(s=null==a?void 0:a.error_code)&&void 0!==s?s:null==a?void 0:a.code,message:null!==(i=null!==(n=null==a?void 0:a.error_message)&&void 0!==n?n:null==a?void 0:a.message)&&void 0!==i?i:""},r=Object(f.a)(Object(f.a)({},e),{},{params:JSON.stringify(t)}),o="Cannot get last seen sub chat tab.";return aW.b.Failure(new dW(o,e,r))}}}var hW,gW=s("1HgD"),mW=s("Ui4J");Object(i.injectable)()(hW=Object(i.singleton)(gW.a)(hW=Reflect.metadata("design:type",Function)(hW=Reflect.metadata("design:paramtypes",[])(hW=class{constructor(){this.httpApi_=void 0,this.wssApi_=void 0,this.currentSyncSeenSubtabReq_=null,this.httpApi_=new cW,this.wssApi_=new uW,MI.default.getChatHandler().subcribe(nd.b.ON_DONE_OFFLINE,this.pullOfflineLastSeenSubChatTabIfNeeded_.bind(this))}sendSeenSubChatTab_(e,t){let s=!1;const i=null==t?void 0:t.signal;return i&&i.addEventListener("abort",(()=>s=!0)),new Promise(((t,i)=>{const n=mW.a(),a=se((async()=>{const t=await this.httpApi_.sendSeenSubChatTab(e);return"error"===t.type?Promise.reject(t.data):Promise.resolve(t.data)}),{min:n.min,max:n.max,step:n.step,retries:n.retries,shouldRetryOnError:({error:e})=>new Promise((t=>{var i;if(s)return t(!1);if(!e)return t(!1);const n=null===(i=e.data)||void 0===i?void 0:i.errorCode;if(-69===n)return t(!1);return[R.NetWorkError.NO_NETWORK,R.NetWorkError.TIMEOUT,R.NetWorkError.TIMEOUT_SENT].includes(n)?t(!0):t(111!==n)}))});a().then((e=>{t(aW.b.Success(e))})).catch((e=>{t(aW.b.Failure(e))}))}))}syncSeenSubChatTab(e){const t={abortController:new AbortController,payload:{seens:e}};if(this.currentSyncSeenSubtabReq_){const s=this.currentSyncSeenSubtabReq_,i=[...s.payload.seens,...e].reduce(((e,t)=>{const s=t.sct+"_"+t.id;if(e[s]=t,e[s]){const i=e[s],n=t.msgId>i.msgId?t.msgId:i.msgId;e[s]=Object(f.a)(Object(f.a)({},t),{},{msgId:n})}else e[s]=t;return e}),Object.create(null));t.payload.seens=Object.values(i),s.abortController.abort()}this.currentSyncSeenSubtabReq_=t,this.sendSeenSubChatTab_(t.payload.seens,{signal:t.abortController.signal}).finally((()=>{this.currentSyncSeenSubtabReq_===t&&(this.currentSyncSeenSubtabReq_=null)}))}onReceiveSeenSubChatTab_(e,t=aW.a.Unknown){Object(nW.a)().info(`[${t}] Receive seen sub chat tab.`,{seens:e});const s=i.ModuleContainer.resolve(Xo.TUnreadSubChatTabStateManager),n=e.map((e=>({type:+e.idTo,msgId:e.lastMsgId})));s.onReceiveSeenSubChatTab(n)}async pullOfflineLastSeenSubChatTabIfNeeded_({msgId:e,msgKey:t}){if(Object(nW.a)().info("[PullOffline] Start sync when done offline.",{msgId:e,msgKey:t},1),mi.default.socket.enable_ctrl_socket){const t=e||null,s=i.ModuleContainer.resolve(Xo.TUnreadSubChatTabStateManager).getAllSubChatTabsNeedPullLastSeenWhenPullOfflineDone(t);if(!s.length)return;const n=s.map((e=>({sct:aW.c.SubChatTab,id:e}))),a=await this.wssApi_.getLastSeenSubChatTab(n);"success"===a.type?this.onReceiveSeenSubChatTab_(a.data.clearUnreadInfo,aW.a.Wss_PullOffline):Object(nW.a)().error("[PullOffline] Cannot get last seen sub chat tab.")}else Object(nW.a)().info("[PullOffline] Socket is not enabled. -> Skip.")}onReceiveSeenSubChatTabFromCtrl(e){this.onReceiveSeenSubChatTab_(e,aW.a.Wss_Response)}})||hW)||hW)||hW);var pW=s("TtB7"),fW=s("BjT2");const vW="s_s_m_prxk",bW="l_r_m_i";class IW{constructor(){this.seenMilestoneAtSubtab_={[aW.d.ARCHIVED]:void 0,[aW.d.FOCUSED]:void 0},this.lastReceivedMsgInfoAtSubtab_={[aW.d.ARCHIVED]:void 0,[aW.d.FOCUSED]:void 0}}setNewSeenMilestone(e,t){this.seenMilestoneAtSubtab_[e]=t;const s=E.default.getInstance(),i=`${vW}::${e}`;s.setItemForCurrentUser(i,t)}getLastSeenMilestone(e){var t;let s=this.seenMilestoneAtSubtab_[e];if(null!=s)return s;const i=E.default.getInstance(),n=`${vW}::${e}`;return s=null!==(t=i.getItemForCurrentUser(n))&&void 0!==t?t:"",this.seenMilestoneAtSubtab_[e]=s,s}setNewReceivedMsgInfo(e,t){this.lastReceivedMsgInfoAtSubtab_[e]=Object(f.a)({},t);const s=E.default.getInstance(),i=`${bW}::${e}`;s.setItemForCurrentUser(i,JSON.stringify(t))}getLastReceivedMsgInfo(e){var t,s;if(null!=this.lastReceivedMsgInfoAtSubtab_[e])return this.lastReceivedMsgInfoAtSubtab_[e];const i=E.default.getInstance(),n=`${bW}::${e}`,a=null!==(t=i.getItemForCurrentUser(n))&&void 0!==t?t:"";return a?(this.lastReceivedMsgInfoAtSubtab_[e]=null!==(s=JSON.parse(a))&&void 0!==s?s:{convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e]):(this.lastReceivedMsgInfoAtSubtab_[e]={convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e])}}var yW,_W=s("7l8h");Object(ko.b)(fW.b)(yW=function(e,t){return Object(i.inject)(_W.c)(e,void 0,0)}(yW=function(e,t){return Object(i.inject)(Je.a)(e,void 0,1)}(yW=Reflect.metadata("design:type",Function)(yW=Reflect.metadata("design:paramtypes",["undefined"==typeof IUnreadSubChatTabNetworkService?Object:IUnreadSubChatTabNetworkService,"undefined"==typeof BaseApplication?Object:BaseApplication])(yW=class{constructor(e,t){this.unreadSubChatTabStateStore_=void 0,this.storage_=void 0,this.networkService_=void 0,this.key=pW.a,this.name=fW.a,this.storage_=new IW,this.networkService_=e,this.handleReceiveLatestMessage=this.handleReceiveLatestMessage.bind(this),this.handleReceiveLatestMessage_=this.handleReceiveLatestMessage_.bind(this),this.handleChangeSubtab=this.handleChangeSubtab.bind(this),this.hasUnreadSubChatTab=this.hasUnreadSubChatTab.bind(this),this.handleDisplayMessageTab=this.handleDisplayMessageTab.bind(this),this.handleHideMessageTab=this.handleHideMessageTab.bind(this),this.handleUpdateArchivedChat=this.handleUpdateArchivedChat.bind(this),this.handleMoveConvFromHiddenToArchivedChat=this.handleMoveConvFromHiddenToArchivedChat.bind(this),this.handleShowReddotsAtSubChatTab=this.handleShowReddotsAtSubChatTab.bind(this),t.addEventListener(Je.b.Idle,this.handleMainApplicationInBackground_.bind(this)),t.addEventListener(Je.b.Active,this.handleMainApplicationInForeground_.bind(this))}handleReceiveLatestMessage(e){e&&e.convId&&this.isRightMsgIdString_(e.msgId)?this.handleReceiveLatestMessage_(e):Object(nW.a)().error("[Event] Receive latest message - Invalid info.",{info:e},1)}handleReceiveLatestMessage_(e){const{convId:t,msgId:s}=e,i=this.getSubtabTypeOfConv(t);if(!this.isValidSubChatTabType(i))return;const n=this.getLastReceivedMsgInfo_(i);(!n.msgId||n.msgId<s)&&this.saveNewReceivedMsgInfo_(i,{convId:t,msgId:s})}getSubtabTypeOfConv(e){let t=aW.d.NONE;return Yo.a.isArchivedChat(e)?t=aW.d.ARCHIVED:xo.a.isThreadHidden(e)||(t=aW.d.FOCUSED),t}handleShowReddotsAtSubChatTab(e){const t=this.convetFilterTypeToSubChatTabType(Co.a.ConvListController.getCurrentFilter().type);this.getAllValidSubtabs().forEach((s=>{if(t===s)return;const i=this.hasUnreadSubChatTab(s),n=e[s];if(i!==n){let e=this.getUnreadSubChatTabStateStore_()[s];e=Object(f.a)(Object(f.a)({},e),{},{hasUnread:n}),this.getUnreadSubChatTabStateStore_()[s]=e,Object(hs.h)(this.name,this.key)}}))}handleMoveConvFromHiddenToArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,aW.d.ARCHIVED)}handleUpdateArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,aW.d.ARCHIVED)}handleMoveConvToArchiveChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,aW.d.ARCHIVED)}handleMoveConvToFocusedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,aW.d.FOCUSED)}handleChangeSubtab(e,t){const s={fromSubtab:e,toSubtab:t};Object(nW.a)().info("[Event] Change subtab.",s);const i=[];if(this.isValidSubChatTabType(t)){const e=this.getLastReceivedMsgInfo_(t);if(e.msgId){let s=this.getUnreadSubChatTabStateStore_()[t];s=Object(f.a)(Object(f.a)({},s),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[t]=s,this.saveNewSeenMilestone_(t,e.msgId),Object(hs.h)(this.name,this.key),i.push({sct:aW.c.SubChatTab,msgId:e.msgId,id:t})}}if(this.isValidSubChatTabType(e)){const t=this.getLastReceivedMsgInfo_(e),s=this.getLastSeenMilestone_(e);t.msgId&&t.msgId>s&&(this.saveNewSeenMilestone_(e,t.msgId),i.push({sct:aW.c.SubChatTab,msgId:t.msgId,id:e}))}i.length&&this.networkService_.syncSeenSubChatTab(i)}handleDisplayMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(Co.a.ConvListController.getCurrentFilter().type);if(Object(nW.a)().info("[Event] Display message tab.",{info:e,enteringSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],i=this.getLastReceivedMsgInfo_(t),n=this.getLastSeenMilestone_(t);if(i.msgId&&i.msgId>n){const e=i.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:aW.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}handleHideMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(Co.a.ConvListController.getCurrentFilter().type);if(Object(nW.a)().info("[Event] Hide message tab.",{info:e,leavingSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],i=this.getLastReceivedMsgInfo_(t),n=this.getLastSeenMilestone_(t);if(i.msgId&&i.msgId>n){const e=i.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:aW.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,t){const s=Co.a.UnreadDataManager.getUnreadByConvIdSync(e);if(!s)return;const i=s.lastProcessMsgId;if(!i)return;const n=this.getLastSeenMilestone_(t);n&&n>=i||this.saveNewSeenMilestone_(t,i)}handleMainApplicationInForeground_(){const e=this.convetFilterTypeToSubChatTabType(Co.a.ConvListController.getCurrentFilter().type);if(Object(nW.a)().info(`[Event] Main application in foreground - enteringSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),i=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>i){const i=s.msgId;this.saveNewSeenMilestone_(e,i),t.push({sct:aW.c.SubChatTab,id:e,msgId:i})}t.length&&this.networkService_.syncSeenSubChatTab(t)}handleMainApplicationInBackground_(){const e=this.convetFilterTypeToSubChatTabType(Co.a.ConvListController.getCurrentFilter().type);if(Object(nW.a)().info(`[Event] Main application in background - leavingSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),i=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>i){const i=s.msgId;this.saveNewSeenMilestone_(e,i),t.push({sct:aW.c.SubChatTab,id:e,msgId:i})}t.length&&this.networkService_.syncSeenSubChatTab(t)}onReceiveSeenSubChatTab(e){e.forEach((({type:e,msgId:t})=>{if(this.isValidSubChatTabType(e)){const s=t,i=this.getLastSeenMilestone_(e);if(s&&s>i){let t=this.getUnreadSubChatTabStateStore_()[e];t=Object(f.a)(Object(f.a)({},t),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[e]=t,this.saveNewSeenMilestone_(e,s),Object(hs.h)(this.name,this.key)}}}))}hasUnreadSubChatTab(e){var t;return!!this.isValidSubChatTabType(e)&&(null!==(t=this.getUnreadSubChatTabStateStore_()[e].hasUnread)&&void 0!==t&&t)}isValidSubChatTabType(e){return this.getAllValidSubtabs().includes(e)}convetFilterTypeToSubChatTabType(e){return e===io.d.FOCUSED?aW.d.FOCUSED:e===io.d.ARCHIVED?aW.d.ARCHIVED:aW.d.NONE}getAllSeenMilestones(){return this.getAllValidSubtabs().reduce(((e,t)=>(e[t]=this.getLastSeenMilestone_(t),e)),{})}getAllValidSubtabs(){return[aW.d.FOCUSED,aW.d.ARCHIVED]}getAllSubChatTabsNeedPullLastSeenWhenPullOfflineDone(e){const t=[];return this.getAllValidSubtabs().forEach((s=>{(e||this.hasUnreadSubChatTab(s))&&t.push(s)})),t}getUnreadSubChatTabStateStore_(){return this.unreadSubChatTabStateStore_||(this.unreadSubChatTabStateStore_=this.getAllValidSubtabs().reduce(((e,t)=>(e[t]={type:t,hasUnread:!1},e)),{})),this.unreadSubChatTabStateStore_}isRightMsgIdString_(e){return!!e&&("string"==typeof e&&!e.includes("object"))}saveNewSeenMilestone_(e,t){this.isValidSubChatTabType(e)?this.isRightMsgIdString_(t)?this.storage_.setNewSeenMilestone(e,t):Object(nW.a)().error("[SaveNMS] Invalid newMilestone.",{newMilestone:t},1):Object(nW.a)().error("[SaveNMS] Invalid subchat tab type.",{type:e},1)}getLastSeenMilestone_(e){if(!this.isValidSubChatTabType(e))return"";let t=this.storage_.getLastSeenMilestone(e);return t&&!this.isRightMsgIdString_(t)&&(Object(nW.a)().error("[GetLSM] Get invalid milestone.",{milestone:t},1),t="",this.storage_.setNewSeenMilestone(e,t)),t}saveNewReceivedMsgInfo_(e,t){this.isValidSubChatTabType(e)?t&&t.convId&&this.isRightMsgIdString_(t.msgId)?this.storage_.setNewReceivedMsgInfo(e,t):Object(nW.a)().error("[SaveNRMI] Invalid msgId.",{info:t},1):Object(nW.a)().error("[SaveNRMI] Invalid subchat tab type.",{type:e},1)}getLastReceivedMsgInfo_(e){if(!this.isValidSubChatTabType(e))return{convId:"",msgId:""};let t=this.storage_.getLastReceivedMsgInfo(e);return t.msgId&&!this.isRightMsgIdString_(t.msgId)&&(Object(nW.a)().error("[GetLRMI] Get invalid msgId.",{lastReceivedMsgInfo:t},1),t={convId:"",msgId:""},this.storage_.setNewReceivedMsgInfo(e,t)),t}init(){}getItem(e){if(e.key===this.key)return this.unreadSubChatTabStateStore_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||yW)||yW)||yW)||yW);s("UCdJ");const CW=Object(i.define)("migrate-dt-remote-configs");var OW,EW=s("BdN5");let MW=Object(i.singleton)()(OW=Object(i.injectable)()(OW=function(e,t){return Object(i.inject)(CW)(e,void 0,0)}(OW=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(OW=Reflect.metadata("design:type",Function)(OW=Reflect.metadata("design:paramtypes",[void 0===CW?Object:CW,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(OW=class{constructor(e,t){this.configs=e,this.logger=void 0,this.logger=t.createZLogger(Ve.ZLoggerNametags.dbDataTransform,["migration"])}install(){this.logger.zsymb(0,"86ISRO","install");const e=i.ModuleContainer.resolve(EW.a).getChatHandler(),t=()=>{e.unsubcribe(nd.b.ON_DONE_OFFLINE,t),setTimeout((()=>{this.migrateIfneeded()}),this.configs.nestedKey("start_after"))};e.subcribe(nd.b.ON_DONE_OFFLINE,t)}async migrateIfneeded(){const e=i.ModuleContainer.resolve(yx.b),t=await e.checkShouldMigrate();-1!==t?this.start(t):this.logger.zsymb(0,"LIPc9P","No migration data transform is available")}async start(e){if(!this.configs.nestedKey("enable"))return void this.logger.zsymb(0,"vN_BvA","Migrate data transform is disable");this.logger.zsymb(0,"hli9PS","start trigger migrate data transform:",e);const t=i.ModuleContainer.resolve(Ne),s=i.ModuleContainer.resolve(yx.b);await t.init(),t.onMigrateStart(e);const n=await s.migrateData({gapTime:this.configs.nestedKey("gap_time"),version:e,batchSize:this.configs.nestedKey("batch_size")},tt.default.getInstance());n.success?t.onMigrateSettled(!0):t.onMigrateSettled(!1),this.logger.zsymb(0,"F3QW-_","done migrate data transform",JSON.stringify(n))}})||OW)||OW)||OW)||OW)||OW)||OW;var SW,TW=s("8NAh");const wW="dt-cmc-sns";Object(i.singleton)(TW.a)(SW=class{commit(e){E.default.getInstance().setObject(wW,e)}getLastCommit(){return E.default.getInstance().getObject(wW)}relase(){E.default.getInstance().removeItem(wW)}});var RW;Be.j.timeInMs("5s"),Be.j.timeInMs("100ms");const LW={enable:!1,start_after:Be.j.timeInMs("1m"),gap_time:Be.j.timeInMs("500ms"),batch_size:50,bypass_legacy_error:!1,enable_detail_log:!0};let DW=Object(i.singleton)()(RW=Reflect.metadata("design:type",Function)(RW=Reflect.metadata("design:paramtypes",[])(RW=class extends yi.AdvancedRemoteConfigs{constructor(){super("db_transform_migrate",LW,{validator:new yi.ObjectValidator({enable:yi.Rule.field().boolean(),start_after:yi.Rule.field().number().min(0),gap_time:yi.Rule.field().number().min(0),batch_size:yi.Rule.field().number().min(1),bypass_legacy_error:yi.Rule.field().boolean(),enable_detail_log:yi.Rule.field().boolean()})})}})||RW)||RW)||RW;i.ModuleContainer.registerSingleton(CW,DW);class AW{constructor(e,t,s){this.state=void 0,this.initDeferer=void 0,this.persister=void 0,this.log=void 0,this.initDeferer=new Be.c.Container,this.state=Object(f.a)({},t),this.persister=e,this.log=s||null}init(){return this.persister.load().then((e=>(e&&(this.state=Object(f.a)({},e)),this.initDeferer.resolve(this.state),this.state)))}async getValue(e){return await this.initDeferer.promise,b()(this.state,e)}async updateValue(e,t){return await this.initDeferer.promise,y()(this.state,e,t),this.saveState()}async getState(){return await this.initDeferer.promise,this.state}saveState(){return new Promise((e=>{this.persister.flush(this.state).then((t=>{e(!0)})).catch((t=>{this.log&&this.log("state-store: flush err "+JSON.stringify(t)),e(!1)}))}))}destroy(){return new Promise((e=>{this.persister.destroy().then((t=>{e(!0)})).catch((t=>{this.log&&this.log("state-store: destroy err "+JSON.stringify(t)),e(!1)}))}))}}class FW{constructor(e){this.storeName=e}async load(){return E.default.getInstance().getObject(this.storeName)}async flush(e){E.default.getInstance().setObject(this.storeName,e)}async destroy(){return E.default.getInstance().removeItem(this.storeName),!0}}var jW,PW=s("4oeT");const kW={version:0,startTime:-1,runTimes:0,migratedRecord:0,migrateTime:-1,tables:[]};function NW(e,t){return`${e}_${t}`}Object(i.singleton)(Ne)(jW=Reflect.metadata("design:type",Function)(jW=Reflect.metadata("design:paramtypes",[])(jW=class{constructor(){this.migrateHasStarted=void 0,this.stateStore=void 0,this.migrateTBStartTimes=void 0,this.migrateTBCount=void 0,this.qos=void 0,this.migrateHasStarted=!1,this.stateStore=new AW(new FW("db_tr_rp"),kW),this.migrateTBStartTimes=new Map,this.migrateTBCount=new Map,this.qos=new PW.DataTransformQos}get state(){return this.stateStore.state}async init(){await this.stateStore.init()}onMigrateStart(e){this.migrateHasStarted||(this.migrateHasStarted=!0,this.qos.startMigrate(),this.stateStore.updateValue("runTimes",this.state.runTimes+1),this.state.startTime===kW.startTime&&(this.stateStore.updateValue("startTime",Date.now()),this.stateStore.updateValue("version",e)))}onMigrateSettled(e){const t=Date.now()-this.state.startTime;this.stateStore.updateValue("migrateTime",t).then((t=>{this.qos.endMigrate(e,this.state),e&&this.stateStore.destroy()}))}onStart(e,t){const s=NW(e,t);this.migrateTBStartTimes.has(s)||this.migrateTBStartTimes.set(s,Date.now())}onProgress(e,t,s){const i=NW(e,t),n=this.migrateTBCount.get(i)||0,a=this.state.migratedRecord;this.migrateTBCount.set(i,n+s),this.stateStore.updateValue("migratedRecord",a+s)}onFinished(e,t){const s=NW(e,t);this.qos.submitMigrateTableSuccess({tableName:e,count:this.migrateTBCount.get(s)||0,migratetime:Date.now()-(this.migrateTBStartTimes.get(s)||0),version:t});const i=[...this.state.tables,e];this.stateStore.updateValue("tables",i)}onError(e,t,s){const i=NW(e,t);this.qos.submitMigrateTableError({tableName:e,count:this.migrateTBCount.get(i)||0,migratetime:Date.now()-(this.migrateTBStartTimes.get(i)||0),error:s,version:t});const n=[...this.state.tables,e];this.stateStore.updateValue("tables",n)}})||jW)||jW);i.ModuleContainer.resolveToken(MW).install();class UW{constructor(){this.aborted=void 0,this.aborted=!0}}class BW{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this._taskId=Object(gr.b)(8),this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const i=()=>{this._aborted=!0,s(new UW),this._abortController.signal.removeEventListener("abort",i)};this._abortController.signal.addEventListener("abort",i),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",i),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}get taskId(){return this._taskId}set taskId(e){this._taskId=e}}function xW(e,...t){return new BW(e,t)}var GW=s("SkSZ");const zW={UNLOAD_ZPOPUP_WINDOW:"UNLOAD_ZPOPUP_WINDOW"};var VW,HW=s("6VRG");Object(i.injectable)()(VW=Object(ko.b)(mr.a)(VW=class{constructor(){this.OPEN_TIMEOUT=1e4,this.CLOSE_TIMEOUT=1e4,this.instances=new Map,this.runningTask=new Map,this._eventEmitter=new Op.a,this.open=async e=>{const t=e.windowId;Object(Q.a)(!!t,`windowId must be a valid string. Received ${t}`),Object(Q.a)("object"==typeof e.parentWindow,"parentWindow must be a valid window object");const s=this.getOpenTaskId(t),i=this.runningTask.get(s);if(i&&!i.fulfilled)return await i.promise;if(this.instances.has(t)){const e=this.instances.get(t);return this.focus(t),e}const n=xW(this._create,e);n.taskId=s;const a=e.parentWindow.setTimeout((()=>{n.abort(),this.runningTask.delete(s)}),this.OPEN_TIMEOUT),r=()=>{this.runningTask.delete(s),e.parentWindow.clearTimeout(a)};this.runningTask.set(s,n);try{const e=await n.promise;return r(),e}catch(o){throw r(),o}},this.openMediaViewerWindow=async e=>{Object(Q.a)(!!e.windowId,`windowId must be a valid string. Received ${e.windowId}`),Object(Q.a)("object"==typeof e.parentWindow,"parentWindow must be a valid window object");const t=this.getOpenTaskId(e.windowId),s=this.runningTask.get(t);if(s&&!s.fulfilled)return zconsole.zsymb(3,"gKyWQr",["[MVR]:found opening task:lock","ozyMrm"],e.windowId),await this.runningTask.get(t).promise;if(this.instances.has(e.windowId)){const t=this.instances.get(e.windowId);return this.focus(e.windowId),t}const n=i.ModuleContainer.resolve(hr.c).getInfoScreenOfMouse(e.parentWindow),a={min_width_open_window:GW.a.media_viewer.min_width_open_window,min_height_open_window:GW.a.media_viewer.min_height_open_window,max_width_open_window:GW.a.media_viewer.max_width_open_window,max_height_open_window:GW.a.media_viewer.max_height_open_window},r=this._getSavedPopupSize(e.windowId);zconsole.zsymb(12,"oiKxM8","[MVR]: open:init savedSize",r);const o=hr.d.calculateWindowSizeByScreen(n,a,r),l=hr.d.calculatePositionCenterScreen(n,o),c={w:o.w,h:o.h,x:l.x,y:l.y};zconsole.zsymb(12,"_d2AMZ","[MVR]: open:init bounds",c),e.onWindowDOMContentLoaded||(e.onWindowDOMContentLoaded=()=>{var t;const s=this.getWindow(e.windowId),i=s.instance;Object(Q.a)(!!i,`zpopupWindow must be a valid object. Received ${s}`),zconsole.info("[MVR]: onWindowDOMContentLoaded",null==i||null===(t=i.document)||void 0===t?void 0:t.readyState),Object(br.copyStyles)(e.parentWindow.document,i.document)}),e.onWindowLoad||(e.onWindowLoad=()=>{var t;const s=this.getWindow(e.windowId),i=s.instance;Object(Q.a)(!!i,`[MVR]: zpopupWindow must be a valid object. Received ${s}`),zconsole.zsymb(12,"gI2R3p","[MVR]: onWindowLoad cb"),Object(br.preventUserAction)(i,!0,this._exitWhenError);const n=i.document.createElement("div");n.id="popup-viewer";const a=i.document.createElement("div");a.id=s.id,n.appendChild(a),i.document.body.appendChild(n),null===(t=i.document.getElementById("app"))||void 0===t||t.remove(),this.data.set(e.windowId,{windowId:e.windowId,ready:!0}),this._signalRenderItem(this.name,e.windowId)}),e.frame||(e.frame=""),e.specs||(e.specs=hr.d.getWindowSpec(c)),e.windowBoundary||(e.windowBoundary=c);try{const t=await this.open(e);return Mo.a.increaseSuccess(Mo.a.duration),t}catch(m$){throw Mo.a.increaseFailed(Mo.a.duration,Mo.a.Code.WindowOpenFailed,Date.now(),[Mo.a.platform]),m$}},this.getWindow=e=>this.instances.get(e)||null,this.close=async e=>{var t;this.emit(zW.UNLOAD_ZPOPUP_WINDOW,{windowId:e});const s=this.getOpenTaskId(e);if(this.runningTask.has(s))return;const i=this.getCloseTaskId(e);if(this.runningTask.has(i))return;const n=this.instances.get(e);if(!n)return zconsole.zsymb(18,"DyDpzX","[MVR]: zpopup close failed due to NO WINDOW FOUND"),Promise.resolve();this.savePopupSize(e);const a=xW(n.close);a.taskId=i,this.runningTask.set(i,a);const r=null===(t=n.instance)||void 0===t?void 0:t.setTimeout(a.abort,this.CLOSE_TIMEOUT),o=()=>{var t;this.runningTask.delete(i),null===(t=n.instance)||void 0===t||t.clearTimeout(r),this.instances.delete(e),this.data.delete(e),this._signalRenderItem(this.name,e),zconsole.zsymb(0,"0oHPTW",`[MVR]: zpopup: close finished ${e}`)};try{await a.promise,Mo.a.increaseSuccess(Mo.a.duration),o()}catch(l){throw Mo.a.increaseFailed(Mo.a.duration,Mo.a.Code.WindowFailed,Date.now(),[Mo.a.platform]),o(),zconsole.error("[MVR]: zpopup:close error",l),l}},this.focus=async e=>{const t=this.instances.get(e);if(!t)return Promise.resolve();try{await t.focus(),Mo.a.increaseSuccess(Mo.a.duration)}catch(m$){throw Mo.a.increaseFailed(Mo.a.duration,Mo.a.Code.WindowFocusFailed,Date.now(),[Mo.a.platform]),this.instances.delete(e),m$}},this.getOpenTaskId=e=>`open-${e}`,this.getCloseTaskId=e=>`close-${e}`,this._exitWhenError=e=>{zconsole.zsymb(18,"_pbOAc",`[MVR]: zpopup:exitWhenError windowId ${e}`),rs.default.createError(os.a.str("STR_POPUP_OPEN_ERR")),this.close(e),this.data.delete(e),this._signalRenderItem(this.name,e),Mo.a.increaseFailed(Mo.a.duration,Mo.a.Code.ExitWhenError,Date.now())},this._abortTask=async e=>{const t=this.runningTask.get(e);t?(t.abort(),this.runningTask.delete(e)):zconsole.info(`[MVR]: zpopup:abort open windowId ${e}`)},this._signalRenderItem=(...e)=>{Object(hs.i)(...e)},this._create=async e=>{if(this.instances.has(e.windowId))return this.instances.get(e.windowId);e.onWindowCreated=t=>{this.instances.set(e.windowId,t)};const t=await i.ModuleContainer.resolve(hr.c).create(e);if("ERROR"===t.type)throw t;return t.data},this.savePopupSize=e=>{if(HW.MVR_ID_LIST.some((t=>t===e))){const t=this.instances.get(e);if(!t)return;const s=t.getCurrentWindowSizes(),i=E.default.getInstance();if(i&&s)try{const{w:t,h:n}=s;Object(Q.a)("number"==typeof t&&t>0,`width must be a number. Received ${t}`),Object(Q.a)("number"==typeof n&&n>0,`height must be a number. Received ${n}`),zconsole.zsymb(15,"FfVzZQ",["[MVR] savePopupSize: windowId: {}, width: {}, height: {}","YJ8ycf"],e,t,n);const a=this._buildPopupSizeKey(e),r=JSON.stringify({width:t,height:n});i.setItemForCurrentUser(a,r)}catch(m$){zconsole.zsymb(21,"HPwCAV",["[MVR] error: Cannot save popup size. windowId: {}","bGB34d"],e,m$)}else zconsole.zsymb(21,"52ZnPl",["[MVR] Cannot save popup size. secureLocalStorage is not found. windowId: {}","OJAdEK"],e)}},this._buildPopupSizeKey=e=>`mvr_${e}_size`,this._getSavedPopupSize=e=>{const t=E.default.getInstance();if(t)try{const s=this._buildPopupSizeKey(e),i=t.getItemForCurrentUser(s);if(i){const e=JSON.parse(i);return Object(Q.a)("object"==typeof e,"width must be a number. Received "+typeof e),Object(Q.a)("number"==typeof(null==e?void 0:e.width),`width must be a number. Received ${null==e?void 0:e.width}`),Object(Q.a)("number"==typeof(null==e?void 0:e.height),`height must be a number. Received ${null==e?void 0:e.height}`),{w:e.width,h:e.height}}}catch(m$){zconsole.zsymb(21,"I0FKcP",["[MVR] error: Cannot get popup size. windowId: {}","YEQx8j"],e,m$)}else zconsole.zsymb(21,"Xhjggt",["[MVR] Cannot get popup size. secureLocalStorage is not found. windowId: {}","VcKwZ_"],e);return null},this.name=mr.b,this.data=new Map,this.key="windowId",this.init=()=>{}}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in zW&&this._eventEmitter.emit(e,t)}isValidPhotoViewerWindowId(e){return e===hr.a.PHOTO_VIEWER_ID}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||VW);var WW,$W=s("RHk6"),KW=s("r06Z");Object(i.singleton)($W.BankParserController)(WW=class{constructor(){this.logger=void 0}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(Ve.ZLoggerNametags.bankParser,["controller"])),this.logger}async createParserTasks(e,t){const s=new Map,i=new Map;for(const n of e){const e=t.get(n);if(!e||!e.length)continue;const a=await Rt.default.getMessagesByIds(n,e);for(const t in a){const e=a[t];if(KW.a.isMessageParsable(e)&&e.message){const t=e.cliMsgId,a=Number(e.sendDttm)||yn.default.getTimeNow(),r=KW.a.formatMessageContent({content:{text:e.message},mentions:e.mentions});if(r){let e=s.get(r);e||(e=KW.a.create(r),s.set(r,e));const o=i.get(r)||[];o.push({clientId:String(t),convId:n,ts:a}),i.set(r,o)}}}}return{parserMapping:s,submitInfoMapping:i}}onForwardMessages(e,t){if(!Array.isArray(e)||!KW.a.enableBankParser())return;const s=Array.isArray(t)?t:[t],i=new Map;for(const{msgId:n,toUid:a}of s){const e=i.get(a)||[];e.push(n),i.set(a,e)}this.createParserTasks(e,i).then((({parserMapping:e,submitInfoMapping:t})=>{e.forEach(((e,s)=>{const i=t.get(s)||[];for(const{clientId:t,ts:n,convId:a}of i)e.submit(t,n,a,ho.default.isGroup(a));e.parse().exec()}))})).catch((t=>{this.Logger.zsymb(18,"Im1wpr","[forward] parse bank failed",e,t)}))}});var qW,QW=s("cO+G"),ZW=s("ju6I");let JW=Object(i.injectable)()(qW=Object(Je.d)()(qW=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(qW=function(e,t){return Object(i.inject)(Xr)(e,void 0,1)}(qW=Reflect.metadata("design:type",Function)(qW=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof ILastOnlineDetector?Object:ILastOnlineDetector])(qW=class extends Fe.b{constructor(e,t){super(),this.lastOnlineDetector=t,this.config=void 0,this.isBackOnlineEventFired=!1,this.prevNetworkStatus=null,this.prevUserActiveStatus=null,this.logger=void 0,this.config=QW.a,this.logger=e.createZLogger(Ve.ZLoggerNametags.offline2Online,["back-to-online-detector"])}onApplicationReady(){this.logger.zsymb(3,"eIgEur",["application ready","pOt7Xr"]),this.dispatchEventBackToOnline("first-start-app"),this.registerListener()}registerListener(){this.logger.zsymb(3,"W8RrW0",["register listener","uNQXhI"]),Fi.default.subscribe(((e,t)=>{switch(e){case Ai.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t);case Ai.GeneralActions.USER_ACTIVE_CHANGED:return this.onUserActiveChanged(t);case Ai.WebsocketActions.CONNECTION_STATE_CHANGE:return this.onWebSocketStateChanged(null==t?void 0:t.state)}}))}onNetworkStatusChanged(e){const t=this.prevNetworkStatus;e!==t&&(this.logger.zsymb(3,"gELdXg",["network status changed, [prev, curr]=[{}, {}]","adbtsq"],this.prevNetworkStatus,e),this.prevNetworkStatus=e,t!==fu.a.CONNECTED&&e===fu.a.CONNECTED?this.checkAndDispatchEventIfNeeded():e!==fu.a.CONNECTED&&MI.default.getSocketState()!==WebSocket.OPEN&&(this.isBackOnlineEventFired=!1))}onUserActiveChanged(e){if(!1===[dI.c.RESUME,dI.c.SLEEP].includes(e))return;const t=this.prevUserActiveStatus;e!==t&&(this.logger.zsymb(3,"0qF6eJ",["user active changed, [prev, curr]=[{}, {}]","rhuBAv"],this.prevUserActiveStatus,e),this.prevUserActiveStatus=e,t===dI.c.SLEEP&&e===dI.c.RESUME?this.checkAndDispatchEventIfNeeded():e===dI.c.SLEEP&&(this.isBackOnlineEventFired=!1))}onWebSocketStateChanged(e){if(this.config.nestedKey("back_to_online_detector.enable_detect_session_by_websocket"))switch(e){case WebSocket.OPEN:return void this.dispatchEventBackToOnline("resume-app");case WebSocket.CLOSED:case-1:return void(this.isBackOnlineEventFired=!1)}}checkAndDispatchEventIfNeeded(){if(this.config.nestedKey("back_to_online_detector.enable_detect_session_by_websocket")){switch(id.default.getMsgSrcType()){case R.MsgSources.SOCKET:this.checkWebSocketAndDispatchEventIfNeeded();break;case R.MsgSources.POLLING:case R.MsgSources.UNSET:default:this.checkDurationOfflineAndDispatchEventIfNeeded()}}else this.checkDurationOfflineAndDispatchEventIfNeeded()}checkWebSocketAndDispatchEventIfNeeded(){const e=MI.default.getSocketState();e!==WebSocket.OPEN?this.dispatchEventBackToOnline("resume-app"):(this.logger.zsymb(3,"ZhypUT",["not need dispatch event resume app, socket state is {}","DB5Ge1"],e),this.isBackOnlineEventFired=!0)}async checkDurationOfflineAndDispatchEventIfNeeded(){const[e,t]=await Promise.all([this.lastOnlineDetector.getStartTsOnlineCurrSession(),this.lastOnlineDetector.getLastTsOnlinePrevSession()]);Math.abs(e-t)>=this.config.nestedKey("back_to_online_detector.max_offline_duration")&&this.dispatchEventBackToOnline("resume-app"),this.isBackOnlineEventFired=!0}dispatchEventBackToOnline(e){this.isBackOnlineEventFired||(this.dispatchEvent(new ZW.b(e)),this.isBackOnlineEventFired=!0)}})||qW)||qW)||qW)||qW)||qW)||qW;i.ModuleContainer.registerSingleton(ZW.c,JW);class YW{constructor(){this.name="o2o",this.key="",this.state={shouldKeepLoadingScreen:!0},this.timer=null}startKeepLoadingIfNeeded(){this.enabled&&this.state.shouldKeepLoadingScreen&&(this.resetTimer(),this.timer=setTimeout((()=>{this.dismissLoadingScreen(),this.timer=null}),this.timeoutDuration))}async dismissLoadingScreen(){await Object(ro.c)(this.delayDuration),this.state.shouldKeepLoadingScreen=!1,Object(hs.h)(this.name,ps),this.resetTimer()}resetTimer(){null!==this.timer&&clearTimeout(this.timer)}get enabled(){return!!QW.a.nestedKey("keep_loading_during_preload.enable")}get timeoutDuration(){return QW.a.nestedKey("keep_loading_during_preload.timeout_duration")}get delayDuration(){return QW.a.nestedKey("keep_loading_during_preload.screen_dismiss_delay")}init(){}getItem(){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){}onGetListFailure(e,t){}}i.ModuleContainer.registerSingleton(fs,YW),i.ModuleContainer.registerSingleton(ko.a,YW),function(){const e=i.ModuleContainer.resolve(No.ConvListController),t=Zr.a.getInstance();e.addEventListener(so.c.StateChangedDueToFilterTypeChange,(e=>{t.skipAnimationForSnapshot(e.listFiltered)})),e.addEventListener(so.c.StateChangedDueToFilterTypeSrcChange,(e=>{t.skipAnimationForSnapshot(e.listFiltered)}))}();i.ModuleContainer.resolve(me.a).addEventListener(je.a.SessionChange,(async({session:e})=>{const t=E.default.getInstance();null!==e?t.init(e.userId,e.UIN):t.resetSession()}));var XW=s("+eUS");const e$="render"!==__ZaBUNDLENAME__&&"WEB"!==__ZaBUNDLENAME__&&"shared-worker"!==__ZaBUNDLENAME__&&"main"!==__ZaBUNDLENAME__;setTimeout((async function(){if(e$)return;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("bootstrap",["shared"]);e.zsymb(3,"S4ddRU",["running application bootstrap","_jjhYp"]);let t=(()=>{switch(__ZaBUNDLENAME__){case"WEB":return Le.i.Browser;case"render":return Le.i.Host;case"shared-worker":return Le.i.Client;case"main":return Le.i.Background;default:return Le.i.Unknown}})();try{const s=i.ModuleContainer.resolve(Je.a);await s.start(),Object(XW.a)(t),t===Le.i.Browser&&Object(Tt.b)(),"shared-worker"===__ZaBUNDLENAME__&&await s.init(),e.zsymb(3,"0AWGnZ",["application bootstrap success","VDFJQN"])}catch(s){e.zsymb(0,"dJ4XhC",(()=>["application bootstrap fail",{reason:s}]))}}),0);s("Lp8g");var t$,s$=s("6QZ1");i.ModuleContainer.registerSingleton(s$.a,class{getNotMigratedAccounts(){throw new Error("Not supported")}authenticate(e){}isCurrentAccountMigrated(){throw new Error("Not supported")}getTotalMigratedAccount(){throw new Error("Not supported")}forceMarkAsDoneMigrateDB40(){throw new Error("Not supported")}getIsTrickle(){throw new Error("Not supported")}});let i$=Object(i.injectable)()(t$=Object(i.singleton)()(t$=class{constructor(){this.type=void 0,this.name=ms.a,this.key=""}handleResumeMigrate(e){throw new Error("Method not implemented.")}getMigrateDiskInfoByProgress(e){throw new Error("Method not implemented.")}async handleStartMigrate(){throw new Error("Method not implemented.")}async handleRejectMigrate(){throw new Error("Method not implemented.")}async handleRetryMigrate(){throw new Error("Method not implemented.")}waitMigrateRelease(){return Promise.resolve()}waitForDBMigrate(e,t){return Promise.resolve()}cleanupData(){return Promise.resolve()}promoteMigrateByOpenConv(e){}skipMigrate(){throw new Error("Method not implemented.")}scheduleReminder(){throw new Error("Method not implemented.")}init(){}getItem(){return{percent:0,status:ms.d.DISABLED,requiredSpace:0,error:"",migratedCount:0,toMigrateCount:0,timeElapsed:0,numOfReader:1,batchSize:5e3,count:1,pausedLastSession:!1,allowReject:!1,forceReject:!1,isLowDiskSpace:!1}}getList(){return[]}onGetItemFailure(e,t){}onGetListFailure(e,t){}})||t$)||t$;i.ModuleContainer.registerSingleton(ms.b,i$),i.ModuleContainer.registerSingleton(ko.a,i$);var n$,a$=s("vyAj");let r$=Object(i.injectable)()(n$=Object(Je.g)()(n$=Object(Je.i)()(n$=Object(i.singleton)()(n$=Reflect.metadata("design:type",Function)(n$=Reflect.metadata("design:paramtypes",[])(n$=class{constructor(){}onStart(){a$.b.on(a$.a.UPDATE_SERVER_CONFIG_BY_SOCKET,this.handleReceiveConfig.bind(this))}onDispose(){a$.b.off(a$.a.UPDATE_SERVER_CONFIG_BY_SOCKET,this.handleReceiveConfig.bind(this))}handleReceiveConfig(e){return!!this.isValidConfig(e.payload)&&(this.handleUpdateConfig(e.payload),!0)}isValidConfig(e){return!!e&&("object"==typeof e&&(!!e.hasOwnProperty("data")&&(!!e.data.hasOwnProperty("actions")&&(!!Array.isArray(e.data.actions)&&(!!e.data.actions.length&&this.isValidActions(e.data.actions))))))}isValidActions(e){let t=!0;for(const s of e)s.act!==l$.ACT&&(t=!1),s.act_type!==l$.ACT_TYPE&&(t=!1),this.isValidJsonObjConf(s.data)||(t=!1);return t}isValidJsonObjConf(e){if(!e)return!1;try{let t=JSON.parse(e);return"object"==typeof t&&!Array.isArray(t)}catch(m$){return!1}}getObjConfFromAction(e){try{return JSON.parse(e.data)}catch(m$){return null}}handleUpdateConfig(e){e.data.actions.forEach((e=>{const t=this.getObjConfFromAction(e);t&&HM.default.updateConfigBySocket(t)}))}parsePathToObject(e,t){let s=e.split("?.").join("."),i=[],n="",a=!1,r=!1;for(let c=0;c<s.length;c++){let e=s[c];"["===e?(n&&i.push(n),n="",a=!0,r=!1):"]"===e?(a=!1,r?i.push(n):i.push(parseInt(n,10)),n=""):"'"===e||'"'===e?r=!0:"."!==e||a?n+=e:(n&&i.push(n),n="")}n&&i.push(n);let o="number"==typeof i[0]?[]:{},l=o;for(let c=0;c<i.length;c++){let e=i[c],s=i[c+1];c===i.length-1?l[e]=t:"number"==typeof s?(l[e]=l[e]||[],l=l[e]):(l[e]=l[e]||{},l=l[e])}return o}})||n$)||n$)||n$)||n$)||n$)||n$;const o$=Object(i.define)("server-info-socket-token");i.ModuleContainer.registerSingleton(o$,r$);const l$={ACT:"server_info",ACT_TYPE:"update_config"};class c$ extends Fe.b{start(){}}var d$,u$=c$;Object(Je.i)()(d$=Object(i.singleton)(yc)(d$=class extends u${conversationWillClose(e,t){super.dispatchEvent(new Oc(e,t))}conversationDidClose(e,t){super.dispatchEvent(new Ec(e,t))}conversationWillOpen(e,t){super.dispatchEvent(new Tc(e,t))}conversationDidOpen(e,t){super.dispatchEvent(new wc(e,t))}conversationWillDelete(e,t){super.dispatchEvent(new Mc(e,t))}conversationDidDelete(e,t){super.dispatchEvent(new Sc(e,t))}onStart(){this.start()}start(){const e=Object.keys(Pc);e.length>0&&e.forEach((e=>{const t=Pc[e];this.addEventListener(e,(e=>{t.targets.forEach((s=>{try{var n,a;null===(n=(a=i.ModuleContainer.resolveToken(s))[t.callback])||void 0===n||n.call(a,e)}catch(r){}}))}))})),super.start()}})||d$);var h$=s("GFHO");s("zlHd");function g$(){const e=Vr.a.resolveAll(Wr.a);for(const t of e)t.init()}(function(e){const t=new h$.a(e);if(t.remoteConfigs.key("enable").boolean)g$();else{const e=()=>{t.remoteConfigs.key("enable").boolean&&(g$(),t.remoteConfigs.remove(e))};t.remoteConfigs.add(e)}})({platform:"web"})},qU4b:function(e,t){},rhBN:function(e,t,s){"use strict";var i,n=s("jDHv"),a=s("UK4g"),r=s("YEoC"),o=s("DI/x"),l=s("tHMN"),c=s("LzQZ");let d=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(l.b)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===l.b?Object:l.b])(i=class{constructor(e){this.engine=e,this.currentId=1,this.transactions=void 0,this.transactions=new Map}get(e){const t=this.transactions.get(e);if(!t)throw new o.h("The transaction has already committed!");return t}async beginTransaction(e,t,s){const i=this.currentId++,n=new Error,o=await this.engine.do({type:r.e.BeginTransaction,database:e,table:t[0],transaction:i,priority:r.d.BLOCKING,retry:a.h,timing:{},meta:{step:-1,timeout:a.k,error:n},params:{tables:t,mode:s},trace:()=>{}});return this.transactions.set(i,o),o}async commitTransaction(e){const t=this.transactions.get(e);return!t||t.closed?(t&&this.transactions.delete(e),Promise.resolve()):(await t.commit(),new Promise(((s,i)=>{t.onClose((()=>{this.transactions.delete(e),t.error?i(t.error):s()}))})))}})||i)||i)||i)||i;n.ModuleContainer.registerSingleton(c.a,d)},rvru:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var i,n=s("jDHv"),a=s("fc/q"),r=s("DI/x"),o=s("YEoC"),l=s("MRjZ"),c=s("BwoQ");let d=Object(n.injectable)()(i=function(e,t){return Object(n.inject)(a.b)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===a.IQosService?Object:a.IQosService])(i=class{constructor(e){this.qos=e,this.stopDBErrorQos=!1,this.dbErrorQosCount=0,this.stopMissingTablesQos={}}sendFailedMultiErrorQos(e){const{query:t,error:s}=e.data,i=t.meta.databaseConfig?t.meta.databaseConfig.type:-1,n=(()=>{if("string"==typeof s)return s;if(s instanceof Error)return s.toString();try{return JSON.stringify(s)}catch(e){return"Empty"}})(),a=[`(${Object(l.b)(t)}): ${n}`];this.qos.log({success:!1,commandId:c.g,subCommandId:i,duration:0,errorCode:t.type,params:a})}sendTimeConsumingQueryQos(e,t){let s=0;s=t<3e4?1:t<6e4?2:3,this.qos.log({success:!1,commandId:c.l,subCommandId:0,duration:t,errorCode:s,startTime:Date.now(),params:[JSON.stringify(e)]})}sendDBErrorQos(e){if(!this.stopDBErrorQos){if(e instanceof r.e)e instanceof r.b?this.sendDOMExceptionErrorQos(e):e instanceof r.B?this.sendSQLiteExceptionErrorQos(e):this.sendDALErrorQos(e);else{let t="";"string"==typeof e?t=e:e instanceof Error&&(t=e.message||e.name);const s=new r.i(t);this.sendDALErrorQos(s)}return this.dbErrorQosCount+=1,this.dbErrorQosCount>10?(this.stopDBErrorQos=!0,this.dbErrorQosCount=0,void setTimeout((()=>{this.stopDBErrorQos=!1}),9e5)):void 0}}sendSuccessOpenDBDurationQos(e,t,s){let i=1;s>2e4?i=6:s>15e3?i=5:s>1e4?i=4:s>5e3?i=3:s>1e3&&(i=2),this.qos.log({success:!1,commandId:c.k,subCommandId:0,duration:s,errorCode:i,startTime:t,params:[e]})}sendLongOpenRequestQos(e,t,s){this.qos.log({success:!1,commandId:c.h,subCommandId:0,errorCode:0,duration:s,startTime:t,params:[e]})}sendMissingTableQos(e,t){this.stopMissingTablesQos[e]||(this.qos.log({success:!1,commandId:c.i,subCommandId:0,errorCode:0,duration:0,startTime:Date.now(),params:[e,...t]}),this.stopMissingTablesQos[e]=!0)}sendDALErrorQos(e){this.qos.log({success:!1,commandId:c.e,subCommandId:0,duration:0,errorCode:e.code,startTime:Date.now(),params:e.qosParams})}sendSQLiteExceptionErrorQos(e){this.qos.log({success:!1,commandId:c.j,subCommandId:0,duration:0,errorCode:e.code,startTime:Date.now(),params:e.qosParams})}sendDOMExceptionErrorQos(e){let t=-1;switch(e.name){case"IndexSizeError":t=1;break;case"HierarchyRequestError":t=3;break;case"WrongDocumentError":t=4;break;case"InvalidCharacterError":t=5;break;case"NoModificationAllowedError":t=7;break;case"NotFoundError":t=8;break;case"NotSupportedError":t=9;break;case"InUseAttributeError":t=10;break;case"InvalidStateError":t=11;break;case"SyntaxError":t=12;break;case"InvalidModificationError":t=13;break;case"NamespaceError":t=14;break;case"InvalidAccessError":t=15;break;case"SecurityError":t=18;break;case"NetworkError":t=19;break;case"AbortError":t=20;break;case"URLMismatchError":t=21;break;case"QuotaExceededError":t=22;break;case"TimeoutError":t=23;break;case"InvalidNodeTypeError":t=24;break;case"DataCloneError":t=25;break;case"EncodingError":t=26;break;case"NotReadableError":t=27;break;case"UnknownError":t=-1;break;case"ConstraintError":t=28;break;case"DataError":t=29;break;case"TransactionInactiveError":t=30;break;case"ReadOnlyError":t=31;break;case"VersionError":t=32;break;case"OperationError":t=33;break;case"DBCorruptError":if(e.adapterType===o.a.SQLite){t=50;break}default:void 0!==e.code&&(t=e.code)}const s=e.message||"";this.qos.log({success:!1,commandId:c.f,subCommandId:0,errorCode:t,duration:0,startTime:Date.now(),params:[s]})}})||i)||i)||i)||i;const u=Object(n.define)("database-qos");n.ModuleContainer.registerSingleton(u,d)},taJj:function(e,t,s){"use strict";t.a=class{constructor(e){this.chunkSize=void 0,this.partialChunk=void 0,this.offset=void 0,this.chunkSize=e,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let s=0;if(this.offset>0){const i=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,i),this.offset),this.offset+=i,s+=i,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;s<e.byteLength;){const i=e.byteLength-s;if(i>=this.chunkSize){const i=e.slice(s,s+this.chunkSize);s+=this.chunkSize,this.send(i,t)}else{const t=e.slice(s,s+i);s+=t.byteLength,this.partialChunk.set(t),this.offset=t.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}}},uAZB:function(e,t){globalThis.voiceMessageE2EERaw={actionId:"4724577257152",msgId:"4724598698821",zglobalMsgId:"4724598698821",cliMsgId:"1695617353668",msgType:3,status:2,notify:"1",message:{title:"",description:"",href:"https://f2-voice-aac-dl.zdn.vn/278747013645988928/f1a56fd8df70352e6c61.aac?e2esession=sWJaI+5h2lpvfOKhpVvK1WiZmAVsh9SMd8K9fBEoNNJXagE5R6xEwIPR/YTOg4sY1G/1zvynosJP+gvj",thumb:"",childnumber:0,action:"",params:'{"m4a":"https:\\/\\/f2-voice-aac-dl.zdn.vn\\/278747013645988928\\/f1a56fd8df70352e6c61.aac?e2esession=sWJaI+5h2lpvfOKhpVvK1WiZmAVsh9SMd8K9fBEoNNJXagE5R6xEwIPR\\/YTOg4sY1G\\/1zvynosJP+gvj","duration":3000}',type:""},sendDttm:"1695617381952",serverTime:1695617382529,fromUid:"0",toUid:"g8293820567948517115",dName:"Lê Võ Gia Khang",localDttm:1695617152380,properties:{color:-1,size:-1,type:1,subType:0,ext:'{"shouldParseLinkOrContact":0}'},ttl:0,st:6,at:0,cmd:-1,originMsgType:"chat.voice",e2eeStatus:3e3,platformType:0,src:5,syncFromMobile:!1,topOut:"0",topOutTimeOut:"0",topOutImprTimeOut:"0",isLastMsg:!1,mediaAction:null,isSelected:!1},globalThis.voiceMessageRaw={actionId:"6424901573796",msgId:"4728547151178",zglobalMsgId:"4728547151178",cliMsgId:"1695718894432",msgType:3,status:2,notify:"1",message:{title:"",description:"",href:"https://f1-voice-talk.zdn.vn/1199765638478242634/edd3d72884836edd3792.amr",thumb:"",childnumber:0,action:"",params:'{"m4a":"https:\\/\\/f2-voice-aac-dl.zdn.vn\\/1199765638478242634\\/edd3d72884836edd3792.aac","duration":3000}',type:""},sendDttm:"1695718897605",serverTime:"1695718897605",fromUid:"0",toUid:"g4243069577519568569",dName:"Lê Võ Gia Khang",localDttm:1695718898102,properties:{color:-1,size:-1,type:1,subType:0,ext:'{"shouldParseLinkOrContact":0}'},ttl:0,st:3,at:0,cmd:521,originMsgType:"chat.voice",subState:-1,e2eeStatus:-1,platformType:0,src:10,syncFromMobile:!1,topOut:"0",topOutTimeOut:"0",topOutImprTimeOut:"0",isLastMsg:!1,isSelected:!1},globalThis.runSound=e=>{const t=new Audio;return t.src=e,t.play(),t}},zpw2:function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return u}));var i=s("Uzj0"),n=s("Mk04"),a=s("UK4g"),r=s("YEoC"),o=s("DI/x"),l=s("PmZf"),c=s("d951"),d=s("ipeT");class u{constructor(e,t,s,r,o){this.engine=e,this.transactionManager=t,this.databaseName=s,this.databaseSchema=r,this.numOfActiveQueries=0,this.pendingQueries=[],this.pending=!1,this.idleListeners=[];const l=i.g.map(r,((e,t)=>new d.b(s,t,a.j,this.doQuery.bind(this),this.dispatchQueryErrorEvent.bind(this),o)));Object.entries(l).forEach((([e,t])=>{Object.defineProperty(this,e,{value:t,writable:!1})})),Object.defineProperty(this,"runTransaction",{value:this.runTransaction.bind(this,this.databaseName,this.databaseSchema)}),Object.defineProperty(this,"runFakeTransaction",{value:this.runFakeTransaction.bind(this,this.databaseName,this.databaseSchema)}),Object.defineProperty(this,"runTransactionV2",{value:this.runTransactionV2.bind(this,this.databaseName,this.databaseSchema)}),Object.defineProperty(this,"runMigrateDataTransform",{value:this.runMigrateDataTransform.bind(this,this.databaseName,this.databaseSchema)}),this.closeThisDatabase=Object(n.a)(this.closeThisDatabase.bind(this))}dispatchQueryErrorEvent(e){this.engine.dispatchEvent(new l.d(e))}get isIdle(){return 0===this.numOfActiveQueries}dispatchIdleEvent(){this.idleListeners.forEach((e=>e())),this.idleListeners=[]}addIdleListenerOnce(e){this.isIdle?e():this.idleListeners.push(e)}stop(){this.pending=!0}resume(){this.pendingQueries.forEach((e=>{e.execute()})),this.pendingQueries=[],this.pending=!1}waitUntilIdle(){return new Promise((e=>{this.addIdleListenerOnce((()=>e()))}))}trapIdleTracking(e){return this.numOfActiveQueries+=1,e.finally((()=>{this.numOfActiveQueries-=1,this.isIdle&&this.dispatchIdleEvent()}))}doQuery(e){const t=()=>this.trapIdleTracking(this.engine.do(e));if(this.pending){const e=()=>t(),s=new c.a(e);return this.pendingQueries.push(s),s.getResult()}return t()}async closeThisDatabase(e){this.stop(),await this.waitUntilIdle(),await this.engine.closeDatabase(this.databaseName,e),this.resume()}async deleteThisDatabase(e){this.stop(),await this.waitUntilIdle(),await this.engine.deleteDatabase(this.databaseName,e),this.resume()}runTransaction(t,s,i,n,a=r.g.READWRITE){const l=this.transactionManager,c=this.doQuery.bind(this),u=this.dispatchQueryErrorEvent.bind(this);return new Promise((async(r,h)=>{try{await async function(r,h){const g=i.map((e=>"string"==typeof e?e:e.name)),m=await l.beginTransaction(t,g,a),p=g.map((e=>{if(!s[e])throw new o.x(e);const i=s[e];return new d.b(t,i,m.id,c,u)})),f=await n(p);e((()=>{l.commitTransaction(m.id).then((e=>{r(f)})).catch(h)}))}(r,h)}catch(g){h(g)}}))}runFakeTransaction(t,s,i,n,a=r.g.READWRITE){const l=this.transactionManager,c=this.doQuery.bind(this),u=this.dispatchQueryErrorEvent.bind(this);return new Promise((async(a,r)=>{try{await async function(a,r){const h=i.map((e=>"string"==typeof e?e:e.name)).map((e=>{if(!s[e])throw new o.x(e);const i=s[e];return new d.b(t,i,0,c,u)}));await n(h),e((()=>{l.commitTransaction(0).then(a).catch(r)}))}(a,r)}catch(h){r(h)}}))}runTransactionV2(t,s,i,n,a=r.g.READWRITE){const l=this.transactionManager,c=this.doQuery.bind(this),u=this.dispatchQueryErrorEvent.bind(this);return new Promise(((r,h)=>{try{!async function(r,h){const g=i.map((e=>"string"==typeof e?e:e.name)),m=await l.beginTransaction(t,g,a),p=g.map((e=>{if(!s[e])throw new o.x(e);const i=s[e];return new d.c(t,i,m.id,c,u)}));await n(p),e((()=>{l.commitTransaction(m.id).then(r).catch(h)}))}(r,h)}catch(g){h(g)}}))}runMigrateDataTransform(t,s,i,n,a){const r=this.transactionManager,l=this.doQuery.bind(this),c=this.dispatchQueryErrorEvent.bind(this);return new Promise(((u,h)=>{try{!async function(u,h){const g=i.map((e=>"string"==typeof e?e:e.name)),m=await r.beginTransaction(t,g,a),p=g.map((e=>{if(!s[e])throw new o.x(e);const i=s[e];return new d.a(t,i,m.id,l,c)}));await n(p),e((()=>{r.commitTransaction(m.id).then(u).catch(h)}))}(u,h)}catch(g){h(g)}}))}}}).call(this,s("7fu/").setImmediate)}}]);
//# sourceMappingURL=../sourcemaps/lazy/web-startup.5efb60b00dd4c9513e2c.js.map